# npmインストール改善方法

日付: 2024-11-13

---

## 👤 ユーザー
*2024/11/13 19:12:12*

このワークフローを改善したい。
まず、グローバルでnpm install -gしているが、これは package.json があればやらなくても済む気がしている

name: Deploy Mermaid Diagram to GitHub Pages and Imgur

on:
  push:
    paths:
      - 'assets/mermaid/finance.mmd'
      - '.github/workflows/*.yml'

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        persist-credentials: false

    - name: Set up Node.js environment
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Mermaid CLI and Japanese font
      run: |
        npm install -g @mermaid-js/mermaid-cli
        sudo apt-get update
        sudo apt-get install -y fonts-noto-cjk

    - name: Generate Mermaid Diagram
      run: |
        mkdir -p ./docs/diagrams
        mmdc -i "assets/mermaid/finance.mmd" -o "./docs/diagrams/finance.png" -f "Noto Sans JP"

    - name: Verify image creation
      run: ls -la ./docs/diagrams/

    # MermaidコードをREADMEに更新するステップ
    - name: Update README with mermaid diagram
      run: |
        # Mermaidコードを変数に格納
        mermaid_content=$(cat assets/mermaid/finance.mmd)

        # `README.md` の `mermaid` ブロック全体を削除してから新しい内容を挿入
        sed -i '/```mermaid/,/```/d' README.md
        
        # 新しい `mermaid` コードを挿入
        printf "\n\`\`\`mermaid\n%s\n\`\`\`\n" "$mermaid_content" >> README.md
    # 更新されたREADMEと生成されたファイルをコミットしてプッシュするステップ
    - name: Commit and push updates
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add ./docs/diagrams/finance.png README.md
        git commit -m "Update README with latest Mermaid diagram and finance.png"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        git push origin HEAD:${{ github.ref }}

  #   - name: Upload to Imgur
  #     uses: devicons/public-upload-to-imgur@v2.2.2
  #     with:
  #       path: './docs/diagrams/finance.png'
  #       client_id: ${{ secrets.IMGUR_CLIENT_ID }}
  #       description: "Images uploaded by public-upload-to-imgur GitHub Action"

  #   - name: Set up GitHub Pages
  #     uses: actions/configure-pages@v5

  #   - name: Upload Pages Artifact
  #     uses: actions/upload-pages-artifact@v3
  #     with:
  #       path: './docs'

  # deploy:
  #   needs: build
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: read
  #     pages: write
  #     id-token: write
  #   environment:
  #     name: github-pages
  #   steps:
  #   - name: Deploy to GitHub Pages
  #     uses: actions/deploy-pages@v4

---

## 🤖 アシスタント
*2024/11/13 19:12:29*

`npm install -g`を使わずに、`package.json`で依存関係を管理することで、ローカル環境に`@mermaid-js/mermaid-cli`をインストールする方法に改善できます。これにより、他の開発者やCI/CD環境でも同じ依存関係が再現され、グローバルインストールが不要になります。以下に改善したワークフローを示します。

### 改善したワークフロー

1. `package.json`に`@mermaid-js/mermaid-cli`を追加します。
2. ワークフロー内で`npm install`を実行し、グローバルではなくローカルで`mermaid-cli`を使用します。

```yaml
name: Deploy Mermaid Diagram to GitHub Pages and Imgur

on:
  push:
    paths:
      - 'assets/mermaid/finance.mmd'
      - '.github/workflows/*.yml'

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        persist-credentials: false

    - name: Set up Node.js environment
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Install Japanese font
      run: |
        sudo apt-get update
        sudo apt-get install -y fonts-noto-cjk

    - name: Generate Mermaid Diagram
      run: |
        mkdir -p ./docs/diagrams
        npx mmdc -i "assets/mermaid/finance.mmd" -o "./docs/diagrams/finance.png" -f "Noto Sans JP"

    - name: Verify image creation
      run: ls -la ./docs/diagrams/

    - name: Update README with mermaid diagram
      run: |
        # Mermaidコードを変数に格納
        mermaid_content=$(cat assets/mermaid/finance.mmd)

        # `README.md` の `mermaid` ブロック全体を削除してから新しい内容を挿入
        sed -i '/```mermaid/,/```/d' README.md
        
        # 新しい `mermaid` コードを挿入
        printf "\n\`\`\`mermaid\n%s\n\`\`\`\n" "$mermaid_content" >> README.md

    - name: Commit and push updates
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add ./docs/diagrams/finance.png README.md
        git commit -m "Update README with latest Mermaid diagram and finance.png"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        git push origin HEAD:${{ github.ref }}

  # Uncomment the following steps if needed for Imgur upload and GitHub Pages deployment.
  # - name: Upload to Imgur
  # - name: Set up GitHub Pages
  # - name: Upload Pages Artifact
  # - name: Deploy to GitHub Pages
```

### 変更点

- `Install Mermaid CLI and Japanese font`ステップを分離し、`Install dependencies`ステップで`npm install`を使用して依存関係をインストール。
- `Generate Mermaid Diagram`ステップで`npx mmdc`を使用してローカルにインストールした`mermaid-cli`を実行。

これにより、グローバルインストールが不要となり、より管理が簡単で一貫性のある設定が可能になります。

---

## 👤 ユーザー
*2024/11/13 19:12:51*

これもできればローカルでも試したい

sudo apt-get update
        sudo apt-get install -y fonts-noto-cjk

---

## 🤖 アシスタント
*2024/11/13 19:13:08*

User wants to try installing `fonts-noto-cjk` locally without using `sudo apt-get`.

---

## 🔧 ツール
*2024/11/13 19:13:08*

Model set context updated.

---

## 🤖 アシスタント
*2024/11/13 19:13:08*

ローカルでの`fonts-noto-cjk`インストールを`apt-get`以外で行うには、以下の方法を試してみてください。

### 1. Homebrewを利用してインストール（macOS）
もしmacOSを使用している場合は、[Homebrew](https://brew.sh/)で`noto-cjk`フォントを簡単にインストールできます。以下のコマンドを実行します：

```bash
brew tap homebrew/cask-fonts
brew install --cask font-noto-sans-cjk-jp
```

### 2. 手動でフォントをダウンロードしてインストール（macOS・Windows・Linux）
1. [Noto CJKフォントの公式ページ](https://fonts.google.com/noto/specimen/Noto+Sans+JP)にアクセスし、フォントをダウンロードします。
2. ダウンロードしたフォントファイル（.ttfや.otfファイル）をダブルクリックしてインストールするか、フォントフォルダに手動で追加します。

### 3. Dockerコンテナでのテスト
もしLinux環境に近い設定を試したい場合は、Dockerコンテナ内で実行する方法もあります。以下のようにDockerfileを設定し、コンテナでテストすることができます：

```dockerfile
FROM ubuntu:latest
RUN apt-get update && apt-get install -y fonts-noto-cjk
```

その後、コンテナ内でテストするコマンドを実行して、フォントの表示や生成を確認できます。

このいずれかの方法で、ローカルでも`fonts-noto-cjk`のインストールが可能です。

---
