# ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆè¡¨ç¤ºæ–¹æ³•

æ—¥ä»˜: 2024-12-13

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/12/13 11:48:29*

Exploreã‚’ã‚¿ãƒƒãƒ—ã—ãŸæ™‚ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆãŒã‚¿ãƒ–ãƒãƒ¼ã®ä¸Šã‹ã‚‰è¡¨ç¤ºã•ã‚Œã¦ã—ã¾ã†ã€‚
ã‚¿ãƒ–ãƒãƒ¼ã®ãƒœãƒˆãƒ ã‹ã‚‰è¡¨ç¤ºã•ã›ã‚‹ã«ã¯ã©ã†ã—ãŸã‚ˆã„ã®ã‹ï¼Ÿ

import 'package:flutter/material.dart';
import 'package:flutter\_hooks/flutter\_hooks.dart';
import 'package:go\_router/go\_router.dart';
import 'package:google\_maps\_flutter/google\_maps\_flutter.dart';
import 'package:hooks\_riverpod/hooks\_riverpod.dart';
import 'package:permission\_handler/permission\_handler.dart';
import 'package:snpit\_guild\_app/domain/screen.dart';
import 'package:snpit\_guild\_app/presentation/pages/explorer\_list\_page.dart';
import 'package:snpit\_guild\_app/presentation/providers/current\_location.dart';

class MapPage extends HookConsumerWidget {
  const MapPage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final locationAsync = ref.watch(currentLocationNotifierProvider);
    final googleMapController = useState&lt;GoogleMapController?&gt;(null);

    useEffect(
      () {
        final observer = \_LifecycleObserver(
          onResume: () async {
            // ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«æˆ»ã£ã¦ããŸã‚‰ä½ç½®æƒ…å ±ã‚’å†å–å¾—
            final refreshedLocation =
                ref.refresh(currentLocationNotifierProvider);
            debugPrint('Location refreshed: $refreshedLocation');
          },
        );
        WidgetsBinding.instance.addObserver(observer);

        return () =&gt; WidgetsBinding.instance.removeObserver(observer);
      },
      \[\],
    );

    return Scaffold(
      body: locationAsync.when(
        data: (currentLocation) =&gt; Stack(
          children: \[
            GoogleMap(
              initialCameraPosition: CameraPosition(
                target: currentLocation,
                zoom: 17,
              ),
              myLocationEnabled: true,
              myLocationButtonEnabled: false,
              onMapCreated: (controller) {
                googleMapController.value = controller;
              },
            ),
            Center(
              child: ElevatedButton(
                onPressed: () {
                  context.push(Screen.shooting.path);
                },
                child: const Icon(Icons.camera\_alt),
              ),
            ),
            Positioned(
              bottom: 16,
              left: 16,
              right: 16,
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: \[
                  ElevatedButton(
                    onPressed: () async {
                      final refreshedLocation = await ref
                          .read(currentLocationNotifierProvider.future);
                      final controller = googleMapController.value;
                      if (controller != null) {
                        await controller.animateCamera(
                          CameraUpdate.newLatLng(refreshedLocation),
                        );
                      }
                    },
                    child: const Icon(Icons.my\_location),
                  ),
                  ElevatedButton(
                    onPressed: () {
                      // TODO: ã“ã®ç”»é¢ã‹ã‚‰ showModalBottomSheet ã™ã‚‹ã¨
                      // ã‚¿ãƒ–ãƒãƒ¼ã®ä¸Šã‹ã‚‰è¡¨ç¤ºã•ã‚Œã¦ã—ã¾ã†ã®ã§ã€ã‚¿ãƒ–ãƒãƒ¼ã®ä¸‹ã‹ã‚‰è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ã™ã‚‹
                      showModalBottomSheet&lt;void&gt;(
                        context: context,
                        isScrollControlled: true,
                        shape: const RoundedRectangleBorder(
                          borderRadius:
                              BorderRadius.vertical(top: Radius.circular(16)),
                        ),
                        builder: (context) {
                          return SizedBox(
                            height: MediaQuery.of(context).size.height \* 0.5,
                            child: const ExplorerListPage(),
                          );
                        },
                      );
                    },
                    style: ElevatedButton.styleFrom(
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(16),
                      ),
                      padding: const EdgeInsets.symmetric(
                        horizontal: 24,
                        vertical: 12,
                      ),
                    ),
                    child: const Row(
                      children: \[
                        Icon(Icons.explore),
                        SizedBox(width: 8),
                        Text('Explore'),
                      \],
                    ),
                  ),
                  ElevatedButton(
                    onPressed: () {
                      context.push(Screen.spotList.path);
                    },
                    child: const Icon(Icons.photo),
                  ),
                \],
              ),
            ),
          \],
        ),
        loading: () =&gt; const Center(child: CircularProgressIndicator()),
        error: (error, stack) =&gt; Center(
          child: ElevatedButton(
            onPressed: () async {
              final \_ = await openAppSettings();
            },
            child: const Text('è¨­å®šã‚¢ãƒ—ãƒªã‹ã‚‰ä½ç½®æƒ…å ±å–å¾—ã‚’ONã«ã—ã¦ãã ã•ã„'),
          ),
        ),
      ),
    );
  }
}

class \_LifecycleObserver extends WidgetsBindingObserver {
  \_LifecycleObserver({this.onResume});
  final VoidCallback? onResume;

  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    if (state == AppLifecycleState.resumed) {
      onResume?.call();
    }
  }
}

import 'package:flutter/material.dart';
import 'package:go\_router/go\_router.dart';
import 'package:snpit\_guild\_app/domain/screen.dart';

class TabPage extends StatelessWidget {
  const TabPage({required this.navigationShell, super.key});
  final StatefulNavigationShell navigationShell;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        leadingWidth: 100,
        leading: Row(
          mainAxisSize: MainAxisSize.min,
          children: \[
            IconButton(
              icon: const Icon(Icons.person),
              onPressed: () {
                context.push(Screen.myPage.path);
              },
            ),
            IconButton(
              icon: const Icon(Icons.notifications),
              onPressed: () {
                context.push(Screen.notificationList.path);
              },
            ),
          \],
        ),
        actions: \[
          Padding(
            padding: const EdgeInsets.only(right: 16),
            child: InkWell(
              onTap: () {
                context.push(Screen.wallet.path);
              },
              child: const Row(
                children: \[
                  Icon(Icons.token, size: 20),
                  SizedBox(width: 4),
                  Text('35.05 STP'), // TODO: ä»®ãƒ‡ãƒ¼ã‚¿
                \],
              ),
            ),
          ),
        \],
      ),
      body: navigationShell,
      bottomNavigationBar: BottomNavigationBar(
        currentIndex: navigationShell.currentIndex,
        onTap: navigationShell.goBranch,
        items: const \[
          BottomNavigationBarItem(icon: Icon(Icons.map), label: 'Map'),
          BottomNavigationBarItem(icon: Icon(Icons.group), label: 'Guild'),
        \],
      ),
    );
  }
}

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/12/13 11:49:13*

`showModalBottomSheet` ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚¹ã‚¯ãƒªãƒ¼ãƒ³å…¨ä½“ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã™ã‚‹ãŸã‚ã€ã‚¿ãƒ–ãƒãƒ¼ã®ä¸Šã‹ã‚‰è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚’ã‚¿ãƒ–ãƒãƒ¼ã®ä¸‹ã‹ã‚‰è¡¨ç¤ºã™ã‚‹ã«ã¯ã€`Scaffold` ã® `bottomSheet` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ãŒé©åˆ‡ã§ã™ã€‚`bottomSheet` ã‚’è¨­å®šã™ã‚‹ã¨ã€ã‚¿ãƒ–ãƒãƒ¼ã®ä¸‹éƒ¨ã«å›ºå®šã•ã‚ŒãŸãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

ä»¥ä¸‹ã«ä¿®æ­£ä¾‹ã‚’ç¤ºã—ã¾ã™:

### ä¿®æ­£ä¾‹

`MapPage` ã® `onPressed` ã«ã‚ˆã‚‹ `showModalBottomSheet` ã®ä»£ã‚ã‚Šã«ã€`Scaffold` ã® `bottomSheet` ã‚’å‹•çš„ã«è¨­å®šã™ã‚‹æ–¹æ³•ã‚’å°å…¥ã—ã¾ã™ã€‚

#### å¤‰æ›´ç‚¹

- ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆã®çŠ¶æ…‹ç®¡ç†ã®ãŸã‚ã« `State` ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
- `Scaffold` ã® `bottomSheet` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ´»ç”¨ã—ã¦ã€ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆã‚’ã‚¿ãƒ–ãƒãƒ¼ã®ä¸‹éƒ¨ã‹ã‚‰è¡¨ç¤ºã—ã¾ã™ã€‚

```dart
class MapPage extends HookConsumerWidget {
  const MapPage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final locationAsync = ref.watch(currentLocationNotifierProvider);
    final googleMapController = useState<GoogleMapController?>(null);
    final isBottomSheetVisible = useState(false); // ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆã®çŠ¶æ…‹ç®¡ç†

    useEffect(
      () {
        final observer = _LifecycleObserver(
          onResume: () async {
            // ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«æˆ»ã£ã¦ããŸã‚‰ä½ç½®æƒ…å ±ã‚’å†å–å¾—
            final refreshedLocation =
                ref.refresh(currentLocationNotifierProvider);
            debugPrint('Location refreshed: $refreshedLocation');
          },
        );
        WidgetsBinding.instance.addObserver(observer);

        return () => WidgetsBinding.instance.removeObserver(observer);
      },
      [],
    );

    return Scaffold(
      bottomSheet: isBottomSheetVisible.value
          ? BottomSheet(
              onClosing: () {
                isBottomSheetVisible.value = false;
              },
              builder: (context) {
                return SizedBox(
                  height: MediaQuery.of(context).size.height * 0.5,
                  child: const ExplorerListPage(),
                );
              },
            )
          : null,
      body: locationAsync.when(
        data: (currentLocation) => Stack(
          children: [
            GoogleMap(
              initialCameraPosition: CameraPosition(
                target: currentLocation,
                zoom: 17,
              ),
              myLocationEnabled: true,
              myLocationButtonEnabled: false,
              onMapCreated: (controller) {
                googleMapController.value = controller;
              },
            ),
            Center(
              child: ElevatedButton(
                onPressed: () {
                  context.push(Screen.shooting.path);
                },
                child: const Icon(Icons.camera_alt),
              ),
            ),
            Positioned(
              bottom: 16,
              left: 16,
              right: 16,
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  ElevatedButton(
                    onPressed: () async {
                      final refreshedLocation = await ref
                          .read(currentLocationNotifierProvider.future);
                      final controller = googleMapController.value;
                      if (controller != null) {
                        await controller.animateCamera(
                          CameraUpdate.newLatLng(refreshedLocation),
                        );
                      }
                    },
                    child: const Icon(Icons.my_location),
                  ),
                  ElevatedButton(
                    onPressed: () {
                      isBottomSheetVisible.value = true; // ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆã‚’è¡¨ç¤º
                    },
                    style: ElevatedButton.styleFrom(
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(16),
                      ),
                      padding: const EdgeInsets.symmetric(
                        horizontal: 24,
                        vertical: 12,
                      ),
                    ),
                    child: const Row(
                      children: [
                        Icon(Icons.explore),
                        SizedBox(width: 8),
                        Text('Explore'),
                      ],
                    ),
                  ),
                  ElevatedButton(
                    onPressed: () {
                      context.push(Screen.spotList.path);
                    },
                    child: const Icon(Icons.photo),
                  ),
                ],
              ),
            ),
          ],
        ),
        loading: () => const Center(child: CircularProgressIndicator()),
        error: (error, stack) => Center(
          child: ElevatedButton(
            onPressed: () async {
              final _ = await openAppSettings();
            },
            child: const Text('è¨­å®šã‚¢ãƒ—ãƒªã‹ã‚‰ä½ç½®æƒ…å ±å–å¾—ã‚’ONã«ã—ã¦ãã ã•ã„'),
          ),
        ),
      ),
    );
  }
}
```

### ã“ã®æ–¹æ³•ã®ãƒã‚¤ãƒ³ãƒˆ
- `BottomSheet` ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆãŒã‚¿ãƒ–ãƒãƒ¼ã®ä¸‹ã‹ã‚‰è¡¨ç¤ºã•ã‚Œã‚‹ã€‚
- `isBottomSheetVisible` ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ã§ã€ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºã‚’ç®¡ç†ã§ãã‚‹ã€‚
- `onClosing` ã‚’ä½¿ã£ã¦ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆã®é–‰ã˜ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¤œå‡ºã€‚

ã“ã‚Œã§ã‚¿ãƒ–ãƒãƒ¼ã®ä¸‹ã‹ã‚‰ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

---
