# ボトムシート表示方法

日付: 2024-12-13

---

## 👤 ユーザー
*2024/12/13 11:48:29*

Exploreをタップした時ボトムシートがタブバーの上から表示されてしまう。
タブバーのボトムから表示させるにはどうしたよいのか？

import 'package:flutter/material.dart';
import 'package:flutter\_hooks/flutter\_hooks.dart';
import 'package:go\_router/go\_router.dart';
import 'package:google\_maps\_flutter/google\_maps\_flutter.dart';
import 'package:hooks\_riverpod/hooks\_riverpod.dart';
import 'package:permission\_handler/permission\_handler.dart';
import 'package:snpit\_guild\_app/domain/screen.dart';
import 'package:snpit\_guild\_app/presentation/pages/explorer\_list\_page.dart';
import 'package:snpit\_guild\_app/presentation/providers/current\_location.dart';

class MapPage extends HookConsumerWidget {
  const MapPage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final locationAsync = ref.watch(currentLocationNotifierProvider);
    final googleMapController = useState&lt;GoogleMapController?&gt;(null);

    useEffect(
      () {
        final observer = \_LifecycleObserver(
          onResume: () async {
            // フォアグラウンドに戻ってきたら位置情報を再取得
            final refreshedLocation =
                ref.refresh(currentLocationNotifierProvider);
            debugPrint('Location refreshed: $refreshedLocation');
          },
        );
        WidgetsBinding.instance.addObserver(observer);

        return () =&gt; WidgetsBinding.instance.removeObserver(observer);
      },
      \[\],
    );

    return Scaffold(
      body: locationAsync.when(
        data: (currentLocation) =&gt; Stack(
          children: \[
            GoogleMap(
              initialCameraPosition: CameraPosition(
                target: currentLocation,
                zoom: 17,
              ),
              myLocationEnabled: true,
              myLocationButtonEnabled: false,
              onMapCreated: (controller) {
                googleMapController.value = controller;
              },
            ),
            Center(
              child: ElevatedButton(
                onPressed: () {
                  context.push(Screen.shooting.path);
                },
                child: const Icon(Icons.camera\_alt),
              ),
            ),
            Positioned(
              bottom: 16,
              left: 16,
              right: 16,
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: \[
                  ElevatedButton(
                    onPressed: () async {
                      final refreshedLocation = await ref
                          .read(currentLocationNotifierProvider.future);
                      final controller = googleMapController.value;
                      if (controller != null) {
                        await controller.animateCamera(
                          CameraUpdate.newLatLng(refreshedLocation),
                        );
                      }
                    },
                    child: const Icon(Icons.my\_location),
                  ),
                  ElevatedButton(
                    onPressed: () {
                      // TODO: この画面から showModalBottomSheet すると
                      // タブバーの上から表示されてしまうので、タブバーの下から表示するように修正する
                      showModalBottomSheet&lt;void&gt;(
                        context: context,
                        isScrollControlled: true,
                        shape: const RoundedRectangleBorder(
                          borderRadius:
                              BorderRadius.vertical(top: Radius.circular(16)),
                        ),
                        builder: (context) {
                          return SizedBox(
                            height: MediaQuery.of(context).size.height \* 0.5,
                            child: const ExplorerListPage(),
                          );
                        },
                      );
                    },
                    style: ElevatedButton.styleFrom(
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(16),
                      ),
                      padding: const EdgeInsets.symmetric(
                        horizontal: 24,
                        vertical: 12,
                      ),
                    ),
                    child: const Row(
                      children: \[
                        Icon(Icons.explore),
                        SizedBox(width: 8),
                        Text('Explore'),
                      \],
                    ),
                  ),
                  ElevatedButton(
                    onPressed: () {
                      context.push(Screen.spotList.path);
                    },
                    child: const Icon(Icons.photo),
                  ),
                \],
              ),
            ),
          \],
        ),
        loading: () =&gt; const Center(child: CircularProgressIndicator()),
        error: (error, stack) =&gt; Center(
          child: ElevatedButton(
            onPressed: () async {
              final \_ = await openAppSettings();
            },
            child: const Text('設定アプリから位置情報取得をONにしてください'),
          ),
        ),
      ),
    );
  }
}

class \_LifecycleObserver extends WidgetsBindingObserver {
  \_LifecycleObserver({this.onResume});
  final VoidCallback? onResume;

  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    if (state == AppLifecycleState.resumed) {
      onResume?.call();
    }
  }
}

import 'package:flutter/material.dart';
import 'package:go\_router/go\_router.dart';
import 'package:snpit\_guild\_app/domain/screen.dart';

class TabPage extends StatelessWidget {
  const TabPage({required this.navigationShell, super.key});
  final StatefulNavigationShell navigationShell;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        leadingWidth: 100,
        leading: Row(
          mainAxisSize: MainAxisSize.min,
          children: \[
            IconButton(
              icon: const Icon(Icons.person),
              onPressed: () {
                context.push(Screen.myPage.path);
              },
            ),
            IconButton(
              icon: const Icon(Icons.notifications),
              onPressed: () {
                context.push(Screen.notificationList.path);
              },
            ),
          \],
        ),
        actions: \[
          Padding(
            padding: const EdgeInsets.only(right: 16),
            child: InkWell(
              onTap: () {
                context.push(Screen.wallet.path);
              },
              child: const Row(
                children: \[
                  Icon(Icons.token, size: 20),
                  SizedBox(width: 4),
                  Text('35.05 STP'), // TODO: 仮データ
                \],
              ),
            ),
          ),
        \],
      ),
      body: navigationShell,
      bottomNavigationBar: BottomNavigationBar(
        currentIndex: navigationShell.currentIndex,
        onTap: navigationShell.goBranch,
        items: const \[
          BottomNavigationBarItem(icon: Icon(Icons.map), label: 'Map'),
          BottomNavigationBarItem(icon: Icon(Icons.group), label: 'Guild'),
        \],
      ),
    );
  }
}

---

## 🤖 アシスタント
*2024/12/13 11:49:13*

`showModalBottomSheet` はデフォルトでスクリーン全体をオーバーレイするため、タブバーの上から表示されます。これをタブバーの下から表示するには、`Scaffold` の `bottomSheet` プロパティを使用する方法が適切です。`bottomSheet` を設定すると、タブバーの下部に固定されたボトムシートが表示されます。

以下に修正例を示します:

### 修正例

`MapPage` の `onPressed` による `showModalBottomSheet` の代わりに、`Scaffold` の `bottomSheet` を動的に設定する方法を導入します。

#### 変更点

- ボトムシートの状態管理のために `State` を使用します。
- `Scaffold` の `bottomSheet` プロパティを活用して、ボトムシートをタブバーの下部から表示します。

```dart
class MapPage extends HookConsumerWidget {
  const MapPage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final locationAsync = ref.watch(currentLocationNotifierProvider);
    final googleMapController = useState<GoogleMapController?>(null);
    final isBottomSheetVisible = useState(false); // ボトムシートの状態管理

    useEffect(
      () {
        final observer = _LifecycleObserver(
          onResume: () async {
            // フォアグラウンドに戻ってきたら位置情報を再取得
            final refreshedLocation =
                ref.refresh(currentLocationNotifierProvider);
            debugPrint('Location refreshed: $refreshedLocation');
          },
        );
        WidgetsBinding.instance.addObserver(observer);

        return () => WidgetsBinding.instance.removeObserver(observer);
      },
      [],
    );

    return Scaffold(
      bottomSheet: isBottomSheetVisible.value
          ? BottomSheet(
              onClosing: () {
                isBottomSheetVisible.value = false;
              },
              builder: (context) {
                return SizedBox(
                  height: MediaQuery.of(context).size.height * 0.5,
                  child: const ExplorerListPage(),
                );
              },
            )
          : null,
      body: locationAsync.when(
        data: (currentLocation) => Stack(
          children: [
            GoogleMap(
              initialCameraPosition: CameraPosition(
                target: currentLocation,
                zoom: 17,
              ),
              myLocationEnabled: true,
              myLocationButtonEnabled: false,
              onMapCreated: (controller) {
                googleMapController.value = controller;
              },
            ),
            Center(
              child: ElevatedButton(
                onPressed: () {
                  context.push(Screen.shooting.path);
                },
                child: const Icon(Icons.camera_alt),
              ),
            ),
            Positioned(
              bottom: 16,
              left: 16,
              right: 16,
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  ElevatedButton(
                    onPressed: () async {
                      final refreshedLocation = await ref
                          .read(currentLocationNotifierProvider.future);
                      final controller = googleMapController.value;
                      if (controller != null) {
                        await controller.animateCamera(
                          CameraUpdate.newLatLng(refreshedLocation),
                        );
                      }
                    },
                    child: const Icon(Icons.my_location),
                  ),
                  ElevatedButton(
                    onPressed: () {
                      isBottomSheetVisible.value = true; // ボトムシートを表示
                    },
                    style: ElevatedButton.styleFrom(
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(16),
                      ),
                      padding: const EdgeInsets.symmetric(
                        horizontal: 24,
                        vertical: 12,
                      ),
                    ),
                    child: const Row(
                      children: [
                        Icon(Icons.explore),
                        SizedBox(width: 8),
                        Text('Explore'),
                      ],
                    ),
                  ),
                  ElevatedButton(
                    onPressed: () {
                      context.push(Screen.spotList.path);
                    },
                    child: const Icon(Icons.photo),
                  ),
                ],
              ),
            ),
          ],
        ),
        loading: () => const Center(child: CircularProgressIndicator()),
        error: (error, stack) => Center(
          child: ElevatedButton(
            onPressed: () async {
              final _ = await openAppSettings();
            },
            child: const Text('設定アプリから位置情報取得をONにしてください'),
          ),
        ),
      ),
    );
  }
}
```

### この方法のポイント
- `BottomSheet` を使用すると、ボトムシートがタブバーの下から表示される。
- `isBottomSheetVisible` を切り替えることで、ボトムシートの表示・非表示を管理できる。
- `onClosing` を使ってボトムシートの閉じるアクションを検出。

これでタブバーの下からボトムシートを表示することができます。

---
