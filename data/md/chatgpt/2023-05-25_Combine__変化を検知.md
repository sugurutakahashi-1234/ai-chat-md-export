# Combine: å¤‰åŒ–ã‚’æ¤œçŸ¥

æ—¥ä»˜: 2023-05-25

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2023/5/26 3:53:58*

Swiftã®Combineã§å‰å›ã®å€¤ã¨æ¯”è¼ƒã—ã¦å¤‰åŒ–ãŒã‚ã£ãŸã‚‰æµã‚Œã‚‹ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å®Ÿè£…ã—ã¦æ¬²ã—ã„

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2023/5/26 3:54:45*

Swiftã®Combineãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã—ã¦ã€å‰å›ã®å€¤ã¨æ¯”è¼ƒã—ãŸéš›ã«å¤‰åŒ–ãŒã‚ã£ãŸå ´åˆã«ã®ã¿å€¤ã‚’ç™ºè¡Œã™ã‚‹ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å®Ÿè£…ã™ã‚‹ã«ã¯ã€`removeDuplicates`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã¯ã‚¹ãƒˆãƒªãƒ¼ãƒ ä¸Šã®é€£ç¶šã—ãŸé‡è¤‡å€¤ã‚’é™¤å»ã—ã¾ã™ã€‚

ä»¥ä¸‹ã«ç°¡å˜ãªä¾‹ã‚’ç¤ºã—ã¾ã™ï¼š

```swift
import Combine

let publisher = PassthroughSubject<Int, Never>()

let subscription = publisher
    .removeDuplicates()
    .sink { value in
        print("Received value: \(value)")
    }

publisher.send(1)
publisher.send(1) // é‡è¤‡å€¤ã¯ç„¡è¦–ã•ã‚Œã¾ã™
publisher.send(2)
publisher.send(2) // é‡è¤‡å€¤ã¯ç„¡è¦–ã•ã‚Œã¾ã™
publisher.send(3)

// å‡ºåŠ›ï¼š
// Received value: 1
// Received value: 2
// Received value: 3
```

ã“ã®ä¾‹ã§ã¯ã€`PassthroughSubject`ã¨ã„ã†ç‰¹å®šã®`Publisher`ã‚’ä½œæˆã—ã€ãã‚Œã«`removeDuplicates`ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã‚’é©ç”¨ã—ã¦ã„ã¾ã™ã€‚ãã—ã¦ã€ãã®çµæœã‚’`sink`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦è³¼èª­ã—ã€å€¤ãŒæµã‚Œã‚‹ãŸã³ã«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€åŒã˜å€¤ãŒé€£ç¶šã—ã¦æµã‚Œã‚‹ã¨ã€2å›ç›®ä»¥é™ã®å€¤ã¯ç„¡è¦–ã•ã‚Œã€å¤‰åŒ–ã—ãŸå€¤ã®ã¿ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

`removeDuplicates`ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§`==`æ¼”ç®—å­ã‚’ä½¿ç”¨ã—ã¦æ¯”è¼ƒã—ã¾ã™ãŒã€ç‹¬è‡ªã®æ¯”è¼ƒæ–¹æ³•ã‚’æä¾›ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚ä¾‹ãˆã°ï¼š

```swift
publisher
    .removeDuplicates(by: { (oldValue, newValue) in
        // ç‹¬è‡ªã®æ¯”è¼ƒãƒ­ã‚¸ãƒƒã‚¯ã‚’è¨˜è¿°ã—ã¾ã™
    })
    .sink { value in
        print("Received value: \(value)")
    }
```

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€`removeDuplicates(by:)`ã‚’ä½¿ç”¨ã—ã¦ã€å‰å›ã®å€¤ã¨æ–°ã—ã„å€¤ã‚’æ¯”è¼ƒã™ã‚‹ç‹¬è‡ªã®æ–¹æ³•ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2023/5/26 3:58:25*

Equatable ã‚’é©å¿œã•ã›ãªãã¦ã¯ã„ã‘ãªã„ã®ãŒå¤§å¤‰ãªã‚“ã ãŒã€ã€ã€

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2023/5/26 3:59:07*

`Equatable`ã‚’é©ç”¨ã™ã‚‹ã®ãŒå›°é›£ãªå ´åˆã§ã‚‚ã€`removeDuplicates(by:)` ã‚’ä½¿ç”¨ã—ã¦ã‚«ã‚¹ã‚¿ãƒ æ¯”è¼ƒãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

æ¬¡ã®ä¾‹ã¯ã€å˜ã«å‰å›ã®å€¤ã¨æ–°ã—ã„å€¤ãŒç•°ãªã‚‹å ´åˆã®ã¿å€¤ã‚’ç™ºè¡Œã™ã‚‹ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å®Ÿè£…ã—ã¾ã™ã€‚ã“ã®å ´åˆã€`Equatable`ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ï¼š

```swift
import Combine

let publisher = PassthroughSubject<String, Never>()

let subscription = publisher
    .tryRemoveDuplicates(by: { (oldValue, newValue) in
        return oldValue != newValue
    })
    .sink { completion in
        switch completion {
        case .failure(let error):
            print("Received error: \(error)")
        case .finished:
            print("Publisher is finished")
        }
    } receiveValue: { value in
        print("Received value: \(value)")
    }

publisher.send("A")
publisher.send("A") // é‡è¤‡å€¤ã¯ç„¡è¦–ã•ã‚Œã¾ã™
publisher.send("B")
publisher.send("B") // é‡è¤‡å€¤ã¯ç„¡è¦–ã•ã‚Œã¾ã™
publisher.send("A")

// å‡ºåŠ›ï¼š
// Received value: A
// Received value: B
// Received value: A
```

ã“ã®ä¾‹ã§ã¯ã€æ–°ã—ã„å€¤ã¨å‰å›ã®å€¤ã‚’æ¯”è¼ƒã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã¯ã€æ–°æ—§ã®å€¤ãŒç­‰ã—ããªã„å ´åˆã« `true` ã‚’è¿”ã™å˜ç´”ãªã‚‚ã®ã§ã™ã€‚ã—ã‹ã—ã€ã“ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯ä»»æ„ã®è¤‡é›‘ã•ã‚’æŒã¤ã“ã¨ãŒã§ãã¾ã™ã€‚

`tryRemoveDuplicates(by:)`ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã§ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã«ã¯ `Failure`ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®ä¾‹ã§ã¯ã€ãã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã¨ãã«ãã‚Œã‚’å˜ã«ãƒ—ãƒªãƒ³ãƒˆã—ã¦ã„ã¾ã™ã€‚

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã§ã¯`String`ã‚’ä½¿ç”¨ã—ã¾ã—ãŸãŒã€ã©ã®ã‚ˆã†ãªå‹ã«ã‚‚å¯¾å¿œå¯èƒ½ã§ã™ã€‚é©åˆ‡ãªæ¯”è¼ƒãƒ­ã‚¸ãƒƒã‚¯ã‚’æä¾›ã™ã‚Œã°ã„ã„ã®ã§ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2023/5/26 4:00:30*

ã“ã‚“ãªå‹ãªã®ã§ã§ããªã‹ã£ãŸã€‚

struct InputtedUserAttributes {
    // TODO: ä»®å®Ÿè£…
    var nickName: String?
    var gender: SampleUserAttribute?
    var birthday: Date?
    var location: SampleUserAttribute?
    var residenceType: SampleUserAttribute?
    var householdSize: SampleUserAttribute?
    var houseAnnualIncome: SampleUserAttribute?
    var occupation: SampleUserAttribute?
    var industry: SampleUserAttribute?
    var annualIncome: SampleUserAttribute?
    var education: SampleUserAttribute?
}

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2023/5/26 4:01:22*

ãªã‚‹ã»ã©ã€æ§‹é€ ä½“ `InputtedUserAttributes` ãŒå«ã‚€å…¨ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¯”è¼ƒã™ã‚‹ã“ã¨ã¯ã‹ãªã‚Šè¤‡é›‘ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã­ã€‚

ã—ã‹ã—ã€`tryRemoveDuplicates(by:)` ã‚’ä½¿ãˆã° `Equatable` ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’é©ç”¨ã›ãšã«ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ä»¥ä¸‹ã«ã‚µãƒ³ãƒ—ãƒ«ã®ã‚³ãƒ¼ãƒ‰ã‚’ç¤ºã—ã¾ã™ï¼š

```swift
import Combine

struct InputtedUserAttributes {
    var nickName: String?
    var gender: String? // ä»®ã«Stringã¨ã™ã‚‹
    var birthday: Date?
    var location: String? // ä»®ã«Stringã¨ã™ã‚‹
    // ...ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰...
}

let publisher = PassthroughSubject<InputtedUserAttributes, Never>()

let subscription = publisher
    .tryRemoveDuplicates(by: { (oldValue, newValue) in
        return oldValue.nickName != newValue.nickName ||
               oldValue.gender != newValue.gender ||
               oldValue.birthday != newValue.birthday ||
               oldValue.location != newValue.location
               // ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã¤ã„ã¦ã‚‚åŒæ§˜ã«æ¯”è¼ƒã—ã¾ã™...
    })
    .sink { completion in
        switch completion {
        case .failure(let error):
            print("Received error: \(error)")
        case .finished:
            print("Publisher is finished")
        }
    } receiveValue: { value in
        print("Received value: \(value)")
    }
```

ã“ã“ã§ã¯ã€æ–°æ—§ã®å€¤ãŒç­‰ã—ã„ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãŸã‚ã«ã€å…¨ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å€‹åˆ¥ã«æ¯”è¼ƒã—ã¦ã„ã¾ã™ã€‚ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä¸€ã¤ã§ã‚‚é•ã„ãŒã‚ã‚Œã°ã€ãã®å€¤ã¯æ–°ã—ã„ã‚‚ã®ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚

ãŸã ã—ã€ã“ã®å®Ÿè£…ã¯ãã‚Œãã‚Œã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ˜ç¤ºçš„ã«æ¯”è¼ƒã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€æ–°ãŸãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆã«ã¯ãã®æ¯”è¼ƒãƒ­ã‚¸ãƒƒã‚¯ã‚‚è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ•°ãŒå¤šããªã‚‹ã¨ã“ã®æ–¹æ³•ã¯æ‰‹é–“ãŒã‹ã‹ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ãªãŠã€SampleUserAttributeå‹ã®è©³ç´°ãªå®Ÿè£…å†…å®¹ã«ã‚ˆã£ã¦ã¯ã€ãã®æ¯”è¼ƒæ–¹æ³•ã‚‚é©å®œèª¿æ•´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä¸Šè¨˜ã®ä¾‹ã§ã¯ä»®ã«Stringã¨ã—ã¦æ‰±ã£ã¦ã„ã¾ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2023/5/26 4:01:51*

ã¡ãªã¿ã«ã“ã‚“ãªå‹

struct SampleUserAttribute: Equatable, PickerProtocol {
    let id: String
    let name: String
}

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2023/5/26 4:02:33*

äº†è§£ã—ã¾ã—ãŸã€‚`SampleUserAttribute`å‹ãŒ`Equatable`ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’æº–æ‹ ã—ã¦ã„ã‚‹ã®ã§ã‚ã‚Œã°ã€`SampleUserAttribute`ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹é–“ã®æ¯”è¼ƒã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®`==`æ¼”ç®—å­ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã§ã™ã®ã§ã€`InputtedUserAttributes`ã®å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¯”è¼ƒã™ã‚‹éš›ã«ã€`SampleUserAttribute`å‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ãã®ã¾ã¾æ¯”è¼ƒå¯èƒ½ã§ã™ã€‚

ä»¥ä¸‹ã®ä¾‹ã§ã¯ã€`InputtedUserAttributes`ãŒ`SampleUserAttribute`ã®å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å«ã‚€ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã—ãŸï¼š

```swift
import Combine

struct SampleUserAttribute: Equatable {
    let id: String
    let name: String
}

struct InputtedUserAttributes {
    var nickName: String?
    var gender: SampleUserAttribute?
    var birthday: Date?
    var location: SampleUserAttribute?
    // ...ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰...
}

let publisher = PassthroughSubject<InputtedUserAttributes, Never>()

let subscription = publisher
    .tryRemoveDuplicates(by: { (oldValue, newValue) in
        return oldValue.nickName != newValue.nickName ||
               oldValue.gender != newValue.gender ||
               oldValue.birthday != newValue.birthday ||
               oldValue.location != newValue.location
               // ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã¤ã„ã¦ã‚‚åŒæ§˜ã«æ¯”è¼ƒã—ã¾ã™...
    })
    .sink { completion in
        switch completion {
        case .failure(let error):
            print("Received error: \(error)")
        case .finished:
            print("Publisher is finished")
        }
    } receiveValue: { value in
        print("Received value: \(value)")
    }
```

ã“ã“ã§ã¯ã€`SampleUserAttribute`å‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆã“ã®ä¾‹ã§ã¯`gender`ã¨`location`ï¼‰ã¯ã€`==`æ¼”ç®—å­ã‚’ä½¿ç”¨ã—ã¦ç›´æ¥æ¯”è¼ƒã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯`SampleUserAttribute`ãŒ`Equatable`ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«æº–æ‹ ã—ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚

---
