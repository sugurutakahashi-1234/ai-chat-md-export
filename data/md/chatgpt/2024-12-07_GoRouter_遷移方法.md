# GoRouter 遷移方法

日付: 2024-12-07

---

## 👤 ユーザー
*2024/12/07 12:04:46*

flutter の go routerの遷移方法について教えてほしい どんな種類があるのか

---

## 🤖 アシスタント
*2024/12/07 12:05:03*

Flutter の `go_router` では、主に以下の種類の遷移方法があります。それぞれの方法は、アプリの要件に応じて使い分けます。

---

### 1. **`GoRouter.of(context).go(path)`**
指定したパスに遷移します。現在のルートスタックをリセットし、直接指定したルートに移動します。履歴は残らないため、戻るボタンを押すとアプリが終了する場合があります。

- **用途:**  
  ログイン後のホーム画面遷移やトップページへの遷移など、履歴をリセットしたいとき。

```dart
GoRouter.of(context).go('/home');
```

---

### 2. **`GoRouter.of(context).push(path)`**
現在のルートスタックの上に新しいルートを積み重ねます。戻るボタンで前の画面に戻ることができます。

- **用途:**  
  詳細画面や設定画面など、戻れる画面遷移が必要なとき。

```dart
GoRouter.of(context).push('/details');
```

---

### 3. **`GoRouter.of(context).replace(path)`**
現在のルートを置き換えます。履歴スタックに新しいルートを追加せず、現在のルートを上書きします。

- **用途:**  
  ページの再ロードやリダイレクト処理を行いたいとき。

```dart
GoRouter.of(context).replace('/dashboard');
```

---

### 4. **`GoRouter.of(context).pop()`**
現在のルートをポップして前のルートに戻ります。`Navigator.pop(context)` と似た挙動をします。

- **用途:**  
  詳細画面やモーダルから元の画面に戻りたいとき。

```dart
GoRouter.of(context).pop();
```

---

### 5. **`GoRouter.of(context).popWithResult(result)`**
値を返しながら現在のルートを閉じます。`Navigator.pop(context, result)` のようにデータを返すことが可能です。

- **用途:**  
  フォーム画面やピッカー画面など、遷移元に値を返したいとき。

```dart
GoRouter.of(context).popWithResult('UserSelectedValue');
```

---

### 6. **`context.go(path)`**
ショートハンド形式で、`GoRouter.of(context).go(path)` と同じです。

```dart
context.go('/home');
```

---

### 7. **`context.push(path)`**
ショートハンド形式で、`GoRouter.of(context).push(path)` と同じです。

```dart
context.push('/details');
```

---

### 遷移の種類を使い分けるポイント
1. **`go`**: 履歴をリセットして画面遷移をしたいとき。
2. **`push`**: 履歴を積み重ねて通常の画面遷移をしたいとき。
3. **`replace`**: 履歴を置き換えて遷移したいとき。
4. **`pop`/`popWithResult`**: 現在の画面を閉じて戻りたいとき。

具体的なシナリオに応じて、適切なメソッドを選ぶことが重要です。

---

## 👤 ユーザー
*2024/12/07 12:06:40*

例えばログイン画面からホーム画面に遷移してそこからアカウント画面に遷移してログアウトしてログイン画面に戻りたい時はどうするのか。

---

## 🤖 アシスタント
*2024/12/07 12:07:05*

ログイン画面 → ホーム画面 → アカウント画面 → ログアウト → ログイン画面に戻る、というフローを実現するには、以下のように **`go_router`** を設定し、適切な遷移メソッドを使用します。

---

### 必要なルートの設定
まず、`GoRouter` にルートを設定します。

```dart
final GoRouter router = GoRouter(
  initialLocation: '/login',
  routes: [
    GoRoute(
      path: '/login',
      builder: (context, state) => LoginPage(),
    ),
    GoRoute(
      path: '/home',
      builder: (context, state) => HomePage(),
      routes: [
        GoRoute(
          path: 'account', // '/home/account' にアクセスする
          builder: (context, state) => AccountPage(),
        ),
      ],
    ),
  ],
);
```

- `/login` はログイン画面。
- `/home` はホーム画面。
- `/home/account` はアカウント画面。
- アカウント画面からログアウトするときは `/login` に戻る。

---

### 各画面の遷移方法
#### 1. **ログイン画面 → ホーム画面**
ログイン成功時に `context.go('/home')` を使用してホーム画面に遷移します。  
**理由:**  
`go` を使うことでログイン画面を履歴から削除し、戻る操作で再びログイン画面が表示されないようにします。

```dart
// ログイン成功時
void onLoginSuccess(BuildContext context) {
  context.go('/home'); // 履歴をリセットしてホーム画面に遷移
}
```

---

#### 2. **ホーム画面 → アカウント画面**
アカウント画面に遷移する場合は、`context.push('/home/account')` を使用します。  
**理由:**  
`push` を使うことで戻る操作が可能になります。

```dart
// アカウントボタンが押されたとき
void goToAccountPage(BuildContext context) {
  context.push('/home/account'); // 履歴を積み重ねてアカウント画面に遷移
}
```

---

#### 3. **アカウント画面 → ログイン画面**
ログアウト時に `context.go('/login')` を使用します。  
**理由:**  
`go` を使うことで、履歴スタックをクリアしてログイン画面に戻します。これにより、戻るボタンを押してもログイン後の画面に戻れません。

```dart
// ログアウト時
void onLogout(BuildContext context) {
  context.go('/login'); // 履歴をリセットしてログイン画面に遷移
}
```

---

### まとめた例
以下は、ログイン画面からアカウント画面までの遷移とログアウト処理を含むコード例です。

```dart
class LoginPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Login')),
      body: Center(
        child: ElevatedButton(
          onPressed: () => context.go('/home'), // ログイン成功時
          child: Text('Login'),
        ),
      ),
    );
  }
}

class HomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Home')),
      body: Center(
        child: ElevatedButton(
          onPressed: () => context.push('/home/account'), // アカウント画面へ
          child: Text('Go to Account'),
        ),
      ),
    );
  }
}

class AccountPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Account')),
      body: Center(
        child: ElevatedButton(
          onPressed: () => context.go('/login'), // ログアウト時
          child: Text('Logout'),
        ),
      ),
    );
  }
}
```

---

### 遷移フローの動作
1. 初期画面はログイン画面 `/login`。
2. ログイン成功時に `context.go('/home')` を使いホーム画面に遷移。
3. ホーム画面で `context.push('/home/account')` を使いアカウント画面に遷移。
4. アカウント画面で `context.go('/login')` を使い履歴をクリアしてログイン画面に戻る。

この方法で、適切な履歴管理を行いながら遷移フローを実現できます。

---

## 👤 ユーザー
*2024/12/07 12:08:08*

いわゆるiosのsheetやフルスクリーンカバーのような概念はないのか？全部pushのように感じる

---

## 🤖 アシスタント
*2024/12/07 12:08:39*

`go_router` では、iOSの **sheet** や **フルスクリーンカバー** に似た遷移を実現する機能もあります。これらはすべて `Navigator` を利用しているため、適切に設定すればモーダルやカバー遷移も実現できます。

以下の方法で iOS の **sheet** や **フルスクリーンカバー** に近い動作を作ることができます。

---

### 1. **`GoRoute` に `pageBuilder` を利用する**
`pageBuilder` を使うと、`MaterialPage` や `CustomTransitionPage` をカスタマイズすることでモーダルやフルスクリーン遷移を設定できます。

#### シート風の表示 (モーダル)
以下の例では、`CupertinoPage` を利用してシート風の表示を行います。

```dart
GoRoute(
  path: '/settings',
  pageBuilder: (context, state) => CupertinoPage(
    fullscreenDialog: true, // モーダル表示を有効化
    child: SettingsPage(),
  ),
),
```

- **ポイント:**
  - `CupertinoPage` を使うことで、iOS のネイティブなモーダル遷移を再現。
  - `fullscreenDialog: true` を指定すると、ナビゲーションバーがモーダルスタイルになる。

---

#### フルスクリーンカバー
`MaterialPage` を使い、フルスクリーンのカバー表示を実現します。

```dart
GoRoute(
  path: '/profile',
  pageBuilder: (context, state) => MaterialPage(
    child: ProfilePage(),
  ),
),
```

- **ポイント:**
  - デフォルトではフルスクリーンカバーとして表示。
  - Android の `Material Design` にも自然にマッチ。

---

### 2. **`Navigator` を直接操作してシートを表示**
`go_router` の下にカスタムの `Navigator` を仕込むことで、`showModalBottomSheet` や `showGeneralDialog` を使った遷移を統合できます。

#### シートの表示例
```dart
GoRoute(
  path: '/sheet',
  builder: (context, state) {
    return HomePage(); // ベースとなるページ
  },
  routes: [
    GoRoute(
      path: 'modal',
      builder: (context, state) {
        WidgetsBinding.instance.addPostFrameCallback((_) {
          showModalBottomSheet(
            context: context,
            builder: (_) => ModalContentPage(),
          );
        });
        return Container(); // 実際には何も表示しない
      },
    ),
  ],
),
```

- **ポイント:**
  - `showModalBottomSheet` を利用してカスタムモーダルを表示。
  - 遷移が呼ばれた際にシートを開く。

---

### 3. **`CustomTransitionPage` でアニメーションをカスタマイズ**
独自の遷移アニメーションを設定できます。たとえば、スライドアップするシートのような動作を再現することが可能です。

#### カスタムアニメーション
```dart
GoRoute(
  path: '/modal',
  pageBuilder: (context, state) {
    return CustomTransitionPage(
      child: ModalPage(),
      transitionsBuilder: (context, animation, secondaryAnimation, child) {
        const begin = Offset(0.0, 1.0);
        const end = Offset.zero;
        const curve = Curves.easeInOut;

        var tween = Tween(begin: begin, end: end).chain(CurveTween(curve: curve));
        var offsetAnimation = animation.drive(tween);

        return SlideTransition(
          position: offsetAnimation,
          child: child,
        );
      },
    );
  },
),
```

- **ポイント:**
  - `CustomTransitionPage` を使うことで、スライド、フェード、ズームなどの遷移アニメーションを自由に設定可能。
  - iOS のシートのような遷移も作りやすい。

---

### 4. **ルートのタイプでカバーやシートを分ける**
`Navigator.push` を意識することなく、画面ごとに「モーダル」「フルスクリーン」「通常遷移」を使い分けられます。

例: ホーム画面 → 設定画面 (シート) → プロフィール画面 (フルスクリーン)
```dart
final GoRouter router = GoRouter(
  routes: [
    GoRoute(
      path: '/home',
      builder: (context, state) => HomePage(),
    ),
    GoRoute(
      path: '/settings',
      pageBuilder: (context, state) => CupertinoPage(
        fullscreenDialog: true,
        child: SettingsPage(),
      ),
    ),
    GoRoute(
      path: '/profile',
      pageBuilder: (context, state) => MaterialPage(
        child: ProfilePage(),
      ),
    ),
  ],
);
```

---

### 遷移フロー例
#### ホーム画面 → 設定画面 (シート風) → プロフィール画面 (フルスクリーン)
```dart
// ホーム画面で設定画面をモーダル表示
ElevatedButton(
  onPressed: () => context.go('/settings'),
  child: Text('Open Settings'),
);

// 設定画面でプロフィール画面をフルスクリーン表示
ElevatedButton(
  onPressed: () => context.go('/profile'),
  child: Text('Go to Profile'),
);
```

---

### 結論
- **`go_router`** でも **sheet** や **フルスクリーンカバー** に近い遷移が可能です。
- `CupertinoPage` や `CustomTransitionPage` を使うと、iOSらしいネイティブな体験を作りやすいです。
- 遷移のスタイルをカスタマイズしたい場合、`pageBuilder` による細かい設定が有効です。

`push` だけではなく、さまざまな遷移方法を組み合わせることで、柔軟な画面遷移を実現できます！

---
