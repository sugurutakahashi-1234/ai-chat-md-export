# æ¨©é™ãƒã‚§ãƒƒã‚¯ã¨ç”»åƒå‡¦ç†

Date: 2024-12-20

---

## ğŸ‘¤ User
*2024-12-20 14:05:25*

pickAndCropImage ã®å®Ÿè¡Œã‚’ _checkPhotoPermission ã®ä¸­ã§è¡Œã†ã“ã¨ã¯ã§ããªã„ã‹ï¼Ÿ

import 'dart:io';

import 'package:flutter/material.dart';
import 'package:flutter_hooks/flutter_hooks.dart';
import 'package:go_router/go_router.dart';
import 'package:image_cropper/image_cropper.dart';
import 'package:image_picker/image_picker.dart';
import 'package:permission_handler/permission_handler.dart';

class GuildCreatePage extends HookWidget {
  const GuildCreatePage({super.key});

  @override
  Widget build(BuildContext context) {
    final imageFile = useState&lt;File?&gt;(null);
    final picker = useMemoized(ImagePicker.new);

    /// å†™çœŸã‚’é¸æŠã—ã¦å††çŠ¶ã«ã‚¯ãƒ­ãƒƒãƒ—ã™ã‚‹
    Future&lt;void&gt; pickAndCropImage() async {
      final pickedFile = await picker.pickImage(source: ImageSource.gallery);

      if (pickedFile != null) {
        final croppedFile = await ImageCropper().cropImage(
          sourcePath: pickedFile.path,
          aspectRatio: const CropAspectRatio(ratioX: 1, ratioY: 1), // æ­£æ–¹å½¢ã«ã‚¯ãƒ­ãƒƒãƒ—
          uiSettings: [
            AndroidUiSettings(
              hideBottomControls: true, // ãƒœãƒˆãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«éè¡¨ç¤º
              lockAspectRatio: true, // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’å›ºå®š
              // cropStyle: CropStyle.circle, // å††å½¢ã«ã‚¯ãƒ­ãƒƒãƒ—
            ),
            IOSUiSettings(
              aspectRatioLockEnabled: true, // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’å›ºå®š
              // cropStyle: CropStyle.circle, // å††å½¢ã«ã‚¯ãƒ­ãƒƒãƒ—
            ),
          ],
        );

        if (croppedFile != null) {
          imageFile.value = File(croppedFile.path);
        } else {
          debugPrint('ã‚¯ãƒ­ãƒƒãƒ—ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
        }
      } else {
        debugPrint('ç”»åƒé¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
      }
    }

    /// å†™çœŸã‚’å‰Šé™¤
    void deleteImage() {
      imageFile.value = null;
      debugPrint('ç”»åƒãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
    }

    return Scaffold(
      appBar: AppBar(title: const Text('GuildCreatePage')),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            imageFile.value != null
                ? Column(
                    children: [
                      ClipRRect(
                        borderRadius: BorderRadius.circular(8),
                        child: Image.file(
                          imageFile.value!,
                          width: 150,
                          height: 150,
                          fit: BoxFit.cover,
                        ),
                      ),
                      const SizedBox(height: 10),
                      ElevatedButton(
                        onPressed: deleteImage,
                        child: const Text('ç”»åƒã‚’å‰Šé™¤'),
                      ),
                    ],
                  )
                : const Text('ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“'),
            const SizedBox(height: 20),
            ElevatedButton(
              onPressed: () async {
                final status = await _checkPhotoPermission(context);
                if (status == PermissionStatus.granted || status == PermissionStatus.limited) {
                  await pickAndCropImage();
                }
              },
              child: const Text('ã‚®ãƒ«ãƒ‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’é¸æŠ'),
            ),
            ElevatedButton(
              onPressed: () {
                context.pop();
              },
              child: const Text('Create'),
            ),
          ],
        ),
      ),
    );
  }

  /// å†™çœŸã®æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
  Future&lt;PermissionStatus&gt; _checkPhotoPermission(BuildContext context) async {
    final status = await Permission.photos.request();

    if (status.isGranted) {
      // è¨±å¯æ¸ˆã¿ã®å ´åˆ
      return status;
    } else if (status.isPermanentlyDenied) {
      // æ°¸ä¹…ã«æ‹’å¦ã•ã‚Œã¦ã„ã‚‹å ´åˆ
      if (context.mounted) {
        _showPermissionDialog(context);
      }
    } else {
      // ãã®ä»–ã®ã‚±ãƒ¼ã‚¹
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('å†™çœŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚')),
        );
      }
    }
    return status;
  }

  /// è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
  void _showPermissionDialog(BuildContext context) {
    showDialog&lt;void&gt;(
      context: context,
      builder: (context) =&gt; AlertDialog(
        title: const Text('å†™çœŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦ã§ã™'),
        content: const Text('å†™çœŸã‚’é¸æŠã™ã‚‹ã«ã¯ã€è¨­å®šã§å†™çœŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„ã€‚'),
        actions: [
          TextButton(
            onPressed: () {
              context.pop();
            },
            child: const Text('ã‚­ãƒ£ãƒ³ã‚»ãƒ«'),
          ),
          TextButton(
            onPressed: () async =&gt; openAppSettings(),
            child: const Text('è¨­å®šã‚’é–‹ã'),
          ),
        ],
      ),
    );
  }
}

---

## ğŸ¤– Assistant
*2024-12-20 14:05:41*

`pickAndCropImage` ã®å®Ÿè¡Œã‚’ `_checkPhotoPermission` å†…ã«å«ã‚ã‚‹ã“ã¨ã¯å¯èƒ½ã§ã™ã€‚ã—ã‹ã—ã€è²¬å‹™ãŒæ··ã–ã‚‹ã“ã¨ã§ã€ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã‚„ä¿å®ˆæ€§ãŒä½ä¸‹ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãã‚Œã§ã‚‚å®Ÿè¡Œã—ãŸã„å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã« `_checkPhotoPermission` ã‚’æ”¹ä¿®ã—ã¦å®Ÿç¾ã§ãã¾ã™ã€‚

ä»¥ä¸‹ã®å¤‰æ›´ä¾‹ã§ã¯ã€æ¨©é™ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ãŸå ´åˆã«è‡ªå‹•çš„ã« `pickAndCropImage` ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

### ä¿®æ­£ä¾‹

```dart
/// å†™çœŸã®æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€è¨±å¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç”»åƒã‚’é¸æŠã—ã¦ã‚¯ãƒ­ãƒƒãƒ—ã™ã‚‹
Future<void> _checkPhotoPermissionAndPickImage(BuildContext context, ValueNotifier<File?> imageFile, ImagePicker picker) async {
  final status = await Permission.photos.request();

  if (status.isGranted) {
    // è¨±å¯æ¸ˆã¿ã®å ´åˆã€ç”»åƒã‚’é¸æŠã—ã¦ã‚¯ãƒ­ãƒƒãƒ—
    final pickedFile = await picker.pickImage(source: ImageSource.gallery);

    if (pickedFile != null) {
      final croppedFile = await ImageCropper().cropImage(
        sourcePath: pickedFile.path,
        aspectRatio: const CropAspectRatio(ratioX: 1, ratioY: 1), // æ­£æ–¹å½¢ã«ã‚¯ãƒ­ãƒƒãƒ—
        uiSettings: [
          AndroidUiSettings(
            hideBottomControls: true, // ãƒœãƒˆãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«éè¡¨ç¤º
            lockAspectRatio: true, // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’å›ºå®š
          ),
          IOSUiSettings(
            aspectRatioLockEnabled: true, // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’å›ºå®š
          ),
        ],
      );

      if (croppedFile != null) {
        imageFile.value = File(croppedFile.path);
      } else {
        debugPrint('ã‚¯ãƒ­ãƒƒãƒ—ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
      }
    } else {
      debugPrint('ç”»åƒé¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
    }
  } else if (status.isPermanentlyDenied) {
    // æ°¸ä¹…ã«æ‹’å¦ã•ã‚Œã¦ã„ã‚‹å ´åˆ
    if (context.mounted) {
      _showPermissionDialog(context);
    }
  } else {
    // ãã®ä»–ã®ã‚±ãƒ¼ã‚¹
    if (context.mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('å†™çœŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚')),
      );
    }
  }
}
```

### ä¿®æ­£å¾Œã® `ElevatedButton` ã®å®Ÿè£…

ãƒœã‚¿ãƒ³ã‹ã‚‰ç›´æ¥ `_checkPhotoPermissionAndPickImage` ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

```dart
ElevatedButton(
  onPressed: () async {
    await _checkPhotoPermissionAndPickImage(context, imageFile, picker);
  },
  child: const Text('ã‚®ãƒ«ãƒ‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’é¸æŠ'),
),
```

### ãƒ¡ãƒªãƒƒãƒˆ

- ãƒœã‚¿ãƒ³ã® `onPressed` å†…ã§ã®è²¬å‹™ãŒæ¸›ã‚Šã€æ¨©é™ãƒã‚§ãƒƒã‚¯ã¨ç”»åƒå‡¦ç†ãŒã²ã¨ã¾ã¨ã¾ã‚Šã«ãªã‚Šã¾ã™ã€‚

### ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

- `_checkPhotoPermissionAndPickImage` ãŒè¤‡æ•°ã®è²¬å‹™ï¼ˆæ¨©é™ãƒã‚§ãƒƒã‚¯ï¼‹ç”»åƒé¸æŠï¼‹ã‚¯ãƒ­ãƒƒãƒ—ï¼‰ã‚’æŒã¤ãŸã‚ã€å†åˆ©ç”¨æ€§ãŒä¸‹ãŒã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ä¸Šè¨˜ã®ã‚ˆã†ã«æ”¹ä¿®ã™ã‚Œã°ã€å¸Œæœ›ã™ã‚‹å‹•ä½œã‚’å®Ÿç¾ã§ãã¾ã™ãŒã€é–¢æ•°ã®è²¬å‹™ã‚’é©åˆ‡ã«åˆ†ã‘ã‚‹ã¹ãã‹ã©ã†ã‹ã‚‚æ¤œè¨ã—ã¦ãã ã•ã„ã€‚

---
