# 権限チェックと画像処理

Date: 2024-12-20

---

## 👤 User
*2024-12-20 14:05:25*

pickAndCropImage の実行を _checkPhotoPermission の中で行うことはできないか？

import 'dart:io';

import 'package:flutter/material.dart';
import 'package:flutter_hooks/flutter_hooks.dart';
import 'package:go_router/go_router.dart';
import 'package:image_cropper/image_cropper.dart';
import 'package:image_picker/image_picker.dart';
import 'package:permission_handler/permission_handler.dart';

class GuildCreatePage extends HookWidget {
  const GuildCreatePage({super.key});

  @override
  Widget build(BuildContext context) {
    final imageFile = useState&lt;File?&gt;(null);
    final picker = useMemoized(ImagePicker.new);

    /// 写真を選択して円状にクロップする
    Future&lt;void&gt; pickAndCropImage() async {
      final pickedFile = await picker.pickImage(source: ImageSource.gallery);

      if (pickedFile != null) {
        final croppedFile = await ImageCropper().cropImage(
          sourcePath: pickedFile.path,
          aspectRatio: const CropAspectRatio(ratioX: 1, ratioY: 1), // 正方形にクロップ
          uiSettings: [
            AndroidUiSettings(
              hideBottomControls: true, // ボトムコントロール非表示
              lockAspectRatio: true, // アスペクト比を固定
              // cropStyle: CropStyle.circle, // 円形にクロップ
            ),
            IOSUiSettings(
              aspectRatioLockEnabled: true, // アスペクト比を固定
              // cropStyle: CropStyle.circle, // 円形にクロップ
            ),
          ],
        );

        if (croppedFile != null) {
          imageFile.value = File(croppedFile.path);
        } else {
          debugPrint('クロップがキャンセルされました');
        }
      } else {
        debugPrint('画像選択がキャンセルされました');
      }
    }

    /// 写真を削除
    void deleteImage() {
      imageFile.value = null;
      debugPrint('画像が削除されました');
    }

    return Scaffold(
      appBar: AppBar(title: const Text('GuildCreatePage')),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            imageFile.value != null
                ? Column(
                    children: [
                      ClipRRect(
                        borderRadius: BorderRadius.circular(8),
                        child: Image.file(
                          imageFile.value!,
                          width: 150,
                          height: 150,
                          fit: BoxFit.cover,
                        ),
                      ),
                      const SizedBox(height: 10),
                      ElevatedButton(
                        onPressed: deleteImage,
                        child: const Text('画像を削除'),
                      ),
                    ],
                  )
                : const Text('画像が選択されていません'),
            const SizedBox(height: 20),
            ElevatedButton(
              onPressed: () async {
                final status = await _checkPhotoPermission(context);
                if (status == PermissionStatus.granted || status == PermissionStatus.limited) {
                  await pickAndCropImage();
                }
              },
              child: const Text('ギルドアイコンを選択'),
            ),
            ElevatedButton(
              onPressed: () {
                context.pop();
              },
              child: const Text('Create'),
            ),
          ],
        ),
      ),
    );
  }

  /// 写真の権限をチェックする
  Future&lt;PermissionStatus&gt; _checkPhotoPermission(BuildContext context) async {
    final status = await Permission.photos.request();

    if (status.isGranted) {
      // 許可済みの場合
      return status;
    } else if (status.isPermanentlyDenied) {
      // 永久に拒否されている場合
      if (context.mounted) {
        _showPermissionDialog(context);
      }
    } else {
      // その他のケース
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('写真へのアクセスが許可されていません。')),
        );
      }
    }
    return status;
  }

  /// 設定ダイアログを表示
  void _showPermissionDialog(BuildContext context) {
    showDialog&lt;void&gt;(
      context: context,
      builder: (context) =&gt; AlertDialog(
        title: const Text('写真へのアクセス許可が必要です'),
        content: const Text('写真を選択するには、設定で写真へのアクセス許可をオンにしてください。'),
        actions: [
          TextButton(
            onPressed: () {
              context.pop();
            },
            child: const Text('キャンセル'),
          ),
          TextButton(
            onPressed: () async =&gt; openAppSettings(),
            child: const Text('設定を開く'),
          ),
        ],
      ),
    );
  }
}

---

## 🤖 Assistant
*2024-12-20 14:05:41*

`pickAndCropImage` の実行を `_checkPhotoPermission` 内に含めることは可能です。しかし、責務が混ざることで、コードの可読性や保守性が低下する可能性があります。それでも実行したい場合は、以下のように `_checkPhotoPermission` を改修して実現できます。

以下の変更例では、権限チェックが成功した場合に自動的に `pickAndCropImage` が呼び出されるようになります。

### 修正例

```dart
/// 写真の権限をチェックし、許可されている場合は画像を選択してクロップする
Future<void> _checkPhotoPermissionAndPickImage(BuildContext context, ValueNotifier<File?> imageFile, ImagePicker picker) async {
  final status = await Permission.photos.request();

  if (status.isGranted) {
    // 許可済みの場合、画像を選択してクロップ
    final pickedFile = await picker.pickImage(source: ImageSource.gallery);

    if (pickedFile != null) {
      final croppedFile = await ImageCropper().cropImage(
        sourcePath: pickedFile.path,
        aspectRatio: const CropAspectRatio(ratioX: 1, ratioY: 1), // 正方形にクロップ
        uiSettings: [
          AndroidUiSettings(
            hideBottomControls: true, // ボトムコントロール非表示
            lockAspectRatio: true, // アスペクト比を固定
          ),
          IOSUiSettings(
            aspectRatioLockEnabled: true, // アスペクト比を固定
          ),
        ],
      );

      if (croppedFile != null) {
        imageFile.value = File(croppedFile.path);
      } else {
        debugPrint('クロップがキャンセルされました');
      }
    } else {
      debugPrint('画像選択がキャンセルされました');
    }
  } else if (status.isPermanentlyDenied) {
    // 永久に拒否されている場合
    if (context.mounted) {
      _showPermissionDialog(context);
    }
  } else {
    // その他のケース
    if (context.mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('写真へのアクセスが許可されていません。')),
      );
    }
  }
}
```

### 修正後の `ElevatedButton` の実装

ボタンから直接 `_checkPhotoPermissionAndPickImage` を呼び出します。

```dart
ElevatedButton(
  onPressed: () async {
    await _checkPhotoPermissionAndPickImage(context, imageFile, picker);
  },
  child: const Text('ギルドアイコンを選択'),
),
```

### メリット

- ボタンの `onPressed` 内での責務が減り、権限チェックと画像処理がひとまとまりになります。

### デメリット

- `_checkPhotoPermissionAndPickImage` が複数の責務（権限チェック＋画像選択＋クロップ）を持つため、再利用性が下がる可能性があります。

上記のように改修すれば、希望する動作を実現できますが、関数の責務を適切に分けるべきかどうかも検討してください。

---
