# 柔軟な高さ設定

Date: 2024-12-13

---

## 👤 User
*2024-12-13 14:18:24*

今だと50%の高さ固定なので、柔軟にしたい

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:hooks_riverpod/hooks_riverpod.dart';
import 'package:snpit_guild_app/domain/screen.dart';
import 'package:snpit_guild_app/presentation/pages/explorer_list_page.dart';
import 'package:snpit_guild_app/presentation/providers/show_explorer_list.dart';
import 'package:snpit_guild_app/presentation/providers/show_spot_list.dart';
import 'package:snpit_guild_app/presentation/router/spot_list_router.dart';

class TabPage extends HookConsumerWidget {
  const TabPage({required this.navigationShell, super.key});
  final StatefulNavigationShell navigationShell;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    ref
      ..listen&lt;bool&gt;(showExplorerListNotifierProvider, (previous, next) {
        if (next) {
          _showExploreListSheet(context, ref);
        }
      })
      ..listen&lt;bool&gt;(showSpotListNotifierProvider, (previous, next) {
        if (next) {
          _showSpotListSheet(context, ref);
        }
      });

    return Scaffold(
      appBar: AppBar(
        leadingWidth: 100,
        leading: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            IconButton(
              icon: const Icon(Icons.person),
              onPressed: () {
                context.push(Screen.myPage.path);
              },
            ),
            IconButton(
              icon: const Icon(Icons.notifications),
              onPressed: () {
                context.push(Screen.notificationList.path);
              },
            ),
          ],
        ),
        actions: [
          Padding(
            padding: const EdgeInsets.only(right: 16),
            child: InkWell(
              onTap: () {
                context.push(Screen.wallet.path);
              },
              child: const Row(
                children: [
                  Icon(Icons.token, size: 20),
                  SizedBox(width: 4),
                  Text('35.05 STP'), // TODO: 仮データ
                ],
              ),
            ),
          ),
        ],
      ),
      body: navigationShell,
      bottomNavigationBar: BottomNavigationBar(
        currentIndex: navigationShell.currentIndex,
        onTap: navigationShell.goBranch,
        items: const [
          BottomNavigationBarItem(icon: Icon(Icons.map), label: 'Map'),
          BottomNavigationBarItem(icon: Icon(Icons.group), label: 'Guild'),
        ],
      ),
    );
  }

  void _showExploreListSheet(BuildContext context, WidgetRef ref) {
    showModalBottomSheet&lt;void&gt;(
      context: context,
      isScrollControlled: true,
      builder: (context) {
        return const FractionallySizedBox(
          heightFactor: 0.5,
          child: ClipRRect(
            borderRadius: BorderRadius.vertical(top: Radius.circular(16)),
            child: ExplorerListPage(),
          ),
        );
      },
    ).then((_) {
      ref.read(showExplorerListNotifierProvider.notifier).hide();
    });
  }

  void _showSpotListSheet(BuildContext context, WidgetRef ref) {
    // sheet が立ち上がるタイミングで最初の画面にリセットしないと、sheet を表示したときに前回閉じた画面が表示される
    spotListRouter.go(Screen.spotList.path);

    showModalBottomSheet&lt;void&gt;(
      context: context,
      isScrollControlled: true,
      builder: (context) {
        return FractionallySizedBox(
          heightFactor: 0.5,
          child: ClipRRect(
            borderRadius: const BorderRadius.vertical(top: Radius.circular(16)),
            child: MaterialApp.router(
              routerConfig: spotListRouter,
              debugShowCheckedModeBanner: false,
            ),
          ),
        );
      },
    ).then((_) {
      ref.read(showSpotListNotifierProvider.notifier).hide();
    });
  }
}

---

## 🤖 Assistant
*2024-12-13 14:18:42*

`FractionallySizedBox` の `heightFactor` を固定値 (例えば 0.5) から、柔軟に変更可能な実装にするために、関数引数として高さを受け取るように変更することを提案します。また、各モーダルシートで高さを設定できるようにします。

以下は修正版のコードです：

```dart
void _showExploreListSheet(BuildContext context, WidgetRef ref, {double? heightFactor}) {
  showModalBottomSheet<void>(
    context: context,
    isScrollControlled: true,
    builder: (context) {
      return FractionallySizedBox(
        heightFactor: heightFactor ?? 0.5, // デフォルト値を 0.5 に設定
        child: ClipRRect(
          borderRadius: const BorderRadius.vertical(top: Radius.circular(16)),
          child: const ExplorerListPage(),
        ),
      );
    },
  ).then((_) {
    ref.read(showExplorerListNotifierProvider.notifier).hide();
  });
}

void _showSpotListSheet(BuildContext context, WidgetRef ref, {double? heightFactor}) {
  spotListRouter.go(Screen.spotList.path);

  showModalBottomSheet<void>(
    context: context,
    isScrollControlled: true,
    builder: (context) {
      return FractionallySizedBox(
        heightFactor: heightFactor ?? 0.5, // デフォルト値を 0.5 に設定
        child: ClipRRect(
          borderRadius: const BorderRadius.vertical(top: Radius.circular(16)),
          child: MaterialApp.router(
            routerConfig: spotListRouter,
            debugShowCheckedModeBanner: false,
          ),
        ),
      );
    },
  ).then((_) {
    ref.read(showSpotListNotifierProvider.notifier).hide();
  });
}
```

また、呼び出し元で高さを指定できるようにします：

```dart
ref.listen<bool>(showExplorerListNotifierProvider, (previous, next) {
  if (next) {
    _showExploreListSheet(context, ref, heightFactor: 0.7); // 高さを柔軟に指定
  }
});

ref.listen<bool>(showSpotListNotifierProvider, (previous, next) {
  if (next) {
    _showSpotListSheet(context, ref, heightFactor: 0.8); // 高さを柔軟に指定
  }
});
```

### 修正ポイント
1. **高さの柔軟性**: `heightFactor` をパラメータとして受け取り、デフォルト値を設定。
2. **呼び出し元の柔軟性**: 必要に応じて異なる高さを指定可能。
3. **デフォルト設定**: 明示的に高さを指定しない場合、デフォルト値（0.5）が使用される。

これにより、モーダルシートの高さを柔軟に設定できるようになります。

---

## 👤 User
*2024-12-13 14:20:54*

そうではなくて、SwiftUIの.presentationDetents([
    .medium,
    .large,
])のように止めたい。

---

## 🤖 Assistant
*2024-12-13 14:21:13*

Flutterでは、SwiftUIの`.presentationDetents`に相当するような動作を実現するには、`showModalBottomSheet`のカスタムウィジェット内でドラッグ操作に応じて高さを調整する実装が必要です。

以下は、`DraggableScrollableSheet`を使用して、SwiftUIの`.presentationDetents`のような挙動を模倣するコード例です。

### 改良コード

```dart
void _showExploreListSheet(BuildContext context, WidgetRef ref) {
  showModalBottomSheet<void>(
    context: context,
    isScrollControlled: true,
    shape: const RoundedRectangleBorder(
      borderRadius: BorderRadius.vertical(top: Radius.circular(16)),
    ),
    builder: (context) {
      return DraggableScrollableSheet(
        initialChildSize: 0.5, // 最初の高さ（50%）
        minChildSize: 0.3, // 最小高さ（30%）
        maxChildSize: 0.9, // 最大高さ（90%）
        builder: (context, scrollController) {
          return ClipRRect(
            borderRadius: const BorderRadius.vertical(top: Radius.circular(16)),
            child: SingleChildScrollView(
              controller: scrollController,
              child: const ExplorerListPage(),
            ),
          );
        },
      );
    },
  ).then((_) {
    ref.read(showExplorerListNotifierProvider.notifier).hide();
  });
}

void _showSpotListSheet(BuildContext context, WidgetRef ref) {
  spotListRouter.go(Screen.spotList.path);

  showModalBottomSheet<void>(
    context: context,
    isScrollControlled: true,
    shape: const RoundedRectangleBorder(
      borderRadius: BorderRadius.vertical(top: Radius.circular(16)),
    ),
    builder: (context) {
      return DraggableScrollableSheet(
        initialChildSize: 0.5, // 最初の高さ（50%）
        minChildSize: 0.3, // 最小高さ（30%）
        maxChildSize: 0.9, // 最大高さ（90%）
        builder: (context, scrollController) {
          return ClipRRect(
            borderRadius: const BorderRadius.vertical(top: Radius.circular(16)),
            child: MaterialApp.router(
              routerConfig: spotListRouter,
              debugShowCheckedModeBanner: false,
              builder: (context, child) {
                return SingleChildScrollView(
                  controller: scrollController,
                  child: child,
                );
              },
            ),
          );
        },
      );
    },
  ).then((_) {
    ref.read(showSpotListNotifierProvider.notifier).hide();
  });
}
```

### 修正ポイント
1. **`DraggableScrollableSheet`の使用**:
   - 高さをドラッグ操作で変更可能にし、`minChildSize`, `initialChildSize`, `maxChildSize`で高さの範囲を指定。
   
2. **`SingleChildScrollView`でスクロール制御**:
   - `scrollController`を渡して、ドラッグ可能なシート内でスクロールを制御。

3. **デザインの一貫性**:
   - 上部の角を丸めるために`RoundedRectangleBorder`を適用。

### 動作
- シートをスワイプで上下に動かすことで高さを変更可能。
- 最小（`minChildSize`）、初期（`initialChildSize`）、最大（`maxChildSize`）の高さを設定。
- 例えば、`0.3`は画面全体の30%を表します。

この実装で、SwiftUIの`.presentationDetents`に近い動作がFlutterで再現できます。

---
