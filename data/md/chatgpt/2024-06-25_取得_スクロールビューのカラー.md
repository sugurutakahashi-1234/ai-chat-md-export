# 取得:スクロールビューのカラー

日付: 2024-06-25

---

## 👤 ユーザー
*2024/6/25 9:54:13*

スクロールビューで今画面に表示しているカラー名を取得したい。

public struct SimpleScrollDesignView: View {
    let items: [ScrollDesignViewItem]

    public var body: some View {
        GeometryReader { geometry in
            ScrollView(.horizontal) {
                LazyHStack(spacing: 15) {
                    ForEach(items) { item in
                        RoundedRectangle(cornerRadius: 16)
                            .fill(item.color.gradient)
                            .frame(width: geometry.size.width - 60)
                    }
                }
                .padding(.horizontal, 32)
            }
            .scrollIndicators(.hidden)
        }
        .frame(height: 100)
    }
}


struct ScrollDesignViewItem: Identifiable, Hashable {
    let id: String = UUID().uuidString
    let color: Color
}

---

## 🤖 アシスタント
*2024/6/25 9:54:37*

画面に表示されているカラー名を取得するためには、スクロールビューの表示範囲を監視し、表示されているアイテムを特定するロジックを追加する必要があります。以下のように `onAppear` と `onChange` モディファイアを使ってスクロール位置を監視し、表示されているカラー名を取得できます。

```swift
import SwiftUI

public struct SimpleScrollDesignView: View {
    let items: [ScrollDesignViewItem]

    @State private var visibleColorNames: [String] = []

    public var body: some View {
        GeometryReader { geometry in
            ScrollView(.horizontal) {
                LazyHStack(spacing: 15) {
                    ForEach(items) { item in
                        RoundedRectangle(cornerRadius: 16)
                            .fill(item.color.gradient)
                            .frame(width: geometry.size.width - 60)
                            .background(
                                GeometryReader { itemGeometry in
                                    Color.clear
                                        .preference(key: ViewOffsetKey.self, value: itemGeometry.frame(in: .global))
                                }
                            )
                    }
                }
                .padding(.horizontal, 32)
            }
            .scrollIndicators(.hidden)
            .onPreferenceChange(ViewOffsetKey.self) { preferences in
                updateVisibleColors(with: preferences, in: geometry.frame(in: .global).minX...geometry.frame(in: .global).maxX)
            }
        }
        .frame(height: 100)
        .overlay(
            Text("Visible Colors: \(visibleColorNames.joined(separator: ", "))")
                .foregroundColor(.black)
                .padding()
                .background(Color.white.opacity(0.7))
                .cornerRadius(10)
                .padding()
                , alignment: .top
        )
    }

    private func updateVisibleColors(with preferences: [CGRect], in scrollRange: ClosedRange<CGFloat>) {
        let visibleItems = items.enumerated().filter { index, _ in
            let frame = preferences[index]
            return frame.minX < scrollRange.upperBound && frame.maxX > scrollRange.lowerBound
        }
        visibleColorNames = visibleItems.map { $0.element.color.description }
    }
}

struct ScrollDesignViewItem: Identifiable, Hashable {
    let id: String = UUID().uuidString
    let color: Color
}

// Custom preference key to store frame data
struct ViewOffsetKey: PreferenceKey {
    typealias Value = [CGRect]

    static var defaultValue: [CGRect] = []

    static func reduce(value: inout [CGRect], nextValue: () -> [CGRect]) {
        value.append(contentsOf: nextValue())
    }
}
```

このコードでは、各 `RoundedRectangle` の背景に透明な `GeometryReader` を配置し、そのフレームをカスタム `PreferenceKey` を使って収集します。スクロールビューの位置が変わるたびに `onPreferenceChange` モディファイアでフレーム情報が更新され、表示範囲に基づいて現在表示されているカラー名を特定します。

この方法により、現在スクロールビューに表示されているカラー名を取得し、画面上部にオーバーレイとして表示できます。

---

## 👤 ユーザー
*2024/6/25 9:58:47*

ViewOffsetKey とは？

---

## 🤖 アシスタント
*2024/6/25 9:59:19*

`ViewOffsetKey` は、SwiftUI の `PreferenceKey` を使用して、ビューの位置情報を収集するためのカスタムキーです。このキーを使用することで、各ビューのフレームデータを取得し、それを基にスクロールビューの表示範囲を判断することができます。

以下は `ViewOffsetKey` の定義とその使い方の詳細です。

### ViewOffsetKey の定義

`ViewOffsetKey` は、各ビューの位置情報（フレーム）を収集するための `PreferenceKey` です。

```swift
import SwiftUI

// Custom preference key to store frame data
struct ViewOffsetKey: PreferenceKey {
    typealias Value = [CGRect]

    // The default value for the preference
    static var defaultValue: [CGRect] = []

    // Combines a new value with the current value
    static func reduce(value: inout [CGRect], nextValue: () -> [CGRect]) {
        value.append(contentsOf: nextValue())
    }
}
```

### 使い方の説明

1. **カスタム `PreferenceKey` の定義**:
    - `defaultValue`: `PreferenceKey` が保持するデフォルトの値。ここでは空の `CGRect` 配列を指定しています。
    - `reduce`: 新しい値を既存の値に結合するためのメソッド。ここでは新しいフレームデータを既存の配列に追加しています。

2. **各ビューの位置情報の収集**:
    - 各 `RoundedRectangle` に対して透明な `GeometryReader` を配置し、そのフレーム情報を `ViewOffsetKey` に渡します。

```swift
.background(
    GeometryReader { itemGeometry in
        Color.clear
            .preference(key: ViewOffsetKey.self, value: [itemGeometry.frame(in: .global)])
    }
)
```

3. **スクロールビューの位置変更に応じた処理**:
    - `onPreferenceChange` モディファイアを使って、フレーム情報が変更されたときに `updateVisibleColors` 関数を呼び出し、表示範囲に基づいて表示されているカラー名を更新します。

```swift
.onPreferenceChange(ViewOffsetKey.self) { preferences in
    updateVisibleColors(with: preferences, in: geometry.frame(in: .global).minX...geometry.frame(in: .global).maxX)
}
```

### 完全なコード

以下が、上記の説明を含む完全なコードです。

```swift
import SwiftUI

public struct SimpleScrollDesignView: View {
    let items: [ScrollDesignViewItem]

    @State private var visibleColorNames: [String] = []

    public var body: some View {
        GeometryReader { geometry in
            ScrollView(.horizontal) {
                LazyHStack(spacing: 15) {
                    ForEach(items) { item in
                        RoundedRectangle(cornerRadius: 16)
                            .fill(item.color.gradient)
                            .frame(width: geometry.size.width - 60)
                            .background(
                                GeometryReader { itemGeometry in
                                    Color.clear
                                        .preference(key: ViewOffsetKey.self, value: [itemGeometry.frame(in: .global)])
                                }
                            )
                    }
                }
                .padding(.horizontal, 32)
            }
            .scrollIndicators(.hidden)
            .onPreferenceChange(ViewOffsetKey.self) { preferences in
                updateVisibleColors(with: preferences, in: geometry.frame(in: .global).minX...geometry.frame(in: .global).maxX)
            }
        }
        .frame(height: 100)
        .overlay(
            Text("Visible Colors: \(visibleColorNames.joined(separator: ", "))")
                .foregroundColor(.black)
                .padding()
                .background(Color.white.opacity(0.7))
                .cornerRadius(10)
                .padding()
                , alignment: .top
        )
    }

    private func updateVisibleColors(with preferences: [CGRect], in scrollRange: ClosedRange<CGFloat>) {
        let visibleItems = items.enumerated().filter { index, _ in
            let frame = preferences[index]
            return frame.minX < scrollRange.upperBound && frame.maxX > scrollRange.lowerBound
        }
        visibleColorNames = visibleItems.map { $0.element.color.description }
    }
}

struct ScrollDesignViewItem: Identifiable, Hashable {
    let id: String = UUID().uuidString
    let color: Color
}

// Custom preference key to store frame data
struct ViewOffsetKey: PreferenceKey {
    typealias Value = [CGRect]

    static var defaultValue: [CGRect] = []

    static func reduce(value: inout [CGRect], nextValue: () -> [CGRect]) {
        value.append(contentsOf: nextValue())
    }
}
```

このコードは、スクロールビューの表示範囲にあるアイテムのカラー名を取得して表示するためのフルセットの例です。

---
