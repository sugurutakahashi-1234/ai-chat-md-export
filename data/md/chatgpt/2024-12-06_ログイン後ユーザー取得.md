# ログイン後ユーザー取得

日付: 2024-12-06

---

## 👤 ユーザー
*2024/12/6 18:01:52*

flutterでログインボタンを押した後にgetUsersを呼んで、リストの中からランダムに取得したuserを保持したい。

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';

class LoginPage extends StatelessWidget {
  const LoginPage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('Login')),
      body: Center(
        child: ElevatedButton(
          onPressed: () {
            // ログイン成功後、タブページへ遷移
            context.go('/map');
          },
          child: const Text('Login'),
        ),
      ),
    );
  }
}
# openapi (EXPERIMENTAL)
No description provided (generated by Openapi Generator https://github.com/openapitools/openapi-generator)

This Dart package is automatically generated by the [OpenAPI Generator](https://openapi-generator.tech) project:

- API version: 1.0.0
- Generator version: 7.10.0
- Build package: org.openapitools.codegen.languages.DartDioClientCodegen

## Requirements

* Dart 2.15.0+ or Flutter 2.8.0+
* Dio 5.0.0+ (https://pub.dev/packages/dio)

## Installation & Usage

### pub.dev
To use the package from [pub.dev](https://pub.dev), please include the following in pubspec.yaml
```yaml
dependencies:
  openapi: 1.0.0
```

### Github
If this Dart package is published to Github, please include the following in pubspec.yaml
```yaml
dependencies:
  openapi:
    git:
      url: https://github.com/GIT_USER_ID/GIT_REPO_ID.git
      #ref: main
```

### Local development
To use the package from your local drive, please include the following in pubspec.yaml
```yaml
dependencies:
  openapi:
    path: /path/to/openapi
```

## Getting Started

Please follow the [installation procedure](#installation--usage) and then run the following:

```dart
import 'package:openapi/openapi.dart';


final api = Openapi().getDefaultApi();
final int id = 56; // int | The id of the user to retrieve

try {
    final response = await api.getUserById(id);
    print(response);
} catch on DioException (e) {
    print("Exception when calling DefaultApi->getUserById: $e\n");
}

```

## Documentation for API Endpoints

All URIs are relative to *https://jsonplaceholder.typicode.com*

Class | Method | HTTP request | Description
------------ | ------------- | ------------- | -------------
[*DefaultApi*](doc/DefaultApi.md) | [**getUserById**](doc/DefaultApi.md#getuserbyid) | **GET** /users/{id} | Get a user by ID
[*DefaultApi*](doc/DefaultApi.md) | [**getUsers**](doc/DefaultApi.md#getusers) | **GET** /users | Get a list of users


## Documentation For Models

 - [Error](doc/Error.md)
 - [User](doc/User.md)
 - [UserAddress](doc/UserAddress.md)
 - [UserAddressGeo](doc/UserAddressGeo.md)
 - [UserCompany](doc/UserCompany.md)


## Documentation For Authorization

Endpoints do not require authorization.


## Author

---

## 🤖 アシスタント
*2024/12/6 18:02:19*

以下のように、`getUsers` メソッドを使用してリストからランダムなユーザーを取得し、そのユーザーを保持するようにコードを変更できます。この例では、Flutterの状態管理ライブラリ `flutter_hooks` を利用して状態を管理しつつ、ユーザー取得処理を実装しています。

### 完成コード

```dart
import 'dart:math';

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:openapi/openapi.dart';

class LoginPage extends HookConsumerWidget {
  const LoginPage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return Scaffold(
      appBar: AppBar(title: const Text('Login')),
      body: Center(
        child: ElevatedButton(
          onPressed: () async {
            try {
              // ユーザーリストを取得
              final users = await _fetchUsers();

              // ランダムなユーザーを選択
              final randomUser = _selectRandomUser(users);

              // 選択したユーザーを状態として保持 (例: Providerを通じてグローバルに保持)
              ref.read(userProvider.notifier).state = randomUser;

              // ログイン成功後、タブページへ遷移
              context.go('/map');
            } catch (e) {
              // エラー処理
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(content: Text('Failed to fetch users: $e')),
              );
            }
          },
          child: const Text('Login'),
        ),
      ),
    );
  }

  Future<List<User>> _fetchUsers() async {
    final api = Openapi().getDefaultApi();
    final response = await api.getUsers();
    return response.data ?? [];
  }

  User _selectRandomUser(List<User> users) {
    final randomIndex = Random().nextInt(users.length);
    return users[randomIndex];
  }
}

// グローバルなユーザー状態管理用のProvider
final userProvider = StateProvider<User?>((ref) => null);
```

### 解説

1. **ユーザーリストの取得**:
   - OpenAPI Generatorで生成された`DefaultApi`クラスの`getUsers`メソッドを使用してユーザーリストを取得しています。
   - デフォルトのエンドポイント（`https://jsonplaceholder.typicode.com/users`）を叩きます。

2. **ランダムなユーザー選択**:
   - Dartの`Random`クラスを使用して、取得したリストからランダムなインデックスを選択し、そのユーザーを取り出します。

3. **ユーザー状態の保持**:
   - `flutter_hooks`の`StateProvider`を使用して、選択したユーザーをグローバルに保持します。この状態は他のページでも参照可能です。

4. **エラーハンドリング**:
   - API呼び出しでエラーが発生した場合に備え、`try-catch`を使ってエラーメッセージをSnackBarで表示します。

5. **ルーティング遷移**:
   - ユーザーが正常に選択されると、`context.go('/map')`で次のページに遷移します。

このコードにより、ログインボタンを押した後にランダムなユーザーを取得して保持し、次のページに遷移する処理が実現できます。

---

## 👤 ユーザー
*2024/12/6 18:02:38*

dioを使ってほしい。

---

## 🤖 アシスタント
*2024/12/6 18:03:03*

以下は、Dioを使用してユーザーリストを取得し、ランダムなユーザーを選択して保持するコードです。

### 完成コード

```dart
import 'dart:math';

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:dio/dio.dart';
import 'package:go_router/go_router.dart';

// グローバルなユーザー状態管理用のProvider
final userProvider = StateProvider<Map<String, dynamic>?>((ref) => null);

class LoginPage extends ConsumerWidget {
  const LoginPage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return Scaffold(
      appBar: AppBar(title: const Text('Login')),
      body: Center(
        child: ElevatedButton(
          onPressed: () async {
            try {
              // ユーザーリストを取得
              final users = await _fetchUsers();

              // ランダムなユーザーを選択
              final randomUser = _selectRandomUser(users);

              // 選択したユーザーを状態として保持
              ref.read(userProvider.notifier).state = randomUser;

              // ログイン成功後、タブページへ遷移
              context.go('/map');
            } catch (e) {
              // エラー処理
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(content: Text('Failed to fetch users: $e')),
              );
            }
          },
          child: const Text('Login'),
        ),
      ),
    );
  }

  Future<List<Map<String, dynamic>>> _fetchUsers() async {
    try {
      final dio = Dio();
      final response = await dio.get('https://jsonplaceholder.typicode.com/users');

      if (response.statusCode == 200) {
        // ユーザーリストを返す
        return List<Map<String, dynamic>>.from(response.data);
      } else {
        throw Exception('Failed to fetch users: ${response.statusCode}');
      }
    } catch (e) {
      throw Exception('Error fetching users: $e');
    }
  }

  Map<String, dynamic> _selectRandomUser(List<Map<String, dynamic>> users) {
    final randomIndex = Random().nextInt(users.length);
    return users[randomIndex];
  }
}
```

---

### 主な変更点とポイント

1. **Dioの使用**:
   - `Dio`パッケージを使用してHTTPリクエストを行い、`https://jsonplaceholder.typicode.com/users`からユーザーリストを取得します。
   - レスポンスの`statusCode`を確認して、成功時のみデータを返します。

2. **ユーザーリストの型**:
   - Dioのレスポンスデータを`List<Map<String, dynamic>>`に変換して扱います。これにより、柔軟なデータ操作が可能です。

3. **グローバル状態の管理**:
   - ランダムに選択したユーザーをRiverpodの`StateProvider`で管理します。他のページでも選択したユーザー情報を参照可能です。

4. **エラーハンドリング**:
   - ネットワークエラーやサーバーエラーが発生した場合に備え、`try-catch`でエラー処理を行います。エラー内容はSnackBarでユーザーに通知します。

---

### このコードの実行に必要なパッケージ

以下を`pubspec.yaml`に追加してください：

```yaml
dependencies:
  dio: ^5.0.0
  flutter_riverpod: ^2.0.0
  go_router: ^5.0.0
```

---

### 次のステップ
- ログイン後の画面（`/map`）で選択したユーザー情報を表示するには、`userProvider`を使用してデータを取得できます。

---
