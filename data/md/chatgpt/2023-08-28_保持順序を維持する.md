# ä¿æŒé †åºã‚’ç¶­æŒã™ã‚‹

æ—¥ä»˜: 2023-08-28

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2023/8/29 1:50:06*

ã“ã®å‡¦ç†ã«ã¤ã„ã¦ã€é…åˆ—ã®é †ç•ªã‚’ç¶­æŒã™ã‚‹ã‚ˆã†ã«ã—ã¦æ¬²ã—ã„

func convertToDomainEntity(amplifyResearchs: \[Research\]) async throws -&gt; \[EmomilCore.Research\] {
        try await withThrowingTaskGroup(of: EmomilCore.Research.self) { group in
            for amplifyResearch in amplifyResearchs {
                group.addTask {
                    try await self.convertToDomainEntity(amplifyResearch: amplifyResearch)
                }
            }
            var domainResearches: \[EmomilCore.Research\] = \[\]
            for try await domainResearch in group {
                domainResearches.append(domainResearch)
            }
            
            // ã€ãƒ‡ã‚°ãƒ¬ã€‘ã€ãŠé¡˜ã„ãƒªã‚¹ãƒˆã€‘ãŠé¡˜ã„ä¸€è¦§ã®ã‚µãƒ ãƒã‚¤ãƒ«ã‚’éåŒæœŸå‡¦ç†ã§å–å¾—ã™ã‚‹å½±éŸ¿ã§é †ç•ªãŒä¿æŒã•ã‚Œãªããªã£ã¦ã—ã¾ã£ã¦ã„ã‚‹ #638
            // https://github.com/Viagate/emomil-app-ios/issues/638
            
            // TODO: orderã‚’é€ã£ã¦æ¬²ã—ã„ï¼ˆç¾çŠ¶ã€é †ç•ªãŒå…¥ã‚Œæ›¿ã‚ã£ã¦ãŠã‚Šã¾ã™ã€‚ã€‚ã€‚ï¼‰
            return domainResearches
        }
    }

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2023/8/29 1:50:43*

éåŒæœŸã‚¿ã‚¹ã‚¯ã¯ã€ã‚¿ã‚¹ã‚¯ãŒçµ‚äº†ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒç•°ãªã‚‹ãŸã‚ã€å…ƒã®é †åºãŒä¿æŒã•ã‚Œãªã„ã“ã¨ãŒã‚ˆãã‚ã‚Šã¾ã™ã€‚ã“ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã¯ã€`TaskGroup`ã®ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ãŸé †åºã¨åŒã˜é †åºã§çµæœã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã®æ–¹æ³•ã§é…åˆ—ã®é †åºã‚’ç¶­æŒã—ãªãŒã‚‰ã€å„ã‚¿ã‚¹ã‚¯ã®çµæœã‚’æ ¼ç´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™:

1. `domainResearches`ã®ã‚µã‚¤ã‚ºã‚’å…ƒã®`amplifyResearchs`ã¨åŒã˜ã‚µã‚¤ã‚ºã«åˆæœŸåŒ–ã—ã¾ã™ã€‚
2. å„ã‚¿ã‚¹ã‚¯ã§ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨˜éŒ²ã—ã€ãã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å¯¾å¿œã™ã‚‹`domainResearches`ã®ä½ç½®ã«çµæœã‚’æ ¼ç´ã—ã¾ã™ã€‚

ä»¥ä¸‹ãŒæ”¹å–„ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã§ã™ï¼š

```swift
func convertToDomainEntity(amplifyResearchs: [Research]) async throws -> [EmomilCore.Research] {
    try await withThrowingTaskGroup(of: (Int, EmomilCore.Research).self) { group in
        for (index, amplifyResearch) in amplifyResearchs.enumerated() {
            group.addTask {
                let domainResearch = try await self.convertToDomainEntity(amplifyResearch: amplifyResearch)
                return (index, domainResearch)
            }
        }
        var domainResearches: [EmomilCore.Research?] = Array(repeating: nil, count: amplifyResearchs.count)
        for try await (index, domainResearch) in group {
            domainResearches[index] = domainResearch
        }
        
        // çµæœã¨ã—ã¦Optionalã‚’å–ã‚Šé™¤ãã€ç¢ºå®Ÿã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ä¿è¨¼ã™ã‚‹
        return domainResearches.compactMap { $0 }
    }
}
```

ã“ã®å¤‰æ›´ã«ã‚ˆã‚Šã€å„ã‚¿ã‚¹ã‚¯ã®çµæœãŒæ­£ç¢ºãªé †åºã§`domainResearches`ã«æ ¼ç´ã•ã‚Œã€é †åºãŒç¶­æŒã•ã‚Œã¾ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2023/8/29 10:29:07*

var domainResearches: \[EmomilCore.Research?\] = Array(repeating: nil, count: amplifyResearchs.count) ã“ã‚Œã¯ã©ã†ã„ã†æ„å‘³ï¼Ÿ

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2023/8/29 10:29:40*

ã“ã®ã‚³ãƒ¼ãƒ‰ã®è¡Œã¯ã€Swiftã®é…åˆ—ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™ã€‚ç‰¹ã«ã€æ¬¡ã®ã“ã¨ã‚’è¡Œã£ã¦ã„ã¾ã™ï¼š

```swift
var domainResearches: [EmomilCore.Research?] = Array(repeating: nil, count: amplifyResearchs.count)
```

1. `domainResearches`ã¨ã„ã†å¤‰æ•°ã‚’å®£è¨€ã—ã¦ã„ã¾ã™ã€‚
2. å‹ã¯`[EmomilCore.Research?]`ã§ã€ã“ã‚Œã¯`EmomilCore.Research`ã®ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«å‹ã®é…åˆ—ã‚’æ„å‘³ã—ã¾ã™ã€‚ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«å‹ã¯ã€å€¤ãŒå­˜åœ¨ã™ã‚‹å ´åˆã‚„å­˜åœ¨ã—ãªã„å ´åˆ(nil)ã®2ã¤ã®çŠ¶æ…‹ã‚’æŒã¤ã“ã¨ãŒã§ãã¾ã™ã€‚
3. `Array(repeating: nil, count: amplifyResearchs.count)`ã¯ã€ç‰¹å®šã®å€¤ã‚’ç¹°ã‚Šè¿”ã—ã¦é…åˆ—ã‚’åˆæœŸåŒ–ã™ã‚‹æ–¹æ³•ã§ã™ã€‚ã“ã®å ´åˆã€`nil`ã‚’`amplifyResearchs.count`å›ç¹°ã‚Šè¿”ã—ã¦ã€ãã®å¤§ãã•ã®é…åˆ—ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚

ã“ã®ã‚³ãƒ¼ãƒ‰ã®ç›®çš„ã¯ã€`domainResearches`é…åˆ—ã‚’`amplifyResearchs`ã¨åŒã˜å¤§ãã•ã«åˆæœŸåŒ–ã—ã€ã™ã¹ã¦ã®è¦ç´ ã‚’`nil`ã§åŸ‹ã‚ã‚‹ã“ã¨ã§ã™ã€‚ãã®å¾Œã€éåŒæœŸã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã™ã‚‹ãŸã³ã«ã€`domainResearches`ã®ç‰¹å®šã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«çµæœã‚’æ ¼ç´ã—ã¾ã™ã€‚ã“ã®æ–¹æ³•ã§ã€ã‚¿ã‚¹ã‚¯ãŒçµ‚äº†ã™ã‚‹é †ç•ªã«é–¢ä¿‚ãªãã€å…ƒã®`amplifyResearchs`ã®é †åºã‚’ç¶­æŒã—ã¦`domainResearches`ã«çµæœã‚’æ ¼ç´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2023/8/29 10:30:34*

ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã‚’ä½¿ã‚ãªã„æ–¹æ³•ã£ã¦ãªã„ã®ã‹ãªï¼Ÿ

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2023/8/29 10:31:05*

ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã‚’ä½¿ç”¨ã›ãšã«é †åºã‚’ç¶­æŒã™ã‚‹æ–¹æ³•ã¯ã„ãã¤ã‹è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚ä¸€ã¤ã®æ–¹æ³•ã¨ã—ã¦ã€`domainResearches`ã‚’äº‹å‰ã«é ˜åŸŸã‚’ç¢ºä¿ã™ã‚‹ã®ã§ã¯ãªãã€å¾Œã‹ã‚‰çµæœã‚’æŒ¿å…¥ã™ã‚‹ã®ã«é©ã—ãŸæ–¹æ³•ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

å…·ä½“çš„ã«ã¯ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨çµæœã‚’çµ„ã«ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ä¸€æ™‚çš„ãªé…åˆ—ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚éåŒæœŸã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã™ã‚‹ãŸã³ã«ã“ã®é…åˆ—ã«çµæœã‚’è¿½åŠ ã—ã€å…¨ã¦ã®ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ãŸå¾Œã«ã“ã®ä¸€æ™‚çš„ãªé…åˆ—ã‚’ã‚½ãƒ¼ãƒˆã—ã¦ã€æ­£ã—ã„é †åºã§çµæœã‚’å–å¾—ã—ã¾ã™ã€‚

ä»¥ä¸‹ã¯ãã®å®Ÿè£…ä¾‹ã§ã™ï¼š

```swift
func convertToDomainEntity(amplifyResearchs: [Research]) async throws -> [EmomilCore.Research] {
    try await withThrowingTaskGroup(of: (Int, EmomilCore.Research).self) { group in
        for (index, amplifyResearch) in amplifyResearchs.enumerated() {
            group.addTask {
                let domainResearch = try await self.convertToDomainEntity(amplifyResearch: amplifyResearch)
                return (index, domainResearch)
            }
        }
        
        var tempResults: [(Int, EmomilCore.Research)] = []
        for try await result in group {
            tempResults.append(result)
        }
        
        // ä¸€æ™‚çš„ãªé…åˆ—ã‚’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ã‚½ãƒ¼ãƒˆ
        tempResults.sort(by: { $0.0 < $1.0 })
        
        // ã‚½ãƒ¼ãƒˆã•ã‚ŒãŸé…åˆ—ã‹ã‚‰EmomilCore.Researchã®å€¤ã®ã¿ã‚’æŠ½å‡º
        return tempResults.map { $0.1 }
    }
}
```

ã“ã®æ–¹æ³•ã§ã¯ã€ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã‚’ä½¿ç”¨ã›ãšã«éåŒæœŸã‚¿ã‚¹ã‚¯ã®çµæœã‚’æ­£ã—ã„é †åºã§å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2023/8/29 10:31:48*

tempResults ã®ã‚¿ãƒ—ãƒ«ã«å¤‰æ•°åã‚’ã¤ã‘ã¦å‡¦ç†ã‚’ã‚ã‹ã‚Šã‚„ã™ãã—ã¦æ¬²ã—ã„

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2023/8/29 10:32:13*

äº†è§£ã—ã¾ã—ãŸã€‚ã‚¿ãƒ—ãƒ«ã®å„è¦ç´ ã«å¤‰æ•°åã‚’ã¤ã‘ã‚‹ã“ã¨ã§ã€ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«æ”¹å–„ã—ã¾ã™ï¼š

```swift
func convertToDomainEntity(amplifyResearchs: [Research]) async throws -> [EmomilCore.Research] {
    try await withThrowingTaskGroup(of: (index: Int, domainResearch: EmomilCore.Research).self) { group in
        for (index, amplifyResearch) in amplifyResearchs.enumerated() {
            group.addTask {
                let domainResearch = try await self.convertToDomainEntity(amplifyResearch: amplifyResearch)
                return (index: index, domainResearch: domainResearch)
            }
        }
        
        var tempResults: [(index: Int, domainResearch: EmomilCore.Research)] = []
        for try await result in group {
            tempResults.append(result)
        }
        
        // ä¸€æ™‚çš„ãªé…åˆ—ã‚’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ã‚½ãƒ¼ãƒˆ
        tempResults.sort(by: { $0.index < $1.index })
        
        // ã‚½ãƒ¼ãƒˆã•ã‚ŒãŸé…åˆ—ã‹ã‚‰EmomilCore.Researchã®å€¤ã®ã¿ã‚’æŠ½å‡º
        return tempResults.map { $0.domainResearch }
    }
}
```

ã“ã®ã‚ˆã†ã«ã‚¿ãƒ—ãƒ«ã®å„è¦ç´ ã«åå‰ã‚’ã¤ã‘ã‚‹ã“ã¨ã§ã€ã©ã®è¦ç´ ãŒä½•ã‚’æ„å‘³ã™ã‚‹ã®ã‹ãŒæ˜ç¢ºã«ãªã‚Šã€ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ãŒå‘ä¸Šã—ã¾ã™ã€‚

---
