# Add 1s Delay.

日付: 2023-06-13

---

## 👤 ユーザー
*2023/06/13 20:44:56*

以下のMissionとMissionの配列を返却する関数のHandlerについて、レスポンスを返す前に1秒の遅延処理を入れたいのだけれどもどうすればいい？


import Combine
import Foundation

public final class ApiRequestManagerProtocolMock: ApiRequestManagerProtocol {
    public init() {}

    public private(set) var getUserCallCount = 0
    public var getUserHandler: (() async throws -&gt; (User))?
    public func getUser() async throws -&gt; User {
        getUserCallCount += 1
        if let getUserHandler {
            return try await getUserHandler()
        }
        fatalError("getUserHandler returns can't have a default value thus its handler must be set")
    }

    public private(set) var getUserAttributeContentsCallCount = 0
    public var getUserAttributeContentsHandler: (() async throws -&gt; (UserAttributeContents))?
    public func getUserAttributeContents() async throws -&gt; UserAttributeContents {
        getUserAttributeContentsCallCount += 1
        if let getUserAttributeContentsHandler {
            return try await getUserAttributeContentsHandler()
        }
        fatalError("getUserAttributeContentsHandler returns can't have a default value thus its handler must be set")
    }

    public private(set) var getUserAttributeCallCount = 0
    public var getUserAttributeHandler: (() async throws -&gt; (UserAttributes))?
    public func getUserAttribute() async throws -&gt; UserAttributes {
        getUserAttributeCallCount += 1
        if let getUserAttributeHandler {
            return try await getUserAttributeHandler()
        }
        fatalError("getUserAttributeHandler returns can't have a default value thus its handler must be set")
    }

    public private(set) var getMissionListCallCount = 0
    public var getMissionListHandler: ((MeasurementType?) async throws -&gt; ([Mission]))? = { _ in
        [.dummy, .dummy] // TODO: 仮
    }
    public func getMissionList(measurementType: MeasurementType?) async throws -&gt; [Mission] {
        getMissionListCallCount += 1
        if let getMissionListHandler {
            return try await getMissionListHandler(measurementType)
        }
        return [Mission]()
    }

    public private(set) var getMissionCallCount = 0
    public var getMissionHandler: ((String) async throws -&gt; (Mission))? = { _ in
        .dummy // TODO: 仮
    }
    public func getMission(id: String) async throws -&gt; Mission {
        getMissionCallCount += 1
        if let getMissionHandler {
            return try await getMissionHandler(id)
        }
        fatalError("getMissionHandler returns can't have a default value thus its handler must be set")
    }

    public private(set) var getVideoMeasurementCallCount = 0
    public var getVideoMeasurementHandler: ((String) async throws -&gt; (VideoMeasurement))?
    public func getVideoMeasurement(id: String) async throws -&gt; VideoMeasurement {
        getVideoMeasurementCallCount += 1
        if let getVideoMeasurementHandler {
            return try await getVideoMeasurementHandler(id)
        }
        fatalError("getVideoMeasurementHandler returns can't have a default value thus its handler must be set")
    }

    public private(set) var getWebsiteMeasurementCallCount = 0
    public var getWebsiteMeasurementHandler: ((String) async throws -&gt; (WebsiteMeasurement))?
    public func getWebsiteMeasurement(id: String) async throws -&gt; WebsiteMeasurement {
        getWebsiteMeasurementCallCount += 1
        if let getWebsiteMeasurementHandler {
            return try await getWebsiteMeasurementHandler(id)
        }
        fatalError("getWebsiteMeasurementHandler returns can't have a default value thus its handler must be set")
    }

    public private(set) var getPointHistoriesCallCount = 0
    public var getPointHistoriesHandler: (() async throws -&gt; ([PointHistory]))?
    public func getPointHistories() async throws -&gt; [PointHistory] {
        getPointHistoriesCallCount += 1
        if let getPointHistoriesHandler {
            return try await getPointHistoriesHandler()
        }
        return [PointHistory]()
    }

    public private(set) var getResearchesCallCount = 0
    public var getResearchesHandler: ((MeasurementType?) async throws -&gt; ([Research]))?
    public func getResearches(measurementType: MeasurementType?) async throws -&gt; [Research] {
        getResearchesCallCount += 1
        if let getResearchesHandler {
            return try await getResearchesHandler(measurementType)
        }
        return [Research]()
    }

    public private(set) var getResearchCallCount = 0
    public var getResearchHandler: ((String) async throws -&gt; (Research))?
    public func getResearch(id: String) async throws -&gt; Research {
        getResearchCallCount += 1
        if let getResearchHandler {
            return try await getResearchHandler(id)
        }
        fatalError("getResearchHandler returns can't have a default value thus its handler must be set")
    }
}

---

## 🤖 アシスタント
*2023/06/13 20:45:31*

Swiftの`async/await`は、非同期処理を直感的にかつ順序立てて実行するための特性です。以下のように遅延処理を実装することができます。

Swift 5.5以降では`Task.sleep(nanoseconds:)`というメソッドが用意されています。これを使って、指定した時間（ナノ秒単位）だけ処理を停止することができます。1秒をナノ秒に変換すると1,000,000,000ナノ秒となります。

例えば、`getMissionList`関数で1秒の遅延を入れるには以下のようになります。

```swift
public func getMissionList(measurementType: MeasurementType?) async throws -> [Mission] {
    getMissionListCallCount += 1
    if let getMissionListHandler {
        await Task.sleep(1_000_000_000) // 1秒の遅延
        return try await getMissionListHandler(measurementType)
    }
    return [Mission]()
}
```

このようにして各関数に遅延処理を挿入することができます。このとき、遅延処理は非同期のため、`await`キーワードを使って非同期処理が完了するのを待つ必要があります。

---
