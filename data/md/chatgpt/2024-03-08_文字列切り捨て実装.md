# 文字列切り捨て実装

日付: 2024-03-08

---

## 👤 ユーザー
*2024/03/08 16:15:24*

///
/// @param name The name of the event. Should contain 1 to 40 alphanumeric characters or
///     underscores. The name must start with an alphabetic character. Some event names are
///     reserved. See FIREventNames.h for the list of reserved event names. The "firebase_",
///     "google_", and "ga_" prefixes are reserved and should not be used. Note that event names are
///     case-sensitive and that logging two events whose names differ only in case will result in
///     two distinct events. To manually log screen view events, use the `screen_view` event name.
/// @param parameters The dictionary of event parameters. Passing `nil` indicates that the event has
///     no parameters. Parameter names can be up to 40 characters long and must start with an
///     alphabetic character and contain only alphanumeric characters and underscores. Only String,
///     Int, and Double parameter types are supported. String parameter values can be up to 100
///     characters long for standard Google Analytics properties, and up to 500 characters long for
///     Google Analytics 360 properties. The "firebase_", "google_", and "ga_" prefixes are reserved
///     and should not be used for parameter names.
+ (void)logEventWithName:(NSString *)name
              parameters:(nullable NSDictionary&lt;NSString *, id&gt; *)parameters
    NS_SWIFT_NAME(logEvent(_:parameters:));



Parameters
name
The name of the event. Should contain 1 to 40 alphanumeric characters or underscores. The name must start with an alphabetic character. Some event names are reserved. See FIREventNames.h for the list of reserved event names. The “firebase_”, “google_”, and “ga_” prefixes are reserved and should not be used. Note that event names are case-sensitive and that logging two events whose names differ only in case will result in two distinct events. To manually log screen view events, use the screen_view event name.

parameters
The dictionary of event parameters. Passing nil indicates that the event has no parameters. Parameter names can be up to 40 characters long and must start with an alphabetic character and contain only alphanumeric characters and underscores. Only String, Int, and Double parameter types are supported. String parameter values can be up to 100 characters long for standard Google Analytics properties, and up to 500 characters long for Google Analytics 360 properties. The “firebase_”, “google_”, and “ga_” prefixes are reserved and should not be used for parameter names.



public class FirebaseLogDriver: FirebaseLogDriverProtocol {
    public init() {
        LogDriver.initLog()
    }

    deinit {
        LogDriver.deinitLog()
    }

    public func log(_ event: LogEventType, level: LogLevel, file: String, function: String, line: Int) {
        Analytics.logEvent(
            event.logEvent.instanceSnakeCasedStructName,
            parameters: event.logEvent.toAnalyticsPropertiesWithMetadata(level: level, file: file, function: function, line: line)
        )
    }
}

extension LoggableEntity {
    func toAnalyticsPropertiesWithMetadata(level: LogLevel, file: String, function: String, line: Int) -&gt; [String: Any] {
        let metadata: [String: Any] = [
            "log_level": level.name,
            "file": file,
            "function": function,
            "line": line,
        ]
        return toAnalyticsProperties.merging(metadata, uniquingKeysWith: { _, new in new })
    }

    /// AWS や Protocol Buffers を考慮の IF を考慮して String, Int, Double, Bool のみを許容してる
    private var toAnalyticsProperties: [String: Any] {
        toDictionary(caseFormat: .snakeCase).mapValues { value in
            switch value {
            case let intValue as Int:
                intValue
            case let stringValue as String:
                stringValue
            case let doubleValue as Double:
                doubleValue
            case let floatValue as Float:
                Double(floatValue)
            case let boolValue as Bool:
                boolValue
            case let dateValue as Date:
                ISO8601DateFormatter.sharedWithFractionalSeconds.string(from: dateValue)
            default:
                String(describing: value)
            }
        }
    }
}


10.22.1 - [FirebaseAnalytics][I-ACS013000] Event parameter value is too long. The maximum supported length is 100: AppInfo(appUpdateInfo: DomainLayer.AppUpdateInfo(minimumRequiredAppVersion: "1.2.3", appUpdateUrl: "https://example.com/update"), maintenanceInfo: DomainLayer.MaintenanceInfo(isMaintenance: true, maintenanceAlertTitle: "Maintenance Mode", maintenanceAlertMessage: "Our app is currently under maintenance. Please check back later."))

100文字以下にする処理を最後にいれたい。
どうすればいいか候補をあげてほしい。
日本語で回答してください。

---

## 🤖 アシスタント
*2024/03/08 16:16:37*

パラメータの値が100文字を超える場合、以下のような方法で対処できます。適用する方法は、データの性質や要件に応じて選択してください。

1. **文字列を切り捨てる**: 文字列の長さが100文字を超える場合、最初の100文字だけを使用し、残りは切り捨てます。この方法は最もシンプルで、実装が容易ですが、重要な情報が失われる可能性があります。

2. **要約を使用する**: 文字列が長い場合、要約または抽象化して短縮版を生成します。例えば、長い説明文からキーワードを抽出し、それらを組み合わせて短い文字列を生成することができます。この方法はより複雑ですが、重要な情報を保持する可能性が高くなります。

3. **ハッシュ関数を使用する**: 長い文字列をハッシュ値に変換して使用します。ハッシュ関数は任意の長さのデータを固定長の出力に変換します。この方法では元の情報は復元できませんが、データの一意性を保持するための識別子として利用で

---

## 👤 ユーザー
*2024/03/08 16:16:50*

1番の実装例をしてほしい

---

## 🤖 アシスタント
*2024/03/08 16:18:57*

1番の「文字列を切り捨てる」方法の実装例を示します。この例では、イベントパラメータの値が100文字を超える場合に、最初の100文字だけを保持し、残りを切り捨てるように`toAnalyticsProperties`メソッドを修正します。

```swift
extension LoggableEntity {
    func toAnalyticsPropertiesWithMetadata(level: LogLevel, file: String, function: String, line: Int) -> [String: Any] {
        let metadata: [String: Any] = [
            "log_level": level.name,
            "file": file,
            "function": function,
            "line": line,
        ]
        return toAnalyticsProperties.merging(metadata, uniquingKeysWith: { _, new in new })
    }

    private var toAnalyticsProperties: [String: Any] {
        toDictionary(caseFormat: .snakeCase).mapValues { value in
            switch value {
            case let intValue as Int:
                intValue
            case let stringValue as String:
                // 文字列の長さを確認し、100文字を超える場合は最初の100文字を保持
                stringValue.count > 100 ? String(stringValue.prefix(100)) : stringValue
            case let doubleValue as Double:
                doubleValue
            case let floatValue as Float:
                Double(floatValue)
            case let boolValue as Bool:
                boolValue
            case let dateValue as Date:
                ISO8601DateFormatter.sharedWithFractionalSeconds.string(from: dateValue)
            default:
                let stringDescription = String(describing: value)
                // 文字列変換後の長さを確認し、100文字を超える場合は最初の100文字を保持
                return stringDescription.count > 100 ? String(stringDescription.prefix(100)) : stringDescription
            }
        }
    }
}
```

このコードでは、`toAnalyticsProperties`メソッド内で、`String`型の値を扱う場合に文字列の長さをチェックし、100文字を超える場合は先頭から100文字だけを使用して残りを切り捨てています。`default`ケースでも同様の処理を行い、`String(describing:)`によって変換された文字列も同じルールを適用しています。これにより、Firebase Analyticsに送信されるイベントパラメータの文字列長が100文字以下に保たれます。

---

## 👤 ユーザー
*2024/03/08 16:19:43*

toAnalyticsProperties で処理するのではなくて、辞書型のValueがStringのときに100文字以下にするのはどう？

---

## 🤖 アシスタント
*2024/03/08 16:21:36*

辞書型の`Value`が`String`のときに100文字以下に制限する場合、イベントパラメータをログに送信する直前に文字列を切り捨てる処理を入れる方法が考えられます。このアプローチでは、辞書全体をループして`String`型の値をチェックし、必要に応じて修正します。ここでは、`logEvent`メソッド内でその処理を実装する例を示します。

```swift
public class FirebaseLogDriver: FirebaseLogDriverProtocol {
    public init() {
        LogDriver.initLog()
    }

    deinit {
        LogDriver.deinitLog()
    }

    public func log(_ event: LogEventType, level: LogLevel, file: String, function: String, line: Int) {
        var parameters = event.logEvent.toAnalyticsPropertiesWithMetadata(level: level, file: file, function: function, line: line)
        
        // 辞書内のString型のValueが100文字を超える場合は、100文字に切り捨てる
        parameters = parameters.mapValues { value in
            if let stringValue = value as? String, stringValue.count > 100 {
                return String(stringValue.prefix(100))
            }
            return value
        }
        
        Analytics.logEvent(
            event.logEvent.instanceSnakeCasedStructName,
            parameters: parameters
        )
    }
}
```

このコードでは、`log`メソッド内でイベントパラメータの辞書(`parameters`)を変更しています。辞書内の各要素に対して、値が`String`型である場合にその長さをチェックし、100文字を超える場合は先頭から100文字のみを取得しています。これにより、`Analytics.logEvent`メソッドに渡すパラメータの値を、Firebase Analyticsの要件に合わせて100文字以下に制限することができます。

---

## 👤 ユーザー
*2024/03/08 16:21:39*

この処理を辞書型のextensionにすることはできないの？  parameters = parameters.mapValues { value in
            if let stringValue = value as? String, stringValue.count &gt; 100 {
                return String(stringValue.prefix(100))
            }
            return value
        }

---

## 🤖 アシスタント
*2024/03/08 16:23:02*

はい、その処理を辞書型の`extension`にすることは可能です。これにより、辞書内の`String`型の値が100文字以上の場合に100文字に切り捨てる処理を、より汎用的に再利用できるようになります。以下のように`Dictionary`の`extension`を定義してみましょう。

```swift
extension Dictionary where Value == Any {
    func trimmingValuesToMaxLength(_ maxLength: Int) -> [Key: Value] {
        return self.mapValues { value in
            if let stringValue = value as? String, stringValue.count > maxLength {
                return String(stringValue.prefix(maxLength))
            }
            return value
        }
    }
}
```

この`extension`は`Value`が`Any`型の`Dictionary`に対して定義されており、`trimmingValuesToMaxLength`メソッドを通じて辞書内の全ての`String`型の値を指定された最大長に基づいて切り捨てることができます。使用方法は以下の通りです。

```swift
// Eventパラメータを取得し、100文字に制限をかける例
var parameters = event.logEvent.toAnalyticsPropertiesWithMetadata(level: level, file: file, function: function, line: line)

// 辞書内のString型の値を100文字に制限
parameters = parameters.trimmingValuesToMaxLength(100)

// 修正されたパラメータを使ってイベントをログ
Analytics.logEvent(
    event.logEvent.instanceSnakeCasedStructName,
    parameters: parameters
)
```

この方法を用いることで、任意の辞書に対して一貫した文字数制限の処理を適用することが可能になり、コードの再利用性と可読性が向上します。

---
