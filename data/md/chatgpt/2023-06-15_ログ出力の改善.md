# ログ出力の改善

Date: 2023-06-15

---

## 👤 User
*2023-06-16 01:55:52*

configurationエラーのように他のものもエラー内容を出力するようにして

public func signIn(emailAddress: LoginForm.EmailAddress, password: LoginForm.Password) async throws {
        do {
            let authSignInResult = try await Amplify.Auth.signIn(username: emailAddress.value, password: password.value)
            AppLogger.debugLog("Sign in succeeded with result: \(authSignInResult)", category: .network)
        } catch let error as AuthError {
            switch error {
            case .configuration(let errorDescription, let recoverySuggestion, let error):
                AppLogger.debugLog("Sign in failed configuration: \(errorDescription), \(recoverySuggestion), \(String(describing: error))", category: .network, level: .error)
            case .service(_, _, _):
                AppLogger.debugLog("Sign in failed \(error)", category: .network, level: .error)
            case .unknown(_, _):
                AppLogger.debugLog("Sign in failed \(error)", category: .network, level: .error)
            case .validation(_, _, _, _):
                AppLogger.debugLog("Sign in failed \(error)", category: .network, level: .error)
            case .notAuthorized(_, _, _):
                AppLogger.debugLog("Sign in failed \(error)", category: .network, level: .error)
            case .invalidState(_, _, _):
                AppLogger.debugLog("Sign in failed \(error)", category: .network, level: .error)
            case .signedOut(_, _, _):
                AppLogger.debugLog("Sign in failed \(error)", category: .network, level: .error)
            case .sessionExpired(_, _, _):
                AppLogger.debugLog("Sign in failed \(error)", category: .network, level: .error)
            }
            throw error
        } catch {
            AppLogger.debugLog("Unexpected error: \(error)", category: .network, level: .error)
            throw error
        }
    }

---

## 🤖 Assistant
*2023-06-16 01:56:56*

既存のコードでログ出力部分を変更すると、具体的なエラーメッセージをログに含めることができます。それぞれのエラーケースでの説明、回復の提案、エラーの原因を出力するように変更します。以下のようにコードを修正してみてください。

```swift
public func signIn(emailAddress: LoginForm.EmailAddress, password: LoginForm.Password) async throws {
    do {
        let authSignInResult = try await Amplify.Auth.signIn(username: emailAddress.value, password: password.value)
        AppLogger.debugLog("Sign in succeeded with result: \(authSignInResult)", category: .network)
    } catch let error as AuthError {
        switch error {
        case .configuration(let errorDescription, let recoverySuggestion, let error):
            AppLogger.debugLog("Sign in failed configuration: \(errorDescription), \(recoverySuggestion), \(String(describing: error))", category: .network, level: .error)
        case .service(let errorDescription, let recoverySuggestion, let error):
            AppLogger.debugLog("Sign in failed service: \(errorDescription), \(recoverySuggestion), \(String(describing: error))", category: .network, level: .error)
        case .unknown(let errorDescription, let recoverySuggestion, let error):
            AppLogger.debugLog("Sign in failed unknown: \(errorDescription), \(recoverySuggestion), \(String(describing: error))", category: .network, level: .error)
        case .validation(let errorDescription, let recoverySuggestion, let error):
            AppLogger.debugLog("Sign in failed validation: \(errorDescription), \(recoverySuggestion), \(String(describing: error))", category: .network, level: .error)
        case .notAuthorized(let errorDescription, let recoverySuggestion, let error):
            AppLogger.debugLog("Sign in failed notAuthorized: \(errorDescription), \(recoverySuggestion), \(String(describing: error))", category: .network, level: .error)
        case .invalidState(let errorDescription, let recoverySuggestion, let error):
            AppLogger.debugLog("Sign in failed invalidState: \(errorDescription), \(recoverySuggestion), \(String(describing: error))", category: .network, level: .error)
        case .signedOut(let errorDescription, let recoverySuggestion, let error):
            AppLogger.debugLog("Sign in failed signedOut: \(errorDescription), \(recoverySuggestion), \(String(describing: error))", category: .network, level: .error)
        case .sessionExpired(let errorDescription, let recoverySuggestion, let error):
            AppLogger.debugLog("Sign in failed sessionExpired: \(errorDescription), \(recoverySuggestion), \(String(describing: error))", category: .network, level: .error)
        }
        throw error
    } catch {
        AppLogger.debugLog("Unexpected error: \(error)", category: .network, level: .error)
        throw error
    }
}
```

ただし、上記のコードはAuthErrorの各ケースがerrorDescription, recoverySuggestion, errorという3つのパラメータを持つと仮定しています。実際のAuthErrorの定義によっては、これらのパラメータが存在しないかもしれません。その場合は適宜コードを修正してください。

---

## 👤 User
*2023-06-16 01:58:12*

ごめん以下の定義にあわせてしゅうせいしてほしい

public enum AuthError {

    /// Caused by issue in the way auth category is configured
    case configuration(ErrorDescription, RecoverySuggestion, Error? = nil)

    /// Caused by some error in the underlying service. Check the associated error for more details.
    case service(ErrorDescription, RecoverySuggestion, Error? = nil)

    /// Caused by an unknown reason
    case unknown(ErrorDescription, Error? = nil)

    /// Caused when one of the input field is invalid
    case validation(Field, ErrorDescription, RecoverySuggestion, Error? = nil)

    /// Caused when the current session is not authorized to perform an operation
    case notAuthorized(ErrorDescription, RecoverySuggestion, Error? = nil)

    /// Caused when an operation is not valid with the current state of Auth category
    case invalidState(ErrorDescription, RecoverySuggestion, Error? = nil)

    /// Caused when an operation needs the user to be in signedIn state
    case signedOut(ErrorDescription, RecoverySuggestion, Error? = nil)

    /// Caused when a session is expired and needs the user to be re-authenticated
    case sessionExpired(ErrorDescription, RecoverySuggestion, Error? = nil)
}

---

## 🤖 Assistant
*2023-06-16 01:59:17*

AuthErrorの各ケースの定義に従って、エラーの詳細をログに出力するコードを修正します。以下のコードをご覧ください。

```swift
public func signIn(emailAddress: LoginForm.EmailAddress, password: LoginForm.Password) async throws {
    do {
        let authSignInResult = try await Amplify.Auth.signIn(username: emailAddress.value, password: password.value)
        AppLogger.debugLog("Sign in succeeded with result: \(authSignInResult)", category: .network)
    } catch let error as AuthError {
        switch error {
        case .configuration(let errorDescription, let recoverySuggestion, let error):
            AppLogger.debugLog("Sign in failed configuration: \(errorDescription), \(recoverySuggestion), \(String(describing: error))", category: .network, level: .error)
        case .service(let errorDescription, let recoverySuggestion, let error):
            AppLogger.debugLog("Sign in failed service: \(errorDescription), \(recoverySuggestion), \(String(describing: error))", category: .network, level: .error)
        case .unknown(let errorDescription, let error):
            AppLogger.debugLog("Sign in failed unknown: \(errorDescription), \(String(describing: error))", category: .network, level: .error)
        case .validation(let field, let errorDescription, let recoverySuggestion, let error):
            AppLogger.debugLog("Sign in failed validation on \(field): \(errorDescription), \(recoverySuggestion), \(String(describing: error))", category: .network, level: .error)
        case .notAuthorized(let errorDescription, let recoverySuggestion, let error):
            AppLogger.debugLog("Sign in failed notAuthorized: \(errorDescription), \(recoverySuggestion), \(String(describing: error))", category: .network, level: .error)
        case .invalidState(let errorDescription, let recoverySuggestion, let error):
            AppLogger.debugLog("Sign in failed invalidState: \(errorDescription), \(recoverySuggestion), \(String(describing: error))", category: .network, level: .error)
        case .signedOut(let errorDescription, let recoverySuggestion, let error):
            AppLogger.debugLog("Sign in failed signedOut: \(errorDescription), \(recoverySuggestion), \(String(describing: error))", category: .network, level: .error)
        case .sessionExpired(let errorDescription, let recoverySuggestion, let error):
            AppLogger.debugLog("Sign in failed sessionExpired: \(errorDescription), \(recoverySuggestion), \(String(describing: error))", category: .network, level: .error)
        }
        throw error
    } catch {
        AppLogger.debugLog("Unexpected error: \(error)", category: .network, level: .error)
        throw error
    }
}
```
これにより、エラーが発生した場合にエラーの種類、説明、回復提案、およびエラーの詳細がログに出力されます。ただし、上記のコードは`validation`の場合で`field`が`CustomStringConvertible`プロトコルを準拠していることを前提としています。もし準拠していない場合は、適切にエラー情報を出力するためにコードを修正する必要があります。

---

## 👤 User
*2023-06-16 02:04:45*

パスワードとメールアドレスの組み合わせが間違っている場合のエラー定義を追加して。命名を迷っている

public enum AppAuthError: Error {
    case unexpectedError
}

---

## 🤖 Assistant
*2023-06-16 02:05:07*

エラーの種類を表現するために、エラー定義に新たなケースを追加することができます。具体的なエラー内容を表すための名前については、`invalidCredentials`や`wrongCredentials`といったものが考えられます。これらの名前は、ユーザーが提供したメールアドレスとパスワードの組み合わせが無効であることを明確に表現しています。以下のように定義すると良いでしょう：

```swift
public enum AppAuthError: Error {
    case unexpectedError
    case invalidCredentials
}
```

この新たなエラー定義をsignInメソッドで利用する場合、メソッド内で適切な条件をチェックし、無効なクレデンシャルが提供された場合にこのエラーをスローするようにコードを修正する必要があります。

---
