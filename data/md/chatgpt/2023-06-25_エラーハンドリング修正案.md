# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä¿®æ­£æ¡ˆ

Date: 2023-06-25

---

## ğŸ‘¤ User
*2023-06-25 15:59:03*

ã‚¨ãƒ©ãƒ¼è¨­è¨ˆã‚’ã—ãŸ


extension Publisher where Output: OptionalProtocol {
    func mapIsNotNil() -&gt; AnyPublisher&lt;Bool, Failure&gt; {
        map { $0.optional != nil }
            .eraseToAnyPublisher()
    }
}

protocol OptionalProtocol {
    associatedtype Wrapped
    var optional: Wrapped? { get }
}

extension Optional: OptionalProtocol {
    var optional: Wrapped? { self }
}

public enum ApiRequestError: Error {
    case hoge
}
public enum AppAuthError: Error {
    case moge
}

// TODO: ãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚º
public enum AppError: LocalizedError {
    case apiRequestError(ApiRequestError)
    case authError(AppAuthError)
    case customMessageError(message: String) // å›°ã£ãŸã¨ãã«ä½¿ã†ã‚¨ãƒ©ãƒ¼
    case generalError
    case unexpectedError

    // å®Ÿè³ªçš„ã« alert ã®ã‚¿ã‚¤ãƒˆãƒ«ã«ãªã‚‹ï¼ˆLocalizedError ã® errorDescription ã® override ã§ã‚ã‚‹ï¼‰
    public var errorDescription: String? {
        switch self {
        case .apiRequestError:
            return "é€šä¿¡ã‚¨ãƒ©ãƒ¼"
        case .authError:
            return "èªè¨¼ã‚¨ãƒ©ãƒ¼"
        case .unexpectedError:
            return "ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼"
        default:
            return "ã‚¨ãƒ©ãƒ¼"
        }
    }

    public var alertMessageText: String {
        switch self {
        case .unexpectedError:
            return "äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
        default:
            return "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
        }
    }

    public var alertCancelButtonText: String {
        switch self {
        default:
            return "é–‰ã˜ã‚‹"
        }
    }
    public var alertCancelButton: some View {
        Button(alertCancelButtonText, role: .cancel) {}
    }

    public var alertMessage: some View {
        Text(alertMessageText)
    }
}


class Presenter: ObservableObject {
    @Published var appError: AppError?
    @Published var shouldShowAlert: Bool = false
    
    init() {
        //
        $appError
            .mapIsNotNil()
            .assign(to: &$shouldShowAlert)
    }
}

struct ContentView: View {
    @StateObject var presenter = Presenter()
    
    var body: some View {
        Button("ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ") {
            presenter.appError = AppError.unexpectedError
        }
        .alert(isPresented: $presenter.shouldShowAlert, error: presenter.appError) { error in
            error.alertCancelButton
        } message: { error in
            error.alertMessage
        }
    }
}

---

## ğŸ¤– Assistant
*2023-06-25 15:59:54*

ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹ã¨ã€SwiftUIã¨Combineã‚’ä½¿ç”¨ã—ã¦ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®è¨­è¨ˆã‚’ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã­ã€‚ã—ã‹ã—ãªãŒã‚‰ã€ã„ãã¤ã‹å•é¡Œç‚¹ãŒã‚ã‚Šã¾ã™ã€‚

1. SwiftUIã® `alert(isPresented:content:)`ãƒ¡ã‚½ãƒƒãƒ‰ã¯errorå‹ã®å¼•æ•°ã‚’å–ã‚Šã¾ã›ã‚“ã€‚ã‚ãªãŸãŒä½¿ãŠã†ã¨ã—ã¦ã„ã‚‹ã‚¨ãƒ©ãƒ¼å‹ã®å¼•æ•°ã‚’æŒã¤alertã¯SwiftUIã®ãƒ“ãƒ«ãƒˆã‚¤ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

2. `assign(to:)`ãƒ¡ã‚½ãƒƒãƒ‰ã¯Publisherã®å‡ºåŠ›å€¤ã‚’Publishedãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ç›´æ¥å‰²ã‚Šå½“ã¦ã‚‹ãŸã‚ã«ä½¿ã‚ã‚Œã¾ã™ãŒã€`$shouldShowAlert`ãŒBoolå‹ã§ã‚ã‚‹ãŸã‚ã€mapIsNotNil()ãŒBoolå‹ã®å€¤ã‚’å‡ºåŠ›ã™ã‚‹Publisherã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

ã“ã®å•é¡Œã‚’ä¿®æ­£ã™ã‚‹ãŸã‚ã«ã¯ã€è‡ªåˆ†ã§alertã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã‹ã€ã‚‚ã—ãã¯æ—¢å­˜ã®alertã‚’ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã«é©å¿œã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã«ä¿®æ­£æ¡ˆã‚’ç¤ºã—ã¾ã™ã€‚

```swift
class Presenter: ObservableObject {
    @Published var appError: AppError?
    var shouldShowAlert: AnyPublisher<Bool, Never> {
        $appError
            .map { $0 != nil }
            .eraseToAnyPublisher()
    }
}

struct ContentView: View {
    @StateObject var presenter = Presenter()
    @Environment(\.dismiss) var dismiss
    
    var body: some View {
        Button("ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ") {
            presenter.appError = AppError.unexpectedError
        }
        .alert(isPresented: presenter.shouldShowAlert
            .receive(on: DispatchQueue.main)
            .sink { _ in },
               content: {
                    Alert(title: Text(presenter.appError?.errorDescription ?? ""),
                          message: Text(presenter.appError?.alertMessageText ?? ""),
                          dismissButton: .default(Text(presenter.appError?.alertCancelButtonText ?? ""), action: {
                              presenter.appError = nil
                          }))
                })
    }
}
```

ä»¥ä¸Šã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€æ¬¡ã®å¤‰æ›´ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚

1. `shouldShowAlert`ã¯ `AnyPublisher<Bool, Never>`å‹ã¨ãªã‚Šã€`$appError`ãŒnilã§ãªã„ã‹ã©ã†ã‹ã‚’å‡ºåŠ›ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ã“ã®çµæœã€ã‚¨ãƒ©ãƒ¼ãŒå­˜åœ¨ã™ã‚Œã° `shouldShowAlert`ã¯ `true`ã¨ãªã‚Šã€ã‚¨ãƒ©ãƒ¼ãŒè§£æ¶ˆï¼ˆnilã«ãªã£ãŸï¼‰ã•ã‚Œã‚Œã° `false`ã¨ãªã‚Šã¾ã™ã€‚

2. SwiftUIã®ãƒ“ãƒ«ãƒˆã‚¤ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰ `alert(isPresented:content:)`ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ `isPresented`ã«ã¯ `shouldShowAlert`ã‚’æŒ‡å®šã—ã€contentã«ã¯Alertã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚Alertã®ã‚¿ã‚¤ãƒˆãƒ«ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã¯ã™ã¹ã¦ `appError`ã‹ã‚‰å–å¾—ã—ã¦ã„ã¾ã™ã€‚

3. Alertã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€`appError`ã‚’nilã«è¨­å®šã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’è§£æ¶ˆã—ã€ãã®çµæœ `shouldShowAlert`ã‚‚ `false`ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Alertã¯è¡¨ç¤ºã•ã‚Œãªããªã‚Šã¾ã™ã€‚

ã“ã‚Œã‚‰ã®

---

## ğŸ‘¤ User
*2023-06-25 16:00:19*

ä¸Šè¨˜ã®å•é¡Œã¯ã‚¯ãƒªã‚¢ã«ãªã£ã¦ã„ã‚‹

ä»¥ä¸‹ã‚’ã©ã®å ´æ‰€ã§ã‚‚ç¹°ã‚Šè¿”ã—ä½¿ã„ãŸã„ã®ã§ã€å…±é€šåŒ–ã™ã‚‹ã‚ˆã†ãªã‚‚ã®ã‚’æä¾›ã—ã¦æ¬²ã—ã„

.alert(isPresented: $presenter.shouldShowAlert, error: presenter.appError) { error in
            error.alertCancelButton
        } message: { error in
            error.alertMessage
        }

---

## ğŸ¤– Assistant
*2023-06-25 16:00:55*

ãã®æ©Ÿèƒ½ã‚’å…±é€šåŒ–ã™ã‚‹ã«ã¯ã€è‡ªåˆ†ã§å®šç¾©ã—ãŸãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ‡ã‚£ãƒ•ã‚¡ã‚¤ã‚¢ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§è§£æ±ºã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¨ãƒ©ãƒ¼ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ã©ã®ãƒ“ãƒ¥ãƒ¼ã§ã‚‚ç°¡å˜ã«ä½¿ç”¨ã§ãã¾ã™ã€‚ä»¥ä¸‹ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ‡ã‚£ãƒ•ã‚¡ã‚¤ã‚¢ã®ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚

ã¾ãšã¯ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ‡ã‚£ãƒ•ã‚¡ã‚¤ã‚¢ã‚’å®šç¾©ã—ã¾ã—ã‚‡ã†ï¼š

```swift
struct ErrorAlertModifier: ViewModifier {
    @Binding var isPresented: Bool
    var error: AppError?
    
    func body(content: Content) -> some View {
        content
            .alert(isPresented: $isPresented) {
                Alert(
                    title: Text(error?.errorDescription ?? ""),
                    message: Text(error?.alertMessageText ?? ""),
                    dismissButton: .default(Text(error?.alertCancelButtonText ?? ""), action: {
                        self.isPresented = false
                    })
                )
            }
    }
}
```

ãã—ã¦ã€ãã®ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ‡ã‚£ãƒ•ã‚¡ã‚¤ã‚¢ã‚’ä½¿ã†ãŸã‚ã®æ‹¡å¼µã‚’ä½œæˆã—ã¾ã™ï¼š

```swift
extension View {
    func errorAlert(isPresented: Binding<Bool>, error: AppError?) -> some View {
        self.modifier(ErrorAlertModifier(isPresented: isPresented, error: error))
    }
}
```

ã“ã‚Œã§æº–å‚™ãŒå®Œäº†ã§ã™ã€‚ã“ã‚Œã‚’ä½¿ç”¨ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼š

```swift
struct ContentView: View {
    @StateObject var presenter = Presenter()
    
    var body: some View {
        Button("ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ") {
            presenter.appError = AppError.unexpectedError
        }
        .errorAlert(isPresented: $presenter.shouldShowAlert, error: presenter.appError)
    }
}
```

`errorAlert`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ã€ã‚¨ãƒ©ãƒ¼ã‚¢ãƒ©ãƒ¼ãƒˆã®è¡¨ç¤ºã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚ã“ã‚Œã¯`isPresented`ã¨`error`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

ã“ã“ã§ã¯`ContentView`ã§`Presenter`ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã€"ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ"ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨`appError`ã«ã‚¨ãƒ©ãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚ãã—ã¦`errorAlert`ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ‡ã‚£ãƒ•ã‚¡ã‚¤ã‚¢ã‚’ä½¿ç”¨ã—ã¦ã‚¨ãƒ©ãƒ¼ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å…±é€šåŒ–ã—ã€ç¹°ã‚Šè¿”ã—ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

---
