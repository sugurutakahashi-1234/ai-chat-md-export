# éåŒæœŸã‚¿ã‚¹ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½¿ç”¨

æ—¥ä»˜: 2023-06-19

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2023/06/19 15:34:06*

ä»¥ä¸‹ã®foræ–‡ã‚’ç¶ºéº—ã«ç›´ã—ãŸã„


@MainActor
final class ApiRequestListPresenter: ObservableObject {
    private let apiRequestManager: ApiRequestManagerProtocol

    @Published var isShownAlert = false
    @Published var user: EmomilCore.User?
    @Published var userAttributeContents: EmomilCore.UserAttributeContents?
    @Published var userAttributes: EmomilCore.UserAttributes?
    @Published var pointHistories: [EmomilCore.PointHistory] = []
    @Published var researches: [EmomilCore.Research] = []
    @Published var researchDetails: [EmomilCore.Research] = []
    @Published var measurements: [EmomilCore.Measurement] = []

    init(apiRequestManager: ApiRequestManagerProtocol = AmplifyApiRequestManager()) {
        self.apiRequestManager = apiRequestManager
    }

    func onAppear() async {
        do {
            user = try await apiRequestManager.getUser()
            userAttributeContents = try await apiRequestManager.getUserAttributeContents()
            userAttributes = try await apiRequestManager.getUserAttribute()
            pointHistories = try await apiRequestManager.getPointHistories()
            researches = try await apiRequestManager.getResearches(measurementType: nil)

            for research in researches {
                let detailedResearch = try await apiRequestManager.getResearch(id: research.id)
                researchDetails.append(detailedResearch)

                for measurement in detailedResearch.measurements {
                    let measurement = try await apiRequestManager.getMeasurement(id: measurement.id, measurementType: measurement.type)
                    measurements.append(measurement)
                }
            }
        } catch {
            AppLogger.debugLog("error: \(error)", category: .network)
            isShownAlert = true
        }
    }
}

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2023/06/19 15:35:01*

ã‚³ãƒ¼ãƒ‰ã‚’æ•´ç†ã™ã‚‹ä¸€ã¤ã®æ‰‹æ®µã¨ã—ã¦ã¯éåŒæœŸã‚¿ã‚¹ã‚¯ã®åˆ©ç”¨ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚éåŒæœŸã‚¿ã‚¹ã‚¯ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€åŒã˜ãƒ«ãƒ¼ãƒ—å†…ã§ã®é€£ç¶šã—ãŸAPIå‘¼ã³å‡ºã—ã‚’å›é¿ã—ã€å…¨ä½“ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ã“ã®å ´åˆã€ã‚ã‚‹ç ”ç©¶ã®è©³ç´°ã¨ã€ãã®ç ”ç©¶ã«é–¢é€£ã™ã‚‹æ¸¬å®šã‚’åŒæ™‚ã«å–å¾—ã™ã‚‹ãŸã‚ã«éåŒæœŸã‚¿ã‚¹ã‚¯ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯ã€éåŒæœŸã‚¿ã‚¹ã‚¯ã‚’ä½¿ç”¨ã—ã¦ãƒ«ãƒ¼ãƒ—å†…ã§APIã‚’å‘¼ã³å‡ºã™ä¾‹ã§ã™ã€‚

```swift
func onAppear() async {
    do {
        user = try await apiRequestManager.getUser()
        userAttributeContents = try await apiRequestManager.getUserAttributeContents()
        userAttributes = try await apiRequestManager.getUserAttribute()
        pointHistories = try await apiRequestManager.getPointHistories()
        researches = try await apiRequestManager.getResearches(measurementType: nil)

        var tempResearchDetails: [EmomilCore.Research] = []
        var tempMeasurements: [EmomilCore.Measurement] = []
        
        await withTaskGroup(of: Void.self) { group in
            for research in researches {
                group.addTask {
                    let detailedResearch = try await apiRequestManager.getResearch(id: research.id)
                    tempResearchDetails.append(detailedResearch)

                    for measurement in detailedResearch.measurements {
                        let newMeasurement = try await apiRequestManager.getMeasurement(id: measurement.id, measurementType: measurement.type)
                        tempMeasurements.append(newMeasurement)
                    }
                }
            }
        }
        researchDetails = tempResearchDetails
        measurements = tempMeasurements

    } catch {
        AppLogger.debugLog("error: \(error)", category: .network)
        isShownAlert = true
    }
}
```

ã“ã“ã§ã¯ã€`withTaskGroup`ã‚’ä½¿ç”¨ã—ã¦éåŒæœŸã‚¿ã‚¹ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚ãã‚Œãã‚Œã®ç ”ç©¶ã«å¯¾ã—ã¦ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã€ãã®ç ”ç©¶ã®è©³ç´°ã¨ãã‚Œã«é–¢é€£ã™ã‚‹æ¸¬å®šã‚’åŒæ™‚ã«å–å¾—ã—ã¾ã™ã€‚çµæœã¯ä¸€æ™‚çš„ãªé…åˆ—ã«ä¿å­˜ã•ã‚Œã€ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ãŸå¾Œã«å…¬é–‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«è¨­å®šã•ã‚Œã¾ã™ã€‚éåŒæœŸã‚¿ã‚¹ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—ã¯ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã™ã‚‹ã¾ã§ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã™ã®ã§ã€ã“ã‚Œã«ã‚ˆã‚Šå„APIå‘¼ã³å‡ºã—ãŒå®Œå…¨ã«çµ‚äº†ã™ã‚‹ã“ã¨ã‚’ä¿è¨¼ã§ãã¾ã™ã€‚

---
