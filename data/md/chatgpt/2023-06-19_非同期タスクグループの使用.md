# 非同期タスクグループの使用

日付: 2023-06-19

---

## 👤 ユーザー
*2023/06/19 15:34:06*

以下のfor文を綺麗に直したい


@MainActor
final class ApiRequestListPresenter: ObservableObject {
    private let apiRequestManager: ApiRequestManagerProtocol

    @Published var isShownAlert = false
    @Published var user: EmomilCore.User?
    @Published var userAttributeContents: EmomilCore.UserAttributeContents?
    @Published var userAttributes: EmomilCore.UserAttributes?
    @Published var pointHistories: [EmomilCore.PointHistory] = []
    @Published var researches: [EmomilCore.Research] = []
    @Published var researchDetails: [EmomilCore.Research] = []
    @Published var measurements: [EmomilCore.Measurement] = []

    init(apiRequestManager: ApiRequestManagerProtocol = AmplifyApiRequestManager()) {
        self.apiRequestManager = apiRequestManager
    }

    func onAppear() async {
        do {
            user = try await apiRequestManager.getUser()
            userAttributeContents = try await apiRequestManager.getUserAttributeContents()
            userAttributes = try await apiRequestManager.getUserAttribute()
            pointHistories = try await apiRequestManager.getPointHistories()
            researches = try await apiRequestManager.getResearches(measurementType: nil)

            for research in researches {
                let detailedResearch = try await apiRequestManager.getResearch(id: research.id)
                researchDetails.append(detailedResearch)

                for measurement in detailedResearch.measurements {
                    let measurement = try await apiRequestManager.getMeasurement(id: measurement.id, measurementType: measurement.type)
                    measurements.append(measurement)
                }
            }
        } catch {
            AppLogger.debugLog("error: \(error)", category: .network)
            isShownAlert = true
        }
    }
}

---

## 🤖 アシスタント
*2023/06/19 15:35:01*

コードを整理する一つの手段としては非同期タスクの利用が挙げられます。非同期タスクを用いることで、同じループ内での連続したAPI呼び出しを回避し、全体のパフォーマンスを向上させることが可能です。この場合、ある研究の詳細と、その研究に関連する測定を同時に取得するために非同期タスクを使用します。

以下のコードは、非同期タスクを使用してループ内でAPIを呼び出す例です。

```swift
func onAppear() async {
    do {
        user = try await apiRequestManager.getUser()
        userAttributeContents = try await apiRequestManager.getUserAttributeContents()
        userAttributes = try await apiRequestManager.getUserAttribute()
        pointHistories = try await apiRequestManager.getPointHistories()
        researches = try await apiRequestManager.getResearches(measurementType: nil)

        var tempResearchDetails: [EmomilCore.Research] = []
        var tempMeasurements: [EmomilCore.Measurement] = []
        
        await withTaskGroup(of: Void.self) { group in
            for research in researches {
                group.addTask {
                    let detailedResearch = try await apiRequestManager.getResearch(id: research.id)
                    tempResearchDetails.append(detailedResearch)

                    for measurement in detailedResearch.measurements {
                        let newMeasurement = try await apiRequestManager.getMeasurement(id: measurement.id, measurementType: measurement.type)
                        tempMeasurements.append(newMeasurement)
                    }
                }
            }
        }
        researchDetails = tempResearchDetails
        measurements = tempMeasurements

    } catch {
        AppLogger.debugLog("error: \(error)", category: .network)
        isShownAlert = true
    }
}
```

ここでは、`withTaskGroup`を使用して非同期タスクグループを作成しています。それぞれの研究に対してタスクを追加し、その研究の詳細とそれに関連する測定を同時に取得します。結果は一時的な配列に保存され、すべてのタスクが完了した後に公開プロパティに設定されます。非同期タスクグループはすべてのタスクが完了するまでブロックしますので、これにより各API呼び出しが完全に終了することを保証できます。

---
