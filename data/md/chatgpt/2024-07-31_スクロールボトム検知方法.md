# スクロールボトム検知方法

Date: 2024-07-31

---

## 👤 User
*2024-07-31 18:07:07*

スクロールの bottom までスクロールしたことだけを検知したい。
bottomに到達した場合に何度も処理を実行したい

---

## 🤖 Assistant
*2024-07-31 18:07:31*

SwiftUIでスクロールのボトムに到達したことを検知するには、`GeometryReader`と`ScrollView`を組み合わせて使うことができます。以下はその実装例です：

```swift
import SwiftUI

struct ContentView: View {
    @State private var items = Array(1...100)
    @State private var bottomReachedCount = 0
    
    var body: some View {
        ScrollView {
            LazyVStack {
                ForEach(items, id: \.self) { item in
                    Text("Item \(item)")
                        .padding()
                        .background(Color.gray.opacity(0.3))
                        .cornerRadius(8)
                        .padding(.horizontal)
                }
                GeometryReader { geometry in
                    Color.clear
                        .onAppear {
                            if geometry.frame(in: .global).maxY < UIScreen.main.bounds.height {
                                self.loadMore()
                            }
                        }
                }
                .frame(height: 1)
            }
        }
        .padding()
        .overlay(
            VStack {
                Spacer()
                Text("Bottom reached \(bottomReachedCount) times")
                    .padding()
                    .background(Color.black.opacity(0.7))
                    .foregroundColor(.white)
                    .cornerRadius(8)
                    .padding()
            }
        )
    }
    
    private func loadMore() {
        bottomReachedCount += 1
        items.append(contentsOf: Array(items.count + 1...items.count + 20))
    }
}

struct ContentView_Previews: PreviewProvider {
    static var previews: some View {
        ContentView()
    }
}
```

### 解説

1. **`ScrollView`と`LazyVStack`**: `ScrollView`の中に`LazyVStack`を配置して、アイテムを縦に並べます。
2. **`GeometryReader`**: `LazyVStack`の最後に`GeometryReader`を配置し、これが表示されたときにボトムに到達したことを検知します。
3. **`onAppear`**: `GeometryReader`の`onAppear`モディファイアで、表示されるときに特定の処理（ここでは`loadMore`メソッド）を呼び出します。
4. **`loadMore`メソッド**: このメソッドでは、ボトムに到達した回数をカウントし、新しいアイテムをリストに追加します。

この実装により、スクロールのボトムに到達するたびに`loadMore`メソッドが呼び出されます。`bottomReachedCount`を使用して、何度ボトムに到達したかを表示しています。

---

## 👤 User
*2024-07-31 18:08:15*

英語で「bottomまで到達する」

---

## 🤖 Assistant
*2024-07-31 18:08:19*

英語で「bottomまで到達する」は「reaching the bottom」または「reaching the end of the scroll view」と表現できます。

例文:
- "The action will be triggered upon reaching the bottom of the scroll view."
- "When you reach the bottom, more items will be loaded."

---

## 👤 User
*2024-07-31 18:16:54*

if geometry.frame(in: .global).maxY &lt; UIScreen.main.bounds.height { の処理ってUIScreen.main.bounds.heightを使わずにできないの？

---

## 🤖 Assistant
*2024-07-31 18:17:21*

`UIScreen.main.bounds.height`を使わずにスクロールのボトムに到達したかを検知するには、`ScrollView`の座標系とビューの相対的な位置を利用する方法があります。`View`の`frame(in:)`メソッドを`ScrollView`の座標系で利用することで、`UIScreen.main.bounds.height`を使わずに検知できます。

以下はその例です：

```swift
import SwiftUI

struct ContentView: View {
    @State private var items = Array(1...100)
    @State private var bottomReachedCount = 0

    var body: some View {
        ScrollView {
            LazyVStack {
                ForEach(items, id: \.self) { item in
                    Text("Item \(item)")
                        .padding()
                        .background(Color.gray.opacity(0.3))
                        .cornerRadius(8)
                        .padding(.horizontal)
                }
                GeometryReader { geometry in
                    Color.clear
                        .onAppear {
                            let frame = geometry.frame(in: CoordinateSpace.named("scrollView"))
                            if frame.maxY < geometry.size.height {
                                self.loadMore()
                            }
                        }
                }
                .frame(height: 1)
            }
        }
        .coordinateSpace(name: "scrollView")
        .padding()
        .overlay(
            VStack {
                Spacer()
                Text("Bottom reached \(bottomReachedCount) times")
                    .padding()
                    .background(Color.black.opacity(0.7))
                    .foregroundColor(.white)
                    .cornerRadius(8)
                    .padding()
            }
        )
    }

    private func loadMore() {
        bottomReachedCount += 1
        items.append(contentsOf: Array(items.count + 1...items.count + 20))
    }
}

struct ContentView_Previews: PreviewProvider {
    static var previews: some View {
        ContentView()
    }
}
```

### 解説

1. **`coordinateSpace(name:)`**: `ScrollView`に名前付きの座標空間を設定します。ここでは「scrollView」という名前を使用しています。
2. **`geometry.frame(in:)`**: `GeometryReader`の`frame(in:)`メソッドで`ScrollView`の座標空間を指定します。
3. **`frame.maxY < geometry.size.height`**: `GeometryReader`の位置を`ScrollView`の座標空間で比較することで、`UIScreen.main.bounds.height`を使用せずにスクロールのボトムに到達したかどうかを検知します。

この方法により、スクロールのボトムに到達したときに適切な処理を行うことができます。

---
