# 無限スクロール実装方法

Date: 2024-08-16

---

## 👤 User
*2024-08-16 12:07:13*

以下を無限にループしてスクロールできるようにする方法はありますか？

@available(iOS 17.0, *)
public struct TransitionScrollDesignView: View {
    let items: [ScrollDesignViewItem]
    let spacing: CGFloat
    let padding: CGFloat

    public var body: some View {
        GeometryReader { geometry in
            ScrollView(.horizontal) {
                LazyHStack(spacing: spacing) {
                    ForEach(items, id: \.id) { item in
                        RoundedRectangle(cornerRadius: 15)
                            .fill(item.color.gradient)
                            .frame(width: max(geometry.size.width - padding * 2, 0), height: 100)
                            .scrollTransition(.interactive, axis: .horizontal) { view, phase in
                                view
                                    .scaleEffect(phase.isIdentity ? 1 : 0.95)
                                    .offset(y: phase.isIdentity ? -15 : 0)
                            }
                            .offset(y: 15)
                    }
                }
                .padding(.horizontal, padding)
                .scrollTargetLayout()
            }
            .scrollTargetBehavior(.viewAligned) // paging だと上手くいかない
            .scrollIndicators(.hidden)
        }
        .frame(height: 150)
    }
}

---

## 🤖 Assistant
*2024-08-16 12:07:37*

このような水平スクロールビューを無限にループさせるためには、表示されている要素の最後と最初を接続する工夫が必要です。これは通常、「データの複製」および「位置リセット」を使用して実現します。具体的には、配列の前後にデータを追加して、スクロール位置が最初または最後に到達したときに、ユーザーに気づかれないようにスクロール位置をリセットします。

以下にその実装例を示します。

```swift
@available(iOS 17.0, *)
public struct TransitionScrollDesignView: View {
    let items: [ScrollDesignViewItem]
    let spacing: CGFloat
    let padding: CGFloat
    
    // Add duplicated items at the start and end for infinite scroll
    private var loopedItems: [ScrollDesignViewItem] {
        let loopItems = items
        return [items.last!] + loopItems + [items.first!]
    }

    @State private var scrollOffset: CGFloat = 0
    @State private var isScrolling = false
    
    public var body: some View {
        GeometryReader { geometry in
            ScrollView(.horizontal) {
                LazyHStack(spacing: spacing) {
                    ForEach(loopedItems, id: \.id) { item in
                        RoundedRectangle(cornerRadius: 15)
                            .fill(item.color.gradient)
                            .frame(width: max(geometry.size.width - padding * 2, 0), height: 100)
                            .scrollTransition(.interactive, axis: .horizontal) { view, phase in
                                view
                                    .scaleEffect(phase.isIdentity ? 1 : 0.95)
                                    .offset(y: phase.isIdentity ? -15 : 0)
                            }
                            .offset(y: 15)
                    }
                }
                .padding(.horizontal, padding)
                .scrollTargetLayout()
                .content.offset(x: scrollOffset)
                .onAppear {
                    // Set the initial scroll position to the second item
                    scrollOffset = -geometry.size.width + padding * 2 + spacing
                }
                .gesture(
                    DragGesture()
                        .onChanged { value in
                            isScrolling = true
                            scrollOffset = value.translation.width + (scrollOffset)
                        }
                        .onEnded { _ in
                            isScrolling = false
                            let scrollThreshold = geometry.size.width - padding * 2 + spacing
                            // Check if the scroll position is close to the start or end
                            if scrollOffset > 0 {
                                // Snap to the last item (loop)
                                withAnimation {
                                    scrollOffset = -(scrollThreshold * CGFloat(items.count))
                                }
                            } else if scrollOffset < -scrollThreshold * CGFloat(items.count + 1) {
                                // Snap to the first item (loop)
                                withAnimation {
                                    scrollOffset = -scrollThreshold
                                }
                            }
                        }
                )
            }
            .scrollTargetBehavior(.viewAligned)
            .scrollIndicators(.hidden)
        }
        .frame(height: 150)
    }
}
```

### 説明：
1. **Duplicated Items**: `loopedItems` 変数により、最初と最後の項目を複製し、無限スクロール感を作り出します。
2. **Scroll Position Reset**: `DragGesture` を使用して、スクロール位置がリセットされるようにします。ユーザーが最後の項目に到達した場合、次のスクロールが最初の項目に戻るように、`scrollOffset` を調整します。
3. **Initial Position**: `onAppear` でスクロールビューが最初に表示される位置をセットします。

これにより、ユーザーが気づかない形で無限にループする水平スクロールを実現できます。

---
