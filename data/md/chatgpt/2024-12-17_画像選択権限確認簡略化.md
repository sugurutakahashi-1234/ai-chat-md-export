# 画像選択権限確認簡略化

日付: 2024-12-17

---

## 👤 ユーザー
*2024/12/17 17:10:15*

pickImageWithPermission の定義やめてonPressedで直接実施して欲しい。

import 'dart:io';

import 'package:flutter/material.dart';
import 'package:flutter\_hooks/flutter\_hooks.dart';
import 'package:go\_router/go\_router.dart';
import 'package:image\_picker/image\_picker.dart';
import 'package:permission\_handler/permission\_handler.dart';

class GuildCreatePage extends HookWidget {
  const GuildCreatePage({super.key});

  @override
  Widget build(BuildContext context) {
    final imageFile = useState&lt;File?&gt;(null);
    final picker = useMemoized(ImagePicker.new);

    /// 写真を選択
    Future&lt;void&gt; pickImage() async {
      final pickedFile = await picker.pickImage(source: ImageSource.gallery);

      if (pickedFile != null) {
        imageFile.value = File(pickedFile.path);
      } else {
        debugPrint('画像選択がキャンセルされました');
      }
    }

        /// 写真へのアクセス権を確認して画像を選択
    Future&lt;void&gt; pickImageWithPermission() async {
      final status = await \_checkPhotoPermission(context);
      if (status == PermissionStatus.granted) {
        await pickImage();
      }
    }

    return Scaffold(
      appBar: AppBar(title: const Text('GuildCreatePage')),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: \[
            imageFile.value != null
                ? Image.file(imageFile.value!, height: 300, fit: BoxFit.cover)
                : const Text('画像が選択されていません'),
            const SizedBox(height: 20),
            ElevatedButton(
              onPressed: pickImageWithPermission,
              child: const Text('ギルドアイコンを選択'),
            ),
            ElevatedButton(
              onPressed: () {
                context.pop();
              },
              child: const Text('Create'),
            ),
          \],
        ),
      ),
    );
  }

  /// 写真の権限をチェックする
  Future&lt;PermissionStatus&gt; \_checkPhotoPermission(BuildContext context) async {
    final status = await Permission.photos.request();

    if (status.isGranted) {
      // 許可済みの場合
      return status;
    } else if (status.isPermanentlyDenied) {
      // 永久に拒否されている場合
      if (context.mounted) {
        \_showPermissionDialog(context);
      }
    } else {
      // その他のケース（拒否された場合）
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('写真へのアクセスが許可されていません。')),
        );
      }
    }
    return status;
  }

  /// 設定ダイアログを表示
  void \_showPermissionDialog(BuildContext context) {
    showDialog&lt;void&gt;(
      context: context,
      builder: (context) =&gt; AlertDialog(
        title: const Text('写真へのアクセス許可が必要です'),
        content: const Text('写真を選択するには、設定で写真へのアクセス許可をオンにしてください。'),
        actions: \[
          TextButton(
            onPressed: () {
              Navigator.of(context).pop();
            },
            child: const Text('キャンセル'),
          ),
          TextButton(
            onPressed: () async {
              await openAppSettings(); // アプリの設定画面を開く
            },
            child: const Text('設定を開く'),
          ),
        \],
      ),
    );
  }
}

---

## 🤖 アシスタント
*2024/12/17 17:10:56*

`pickImageWithPermission` の定義を削除し、`onPressed` 内で直接権限確認と画像選択を実施するように変更します。以下のコードで対応します。

---

## 🤖 アシスタント
*2024/12/17 17:10:56*

{"name": "pick\_image\_direct", "type": "code/dart", "content": "import 'dart:io';\\n\\nimport 'package:flutter/material.dart';\\nimport 'package:flutter\_hooks/flutter\_hooks.dart';\\nimport 'package:go\_router/go\_router.dart';\\nimport 'package:image\_picker/image\_picker.dart';\\nimport 'package:permission\_handler/permission\_handler.dart';\\n\\nclass GuildCreatePage extends HookWidget {\\n  const GuildCreatePage({super.key});\\n\\n  @override\\n  Widget build(BuildContext context) {\\n    final imageFile = useState&lt;File?&gt;(null);\\n    final picker = useMemoized(ImagePicker.new);\\n\\n    /// 写真を選択\\n    Future&lt;void&gt; pickImage() async {\\n      final pickedFile = await picker.pickImage(source: ImageSource.gallery);\\n      if (pickedFile != null) {\\n        imageFile.value = File(pickedFile.path);\\n      } else {\\n        debugPrint('画像選択がキャンセルされました');\\n      }\\n    }\\n\\n    return Scaffold(\\n      appBar: AppBar(title: const Text('GuildCreatePage')),\\n      body: Center(\\n        child: Column(\\n          mainAxisAlignment: MainAxisAlignment.center,\\n          children: \[\\n            imageFile.value != null\\n                ? Image.file(imageFile.value!, height: 300, fit: BoxFit.cover)\\n                : const Text('画像が選択されていません'),\\n            const SizedBox(height: 20),\\n            ElevatedButton(\\n              onPressed: () async {\\n                final status = await Permission.photos.request();\\n\\n                if (status.isGranted) {\\n                  await pickImage();\\n                } else if (status.isPermanentlyDenied) {\\n                  if (context.mounted) {\\n                    \_showPermissionDialog(context);\\n                  }\\n                } else {\\n                  if (context.mounted) {\\n                    ScaffoldMessenger.of(context).showSnackBar(\\n                      const SnackBar(content: Text('写真へのアクセスが許可されていません。')),\\n                    );\\n                  }\\n                }\\n              },\\n              child: const Text('ギルドアイコンを選択'),\\n            ),\\n            ElevatedButton(\\n              onPressed: () {\\n                context.pop();\\n              },\\n              child: const Text('Create'),\\n            ),\\n          \],\\n        ),\\n      ),\\n    );\\n  }\\n\\n  /// 設定ダイアログを表示\\n  void \_showPermissionDialog(BuildContext context) {\\n    showDialog&lt;void&gt;(\\n      context: context,\\n      builder: (context) =&gt; AlertDialog(\\n        title: const Text('写真へのアクセス許可が必要です'),\\n        content: const Text('写真を選択するには、設定で写真へのアクセス許可をオンにしてください。'),\\n        actions: \[\\n          TextButton(\\n            onPressed: () {\\n              Navigator.of(context).pop();\\n            },\\n            child: const Text('キャンセル'),\\n          ),\\n          TextButton(\\n            onPressed: () async {\\n              await openAppSettings(); // アプリの設定画面を開く\\n            },\\n            child: const Text('設定を開く'),\\n          ),\\n        \],\\n      ),\\n    );\\n  }\\n}"}

---

## 🔧 ツール
*2024/12/17 17:10:56*

{"result": "Successfully created text document 'pick\_image\_direct' which will be referenced in all future messages with the unique identifier textdoc\_id: '67613209bb60819197c8cff2ada8c93b'", "textdoc\_id": "67613209bb60819197c8cff2ada8c93b", "name": "pick\_image\_direct"}

---

## 🤖 アシスタント
*2024/12/17 17:10:56*

### 主な変更点
1. \*\*`pickImageWithPermission` 関数を削除\*\*。
2. `onPressed` 内に直接権限確認と `pickImage` を実装。
3. 権限が `granted` なら画像選択、`permanentlyDenied` の場合は設定ダイアログ表示、それ以外は `SnackBar` を表示。

この形ならロジックがシンプルでコードが短くなります。

---
