# Swiftã§éŸ³å£°URLã‚’æ“ä½œ

æ—¥ä»˜: 2024-06-24

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/6/24 18:49:26*

Swiftã§éŸ³å£°URLã®é…åˆ—ã‚’ã‚ãŸã—ã¦ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚»ãƒ³ã‚¿ãƒ¼ã®æ¬¡ã¸ã¨æˆ»ã‚‹ã«å¯¾å¿œã•ã›ãŸã„

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/6/24 18:50:12*

éŸ³å£°URLã®é…åˆ—ã‚’æ¸¡ã—ã¦ã€iOSã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚»ãƒ³ã‚¿ãƒ¼ã®ã€Œæ¬¡ã¸ã€ã¨ã€Œæˆ»ã‚‹ã€ã«å¯¾å¿œã•ã›ã‚‹ã«ã¯ã€`AVQueuePlayer`ã‚’ä½¿ç”¨ã™ã‚‹ã®ãŒä¸€èˆ¬çš„ã§ã™ã€‚`AVQueuePlayer`ã‚’ä½¿ã†ã¨ã€è¤‡æ•°ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ç”Ÿãƒªã‚¹ãƒˆã¨ã—ã¦ç®¡ç†ã—ã€æ¬¡ã®ãƒˆãƒ©ãƒƒã‚¯ã‚„å‰ã®ãƒˆãƒ©ãƒƒã‚¯ã«ç°¡å˜ã«ç§»å‹•ã§ãã¾ã™ã€‚

ä»¥ä¸‹ã¯ã€Swiftã§ã®å®Ÿè£…ä¾‹ã§ã™ï¼š

```swift
import AVFoundation
import MediaPlayer

class AudioPlayerManager: NSObject {
    static let shared = AudioPlayerManager()
    private var player: AVQueuePlayer?
    private var playerItems: [AVPlayerItem] = []

    private override init() {
        super.init()
        setupRemoteTransportControls()
    }

    func setupAudioPlayer(with urls: [URL]) {
        playerItems = urls.map { AVPlayerItem(url: $0) }
        player = AVQueuePlayer(items: playerItems)
    }

    func play() {
        player?.play()
    }

    func pause() {
        player?.pause()
    }

    func skipToNext() {
        player?.advanceToNextItem()
    }

    func skipToPrevious() {
        guard let currentItem = player?.currentItem else { return }
        player?.pause()
        player?.insert(currentItem, after: nil)
        player?.play()
    }

    private func setupRemoteTransportControls() {
        let commandCenter = MPRemoteCommandCenter.shared()
        
        commandCenter.playCommand.addTarget { [unowned self] event in
            self.play()
            return .success
        }
        
        commandCenter.pauseCommand.addTarget { [unowned self] event in
            self.pause()
            return .success
        }

        commandCenter.nextTrackCommand.addTarget { [unowned self] event in
            self.skipToNext()
            return .success
        }

        commandCenter.previousTrackCommand.addTarget { [unowned self] event in
            self.skipToPrevious()
            return .success
        }
    }
}
```

### ä½¿ç”¨æ–¹æ³•

1. é…åˆ—ã§éŸ³å£°URLã‚’æ¸¡ã—ã¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ï¼š
```swift
let audioURLs: [URL] = [
    URL(string: "https://example.com/audio1.mp3")!,
    URL(string: "https://example.com/audio2.mp3")!
]

AudioPlayerManager.shared.setupAudioPlayer(with: audioURLs)
```

2. å†ç”Ÿã€åœæ­¢ã€æ¬¡ã®ãƒˆãƒ©ãƒƒã‚¯ã€å‰ã®ãƒˆãƒ©ãƒƒã‚¯ã«ç§»å‹•ã™ã‚‹ãŸã‚ã«ã€`AudioPlayerManager.shared.play()`, `AudioPlayerManager.shared.pause()`, `AudioPlayerManager.shared.skipToNext()`, `AudioPlayerManager.shared.skipToPrevious()`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

3. ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚»ãƒ³ã‚¿ãƒ¼ã§ã®æ“ä½œã¯ã€`setupRemoteTransportControls()`ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã£ã¦å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã€ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒãƒ³ãƒ‰ã‚»ãƒ³ã‚¿ãƒ¼ã‚’è¨­å®šã—ã€å†ç”Ÿã€åœæ­¢ã€æ¬¡ã®ãƒˆãƒ©ãƒƒã‚¯ã€å‰ã®ãƒˆãƒ©ãƒƒã‚¯ã®ã‚³ãƒãƒ³ãƒ‰ã«å¯¾å¿œã—ã¾ã™ã€‚

ã“ã®å®Ÿè£…ã«ã‚ˆã‚Šã€iOSã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚»ãƒ³ã‚¿ãƒ¼ã‚„ãƒ­ãƒƒã‚¯ç”»é¢ã‹ã‚‰ã®æ“ä½œãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/6/24 18:51:02*

ã“ã‚Œã¯ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å†ç”Ÿå¯èƒ½ãªã®ï¼Ÿ

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/6/24 18:51:44*

`AVQueuePlayer`ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€URLãŒã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯èƒ½ã§ã‚ã‚Œã°ã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å†ç”Ÿã‚‚å¯èƒ½ã§ã™ã€‚ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å†ç”Ÿã®URLã¯é€šå¸¸ã€HTTP Live Streaming (HLS) ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆæ‹¡å¼µå­ãŒ`.m3u8`ï¼‰ãªã©ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

ä»¥ä¸‹ã«ã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å†ç”Ÿã«å¯¾å¿œã—ãŸå®Ÿè£…ä¾‹ã‚’ç¤ºã—ã¾ã™ï¼š

```swift
import AVFoundation
import MediaPlayer

class AudioPlayerManager: NSObject {
    static let shared = AudioPlayerManager()
    private var player: AVQueuePlayer?
    private var playerItems: [AVPlayerItem] = []

    private override init() {
        super.init()
        setupRemoteTransportControls()
        setupNowPlayingInfoCenter()
    }

    func setupAudioPlayer(with urls: [URL]) {
        playerItems = urls.map { AVPlayerItem(url: $0) }
        player = AVQueuePlayer(items: playerItems)
    }

    func play() {
        player?.play()
    }

    func pause() {
        player?.pause()
    }

    func skipToNext() {
        player?.advanceToNextItem()
        updateNowPlayingInfo()
    }

    func skipToPrevious() {
        guard let currentItem = player?.currentItem else { return }
        player?.pause()
        player?.insert(currentItem, after: nil)
        player?.play()
        updateNowPlayingInfo()
    }

    private func setupRemoteTransportControls() {
        let commandCenter = MPRemoteCommandCenter.shared()

        commandCenter.playCommand.addTarget { [unowned self] event in
            self.play()
            return .success
        }

        commandCenter.pauseCommand.addTarget { [unowned self] event in
            self.pause()
            return .success
        }

        commandCenter.nextTrackCommand.addTarget { [unowned self] event in
            self.skipToNext()
            return .success
        }

        commandCenter.previousTrackCommand.addTarget { [unowned self] event in
            self.skipToPrevious()
            return .success
        }
    }

    private func setupNowPlayingInfoCenter() {
        // Set up Now Playing Info Center
        let nowPlayingInfoCenter = MPNowPlayingInfoCenter.default()
        nowPlayingInfoCenter.nowPlayingInfo = [
            MPMediaItemPropertyTitle: "Audio Title",
            MPMediaItemPropertyArtist: "Artist Name",
            MPNowPlayingInfoPropertyPlaybackRate: 1.0
        ]
    }

    private func updateNowPlayingInfo() {
        guard let currentItem = player?.currentItem else { return }
        let nowPlayingInfoCenter = MPNowPlayingInfoCenter.default()
        var nowPlayingInfo = nowPlayingInfoCenter.nowPlayingInfo ?? [String: Any]()

        nowPlayingInfo[MPMediaItemPropertyTitle] = "Updated Title"
        nowPlayingInfo[MPMediaItemPropertyArtist] = "Updated Artist"
        nowPlayingInfo[MPNowPlayingInfoPropertyElapsedPlaybackTime] = CMTimeGetSeconds(currentItem.currentTime())
        nowPlayingInfo[MPMediaItemPropertyPlaybackDuration] = CMTimeGetSeconds(currentItem.asset.duration)
        nowPlayingInfo[MPNowPlayingInfoPropertyPlaybackRate] = player?.rate

        nowPlayingInfoCenter.nowPlayingInfo = nowPlayingInfo
    }
}
```

### ä½¿ç”¨æ–¹æ³•

1. é…åˆ—ã§ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°URLã‚’æ¸¡ã—ã¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ï¼š

```swift
let streamingURLs: [URL] = [
    URL(string: "https://example.com/stream1.m3u8")!,
    URL(string: "https://example.com/stream2.m3u8")!
]

AudioPlayerManager.shared.setupAudioPlayer(with: streamingURLs)
```

2. å†ç”Ÿã€åœæ­¢ã€æ¬¡ã®ãƒˆãƒ©ãƒƒã‚¯ã€å‰ã®ãƒˆãƒ©ãƒƒã‚¯ã«ç§»å‹•ã™ã‚‹ãŸã‚ã«ã€`AudioPlayerManager.shared.play()`, `AudioPlayerManager.shared.pause()`, `AudioPlayerManager.shared.skipToNext()`, `AudioPlayerManager.shared.skipToPrevious()`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

3. ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚»ãƒ³ã‚¿ãƒ¼ã‚„ãƒ­ãƒƒã‚¯ç”»é¢ã‹ã‚‰ã®æ“ä½œã‚‚åŒæ§˜ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã®æ–¹æ³•ã§ã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°URLãŒæä¾›ã™ã‚‹éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’å†ç”Ÿã—ã€iOSã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚»ãƒ³ã‚¿ãƒ¼ã‚„ãƒ­ãƒƒã‚¯ç”»é¢ã‹ã‚‰ã®åˆ¶å¾¡ã‚‚å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/6/24 18:53:26*

ã¡ãªã¿ã«ã“ã‚Œã‚’ä½¿ã£ã¦SwiftUIã§éŸ³é‡ã¨ã‹ã‚’è¡¨ç¤ºã§ãã‚‹ï¼ŸAV audio playerã¨ã‹ã§average Powerãªã©å–å¾—ã™ã‚Œã°å–ã‚Œã¦ã‚„ã¤ãªã‚“ã ã‘ã©

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/6/24 18:54:43*

SwiftUIã§éŸ³é‡ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ã€`AVAudioRecorder`ã‚„`AVAudioPlayer`ã‚’ä½¿ã£ã¦éŸ³é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€ãã®ãƒ‡ãƒ¼ã‚¿ã‚’SwiftUIã®ãƒ“ãƒ¥ãƒ¼ã«åæ˜ ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä»¥ä¸‹ã«ã€`AVAudioPlayer`ã‚’ä½¿ç”¨ã—ã¦éŸ³é‡ã‚’å–å¾—ã—ã€SwiftUIã§è¡¨ç¤ºã™ã‚‹ä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚

### 1. `AudioPlayerManager`ã®æ‹¡å¼µ

ã¾ãšã€éŸ³é‡ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®`AudioPlayerManager`ã‚’æ‹¡å¼µã—ã¾ã™ã€‚

```swift
import AVFoundation
import Combine

class AudioPlayerManager: NSObject, ObservableObject {
    static let shared = AudioPlayerManager()
    private var player: AVQueuePlayer?
    private var playerItems: [AVPlayerItem] = []
    private var timer: Timer?
    
    @Published var currentVolume: Float = 0.0

    private override init() {
        super.init()
        setupRemoteTransportControls()
        setupNowPlayingInfoCenter()
    }

    func setupAudioPlayer(with urls: [URL]) {
        playerItems = urls.map { AVPlayerItem(url: $0) }
        player = AVQueuePlayer(items: playerItems)
        startVolumeMonitoring()
    }

    func play() {
        player?.play()
    }

    func pause() {
        player?.pause()
    }

    func skipToNext() {
        player?.advanceToNextItem()
        updateNowPlayingInfo()
    }

    func skipToPrevious() {
        guard let currentItem = player?.currentItem else { return }
        player?.pause()
        player?.insert(currentItem, after: nil)
        player?.play()
        updateNowPlayingInfo()
    }

    private func setupRemoteTransportControls() {
        let commandCenter = MPRemoteCommandCenter.shared()

        commandCenter.playCommand.addTarget { [unowned self] event in
            self.play()
            return .success
        }

        commandCenter.pauseCommand.addTarget { [unowned self] event in
            self.pause()
            return .success
        }

        commandCenter.nextTrackCommand.addTarget { [unowned self] event in
            self.skipToNext()
            return .success
        }

        commandCenter.previousTrackCommand.addTarget { [unowned self] event in
            self.skipToPrevious()
            return .success
        }
    }

    private func setupNowPlayingInfoCenter() {
        let nowPlayingInfoCenter = MPNowPlayingInfoCenter.default()
        nowPlayingInfoCenter.nowPlayingInfo = [
            MPMediaItemPropertyTitle: "Audio Title",
            MPMediaItemPropertyArtist: "Artist Name",
            MPNowPlayingInfoPropertyPlaybackRate: 1.0
        ]
    }

    private func updateNowPlayingInfo() {
        guard let currentItem = player?.currentItem else { return }
        let nowPlayingInfoCenter = MPNowPlayingInfoCenter.default()
        var nowPlayingInfo = nowPlayingInfoCenter.nowPlayingInfo ?? [String: Any]()

        nowPlayingInfo[MPMediaItemPropertyTitle] = "Updated Title"
        nowPlayingInfo[MPMediaItemPropertyArtist] = "Updated Artist"
        nowPlayingInfo[MPNowPlayingInfoPropertyElapsedPlaybackTime] = CMTimeGetSeconds(currentItem.currentTime())
        nowPlayingInfo[MPMediaItemPropertyPlaybackDuration] = CMTimeGetSeconds(currentItem.asset.duration)
        nowPlayingInfo[MPNowPlayingInfoPropertyPlaybackRate] = player?.rate

        nowPlayingInfoCenter.nowPlayingInfo = nowPlayingInfo
    }
    
    private func startVolumeMonitoring() {
        timer?.invalidate()
        timer = Timer.scheduledTimer(timeInterval: 0.1, target: self, selector: #selector(updateVolume), userInfo: nil, repeats: true)
    }
    
    @objc private func updateVolume() {
        guard let currentItem = player?.currentItem else { return }
        let asset = currentItem.asset
        asset.loadValuesAsynchronously(forKeys: ["tracks"]) {
            var error: NSError?
            let status = asset.statusOfValue(forKey: "tracks", error: &error)
            if status == .loaded {
                if let track = asset.tracks(withMediaType: .audio).first {
                    let formatDescriptions = track.formatDescriptions as! [CMAudioFormatDescription]
                    if let audioStreamBasicDescription = CMAudioFormatDescriptionGetStreamBasicDescription(formatDescriptions[0]) {
                        let sampleRate = audioStreamBasicDescription.pointee.mSampleRate
                        let channelCount = audioStreamBasicDescription.pointee.mChannelsPerFrame
                        let bufferSize = UInt32(sampleRate * 0.1)
                        
                        var buffer = [Int16](repeating: 0, count: Int(bufferSize))
                        var bufferList = AudioBufferList()
                        bufferList.mNumberBuffers = 1
                        bufferList.mBuffers.mNumberChannels = channelCount
                        bufferList.mBuffers.mDataByteSize = bufferSize * 2
                        bufferList.mBuffers.mData = &buffer
                        
                        if let audioUnit = track.copy() as? AVAudioUnit {
                            audioUnit.inputHandler = { (bufferList, _) in
                                let buffer = bufferList[0]
                                let samples = buffer.mData?.assumingMemoryBound(to: Int16.self)
                                let sampleCount = Int(buffer.mDataByteSize) / MemoryLayout<Int16>.size
                                
                                var sum: Float = 0.0
                                for i in 0..<sampleCount {
                                    sum += abs(Float(samples?[i] ?? 0))
                                }
                                
                                let avgVolume = sum / Float(sampleCount)
                                DispatchQueue.main.async {
                                    self.currentVolume = avgVolume
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
```

### 2. SwiftUI Viewã®å®Ÿè£…

æ¬¡ã«ã€SwiftUIãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆã—ã¦ã€éŸ³é‡ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

```swift
import SwiftUI

struct ContentView: View {
    @ObservedObject var audioPlayerManager = AudioPlayerManager.shared

    var body: some View {
        VStack {
            Text("Audio Player")
                .font(.largeTitle)
                .padding()
            
            Text("Current Volume: \(audioPlayerManager.currentVolume, specifier: "%.2f")")
                .padding()
            
            Button(action: {
                audioPlayerManager.play()
            }) {
                Text("Play")
                    .padding()
                    .background(Color.blue)
                    .foregroundColor(.white)
                    .cornerRadius(8)
            }
            
            Button(action: {
                audioPlayerManager.pause()
            }) {
                Text("Pause")
                    .padding()
                    .background(Color.red)
                    .foregroundColor(.white)
                    .cornerRadius(8)
            }
        }
    }
}

@main
struct YourApp: App {
    var body: some Scene {
        WindowGroup {
            ContentView()
        }
    }
}
```

### èª¬æ˜
- `AudioPlayerManager`ã‚¯ãƒ©ã‚¹ã‚’æ‹¡å¼µã—ã€éŸ³é‡ã‚’å–å¾—ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`currentVolume`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ã€SwiftUIã®ãƒ“ãƒ¥ãƒ¼ã«ãƒã‚¤ãƒ³ãƒ‰ã•ã‚Œã¾ã™ã€‚
- `startVolumeMonitoring`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã€ã‚¿ã‚¤ãƒãƒ¼ã‚’ä½¿ã£ã¦å®šæœŸçš„ã«éŸ³é‡ã‚’å–å¾—ã—ã€`updateVolume`ãƒ¡ã‚½ãƒƒãƒ‰ã§ç¾åœ¨ã®éŸ³é‡ã‚’æ›´æ–°ã—ã¾ã™ã€‚
- SwiftUIã®`ContentView`ã§ã€`AudioPlayerManager`ã‚’`@ObservedObject`ã¨ã—ã¦ç›£è¦–ã—ã€éŸ³é‡ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚

ã“ã®å®Ÿè£…ã«ã‚ˆã‚Šã€éŸ³é‡ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºãŒå¯èƒ½ã«ãªã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦–è¦šçš„ã«ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

---
