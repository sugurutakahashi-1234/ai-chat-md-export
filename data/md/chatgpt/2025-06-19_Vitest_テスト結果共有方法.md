# Vitest テスト結果共有方法

日付: 2025-06-19

---

## 👤 ユーザー
*2025/6/19 20:43:27*

vitest のテスト結果をカジュアルに共有したい。 どういう選択肢があるだろう。  

import { coverageConfigDefaults, defineConfig } from "vitest/config";

export default defineConfig({
  test: {
    globals: true,
    environment: "node",
    // css: true, // ルートレベルではCSS処理は不要（各パッケージで設定）

    // テスト環境のセットアップとクリーンアップ
    globalSetup: \["./vitest.setup.ts"\],

    // ─────────────────────────────────────────────
    // ①: テスト対象ファイルのパターン
    //    \*.test.ts / \*.spec.ts などを packages/\*/src 以下から拾う
    //    Vitest 標準のパターン（docs: \*\*/\*.{test,spec}.?(c|m)\[jt\]s?(x)）を
    //    packages/\*/src に限定するだけで OK
    // ─────────────────────────────────────────────
    include: \["packages/\*/src/\*\*/\*.{test,spec}.?(c|m)\[jt\]s?(x)"\],

    // テスト自体を実行しないパス
    // Vitestのデフォルト除外設定に追加でプロジェクト固有の除外を指定
    exclude: \[
      "\*\*/node\_modules/\*\*",
      "\*\*/dist/\*\*",
      "\*\*/cypress/\*\*",
      "\*\*/.{idea,git,cache,output,temp}/\*\*",
      "\*\*/{karma,rollup,webpack,vite,vitest,jest,ava,babel,nyc,cypress,tsup,build}.config.\*",
      "\*\*/\*.manual.test.ts", // 手動実行用のテストを除外
      "\*\*/e2e/\*\*", // E2Eテストを除外（Playwrightで実行）
      "\*\*/dist-storybook/\*\*", // Storybookビルド成果物を除外
    \],

    // ─────────────────────────────────────────────
    // ②: カバレッジ設定
    //    test.include と同じパターンは Vitest が自動で除外してくれる
    //    → 重複する exclude は不要
    // ─────────────────────────────────────────────
    coverage: {
      provider: "v8", // Node 18+ なら v8 で問題なし
      reporter: \["text", "json", "html", "json-summary"\],
      reportsDirectory: "./coverage",
      exclude: \[
        "\*\*/\*.config.\*", // 設定ファイルを除外
        "\*\*/src/generated/\*\*", // 自動生成ファイルを除外
        "\*\*/\*.d.ts", // 型定義ファイルを除外
        "\*\*/\_\_tests\_\_/\*\*", // テストファイルを除外
        "\*\*/\*.test.ts", // テストファイルを除外
        "\*\*/\*.spec.ts", // テストファイルを除外
        "\*\*/test/\*\*", // テストディレクトリを除外
        "\*\*/dist/\*\*", // ビルド成果物を除外
        "\*\*/node\_modules/\*\*", // node\_modulesを除外
        "\*\*/\*.stories.tsx", // Storybookファイルを除外
        "\*\*/dist-storybook/\*\*", // Storybookビルド成果物を除外
        "packages/\*/scripts/\*\*", // スクリプトファイルを除外
        "packages/database/prisma/\*\*", // Prismaスキーマ・シードを除外
        "packages/web-client/src/main.tsx", // エントリポイントを除外
        "packages/server/src/index.ts", // エントリポイントを除外
        ...coverageConfigDefaults.exclude, // 既定の除外を維持
      \],
      thresholds: {
        // カバレッジの最低基準を設定（オプション）
        statements: 0, // 現在は0%から始める
        branches: 0,
        functions: 0,
        lines: 0,
      },
    },
  },
});

---

## 🤖 アシスタント
*2025/6/19 20:43:47*

「カジュアルに共有する」＝**“テストを回したら、できるだけ手間なくチーム全員が結果を見られる”**という観点で、代表的な選択肢を 5 つのパターンに整理しました。すべて Vitest が標準で出力できるレポートやプラグインに沿っているので、今の vitest.config.ts に reporter／coverage 設定を少し足すだけで済みます。

---

### 1. **静的 HTML レポートをそのまま置く**  
Vitest の `coverage.reporter: "html"` を指定すると `coverage/index.html` が生成されます。これを GitHub Pages／Vercel／Netlify などに push しておけば、URL を投げるだけで完了。CI を組まなくてもローカル `npx vitest run --coverage` → `open coverage/index.html` で即確認できます。citeturn0search2  

> **向いているケース**  
> * 個人開発や少人数チーム  
> * CI がまだ整っておらず “とりあえず URL があれば OK”

---

### 2. **GitHub Actions の Step Summary／PR コメント**  
- **vitest-coverage-report-action**  
  GitHub Actions でテストを回すと、Step Summary と Pull Request コメントに “全体サマリ＋ファイル別カバレッジ” を貼り付けてくれる Action。HTML を別途ホストしなくても、PR 画面だけでカバレッジを確認できます。citeturn0search1  
- **vitest-github-actions-summary-reporter**  
  Vitest のカスタム reporter 版。`reporters: [new GithubActionsReporter()]` と書くだけで、Actions の built-in “Summary” にテスト結果が出力されます。citeturn0search7  

> **向いているケース**  
> * GitHub Flow／PR Review が中心  
> * “別タブを開きたくない” という開発者に優しい

---

### 3. **Codecov / Coveralls / Trunk など外部サービスにアップロード**  
Vitest は `--reporter=junit` で JUnit XML を出力できます。  
- **Codecov Test Analytics**：JUnit とカバレッジを両方食わせるとダッシュボードで推移を可視化。citeturn0search5turn0search10  
- **Trunk Flaky Test Analytics**：JUnit XML のみで “どのテストが flaky か” を検出。citeturn1search5  

CI で XML を artifact としてアップ → サービス側へ upload コマンド or GitHub Action で送るだけなのでセットアップは数行です。  

> **向いているケース**  
> * カバレッジ推移をグラフで見たい  
> * Flaky テストを自動検知したい  
> * リポジトリ外に結果を置いても OK

---

### 4. **Slack／Teams などチャット通知**  
- **CTRf Slack Reporter**（`slack-ctrf`）はフレームワーク横断型。Vitest でも `npx slack-ctrf results vitest-ctrf.json` で結果を送信できます。citeturn1search1  
- 自作でも簡単で、Vitest の `json` レポートを Slack Webhook に POST する 20 行程度のスクリプトで十分。  

> **向いているケース**  
> * 「落ちたら即チームに通知」「毎朝結果を流す」など情報共有をチャットで完結させたい  
> * CI はあるがダッシュボードまでは不要

---

### 5. **ホスティング付きダッシュボードサービス**  
- **TestPig.io**：npm `@testpig/vitest-reporter` を追加すると、自動でテスト結果がクラウドに送られ、Web ダッシュボードで履歴・傾向が閲覧可能。citeturn0search3  
- **ReportPortal**：より本格派のテストレポーティング。Vitest 用エージェントがあり、結果をリアルタイム集計。citeturn0search9  

> **向いているケース**  
> * 複数プロジェクト／大量テストを横断管理したい  
> * スクリーンショットやログをひとまとめに残したい

---

## すぐ試せる最小構成サンプル

```ts
// vitest.config.ts
import { defineConfig } from "vitest/config";
import { GithubActionsReporter } from "vitest-github-actions-summary-reporter";

export default defineConfig({
  test: {
    reporters: [
      "default",
      "junit",               // JUnit XML (Codecov 等に流用)
      new GithubActionsReporter(), // GH Step Summary
    ],
    outputFile: {
      junit: "vitest-report.junit.xml",
    },
    coverage: {
      reporter: ["text", "json", "html"], // HTML も残す
    },
  },
});
```

- **HTML** → `coverage/` を GitHub Pages にデプロイ（最短 `pnpm gh-pages -d coverage`）  
- **GitHub Actions** → 前述の Action か `cat vitest-report.junit.xml` を Codecov Action へ渡すだけ  
- **Slack** → ジョブの最後に `npx slack-ctrf results vitest-report.junit.xml --token $SLACK_WEBHOOK`  

---

### まとめ

| 共有方法 | 導入コスト | 視認性 | コメント |
|----------|-----------|--------|----------|
| HTML 静的ページ | ★ | ◎ | URL があれば OK |
| GH Step Summary / PR コメント | ★★ | ◎ | GitHub で完結 |
| Codecov / Coveralls / Trunk | ★★ | ○ | 解析系も豊富 |
| Slack 通知 | ★★ | ○ | “落ちたら鳴る” 文化向け |
| TestPig.io / ReportPortal | ★★★ | ◎ | 歴史・検索・分析まで |

まず **Step Summary + HTML** だけでも十分 “カジュアル共有” は実現できます。  
さらに分析したくなったら Codecov 等へエクスポート、チームの通知フローに合わせて Slack 連携を加える、という段階的な拡張がおすすめです。

---
