# ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜å‡¦ç†

æ—¥ä»˜: 2025-01-15

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2025/01/15 19:41:59*

VerifyCodeNotifier ã® verifyCode ã‚’èª­ã‚“ã§ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã—ãŸã„

class AuthCredentials {
  AuthCredentials({required this.accessToken});

  final String accessToken;
}

@riverpod
class VerifyCodeNotifier extends _$VerifyCodeNotifier {
  @override
  Future&lt;AuthCredentials?&gt; build() async =&gt; null;

  Future&lt;AuthCredentials&gt; verifyCode(String email, num code) async {
    state = const AsyncValue.loading();
    try {
      final api = await ref.watch(authApiProvider.future);
      final response = await api.authControllerLogin(
        AuthLoginDTO(email: email, code: code),
      );
      debugPrint('Response Body: ${response.data}');
      debugPrint('Response Body.data: ${response.data?.data}');
      final responseData = response.data?.data;
      if (responseData == null) {
        throw Exception('Photo upload failed: response data is null');
      }
      // final authCredentials = AuthCredentials(
      //   accessToken: responseData.accessToken,
      // );
      final authCredentials = AuthCredentials(
        accessToken:
            // ignore: lines_longer_than_80_chars
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1dWlkIjoiMTIzZTQ1NjctZTg5Yi0xMmQzLWE0NTYtNDI2NjE0MTc0MDAwIiwiYWNjZXNzVG9rZW4iOiJ1c2VyMUBleGFtcGxlLmNvbSIsImlzc3VlZEF0IjoxNzM2NDc3NzUxOTg5LCJpYXQiOjE3MzY0Nzc3NTEsImV4cCI6MTczOTA2OTc1MX0.blJd4GIRkobRS6rNatg6IRJINBzq6lr0E3lLDFwfRJY',
      );
      state = AsyncValue.data(authCredentials);
      return authCredentials;
    } on Exception catch (e, stackTrace) {
      debugPrint('Error: $e');
      debugPrint('StackTrace: $stackTrace');
      state = AsyncValue.error(e, stackTrace);
      rethrow;
    }
  }
}

@Riverpod(keepAlive: true)
class AccessTokenNotifier extends _$AccessTokenNotifier {
  @override
  Future&lt;String?&gt; build() async {
    final storage = ref.read(flutterSecureStorageProvider);
    return storage.read(key: SecureStorageKey.accessToken.name);
  }

  Future&lt;void&gt; save(String accessToken) async {
    final storage = ref.read(flutterSecureStorageProvider);
    await storage.write(
      key: SecureStorageKey.accessToken.name,
      value: accessToken,
    );
    state = AsyncData(accessToken);
  }

  Future&lt;void&gt; delete() async {
    final storage = ref.read(flutterSecureStorageProvider);
    await storage.delete(key: SecureStorageKey.accessToken.name);
    state = const AsyncData(null);
  }
}

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2025/01/15 19:42:21*

`VerifyCodeNotifier` ã® `verifyCode` ãƒ¡ã‚½ãƒƒãƒ‰ã§èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã€ãã‚Œã‚’ `AccessTokenNotifier` ã«ä¿å­˜ã™ã‚‹ã«ã¯ã€`AccessTokenNotifier` ã‚’å‚ç…§ã—ã¦ä¿å­˜æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã«ã€`AccessTokenNotifier` ã‚’ `verifyCode` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã§ãã¾ã™ã€‚

ä¿®æ­£å¾Œã® `verifyCode` ãƒ¡ã‚½ãƒƒãƒ‰ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

### ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰

```dart
Future<AuthCredentials> verifyCode(String email, num code) async {
  state = const AsyncValue.loading();
  try {
    final api = await ref.watch(authApiProvider.future);
    final response = await api.authControllerLogin(
      AuthLoginDTO(email: email, code: code),
    );
    debugPrint('Response Body: ${response.data}');
    debugPrint('Response Body.data: ${response.data?.data}');
    final responseData = response.data?.data;
    if (responseData == null) {
      throw Exception('Photo upload failed: response data is null');
    }
    final authCredentials = AuthCredentials(
      accessToken: responseData.accessToken,
    );

    // AccessTokenNotifier ã«ä¿å­˜
    await ref.read(accessTokenNotifierProvider.notifier).save(authCredentials.accessToken);

    state = AsyncValue.data(authCredentials);
    return authCredentials;
  } on Exception catch (e, stackTrace) {
    debugPrint('Error: $e');
    debugPrint('StackTrace: $stackTrace');
    state = AsyncValue.error(e, stackTrace);
    rethrow;
  }
}
```

### ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ

1. **AccessTokenNotifier ã®å‘¼ã³å‡ºã—**:
   `ref.read(accessTokenNotifierProvider.notifier).save` ã‚’ç”¨ã„ã¦ã€`AccessTokenNotifier` ã«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã—ã¾ã™ã€‚ã“ã®å‘¼ã³å‡ºã—ã«ã‚ˆã‚Šã€`flutterSecureStorage` ã«ãƒˆãƒ¼ã‚¯ãƒ³ãŒä¿å­˜ã•ã‚Œã€ã‚¢ãƒ—ãƒªå…¨ä½“ã§å†åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

2. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:
   ä¿å­˜æ“ä½œã«å¤±æ•—ã™ã‚‹å¯èƒ½æ€§ã‚‚è€ƒæ…®ã—ã€ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹ã‹é©åˆ‡ãªå¯¾å¿œã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### ä½¿ç”¨ä¾‹

ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ç™»éŒ²ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```dart
final verifyCodeNotifierProvider = 
    AutoDisposeAsyncNotifierProvider<VerifyCodeNotifier, AuthCredentials?>(
  VerifyCodeNotifier.new,
);

final accessTokenNotifierProvider =
    AsyncNotifierProvider<AccessTokenNotifier, String?>(
  AccessTokenNotifier.new,
);
```

ã“ã®å¤‰æ›´ã«ã‚ˆã‚Šã€èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å®‰å…¨ã«ä¿å­˜ã—ã€å¿…è¦ã«å¿œã˜ã¦å¾Œã§ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

---
