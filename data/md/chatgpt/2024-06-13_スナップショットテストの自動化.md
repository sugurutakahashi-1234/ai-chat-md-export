# スナップショットテストの自動化

日付: 2024-06-13

---

## 👤 ユーザー
*2024/6/13 20:28:03*

SnapshotTestType ごとにSnapshotConfig.previewTestだったり、SnapshotConfig.previewDeviceVariationTest などを呼び分けたい。

ちなみにstatic func previewTest(_ previews: (some SnapshotTestable).Type)のように定義されている。

一番最後の

@Suite struct DeviceInfoViewSnapshotTest {
    @Test @MainActor func previewTest() {
        SnapshotConfig.previewTest(DeviceInfoView_Previews.self)
    }

    /// デバイスバリエーションテストをしたい場合
    @Test @MainActor func previewDeviceVariationTest() {
        SnapshotConfig.previewDeviceVariationTest(DeviceInfoView_Previews.self)
    }

    /// 文字サイズのバリエーションテストをしたい場合
    @Test @MainActor func previewContentSizeVariationTest() {
        SnapshotConfig.previewContentSizeVariationTest(DeviceInfoView_Previews.self)
    }

    /// ダークモードでテストしたい場合
    @Test @MainActor func previewDarkModeTest() {
        SnapshotConfig.previewDarkModeTest(DeviceInfoView_Previews.self)
    }

    /// 多言語テストしたい場合
    @Test @MainActor func previewLanguageVariationTest() {
        SnapshotConfig.previewLanguageVariationTest(DeviceInfoView_Previews.self)
    }
    
    @Test(arguments: SnapshotTestType.allCases)
    @MainActor func previewSnapshotTest(snapshotTestType: SnapshotTestType) {
        // ここを考えてほしい。SnapshotTestTypeのextensionで定義しておけば良さそう？ 
   }
}

enum SnapshotTestType: CaseIterable {
    case `default`
    case deviceVariation
    case contentSizeVariation
    case darkMode
    case languageVariation
}

---

## 🤖 アシスタント
*2024/6/13 20:28:20*

`SnapshotTestType`の各ケースに対応するテストメソッドを呼び出すためには、`SnapshotTestType`のエクステンションでそれぞれのケースに対応するテストメソッドを定義すると良いでしょう。これにより、`previewSnapshotTest`メソッド内でスイッチ文を使用して適切なテストメソッドを呼び出すことができます。

以下にその実装例を示します：

```swift
import XCTest
import SwiftUI
import SnapshotTesting

// Assume that SnapshotTestable is a protocol and SnapshotConfig has the necessary methods.

enum SnapshotTestType: CaseIterable {
    case `default`
    case deviceVariation
    case contentSizeVariation
    case darkMode
    case languageVariation

    func runTest(previewType: (some SnapshotTestable).Type) {
        switch self {
        case .default:
            SnapshotConfig.previewTest(previewType)
        case .deviceVariation:
            SnapshotConfig.previewDeviceVariationTest(previewType)
        case .contentSizeVariation:
            SnapshotConfig.previewContentSizeVariationTest(previewType)
        case .darkMode:
            SnapshotConfig.previewDarkModeTest(previewType)
        case .languageVariation:
            SnapshotConfig.previewLanguageVariationTest(previewType)
        }
    }
}

@Suite struct DeviceInfoViewSnapshotTest {
    @Test @MainActor func previewTest() {
        SnapshotConfig.previewTest(DeviceInfoView_Previews.self)
    }

    @Test @MainActor func previewDeviceVariationTest() {
        SnapshotConfig.previewDeviceVariationTest(DeviceInfoView_Previews.self)
    }

    @Test @MainActor func previewContentSizeVariationTest() {
        SnapshotConfig.previewContentSizeVariationTest(DeviceInfoView_Previews.self)
    }

    @Test @MainActor func previewDarkModeTest() {
        SnapshotConfig.previewDarkModeTest(DeviceInfoView_Previews.self)
    }

    @Test @MainActor func previewLanguageVariationTest() {
        SnapshotConfig.previewLanguageVariationTest(DeviceInfoView_Previews.self)
    }
    
    @Test(arguments: SnapshotTestType.allCases)
    @MainActor func previewSnapshotTest(snapshotTestType: SnapshotTestType) {
        snapshotTestType.runTest(previewType: DeviceInfoView_Previews.self)
    }
}
```

この実装により、`previewSnapshotTest`メソッドは、`SnapshotTestType`の各ケースに応じて適切なスナップショットテストを呼び出すことができます。エクステンション内で`runTest`メソッドを定義することで、スイッチ文を使ってそれぞれのテストメソッドを呼び出すことができます。この方法で、テストの呼び出しを簡潔に保つことができます。

---

## 👤 ユーザー
*2024/6/13 20:36:50*

ほんとはこう言う引数があるので、どう対応したらいいのか？

@MainActor
    static func previewTest(_ previews: (some SnapshotTestable).Type, device: SnapshotConfig.DeviceType = .defaultDevice, shouldWait: Bool = false, file: StaticString = #filePath, line: Int = #line) {
        guard currentLanguage == "ja" else {
            return
        }
        // Combine などの処理がある場合は wait をいれないと期待値通りの View の状態にならない
        previews.snapshots.assertSnapshots(
            as: shouldWait ? .wait(for: 0.01, on: .image(precision: SnapshotConfig.precision, layout: .device(config: device.viewImageConfig))) : .image(precision: SnapshotConfig.precision, layout: .device(config: device.viewImageConfig)),
            named: nil,
            file: file,
            testName: "\(type(of: previews))".sliceToViewName,
            line: UInt(line)
        )
    }

    @MainActor
    static func previewDeviceVariationTest(_ previews: (some SnapshotTestable).Type, file: StaticString = #filePath, line: Int = #line) {
        guard currentLanguage == "ja" else {
            return
        }
        for device in SnapshotConfig.DeviceType.allCases {
            previews.snapshots.assertSnapshots(
                as: .image(precision: SnapshotConfig.precision, layout: .device(config: device.viewImageConfig)),
                named: "\(device.rawValue)",
                file: file,
                testName: "\(type(of: previews))".sliceToViewName + "-Device",
                line: UInt(line)
            )
        }
    }

    @MainActor
    static func previewContentSizeVariationTest(_ previews: (some SnapshotTestable).Type, device: SnapshotConfig.DeviceType = .defaultDevice, file: StaticString = #filePath, line: Int = #line) {
        guard currentLanguage == "ja" else {
            return
        }
        for contentSizeType in SnapshotConfig.ContentSizeType.allCases {
            previews.snapshots.assertSnapshots(
                as: .image(precision: SnapshotConfig.precision, layout: .device(config: device.viewImageConfig), traits: .init(preferredContentSizeCategory: contentSizeType.size)),
                named: "\(contentSizeType.rawValue)",
                file: file,
                testName: "\(type(of: previews))".sliceToViewName + "-ContentSize",
                line: UInt(line)
            )
        }
    }

    @MainActor
    static func previewDarkModeTest(_ previews: (some SnapshotTestable).Type, device: SnapshotConfig.DeviceType = .defaultDevice, file: StaticString = #filePath, line: Int = #line) {
        guard currentLanguage == "ja" else {
            return
        }
        for colorScheme in ColorScheme.allCases.filter({ $0 != .light }) {
            previews.snapshots.assertSnapshots(
                as: .image(precision: SnapshotConfig.precision, layout: .device(config: device.viewImageConfig), traits: .init(userInterfaceStyle: colorScheme.asUIUserInterfaceStyle)),
                named: "\("\(colorScheme)".initialUppercased)Mode",
                file: file,
                testName: "\(type(of: previews))".sliceToViewName + "-ColorThema",
                line: UInt(line)
            )
        }
    }

    @MainActor
    static func previewLanguageVariationTest(_ previews: (some SnapshotTestable).Type, device: SnapshotConfig.DeviceType = .defaultDevice, file: StaticString = #filePath, line: Int = #line) {
        guard currentLanguage != "ja" else {
            return
        }
        previews.snapshots.assertSnapshots(
            as: .image(precision: SnapshotConfig.precision, layout: .device(config: device.viewImageConfig)),
            named: currentLanguage,
            file: file,
            testName: "\(type(of: previews))".sliceToViewName + "-Language",
            line: UInt(line)
        )
    }

---

## 🤖 アシスタント
*2024/6/13 20:37:12*

`SnapshotTestType` の各ケースに対応するテストメソッドを引数付きで呼び出すには、エクステンション内でそれぞれのケースに対応する関数を定義し、`previewSnapshotTest` メソッド内でこれらの関数を呼び出すようにします。

以下はその実装例です：

```swift
import XCTest
import SwiftUI
import SnapshotTesting

enum SnapshotTestType: CaseIterable {
    case `default`
    case deviceVariation
    case contentSizeVariation
    case darkMode
    case languageVariation

    func runTest(previewType: (some SnapshotTestable).Type, device: SnapshotConfig.DeviceType = .defaultDevice, shouldWait: Bool = false, file: StaticString = #filePath, line: Int = #line) {
        switch self {
        case .default:
            SnapshotConfig.previewTest(previewType, device: device, shouldWait: shouldWait, file: file, line: line)
        case .deviceVariation:
            SnapshotConfig.previewDeviceVariationTest(previewType, file: file, line: line)
        case .contentSizeVariation:
            SnapshotConfig.previewContentSizeVariationTest(previewType, device: device, file: file, line: line)
        case .darkMode:
            SnapshotConfig.previewDarkModeTest(previewType, device: device, file: file, line: line)
        case .languageVariation:
            SnapshotConfig.previewLanguageVariationTest(previewType, device: device, file: file, line: line)
        }
    }
}

@Suite struct DeviceInfoViewSnapshotTest {
    @Test @MainActor func previewTest() {
        SnapshotConfig.previewTest(DeviceInfoView_Previews.self)
    }

    @Test @MainActor func previewDeviceVariationTest() {
        SnapshotConfig.previewDeviceVariationTest(DeviceInfoView_Previews.self)
    }

    @Test @MainActor func previewContentSizeVariationTest() {
        SnapshotConfig.previewContentSizeVariationTest(DeviceInfoView_Previews.self)
    }

    @Test @MainActor func previewDarkModeTest() {
        SnapshotConfig.previewDarkModeTest(DeviceInfoView_Previews.self)
    }

    @Test @MainActor func previewLanguageVariationTest() {
        SnapshotConfig.previewLanguageVariationTest(DeviceInfoView_Previews.self)
    }
    
    @Test(arguments: SnapshotTestType.allCases)
    @MainActor func previewSnapshotTest(snapshotTestType: SnapshotTestType) {
        snapshotTestType.runTest(previewType: DeviceInfoView_Previews.self)
    }
}
```

この実装では、`runTest` メソッド内で各ケースに対応するスナップショットテストメソッドを引数付きで呼び出しています。これにより、`previewSnapshotTest` メソッド内でスイッチ文を使わずに、`SnapshotTestType` の各ケースに対応するテストを実行できます。

必要に応じて、`runTest` メソッドに追加の引数を渡すことができます。例えば、`shouldWait` や `device` などの引数を `previewSnapshotTest` メソッド内で設定してから `runTest` メソッドに渡すことができます。

---
