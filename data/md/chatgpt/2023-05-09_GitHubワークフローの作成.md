# GitHubワークフローの作成

日付: 2023-05-09

---

## 👤 ユーザー
*2023/5/9 10:19:30*

以下の条件をみたす。GitHubワークフローを作って欲しいです。

- (1) notify_reviewers_on_successful_checks.yml という名前のファイル
- (2) Pull Requestを作成や変更した際に走るCIがすべて通過したことを条件に動く
- (3) 以下のようなメッセージをSlackのあるチャンネルにメッセージを送信する

```
@username1 @username2 レビューをお願いします。
PR の CI が通りました。

プルリクエストのタイトル
プルリクエストのURL

by @PRの作成の名前
```

- (4) username1 や username2 はそのPRのレビューワーであり、かつ、approve していない人である
- (5) Incoming Webhook を使用する
- (6) SLACK_WEBHOOK_URL という名前のリポジトリのシークレットを使う
- (7).github/github_to_slack_mapping.json というファイルに、GitHubユーザー名と対応するSlackユーザー名のマッピングを定義して、それを使って、メンションがうまくいくようにする

---

## 🤖 アシスタント
*2023/5/9 10:21:09*

以下のコードは、ご指定いただいた条件に基づいてGitHubワークフローを作成します。`.github/workflows/notify_reviewers_on_successful_checks.yml` という名前でファイルを保存してください。

```yaml
name: Notify Reviewers on Successful Checks

on:
  pull_request:
    types:
      - opened
      - synchronize
  check_suite:
    types:
      - completed

jobs:
  notify_reviewers:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'check_suite' && github.event.check_suite.conclusion == 'success' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Notify Reviewers on Slack
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        PR_URL="${{ github.event.pull_request.html_url }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_AUTHOR="${{ github.event.pull_request.user.login }}"
        PR_NUMBER="${{ github.event.pull_request.number }}"

        echo "Fetching requested reviewers..."
        reviewers=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews \
          | jq -r '.[] | select(.state=="PENDING") | .user.login')

        if [ -z "$reviewers" ]; then
          echo "No reviewers found."
          exit 0
        fi

        echo "Fetching slack usernames..."
        slack_usernames=""
        for reviewer in $reviewers
        do
          slack_username=$(jq -r --arg github_user "$reviewer" '.[$github_user]' .github/github_to_slack_mapping.json)
          if [ "$slack_username" != "null" ]; then
            slack_usernames="$slack_usernames @$slack_username"
          fi
        done

        if [ -z "$slack_usernames" ]; then
          echo "No slack usernames found."
          exit 0
        fi

        message="<!here> $slack_usernames レビューをお願いします。\nPR の CI が通りました。\n\n$PR_TITLE\n$PR_URL\n\nby @$PR_AUTHOR"

        echo "Sending message to slack..."
        curl -X POST -H 'Content-type: application/json' --data "{'text':'$message'}" $SLACK_WEBHOOK_URL
```

また、`.github/github_to_slack_mapping.json` というファイルに、GitHubユーザー名と対応するSlackユーザー名のマッピングを定義してください。例えば：

```json
{
  "github_username1": "slack_username1",
  "github_username2": "slack_username2",
  "github_username3": "slack_username3"
}
```

このワークフローは、Pull Requestが作成されたり変更されたりしたとき、またはすべてのCIが成功したときに実行されます。実行時に、プルリクエストに割り当てられていて、まだ承認されていないレビュアーのSlackユーザー名を取得し、メッセージを送信します。ただし、Slackユーザー名は、.github/github_to_slack_mapping.json

---

## 👤 ユーザー
*2023/5/9 10:21:15*

つづき

---

## 🤖 アシスタント
*2023/5/9 10:21:49*

ファイルで定義されたGitHubユーザー名と対応するSlackユーザー名のマッピングを使用しています。

このワークフローは、すべてのCIが成功したときにのみ実行されるようになっています。それ以外の場合、ワークフローは実行されません。また、リポジトリのシークレットである `SLACK_WEBHOOK_URL` を使用して、Incoming Webhookを利用してメッセージを送信しています。

これで、あなたの要件に合ったGitHubワークフローが完成しました。ワークフローが正常に動作するかどうかを確認するために、プルリクエストを作成または更新して、すべてのCIが成功した後に、レビュアーに通知が送信されるかどうかを確認してください。

もし何か問題があれば、お気軽にお知らせください。修正やサポートが必要な場合はお手伝いいたします。

---

## 👤 ユーザー
*2023/5/9 10:25:06*

だいたいOK。ちょっと条件を追加したけどそれで作って欲しい。

以下の条件をみたす。GitHubワークフローを作って欲しいです。

- (1) notify_reviewers_on_successful_checks.yml という名前のファイル
- (2) Pull Requestを作成や変更やreopenedした際に走るCIがすべて通過したことを条件に動く
- (3) 以下のようなメッセージをSlackのあるチャンネルにメッセージを送信する

```
@username1 @username2 レビューをお願いします。
PR の CI が通りました。

プルリクエストのタイトル
プルリクエストのURL

by @PRの作成の名前
```

- (4) username1 や username2 はそのPRのレビューワーであり、かつ、approve していない人である。対象者がいないこともあるので、その場合はメッセージは送信せずに、その旨をコンソールに出力する
- (5) Incoming Webhook を使用する
- (6) SLACK_WEBHOOK_URL という名前のリポジトリのシークレットを使う
- (7) .github/github_to_slack_mapping.json というファイルに、GitHubユーザー名と対応するSlackユーザー名のマッピングを定義して、それを使って、メンションがうまくいくようにする
- (8) 少量のコメントをつけてほしい

---

## 🤖 アシスタント
*2023/5/9 10:26:32*

条件を追加し、コメントを追加したワークフローファイルを以下に示します。`.github/workflows/notify_reviewers_on_successful_checks.yml` という名前でファイルを保存してください。

```yaml
name: Notify Reviewers on Successful Checks

# This workflow triggers on pull request events and check suite events.
on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
  check_suite:
    types:
      - completed

jobs:
  notify_reviewers:
    runs-on: ubuntu-latest
    # This job will run only if all checks have passed for the pull request.
    if: ${{ github.event_name == 'check_suite' && github.event.check_suite.conclusion == 'success' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Notify Reviewers on Slack
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        PR_URL="${{ github.event.pull_request.html_url }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_AUTHOR="${{ github.event.pull_request.user.login }}"
        PR_NUMBER="${{ github.event.pull_request.number }}"

        # Fetch the reviewers who have not yet approved the pull request.
        echo "Fetching requested reviewers..."
        reviewers=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews \
          | jq -r '.[] | select(.state=="PENDING") | .user.login')

        if [ -z "$reviewers" ]; then
          echo "No reviewers found or all reviewers have approved."
          exit 0
        fi

        # Map the GitHub usernames to their corresponding Slack usernames.
        echo "Fetching slack usernames..."
        slack_usernames=""
        for reviewer in $reviewers
        do
          slack_username=$(jq -r --arg github_user "$reviewer" '.[$github_user]' .github/github_to_slack_mapping.json)
          if [ "$slack_username" != "null" ]; then
            slack_usernames="$slack_usernames @$slack_username"
          fi
        done

        if [ -z "$slack_usernames" ]; then
          echo "No slack usernames found."
          exit 0
        fi

        # Prepare the message to be sent on Slack.
        message="<!here> $slack_usernames レビューをお願いします。\nPR の CI が通りました。\n\n$PR_TITLE\n$PR_URL\n\nby @$PR_AUTHOR"

        # Send the message to the Slack channel using Incoming Webhook.
        echo "Sending message to slack..."
        curl -X POST -H 'Content-type: application/json' --data "{'text':'$message'}" $SLACK_WEBHOOK_URL
```

この更新されたワークフローは、プルリクエストが作成、変更、または再オープンされたときにトリガーされるようになりました。また、指定された条件に基づいてレビュアーを取得し、対象者がいない場合はメッセージを送信せず、その旨をコンソールに出力します。

上記のワークフローを使用して、要件が満たされるかどうかを確

---

## 👤 ユーザー
*2023/5/9 10:26:44*

つづき

---

## 🤖 アシスタント
*2023/5/9 10:27:00*

認してください。プルリクエストを作成、更新、または再オープンし、すべてのCIが成功した後に、承認されていないレビュアーに通知が送信されるかどうかを確認してください。

問題が発生した場合や、さらなるカスタマイズが必要な場合は、お気軽にお知らせください。必要に応じて修正やサポートを提供いたします。

---

## 👤 ユーザー
*2023/5/9 10:30:32*

もう少し、条件を変えてみた

以下の条件をみたす。GitHubワークフローを作って欲しいです。

- (1) notify_reviewers_on_successful_checks.yml という名前のファイル
- (2) Pull Requestを作成や変更やreopenedした際に走るCIがすべて通過したことを条件に動く
- (3) 以下のようなメッセージをSlackのあるチャンネルにメッセージを送信する

```
@username1 @username2 レビューをお願いします。
PR の CI が通りました。

プルリクエストのタイトル
プルリクエストのURL

by @PRの作成の名前
```

- (4) username1 や username2 はそのPRのレビューワーであり、かつ、APPROVED ではない人が対象である。対象者がいないこともあるので、その場合はメッセージは送信せずに、その旨をコンソールに出力する
- (5) Incoming Webhook を使用する
- (6) SLACK_WEBHOOK_URL という名前のリポジトリのシークレットを使う
- (7) .github/github_to_slack_mapping.json というファイルに、GitHubユーザー名と対応するSlackユーザー名のマッピングを定義して、それを使って、メンションがうまくいくようにする
- (8) 少量のコメントをつけてほしい
- (9) 内部で宣言する変数は大文字に統一してほしい

---

## 🤖 アシスタント
*2023/5/9 10:31:55*

条件を変更し、内部で宣言する変数を大文字に統一したワークフローファイルを以下に示します。`.github/workflows/notify_reviewers_on_successful_checks.yml` という名前でファイルを保存してください。

```yaml
name: Notify Reviewers on Successful Checks

# This workflow triggers on pull request events and check suite events.
on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
  check_suite:
    types:
      - completed

jobs:
  notify_reviewers:
    runs-on: ubuntu-latest
    # This job will run only if all checks have passed for the pull request.
    if: ${{ github.event_name == 'check_suite' && github.event.check_suite.conclusion == 'success' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Notify Reviewers on Slack
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        PR_URL="${{ github.event.pull_request.html_url }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_AUTHOR="${{ github.event.pull_request.user.login }}"
        PR_NUMBER="${{ github.event.pull_request.number }}"

        # Fetch the reviewers who have not yet approved the pull request.
        echo "Fetching requested reviewers..."
        REVIEWERS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews \
          | jq -r '.[] | select(.state!="APPROVED") | .user.login')

        if [ -z "$REVIEWERS" ]; then
          echo "No reviewers found or all reviewers have approved."
          exit 0
        fi

        # Map the GitHub usernames to their corresponding Slack usernames.
        echo "Fetching slack usernames..."
        SLACK_USERNAMES=""
        for REVIEWER in $REVIEWERS
        do
          SLACK_USERNAME=$(jq -r --arg github_user "$REVIEWER" '.[$github_user]' .github/github_to_slack_mapping.json)
          if [ "$SLACK_USERNAME" != "null" ]; then
            SLACK_USERNAMES="$SLACK_USERNAMES @$SLACK_USERNAME"
          fi
        done

        if [ -z "$SLACK_USERNAMES" ]; then
          echo "No slack usernames found."
          exit 0
        fi

        # Prepare the message to be sent on Slack.
        MESSAGE="<!here> $SLACK_USERNAMES レビューをお願いします。\nPR の CI が通りました。\n\n$PR_TITLE\n$PR_URL\n\nby @$PR_AUTHOR"

        # Send the message to the Slack channel using Incoming Webhook.
        echo "Sending message to slack..."
        curl -X POST -H 'Content-type: application/json' --data "{'text':'$MESSAGE'}" $SLACK_WEBHOOK_URL
```

この更新されたワークフローは、プルリクエストが作成、変更、または再オープンされたときにトリガーされるようになりました。また、指定された条件に基づいてレビュアーを取得し、対象者がいない場合はメッセージを送信せず、その旨をコンソールに出力

---

## 👤 ユーザー
*2023/5/9 10:32:02*

つづき

---

## 🤖 アシスタント
*2023/5/9 10:32:20*

します。

上記のワークフローを使用して、要件が満たされるかどうかを確認してください。プルリクエストを作成、更新、または再オープンし、すべてのCIが成功した後に、承認されていないレビュアーに通知が送信されるかどうかを確認してください。

問題が発生した場合や、さらなるカスタマイズが必要な場合は、お気軽にお知らせください。必要に応じて修正やサポートを提供いたします。

---

## 👤 ユーザー
*2023/5/9 10:32:59*

メッセージの例を教えて

---

## 🤖 アシスタント
*2023/5/9 10:33:25*

以下は、Slackに送信される通知メッセージの例です。

```
@john_doe @jane_doe レビューをお願いします。
PR の CI が通りました。

プルリクエストのタイトル: Implement new feature XYZ
プルリクエストのURL: https://github.com/your_repository/your_project/pull/123

by @pr_author
```

この例では、GitHubのユーザー名 `john_doe` と `jane_doe` がメンションされており、プルリクエストのタイトルが「Implement new feature XYZ」で、プルリクエストのURLが「https://github.com/your_repository/your_project/pull/123」となっています。また、このメッセージは、プルリクエストの作成者である `pr_author` によって送信されています。

---

## 👤 ユーザー
*2023/5/9 10:33:49*

&lt;!here&gt;  の意味を教えて

---

## 🤖 アシスタント
*2023/5/9 10:34:23*

Slackの `&lt;!here&gt;` は、特殊なメンションのひとつで、メッセージが投稿されたチャンネル内のオンライン（アクティブ）なメンバー全員に通知を送るために使用されます。このメンションを使用すると、チャンネル内のアクティブなメンバーがメッセージに気付く可能性が高まります。

ただし、このメンションは、特定の人に向けたメッセージではなく、チャンネル内のアクティブなメンバー全員に対して通知が送信されるため、適切な状況で使用することが重要です。過度に使用すると、チャンネルのメンバーが通知を無視するようになったり、メッセージに対する反応が鈍くなる可能性があります。

---

## 👤 ユーザー
*2023/5/9 10:34:49*

ymlファイルのメッセージを作成するところに&lt;!here&gt;があるんだけど、それはなくしてほしい

---

## 🤖 アシスタント
*2023/5/9 10:36:10*

了解しました。`<!here>`を削除したワークフローファイルを以下に示します。`.github/workflows/notify_reviewers_on_successful_checks.yml` という名前でファイルを保存してください。

```yaml
name: Notify Reviewers on Successful Checks

# This workflow triggers on pull request events and check suite events.
on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
  check_suite:
    types:
      - completed

jobs:
  notify_reviewers:
    runs-on: ubuntu-latest
    # This job will run only if all checks have passed for the pull request.
    if: ${{ github.event_name == 'check_suite' && github.event.check_suite.conclusion == 'success' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Notify Reviewers on Slack
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        PR_URL="${{ github.event.pull_request.html_url }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_AUTHOR="${{ github.event.pull_request.user.login }}"
        PR_NUMBER="${{ github.event.pull_request.number }}"

        # Fetch the reviewers who have not yet approved the pull request.
        echo "Fetching requested reviewers..."
        REVIEWERS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews \
          | jq -r '.[] | select(.state!="APPROVED") | .user.login')

        if [ -z "$REVIEWERS" ]; then
          echo "No reviewers found or all reviewers have approved."
          exit 0
        fi

        # Map the GitHub usernames to their corresponding Slack usernames.
        echo "Fetching slack usernames..."
        SLACK_USERNAMES=""
        for REVIEWER in $REVIEWERS
        do
          SLACK_USERNAME=$(jq -r --arg github_user "$REVIEWER" '.[$github_user]' .github/github_to_slack_mapping.json)
          if [ "$SLACK_USERNAME" != "null" ]; then
            SLACK_USERNAMES="$SLACK_USERNAMES @$SLACK_USERNAME"
          fi
        done

        if [ -z "$SLACK_USERNAMES" ]; then
          echo "No slack usernames found."
          exit 0
        fi

        # Prepare the message to be sent on Slack.
        MESSAGE="$SLACK_USERNAMES レビューをお願いします。\nPR の CI が通りました。\n\n$PR_TITLE\n$PR_URL\n\nby @$PR_AUTHOR"

        # Send the message to the Slack channel using Incoming Webhook.
        echo "Sending message to slack..."
        curl -X POST -H 'Content-type: application/json' --data "{'text':'$MESSAGE'}" $SLACK_WEBHOOK_URL
```

この更新されたワークフローでは、`<!here>`がメッセージから削除され、レビュアーに向けた通知が送信されます。

---

## 👤 ユーザー
*2023/5/9 10:38:33*

別の以下の条件をみたす。GitHubワークフローを作って欲しいです。

- (1) notify_reviewers_on_assign.yml という名前のファイル
- (2) レビューワーをアサインした際に、PRのCIがすべて通過していた場合にのみ動く
- (3) 以下のようなメッセージをSlackのあるチャンネルにメッセージを送信する

```
@username1 @username2 レビューをお願いします。
PR の CI が通りました。

プルリクエストのタイトル
プルリクエストのURL

by @PRの作成の名前
```

- (4) username1 や username2 はそのPRのレビューワーであり、かつ、APPROVED ではない人が対象である。対象者がいないこともあるので、その場合はメッセージは送信せずに、その旨をコンソールに出力する
- (5) Incoming Webhook を使用する
- (6) SLACK_WEBHOOK_URL という名前のリポジトリのシークレットを使う
- (7) .github/github_to_slack_mapping.json というファイルに、GitHubユーザー名と対応するSlackユーザー名のマッピングを定義して、それを使って、メンションがうまくいくようにする
- (8) 少量のコメントをつけてほしい
- (9) 内部で宣言する変数は大文字に統一してほしい

---

## 🤖 アシスタント
*2023/5/9 10:40:07*

要件に基づいて新しいワークフローファイル `notify_reviewers_on_assign.yml` を作成しました。以下の内容をご確認ください。

```yaml
name: Notify Reviewers on Assign

on:
  pull_request_review:
    types:
      - requested

jobs:
  notify_reviewers:
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.mergeable_state == 'clean' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Notify Reviewers on Slack
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        PR_URL="${{ github.event.pull_request.html_url }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_AUTHOR="${{ github.event.pull_request.user.login }}"
        PR_NUMBER="${{ github.event.pull_request.number }}"

        # Fetch the reviewers who have not yet approved the pull request.
        echo "Fetching requested reviewers..."
        REVIEWERS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews \
          | jq -r '.[] | select(.state!="APPROVED") | .user.login')

        if [ -z "$REVIEWERS" ]; then
          echo "No reviewers found or all reviewers have approved."
          exit 0
        fi

        # Map the GitHub usernames to their corresponding Slack usernames.
        echo "Fetching slack usernames..."
        SLACK_USERNAMES=""
        for REVIEWER in $REVIEWERS
        do
          SLACK_USERNAME=$(jq -r --arg github_user "$REVIEWER" '.[$github_user]' .github/github_to_slack_mapping.json)
          if [ "$SLACK_USERNAME" != "null" ]; then
            SLACK_USERNAMES="$SLACK_USERNAMES @$SLACK_USERNAME"
          fi
        done

        if [ -z "$SLACK_USERNAMES" ]; then
          echo "No slack usernames found."
          exit 0
        fi

        # Prepare the message to be sent on Slack.
        MESSAGE="$SLACK_USERNAMES レビューをお願いします。\nPR の CI が通りました。\n\n$PR_TITLE\n$PR_URL\n\nby @$PR_AUTHOR"

        # Send the message to the Slack channel using Incoming Webhook.
        echo "Sending message to slack..."
        curl -X POST -H 'Content-type: application/json' --data "{'text':'$MESSAGE'}" $SLACK_WEBHOOK_URL
```

このワークフローファイルでは、レビュアーがアサインされたときにトリガーされ、プルリクエストのCIがすべて通過している場合にのみ実行されます。指定された条件に従って、承認されていないレビュアーに通知が送信されます。

`.github/workflows` ディレクトリに `notify_reviewers_on_assign.yml` という名前でこのファイルを保存してください。これで、要件に従ったGitHubワークフローが作成されました。

---

## 👤 ユーザー
*2023/5/9 10:41:00*

${{ github.event.pull_request.mergeable_state == 'clean' }} はどういう意味

---

## 🤖 アシスタント
*2023/5/9 10:41:37*

`${{ github.event.pull_request.mergeable_state == 'clean' }}` は、GitHub Actionsワークフローの条件式で、プルリクエスト (PR) のマージ可能状態が「clean」であるかどうかをチェックしています。

`mergeable_state` は、プルリクエストのマージの可否に関する情報を提供するプロパティで、GitHub APIから取得できます。`clean` は、PRがマージ可能であり、PRに関連するすべてのステータスチェック (CIなど) が成功した状態を表します。

したがって、`${{ github.event.pull_request.mergeable_state == 'clean' }}` は、プルリクエストがマージ可能であり、関連するすべてのステータスチェックが成功している場合にのみ、条件が満たされることを意味します。この条件が `true` である場合にのみ、ワークフロー内のジョブが実行されます。

---

## 👤 ユーザー
*2023/5/9 10:42:21*

すべてのステータスチェックが成功している場合にのみを表すようにへんこうしてほしいんだけどできる？CIだけはなく他の条件でマージ可能にしていないこともあるので

---

## 🤖 アシスタント
*2023/5/9 10:42:53*

すべてのステータスチェックが成功している場合にのみ実行されるように、条件式を変更しました。GitHub Actionsの `check_suite` イベントを利用して、すべてのチェックが成功したかどうかを判定することができます。

```yaml
name: Notify Reviewers on Assign

on:
  pull_request_review:
    types:
      - requested
  check_suite:
    types:
      - completed

jobs:
  notify_reviewers:
    runs-on: ubuntu-latest
    if: ${{ github.event.check_suite.conclusion == 'success' }}

    steps:
    # 以下のステップは同じままです。
    ...
```

上記の変更では、`on` セクションに `check_suite` イベントが追加されており、チェックスイートが完了したときにトリガーされます。その後、`if` 条件式で `github.event.check_suite.conclusion` が `success` であるかどうかを確認しています。これにより、すべてのステータスチェックが成功している場合にのみ、ジョブが実行されます。

---

## 👤 ユーザー
*2023/5/9 10:43:00*

全文かいていほしい

---

## 🤖 アシスタント
*2023/5/9 10:44:22*

要件に基づいて、すべてのステータスチェックが成功している場合にのみ実行されるように条件を変更したワークフローファイル `notify_reviewers_on_assign.yml` を作成しました。以下の内容をご確認ください。

```yaml
name: Notify Reviewers on Assign

on:
  pull_request_review:
    types:
      - requested
  check_suite:
    types:
      - completed

jobs:
  notify_reviewers:
    runs-on: ubuntu-latest
    if: ${{ github.event.check_suite.conclusion == 'success' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Notify Reviewers on Slack
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        PR_URL="${{ github.event.pull_request.html_url }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_AUTHOR="${{ github.event.pull_request.user.login }}"
        PR_NUMBER="${{ github.event.pull_request.number }}"

        # Fetch the reviewers who have not yet approved the pull request.
        echo "Fetching requested reviewers..."
        REVIEWERS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews \
          | jq -r '.[] | select(.state!="APPROVED") | .user.login')

        if [ -z "$REVIEWERS" ]; then
          echo "No reviewers found or all reviewers have approved."
          exit 0
        fi

        # Map the GitHub usernames to their corresponding Slack usernames.
        echo "Fetching slack usernames..."
        SLACK_USERNAMES=""
        for REVIEWER in $REVIEWERS
        do
          SLACK_USERNAME=$(jq -r --arg github_user "$REVIEWER" '.[$github_user]' .github/github_to_slack_mapping.json)
          if [ "$SLACK_USERNAME" != "null" ]; then
            SLACK_USERNAMES="$SLACK_USERNAMES @$SLACK_USERNAME"
          fi
        done

        if [ -z "$SLACK_USERNAMES" ]; then
          echo "No slack usernames found."
          exit 0
        fi

        # Prepare the message to be sent on Slack.
        MESSAGE="$SLACK_USERNAMES レビューをお願いします。\nPR の CI が通りました。\n\n$PR_TITLE\n$PR_URL\n\nby @$PR_AUTHOR"

        # Send the message to the Slack channel using Incoming Webhook.
        echo "Sending message to slack..."
        curl -X POST -H 'Content-type: application/json' --data "{'text':'$MESSAGE'}" $SLACK_WEBHOOK_URL
```

`.github/workflows` ディレクトリに `notify_reviewers_on_assign.yml` という名前でこのファイルを保存してください。これで、要件に従ったGitHubワークフローが作成されました。

---

## 👤 ユーザー
*2023/5/9 10:45:55*

以下のほうがただしくない？

on:
  pull_request:
    types:
      - review_requested

---

## 🤖 アシスタント
*2023/5/9 10:46:32*

おっしゃる通り、`review_requested` イベントを使うことで、レビュワーがアサインされたときにワークフローをトリガーすることができます。以下が修正したワークフローファイルです。

```yaml
name: Notify Reviewers on Assign

on:
  pull_request:
    types:
      - review_requested
  check_suite:
    types:
      - completed

jobs:
  notify_reviewers:
    runs-on: ubuntu-latest
    if: ${{ github.event.check_suite.conclusion == 'success' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Notify Reviewers on Slack
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        PR_URL="${{ github.event.pull_request.html_url }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_AUTHOR="${{ github.event.pull_request.user.login }}"
        PR_NUMBER="${{ github.event.pull_request.number }}"

        # 以下のステップは同じままです。
        ...
```

`on` セクションで `pull_request` イベントに `review_requested` タイプを指定することで、レビュワーがアサインされたときにワークフローがトリガーされます。これで、より正確なGitHubワークフローが作成されました。

---

## 👤 ユーザー
*2023/5/9 10:46:52*

全文書いて欲しい

---

## 🤖 アシスタント
*2023/5/9 10:48:17*

すみません、以下が修正した全文のワークフローファイル `notify_reviewers_on_assign.yml` です。

```yaml
name: Notify Reviewers on Assign

on:
  pull_request:
    types:
      - review_requested
  check_suite:
    types:
      - completed

jobs:
  notify_reviewers:
    runs-on: ubuntu-latest
    if: ${{ github.event.check_suite.conclusion == 'success' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Notify Reviewers on Slack
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        PR_URL="${{ github.event.pull_request.html_url }}"
        PR_TITLE="${{ github.event.pull_request.title }}"
        PR_AUTHOR="${{ github.event.pull_request.user.login }}"
        PR_NUMBER="${{ github.event.pull_request.number }}"

        # Fetch the reviewers who have not yet approved the pull request.
        echo "Fetching requested reviewers..."
        REVIEWERS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews \
          | jq -r '.[] | select(.state!="APPROVED") | .user.login')

        if [ -z "$REVIEWERS" ]; then
          echo "No reviewers found or all reviewers have approved."
          exit 0
        fi

        # Map the GitHub usernames to their corresponding Slack usernames.
        echo "Fetching slack usernames..."
        SLACK_USERNAMES=""
        for REVIEWER in $REVIEWERS
        do
          SLACK_USERNAME=$(jq -r --arg github_user "$REVIEWER" '.[$github_user]' .github/github_to_slack_mapping.json)
          if [ "$SLACK_USERNAME" != "null" ]; then
            SLACK_USERNAMES="$SLACK_USERNAMES @$SLACK_USERNAME"
          fi
        done

        if [ -z "$SLACK_USERNAMES" ]; then
          echo "No slack usernames found."
          exit 0
        fi

        # Prepare the message to be sent on Slack.
        MESSAGE="$SLACK_USERNAMES レビューをお願いします。\nPR の CI が通りました。\n\n$PR_TITLE\n$PR_URL\n\nby @$PR_AUTHOR"

        # Send the message to the Slack channel using Incoming Webhook.
        echo "Sending message to slack..."
        curl -X POST -H 'Content-type: application/json' --data "{'text':'$MESSAGE'}" $SLACK_WEBHOOK_URL
```

これで、レビュワーがアサインされたときにワークフローがトリガーされるようになりました。`.github/workflows` ディレクトリに `notify_reviewers_on_assign.yml` という名前でこのファイルを保存してください。

---

## 👤 ユーザー
*2023/5/9 10:56:30*

notify_reviewers_on_successful_checks.yml を試してみたんだけど、すぐにこのワークフローが動いて、スキップしてしまったんだ。どうにか修正する方法を教えて欲しい

---

## 🤖 アシスタント
*2023/5/9 10:57:22*

`notify_reviewers_on_successful_checks.yml` ワークフローがすぐに実行されてしまうのは、`check_suite`イベントが完了するとすぐにトリガーされるからです。`check_suite`イベントは、他のワークフローやステータスチェックが完了するたびに発生します。

ワークフローがすぐに実行されないようにするためには、`check_suite`イベントがプルリクエストに関連していることを確認し、その後ステータスチェックが成功しているかどうかを確認する必要があります。以下の修正を `notify_reviewers_on_successful_checks.yml` に適用してください：

```yaml
name: Notify Reviewers on Successful Checks

on:
  check_suite:
    types:
      - completed

jobs:
  notify_reviewers:
    runs-on: ubuntu-latest
    if: ${{ github.event.check_suite.pull_requests && github.event.check_suite.conclusion == 'success' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    # 以降のステップは変更なし
    ...
```

`if` 条件に `github.event.check_suite.pull_requests` を追加しました。これにより、`check_suite` イベントがプルリクエストに関連している場合にのみ、ワークフローが実行されます。それ以外の場合、ワークフローはスキップされます。

この修正で、`notify_reviewers_on_successful_checks.yml` ワークフローは、プルリクエストに関連するステータスチェックが成功した場合にのみ実行されるようになります。

---

## 👤 ユーザー
*2023/5/9 10:57:31*

全文表示してほしい

---

## 🤖 アシスタント
*2023/5/9 10:58:49*

すみません、以下が修正した全文のワークフローファイル `notify_reviewers_on_successful_checks.yml` です。

```yaml
name: Notify Reviewers on Successful Checks

on:
  check_suite:
    types:
      - completed

jobs:
  notify_reviewers:
    runs-on: ubuntu-latest
    if: ${{ github.event.check_suite.pull_requests && github.event.check_suite.conclusion == 'success' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Notify Reviewers on Slack
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        PR_URL="${{ github.event.check_suite.pull_requests[0].html_url }}"
        PR_TITLE="${{ github.event.check_suite.pull_requests[0].title }}"
        PR_AUTHOR="${{ github.event.check_suite.pull_requests[0].user.login }}"
        PR_NUMBER="${{ github.event.check_suite.pull_requests[0].number }}"

        echo "Fetching requested reviewers..."
        REVIEWERS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews \
          | jq -r '.[] | select(.state!="APPROVED") | .user.login')

        if [ -z "$REVIEWERS" ]; then
          echo "No reviewers found or all reviewers have approved."
          exit 0
        fi

        echo "Fetching slack usernames..."
        SLACK_USERNAMES=""
        for REVIEWER in $REVIEWERS
        do
          SLACK_USERNAME=$(jq -r --arg github_user "$REVIEWER" '.[$github_user]' .github/github_to_slack_mapping.json)
          if [ "$SLACK_USERNAME" != "null" ]; then
            SLACK_USERNAMES="$SLACK_USERNAMES @$SLACK_USERNAME"
          fi
        done

        if [ -z "$SLACK_USERNAMES" ]; then
          echo "No slack usernames found."
          exit 0
        fi

        MESSAGE="$SLACK_USERNAMES レビューをお願いします。\nPR の CI が通りました。\n\n$PR_TITLE\n$PR_URL\n\nby @$PR_AUTHOR"

        echo "Sending message to slack..."
        curl -X POST -H 'Content-type: application/json' --data "{'text':'$MESSAGE'}" $SLACK_WEBHOOK_URL
```

これで、`check_suite` イベントがプルリクエストに関連している場合にのみ、ワークフローが実行されるようになります。それ以外の場合、ワークフローはスキップされます。

この修正で、`notify_reviewers_on_successful_checks.yml` ワークフローは、プルリクエストに関連するステータスチェックが成功した場合にのみ実行されるようになります。`.github/workflows` ディレクトリに `notify_reviewers_on_successful_checks.yml` という名前でこのファイルを保存してください。

---

## 👤 ユーザー
*2023/5/9 10:59:08*

どうして、github.event.check_suite.pull_requests[0] のようなアクセスになったの？

---

## 🤖 アシスタント
*2023/5/9 10:59:32*

`github.event.check_suite.pull_requests` は、GitHub Actions の `check_suite` イベントに関連するプルリクエストの情報を含む配列です。この配列は、イベントが複数のプルリクエストに関連する場合、複数の要素を持つことがあります。

ただし、実際にはほとんどの場合、`check_suite` イベントは1つのプルリクエストに対してのみトリガーされるため、この配列には1つの要素しか含まれていないことが一般的です。そのため、`github.event.check_suite.pull_requests[0]` を使用して、イベントに関連する最初のプルリクエストの情報にアクセスします。この方法で、関連するプルリクエストのタイトル、URL、作者などの情報を取得することができます。

---

## 👤 ユーザー
*2023/5/9 10:59:45*

なるほど、あと少しコメントをつけてほしい＼

---

## 🤖 アシスタント
*2023/5/9 11:01:06*

もちろんです。以下がコメントを追加した `notify_reviewers_on_successful_checks.yml` の全文です。

```yaml
name: Notify Reviewers on Successful Checks

on:
  check_suite:
    types:
      - completed

jobs:
  notify_reviewers:
    runs-on: ubuntu-latest
    # Execute the job only if the check_suite event is related to a pull request and all checks are successful
    if: ${{ github.event.check_suite.pull_requests && github.event.check_suite.conclusion == 'success' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Notify Reviewers on Slack
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        # Get pull request information from the check_suite event
        PR_URL="${{ github.event.check_suite.pull_requests[0].html_url }}"
        PR_TITLE="${{ github.event.check_suite.pull_requests[0].title }}"
        PR_AUTHOR="${{ github.event.check_suite.pull_requests[0].user.login }}"
        PR_NUMBER="${{ github.event.check_suite.pull_requests[0].number }}"

        # Fetch the requested reviewers who have not yet approved the pull request
        echo "Fetching requested reviewers..."
        REVIEWERS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews \
          | jq -r '.[] | select(.state!="APPROVED") | .user.login')

        # Exit early if there are no reviewers or all reviewers have approved
        if [ -z "$REVIEWERS" ]; then
          echo "No reviewers found or all reviewers have approved."
          exit 0
        fi

        # Fetch the Slack usernames for the GitHub reviewers using the mapping file
        echo "Fetching slack usernames..."
        SLACK_USERNAMES=""
        for REVIEWER in $REVIEWERS
        do
          SLACK_USERNAME=$(jq -r --arg github_user "$REVIEWER" '.[$github_user]' .github/github_to_slack_mapping.json)
          if [ "$SLACK_USERNAME" != "null" ]; then
            SLACK_USERNAMES="$SLACK_USERNAMES @$SLACK_USERNAME"
          fi
        done

        # Exit early if there are no corresponding Slack usernames
        if [ -z "$SLACK_USERNAMES" ]; then
          echo "No slack usernames found."
          exit 0
        fi

        # Create the message to be sent to Slack
        MESSAGE="$SLACK_USERNAMES レビューをお願いします。\nPR の CI が通りました。\n\n$PR_TITLE\n$PR_URL\n\nby @$PR_AUTHOR"

        # Send the message to Slack
        echo "Sending message to slack..."
        curl -X POST -H 'Content-type: application/json' --data "{'text':'$MESSAGE'}" $SLACK_WEBHOOK_URL
```

コメントは、各セクションの目的を説明し、コードが何をしているかを理解しやすくするために追加されています。この修正されたファイルを `.github/workflows` ディレクトリに `notify_reviewers_on_successful_checks.yml` という名前で保存してください。

---

## 👤 ユーザー
*2023/5/9 11:08:13*

if: ${{ github.event.check_suite.pull_requests && github.event.check_suite.conclusion == 'success' }} で条件が動かないみたいなんだけどなんでだと思う？

---

## 🤖 アシスタント
*2023/5/9 11:08:32*

すみません、正しく動作しない条件を提供してしまいました。`github.event.check_suite.pull_requests` が空でないことを確認するために、配列の長さをチェックするように条件を修正します。

以下のように `if` 条件を変更してみてください：

```yaml
if: ${{ github.event.check_suite.conclusion == 'success' && github.event.check_suite.pull_requests != '[]' }}
```

これで、`check_suite` イベントがプルリクエストに関連し、すべてのチェックが成功している場合にのみジョブが実行されるはずです。

---

## 👤 ユーザー
*2023/5/9 11:13:06*

if: ${{ github.event.check_suite.conclusion == 'success' && github.event.check_suite.pull_requests != '[]' }} でも動かないんだけどなんでかな？

---

## 🤖 アシスタント
*2023/5/9 11:13:31*

すみません、条件が正しく動作しない理由がわかりました。GitHub Actions の条件式では、`!=` 演算子は文字列と配列の比較には適切に機能しないようです。

その代わり、配列の長さをチェックするために `fromJson()` 関数を使用して、条件を次のように変更してください：

```yaml
if: ${{ github.event.check_suite.conclusion == 'success' && fromJson(github.event.check_suite.pull_requests).length > 0 }}
```

この修正により、`github.event.check_suite.pull_requests` 配列の長さが 0 より大きい場合、つまりプルリクエストが存在する場合にのみジョブが実行されるはずです。

---

## 👤 ユーザー
*2023/5/9 11:14:04*

もっとスマートな書き方ないですか？

---

## 🤖 アシスタント
*2023/5/9 11:14:23*

GitHub Actions の条件式では、`fromJson()` 関数を使用せずに、以下のように `!=` 演算子を使って直接比較することができます。

```yaml
if: ${{ github.event.check_suite.conclusion == 'success' && github.event.check_suite.pull_requests[0] }}
```

この条件式では、`github.event.check_suite.pull_requests[0]` が存在する場合、つまり `pull_requests` 配列に少なくとも1つの要素がある場合にジョブが実行されます。これは前回提案した方法よりも簡潔で理解しやすいです。

---

## 👤 ユーザー
*2023/5/9 11:14:59*

github.event.check_suite.pull_requests[0] に何か値があれば true ってこと

---

## 🤖 アシスタント
*2023/5/9 11:15:13*

はい、その通りです。`github.event.check_suite.pull_requests[0]` に何か値がある場合、その値は `null` 以外であり、条件式は `true` になります。つまり、`github.event.check_suite.pull_requests` 配列に少なくとも1つの要素が含まれている場合にジョブが実行されることになります。

---

## 👤 ユーザー
*2023/5/9 11:16:06*

もしかしてgithub.event.check_suite.pull_requests[0]がなかったらクラッシュしたりしないよね

---

## 🤖 アシスタント
*2023/5/9 11:16:21*

ご心配いりません。`github.event.check_suite.pull_requests[0]` が存在しない場合、条件式は `null` を返し、その結果 `false` と評価されます。GitHub Actions の条件式では、配列のインデックスが範囲外の場合でもクラッシュしません。条件式は単に `false` と評価されるだけで、ジョブは実行されません。

---

## 👤 ユーザー
*2023/5/9 13:29:03*

この書き方だとどのような場合にワークフローが動くのか詳しく教えて欲しい。

```
on:
  pull_request:
    types:
      - opened
      - synchronize
  check_suite:
    types:
      - completed
```

---

## 🤖 アシスタント
*2023/5/9 13:30:05*

この設定では、ワークフローが以下の場合にトリガーされます。

1. `pull_request` イベントで、そのタイプが `opened` または `synchronize` の場合：
    - `opened`：プルリクエストが新しく作成されたとき
    - `synchronize`：プルリクエストに新しいコミットがプッシュされたとき、またはプルリクエストのブランチが変更されたとき
    この場合、プルリクエストが開かれたり、更新されたりしたときにワークフローが実行されます。

2. `check_suite` イベントで、そのタイプが `completed` の場合：
    - `completed`：チェックスイート（リポジトリ内のすべてのチェックラン）が完了したとき
    この場合、プルリクエストに関連するチェックスイートが完了したときにワークフローが実行されます。

この設定を使用すると、プルリクエストが開かれたり更新されたりしたとき、およびチェックスイートが完了したときにワークフローがトリガーされます。ただし、ワークフローのジョブで条件式を追加して、特定の条件が満たされた場合にのみジョブが実行されるように制御することができます。

---

## 👤 ユーザー
*2023/5/9 13:30:25*

チェックスイート（リポジトリ内のすべてのチェックラン）が完了したとき について、もっと具体的に押して欲しい、

---

## 🤖 アシスタント
*2023/5/9 13:32:49*

チェックスイートは、リポジトリ内のコードに対して実行される一連のチェックラン（テスト、静的解析、ビルド、その他の検証手順）の集合です。GitHub Actions を使用している場合、チェックスイートはワークフロー内の各ジョブに対応します。

`check_suite` イベントの `completed` タイプは、リポジトリ内のすべてのチェックラン（GitHub Actions の各ジョブ）が終了し、その結果が利用可能になったときにトリガーされます。

具体的には、以下のような状況で `completed` タイプのイベントが発生します。

1. プルリクエストに関連するすべてのジョブが完了し、その結果が利用可能になった場合
2. プッシュされたコミットに関連するすべてのジョブが完了し、その結果が利用可能になった場合

このイベントがトリガーされると、ワークフローが実行されますが、ジョブの実行条件を追加することで、特定の状況下でのみジョブが実行されるように制御できます。例えば、すべてのチェックランが成功した場合にのみジョブを実行するように指定できます。

---

## 👤 ユーザー
*2023/5/9 13:33:06*

すべてのチェックランが成功した場合にのみジョブを実行するように指定する方法をおしえてほしい

---

## 🤖 アシスタント
*2023/5/9 13:33:57*

すべてのチェックランが成功した場合にのみジョブを実行するように指定するには、`if` ステートメントを使用してジョブの実行条件を設定します。具体的には、`github.event.check_suite.conclusion` の値が `success` であることを確認します。

以下は、この条件を使用してジョブを実行するように指定した例です。

```yaml
name: Notify reviewers on successful checks

on:
  check_suite:
    types:
      - completed

jobs:
  notify_reviewers:
    runs-on: ubuntu-latest
    if: ${{ github.event.check_suite.conclusion == 'success' }}
    steps:
      - name: Notify reviewers on Slack
        # 以降、通知に関するステップを記述します
```

この例では、`if` ステートメントを `jobs.notify_reviewers` ジョブのレベルに設定しています。これにより、`check_suite` イベントが `completed` タイプでトリガーされたときに、チェックスイートの結論が `success` である場合にのみ、`notify_reviewers` ジョブが実行されます。つまり、すべてのチェックランが成功した場合にのみ、ジョブが実行されるようになります。

---
