# Guild管理ウィジェット分割

Date: 2025-02-14

---

## 👤 User
*2025-02-14 15:33:02*

Widget _buildGuildManagementContent({ を定義しているが、全体的にrefの引数を引き回すのが大変なので、HookConsumerWidgetで別に定義した方がいい気がしている。

そして、コメントアウトしている以下の処理を実際に適応させたい。onTapDeleteGuildはそちらのHookConsumerWidgetで定義して方がいいと思う。
リフレッシュの処理もしないといけないので、それは考えて欲しい。

        // Padding(
        //   padding: const EdgeInsets.only(top: 24, bottom: 24),
        //   child: OutlinedButton(
        //     onPressed: isLoadingState.value
        //         ? null
        //         : () async {
        //             await onTapDeleteGuild();
        //           },
        //     child: const Text('Delete this guild'),
        //   ),
        // ),  import 'dart:io';
import 'package:flutter/material.dart';
import 'package:flutter_hooks/flutter_hooks.dart';
import 'package:go_router/go_router.dart';
import 'package:hooks_riverpod/hooks_riverpod.dart';
import 'package:image_cropper/image_cropper.dart';
import 'package:image_picker/image_picker.dart';
import 'package:permission_handler/permission_handler.dart';
import 'package:snpit_guild_app/domain/design/color_pallet.dart';
import 'package:snpit_guild_app/domain/design/color_token.dart';
import 'package:snpit_guild_app/domain/screen.dart';
import 'package:snpit_guild_app/infrastructure/entities/extensions/camera_dto_x.dart';
import 'package:snpit_guild_app/infrastructure/snapit_guild_api/snapit_guild_api.openapi.dart';
import 'package:snpit_guild_app/presentation/providers/api_client/guilds/delete_guild.dart';
import 'package:snpit_guild_app/presentation/providers/api_client/guilds/get_guild.dart';
import 'package:snpit_guild_app/presentation/providers/api_client/guilds/update_guild.dart';
import 'package:snpit_guild_app/presentation/providers/api_client/guilds/update_guild_member.dart';
import 'package:snpit_guild_app/presentation/router/router.dart';
import 'package:snpit_guild_app/presentation/widgets/dialogs/delete_guild_dialog.dart';
import 'package:snpit_guild_app/presentation/widgets/guild_icon.dart';
import 'package:snpit_guild_app/presentation/widgets/guild_member_column.dart';
import 'package:snpit_guild_app/presentation/widgets/parameters_bar_column.dart';
import 'package:snpit_guild_app/utils/extensions/uri_extensions.dart';
import 'package:snpit_guild_app/utils/snack_bar_utils.dart';

class GuildManagePage extends HookConsumerWidget {
  const GuildManagePage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final picker = useMemoized(ImagePicker.new);
    final imageFileState = useState&lt;File?&gt;(null);
    final myGuildAsyncValue = ref.watch(getMyGuildNotifierProvider);
    final isLoadingState = useState(false);

    Future&lt;void&gt; onRefresh() async {
      try {
        await ref.read(getMyGuildNotifierProvider.notifier).getMyGuild();
      } on Exception catch (error) {
        if (context.mounted) {
          showErrorSnackBar(context, error);
        }
      }
    }

    Future&lt;void&gt; onTapDeleteGuild() async {
      final confirm = await showDialog&lt;bool&gt;(
        context: context,
        builder: (context) =&gt; const DeleteGuildDialog(),
      );

      if (confirm != true) {
        return;
      }

      try {
        await ref.read(deleteGuildNotifierProvider.notifier).deleteGuild();
        await onRefresh();

        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Guild deleted successfully.'),
            ),
          );
        }

        if (context.mounted) {
          context.pop();
        }
      } on Exception catch (error) {
        if (context.mounted) {
          showErrorSnackBar(context, error);
        }
      }
    }

    Future&lt;void&gt; pickAndCropImage() async {
      final pickedFile = await picker.pickImage(source: ImageSource.gallery);
      if (pickedFile == null) {
        debugPrint('Image selection cancelled');
        return;
      }

      final croppedFile = await ImageCropper().cropImage(
        sourcePath: pickedFile.path,
        aspectRatio: const CropAspectRatio(ratioX: 1, ratioY: 1),
        uiSettings: [
          AndroidUiSettings(
            hideBottomControls: true,
            lockAspectRatio: true,
          ),
          IOSUiSettings(
            aspectRatioLockEnabled: true,
          ),
        ],
      );

      if (croppedFile == null) {
        debugPrint('Cropping cancelled');
        return;
      }

      if (!context.mounted) {
        return;
      }

      imageFileState.value = File(croppedFile.path);
      debugPrint('Cropped image path: ${imageFileState.value!.path}');

      try {
        // TODO: [フェーズ2] 画像アップロードなど適切な API 呼び出し
        await ref.read(updateGuildNotifierProvider.notifier).updateGuildAvatar(
              UriExtensions.randomImageUrlWithTitle(
                // ignore: use_build_context_synchronously
                TimeOfDay.now().format(context),
              ).toString(),
            );

        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Updated Successfully'),
            ),
          );
        }

        await onRefresh();
      } on Exception catch (error) {
        if (context.mounted) {
          showErrorSnackBar(context, error);
        }
      }
    }

    Future&lt;void&gt; onTapGuildPhoto() async {
      await showDialog&lt;void&gt;(
        context: context,
        builder: (context) =&gt; AlertDialog(
          insetPadding: const EdgeInsets.symmetric(horizontal: 16),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(8),
          ),
          backgroundColor: ColorPallet.gray800,
          title: const Text('Guild Icon Editor'),
          content: const Text(
            'Coming Soon!',
          ),
          actions: [
            TextButton(
              onPressed: () =&gt; context.pop(),
              child: const Text('OK'),
            ),
          ],
        ),
      );

      return;

      // TODO: [フェーズ2] 画像アップロード機能を実装する
      // ignore: dead_code, use_build_context_synchronously
      final hasPermission = await _hasPhotoPermission(context);
      if (hasPermission) {
        await pickAndCropImage();
      }
    }

    Future&lt;void&gt; onTapSave(String updatedText, String guildName) async {
      try {
        if (updatedText.isNotEmpty && updatedText != guildName) {
          await ref
              .read(updateGuildNotifierProvider.notifier)
              .updateGuildName(updatedText);

          // Refresh guild information
          await onRefresh();

          // show snackbar
          if (context.mounted) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text('Guild name updated to $updatedText'),
              ),
            );
          }
        }
      } on Exception catch (error) {
        if (context.mounted) {
          showErrorSnackBar(context, error);
        }
      }
    }

    Future&lt;void&gt; onTapReject({
      required String guildId,
      required String userId,
      required String userName,
    }) async {
      try {
        await ref
            .read(rejectGuildNotifierProvider.notifier)
            .rejectGuild(guildId: guildId, userId: userId);

        // ギルド情報をリフレッシュ
        await onRefresh();

        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text('Rejected $userName'),
            ),
          );
        }
      } on Exception catch (error) {
        if (context.mounted) {
          showErrorSnackBar(context, error);
        }
      }
    }

    Future&lt;void&gt; onTapApprove({
      required String guildId,
      required String userId,
      required String userName,
    }) async {
      try {
        await ref
            .read(approveGuildNotifierProvider.notifier)
            .approveGuild(guildId: guildId, userId: userId);

        // ギルド情報をリフレッシュ
        await onRefresh();

        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text('Approved $userName'),
            ),
          );
        }
      } on Exception catch (error) {
        if (context.mounted) {
          showErrorSnackBar(context, error);
        }
      }
    }

    useEffect(
      () {
        Future.microtask(() async {
          await onRefresh();
        });
        return null;
      },
      [],
    );

    return Scaffold(
      appBar: AppBar(
        title: const Text('Guild management'),
      ),
      body: RefreshIndicator(
        onRefresh: () async {
          await onRefresh();
        },
        color: ColorToken.primary,
        backgroundColor: ColorToken.bgLight,
        child: myGuildAsyncValue.when(
          data: (guild) {
            if (guild == null) {
              return const SizedBox.shrink();
            }

            final guildId = guild.guildId ?? 'Unknown';
            final guildName = guild.guildName ?? 'No Name';
            final guildAvatar = guild.guildAvatar ?? '';
            final guildMembers = guild.guildMembers ?? &lt;GuildMemberDto&gt;[];

            return SingleChildScrollView(
              physics: const AlwaysScrollableScrollPhysics(),
              child: Padding(
                padding: const EdgeInsets.symmetric(horizontal: 20),
                child: _buildGuildManagementContent(
                  context: context,
                  ref: ref,
                  guildId: guildId,
                  guildName: guildName,
                  guildAvatar: guildAvatar,
                  guildMembers: guildMembers,
                  pickAndCropImage: pickAndCropImage,
                  onTapSave: onTapSave,
                  onTapGuildPhoto: onTapGuildPhoto,
                  onTapReject: onTapReject,
                  onTapApprove: onTapApprove,
                ),
              ),
            );
          },
          loading: () {
            return const Center(child: CircularProgressIndicator());
          },
          error: (error, _) {
            return Center(child: Text('Error: $error'));
          },
        ),
      ),
    );
  }

  /// GuildInfoResponseDtoData の中の必要データを非オプショナルで受け取り、安全なデフォルトを使う
  Widget _buildGuildManagementContent({
    required BuildContext context,
    required WidgetRef ref,
    required String guildId,
    required String guildName,
    required String guildAvatar,
    required List&lt;GuildMemberDto&gt; guildMembers,
    required Future&lt;void&gt; Function() pickAndCropImage,
    required Future&lt;void&gt; Function(String updatedText, String guildName)
        onTapSave,
    required Future&lt;void&gt; Function() onTapGuildPhoto,
    required Future&lt;void&gt; Function({
      required String guildId,
      required String userId,
      required String userName,
    }) onTapReject,
    required Future&lt;void&gt; Function({
      required String guildId,
      required String userId,
      required String userName,
    }) onTapApprove,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const SizedBox(height: 32),
        // ギルドのアバター(写真)
        Center(
          child: GestureDetector(
            onTap: () async {
              await onTapGuildPhoto();
            },
            child: Stack(
              alignment: Alignment.center,
              children: [
                GuildIcon(
                  guildId: guildId,
                  guildAvatar: guildAvatar,
                ),
                Container(
                  width: 64,
                  height: 64,
                  decoration: BoxDecoration(
                    color: Colors.black.withAlpha(180),
                    borderRadius: BorderRadius.circular(8),
                  ),
                ),
                const Icon(
                  Icons.camera_alt,
                  size: 24,
                  color: Colors.white,
                ),
              ],
            ),
          ),
        ),
        const SizedBox(height: 32),
        // ギルド名編集部分
        Material(
          color: Colors.transparent,
          child: InkWell(
            onTap: () {
              context.push(
                Screen.textEditing.path,
                extra: TextEditingPageArgs(
                  title: 'Name',
                  text: guildName,
                  hintText: 'Enter guild name',
                  onSave: (updatedText) async {
                    await onTapSave(updatedText, guildName);
                  },
                ),
              );
            },
            borderRadius: BorderRadius.circular(8),
            child: Container(
              padding: const EdgeInsets.symmetric(vertical: 8),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  const Text(
                    'Name',
                    style: TextStyle(
                      fontSize: 16,
                      color: ColorPallet.gray300,
                    ),
                  ),
                  const SizedBox(
                    width: 8,
                  ),
                  Flexible(
                    child: Row(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        Flexible(
                          child: Text(
                            guildName,
                            style: const TextStyle(fontSize: 16),
                            maxLines: 1,
                            overflow: TextOverflow.ellipsis,
                          ),
                        ),
                        const SizedBox(width: 8),
                        const Icon(
                          Icons.chevron_right,
                          color: ColorToken.text,
                          size: 20,
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
        const SizedBox(height: 32),
        const Divider(
          color: ColorToken.secondary,
        ),
        const SizedBox(height: 32),
        // メンバー申請一覧
        _buildRequestedMembers(
          context: context,
          ref: ref,
          guildId: guildId,
          guildMembers: guildMembers,
          onTapReject: onTapReject,
          onTapApprove: onTapApprove,
        ),

        // Padding(
        //   padding: const EdgeInsets.only(top: 24, bottom: 24),
        //   child: OutlinedButton(
        //     onPressed: isLoadingState.value
        //         ? null
        //         : () async {
        //             await onTapDeleteGuild();
        //           },
        //     child: const Text('Delete this guild'),
        //   ),
        // ),
      ],
    );
  }

  /// 申請中メンバー一覧表示
  Widget _buildRequestedMembers({
    required BuildContext context,
    required WidgetRef ref,
    required String guildId,
    required List&lt;GuildMemberDto&gt; guildMembers,
    required Future&lt;void&gt; Function({
      required String guildId,
      required String userId,
      required String userName,
    }) onTapReject,
    required Future&lt;void&gt; Function({
      required String guildId,
      required String userId,
      required String userName,
    }) onTapApprove,
  }) {
    // guildMembers の中で、`memberStatus` が REQUESTED のものだけを抽出
    final requestedMembers = guildMembers
        .where(
          (member) =&gt;
              member.memberStatus == GuildMemberDtoMemberStatus.REQUESTED,
        )
        .toList();

    // 申請中メンバーがいない場合
    if (requestedMembers.isEmpty) {
      return const Center(
        child: Padding(
          // pulll-to-refresh でスクロールするための余白を追加
          padding: EdgeInsets.only(bottom: 180),
          child: Text('No members requesting to join.'),
        ),
      );
    }

    return Padding(
      // pulll-to-refresh でスクロールするための余白を追加
      padding: const EdgeInsets.only(bottom: 180),
      child: ListView.builder(
        shrinkWrap: true,
        physics: const NeverScrollableScrollPhysics(),
        itemCount: requestedMembers.length,
        itemBuilder: (context, index) {
          final member = requestedMembers[index];
          final userId = member.userId ?? '';
          final userName = member.username ?? '';
          final avatarUrl = member.avatar;
          final cameraList =
              member.decks?.firstOrNull?.deckCameras?.sorted() ?? [];

          return Padding(
            padding: const EdgeInsets.only(bottom: 8),
            child: DecoratedBox(
              decoration: BoxDecoration(
                color: ColorToken.bg,
                borderRadius: BorderRadius.circular(4),
                border: Border.all(
                  color: ColorToken.defaultBorder,
                ),
              ),
              child: Padding(
                padding: const EdgeInsets.all(16),
                child: Column(
                  children: [
                    // ユーザー情報部分
                    Row(
                      children: [
                        // 左側：アバター + ユーザー名
                        Expanded(
                          child: GuildMemberColumn(
                            userName: userName,
                            isGuildOwner: false,
                            userPhotoUrl: avatarUrl,
                            cameraList: cameraList,
                          ),
                        ),
                        // 右側：各種ステータス (Q, E, L, B など)
                        Expanded(
                          child: ParametersBarColumn(
                            searchQ: member.decks?.firstOrNull?.searchQ ?? 0,
                            attackE: member.decks?.firstOrNull?.attackE ?? 0,
                            luckL: member.decks?.firstOrNull?.luckL ?? 0,
                            defenseB: member.decks?.firstOrNull?.defenseB ?? 0,
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 16),
                    // 承認・却下ボタン
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Flexible(
                          child: OutlinedButton(
                            onPressed: () async {
                              await onTapReject(
                                guildId: guildId,
                                userId: userId,
                                userName: userName,
                              );
                            },
                            style: OutlinedButton.styleFrom(
                              minimumSize: const Size.fromHeight(32),
                            ),
                            child: const Text(
                              'Reject',
                              style: TextStyle(fontSize: 12),
                            ),
                          ),
                        ),
                        const SizedBox(width: 12),
                        Flexible(
                          child: ElevatedButton(
                            onPressed: () async {
                              await onTapApprove(
                                guildId: guildId,
                                userId: userId,
                                userName: userName,
                              );
                            },
                            style: OutlinedButton.styleFrom(
                              minimumSize: const Size.fromHeight(32),
                            ),
                            child: const Text(
                              'Approve',
                              style: TextStyle(fontSize: 12),
                            ),
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ),
          );
        },
      ),
    );
  }

  /// 写真の権限をチェックして、権限があれば true を返す
  Future&lt;bool&gt; _hasPhotoPermission(BuildContext context) async {
    final status = await Permission.photos.request();

    switch (status) {
      case PermissionStatus.granted:
      case PermissionStatus.limited:
        // 許可済み
        return true;
      case PermissionStatus.permanentlyDenied:
        // 永久に拒否されている場合
        if (context.mounted) {
          _showPermissionDialog(context);
        }
        return false;
      case PermissionStatus.denied:
      case PermissionStatus.restricted:
      case PermissionStatus.provisional:
        // その他の場合
        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('Access to photos is not granted.')),
          );
        }
        return false;
    }
  }

  /// 設定画面へ遷移させるダイアログを表示
  void _showPermissionDialog(BuildContext context) {
    showDialog&lt;void&gt;(
      context: context,
      builder: (context) =&gt; AlertDialog(
        insetPadding: const EdgeInsets.symmetric(horizontal: 16),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(8),
        ),
        backgroundColor: ColorPallet.gray800,
        title: const Text(
          'Permission to access photos is required',
        ),
        content: const Text(
          'Enable photo access in settings to select a photo.',
        ),
        actions: [
          TextButton(
            onPressed: () async {
              context.pop();
            },
            child: const Text('Cancel'),
          ),
          TextButton(
            onPressed: () async {
              await openAppSettings();
            },
            child: const Text('Open Settings'),
          ),
        ],
      ),
    );
  }
}

import 'dart:io';
import 'package:flutter/material.dart';
import 'package:flutter_hooks/flutter_hooks.dart';
import 'package:go_router/go_router.dart';
import 'package:hooks_riverpod/hooks_riverpod.dart';
import 'package:image_cropper/image_cropper.dart';
import 'package:image_picker/image_picker.dart';
import 'package:permission_handler/permission_handler.dart';
import 'package:snpit_guild_app/domain/design/color_pallet.dart';
import 'package:snpit_guild_app/domain/design/color_token.dart';
import 'package:snpit_guild_app/domain/screen.dart';
import 'package:snpit_guild_app/infrastructure/entities/extensions/camera_dto_x.dart';
import 'package:snpit_guild_app/infrastructure/snapit_guild_api/snapit_guild_api.openapi.dart';
import 'package:snpit_guild_app/presentation/providers/api_client/guilds/delete_guild.dart';
import 'package:snpit_guild_app/presentation/providers/api_client/guilds/get_guild.dart';
import 'package:snpit_guild_app/presentation/providers/api_client/guilds/update_guild.dart';
import 'package:snpit_guild_app/presentation/providers/api_client/guilds/update_guild_member.dart';
import 'package:snpit_guild_app/presentation/router/router.dart';
import 'package:snpit_guild_app/presentation/widgets/dialogs/delete_guild_dialog.dart';
import 'package:snpit_guild_app/presentation/widgets/guild_icon.dart';
import 'package:snpit_guild_app/presentation/widgets/guild_member_column.dart';
import 'package:snpit_guild_app/presentation/widgets/parameters_bar_column.dart';
import 'package:snpit_guild_app/utils/extensions/uri_extensions.dart';
import 'package:snpit_guild_app/utils/snack_bar_utils.dart';

class GuildManagePage extends HookConsumerWidget {
  const GuildManagePage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final picker = useMemoized(ImagePicker.new);
    final imageFileState = useState&lt;File?&gt;(null);
    final myGuildAsyncValue = ref.watch(getMyGuildNotifierProvider);
    final isLoadingState = useState(false);

    Future&lt;void&gt; onRefresh() async {
      try {
        await ref.read(getMyGuildNotifierProvider.notifier).getMyGuild();
      } on Exception catch (error) {
        if (context.mounted) {
          showErrorSnackBar(context, error);
        }
      }
    }

    Future&lt;void&gt; onTapDeleteGuild() async {
      final confirm = await showDialog&lt;bool&gt;(
        context: context,
        builder: (context) =&gt; const DeleteGuildDialog(),
      );

      if (confirm != true) {
        return;
      }

      try {
        await ref.read(deleteGuildNotifierProvider.notifier).deleteGuild();
        await onRefresh();

        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Guild deleted successfully.'),
            ),
          );
        }

        if (context.mounted) {
          context.pop();
        }
      } on Exception catch (error) {
        if (context.mounted) {
          showErrorSnackBar(context, error);
        }
      }
    }

    Future&lt;void&gt; pickAndCropImage() async {
      final pickedFile = await picker.pickImage(source: ImageSource.gallery);
      if (pickedFile == null) {
        debugPrint('Image selection cancelled');
        return;
      }

      final croppedFile = await ImageCropper().cropImage(
        sourcePath: pickedFile.path,
        aspectRatio: const CropAspectRatio(ratioX: 1, ratioY: 1),
        uiSettings: [
          AndroidUiSettings(
            hideBottomControls: true,
            lockAspectRatio: true,
          ),
          IOSUiSettings(
            aspectRatioLockEnabled: true,
          ),
        ],
      );

      if (croppedFile == null) {
        debugPrint('Cropping cancelled');
        return;
      }

      if (!context.mounted) {
        return;
      }

      imageFileState.value = File(croppedFile.path);
      debugPrint('Cropped image path: ${imageFileState.value!.path}');

      try {
        // TODO: [フェーズ2] 画像アップロードなど適切な API 呼び出し
        await ref.read(updateGuildNotifierProvider.notifier).updateGuildAvatar(
              UriExtensions.randomImageUrlWithTitle(
                // ignore: use_build_context_synchronously
                TimeOfDay.now().format(context),
              ).toString(),
            );

        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Updated Successfully'),
            ),
          );
        }

        await onRefresh();
      } on Exception catch (error) {
        if (context.mounted) {
          showErrorSnackBar(context, error);
        }
      }
    }

    Future&lt;void&gt; onTapGuildPhoto() async {
      await showDialog&lt;void&gt;(
        context: context,
        builder: (context) =&gt; AlertDialog(
          insetPadding: const EdgeInsets.symmetric(horizontal: 16),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(8),
          ),
          backgroundColor: ColorPallet.gray800,
          title: const Text('Guild Icon Editor'),
          content: const Text(
            'Coming Soon!',
          ),
          actions: [
            TextButton(
              onPressed: () =&gt; context.pop(),
              child: const Text('OK'),
            ),
          ],
        ),
      );

      return;

      // TODO: [フェーズ2] 画像アップロード機能を実装する
      // ignore: dead_code, use_build_context_synchronously
      final hasPermission = await _hasPhotoPermission(context);
      if (hasPermission) {
        await pickAndCropImage();
      }
    }

    Future&lt;void&gt; onTapSave(String updatedText, String guildName) async {
      try {
        if (updatedText.isNotEmpty && updatedText != guildName) {
          await ref
              .read(updateGuildNotifierProvider.notifier)
              .updateGuildName(updatedText);

          // Refresh guild information
          await onRefresh();

          // show snackbar
          if (context.mounted) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text('Guild name updated to $updatedText'),
              ),
            );
          }
        }
      } on Exception catch (error) {
        if (context.mounted) {
          showErrorSnackBar(context, error);
        }
      }
    }

    Future&lt;void&gt; onTapReject({
      required String guildId,
      required String userId,
      required String userName,
    }) async {
      try {
        await ref
            .read(rejectGuildNotifierProvider.notifier)
            .rejectGuild(guildId: guildId, userId: userId);

        // ギルド情報をリフレッシュ
        await onRefresh();

        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text('Rejected $userName'),
            ),
          );
        }
      } on Exception catch (error) {
        if (context.mounted) {
          showErrorSnackBar(context, error);
        }
      }
    }

    Future&lt;void&gt; onTapApprove({
      required String guildId,
      required String userId,
      required String userName,
    }) async {
      try {
        await ref
            .read(approveGuildNotifierProvider.notifier)
            .approveGuild(guildId: guildId, userId: userId);

        // ギルド情報をリフレッシュ
        await onRefresh();

        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text('Approved $userName'),
            ),
          );
        }
      } on Exception catch (error) {
        if (context.mounted) {
          showErrorSnackBar(context, error);
        }
      }
    }

    useEffect(
      () {
        Future.microtask(() async {
          await onRefresh();
        });
        return null;
      },
      [],
    );

    return Scaffold(
      appBar: AppBar(
        title: const Text('Guild management'),
      ),
      body: RefreshIndicator(
        onRefresh: () async {
          await onRefresh();
        },
        color: ColorToken.primary,
        backgroundColor: ColorToken.bgLight,
        child: myGuildAsyncValue.when(
          data: (guild) {
            if (guild == null) {
              return const SizedBox.shrink();
            }

            final guildId = guild.guildId ?? 'Unknown';
            final guildName = guild.guildName ?? 'No Name';
            final guildAvatar = guild.guildAvatar ?? '';
            final guildMembers = guild.guildMembers ?? &lt;GuildMemberDto&gt;[];

            return SingleChildScrollView(
              physics: const AlwaysScrollableScrollPhysics(),
              child: Padding(
                padding: const EdgeInsets.symmetric(horizontal: 20),
                child: _buildGuildManagementContent(
                  context: context,
                  ref: ref,
                  guildId: guildId,
                  guildName: guildName,
                  guildAvatar: guildAvatar,
                  guildMembers: guildMembers,
                  pickAndCropImage: pickAndCropImage,
                  onTapSave: onTapSave,
                  onTapGuildPhoto: onTapGuildPhoto,
                  onTapReject: onTapReject,
                  onTapApprove: onTapApprove,
                ),
              ),
            );
          },
          loading: () {
            return const Center(child: CircularProgressIndicator());
          },
          error: (error, _) {
            return Center(child: Text('Error: $error'));
          },
        ),
      ),
    );
  }

  /// GuildInfoResponseDtoData の中の必要データを非オプショナルで受け取り、安全なデフォルトを使う
  Widget _buildGuildManagementContent({
    required BuildContext context,
    required WidgetRef ref,
    required String guildId,
    required String guildName,
    required String guildAvatar,
    required List&lt;GuildMemberDto&gt; guildMembers,
    required Future&lt;void&gt; Function() pickAndCropImage,
    required Future&lt;void&gt; Function(String updatedText, String guildName)
        onTapSave,
    required Future&lt;void&gt; Function() onTapGuildPhoto,
    required Future&lt;void&gt; Function({
      required String guildId,
      required String userId,
      required String userName,
    }) onTapReject,
    required Future&lt;void&gt; Function({
      required String guildId,
      required String userId,
      required String userName,
    }) onTapApprove,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const SizedBox(height: 32),
        // ギルドのアバター(写真)
        Center(
          child: GestureDetector(
            onTap: () async {
              await onTapGuildPhoto();
            },
            child: Stack(
              alignment: Alignment.center,
              children: [
                GuildIcon(
                  guildId: guildId,
                  guildAvatar: guildAvatar,
                ),
                Container(
                  width: 64,
                  height: 64,
                  decoration: BoxDecoration(
                    color: Colors.black.withAlpha(180),
                    borderRadius: BorderRadius.circular(8),
                  ),
                ),
                const Icon(
                  Icons.camera_alt,
                  size: 24,
                  color: Colors.white,
                ),
              ],
            ),
          ),
        ),
        const SizedBox(height: 32),
        // ギルド名編集部分
        Material(
          color: Colors.transparent,
          child: InkWell(
            onTap: () {
              context.push(
                Screen.textEditing.path,
                extra: TextEditingPageArgs(
                  title: 'Name',
                  text: guildName,
                  hintText: 'Enter guild name',
                  onSave: (updatedText) async {
                    await onTapSave(updatedText, guildName);
                  },
                ),
              );
            },
            borderRadius: BorderRadius.circular(8),
            child: Container(
              padding: const EdgeInsets.symmetric(vertical: 8),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  const Text(
                    'Name',
                    style: TextStyle(
                      fontSize: 16,
                      color: ColorPallet.gray300,
                    ),
                  ),
                  const SizedBox(
                    width: 8,
                  ),
                  Flexible(
                    child: Row(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        Flexible(
                          child: Text(
                            guildName,
                            style: const TextStyle(fontSize: 16),
                            maxLines: 1,
                            overflow: TextOverflow.ellipsis,
                          ),
                        ),
                        const SizedBox(width: 8),
                        const Icon(
                          Icons.chevron_right,
                          color: ColorToken.text,
                          size: 20,
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
        const SizedBox(height: 32),
        const Divider(
          color: ColorToken.secondary,
        ),
        const SizedBox(height: 32),
        // メンバー申請一覧
        _buildRequestedMembers(
          context: context,
          ref: ref,
          guildId: guildId,
          guildMembers: guildMembers,
          onTapReject: onTapReject,
          onTapApprove: onTapApprove,
        ),

        // Padding(
        //   padding: const EdgeInsets.only(top: 24, bottom: 24),
        //   child: OutlinedButton(
        //     onPressed: isLoadingState.value
        //         ? null
        //         : () async {
        //             await onTapDeleteGuild();
        //           },
        //     child: const Text('Delete this guild'),
        //   ),
        // ),
      ],
    );
  }

  /// 申請中メンバー一覧表示
  Widget _buildRequestedMembers({
    required BuildContext context,
    required WidgetRef ref,
    required String guildId,
    required List&lt;GuildMemberDto&gt; guildMembers,
    required Future&lt;void&gt; Function({
      required String guildId,
      required String userId,
      required String userName,
    }) onTapReject,
    required Future&lt;void&gt; Function({
      required String guildId,
      required String userId,
      required String userName,
    }) onTapApprove,
  }) {
    // guildMembers の中で、`memberStatus` が REQUESTED のものだけを抽出
    final requestedMembers = guildMembers
        .where(
          (member) =&gt;
              member.memberStatus == GuildMemberDtoMemberStatus.REQUESTED,
        )
        .toList();

    // 申請中メンバーがいない場合
    if (requestedMembers.isEmpty) {
      return const Center(
        child: Padding(
          // pulll-to-refresh でスクロールするための余白を追加
          padding: EdgeInsets.only(bottom: 180),
          child: Text('No members requesting to join.'),
        ),
      );
    }

    return Padding(
      // pulll-to-refresh でスクロールするための余白を追加
      padding: const EdgeInsets.only(bottom: 180),
      child: ListView.builder(
        shrinkWrap: true,
        physics: const NeverScrollableScrollPhysics(),
        itemCount: requestedMembers.length,
        itemBuilder: (context, index) {
          final member = requestedMembers[index];
          final userId = member.userId ?? '';
          final userName = member.username ?? '';
          final avatarUrl = member.avatar;
          final cameraList =
              member.decks?.firstOrNull?.deckCameras?.sorted() ?? [];

          return Padding(
            padding: const EdgeInsets.only(bottom: 8),
            child: DecoratedBox(
              decoration: BoxDecoration(
                color: ColorToken.bg,
                borderRadius: BorderRadius.circular(4),
                border: Border.all(
                  color: ColorToken.defaultBorder,
                ),
              ),
              child: Padding(
                padding: const EdgeInsets.all(16),
                child: Column(
                  children: [
                    // ユーザー情報部分
                    Row(
                      children: [
                        // 左側：アバター + ユーザー名
                        Expanded(
                          child: GuildMemberColumn(
                            userName: userName,
                            isGuildOwner: false,
                            userPhotoUrl: avatarUrl,
                            cameraList: cameraList,
                          ),
                        ),
                        // 右側：各種ステータス (Q, E, L, B など)
                        Expanded(
                          child: ParametersBarColumn(
                            searchQ: member.decks?.firstOrNull?.searchQ ?? 0,
                            attackE: member.decks?.firstOrNull?.attackE ?? 0,
                            luckL: member.decks?.firstOrNull?.luckL ?? 0,
                            defenseB: member.decks?.firstOrNull?.defenseB ?? 0,
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 16),
                    // 承認・却下ボタン
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Flexible(
                          child: OutlinedButton(
                            onPressed: () async {
                              await onTapReject(
                                guildId: guildId,
                                userId: userId,
                                userName: userName,
                              );
                            },
                            style: OutlinedButton.styleFrom(
                              minimumSize: const Size.fromHeight(32),
                            ),
                            child: const Text(
                              'Reject',
                              style: TextStyle(fontSize: 12),
                            ),
                          ),
                        ),
                        const SizedBox(width: 12),
                        Flexible(
                          child: ElevatedButton(
                            onPressed: () async {
                              await onTapApprove(
                                guildId: guildId,
                                userId: userId,
                                userName: userName,
                              );
                            },
                            style: OutlinedButton.styleFrom(
                              minimumSize: const Size.fromHeight(32),
                            ),
                            child: const Text(
                              'Approve',
                              style: TextStyle(fontSize: 12),
                            ),
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ),
          );
        },
      ),
    );
  }

  /// 写真の権限をチェックして、権限があれば true を返す
  Future&lt;bool&gt; _hasPhotoPermission(BuildContext context) async {
    final status = await Permission.photos.request();

    switch (status) {
      case PermissionStatus.granted:
      case PermissionStatus.limited:
        // 許可済み
        return true;
      case PermissionStatus.permanentlyDenied:
        // 永久に拒否されている場合
        if (context.mounted) {
          _showPermissionDialog(context);
        }
        return false;
      case PermissionStatus.denied:
      case PermissionStatus.restricted:
      case PermissionStatus.provisional:
        // その他の場合
        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('Access to photos is not granted.')),
          );
        }
        return false;
    }
  }

  /// 設定画面へ遷移させるダイアログを表示
  void _showPermissionDialog(BuildContext context) {
    showDialog&lt;void&gt;(
      context: context,
      builder: (context) =&gt; AlertDialog(
        insetPadding: const EdgeInsets.symmetric(horizontal: 16),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(8),
        ),
        backgroundColor: ColorPallet.gray800,
        title: const Text(
          'Permission to access photos is required',
        ),
        content: const Text(
          'Enable photo access in settings to select a photo.',
        ),
        actions: [
          TextButton(
            onPressed: () async {
              context.pop();
            },
            child: const Text('Cancel'),
          ),
          TextButton(
            onPressed: () async {
              await openAppSettings();
            },
            child: const Text('Open Settings'),
          ),
        ],
      ),
    );
  }
}

---

## 🔧 Tool
*2025-02-14 15:34:12*

**コードの再構築を検討中**

GuildManagePageのコードを分割し、独立したHookConsumerWidgetで管理する計画。削除ボタンとリフレッシュロジックを統合し、パラメータとコールバックを持つGuildManagementContentを構築中。

**作業の進行中**

GuildManagementContentをHookConsumerWidgetとして作成し、必要なデータを単一のパラメータで渡すことを検討。onTapDeleteGuildメソッドの統合も検討している。

**詳細を詰める**

onTapDeleteGuildとリフレッシュロジックをGuildManagementContentに統合して、親からギルド情報を渡す計画を進めている。

**データの扱いを考える**

子ウィジェットが直接データを取得し、リフレッシュロジックも担当する方法を模索中。親ウィジェットのwatchを省略するか、部分的に行うアプローチを検討中。

**親子ウィジェットの役割を見極める**

親ウィジェットからデータを渡しつつ、子ウィジェットでリフレッシュロジックを実行する方法を検討中。これにより、親ウィジェットはシンプルに保たれる。

**新ウィジェットの役割を強調**

新しいウィジェットがリフレッシュを担当し、親ウィジェットのリフレッシュロジックを省略している。親は表示の簡略化を図っている。

**新ウィジェットの編成を考える**

親のコードを省略しつつ、新しい`HookConsumerWidget`を作成して注釈コードや削除ボタンの`onTapDeleteGuild`を統合し、リフレッシュロジックも新しいウィジェットに含めることを検討している。

**画像選択の統合を模索中**

画像選択のロジックを新しい`HookConsumerWidget`に組み込み、必要に応じて`ref`を子ウィジェットに渡す方法を探っている。

**新ウィジェットの作成**

`GuildManagementContent`という新しいウィジェットを作成し、画像選択や更新ロジックを統合。親ウィジェットの`GuildManagePage`は簡略化し、`AppBar`を追加することを検討中。

**ウィジェット作成をホープする**

`GuildManagementContent`ウィジェットを作成し、画像選択や更新ロジックを統合。親ウィジェット`GuildManagePage`は簡略化し、`AppBar`を維持する方針。

---

## 🤖 Assistant
*2025-02-14 15:34:12*

以下は一例として、**「ギルド管理画面まるごと」を新しい `HookConsumerWidget` に切り出す** 形のサンプルです。  
（`GuildManagePage` を極力シンプルにし、実際のロジックや UI はすべて切り出した `GuildManagementContent` で完結させます。）

もし「`AppBar` は親ウィジェットで定義したまま、中身だけを差し替えたい」という場合は、下記サンプルの `GuildManagePage` の実装を調整して利用してください。

---

## 例: `GuildManagePage`（元のメインページ）を最小化し、子ウィジェットに集約する

```dart
import 'package:flutter/material.dart';
import 'package:hooks_riverpod/hooks_riverpod.dart';

/// ギルド管理ページ（元の親）
class GuildManagePage extends StatelessWidget {
  const GuildManagePage({super.key});

  @override
  Widget build(BuildContext context) {
    return const Scaffold(
      appBar: AppBar(
        title: Text('Guild management'),
      ),
      // 中身(RefreshIndicator含む) は GuildManagementContent にまとめる
      body: GuildManagementContent(),
    );
  }
}
```

---

## 例: 新しく作った `GuildManagementContent`（HookConsumerWidget）

```dart
import 'dart:io';

import 'package:flutter/material.dart';
import 'package:flutter_hooks/flutter_hooks.dart';
import 'package:go_router/go_router.dart';
import 'package:hooks_riverpod/hooks_riverpod.dart';
import 'package:image_cropper/image_cropper.dart';
import 'package:image_picker/image_picker.dart';
import 'package:permission_handler/permission_handler.dart';

// 以下はご自身のプロジェクトの import に合わせてパスを調整してください
import 'package:snpit_guild_app/domain/design/color_pallet.dart';
import 'package:snpit_guild_app/domain/design/color_token.dart';
import 'package:snpit_guild_app/domain/screen.dart';
import 'package:snpit_guild_app/infrastructure/entities/extensions/camera_dto_x.dart';
import 'package:snpit_guild_app/infrastructure/snapit_guild_api/snapit_guild_api.openapi.dart';
import 'package:snpit_guild_app/presentation/providers/api_client/guilds/delete_guild.dart';
import 'package:snpit_guild_app/presentation/providers/api_client/guilds/get_guild.dart';
import 'package:snpit_guild_app/presentation/providers/api_client/guilds/update_guild.dart';
import 'package:snpit_guild_app/presentation/providers/api_client/guilds/update_guild_member.dart';
import 'package:snpit_guild_app/presentation/router/router.dart';
import 'package:snpit_guild_app/presentation/widgets/dialogs/delete_guild_dialog.dart';
import 'package:snpit_guild_app/presentation/widgets/guild_icon.dart';
import 'package:snpit_guild_app/presentation/widgets/guild_member_column.dart';
import 'package:snpit_guild_app/presentation/widgets/parameters_bar_column.dart';
import 'package:snpit_guild_app/utils/extensions/uri_extensions.dart';
import 'package:snpit_guild_app/utils/snack_bar_utils.dart';

/// ギルド管理ページの「中身」全てをここに閉じ込めた例
/// 親の GuildManagePage は、この GuildManagementContent をそのまま body に置くだけ
class GuildManagementContent extends HookConsumerWidget {
  const GuildManagementContent({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final picker = useMemoized(ImagePicker.new);
    final imageFileState = useState<File?>(null);
    final isLoadingState = useState(false);

    // ギルド情報の AsyncValue
    final myGuildAsyncValue = ref.watch(getMyGuildNotifierProvider);

    // リフレッシュ処理
    Future<void> onRefresh() async {
      try {
        await ref.read(getMyGuildNotifierProvider.notifier).getMyGuild();
      } on Exception catch (error) {
        if (context.mounted) {
          showErrorSnackBar(context, error);
        }
      }
    }

    // ギルド削除
    Future<void> onTapDeleteGuild() async {
      final confirm = await showDialog<bool>(
        context: context,
        builder: (context) => const DeleteGuildDialog(),
      );

      if (confirm != true) {
        return;
      }

      try {
        // ローディング開始
        isLoadingState.value = true;

        await ref.read(deleteGuildNotifierProvider.notifier).deleteGuild();

        // 削除後リフレッシュ
        await onRefresh();

        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Guild deleted successfully.'),
            ),
          );
        }

        // 前の画面に戻る
        if (context.mounted) {
          context.pop();
        }
      } on Exception catch (error) {
        if (context.mounted) {
          showErrorSnackBar(context, error);
        }
      } finally {
        // ローディング解除
        isLoadingState.value = false;
      }
    }

    // ギルドアイコン（写真）選択 & クロップ
    Future<void> pickAndCropImage() async {
      final pickedFile = await picker.pickImage(source: ImageSource.gallery);
      if (pickedFile == null) {
        debugPrint('Image selection cancelled');
        return;
      }

      final croppedFile = await ImageCropper().cropImage(
        sourcePath: pickedFile.path,
        aspectRatio: const CropAspectRatio(ratioX: 1, ratioY: 1),
        uiSettings: [
          AndroidUiSettings(
            hideBottomControls: true,
            lockAspectRatio: true,
          ),
          IOSUiSettings(
            aspectRatioLockEnabled: true,
          ),
        ],
      );

      if (croppedFile == null) {
        debugPrint('Cropping cancelled');
        return;
      }

      if (!context.mounted) {
        return;
      }

      imageFileState.value = File(croppedFile.path);
      debugPrint('Cropped image path: ${imageFileState.value!.path}');

      try {
        // TODO: 実際のギルドアイコンアップロードAPIを呼ぶ
        await ref.read(updateGuildNotifierProvider.notifier).updateGuildAvatar(
              UriExtensions.randomImageUrlWithTitle(
                TimeOfDay.now().format(context),
              ).toString(),
            );

        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(
              content: Text('Updated Successfully'),
            ),
          );
        }

        await onRefresh();
      } on Exception catch (error) {
        if (context.mounted) {
          showErrorSnackBar(context, error);
        }
      }
    }

    // アバター写真がタップされた時
    Future<void> onTapGuildPhoto() async {
      await showDialog<void>(
        context: context,
        builder: (context) => AlertDialog(
          insetPadding: const EdgeInsets.symmetric(horizontal: 16),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(8),
          ),
          backgroundColor: ColorPallet.gray800,
          title: const Text('Guild Icon Editor'),
          content: const Text('Coming Soon!'),
          actions: [
            TextButton(
              onPressed: () => context.pop(),
              child: const Text('OK'),
            ),
          ],
        ),
      );
      // 実装するなら下記のように。いったん return して実装を止めています。
      return;

      // TODO: [フェーズ2] 画像アップロード機能を実装する
      final hasPermission = await _hasPhotoPermission(context);
      if (hasPermission) {
        await pickAndCropImage();
      }
    }

    // ギルド名更新
    Future<void> onTapSaveName(String updatedText, String currentGuildName) async {
      try {
        if (updatedText.isNotEmpty && updatedText != currentGuildName) {
          await ref
              .read(updateGuildNotifierProvider.notifier)
              .updateGuildName(updatedText);

          // Refresh guild information
          await onRefresh();

          // show snackbar
          if (context.mounted) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text('Guild name updated to $updatedText'),
              ),
            );
          }
        }
      } on Exception catch (error) {
        if (context.mounted) {
          showErrorSnackBar(context, error);
        }
      }
    }

    // 申請ユーザの「却下」
    Future<void> onTapReject({
      required String guildId,
      required String userId,
      required String userName,
    }) async {
      try {
        await ref
            .read(rejectGuildNotifierProvider.notifier)
            .rejectGuild(guildId: guildId, userId: userId);

        // ギルド情報リフレッシュ
        await onRefresh();

        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text('Rejected $userName'),
            ),
          );
        }
      } on Exception catch (error) {
        if (context.mounted) {
          showErrorSnackBar(context, error);
        }
      }
    }

    // 申請ユーザの「承認」
    Future<void> onTapApprove({
      required String guildId,
      required String userId,
      required String userName,
    }) async {
      try {
        await ref
            .read(approveGuildNotifierProvider.notifier)
            .approveGuild(guildId: guildId, userId: userId);

        // ギルド情報リフレッシュ
        await onRefresh();

        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text('Approved $userName'),
            ),
          );
        }
      } on Exception catch (error) {
        if (context.mounted) {
          showErrorSnackBar(context, error);
        }
      }
    }

    // 初回表示時にリフレッシュ
    useEffect(() {
      Future.microtask(() async {
        await onRefresh();
      });
      return null;
    }, []);

    // 画面本体
    return RefreshIndicator(
      onRefresh: onRefresh,
      color: ColorToken.primary,
      backgroundColor: ColorToken.bgLight,
      child: myGuildAsyncValue.when(
        data: (guild) {
          if (guild == null) {
            return const SizedBox.shrink();
          }

          final guildId = guild.guildId ?? 'Unknown';
          final guildName = guild.guildName ?? 'No Name';
          final guildAvatar = guild.guildAvatar ?? '';
          final guildMembers = guild.guildMembers ?? <GuildMemberDto>[];

          return SingleChildScrollView(
            physics: const AlwaysScrollableScrollPhysics(),
            child: Padding(
              padding: const EdgeInsets.symmetric(horizontal: 20),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const SizedBox(height: 32),
                  // ギルドアバター
                  Center(
                    child: GestureDetector(
                      onTap: () => onTapGuildPhoto(),
                      child: Stack(
                        alignment: Alignment.center,
                        children: [
                          GuildIcon(
                            guildId: guildId,
                            guildAvatar: guildAvatar,
                          ),
                          Container(
                            width: 64,
                            height: 64,
                            decoration: BoxDecoration(
                              color: Colors.black.withAlpha(180),
                              borderRadius: BorderRadius.circular(8),
                            ),
                          ),
                          const Icon(
                            Icons.camera_alt,
                            size: 24,
                            color: Colors.white,
                          ),
                        ],
                      ),
                    ),
                  ),

                  const SizedBox(height: 32),
                  // ギルド名編集
                  Material(
                    color: Colors.transparent,
                    child: InkWell(
                      onTap: () {
                        context.push(
                          Screen.textEditing.path,
                          extra: TextEditingPageArgs(
                            title: 'Name',
                            text: guildName,
                            hintText: 'Enter guild name',
                            onSave: (updatedText) async {
                              await onTapSaveName(updatedText, guildName);
                            },
                          ),
                        );
                      },
                      borderRadius: BorderRadius.circular(8),
                      child: Container(
                        padding: const EdgeInsets.symmetric(vertical: 8),
                        child: Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          children: [
                            const Text(
                              'Name',
                              style: TextStyle(
                                fontSize: 16,
                                color: ColorPallet.gray300,
                              ),
                            ),
                            const SizedBox(width: 8),
                            Flexible(
                              child: Row(
                                mainAxisSize: MainAxisSize.min,
                                children: [
                                  Flexible(
                                    child: Text(
                                      guildName,
                                      style: const TextStyle(fontSize: 16),
                                      maxLines: 1,
                                      overflow: TextOverflow.ellipsis,
                                    ),
                                  ),
                                  const SizedBox(width: 8),
                                  const Icon(
                                    Icons.chevron_right,
                                    color: ColorToken.text,
                                    size: 20,
                                  ),
                                ],
                              ),
                            ),
                          ],
                        ),
                      ),
                    ),
                  ),

                  const SizedBox(height: 32),
                  const Divider(color: ColorToken.secondary),
                  const SizedBox(height: 32),

                  // 申請中メンバー一覧
                  _buildRequestedMembers(
                    context: context,
                    guildId: guildId,
                    guildMembers: guildMembers,
                    onTapReject: onTapReject,
                    onTapApprove: onTapApprove,
                  ),

                  // ギルド削除ボタン
                  Padding(
                    padding: const EdgeInsets.only(top: 24, bottom: 24),
                    child: OutlinedButton(
                      onPressed: isLoadingState.value
                          ? null
                          : () async {
                              await onTapDeleteGuild();
                            },
                      child: const Text('Delete this guild'),
                    ),
                  ),
                ],
              ),
            ),
          );
        },
        loading: () => const Center(child: CircularProgressIndicator()),
        error: (error, _) => Center(child: Text('Error: $error')),
      ),
    );
  }

  /// 申請中メンバー一覧表示
  Widget _buildRequestedMembers({
    required BuildContext context,
    required String guildId,
    required List<GuildMemberDto> guildMembers,
    required Future<void> Function({
      required String guildId,
      required String userId,
      required String userName,
    }) onTapReject,
    required Future<void> Function({
      required String guildId,
      required String userId,
      required String userName,
    }) onTapApprove,
  }) {
    final requestedMembers = guildMembers
        .where(
          (member) =>
              member.memberStatus == GuildMemberDtoMemberStatus.REQUESTED,
        )
        .toList();

    if (requestedMembers.isEmpty) {
      return const Center(
        child: Padding(
          padding: EdgeInsets.only(bottom: 180),
          child: Text('No members requesting to join.'),
        ),
      );
    }

    return Padding(
      padding: const EdgeInsets.only(bottom: 180),
      child: ListView.builder(
        shrinkWrap: true,
        physics: const NeverScrollableScrollPhysics(),
        itemCount: requestedMembers.length,
        itemBuilder: (context, index) {
          final member = requestedMembers[index];
          final userId = member.userId ?? '';
          final userName = member.username ?? '';
          final avatarUrl = member.avatar;
          final cameraList =
              member.decks?.firstOrNull?.deckCameras?.sorted() ?? [];

          return Padding(
            padding: const EdgeInsets.only(bottom: 8),
            child: DecoratedBox(
              decoration: BoxDecoration(
                color: ColorToken.bg,
                borderRadius: BorderRadius.circular(4),
                border: Border.all(color: ColorToken.defaultBorder),
              ),
              child: Padding(
                padding: const EdgeInsets.all(16),
                child: Column(
                  children: [
                    // ユーザー情報
                    Row(
                      children: [
                        Expanded(
                          child: GuildMemberColumn(
                            userName: userName,
                            isGuildOwner: false,
                            userPhotoUrl: avatarUrl,
                            cameraList: cameraList,
                          ),
                        ),
                        Expanded(
                          child: ParametersBarColumn(
                            searchQ: member.decks?.firstOrNull?.searchQ ?? 0,
                            attackE: member.decks?.firstOrNull?.attackE ?? 0,
                            luckL: member.decks?.firstOrNull?.luckL ?? 0,
                            defenseB: member.decks?.firstOrNull?.defenseB ?? 0,
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 16),
                    // 承認・却下ボタン
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Flexible(
                          child: OutlinedButton(
                            onPressed: () async {
                              await onTapReject(
                                guildId: guildId,
                                userId: userId,
                                userName: userName,
                              );
                            },
                            style: OutlinedButton.styleFrom(
                              minimumSize: const Size.fromHeight(32),
                            ),
                            child: const Text(
                              'Reject',
                              style: TextStyle(fontSize: 12),
                            ),
                          ),
                        ),
                        const SizedBox(width: 12),
                        Flexible(
                          child: ElevatedButton(
                            onPressed: () async {
                              await onTapApprove(
                                guildId: guildId,
                                userId: userId,
                                userName: userName,
                              );
                            },
                            style: OutlinedButton.styleFrom(
                              minimumSize: const Size.fromHeight(32),
                            ),
                            child: const Text(
                              'Approve',
                              style: TextStyle(fontSize: 12),
                            ),
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ),
          );
        },
      ),
    );
  }

  /// 写真の権限確認
  Future<bool> _hasPhotoPermission(BuildContext context) async {
    final status = await Permission.photos.request();
    switch (status) {
      case PermissionStatus.granted:
      case PermissionStatus.limited:
        return true;
      case PermissionStatus.permanentlyDenied:
        if (context.mounted) {
          _showPermissionDialog(context);
        }
        return false;
      default:
        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('Access to photos is not granted.')),
          );
        }
        return false;
    }
  }

  /// 権限が永久拒否の場合のダイアログ
  void _showPermissionDialog(BuildContext context) {
    showDialog<void>(
      context: context,
      builder: (context) => AlertDialog(
        insetPadding: const EdgeInsets.symmetric(horizontal: 16),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
        backgroundColor: ColorPallet.gray800,
        title: const Text('Permission to access photos is required'),
        content: const Text('Enable photo access in settings to select a photo.'),
        actions: [
          TextButton(
            onPressed: () => context.pop(),
            child: const Text('Cancel'),
          ),
          TextButton(
            onPressed: () async {
              await openAppSettings();
            },
            child: const Text('Open Settings'),
          ),
        ],
      ),
    );
  }
}
```

---

## ポイント

1. **親 `GuildManagePage` を最小限にする**  
   - ここでは `Scaffold` と `AppBar` だけを残し、`body` に `GuildManagementContent` を配置しています。  
   - すべてのロジック・リフレッシュ処理・API呼び出し等は新規作成した子 `HookConsumerWidget` に集約。

2. **子 `GuildManagementContent` が `HookConsumerWidget`**  
   - `build` メソッド内で `ref.watch(...)` や `ref.read(...)` を使い放題になります。
   - 親で `ref` を引き回す必要がなくなります。

3. **削除ボタン(onTapDeleteGuild) やリフレッシュ(onRefresh) も子ウィジェット内で完結**  
   - これにより「コメントアウトされていたギルド削除ボタン」や、そこから呼ばれる `onTapDeleteGuild` の実装、さらに削除後のリフレッシュまで一貫して子で行えます。
   - 親 `GuildManagePage` 側のロジックをスッキリさせられます。

4. **`RefreshIndicator` も子ウィジェット内で完結させる**  
   - `myGuildAsyncValue.when(...)` の中でギルド情報を表示しているので、その周りを `RefreshIndicator` で包めばOK。  
   - `useEffect` (初回表示時に非同期処理を走らせる) も同じウィジェット内にまとめています。

---

上記のやり方であれば、**「`ref` 引数を全体で引き回す」ことなく**、  
`onTapDeleteGuild` をはじめとした API 呼び出しやリフレッシュ処理を、ひとまとめに管理できます。  

もし「アプリによっては親にも何らかのロジックが必要」というケースなら、必要最小限のデータやコールバックだけを `GuildManagementContent` へ渡す形に調整してみてください。

---

## 👤 User
*2025-02-14 15:34:46*

Widget _buildRequestedMembers({ を別のHookConsumerWidgetにしたほうが、関数を引数に回さないので良くないか？

---

## 🔧 Tool
*2025-02-14 15:35:25*

**分離して構築する**

_RequestedMembersSectionウィジェットを独立させ、guilIdとguildMembersリストを直接受け取る。コールバックは引数またはrefから取得する。getMyGuildNotifierProviderを使用してguildIdとメンバーを監視する。

**整理していると**

refの通知を使い、rejectやapproveの処理をする。guildIdやメンバーを引数として渡したり、親から直接読んだりする方法も探っている。

**親の提供元からの読み込み**

親の提供元から直接guildIdを取得して、子ウィジェット内でrefreshを行う方法を模索している。パラメータを渡さずに解決しようとしている。

**データ読み込みとロジック移管**

`RequestedMembersSection`を作成し、`getMyGuildNotifierProvider`を使用してデータを読み込み、おそらく親からのリフレッシュを引数で渡している。ここでの作業進捗を見守る。

**作業の進行**

ユーザーの希望を受けて、_buildRequestedMembersのロジックを独立させ、子ウィジェットにデータの取得とリフレッシュを担当させる方法を示すコードスニペットを作成している。

---

## 🤖 Assistant
*2025-02-14 15:35:25*

もちろん、**`_buildRequestedMembers`** を別の **`HookConsumerWidget`** に切り出す設計はアリです。  
「関数を引数として渡さずに済む」「UIパーツごとに責務を分割しやすい」などのメリットがあります。

---

## 別 `HookConsumerWidget` へ切り出す例

以下はサンプルとして、`_buildRequestedMembers` の中身を **`RequestedMembersSection`** という **`HookConsumerWidget`** に分離した例です。

### 1. 親ウィジェット (`GuildManagementContent` など) 側のコード

```dart
import 'package:flutter/material.dart';
import 'package:hooks_riverpod/hooks_riverpod.dart';

/// 親ウィジェット例 (GuildManagementContent)
class GuildManagementContent extends HookConsumerWidget {
  const GuildManagementContent({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // ... 省略: ギルド情報を取得 (myGuildAsyncValue) するなどのロジック ...

    return myGuildAsyncValue.when(
      data: (guild) {
        if (guild == null) {
          return const SizedBox.shrink();
        }
        final guildId = guild.guildId ?? 'Unknown';
        final guildMembers = guild.guildMembers ?? [];

        return SingleChildScrollView(
          child: Column(
            children: [
              // ... 省略: ギルド情報やギルド名編集用のUI ...

              // ここで RequestedMembersSection を配置する
              RequestedMembersSection(
                guildId: guildId,
                guildMembers: guildMembers,
              ),

              // ... 省略: ギルド削除ボタンなど ...
            ],
          ),
        );
      },
      loading: () => const Center(child: CircularProgressIndicator()),
      error: (error, _) => Center(child: Text(error.toString())),
    );
  }
}
```

- 親では、**`guildId`** と **`guildMembers`** だけを **`RequestedMembersSection`** に渡しています。
- 「承認/却下」などのコールバックは **渡していません**。代わりに **子ウィジェット内で `ref.read(...)` して処理** します。

---

### 2. 子ウィジェット (`RequestedMembersSection`) の実装

```dart
import 'package:flutter/material.dart';
import 'package:hooks_riverpod/hooks_riverpod.dart';

// 以下は実際のパスに合わせて import を調整してください
import 'package:snpit_guild_app/infrastructure/snapit_guild_api/snapit_guild_api.openapi.dart';
import 'package:snpit_guild_app/presentation/providers/api_client/guilds/get_guild.dart';
import 'package:snpit_guild_app/presentation/providers/api_client/guilds/update_guild_member.dart';
import 'package:snpit_guild_app/utils/snack_bar_utils.dart';
import 'package:snpit_guild_app/domain/design/color_token.dart';
import 'package:snpit_guild_app/presentation/widgets/guild_member_column.dart';
import 'package:snpit_guild_app/presentation/widgets/parameters_bar_column.dart';

/// 申請中メンバー一覧表示用の HookConsumerWidget
class RequestedMembersSection extends HookConsumerWidget {
  const RequestedMembersSection({
    Key? key,
    required this.guildId,
    required this.guildMembers,
  }) : super(key: key);

  final String guildId;
  final List<GuildMemberDto> guildMembers;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // 申請中のメンバーを絞り込む
    final requestedMembers = guildMembers.where(
      (m) => m.memberStatus == GuildMemberDtoMemberStatus.REQUESTED,
    ).toList();

    // 申請中メンバーがいない場合の表示
    if (requestedMembers.isEmpty) {
      return const Center(
        child: Padding(
          padding: EdgeInsets.only(bottom: 180),
          child: Text('No members requesting to join.'),
        ),
      );
    }

    return Padding(
      padding: const EdgeInsets.only(bottom: 180),
      child: ListView.builder(
        shrinkWrap: true,
        physics: const NeverScrollableScrollPhysics(),
        itemCount: requestedMembers.length,
        itemBuilder: (context, index) {
          final member = requestedMembers[index];
          final userId = member.userId ?? '';
          final userName = member.username ?? '';
          final avatarUrl = member.avatar;
          final cameraList = member.decks?.firstOrNull?.deckCameras ?? [];

          return Padding(
            padding: const EdgeInsets.only(bottom: 8),
            child: DecoratedBox(
              decoration: BoxDecoration(
                color: ColorToken.bg,
                borderRadius: BorderRadius.circular(4),
                border: Border.all(color: ColorToken.defaultBorder),
              ),
              child: Padding(
                padding: const EdgeInsets.all(16),
                child: Column(
                  children: [
                    // ユーザー情報
                    Row(
                      children: [
                        Expanded(
                          child: GuildMemberColumn(
                            userName: userName,
                            isGuildOwner: false,
                            userPhotoUrl: avatarUrl,
                            cameraList: cameraList.sorted(), // 拡張メソッドがあれば
                          ),
                        ),
                        Expanded(
                          child: ParametersBarColumn(
                            searchQ: member.decks?.firstOrNull?.searchQ ?? 0,
                            attackE: member.decks?.firstOrNull?.attackE ?? 0,
                            luckL: member.decks?.firstOrNull?.luckL ?? 0,
                            defenseB: member.decks?.firstOrNull?.defenseB ?? 0,
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 16),
                    // 承認・却下ボタン
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Flexible(
                          child: OutlinedButton(
                            onPressed: () async {
                              await _onTapReject(
                                context: context,
                                ref: ref,
                                guildId: guildId,
                                userId: userId,
                                userName: userName,
                              );
                            },
                            style: OutlinedButton.styleFrom(
                              minimumSize: const Size.fromHeight(32),
                            ),
                            child: const Text('Reject', style: TextStyle(fontSize: 12)),
                          ),
                        ),
                        const SizedBox(width: 12),
                        Flexible(
                          child: ElevatedButton(
                            onPressed: () async {
                              await _onTapApprove(
                                context: context,
                                ref: ref,
                                guildId: guildId,
                                userId: userId,
                                userName: userName,
                              );
                            },
                            style: ElevatedButton.styleFrom(
                              minimumSize: const Size.fromHeight(32),
                            ),
                            child: const Text('Approve', style: TextStyle(fontSize: 12)),
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ),
          );
        },
      ),
    );
  }

  /// 承認ボタン押下
  Future<void> _onTapApprove({
    required BuildContext context,
    required WidgetRef ref,
    required String guildId,
    required String userId,
    required String userName,
  }) async {
    try {
      await ref.read(approveGuildNotifierProvider.notifier)
          .approveGuild(guildId: guildId, userId: userId);

      // 成功したらリフレッシュ
      await ref.read(getMyGuildNotifierProvider.notifier).getMyGuild();

      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Approved $userName')),
        );
      }
    } catch (error) {
      if (context.mounted) {
        showErrorSnackBar(context, error);
      }
    }
  }

  /// 却下ボタン押下
  Future<void> _onTapReject({
    required BuildContext context,
    required WidgetRef ref,
    required String guildId,
    required String userId,
    required String userName,
  }) async {
    try {
      await ref.read(rejectGuildNotifierProvider.notifier)
          .rejectGuild(guildId: guildId, userId: userId);

      // 成功したらリフレッシュ
      await ref.read(getMyGuildNotifierProvider.notifier).getMyGuild();

      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Rejected $userName')),
        );
      }
    } catch (error) {
      if (context.mounted) {
        showErrorSnackBar(context, error);
      }
    }
  }
}
```

- 上記のように、**承認/却下のメソッド**（`_onTapApprove` / `_onTapReject`）を 子ウィジェット内に定義 し、`ref.read(...)` で各 NotifierProvider を直接呼び出しています。
- 処理後には同じく 子ウィジェット内から `ref.read(getMyGuildNotifierProvider.notifier).getMyGuild()` を呼び、**自分でリフレッシュ** しています。
- これにより、**親からコールバック関数を引数でもらわず** に完結できます。

---

## 「切り出すメリット」 vs 「切り出さないメリット」

- **切り出すメリット**  
  - 親ウィジェットがシンプルになり、**申請一覧に関わる処理をまるごとカプセル化** できる。  
  - コールバック引数をたくさん渡さなくていいので、見通しが良くなる。

- **切り出さないメリット**  
  - 親ウィジェットの状態や関数で一括管理できるので、**画面単位で把握しやすい** 場合もある。  
  - わざわざ別ウィジェットにするほどでもないボリュームなら、同じクラスに書いておいたほうが一貫する可能性もある。

最終的には、**ロジックの量** や **再利用の有無**、**保守性** などを考慮して、プロジェクト方針に合わせて決めればOKです。  

---

## まとめ

- **`_buildRequestedMembers(...)`** のように機能がはっきり分かれている部分は、**別 `HookConsumerWidget`** として切り出すと「コードの分割」が進んで読みやすくなります。
- 親からのコールバック関数を大量に渡すより、**子ウィジェット側で `ref.read(...)` や `ref.watch(...)`** をするほうがシンプルに管理できるケースも多いです。

---
