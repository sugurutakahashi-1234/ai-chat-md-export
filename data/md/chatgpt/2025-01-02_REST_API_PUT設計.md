# REST API PUT設計

日付: 2025-01-02

---

## 👤 ユーザー
*2025/1/2 22:01:31*

RESTAPI PUT のインターフェース

---

## 🤖 アシスタント
*2025/1/2 22:01:43*

REST APIで`PUT`メソッドを使用する際のインターフェース設計について、以下の点を考慮します。`PUT`メソッドは通常、**リソースを置き換える**または**作成する**ために使用されます。

---

### 1. **基本的な設計ルール**
- **エンドポイント**: `PUT /resource/{id}`
  - `id`は、リソースの一意の識別子。
- **HTTP メソッド**: `PUT`
- **リクエストボディ**:
  - リソースの**完全な状態**を表す必要があります。
  - 部分的な更新の場合は`PATCH`を使用。
- **レスポンス**:
  - 正常に更新された場合は通常`200 OK`または`204 No Content`を返す。
  - 作成された場合は`201 Created`を返す。

---

### 2. **リクエスト例**
エンドポイント:  
`PUT /users/123`

リクエストヘッダー:
```http
Content-Type: application/json
Authorization: Bearer <token>
```

リクエストボディ:
```json
{
  "id": 123,
  "name": "John Doe",
  "email": "john.doe@example.com",
  "isActive": true
}
```

---

### 3. **レスポンス例**

#### **更新成功時**
- ステータスコード: `200 OK` または `204 No Content`（レスポンスボディなし）
- レスポンスボディ例（`200 OK`の場合）:
```json
{
  "id": 123,
  "name": "John Doe",
  "email": "john.doe@example.com",
  "isActive": true,
  "updatedAt": "2025-01-02T10:00:00Z"
}
```

#### **新規作成時**
- ステータスコード: `201 Created`
- レスポンスヘッダー: `Location`に新しいリソースのURLを含む。
```http
Location: /users/123
```
- レスポンスボディ例:
```json
{
  "id": 123,
  "name": "John Doe",
  "email": "john.doe@example.com",
  "isActive": true,
  "createdAt": "2025-01-02T10:00:00Z"
}
```

#### **エラー時**
- ステータスコード: `400 Bad Request`
- レスポンスボディ例:
```json
{
  "error": "Invalid request",
  "details": {
    "email": "Email format is invalid"
  }
}
```

---

### 4. **実装のポイント**
- **リソースの全置換**: `PUT`では、指定されたIDのリソース全体を新しいデータで置き換える必要がある。
  - 一部のプロパティのみを更新する場合は`PATCH`を検討。
- **リクエストの妥当性チェック**: 入力データのフォーマットや値の範囲をサーバー側で検証する。
- **冪等性の確保**: 同じ`PUT`リクエストを何度送信しても結果が変わらない設計にする。

---

### 5. **テストケース**
- **正常系**
  - 有効なデータを使った更新と新規作成の検証。
- **異常系**
  - 不正なデータ形式（例: JSONの欠落フィールド）。
  - 存在しないIDへのリクエスト。
  - 認証エラー（トークンが無効/未提供）。

---

これをベースに、具体的なユースケースやAPI仕様に応じて調整できます。詳しく知りたい場合は教えてください！

---

## 👤 ユーザー
*2025/1/2 22:02:08*

PATCH とは？

---

## 🤖 アシスタント
*2025/1/2 22:02:46*

`PATCH` は、REST API で部分的なリソース更新を行うための HTTP メソッドです。以下で詳細を説明します。

---

## **PATCH の特徴**
1. **部分更新**: リソースの一部のプロパティだけを更新するのに使用します。`PUT` がリソース全体を置き換えるのに対して、`PATCH` は部分的な変更に適しています。
2. **冪等性**: 通常は冪等的であるべきですが、実装次第で非冪等になることもあります（注意が必要です）。
   - 冪等性とは: 同じリクエストを何度送信しても結果が変わらない性質。
3. **リソースの存在確認**: 
   - リソースが存在する場合: 部分更新を行う。
   - 存在しない場合: 多くの場合、エラーを返す（`404 Not Found`）。
   - （一部の実装では）リソースを新規作成することも可能。

---

## **エンドポイント例**
エンドポイント:  
`PATCH /users/123`

---

## **リクエスト例**

リクエストヘッダー:
```http
Content-Type: application/json
Authorization: Bearer <token>
```

### **1. プロパティの部分更新**
リクエストボディ:
```json
{
  "name": "Jane Doe"
}
```

このリクエストは、ユーザーID `123` の `name` プロパティのみを更新します。

---

### **2. 配列の一部変更**
リクエストボディ:
```json
{
  "roles": ["admin", "editor"]
}
```

この場合、`roles` プロパティを完全に置き換えます（部分的な要素追加/削除が必要な場合は、パッチ操作が必要です）。

---

## **レスポンス例**

### **更新成功時**
- ステータスコード: `200 OK` または `204 No Content`
- レスポンスボディ例（`200 OK`の場合）:
```json
{
  "id": 123,
  "name": "Jane Doe",
  "email": "john.doe@example.com",
  "isActive": true,
  "updatedAt": "2025-01-02T10:00:00Z"
}
```

---

### **エラー時**
#### **1. 不正なリクエスト**
- ステータスコード: `400 Bad Request`
- レスポンスボディ例:
```json
{
  "error": "Invalid request",
  "details": {
    "name": "Name cannot be empty"
  }
}
```

#### **2. リソースが存在しない場合**
- ステータスコード: `404 Not Found`
- レスポンスボディ例:
```json
{
  "error": "User not found"
}
```

---

## **PATCH と PUT の違い**

| 特徴             | PUT                               | PATCH                            |
|------------------|----------------------------------|----------------------------------|
| **用途**          | リソース全体を置き換える              | リソースの一部を更新する              |
| **冪等性**        | 必ず冪等                          | 通常は冪等だが、非冪等になる場合もある |
| **リクエストボディ** | 全プロパティが必須                   | 必要なプロパティのみ送信する           |

---

## **PATCH を使うべき場面**
- 更新対象がリソース全体ではなく一部のプロパティに限定されている場合。
- リソースの部分的な更新で効率性を重視したい場合（例: ネットワーク帯域の節約）。

---

### **注意点**
- **JSON Merge Patch**:
  - 部分更新の標準仕様（[RFC 7396](https://www.rfc-editor.org/rfc/rfc7396)）に従い、オブジェクトをマージする形でリソースを更新。
- **JSON Patch**:
  - 操作を明確に定義する仕様（[RFC 6902](https://www.rfc-editor.org/rfc/rfc6902)）。例:
    ```json
    [
      { "op": "replace", "path": "/name", "value": "Jane Doe" }
    ]
    ```

---

何か具体的な実装や例について質問があれば、気軽に聞いてください！

---
