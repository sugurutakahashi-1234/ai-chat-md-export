# GoRouter タブページ設定

Date: 2024-12-07

---

## 👤 User
*2024-12-07 23:58:55*

本当は loginから tab_page に行っているので、tab_
pageをrouterにうまく表現したいのだけれどもできないのか？

// Package imports:
import 'package:go_router/go_router.dart';

// Project imports:
import 'package:flutter_sample_app/pages/account_page.dart';
import 'package:flutter_sample_app/pages/notification_list_page.dart';
import 'pages/guild_page.dart';
import 'pages/login_page.dart';
import 'pages/map_page.dart';
import 'pages/tab_page.dart';

final GoRouter router = GoRouter(
  initialLocation: '/login',
  routes: [
    GoRoute(
      path: '/login',
      builder: (context, state) =&gt; const LoginPage(),
    ),
    GoRoute(
      path: '/notification_list',
      builder: (context, state) =&gt; const NotificationListPage(),
    ),
    GoRoute(
      path: '/account',
      builder: (context, state) =&gt; const AccountPage(),
    ),
    StatefulShellRoute.indexedStack(
      builder: (context, state, navigationShell) =&gt; TabPage(navigationShell: navigationShell),
      branches: [
        StatefulShellBranch(
          routes: [
            GoRoute(
              path: '/map',
              builder: (context, state) =&gt; const MapPage(),
            ),
          ],
        ),
        StatefulShellBranch(
          routes: [
            GoRoute(
              path: '/guild',
              builder: (context, state) =&gt; const GuildPage(),
            ),
          ],
        ),
      ],
    ),
  ],
);

// Flutter imports:
import 'package:flutter/material.dart';

// Package imports:
import 'package:go_router/go_router.dart';

class TabPage extends StatelessWidget {

  const TabPage({required this.navigationShell, super.key});
  final StatefulNavigationShell navigationShell;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        leadingWidth: 100,
        leading: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            IconButton(
              icon: const Icon(Icons.person),
              onPressed: () {
                context.push('/account');
              },
            ),
            IconButton(
              icon: const Icon(Icons.notifications),
              onPressed: () {
                context.push('/notification_list');
              },
            ),
          ],
        ),
        actions: const [
          Padding(
            padding: EdgeInsets.only(right: 16),
            child: Row(
              children: [
                Icon(Icons.token, size: 20),
                SizedBox(width: 4),
                Text('35.05 STP'),
              ],
            ),
          ),
        ],
      ),
      body: navigationShell,
      bottomNavigationBar: BottomNavigationBar(
        currentIndex: navigationShell.currentIndex,
        onTap: navigationShell.goBranch,
        items: const [
          BottomNavigationBarItem(icon: Icon(Icons.map), label: 'Map'),
          BottomNavigationBarItem(icon: Icon(Icons.group), label: 'Guild'),
        ],
      ),
    );
  }
}

// Flutter imports:
import 'package:flutter/material.dart';

// Package imports:
import 'package:go_router/go_router.dart';
import 'package:hooks_riverpod/hooks_riverpod.dart';
import 'package:openapi/openapi.dart';

// Project imports:
import 'package:flutter_sample_app/providers/current_user.dart';

class LoginPage extends HookConsumerWidget {
  const LoginPage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return Scaffold(
      appBar: AppBar(title: const Text('Login')),
      body: Center(
        child: ElevatedButton(
          onPressed: () async {
            final notifier = ref.read(currentUserNotifierProvider.notifier);
            try {
              final user = await fetchRandomUser();
              debugPrint('Setting user: ${user.name}, ID: ${user.id}');
              notifier.updateUser(user);

              if (context.mounted) {
                context.go('/map');
              }
            } on Exception catch (e) {
              debugPrint('Login failed: $e');
            }
          },
          child: const Text('Login'),
        ),
      ),
    );
  }

  Future&lt;User&gt; fetchRandomUser() async {
    final api = Openapi().getDefaultApi();
    try {
      final response = await api.getUsers();
      if (response.data == null) {
        throw Exception('Response data is null.');
      }

      final users = response.data!.toList();
      if (users.isEmpty) {
        throw Exception('No users available.');
      }

      users.shuffle();

      final selectedUser = users.first;
      debugPrint('Selected random user: ${selectedUser.name}, ID: ${selectedUser.id}');
      return selectedUser;

    } catch (e, stackTrace) {
      debugPrint('Error fetching users: $e');
      debugPrint('Stack trace: $stackTrace');
      rethrow;
    }
  }
}

---

## 🤖 Assistant
*2024-12-07 23:59:10*

GoRouterの構造で`tab_page`をうまく表現するには、`StatefulShellRoute`を適切に定義し、その下に`map`や`guild`のルートを構成する必要があります。また、`login`からの遷移が`tab_page`に直接つながるように初期ルートの切り替えを調整することが重要です。

以下は修正された構成です。ポイントは、`tab_page`を明示的に`GoRoute`の階層に追加し、そこから`StatefulShellRoute`に接続することです。

### 修正版

```dart
final GoRouter router = GoRouter(
  initialLocation: '/login',
  routes: [
    GoRoute(
      path: '/login',
      builder: (context, state) => const LoginPage(),
    ),
    GoRoute(
      path: '/notification_list',
      builder: (context, state) => const NotificationListPage(),
    ),
    GoRoute(
      path: '/account',
      builder: (context, state) => const AccountPage(),
    ),
    GoRoute(
      path: '/tab_page',
      builder: (context, state) => const TabPageShell(),
      routes: [
        StatefulShellRoute.indexedStack(
          builder: (context, state, navigationShell) => TabPage(navigationShell: navigationShell),
          branches: [
            StatefulShellBranch(
              routes: [
                GoRoute(
                  path: 'map',
                  builder: (context, state) => const MapPage(),
                ),
              ],
            ),
            StatefulShellBranch(
              routes: [
                GoRoute(
                  path: 'guild',
                  builder: (context, state) => const GuildPage(),
                ),
              ],
            ),
          ],
        ),
      ],
    ),
  ],
);
```

### 修正ポイント

1. **`tab_page`の追加**:
   - 明示的に`/tab_page`を`GoRoute`として定義しました。
   - これにより、`/login`から`/tab_page`への遷移が分かりやすくなります。

2. **`StatefulShellRoute`のネスト**:
   - `tab_page`内に`StatefulShellRoute`をネストすることで、`map`と`guild`のルートを明確に区別しました。

3. **`LoginPage`の遷移先変更**:
   - `LoginPage`内の`context.go('/map')`を`context.go('/tab_page/map')`に変更します。
   - これにより、`tab_page`を経由して適切な画面に遷移します。

### `LoginPage`の修正

以下のように変更します:

```dart
if (context.mounted) {
  context.go('/tab_page/map');
}
```

この構成により、ルート階層が明確になり、将来的な拡張も容易になります。

---

## 👤 User
*2024-12-07 23:59:29*

TabPageShell とは？

---

## 🤖 Assistant
*2024-12-07 23:59:47*

`TabPageShell` は今回のコードには存在しない名前ですが、上記の例で提案したのは、`GoRouter`のルート構成を整理する際の「シェル」としての役割を表現するものです。実際には、この名前は具体的な実装を持たない「ラッパー的な役割をするクラス」を意味しています。

### 背景
- Flutterで`StatefulShellRoute`を使用する場合、その「ルートを持つ親コンテナ」に明示的な構造を設けることで、`GoRouter`の可読性を高めることができます。
- 提案された`TabPageShell`は、この「親コンテナ」を意味します。実際の`TabPageShell`は単にルートの整理をするためのラベルとして使用されています。

---

### `TabPageShell`の例
`TabPageShell`自体は以下のように簡単に定義できます。必要に応じて、このクラスを削除して直接ルート構成を定義することもできます。

#### シンプルな実装
```dart
import 'package:flutter/material.dart';

class TabPageShell extends StatelessWidget {
  const TabPageShell({super.key});

  @override
  Widget build(BuildContext context) {
    return const SizedBox.shrink(); // 実際にUIは不要
  }
}
```

- `SizedBox.shrink()`を返すことで、UIとしては何も描画しません。
- このクラスは、ただの「ルート構造を整理するための目印」として使われます。

---

### `TabPageShell`が不要な場合
もし`TabPageShell`を使いたくない場合は、`StatefulShellRoute`を直接ルートの一部として組み込むことができます。

```dart
final GoRouter router = GoRouter(
  initialLocation: '/login',
  routes: [
    GoRoute(
      path: '/login',
      builder: (context, state) => const LoginPage(),
    ),
    GoRoute(
      path: '/notification_list',
      builder: (context, state) => const NotificationListPage(),
    ),
    GoRoute(
      path: '/account',
      builder: (context, state) => const AccountPage(),
    ),
    StatefulShellRoute.indexedStack(
      builder: (context, state, navigationShell) => TabPage(navigationShell: navigationShell),
      branches: [
        StatefulShellBranch(
          routes: [
            GoRoute(
              path: '/map',
              builder: (context, state) => const MapPage(),
            ),
          ],
        ),
        StatefulShellBranch(
          routes: [
            GoRoute(
              path: '/guild',
              builder: (context, state) => const GuildPage(),
            ),
          ],
        ),
      ],
    ),
  ],
);
```

---

### 結論
- **`TabPageShell`が必要な場合**: ルート構成を整理したい、あるいは今後拡張の余地を持たせたい場合に使います。
- **`TabPageShell`が不要な場合**: 実際のUIには影響を与えないので、簡略化したい場合には省略できます。

---
