# Swift MCPサーバー構築

日付: 2025-06-26

---

## 👤 ユーザー
*2025/6/26 16:10:15*

swiftでMCPサーバーを立ててそのMCPにリクエストする方法

---

## 🤖 アシスタント
*2025/6/26 16:10:17*

SwiftでMCP（Model Control Protocol）サーバーを立てて、そのMCPサーバーにリクエストする方法について解説します。以下では、自作の簡易MCPサーバーをSwiftで立てて、それにリクエストする例を構成しています。

---

## ✅ 目的
- SwiftでMCPのような軽量サーバーを立てる
- クライアントからそのサーバーにリクエストする

※ MCP は公式な規格がまだ一般的でないため、ここでは「JSONベースのリクエスト/レスポンスを扱う簡易RPC的APIサーバー」をSwiftで作るという形で進めます。

---

## 🔧 サーバー実装（SwiftNIO使用）

まず、[SwiftNIO](https://github.com/apple/swift-nio)を使ってHTTPサーバーを作ります。以下は `Package.swift` の例：

```swift
// swift-tools-version:5.7
import PackageDescription

let package = Package(
    name: "SwiftMCPServer",
    platforms: [.macOS(.v13)],
    dependencies: [
        .package(url: "https://github.com/apple/swift-nio.git", from: "2.0.0"),
        .package(url: "https://github.com/apple/swift-nio-http1.git", from: "2.0.0")
    ],
    targets: [
        .executableTarget(
            name: "SwiftMCPServer",
            dependencies: [
                .product(name: "NIO", package: "swift-nio"),
                .product(name: "NIOHTTP1", package: "swift-nio-http1")
            ]
        )
    ]
)
```

### `main.swift`

```swift
import NIO
import NIOHTTP1

final class MCPHandler: ChannelInboundHandler {
    typealias InboundIn = HTTPServerRequestPart
    typealias OutboundOut = HTTPServerResponsePart

    var bodyBuffer: ByteBuffer?

    func channelRead(context: ChannelHandlerContext, data: NIOAny) {
        let reqPart = self.unwrapInboundIn(data)

        switch reqPart {
        case .head(let head):
            print("Received request: \(head.uri)")
        case .body(var body):
            bodyBuffer = body
        case .end:
            let responseJSON = #"{"response": "Hello from Swift MCP"}"#
            var buffer = context.channel.allocator.buffer(string: responseJSON)

            var headers = HTTPHeaders()
            headers.add(name: "Content-Type", value: "application/json")
            headers.add(name: "Content-Length", value: "\(buffer.readableBytes)")

            let head = HTTPResponseHead(version: .init(major: 1, minor: 1),
                                        status: .ok,
                                        headers: headers)

            context.write(self.wrapOutboundOut(.head(head)), promise: nil)
            context.write(self.wrapOutboundOut(.body(.byteBuffer(buffer))), promise: nil)
            context.writeAndFlush(self.wrapOutboundOut(.end(nil)), promise: nil)
        }
    }
}

let group = MultiThreadedEventLoopGroup(numberOfThreads: System.coreCount)
defer { try! group.syncShutdownGracefully() }

let bootstrap = ServerBootstrap(group: group)
    .serverChannelOption(ChannelOptions.backlog, value: 256)
    .childChannelInitializer { channel in
        channel.pipeline.configureHTTPServerPipeline().flatMap {
            channel.pipeline.addHandler(MCPHandler())
        }
    }
    .childChannelOption(ChannelOptions.socketOption(.so_reuseaddr), value: 1)

let channel = try bootstrap.bind(host: "127.0.0.1", port: 8080).wait()
print("MCP Server running on http://127.0.0.1:8080")

try channel.closeFuture.wait()
```

---

## 📡 クライアント実装（URLSession）

```swift
import Foundation

struct MCPRequest: Encodable {
    let model: String
    let input: String
}

struct MCPResponse: Decodable {
    let response: String
}

func sendRequest() {
    let url = URL(string: "http://127.0.0.1:8080")!
    var request = URLRequest(url: url)
    request.httpMethod = "POST"

    let body = MCPRequest(model: "echo", input: "こんにちは")
    request.httpBody = try? JSONEncoder().encode(body)
    request.setValue("application/json", forHTTPHeaderField: "Content-Type")

    let task = URLSession.shared.dataTask(with: request) { data, _, error in
        guard let data = data, error == nil else {
            print("Error:", error ?? "unknown")
            return
        }

        if let response = try? JSONDecoder().decode(MCPResponse.self, from: data) {
            print("Response from MCP:", response.response)
        } else {
            print("Invalid response")
        }
    }
    task.resume()
}

sendRequest()
RunLoop.main.run()
```

---

## ✅ 補足

- 本格的にMCPプロトコルを模倣する場合、OpenAIの[OpenMCP](https://github.com/openmcp/openmcp)や [Composio MCP](https://docs.composio.dev/) を参考にすると良いです。
- Swiftでより高度なRPCをしたい場合は gRPC や JSON-RPC ライブラリ（例: [SwiftGRPC](https://github.com/grpc/grpc-swift)）を検討するのも有効です。

---

必要であれば、`async/await` 対応クライアントや JSON-RPC 形式に拡張した例も作成できます。希望があればお知らせください。

---
