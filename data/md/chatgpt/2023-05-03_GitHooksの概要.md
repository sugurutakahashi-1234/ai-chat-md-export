# GitHooksの概要

日付: 2023-05-03

---

## 👤 ユーザー
*2023/05/04 01:22:23*

GitHooks について教えて

---

## 🤖 アシスタント
*2023/05/04 01:24:06*

GitHooksは、Gitの機能の一部で、リポジトリの特定のイベントが発生する前後にカスタムスクリプトを実行することができる仕組みです。これらのスクリプトは、主に開発者の作業フローを効率化し、チーム間で一貫性を保つために使用されます。

GitHooksは、ローカルリポジトリまたはリモートリポジトリで動作し、以下のようなイベントに対応しています。

1. コミットメッセージの作成前後
2. コミット前後
3. ブランチのチェックアウト前後
4. ブランチのマージ前後
5. プッシュ前後
6. その他のカスタムイベント

GitHooksは、リポジトリの`.git/hooks`ディレクトリに保存されているスクリプトです。これらのスクリプトは、シェルスクリプトやPython、Rubyなど、実行可能なあらゆる言語で書くことができます。GitHooksを使用するには、適切なイベントに対応するファイル名でスクリプトを作成し、実行可能にしておく必要があります。

GitHooksの例:

1. コードの品質を保つために、コミット前にコードのリント（構文チェック）を実行する。
2. コミットメッセージのフォーマットを検証し、不適切なフォーマットの場合はコミットを拒否する。
3. ブランチのマージ前に、特定のブランチポリシーが満たされているかを確認する。

GitHooksは、効率的な開発フローをサポートし、チームの生産性を向上させる強力なツールです。ただし、適切に設定されていない場合は、予期しない問題を引き起こす可能性があるため、注意して使用する必要があります。

---

## 👤 ユーザー
*2023/05/04 01:37:48*

以下のGitHooksのpre-commitのスクリプトを綺麗に書き直してみて

```
#!/usr/bin/env sh

# SwiftFormat
command="swift run --package-path BuildTools swiftformat"

color_red () {
  ESC=$(printf '\033')
  printf "$ESC[31m$1$ESC[m"
}

command -v $command 1>/dev/null 2>&1
if [ $? -gt 0 ]; then
  echo $(color_red "😓 swiftformat コマンドが見つかりません。")
  exit 1
fi

should_fail=false
staged_swift_files=`git diff --diff-filter=d --staged --name-only | grep -e '\(.*\).swift$'`
if [ -z "$staged_swift_files" ]; then
  # no swift file found
  exit 0
fi

while read file; do
  # stagingされていない変更のパッチを作成
  unstaged_patch=$(git diff "$file")
  if [ ! -z "$unstaged_patch" ]; then
    # stagingされていない変更があれば削除
    git restore $file
  fi
  # stagingの変更部分のみSwiftFormatでチェック (変更は起こらない)
  echo "👁 SwiftFormat: 確認中... $file"
  $command --lint $file
  if [ $? -eq 0 ]; then
    # no error
    if [ ! -z "$unstaged_patch" ]; then
      # パッチがあれば適用して戻す
      echo "$unstaged_patch" | git apply --whitespace=nowarn
    fi
    printf "\n"
    continue
  fi
  
  should_fail=true
  if [ ! -z "$unstaged_patch" ]; then
    # パッチがあれば適用して戻す
    echo "$unstaged_patch" | git apply --whitespace=nowarn
  fi
  # SwiftFormatを適用 (変更が起こる)
  echo "🪬 SwiftFormat: 適用中... $file"
  $command $file
  printf "\n"
done <<< "$staged_swift_files"
# ↑doneの後ろから読み込ませる方法でなければ、should_fail変数の変更が反映されない

if "$should_fail" ; then
  echo $(color_red "⛔️ SwiftFormatによってコードに変更が生じました。")
  echo "変更を取り入れるなどの対応をお願いします。"
  echo "🔗 wikiはこちら - https://..."
  exit 1
fi
```

---

## 🤖 アシスタント
*2023/05/04 01:39:38*

以下のようにスクリプトを整理しました。主な変更点はコメントの追加、関数の定義、および一部のコードの簡略化です。

```bash
#!/usr/bin/env sh

# Functions
color_red() {
  ESC=$(printf '\033')
  printf "$ESC[31m$1$ESC[m"
}

run_swiftformat() {
  command="swift run --package-path BuildTools swiftformat"
  command -v $command >/dev/null 2>&1
  if [ $? -gt 0 ]; then
    echo $(color_red "😓 swiftformat コマンドが見つかりません。")
    exit 1
  fi
  $command "$@"
}

# Variables
should_fail=false
staged_swift_files=$(git diff --diff-filter=d --staged --name-only | grep -e '\(.*\).swift$')

# Main script
if [ -z "$staged_swift_files" ]; then
  # No Swift files found
  exit 0
fi

while read file; do
  # Create patch for unstaged changes
  unstaged_patch=$(git diff "$file")
  if [ ! -z "$unstaged_patch" ]; then
    # Remove unstaged changes if any
    git restore $file
  fi

  # Check staged changes only with SwiftFormat (no changes applied)
  echo "👁 SwiftFormat: 確認中... $file"
  run_swiftformat --lint $file
  if [ $? -eq 0 ]; then
    if [ ! -z "$unstaged_patch" ]; then
      # Apply patch if any and restore unstaged changes
      echo "$unstaged_patch" | git apply --whitespace=nowarn
    fi
    printf "\n"
    continue
  fi

  should_fail=true
  if [ ! -z "$unstaged_patch" ]; then
    # Apply patch if any and restore unstaged changes
    echo "$unstaged_patch" | git apply --whitespace=nowarn
  fi

  # Apply SwiftFormat to the file (changes will be applied)
  echo "🪬 SwiftFormat: 適用中... $file"
  run_swiftformat $file
  printf "\n"
done <<< "$staged_swift_files"

if $should_fail; then
  echo $(color_red "⛔️ SwiftFormatによってコードに変更が生じました。")
  echo "変更を取り入れるなどの対応をお願いします。"
  echo "🔗 wikiはこちら - https://..."
  exit 1
fi
```

この整理により、スクリプトがより読みやすくなり、保守性が向上しています。

---

## 👤 ユーザー
*2023/05/04 01:39:50*

コメントを日本語に変更して

---

## 🤖 アシスタント
*2023/05/04 01:42:14*

コメントを日本語に変更しました。以下が修正後のスクリプトです。

```bash
#!/usr/bin/env sh

# 関数
color_red() {
  ESC=$(printf '\033')
  printf "$ESC[31m$1$ESC[m"
}

run_swiftformat() {
  command="swift run --package-path BuildTools swiftformat"
  command -v $command >/dev/null 2>&1
  if [ $? -gt 0 ]; then
    echo $(color_red "😓 swiftformat コマンドが見つかりません。")
    exit 1
  fi
  $command "$@"
}

# 変数
should_fail=false
staged_swift_files=$(git diff --diff-filter=d --staged --name-only | grep -e '\(.*\).swift$')

# メインスクリプト
if [ -z "$staged_swift_files" ]; then
  # Swiftファイルが見つからない場合
  exit 0
fi

while read file; do
  # ステージングされていない変更のパッチを作成
  unstaged_patch=$(git diff "$file")
  if [ ! -z "$unstaged_patch" ]; then
    # ステージングされていない変更がある場合は削除
    git restore $file
  fi

  # SwiftFormatでステージングされた変更のみをチェック（変更は適用されません）
  echo "👁 SwiftFormat: 確認中... $file"
  run_swiftformat --lint $file
  if [ $? -eq 0 ]; then
    if [ ! -z "$unstaged_patch" ]; then
      # パッチがある場合は適用して未ステージの変更を復元
      echo "$unstaged_patch" | git apply --whitespace=nowarn
    fi
    printf "\n"
    continue
  fi

  should_fail=true
  if [ ! -z "$unstaged_patch" ]; then
    # パッチがある場合は適用して未ステージの変更を復元
    echo "$unstaged_patch" | git apply --whitespace=nowarn
  fi

  # ファイルにSwiftFormatを適用（変更が適用されます）
  echo "🪬 SwiftFormat: 適用中... $file"
  run_swiftformat $file
  printf "\n"
done <<< "$staged_swift_files"

if $should_fail; then
  echo $(color_red "⛔️ SwiftFormatによってコードに変更が生じました。")
  echo "変更を取り入れるなどの対応をお願いします。"
  echo "🔗 wikiはこちら - https://..."
  exit 1
fi
```

これで、スクリプトのコメントが日本語になりました。

---

## 👤 ユーザー
*2023/05/04 01:43:40*

while 文を使うのをやめて書くことはできませんか？

---

## 🤖 アシスタント
*2023/05/04 01:45:45*

もちろんできます。`while`文を使わずに`for`文を使用して、同じ処理を実現することができます。以下が修正後のスクリプトです。

```bash
#!/usr/bin/env sh

# 関数
color_red() {
  ESC=$(printf '\033')
  printf "$ESC[31m$1$ESC[m"
}

run_swiftformat() {
  command="swift run --package-path BuildTools swiftformat"
  command -v $command >/dev/null 2>&1
  if [ $? -gt 0 ]; then
    echo $(color_red "😓 swiftformat コマンドが見つかりません。")
    exit 1
  fi
  $command "$@"
}

# 変数
should_fail=false
staged_swift_files=$(git diff --diff-filter=d --staged --name-only | grep -e '\(.*\).swift$')

# メインスクリプト
if [ -z "$staged_swift_files" ]; then
  # Swiftファイルが見つからない場合
  exit 0
fi

# ステージングされたSwiftファイルの配列を作成
IFS=$'\n' read -ra swift_files_array <<< "$staged_swift_files"

for file in "${swift_files_array[@]}"; do
  # ステージングされていない変更のパッチを作成
  unstaged_patch=$(git diff "$file")
  if [ ! -z "$unstaged_patch" ]; then
    # ステージングされていない変更がある場合は削除
    git restore $file
  fi

  # SwiftFormatでステージングされた変更のみをチェック（変更は適用されません）
  echo "👁 SwiftFormat: 確認中... $file"
  run_swiftformat --lint $file
  if [ $? -eq 0 ]; then
    if [ ! -z "$unstaged_patch" ]; then
      # パッチがある場合は適用して未ステージの変更を復元
      echo "$unstaged_patch" | git apply --whitespace=nowarn
    fi
    printf "\n"
    continue
  fi

  should_fail=true
  if [ ! -z "$unstaged_patch" ]; then
    # パッチがある場合は適用して未ステージの変更を復元
    echo "$unstaged_patch" | git apply --whitespace=nowarn
  fi

  # ファイルにSwiftFormatを適用（変更が適用されます）
  echo "🪬 SwiftFormat: 適用中... $file"
  run_swiftformat $file
  printf "\n"
done

if $should_fail; then
  echo $(color_red "⛔️ SwiftFormatによってコードに変更が生じました。")
  echo "変更を取り入れるなどの対応をお願いします。"
  echo "🔗 wikiはこちら - https://..."
  exit 1
fi
```

この修正により、`

---
