# å‹ã‚’æ˜ç¤ºçš„ã«æŒ‡å®š

æ—¥ä»˜: 2024-02-21

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/2/21 23:19:51*

ä»¥ä¸‹ã«ã¤ã„ã¦ã®è³ªå•ã§ã™ã€‚
test_snapshots()ã¯æ­£å¸¸ã«å‹•ãã®ã§ã™ãŒã€func test_hogeSnapshots() {ã¯æ­£ã—ãå‹•ãã¾ã›ã‚“ã€‚test_hogeSnapshots()ã‚’ä¿®æ­£ã—ã¦ã»ã—ã„ã€‚


import PreviewSnapshotsTesting
import PreviewSnapshots
import XCTest

@testable import PresentationLayer


final class SnapshotTests: XCTestCase {
    func test_snapshots() {
        AppRootView_Previews.snapshots.assertSnapshots(as: [.image(layout: .device(config: .iPhoneSe)), .image(layout: .device(config: .iPadMini))])
        LicenseListView_Previews.snapshots.assertSnapshots(as: [.image(layout: .device(config: .iPhoneSe)), .image(layout: .device(config: .iPadMini))])
        LicenseDetailView_Previews.snapshots.assertSnapshots(as: [.image(layout: .device(config: .iPhoneSe)), .image(layout: .device(config: .iPadMini))])
    }
    
    func test_hogeSnapshots() {
        let hoge = [.image(layout: .device(config: .iPhoneSe)), .image(layout: .device(config: .iPadMini))]
        AppRootView_Previews.snapshots.assertSnapshots(as: hoge)
        LicenseListView_Previews.snapshots.assertSnapshots(as: hoge)
        LicenseDetailView_Previews.snapshots.assertSnapshots(as: hoge)
    }
}


extension PreviewSnapshots {
    /// Assert that all of the snapshots defined in a `PreviewSnapshots` collection match their
    /// snapshots recorded on disk.
    ///
    /// - Parameters:
    ///   - strategies: An array of strategies for serializing, deserializing, and comparing values.
    ///   - name: An optional description of the snapshot to include with the configuration name.
    ///   - recording: Whether or not to record a new reference.
    ///   - file: The file in which failure occurred. Defaults to the file name of the test case in
    ///         which this function was called.
    ///   - testName: The name of the test in which failure occurred. Defaults to the function name
    ///         of the test case in which this function was called.
    ///   - line: The line number on which failure occurred. Defaults to the line number on which
    ///         this function was called.
    public func assertSnapshots&lt;Format&gt;(
        as strategies: [Snapshotting&lt;AnyView, Format&gt;],
        named name: String? = nil,
        record recording: Bool = false,
        file: StaticString = #file,
        testName: String = #function,
        line: UInt = #line
    ) {
        for configuration in configurations {
            for (position, strategy) in strategies.enumerated() {
                assertSnapshot(
                    matching: configure(configuration.state),
                    as: strategy,
                    named: configuration.snapshotName(prefix: name) + "-\(position + 1)",
                    record: recording,
                    file: file, testName: testName, line: line
                )
            }
        }
    }
}


/// A type representing the ability to transform a snapshottable value into a diffable format (like text or an image) for snapshot testing.
public struct Snapshotting&lt;Value, Format&gt; {
  /// The path extension applied to references saved to disk.
  public var pathExtension: String?

  /// How the snapshot format is diffed and converted to and from data.
  public var diffing: Diffing&lt;Format&gt;

  /// How a value is transformed into a diffable snapshot format.
  public var snapshot: (Value) -&gt; Async&lt;Format&gt;

  /// Creates a snapshot strategy.
  ///
  /// - Parameters:
  ///   - pathExtension: The path extension applied to references saved to disk.
  ///   - diffing: How to diff and convert the snapshot format to and from data.
  ///   - asyncSnapshot: An asynchronous transform function from a value into a diffable snapshot format.
  ///   - value: A value to be converted.
  public init(
    pathExtension: String?,
    diffing: Diffing&lt;Format&gt;,
    asyncSnapshot: @escaping (_ value: Value) -&gt; Async&lt;Format&gt;
    ) {
    self.pathExtension = pathExtension
    self.diffing = diffing
    self.snapshot = asyncSnapshot
  }

  /// Creates a snapshot strategy.
  ///
  /// - Parameters:
  ///   - pathExtension: The path extension applied to references saved to disk.
  ///   - diffing: How to diff and convert the snapshot format to and from data.
  ///   - snapshot: A transform function from a value into a diffable snapshot format.
  ///   - value: A snapshot value to be converted.
  public init(
    pathExtension: String?,
    diffing: Diffing&lt;Format&gt;,
    snapshot: @escaping (_ value: Value) -&gt; Format
    ) {
    self.init(pathExtension: pathExtension, diffing: diffing) {
      Async(value: snapshot($0))
    }
  }

  /// Transforms a strategy on `Value`s into a strategy on `NewValue`s through a function `(NewValue) -&gt; Value`.
  ///
  /// This is the most important operation for transforming existing strategies into new strategies. It allows you to transform a `Snapshotting&lt;Value, Format&gt;` into a `Snapshotting&lt;NewValue, Format&gt;` by pulling it back along a function `(NewValue) -&gt; Value`. Notice that the function must go in the direction `(NewValue) -&gt; Value` even though we are transforming in the other direction `(Snapshotting&lt;Value, Format&gt;) -&gt; Snapshotting&lt;NewValue, Format&gt;`.
  ///
  /// A simple example of this is to `pullback` the snapshot strategy on `UIView`s to work on `UIViewController`s:
  ///
  ///     let strategy = Snapshotting&lt;UIView, UIImage&gt;.image.pullback { (vc: UIViewController) in
  ///       return vc.view
  ///     }
  ///
  /// Here we took the strategy that snapshots `UIView`s as `UIImage`s and pulled it back to work on `UIViewController`s by using the function `(UIViewController) -&gt; UIView` that simply plucks the view out of the controller.
  ///
  /// Nearly every snapshot strategy provided in this library is a pullback of some base strategy, which shows just how important this operation is.
  ///
  /// - Parameters:
  ///   - transform: A transform function from `NewValue` into `Value`.
  ///   - otherValue: A value to be transformed.
  public func pullback&lt;NewValue&gt;(_ transform: @escaping (_ otherValue: NewValue) -&gt; Value) -&gt; Snapshotting&lt;NewValue, Format&gt; {
    return self.asyncPullback { newValue in Async(value: transform(newValue)) }
  }

  /// Transforms a strategy on `Value`s into a strategy on `NewValue`s through a function `(NewValue) -&gt; Async&lt;Value&gt;`.
  ///
  /// See the documentation of `pullback` for a full description of how pullbacks works. This operation differs from `pullback` in that it allows you to use a transformation `(NewValue) -&gt; Async&lt;Value&gt;`, which is necessary when your transformation needs to perform some asynchronous work.
  ///
  /// - Parameters:
  ///   - transform: A transform function from `NewValue` into `Async&lt;Value&gt;`.
  ///   - otherValue: A value to be transformed.
  public func asyncPullback&lt;NewValue&gt;(_ transform: @escaping (_ otherValue: NewValue) -&gt; Async&lt;Value&gt;)
    -&gt; Snapshotting&lt;NewValue, Format&gt; {

      return Snapshotting&lt;NewValue, Format&gt;(
        pathExtension: self.pathExtension,
        diffing: self.diffing
      ) { newValue in
        return .init { callback in
          transform(newValue).run { value in
            self.snapshot(value).run { snapshot in
              callback(snapshot)
            }
          }
        }
      }
  }
}

/// A snapshot strategy where the type being snapshot is also a diffable type.
public typealias SimplySnapshotting&lt;Format&gt; = Snapshotting&lt;Format, Format&gt;

extension Snapshotting where Value == Format {
  public init(pathExtension: String?, diffing: Diffing&lt;Format&gt;) {
    self.init(
      pathExtension: pathExtension,
      diffing: diffing,
      snapshot: { $0 }
    )
  }
}

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/2/21 23:21:17*

`test_hogeSnapshots()`ãƒ¡ã‚½ãƒƒãƒ‰ãŒæ­£å¸¸ã«æ©Ÿèƒ½ã—ãªã„ç†ç”±ã¯ã€ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹é™ã‚Šã§ã¯ç›´æ¥çš„ã«æ˜ç¢ºã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æä¾›ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã¯ã€åŸºæœ¬çš„ã«ã¯æ­£ã—ãè¦‹ãˆã¾ã™ã€‚ãŸã ã—ã€ã“ã®ãƒ†ã‚¹ãƒˆãŒæœŸå¾…ã©ãŠã‚Šã«å‹•ä½œã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ä¸€èˆ¬çš„ãªç†ç”±ã‚’ã„ãã¤ã‹æ¤œè¨ã™ã‚‹ã“ã¨ã¯å¯èƒ½ã§ã™ã€‚ãã®ä¸Šã§ã€ä¸€èˆ¬çš„ãªè§£æ±ºç­–ã‚„ãƒ‡ãƒãƒƒã‚°ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ææ¡ˆã—ã¾ã™ã€‚

1. **å¤‰æ•°ã®æ‰±ã„**: `test_hogeSnapshots()`å†…ã§`hoge`å¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã®é…åˆ—ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ãŒã€ã“ã®éƒ¨åˆ†ã¯`test_snapshots()`ãƒ¡ã‚½ãƒƒãƒ‰ã¨æ©Ÿèƒ½çš„ã«ã¯åŒç­‰ã§ã™ã€‚å•é¡ŒãŒèµ·ã“ã‚‹ä¸€èˆ¬çš„ãªåŸå› ã¯ãªã•ãã†ã§ã™ã€‚

2. **ç’°å¢ƒã‚„è¨­å®šã®é•ã„**: `test_hogeSnapshots()`ãŒå¤±æ•—ã™ã‚‹ç†ç”±ã¨ã—ã¦ã€ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚„ãƒ“ãƒ«ãƒ‰ã®è¨­å®šã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚ä¾‹ãˆã°ã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ç’°å¢ƒã«ã‚ˆã£ã¦ã¯ã€ç‰¹å®šã®è¨­å®šã‚„ãƒªã‚½ãƒ¼ã‚¹ã®ä¸è¶³ãŒåŸå› ã§å¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

3. **éåŒæœŸå‡¦ç†ã®æ‰±ã„**: ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆã¯å†…éƒ¨çš„ã«éåŒæœŸå‡¦ç†ã‚’è¡Œã†å ´åˆãŒã‚ã‚Šã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒå®Œäº†ã™ã‚‹å‰ã«éåŒæœŸå‡¦ç†ãŒçµ‚äº†ã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãŸã ã—ã€æä¾›ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã§ã¯éåŒæœŸå‡¦ç†ã®æ‰±ã„ã«ã¤ã„ã¦ã¯ç‰¹ã«å¤‰æ›´ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ã“ã‚ŒãŒåŸå› ã§ã‚ã‚‹å¯èƒ½æ€§ã¯ä½ã„ã§ã™ã€‚

4. **ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ†ã‚¹ãƒˆåã®æ‰±ã„**: `assertSnapshots`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯ã€`file`ã€`testName`ã€`line`ã¨ã„ã£ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚‰ã®å€¤ã¯ã€ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã®æ¯”è¼ƒã‚„ä¿å­˜ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç‰¹ã«ã€`testName`ã¯ãƒ†ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰åã«åŸºã¥ã„ã¦è‡ªå‹•çš„ã«è¨­å®šã•ã‚Œã‚‹ãŸã‚ã€ç•°ãªã‚‹ãƒ†ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰åãŒåŸå› ã§ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã®å‚ç…§å…ˆãŒå¤‰ã‚ã‚Šã€æ„å›³ã—ãªã„æ¯”è¼ƒçµæœã«ãªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

ä¿®æ­£ã®ææ¡ˆã¨ã—ã¦ã¯ã€ä»¥ä¸‹ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒè€ƒãˆã‚‰ã‚Œã¾ã™ï¼š

- **ç’°å¢ƒã‚„è¨­å®šã®ç¢ºèª**: ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹åŸå› ãŒç’°å¢ƒã‚„è¨­å®šã«ã‚ã‚‹å ´åˆã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰è¨­å®šã‚„ãƒ†ã‚¹ãƒˆç’°å¢ƒã®æ§‹æˆã‚’å†ç¢ºèªã—ã¦ãã ã•ã„ã€‚

- **éåŒæœŸå‡¦ç†ã®ç¢ºèª**: ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆãŒéåŒæœŸå‡¦ç†ã‚’æ­£ã—ãå¾…æ©Ÿã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚XCTestã«ã¯ã€éåŒæœŸå‡¦ç†ã‚’å¾…æ©Ÿã™ã‚‹ãŸã‚ã®`expectation`ã‚„`waitForExpectations(timeout:handler:)`ã¨ã„ã£ãŸãƒ¡ã‚½ãƒƒãƒ‰ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

- **è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç¢ºèª**: ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸéš›ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚„ãƒ­ã‚°ã‚’è©³ã—ãç¢ºèªã—ã¦ã€å•é¡Œã®åŸå› ã‚’ç‰¹å®šã—ã¦ãã ã•ã„ã€‚

- **ãƒ‡ãƒãƒƒã‚°ã®ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ã®è¿½åŠ **: ãƒ†ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰å†…ã«ãƒ‡ãƒãƒƒã‚°ç”¨ã®å‡ºåŠ›ã‚’è¿½åŠ ã—ã¦ã€ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ã‚’è¿½è·¡ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å•é¡Œã®åŸå› ã‚’ç‰¹å®šã—ã‚„ã™ããªã‚Šã¾ã™ã€‚

ä¸Šè¨˜ã®æƒ…å ±ã‚’åŸºã«ã€`test_hogeSnapshots()`ãƒ¡ã‚½ãƒƒ

---
