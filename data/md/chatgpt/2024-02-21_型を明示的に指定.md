# 型を明示的に指定

日付: 2024-02-21

---

## 👤 ユーザー
*2024/2/21 23:19:51*

以下についての質問です。
test_snapshots()は正常に動くのですが、func test_hogeSnapshots() {は正しく動きません。test_hogeSnapshots()を修正してほしい。


import PreviewSnapshotsTesting
import PreviewSnapshots
import XCTest

@testable import PresentationLayer


final class SnapshotTests: XCTestCase {
    func test_snapshots() {
        AppRootView_Previews.snapshots.assertSnapshots(as: [.image(layout: .device(config: .iPhoneSe)), .image(layout: .device(config: .iPadMini))])
        LicenseListView_Previews.snapshots.assertSnapshots(as: [.image(layout: .device(config: .iPhoneSe)), .image(layout: .device(config: .iPadMini))])
        LicenseDetailView_Previews.snapshots.assertSnapshots(as: [.image(layout: .device(config: .iPhoneSe)), .image(layout: .device(config: .iPadMini))])
    }
    
    func test_hogeSnapshots() {
        let hoge = [.image(layout: .device(config: .iPhoneSe)), .image(layout: .device(config: .iPadMini))]
        AppRootView_Previews.snapshots.assertSnapshots(as: hoge)
        LicenseListView_Previews.snapshots.assertSnapshots(as: hoge)
        LicenseDetailView_Previews.snapshots.assertSnapshots(as: hoge)
    }
}


extension PreviewSnapshots {
    /// Assert that all of the snapshots defined in a `PreviewSnapshots` collection match their
    /// snapshots recorded on disk.
    ///
    /// - Parameters:
    ///   - strategies: An array of strategies for serializing, deserializing, and comparing values.
    ///   - name: An optional description of the snapshot to include with the configuration name.
    ///   - recording: Whether or not to record a new reference.
    ///   - file: The file in which failure occurred. Defaults to the file name of the test case in
    ///         which this function was called.
    ///   - testName: The name of the test in which failure occurred. Defaults to the function name
    ///         of the test case in which this function was called.
    ///   - line: The line number on which failure occurred. Defaults to the line number on which
    ///         this function was called.
    public func assertSnapshots&lt;Format&gt;(
        as strategies: [Snapshotting&lt;AnyView, Format&gt;],
        named name: String? = nil,
        record recording: Bool = false,
        file: StaticString = #file,
        testName: String = #function,
        line: UInt = #line
    ) {
        for configuration in configurations {
            for (position, strategy) in strategies.enumerated() {
                assertSnapshot(
                    matching: configure(configuration.state),
                    as: strategy,
                    named: configuration.snapshotName(prefix: name) + "-\(position + 1)",
                    record: recording,
                    file: file, testName: testName, line: line
                )
            }
        }
    }
}


/// A type representing the ability to transform a snapshottable value into a diffable format (like text or an image) for snapshot testing.
public struct Snapshotting&lt;Value, Format&gt; {
  /// The path extension applied to references saved to disk.
  public var pathExtension: String?

  /// How the snapshot format is diffed and converted to and from data.
  public var diffing: Diffing&lt;Format&gt;

  /// How a value is transformed into a diffable snapshot format.
  public var snapshot: (Value) -&gt; Async&lt;Format&gt;

  /// Creates a snapshot strategy.
  ///
  /// - Parameters:
  ///   - pathExtension: The path extension applied to references saved to disk.
  ///   - diffing: How to diff and convert the snapshot format to and from data.
  ///   - asyncSnapshot: An asynchronous transform function from a value into a diffable snapshot format.
  ///   - value: A value to be converted.
  public init(
    pathExtension: String?,
    diffing: Diffing&lt;Format&gt;,
    asyncSnapshot: @escaping (_ value: Value) -&gt; Async&lt;Format&gt;
    ) {
    self.pathExtension = pathExtension
    self.diffing = diffing
    self.snapshot = asyncSnapshot
  }

  /// Creates a snapshot strategy.
  ///
  /// - Parameters:
  ///   - pathExtension: The path extension applied to references saved to disk.
  ///   - diffing: How to diff and convert the snapshot format to and from data.
  ///   - snapshot: A transform function from a value into a diffable snapshot format.
  ///   - value: A snapshot value to be converted.
  public init(
    pathExtension: String?,
    diffing: Diffing&lt;Format&gt;,
    snapshot: @escaping (_ value: Value) -&gt; Format
    ) {
    self.init(pathExtension: pathExtension, diffing: diffing) {
      Async(value: snapshot($0))
    }
  }

  /// Transforms a strategy on `Value`s into a strategy on `NewValue`s through a function `(NewValue) -&gt; Value`.
  ///
  /// This is the most important operation for transforming existing strategies into new strategies. It allows you to transform a `Snapshotting&lt;Value, Format&gt;` into a `Snapshotting&lt;NewValue, Format&gt;` by pulling it back along a function `(NewValue) -&gt; Value`. Notice that the function must go in the direction `(NewValue) -&gt; Value` even though we are transforming in the other direction `(Snapshotting&lt;Value, Format&gt;) -&gt; Snapshotting&lt;NewValue, Format&gt;`.
  ///
  /// A simple example of this is to `pullback` the snapshot strategy on `UIView`s to work on `UIViewController`s:
  ///
  ///     let strategy = Snapshotting&lt;UIView, UIImage&gt;.image.pullback { (vc: UIViewController) in
  ///       return vc.view
  ///     }
  ///
  /// Here we took the strategy that snapshots `UIView`s as `UIImage`s and pulled it back to work on `UIViewController`s by using the function `(UIViewController) -&gt; UIView` that simply plucks the view out of the controller.
  ///
  /// Nearly every snapshot strategy provided in this library is a pullback of some base strategy, which shows just how important this operation is.
  ///
  /// - Parameters:
  ///   - transform: A transform function from `NewValue` into `Value`.
  ///   - otherValue: A value to be transformed.
  public func pullback&lt;NewValue&gt;(_ transform: @escaping (_ otherValue: NewValue) -&gt; Value) -&gt; Snapshotting&lt;NewValue, Format&gt; {
    return self.asyncPullback { newValue in Async(value: transform(newValue)) }
  }

  /// Transforms a strategy on `Value`s into a strategy on `NewValue`s through a function `(NewValue) -&gt; Async&lt;Value&gt;`.
  ///
  /// See the documentation of `pullback` for a full description of how pullbacks works. This operation differs from `pullback` in that it allows you to use a transformation `(NewValue) -&gt; Async&lt;Value&gt;`, which is necessary when your transformation needs to perform some asynchronous work.
  ///
  /// - Parameters:
  ///   - transform: A transform function from `NewValue` into `Async&lt;Value&gt;`.
  ///   - otherValue: A value to be transformed.
  public func asyncPullback&lt;NewValue&gt;(_ transform: @escaping (_ otherValue: NewValue) -&gt; Async&lt;Value&gt;)
    -&gt; Snapshotting&lt;NewValue, Format&gt; {

      return Snapshotting&lt;NewValue, Format&gt;(
        pathExtension: self.pathExtension,
        diffing: self.diffing
      ) { newValue in
        return .init { callback in
          transform(newValue).run { value in
            self.snapshot(value).run { snapshot in
              callback(snapshot)
            }
          }
        }
      }
  }
}

/// A snapshot strategy where the type being snapshot is also a diffable type.
public typealias SimplySnapshotting&lt;Format&gt; = Snapshotting&lt;Format, Format&gt;

extension Snapshotting where Value == Format {
  public init(pathExtension: String?, diffing: Diffing&lt;Format&gt;) {
    self.init(
      pathExtension: pathExtension,
      diffing: diffing,
      snapshot: { $0 }
    )
  }
}

---

## 🤖 アシスタント
*2024/2/21 23:21:17*

`test_hogeSnapshots()`メソッドが正常に機能しない理由は、コードを見る限りでは直接的に明確ではありません。提供されたコードは、基本的には正しく見えます。ただし、このテストが期待どおりに動作しない可能性がある一般的な理由をいくつか検討することは可能です。その上で、一般的な解決策やデバッグのアプローチを提案します。

1. **変数の扱い**: `test_hogeSnapshots()`内で`hoge`変数を使用してスナップショットの配列を定義していますが、この部分は`test_snapshots()`メソッドと機能的には同等です。問題が起こる一般的な原因はなさそうです。

2. **環境や設定の違い**: `test_hogeSnapshots()`が失敗する理由として、テスト環境やビルドの設定に問題がある可能性が考えられます。例えば、テストを実行する環境によっては、特定の設定やリソースの不足が原因で失敗することがあります。

3. **非同期処理の扱い**: スナップショットテストは内部的に非同期処理を行う場合があり、テストケースが完了する前に非同期処理が終了していない可能性があります。ただし、提供されたコードでは非同期処理の扱いについては特に変更されていないため、これが原因である可能性は低いです。

4. **ファイルやテスト名の扱い**: `assertSnapshots`メソッドでは、`file`、`testName`、`line`といったパラメータが使用されています。これらの値は、スナップショットの比較や保存に影響を与える可能性があります。特に、`testName`はテストメソッド名に基づいて自動的に設定されるため、異なるテストメソッド名が原因でスナップショットの参照先が変わり、意図しない比較結果になることがあります。

修正の提案としては、以下のアプローチが考えられます：

- **環境や設定の確認**: テストが失敗する原因が環境や設定にある場合、プロジェクトのビルド設定やテスト環境の構成を再確認してください。

- **非同期処理の確認**: スナップショットテストが非同期処理を正しく待機しているかを確認してください。XCTestには、非同期処理を待機するための`expectation`や`waitForExpectations(timeout:handler:)`といったメソッドが用意されています。

- **詳細なエラーメッセージの確認**: テストが失敗した際のエラーメッセージやログを詳しく確認して、問題の原因を特定してください。

- **デバッグのためのコードの追加**: テストメソッド内にデバッグ用の出力を追加して、テストの実行フローを追跡します。これにより、問題の原因を特定しやすくなります。

上記の情報を基に、`test_hogeSnapshots()`メソッ

---
