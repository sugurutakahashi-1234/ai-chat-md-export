# iOS シミュレーター カメラ起動

日付: 2024-12-16

---

## 👤 ユーザー
*2024/12/16 21:00:46*

以下について
// iOS シミュレーターの場合はカメラを起動せずに確認画面へ遷移 の処理をinitCameraから分離してuseEffect内でのみ読んでlistenでは呼んで干してくない

import 'dart:io';

import 'package:flutter/material.dart';
import 'package:flutter_hooks/flutter_hooks.dart';
import 'package:go_router/go_router.dart';
import 'package:hooks_riverpod/hooks_riverpod.dart';
import 'package:image_picker/image_picker.dart';
import 'package:snpit_guild_app/domain/screen.dart';
import 'package:snpit_guild_app/presentation/providers/on_pop_snap_confirm.dart';
import 'package:snpit_guild_app/presentation/providers/shoot_photo_path.dart';
import 'package:device_info_plus/device_info_plus.dart';

class ShootingPage extends HookConsumerWidget {
  const ShootingPage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    Future&lt;void&gt; initCamera() async {
      // iOS シミュレーターの場合はカメラを起動せずに確認画面へ遷移
      if (Platform.isIOS) {
        final deviceInfo = DeviceInfoPlugin();
        final iosInfo = await deviceInfo.iosInfo;

        // isPhysicalDeviceがfalseの場合はシミュレーター
        final isSimulator = !iosInfo.isPhysicalDevice;

        if (isSimulator) {
          if (context.mounted) {
            ref.read(onPopSnapConfirmNotifierProvider.notifier).reset();
            await context.push(Screen.snapConfirm.path);
          }
          return;
        }
      }

      // 実機 or Android シュミレーターの場合はカメラを起動
      final picker = ImagePicker();
      final pickedFile = await picker.pickImage(source: ImageSource.camera);

      if (pickedFile != null) {
        ref
            .read(shootPhotoPathNotifierProvider.notifier)
            .updatePath(pickedFile.path);

        if (context.mounted) {
          // 遷移する前に notifier をリセット
          ref.read(onPopSnapConfirmNotifierProvider.notifier).reset();
          await context.push(Screen.snapConfirm.path);
        }
      } else {
        // 写真が選ばれなかった場合は戻る
        if (context.mounted) {
          context.pop();
        }
      }
    }

    useEffect(
      () {
        // Widgets の描画が終わった後に ref から値を更新しなければならない
        WidgetsBinding.instance.addPostFrameCallback((_) {
          ref.read(shootPhotoPathNotifierProvider.notifier).clear();
          initCamera();
        });
        return null;
      },
      [],
    );

    ref.listen&lt;bool&gt;(
      onPopSnapConfirmNotifierProvider,
      (_, next) {
        if (next) {
          initCamera();
        }
      },
    );

    return Scaffold(
      appBar: AppBar(title: const Text('ShootingPage')),
      body: const Center(
        child: CircularProgressIndicator(),
      ),
    );
  }
}

---

## 🤖 アシスタント
*2024/12/16 21:00:58*

以下のコードを修正し、`initCamera` 処理を `useEffect` 内でのみ呼び出すように変更し、`listen` で呼び出さないようにする実装例を提示します。`listen` の中でのカメラ起動を防ぐことで、不要な処理が発生しないようにできます。

修正のポイント:
1. `initCamera` を `useEffect` の中でのみ呼び出す。
2. `listen` ではカメラ起動を行わず、状態の監視と必要な処理のみに留める。

以下のコードは修正版です:

```dart
import 'dart:io';

import 'package:flutter/material.dart';
import 'package:flutter_hooks/flutter_hooks.dart';
import 'package:go_router/go_router.dart';
import 'package:hooks_riverpod/hooks_riverpod.dart';
import 'package:image_picker/image_picker.dart';
import 'package:snpit_guild_app/domain/screen.dart

---
