# SwiftUIでリモート通知管理

Date: 2024-07-10

---

## 👤 User
*2024-07-10 14:48:15*

func application(application: UIApplication,
                 didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data) {}をSwiftUIで実行したい

---

## 🤖 Assistant
*2024-07-10 14:48:40*

`UIApplicationDelegate`を使わずにSwiftUIでリモート通知のデバイストークンを登録するためには、`UIApplicationDelegateAdaptor`プロトコルを使って`AppDelegate`をSwiftUIアプリケーションに統合する方法があります。

以下にその方法を示します。

1. `AppDelegate`クラスを作成し、`didRegisterForRemoteNotificationsWithDeviceToken`メソッドを実装します。
2. `AppDelegate`をSwiftUIの`@UIApplicationDelegateAdaptor`を使って統合します。
3. SwiftUIの`App`プロトコルを実装する構造体で`UIApplication.shared.registerForRemoteNotifications()`を呼び出します。

以下はその実装例です。

```swift
import SwiftUI
import UIKit

// AppDelegateクラスを作成
class AppDelegate: NSObject, UIApplicationDelegate {
    func application(_ application: UIApplication,
                     didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data) {
        // デバイストークンを取得した後の処理をここに書きます
        print("Device Token: \(deviceToken)")
    }

    func application(_ application: UIApplication,
                     didFailToRegisterForRemoteNotificationsWithError error: Error) {
        // エラーが発生した場合の処理をここに書きます
        print("Failed to register for remote notifications: \(error)")
    }
}

@main
struct YourApp: App {
    // AppDelegateをSwiftUIに統合
    @UIApplicationDelegateAdaptor(AppDelegate.self) var appDelegate

    var body: some Scene {
        WindowGroup {
            ContentView()
                .onAppear {
                    // リモート通知の登録をリクエスト
                    UIApplication.shared.registerForRemoteNotifications()
                    
                    // 通知の許可を要求
                    UNUserNotificationCenter.current().requestAuthorization(options: [.alert, .sound, .badge]) { granted, error in
                        if granted {
                            DispatchQueue.main.async {
                                UIApplication.shared.registerForRemoteNotifications()
                            }
                        } else {
                            print("Notification permission denied.")
                        }
                        if let error = error {
                            print("Error requesting notification authorization: \(error)")
                        }
                    }
                }
        }
    }
}

struct ContentView: View {
    var body: some View {
        Text("Hello, world!")
            .padding()
    }
}
```

この方法で、SwiftUIアプリケーションでもリモート通知のデバイストークンを登録することができます。`AppDelegate`内でトークンを取得した後の処理を実装することで、必要な処理を行うことができます。

---

## 👤 User
*2024-07-10 14:49:13*

UIApplicationDelegateAdaptor は @main ではないところでもじっこうできるのか？

---

## 🤖 Assistant
*2024-07-10 14:49:34*

`UIApplicationDelegateAdaptor`は、`@main`属性が付いたエントリーポイントの`App`プロトコルを実装する構造体以外でも使用できます。具体的には、SwiftUIのビュー階層内で利用することも可能です。以下にその方法を示します。

`UIApplicationDelegateAdaptor`を使って`AppDelegate`を統合し、それを任意のSwiftUIのビュー内で使用する方法を紹介します。

```swift
import SwiftUI
import UIKit

// AppDelegateクラスを作成
class AppDelegate: NSObject, UIApplicationDelegate {
    func application(_ application: UIApplication,
                     didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data) {
        // デバイストークンを取得した後の処理をここに書きます
        print("Device Token: \(deviceToken)")
    }

    func application(_ application: UIApplication,
                     didFailToRegisterForRemoteNotificationsWithError error: Error) {
        // エラーが発生した場合の処理をここに書きます
        print("Failed to register for remote notifications: \(error)")
    }
}

@main
struct YourApp: App {
    var body: some Scene {
        WindowGroup {
            ContentView()
        }
    }
}

struct ContentView: View {
    @UIApplicationDelegateAdaptor(AppDelegate.self) var appDelegate

    var body: some View {
        Text("Hello, world!")
            .padding()
            .onAppear {
                // リモート通知の登録をリクエスト
                UIApplication.shared.registerForRemoteNotifications()
                
                // 通知の許可を要求
                UNUserNotificationCenter.current().requestAuthorization(options: [.alert, .sound, .badge]) { granted, error in
                    if granted {
                        DispatchQueue.main.async {
                            UIApplication.shared.registerForRemoteNotifications()
                        }
                    } else {
                        print("Notification permission denied.")
                    }
                    if let error = error {
                        print("Error requesting notification authorization: \(error)")
                    }
                }
            }
    }
}
```

この例では、`ContentView`の中で`@UIApplicationDelegateAdaptor`を使って`AppDelegate`を統合しています。これにより、`App`プロトコルを実装する構造体以外の任意の場所で`UIApplicationDelegateAdaptor`を使用することができます。ビューの表示と同時にリモート通知の登録や通知許可の要求を行うことができます。

---
