# ãƒ—ãƒ­ãƒˆã‚³ãƒ«çµ±åˆæ–¹æ³•

æ—¥ä»˜: 2024-10-16

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/10/16 20:31:24*

Swiftã§protocolã¨protocolåŒå£«ã®ãƒãƒƒãƒ”ãƒ³ã‚°ãŒã—ãŸã„

protocol SubscriptionRepository {
    func getActiveSubscriptions() async throws -&gt; \[Subscription\]
    func deleteStripeSubscription() async throws -&gt; DeletedSubscription
}

protocol JobsApiClientModule.SubscriptionRepository {
    func getActiveSubscriptions() async throws -&gt; \[Subscription\]
    func deleteStripeSubscription() async throws -&gt; DeletedSubscription
}


public protocol JobsApiClientModule.SubscriptionRepository {
    func postAppleSubscribe(receiptData: String) async throws
}

public class JobsApiClientModule.SubscriptionRepositoryImpl: JobsApiClientModule.SubscriptionRepository {

    public static func newInstance() -&gt; SubscriptionRepositoryImpl {
        return .init()
    }

    public func postAppleSubscribe(receiptData: String) async throws {
        let appId = PostSubscribeRequestDTO.AppIdDTO.allCases.first(where: { $0.rawValue == JobsApiSettings.appId })!
        do {
            let dto = try await JobsIOSOpenAPI.SubscriptionAPI.postAppleSubscribe(postSubscribeRequestDTO: .init(receiptData: receiptData, appId: appId))
            print("jobs /api/v1/apple/subscribe: send receipt data success! \\(dto)")
        } catch {
            print(error)
            throw error
        }
    }
}

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/10/16 20:31:51*

ã“ã®å ´åˆã€2ã¤ã® `SubscriptionRepository` ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãŒåˆ¥ã€…ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆ`JobsApiClientModule` ã¨é€šå¸¸ã® `SubscriptionRepository`ï¼‰ã«å®šç¾©ã•ã‚Œã¦ãŠã‚Šã€ã“ã‚Œã‚‰ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ã¾ãŸã¯çµ±åˆã—ãŸã„ã¨è€ƒãˆã¦ã„ã‚‹ã‚ˆã†ã§ã™ã­ã€‚

ä¸€ã¤ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¨ã—ã¦ã€`SubscriptionRepository` ã¨ `JobsApiClientModule.SubscriptionRepository` ã®æ©Ÿèƒ½ã‚’çµ±åˆã™ã‚‹ãŸã‚ã«ã€å…±é€šã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’å®šç¾©ã—ã€`JobsApiClientModule.SubscriptionRepository` ã‚’ãã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«æº–æ‹ ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã•ã‚‰ã«ã€ãã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«å¯¾ã—ã¦ã©ã¡ã‚‰ã®æ©Ÿèƒ½ã‚‚å®Ÿè£…ã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã€ä¸¡è€…ã‚’çµ±åˆã§ãã¾ã™ã€‚

### è§£æ±ºç­–

```swift
// å…±é€šãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’å®šç¾©ã™ã‚‹
public protocol UnifiedSubscriptionRepository {
    func getActiveSubscriptions() async throws -> [Subscription]
    func deleteStripeSubscription() async throws -> DeletedSubscription
    func postAppleSubscribe(receiptData: String) async throws
}

// æ—¢å­˜ã® `JobsApiClientModule.SubscriptionRepository` ã«ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’é©ç”¨ã™ã‚‹
public class JobsApiClientModuleSubscriptionRepositoryImpl: JobsApiClientModule.SubscriptionRepository, UnifiedSubscriptionRepository {
    
    public static func newInstance() -> JobsApiClientModuleSubscriptionRepositoryImpl {
        return .init()
    }

    public func getActiveSubscriptions() async throws -> [Subscription] {
        // å®Ÿéš›ã®å®Ÿè£…ã‚’è¿½åŠ ã™ã‚‹
        return []
    }

    public func deleteStripeSubscription() async throws -> DeletedSubscription {
        // å®Ÿéš›ã®å®Ÿè£…ã‚’è¿½åŠ ã™ã‚‹
        return DeletedSubscription()
    }

    public func postAppleSubscribe(receiptData: String) async throws {
        let appId = PostSubscribeRequestDTO.AppIdDTO.allCases.first(where: { $0.rawValue == JobsApiSettings.appId })!
        do {
            let dto = try await JobsIOSOpenAPI.SubscriptionAPI.postAppleSubscribe(postSubscribeRequestDTO: .init(receiptData: receiptData, appId: appId))
            print("jobs /api/v1/apple/subscribe: send receipt data success! \(dto)")
        } catch {
            print(error)
            throw error
        }
    }
}
```

### ãƒã‚¤ãƒ³ãƒˆ
1. `UnifiedSubscriptionRepository` ã¨ã„ã†å…±é€šã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä½œæˆã—ã¦ã€ä¸¡æ–¹ã®æ©Ÿèƒ½ã‚’å«ã‚ã¾ã—ãŸã€‚
2. `JobsApiClientModule.SubscriptionRepository` ã«åŠ ãˆã¦ã€`UnifiedSubscriptionRepository` ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«æº–æ‹ ã—ãŸã‚¯ãƒ©ã‚¹ `JobsApiClientModuleSubscriptionRepositoryImpl` ã‚’ä½œæˆã—ã¾ã—ãŸã€‚
3. ã“ã®ã‚¯ãƒ©ã‚¹ã§ã€ä¸¡æ–¹ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã€çµ±ä¸€çš„ã«æ‰±ã†ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®æ–¹æ³•ã«ã‚ˆã‚Šã€è¤‡æ•°ã® `SubscriptionRepository` ã‚’åŒæ™‚ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¦ç®¡ç†ã§ãã¾ã™ã€‚

---
