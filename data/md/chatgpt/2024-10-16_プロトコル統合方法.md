# プロトコル統合方法

日付: 2024-10-16

---

## 👤 ユーザー
*2024/10/16 20:31:24*

Swiftでprotocolとprotocol同士のマッピングがしたい

protocol SubscriptionRepository {
    func getActiveSubscriptions() async throws -&gt; \[Subscription\]
    func deleteStripeSubscription() async throws -&gt; DeletedSubscription
}

protocol JobsApiClientModule.SubscriptionRepository {
    func getActiveSubscriptions() async throws -&gt; \[Subscription\]
    func deleteStripeSubscription() async throws -&gt; DeletedSubscription
}


public protocol JobsApiClientModule.SubscriptionRepository {
    func postAppleSubscribe(receiptData: String) async throws
}

public class JobsApiClientModule.SubscriptionRepositoryImpl: JobsApiClientModule.SubscriptionRepository {

    public static func newInstance() -&gt; SubscriptionRepositoryImpl {
        return .init()
    }

    public func postAppleSubscribe(receiptData: String) async throws {
        let appId = PostSubscribeRequestDTO.AppIdDTO.allCases.first(where: { $0.rawValue == JobsApiSettings.appId })!
        do {
            let dto = try await JobsIOSOpenAPI.SubscriptionAPI.postAppleSubscribe(postSubscribeRequestDTO: .init(receiptData: receiptData, appId: appId))
            print("jobs /api/v1/apple/subscribe: send receipt data success! \\(dto)")
        } catch {
            print(error)
            throw error
        }
    }
}

---

## 🤖 アシスタント
*2024/10/16 20:31:51*

この場合、2つの `SubscriptionRepository` プロトコルが別々のモジュール（`JobsApiClientModule` と通常の `SubscriptionRepository`）に定義されており、これらをマッピングまたは統合したいと考えているようですね。

一つのアプローチとして、`SubscriptionRepository` と `JobsApiClientModule.SubscriptionRepository` の機能を統合するために、共通のプロトコルを定義し、`JobsApiClientModule.SubscriptionRepository` をそのプロトコルに準拠させることができます。さらに、そのプロトコルに対してどちらの機能も実装するクラスを作成することで、両者を統合できます。

### 解決策

```swift
// 共通プロトコルを定義する
public protocol UnifiedSubscriptionRepository {
    func getActiveSubscriptions() async throws -> [Subscription]
    func deleteStripeSubscription() async throws -> DeletedSubscription
    func postAppleSubscribe(receiptData: String) async throws
}

// 既存の `JobsApiClientModule.SubscriptionRepository` にプロトコルを適用する
public class JobsApiClientModuleSubscriptionRepositoryImpl: JobsApiClientModule.SubscriptionRepository, UnifiedSubscriptionRepository {
    
    public static func newInstance() -> JobsApiClientModuleSubscriptionRepositoryImpl {
        return .init()
    }

    public func getActiveSubscriptions() async throws -> [Subscription] {
        // 実際の実装を追加する
        return []
    }

    public func deleteStripeSubscription() async throws -> DeletedSubscription {
        // 実際の実装を追加する
        return DeletedSubscription()
    }

    public func postAppleSubscribe(receiptData: String) async throws {
        let appId = PostSubscribeRequestDTO.AppIdDTO.allCases.first(where: { $0.rawValue == JobsApiSettings.appId })!
        do {
            let dto = try await JobsIOSOpenAPI.SubscriptionAPI.postAppleSubscribe(postSubscribeRequestDTO: .init(receiptData: receiptData, appId: appId))
            print("jobs /api/v1/apple/subscribe: send receipt data success! \(dto)")
        } catch {
            print(error)
            throw error
        }
    }
}
```

### ポイント
1. `UnifiedSubscriptionRepository` という共通のプロトコルを作成して、両方の機能を含めました。
2. `JobsApiClientModule.SubscriptionRepository` に加えて、`UnifiedSubscriptionRepository` プロトコルに準拠したクラス `JobsApiClientModuleSubscriptionRepositoryImpl` を作成しました。
3. このクラスで、両方のプロトコルのメソッドを実装することで、統一的に扱うことができます。

この方法により、複数の `SubscriptionRepository` を同時にマッピングして管理できます。

---
