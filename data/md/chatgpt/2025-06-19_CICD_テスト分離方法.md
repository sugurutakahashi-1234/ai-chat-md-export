# CICD テスト分離方法

日付: 2025-06-19

---

## 👤 ユーザー
*2025/06/19 11:59:16*

CICD上でストーリーブックのテストを実行してほしくない。 つまり普通のテストとストーリーブックのテストを分けたい。 今は普通のテストをやるとストーリーブックのテストも同時に行われてしまっている。 それをどうやったら分離することができるか考えてほしい。 

  "scripts": {
    "// 🚀 開発・実行": "",
    "dev": "vite",
    "dev:mock:server": "prism mock ../api-client/openapi.yaml -h 0.0.0.0 -p 4010",
    "dev:mock:web": "VITE_USE_PRISM_MOCK=true VITE_APP_ENV=local vite",
    "start": "vite preview",
    "// 🏗️ ビルド・品質管理": "",
    "build": "vite build",
    "typecheck": "tsc -p . --noEmit",
    "lint": "biome check .",
    "lint:fix": "biome check . --write",
    "test": "vitest --run && echo '\n✅ Tests passed!' || (echo '\n🌀 Tests failed!' && exit 1)",
    "test:watch": "vitest",
    "// ✅ 統合検証": "",
    "preverify": "pnpm lint:fix",
    "verify": "pnpm lint && pnpm build && pnpm typecheck && pnpm test",
    "// 🧹 クリーンアップ": "",
    "clean": "rm -rf dist *.tsbuildinfo",
    "// 📖 ドキュメント": "",
    "dev:storybook": "storybook dev -p 6006",
    "build:storybook": "storybook build",
    "test:storybook": "vitest --project=storybook && echo '\n✅ Tests passed!' || (echo '\n🌀 Tests failed!' && exit 1)"
  },


/// &lt;reference types="vitest/config" /&gt;

import path from "node:path";
import { fileURLToPath } from "node:url";
import { storybookTest } from "@storybook/addon-vitest/vitest-plugin";
import tailwindcss from "@tailwindcss/vite";
import react from "@vitejs/plugin-react";
import { defineConfig } from "vitest/config";

const dirname =
  typeof __dirname !== "undefined"
    ? __dirname
    : path.dirname(fileURLToPath(import.meta.url));

// More info at: https://storybook.js.org/docs/next/writing-tests/integrations/vitest-addon
export default defineConfig({
  plugins: [react(), tailwindcss()],
  test: {
    globals: true,
    environment: "jsdom",
    css: true,
    // CSSの処理を有効化
    coverage: {
      provider: "v8",
      reporter: ["text", "json", "html"],
      exclude: ["**/*.config.*", "**/src/generated/**", "**/src/test/**"],
    },
    projects: [
      {
        extends: true,
        plugins: [
          // The plugin will run tests for the stories defined in your Storybook config
          // See options at: https://storybook.js.org/docs/next/writing-tests/integrations/vitest-addon#storybooktest
          storybookTest({
            configDir: path.join(dirname, ".storybook"),
          }),
        ],
        test: {
          name: "storybook",
          browser: {
            enabled: true,
            headless: true,
            provider: "playwright",
            instances: [
              {
                browser: "chromium",
              },
            ],
          },
          setupFiles: [".storybook/vitest.setup.ts"],
        },
      },
    ],
  },
});

---

## 🤖 アシスタント
*2025/06/19 11:59:17*

普通のユニットテストと Storybook の UI テストが **いっしょに走ってしまう原因** は、  
`vitest.config.ts` に **Storybook 用の project** を含めているためです。  
Vitest は `vitest run` を実行すると *すべての project* をまとめて実行する仕様なので、CLI でプロジェクトを指定しない限り Storybook 側まで含まれてしまいます。

---

## 分離するベストプラクティス

### 1. Storybook 用の Vitest 設定を **別ファイル** に分ける

1. **共通設定** を `vitest.config.base.ts` として抽出  
2. 通常テスト用の `vitest.config.ts` は base だけを読み込む  
3. Storybook 専用の `vitest.config.storybook.ts` で  
   `@storybook/addon-vitest/vitest-plugin` を組み込む

```ts
// vitest.config.base.ts
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';
import tailwindcss from '@tailwindcss/vite';

export default defineConfig({
  plugins: [react(), tailwindcss()],
  test: {
    globals: true,
    environment: 'jsdom',
    css: true,
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        '**/*.config.*',
        '**/src/generated/**',
        '**/src/test/**',
      ],
    },
  },
});
```

```ts
// vitest.config.ts  ── 🔍 ユニットテスト用
import { mergeConfig } from 'vitest/config';
import base from './vitest.config.base';

export default mergeConfig(base, {
  // 追加設定が何もなければそのまま
});
```

```ts
// vitest.config.storybook.ts ── 📚 Storybook テスト用
import { mergeConfig } from 'vitest/config';
import base from './vitest.config.base';
import { storybookTest } from '@storybook/addon-vitest/vitest-plugin';
import path from 'node:path';

export default mergeConfig(base, {
  test: {
    name: 'storybook',
    plugins: [
      storybookTest({
        configDir: path.join(__dirname, '.storybook'),
      }),
    ],
    browser: {
      enabled: true,
      headless: true,
      provider: 'playwright',
      instances: [{ browser: 'chromium' }],
    },
    setupFiles: ['.storybook/vitest.setup.ts'],
  },
});
```

### 2. **npm Scripts** を整理

```jsonc
{
  "scripts": {
    "// 🧪 ユニットテスト": "",
    "test": "vitest run -c vitest.config.ts && echo '\\n✅ Unit tests passed!'",
    "test:watch": "vitest -c vitest.config.ts",

    "// 📚 Storybook テスト": "",
    "test:storybook": "vitest run -c vitest.config.storybook.ts && echo '\\n✅ Storybook tests passed!'",

    "// ✅ 統合検証": "",
    "verify": "pnpm lint && pnpm build && pnpm typecheck && pnpm test"
  }
}
```

*ポイント*

* `-c`/`--config` で **読み込む設定ファイルを明示** する  
* `verify` では **ユニットテストだけ** を実行するように変更  
  （Storybook テストは別ジョブや Nightly で回すのが定番）

### 3. CI/CD ワークフロー例（GitHub Actions）

```yaml
name: CI

concurrency: ci-${{ github.ref }}

jobs:
  unit-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with: { version: 9 }
      - run: pnpm install --frozen-lockfile
      - run: pnpm verify          # ユニットテストのみ

  storybook-test:
    needs: unit-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with: { version: 9 }
      - run: pnpm install --frozen-lockfile
      - run: pnpm test:storybook # Playwright を含む Storybook テスト
```

---

## そのほかの分離パターン（参考）

| 方法 | 仕組み | メリット | デメリット |
|------|--------|----------|-----------|
| **`--projects` フラグ** | 1 つの config に &lt;br&gt;`projects: [{ name:'unit' }, { name:'storybook' }]` &lt;br&gt;を定義し、&lt;br&gt;`vitest run --projects unit` で絞り込み | 設定ファイルが 1 つで済む | script が少し冗長に&lt;br&gt;なりやすい |
| **環境変数で切り替え** | `if (process.env.STORYBOOK_TEST) { projects.push(storybookProject) }` | スクリプトを変えずとも環境で制御可 | 設定が読みにくくなる |
| **完全別リポジトリ/パッケージに分ける** | Storybook を別ワークスペースに切り出す | 依存を物理的に分離 | ストーリーブック開発がやや面倒 |

実務では **“別 config ファイル”** がもっともシンプルでトラブルが少ないため、まずは上記手順で運用してみることをおすすめします。

---

## 👤 ユーザー
*2025/06/19 12:00:41*

なるほど。共通ファイルを作るのはやめて、それぞれある程度重複してもいいから別々のを作ろうか。

---

## 🤖 アシスタント
*2025/06/19 12:00:42*

では **完全に別ファイル** で用意する形に振り切りましょう。  
多少の重複はあっても “読みやすさ” と “想定外に一緒に走らない安心感” を優先します。

---

## 1. `vitest.config.ts`  ―― ユニットテスト専用

```ts
/// <reference types="vitest/config" />

import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';
import tailwindcss from '@tailwindcss/vite';

export default defineConfig({
  plugins: [react(), tailwindcss()],
  test: {
    globals: true,
    environment: 'jsdom',
    css: true,
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        '**/*.config.*',
        '**/src/generated/**',
        '**/src/test/**',
      ],
    },
  },
});
```

&gt; **ポイント**  
&gt; Storybook 関連プラグインや browser 設定を一切入れず、通常の JSDOM 環境に限定。

---

## 2. `vitest.config.storybook.ts`  ―― Storybook テスト専用

```ts
/// <reference types="vitest/config" />

import { defineConfig } from 'vitest/config';
import { storybookTest } from '@storybook/addon-vitest/vitest-plugin';
import react from '@vitejs/plugin-react';
import tailwindcss from '@tailwindcss/vite';
import path from 'node:path';

export default defineConfig({
  plugins: [react(), tailwindcss()],
  test: {
    name: 'storybook',
    globals: true,
    environment: 'jsdom',          // Storybook でも JSDOM が推奨
    css: true,
    plugins: [
      storybookTest({
        configDir: path.join(__dirname, '.storybook'),
      }),
    ],
    setupFiles: ['.storybook/vitest.setup.ts'],
    browser: {
      enabled: true,
      headless: true,
      provider: 'playwright',
      instances: [{ browser: 'chromium' }],
    },
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
    },
  },
});
```

&gt; **ポイント**  
&gt; Storybook 固有の設定だけをこちらに閉じ込め、ユニットテスト側に漏れないようにします。

---

## 3. `package.json` のスクリプト整理

```jsonc
{
  "scripts": {
    "// 🚀 開発・実行": "",
    "dev": "vite",
    "dev:mock:server": "prism mock ../api-client/openapi.yaml -h 0.0.0.0 -p 4010",
    "dev:mock:web": "VITE_USE_PRISM_MOCK=true VITE_APP_ENV=local vite",
    "start": "vite preview",

    "// 🏗️ ビルド・品質管理": "",
    "build": "vite build",
    "typecheck": "tsc -p . --noEmit",
    "lint": "biome check .",
    "lint:fix": "biome check . --write",

    "// 🧪 テスト": "",
    "test": "vitest run -c vitest.config.ts && echo '\\n✅ Unit tests passed!' || (echo '\\n🌀 Unit tests failed!' && exit 1)",
    "test:watch": "vitest -c vitest.config.ts",
    "test:storybook": "vitest run -c vitest.config.storybook.ts && echo '\\n✅ Storybook tests passed!' || (echo '\\n🌀 Storybook tests failed!' && exit 1)",

    "// ✅ 統合検証": "",
    "verify": "pnpm lint && pnpm build && pnpm typecheck && pnpm test",

    "// 🧹 クリーンアップ": "",
    "clean": "rm -rf dist *.tsbuildinfo",

    "// 📖 ドキュメント": "",
    "dev:storybook": "storybook dev -p 6006",
    "build:storybook": "storybook build"
  }
}
```

* `test` / `test:watch` は **ユニットテスト** のみを対象  
* `test:storybook` で **Storybook テスト** を個別実行  
* `verify` に含めるのはユニットテストまで（Storybook テストは別ジョブや夜間バッチで回すケースが多い）

---

## 4. CI/CD（GitHub Actions 例）

```yaml
name: CI

jobs:
  unit-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with: { version: 9 }
      - run: pnpm install --frozen-lockfile
      - run: pnpm verify        # ユニットテストだけ

  storybook-test:
    needs: unit-test            # ユニットテストが通ってから
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with: { version: 9 }
      - run: pnpm install --frozen-lockfile
      - run: pnpm test:storybook
```

---

### これで解決 🎉

* **通常開発・PR チェック** … `pnpm verify`（ユニットテストのみ）
* **UI 回帰テスト** … `pnpm test:storybook`（Playwright 連携 Storybook テスト）

重複は多少ありますが “設定を開けば意図がすぐわかる” ほうが運用しやすいので、まずはこの形で回してみてください。

---

## 👤 ユーザー
*2025/06/19 12:02:04*

ちなみに普通のテストの方は、 -c で指定する必要あるのか。 vitest run -c vitest.config.ts

---

## 🤖 アシスタント
*2025/06/19 12:02:05*

**結論：必須ではない** けれど、  
*「常にそのファイルだけを使う」と明示したいなら付けたほうが安全* です。

---

### Vitest のデフォルト探索ルール

1. `vitest run` を実行すると、カレントディレクトリから順に  
   - `vite.config.*`（あればその `test` セクション）  
   - `vitest.config.*`  
   を探して最初に見つかった設定を読み込みます。  
2. あなたが通常テスト用に **`vitest.config.ts`** を置いているなら、  
   Storybook 用 (`vitest.config.storybook.ts`) は名前パターンが違うので **自動的に無視** されます。

したがって **`vitest run` だけで通常テストは実行される** ので  
`-c vitest.config.ts` は *技術的には不要* です。

---

### それでも `-c` を付けるメリット

| 付けない (`vitest run`) | 付ける (`vitest run -c vitest.config.ts`) |
|-------------------------|-------------------------------------------|
| 設定ファイルの名前をデフォルトから変えた場合にスクリプトを書き換える必要が出る | **どこに置いても確実にそのファイルが使われる** |
| 将来 Storybook 以外のテストプロジェクトを追加したとき、誤って実行してしまう可能性がある | **意図しない project が混ざるリスクをゼロにできる** |
| CLI が短くて少しだけタイプ量が減る | チームメンバーがスクリプトを読んだ瞬間に「この config を使うんだ」と理解できる |

CI や共同開発では **明示的にしておくほうが事故が少ない** ので、私は  
```jsonc
"test": "vitest run -c vitest.config.ts"
```  
のままを推奨します。  
ローカルで手打ちが面倒なら `pnpm test` のエイリアスを使えば済むので負担はほぼありません。

---
