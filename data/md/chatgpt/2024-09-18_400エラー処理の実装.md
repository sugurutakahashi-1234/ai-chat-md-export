# 400ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®å®Ÿè£…

æ—¥ä»˜: 2024-09-18

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/9/18 15:00:27*

ã“ã“ã« 400 ã§"code": "content_filter", ã‚’æ¤œå‡ºã—ã¦ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã—ãŸã„

    private func postMessage(
        threadId: Int,
        messageRequestDTO: MessageRequestDTO,
        isLastMessage: Bool = false
    ) async throws -&gt; Result&lt;Message, PostMessageError&gt; {
        do {
            let message = try await api.postMessage(threadId: threadId, request: messageRequestDTO).toDomain(isLastMessage: isLastMessage)
            return .success(message)
        } catch {
            guard let error = error as? OpenAPIClient.ErrorResponse else {
                throw APIError.unexpectedResponse
            }

            guard error.statusCode == 429,
                  let data = error.data,
                  let response429 = try? JSONDecoder().decode(ErrorDTO.self, from: data)
            else {
                throw APIError.unexpectedResponse
            }

            switch response429.code {
            case errorCodeRateLimit:
                return .failure(.rateLimit)
            default:
                throw APIError.unexpectedResponse
            }
        }
    }


extension ErrorResponse: LocalizedError, ErrorResponseProtocol {
    public var errorDescription: String? {
        if case .error(let code, let data, _, let error) = self {
            if let error = error as? URLError {
                // show NSURLErrorDomain code
                return "é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡çŠ¶æ³ã‚’ã”ç¢ºèªã„ãŸã ãã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚(\(error.errorCode))"
            }
            else if let data = data, let response = String(data: data, encoding: .utf8) {
                // show status code & response
                return "é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡çŠ¶æ³ã‚’ã”ç¢ºèªã„ãŸã ãã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚(\(code) - \(response))"
            }
            else {
                // got unknown error, show everything
                return "é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡çŠ¶æ³ã‚’ã”ç¢ºèªã„ãŸã ãã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚(\(self))"
            }
        }
        return nil
    }

    var statusCode: Int? {
        if case .error(let code, _, _, _) = self {
            return code
        }
        return nil
    }
    var data: Data? {
        if case .error(_, let data, _, _) = self {
            return data
        }
        return nil
    }
}

public enum ErrorResponse: Error {
    case error(Int, Data?, URLResponse?, Error)
}

{
  "code": "content_filter",
  "message": "The content was filtered. Please modify your prompt and retry."
}

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/9/18 15:00:37*

`400` ã‚¨ãƒ©ãƒ¼ã§ `code: "content_filter"` ã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã«ã¯ã€æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã«ç‰¹å®šã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã—ã¦ã€"content_filter" ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æ¤œå‡ºã—ã€ãã‚Œã«å¿œã˜ãŸå‡¦ç†ã‚’è¡Œã†ã‚ˆã†ã«ã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«ã€æ—¢å­˜ã® `postMessage` ãƒ¡ã‚½ãƒƒãƒ‰ã«ã“ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¿½åŠ ã§ãã¾ã™ã€‚

### å¤‰æ›´å¾Œã®ã‚³ãƒ¼ãƒ‰

```swift
private func postMessage(
    threadId: Int,
    messageRequestDTO: MessageRequestDTO,
    isLastMessage: Bool = false
) async throws -> Result<Message, PostMessageError> {
    do {
        let message = try await api.postMessage(threadId: threadId, request: messageRequestDTO).toDomain(isLastMessage: isLastMessage)
        return .success(message)
    } catch {
        guard let error = error as? OpenAPIClient.ErrorResponse else {
            throw APIError.unexpectedResponse
        }

        guard let data = error.data,
              let errorDTO = try? JSONDecoder().decode(ErrorDTO.self, from: data)
        else {
            throw APIError.unexpectedResponse
        }

        switch (error.statusCode, errorDTO.code) {
        case (400, "content_filter"):
            return .failure(.contentFilter) // æ–°ãŸãªã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã‚’è¿½åŠ 
        case (429, _):
            return .failure(.rateLimit)
        default:
            throw APIError.unexpectedResponse
        }
    }
}
```

### `PostMessageError` ã« `contentFilter` ã‚’è¿½åŠ 

`PostMessageError` ã®å®šç¾©ã«æ–°ã—ã„ã‚±ãƒ¼ã‚¹ã¨ã—ã¦ `contentFilter` ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```swift
enum PostMessageError: Error {
    case rateLimit
    case contentFilter // æ–°ãŸãªã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹
    // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹
}
```

### `ErrorDTO` ã®ä¾‹

`ErrorDTO` ãŒæ¬¡ã®ã‚ˆã†ãªæ§‹é€ ã§ã‚ã‚‹ã¨ä»®å®šã—ã¾ã™:

```swift
struct ErrorDTO: Decodable {
    let code: String
    let message: String
}
```

ã“ã‚Œã«ã‚ˆã‚Šã€`400` ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã€`"code": "content_filter"` ã‚’å«ã‚€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ããŸå ´åˆã€ãã®ã‚¨ãƒ©ãƒ¼ã‚’é©åˆ‡ã«å‡¦ç†ã—ã€`contentFilter` ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦å¤±æ•—ã‚’è¿”ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã‚Œã§ã€"content_filter" ã«å¯¾å¿œã™ã‚‹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒè¡Œãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/9/18 15:01:32*

struct ErrorDTO: Codable {

    var code: String
    var message: String

    enum CodingKeys: String, CodingKey {
        case code
        case message
    }
}

ã ã£ãŸã€‚

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/9/18 15:01:43*

`ErrorDTO` ã®å®šç¾©ãŒ `Codable` æº–æ‹ ã§ã€`CodingKeys` ã‚’ä½¿ç”¨ã—ã¦ `code` ã¨ `message` ã‚’å®šç¾©ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚ã“ã®å ´åˆã€å…ˆã»ã©ã®ä¿®æ­£æ¡ˆã«ãã®ã¾ã¾é©ç”¨å¯èƒ½ã§ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯ã€`ErrorDTO` ã®å®šç¾©ã‚’ãã®ã¾ã¾ä½¿ç”¨ã—ã¦ã€400 ã‚¨ãƒ©ãƒ¼ã§ `content_filter` ã‚’æ¤œå‡ºã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’çµ„ã¿è¾¼ã‚“ã ã‚‚ã®ã§ã™ã€‚

### ä¿®æ­£ç‰ˆã‚³ãƒ¼ãƒ‰

```swift
private func postMessage(
    threadId: Int,
    messageRequestDTO: MessageRequestDTO,
    isLastMessage: Bool = false
) async throws -> Result<Message, PostMessageError> {
    do {
        let message = try await api.postMessage(threadId: threadId, request: messageRequestDTO).toDomain(isLastMessage: isLastMessage)
        return .success(message)
    } catch {
        guard let error = error as? OpenAPIClient.ErrorResponse else {
            throw APIError.unexpectedResponse
        }

        guard let data = error.data,
              let errorDTO = try? JSONDecoder().decode(ErrorDTO.self, from: data)
        else {
            throw APIError.unexpectedResponse
        }

        switch (error.statusCode, errorDTO.code) {
        case (400, "content_filter"):
            return .failure(.contentFilter) // æ–°ãŸãªã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹
        case (429, _):
            return .failure(.rateLimit)
        default:
            throw APIError.unexpectedResponse
        }
    }
}
```

### `ErrorDTO` ã®å®šç¾©

`ErrorDTO` ã¯ä»¥ä¸‹ã®å®šç¾©ã®ã¾ã¾ã§å•é¡Œã‚ã‚Šã¾ã›ã‚“:

```swift
struct ErrorDTO: Codable {
    var code: String
    var message: String

    enum CodingKeys: String, CodingKey {
        case code
        case message
    }
}
```

### `PostMessageError` ã« `contentFilter` ã‚’è¿½åŠ 

`PostMessageError` ã« `contentFilter` ã‚’è¿½åŠ ã—ã¦ã€`content_filter` ã‚¨ãƒ©ãƒ¼ã«å¯¾å¿œã—ã¾ã™ã€‚

```swift
enum PostMessageError: Error {
    case rateLimit
    case contentFilter // æ–°ãŸãªã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹
    // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹
}
```

ã“ã‚Œã§ã€`400` ã‚¨ãƒ©ãƒ¼ã§ `"code": "content_filter"` ãŒè¿”ã£ã¦ããŸå ´åˆã«ã€ãã®ã‚¨ãƒ©ãƒ¼ã‚’é©åˆ‡ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/9/18 15:02:04*

enum PostMessageError: Error {
    case rateLimit
}
ã ã£ãŸã€‚

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/9/18 15:02:12*

User's `PostMessageError` enum previously only had a `rateLimit` case and is now being updated to include a `contentFilter` case.

---

## ğŸ”§ ãƒ„ãƒ¼ãƒ«
*2024/9/18 15:02:12*

Model set context updated.

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/9/18 15:02:12*

`PostMessageError` ã« `contentFilter` ã‚±ãƒ¼ã‚¹ã‚’è¿½åŠ ã™ã‚‹ä¿®æ­£ã‚’é©ç”¨ã—ã¾ã™ã€‚æ—¢å­˜ã® `PostMessageError` ãŒ `rateLimit` ã—ã‹å«ã‚“ã§ã„ãªã‹ã£ãŸãŸã‚ã€`contentFilter` ã‚±ãƒ¼ã‚¹ã‚’è¿½åŠ ã™ã‚‹ã ã‘ã§ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã§ãã¾ã™ã€‚

### ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰

```swift
private func postMessage(
    threadId: Int,
    messageRequestDTO: MessageRequestDTO,
    isLastMessage: Bool = false
) async throws -> Result<Message, PostMessageError> {
    do {
        let message = try await api.postMessage(threadId: threadId, request: messageRequestDTO).toDomain(isLastMessage: isLastMessage)
        return .success(message)
    } catch {
        guard let error = error as? OpenAPIClient.ErrorResponse else {
            throw APIError.unexpectedResponse
        }

        guard let data = error.data,
              let errorDTO = try? JSONDecoder().decode(ErrorDTO.self, from: data)
        else {
            throw APIError.unexpectedResponse
        }

        switch (error.statusCode, errorDTO.code) {
        case (400, "content_filter"):
            return .failure(.contentFilter) // æ–°ãŸãªã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹
        case (429, _):
            return .failure(.rateLimit)
        default:
            throw APIError.unexpectedResponse
        }
    }
}
```

### `PostMessageError` ã®ä¿®æ­£

`PostMessageError` ã« `contentFilter` ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```swift
enum PostMessageError: Error {
    case rateLimit
    case contentFilter // æ–°ãŸãªã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹
}
```

ã“ã‚Œã«ã‚ˆã‚Šã€`400` ã‚¨ãƒ©ãƒ¼ã§ `"content_filter"` ãŒè¿”ã£ã¦ããŸå ´åˆã€`contentFilter` ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦å‡¦ç†ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/9/18 16:05:43*

ã“ã†ã—ãŸã„ã€‚enum PostMessageError: Error {
    /// 400
    enum BadRequest: String {
        case contentFilter = "content_filter"
    }
    /// 429
    case rateLimit
}

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/9/18 16:05:55*

ä»¥ä¸‹ã®ã‚ˆã†ã« `PostMessageError` ã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã€`BadRequest` ã¨ã„ã†å†…éƒ¨ `enum` ã‚’ä½¿ã£ã¦ã€`400` ã‚¨ãƒ©ãƒ¼ã«å¯¾ã™ã‚‹ `contentFilter` ã‚’ `BadRequest` å†…ã§å‡¦ç†ã—ã€ä»–ã®ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã‚‚é©åˆ‡ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

### ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰

```swift
enum PostMessageError: Error {
    /// 400 Bad Request ã‚¨ãƒ©ãƒ¼
    enum BadRequest: String {
        case contentFilter = "content_filter"
    }
    
    /// 429 Rate Limit ã‚¨ãƒ©ãƒ¼
    case rateLimit
    
    /// 400 ã‚¨ãƒ©ãƒ¼ã‚’å«ã‚€ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
    case badRequest(BadRequest)
}

private func postMessage(
    threadId: Int,
    messageRequestDTO: MessageRequestDTO,
    isLastMessage: Bool = false
) async throws -> Result<Message, PostMessageError> {
    do {
        let message = try await api.postMessage(threadId: threadId, request: messageRequestDTO).toDomain(isLastMessage: isLastMessage)
        return .success(message)
    } catch {
        guard let error = error as? OpenAPIClient.ErrorResponse else {
            throw APIError.unexpectedResponse
        }

        guard let data = error.data,
              let errorDTO = try? JSONDecoder().decode(ErrorDTO.self, from: data)
        else {
            throw APIError.unexpectedResponse
        }

        switch (error.statusCode, errorDTO.code) {
        case (400, "content_filter"):
            return .failure(.badRequest(.contentFilter)) // BadRequest enumã‚’ä½¿ç”¨
        case (429, _):
            return .failure(.rateLimit)
        default:
            throw APIError.unexpectedResponse
        }
    }
}
```

### å¤‰æ›´ç‚¹

1. `PostMessageError` å†…ã« `BadRequest` ã¨ã„ã†å†…éƒ¨ `enum` ã‚’ä½œæˆã—ã€`contentFilter` ã®ã‚ˆã†ãªç‰¹å®šã® `400` ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æ‰±ã†ã‚±ãƒ¼ã‚¹ã‚’è¿½åŠ ã€‚
2. `postMessage` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ `400` ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€`BadRequest` å†…ã®é©åˆ‡ãªã‚±ãƒ¼ã‚¹ï¼ˆã“ã“ã§ã¯ `contentFilter`ï¼‰ã‚’è¿”ã™ã‚ˆã†ã«å¤‰æ›´ã€‚
3. `429` ã‚¨ãƒ©ãƒ¼ã¯æ—¢å­˜ã® `rateLimit` ã‚±ãƒ¼ã‚¹ã§ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€‚

ã“ã‚Œã§ `400` ã‚¨ãƒ©ãƒ¼ã«å¯¾ã™ã‚‹ `content_filter` ã®å‡¦ç†ã¨ã€`429` ã‚¨ãƒ©ãƒ¼ã«å¯¾ã™ã‚‹ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆå‡¦ç†ãŒä¸¡æ–¹å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/9/18 16:06:10*

case (400, "content_filter"): ã®åˆ¤å®šã‚’enumä»»ã›ã«ã„ãŸã„

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/9/18 16:06:39*

`400` ã‚¨ãƒ©ãƒ¼ã®åˆ¤å®šã‚’ `PostMessageError.BadRequest` ã«å§”ã­ãŸã„å ´åˆã€`enum` å†…ã§ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’å‡¦ç†ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€`case (400, "content_filter")` ã®ã‚ˆã†ãªåˆ¤å®šã‚’ `BadRequest` ã® `rawValue` ã«ä¾å­˜ã•ã›ãšã€`BadRequest` enum ã«ã‚³ãƒ¼ãƒ‰ã‚’ç§»è­²ã§ãã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã« `PostMessageError.BadRequest` ã« `init` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã—ã€`errorDTO.code` ã®åˆ¤å®šã‚’ `BadRequest` ã®è²¬ä»»ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰

```swift
enum PostMessageError: Error {
    /// 400 Bad Request ã‚¨ãƒ©ãƒ¼
    enum BadRequest: String {
        case contentFilter = "content_filter"
        
        init?(code: String) {
            self.init(rawValue: code)
        }
    }
    
    /// 429 Rate Limit ã‚¨ãƒ©ãƒ¼
    case rateLimit
    
    /// 400 ã‚¨ãƒ©ãƒ¼ã‚’å«ã‚€ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
    case badRequest(BadRequest)
}

private func postMessage(
    threadId: Int,
    messageRequestDTO: MessageRequestDTO,
    isLastMessage: Bool = false
) async throws -> Result<Message, PostMessageError> {
    do {
        let message = try await api.postMessage(threadId: threadId, request: messageRequestDTO).toDomain(isLastMessage: isLastMessage)
        return .success(message)
    } catch {
        guard let error = error as? OpenAPIClient.ErrorResponse else {
            throw APIError.unexpectedResponse
        }

        guard let data = error.data,
              let errorDTO = try? JSONDecoder().decode(ErrorDTO.self, from: data)
        else {
            throw APIError.unexpectedResponse
        }

        if let badRequest = PostMessageError.BadRequest(code: errorDTO.code), error.statusCode == 400 {
            return .failure(.badRequest(badRequest)) // 400 ã‚¨ãƒ©ãƒ¼ã‚’BadRequestã«å§”ã­ã‚‹
        } else if error.statusCode == 429 {
            return .failure(.rateLimit)
        } else {
            throw APIError.unexpectedResponse
        }
    }
}
```

### å¤‰æ›´ç‚¹

1. `BadRequest` enum ã« `init?(code: String)` ã‚’è¿½åŠ ã—ã€`errorDTO.code` ã‚’ã‚‚ã¨ã« `BadRequest` ã‚±ãƒ¼ã‚¹ã‚’ç”Ÿæˆã€‚
2. `postMessage` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ã€`PostMessageError.BadRequest` ã®åˆæœŸåŒ–ã‚’é€šã˜ã¦ `400` ã‚¨ãƒ©ãƒ¼ã®åˆ¤å®šã‚’å®Ÿæ–½ã€‚
   - ã“ã‚Œã«ã‚ˆã‚Šã€`400` ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã®åˆ¤å®šã¯ `BadRequest` enum ã®åˆæœŸåŒ–ã«å§”ã­ã‚‰ã‚Œã¾ã™ã€‚
3. `429` ã‚¨ãƒ©ãƒ¼ã¯å¾“æ¥ã©ãŠã‚Š `rateLimit` ã‚±ãƒ¼ã‚¹ã§å‡¦ç†ã€‚

ã“ã‚Œã§ã€`400` ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€`BadRequest` enum ã«ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã®å‡¦ç†ã‚’å§”ã­ã‚‹ã“ã¨ãŒã§ãã€ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã¨æ‹¡å¼µæ€§ãŒå‘ä¸Šã—ã¾ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/9/18 16:07:06*

ãªã‚‹ã¹ãSwitchæ–‡ã«ã—ãŸã„

if let badRequest = PostMessageError.BadRequest(code: errorDTO.code), error.statusCode == 400 {
            return .failure(.badRequest(badRequest)) // 400 ã‚¨ãƒ©ãƒ¼ã‚’BadRequestã«å§”ã­ã‚‹
        } else if error.statusCode == 429 {
            return .failure(.rateLimit)
        } else {
            throw APIError.unexpectedResponse
        }

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/9/18 16:07:28*

`switch` æ–‡ã‚’ä½¿ã£ã¦ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«ã™ã‚‹ãŸã‚ã«ã€`error.statusCode` ã¨ `errorDTO.code` ã‚’ `switch` æ–‡ã®ä¸­ã§å‡¦ç†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚`PostMessageError.BadRequest` ã®åˆæœŸåŒ–ãƒ­ã‚¸ãƒƒã‚¯ã‚’ `switch` æ–‡ã«çµ„ã¿è¾¼ã¿ã€`400` ã‚„ `429` ãªã©ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã«å¿œã˜ã¦é©åˆ‡ã«å‡¦ç†ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã§ãã¾ã™ï¼š

### ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰

```swift
private func postMessage(
    threadId: Int,
    messageRequestDTO: MessageRequestDTO,
    isLastMessage: Bool = false
) async throws -> Result<Message, PostMessageError> {
    do {
        let message = try await api.postMessage(threadId: threadId, request: messageRequestDTO).toDomain(isLastMessage: isLastMessage)
        return .success(message)
    } catch {
        guard let error = error as? OpenAPIClient.ErrorResponse else {
            throw APIError.unexpectedResponse
        }

        guard let data = error.data,
              let errorDTO = try? JSONDecoder().decode(ErrorDTO.self, from: data)
        else {
            throw APIError.unexpectedResponse
        }

        switch error.statusCode {
        case 400:
            if let badRequest = PostMessageError.BadRequest(code: errorDTO.code) {
                return .failure(.badRequest(badRequest)) // 400 ã‚¨ãƒ©ãƒ¼ã‚’ BadRequest ã«å§”ã­ã‚‹
            } else {
                throw APIError.unexpectedResponse
            }
        case 429:
            return .failure(.rateLimit) // 429 ã‚¨ãƒ©ãƒ¼å‡¦ç†
        default:
            throw APIError.unexpectedResponse
        }
    }
}
```

### å¤‰æ›´ç‚¹

1. `switch` æ–‡ã‚’ `error.statusCode` ã«å¯¾ã—ã¦ä½¿ç”¨ã—ã€`400` ã‚„ `429` ãªã©ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã«å¿œã˜ãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å®Ÿè£…ã€‚
2. `400` ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€`PostMessageError.BadRequest` ã®åˆæœŸåŒ–ã‚’è©¦ã¿ã€é©åˆ‡ãªã‚±ãƒ¼ã‚¹ã«åˆ†å²ã€‚
3. `400` ã§ `BadRequest` ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã§ããªã„å ´åˆã‚„ã€ä»–ã®ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ `APIError.unexpectedResponse` ã‚’æŠ•ã’ã‚‹ã€‚

ã“ã®ã‚ˆã†ã« `switch` æ–‡ã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¡Œã†ã“ã¨ã§ã€å¯èª­æ€§ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ãŒå‘ä¸Šã—ã€ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã«å¿œã˜ãŸå‡¦ç†ãŒã‚·ãƒ³ãƒ—ãƒ«ã«æ•´ç†ã•ã‚Œã¾ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/9/18 16:09:19*

init? ã§ã¯ãªãã‚¹ãƒ­ãƒ¼ã—ã¦ã»ã—ã„

enum APIError: Error {
    case unexpectedResponse
}

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/9/18 16:09:31*

User prefers to throw an error instead of using an optional initializer in their BadRequest error handling.

---

## ğŸ”§ ãƒ„ãƒ¼ãƒ«
*2024/9/18 16:09:31*

Model set context updated.

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/9/18 16:09:31*

`PostMessageError.BadRequest` ã®åˆæœŸåŒ–æ™‚ã«ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã€`init?` ã§ã¯ãªãå¤±æ•—æ™‚ã« `APIError.unexpectedResponse` ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹ã‚ˆã†ã«ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¨ãƒ©ãƒ¼ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒæ˜ç¢ºã«ãªã‚Šã¾ã™ã€‚

ä»¥ä¸‹ãŒã‚¹ãƒ­ãƒ¼ã«å¯¾å¿œã—ãŸä¿®æ­£ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

### ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰

```swift
enum PostMessageError: Error {
    /// 400 Bad Request ã‚¨ãƒ©ãƒ¼
    enum BadRequest: String, Error {
        case contentFilter = "content_filter"
        
        init(code: String) throws {
            guard let badRequest = BadRequest(rawValue: code) else {
                throw APIError.unexpectedResponse // ã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ã‚¹ãƒ­ãƒ¼
            }
            self = badRequest
        }
    }
    
    /// 429 Rate Limit ã‚¨ãƒ©ãƒ¼
    case rateLimit
    
    /// 400 ã‚¨ãƒ©ãƒ¼ã‚’å«ã‚€ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
    case badRequest(BadRequest)
}

private func postMessage(
    threadId: Int,
    messageRequestDTO: MessageRequestDTO,
    isLastMessage: Bool = false
) async throws -> Result<Message, PostMessageError> {
    do {
        let message = try await api.postMessage(threadId: threadId, request: messageRequestDTO).toDomain(isLastMessage: isLastMessage)
        return .success(message)
    } catch {
        guard let error = error as? OpenAPIClient.ErrorResponse else {
            throw APIError.unexpectedResponse
        }

        guard let data = error.data,
              let errorDTO = try? JSONDecoder().decode(ErrorDTO.self, from: data)
        else {
            throw APIError.unexpectedResponse
        }

        switch error.statusCode {
        case 400:
            do {
                let badRequest = try PostMessageError.BadRequest(code: errorDTO.code)
                return .failure(.badRequest(badRequest))
            } catch {
                throw APIError.unexpectedResponse // BadRequest ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ãŸå ´åˆ
            }
        case 429:
            return .failure(.rateLimit)
        default:
            throw APIError.unexpectedResponse
        }
    }
}
```

### å¤‰æ›´ç‚¹

1. `PostMessageError.BadRequest` ã®åˆæœŸåŒ–æ™‚ã«ã€è©²å½“ã™ã‚‹ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼ (`APIError.unexpectedResponse`) ã™ã‚‹ã‚ˆã†ã« `init(code:)` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å¤‰æ›´ã€‚
2. `switch` æ–‡å†…ã§ `BadRequest` ã®åˆæœŸåŒ–ãŒå¤±æ•—ã—ãŸå ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§ã‚¹ãƒ­ãƒ¼ã€‚
3. ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒã‚ˆã‚Šå³å¯†ã«ãªã‚Šã€`optional` ã‚’ä½¿ç”¨ã›ãšã«æ˜ç¢ºã«å¤±æ•—ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹å½¢ã«å¤‰æ›´ã€‚

ã“ã®å®Ÿè£…ã«ã‚ˆã‚Šã€`init?` ã‚’ä½¿ã‚ãšã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã‚¹ãƒ­ãƒ¼ã•ã‚Œã‚‹ãŸã‚ã€ã‚³ãƒ¼ãƒ‰ã®æŒ™å‹•ãŒä¸€è²«æ€§ã‚’æŒã¡ã¾ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/9/18 16:47:12*

ã“ã†ã—ãŸã€‚ç›´ã—ã¦ã»ã—ã„

enum PostMessageError: Error {
    enum BadRequestCode: String {
        case contentFilter = "content_filter"
        
        init(code: String) throws {
            guard let errorCode = BadRequestCode(rawValue: code) else {
                throw APIError.unexpectedResponse
            }
            self = errorCode
        }
    }
    
    enum TooManyRequestCode: String {
        case rateLimit = "rate_limit"
        
        init(code: String) throws {
            guard let errorCode = TooManyRequestCode(rawValue: code) else {
                throw APIError.unexpectedResponse
            }
            self = errorCode
        }
    }
    
    /// 400
    case badRequest(BadRequestCode)
    /// 429
    case tooManyRequest(TooManyRequestCode)
}

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/9/18 16:47:33*

ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚`TooManyRequestCode` ã®éƒ¨åˆ†ã‚‚ `BadRequestCode` ã¨åŒæ§˜ã«æ‰±ã„ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ•´åˆæ€§ã‚’ä¿ã¡ã¤ã¤ã€`TooManyRequestCode` ã§ã¯ãªãç›´æ¥ `rateLimit` ã®ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã‚’ä½¿ã†æ–¹ãŒã‚ˆã‚Šã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ä¿®æ­£ç‰ˆã® `enum` å®šç¾©ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

### ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰

```swift
enum PostMessageError: Error {
    
    /// 400 Bad Request ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰
    enum BadRequestCode: String {
        case contentFilter = "content_filter"
        
        init(code: String) throws {
            guard let errorCode = BadRequestCode(rawValue: code) else {
                throw APIError.unexpectedResponse
            }
            self = errorCode
        }
    }
    
    /// 429 Too Many Requests ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰
    enum TooManyRequestCode: String {
        case rateLimit = "rate_limit"
        
        init(code: String) throws {
            guard let errorCode = TooManyRequestCode(rawValue: code) else {
                throw APIError.unexpectedResponse
            }
            self = errorCode
        }
    }
    
    /// 400 Bad Request
    case badRequest(BadRequestCode)
    
    /// 429 Too Many Requests
    case tooManyRequest(TooManyRequestCode)
}
```

### å¤‰æ›´ç‚¹

1. `PostMessageError.BadRequestCode` ã¨ `PostMessageError.TooManyRequestCode` ã®åˆæœŸåŒ–ãƒ¡ã‚½ãƒƒãƒ‰ã§ã€ã‚³ãƒ¼ãƒ‰ãŒ `rawValue` ã«ãƒãƒƒãƒã—ãªã„å ´åˆã¯ `APIError.unexpectedResponse` ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚
2. `TooManyRequestCode` ã‚’ `PostMessageError` ã®ä¸€éƒ¨ã¨ã—ã¦ç¶­æŒã—ã¦ã„ã¾ã™ãŒã€ã‚‚ã—ã‚³ãƒ¼ãƒ‰ã®æ„å‘³ã«å¿œã˜ã¦ `rateLimit` ã‚’ç›´æ¥ `PostMessageError` å†…ã«å®šç¾©ã™ã‚‹ãªã‚‰ã€`TooManyRequestCode` ã¯ä¸è¦ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼ˆè©³ç´°ãªã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹ãªã‚‰æ®‹ã—ã¦ã‚‚è‰¯ã„ï¼‰ã€‚

ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã€å„ HTTP ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã«å¿œã˜ãŸé©åˆ‡ãªã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’å®Ÿè£…ã§ãã¾ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/9/18 16:47:45*

private func postMessage( ã‚’ä¿®æ­£ã—ã¦ã»ã—ã„

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/9/18 16:48:11*

`postMessage` é–¢æ•°ã«å¯¾ã—ã¦ã€`PostMessageError.BadRequestCode` ãŠã‚ˆã³ `PostMessageError.TooManyRequestCode` ã‚’åˆ©ç”¨ã—ãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¿½åŠ ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€`400` ã‚¨ãƒ©ãƒ¼ (`BadRequest`) ã¨ `429` ã‚¨ãƒ©ãƒ¼ (`TooManyRequest`) ã®å‡¦ç†ãŒ `enum` ã‚’ç”¨ã„ã¦ã‚¹ãƒ­ãƒ¼ã•ã‚Œã‚‹ã‚ˆã†ã«èª¿æ•´ã—ã¾ã™ã€‚

### ä¿®æ­£å¾Œã® `postMessage` é–¢æ•°

```swift
private func postMessage(
    threadId: Int,
    messageRequestDTO: MessageRequestDTO,
    isLastMessage: Bool = false
) async throws -> Result<Message, PostMessageError> {
    do {
        let message = try await api.postMessage(threadId: threadId, request: messageRequestDTO).toDomain(isLastMessage: isLastMessage)
        return .success(message)
    } catch {
        guard let error = error as? OpenAPIClient.ErrorResponse else {
            throw APIError.unexpectedResponse
        }

        guard let data = error.data,
              let errorDTO = try? JSONDecoder().decode(ErrorDTO.self, from: data)
        else {
            throw APIError.unexpectedResponse
        }

        switch error.statusCode {
        case 400:
            do {
                let badRequestCode = try PostMessageError.BadRequestCode(code: errorDTO.code)
                return .failure(.badRequest(badRequestCode))
            } catch {
                throw APIError.unexpectedResponse // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ãŒå‡¦ç†ã§ããªã‹ã£ãŸå ´åˆ
            }
            
        case 429:
            do {
                let tooManyRequestCode = try PostMessageError.TooManyRequestCode(code: errorDTO.code)
                return .failure(.tooManyRequest(tooManyRequestCode))
            } catch {
                throw APIError.unexpectedResponse // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ãŒå‡¦ç†ã§ããªã‹ã£ãŸå ´åˆ
            }

        default:
            throw APIError.unexpectedResponse
        }
    }
}
```

### å¤‰æ›´ç‚¹

1. `switch` æ–‡ã§ `error.statusCode` ã‚’ç¢ºèªã—ã€`400` (`BadRequest`) ã¨ `429` (`TooManyRequest`) ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦ã€ãã‚Œãã‚Œ `PostMessageError.BadRequestCode` ãŠã‚ˆã³ `PostMessageError.TooManyRequestCode` ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚
2. å„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦åˆæœŸåŒ–ãŒå¤±æ•—ã—ãŸå ´åˆã¯ã€`APIError.unexpectedResponse` ã‚’ã‚¹ãƒ­ãƒ¼ã—ã¾ã™ã€‚

ã“ã®ä¿®æ­£ã«ã‚ˆã‚Šã€`postMessage` ãƒ¡ã‚½ãƒƒãƒ‰ã¯ `400` ã‚„ `429` ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦é©åˆ‡ãª `enum` ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹æ§‹é€ ã«ãªã‚Šã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒæ˜ç¢ºã‹ã¤å¼·åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/9/18 18:32:19*

ã“ã†ã—ãŸã„

enum PostMessageError: Error {
    case contentFilter
    case rateLimit
}

enum APIError: Error {
    /// 400
    case badRequest(BadRequestCode)
    /// 429
    case tooManyRequest(TooManyRequestCode)
    /// unexpected
    case unexpectedResponse

    // MARK: - 400
    enum BadRequestCode: String {
        /// `é‡å¤§åº¦ãƒ¬ãƒ™ãƒ«` ãŒ `é«˜` ä»¥ä¸Šã§ç™ºç”Ÿ Ref: https://learn.microsoft.com/ja-jp/azure/ai-services/openai/concepts/content-filter?tabs=definitions%2Cuser-prompt%2Cpython-new#risk-categories
        case contentFilter = "content_filter"
        
        init(code: String) throws {
            guard let errorCode = BadRequestCode(rawValue: code) else {
                throw APIError.unexpectedResponse
            }
            self = errorCode
        }
    }
    
    // MARK: - 429
    enum TooManyRequestCode: String {
        case rateLimit = "rate_limit"
        
        init(code: String) throws {
            guard let errorCode = TooManyRequestCode(rawValue: code) else {
                throw APIError.unexpectedResponse
            }
            self = errorCode
        }
    }
}

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/9/18 18:32:42*

ã”æç¤ºã„ãŸã ã„ãŸ `PostMessageError` ã¨ `APIError` ã®æ§‹é€ ã«åŸºã¥ã„ã¦ã€`postMessage` é–¢æ•°ã‚’ä¿®æ­£ã—ã€`PostMessageError` ã‚’é©åˆ‡ã«ã‚¹ãƒ­ãƒ¼ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

`APIError` ã®ä¸­ã§ `BadRequestCode` ã¨ `TooManyRequestCode` ã‚’å®šç¾©ã—ã€`400` ã¨ `429` ã‚¨ãƒ©ãƒ¼ã‚’ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã—ã¤ã¤ã€å¯¾å¿œã™ã‚‹ `PostMessageError` ã‚’è¿”ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

### ä¿®æ­£å¾Œã® `postMessage` é–¢æ•°

```swift
private func postMessage(
    threadId: Int,
    messageRequestDTO: MessageRequestDTO,
    isLastMessage: Bool = false
) async throws -> Result<Message, PostMessageError> {
    do {
        let message = try await api.postMessage(threadId: threadId, request: messageRequestDTO).toDomain(isLastMessage: isLastMessage)
        return .success(message)
    } catch {
        guard let error = error as? OpenAPIClient.ErrorResponse else {
            throw APIError.unexpectedResponse
        }

        guard let data = error.data,
              let errorDTO = try? JSONDecoder().decode(ErrorDTO.self, from: data)
        else {
            throw APIError.unexpectedResponse
        }

        switch error.statusCode {
        case 400:
            do {
                let badRequestCode = try APIError.BadRequestCode(code: errorDTO.code)
                switch badRequestCode {
                case .contentFilter:
                    return .failure(.contentFilter)
                }
            } catch {
                throw APIError.unexpectedResponse // BadRequestCode ãŒå‡¦ç†ã§ããªã‹ã£ãŸå ´åˆ
            }
            
        case 429:
            do {
                let tooManyRequestCode = try APIError.TooManyRequestCode(code: errorDTO.code)
                switch tooManyRequestCode {
                case .rateLimit:
                    return .failure(.rateLimit)
                }
            } catch {
                throw APIError.unexpectedResponse // TooManyRequestCode ãŒå‡¦ç†ã§ããªã‹ã£ãŸå ´åˆ
            }

        default:
            throw APIError.unexpectedResponse
        }
    }
}
```

### å¤‰æ›´ç‚¹

1. **400ã‚¨ãƒ©ãƒ¼å‡¦ç† (`BadRequestCode`)**  
   `APIError.BadRequestCode` ã‚’åˆæœŸåŒ–ã—ã€`switch` æ–‡ã§ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: `.contentFilter`ï¼‰ã«å¯¾å¿œã™ã‚‹å‡¦ç†ã‚’è¡Œã„ã€`PostMessageError.contentFilter` ã‚’è¿”ã™ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

2. **429ã‚¨ãƒ©ãƒ¼å‡¦ç† (`TooManyRequestCode`)**  
   åŒæ§˜ã« `APIError.TooManyRequestCode` ã‚’åˆæœŸåŒ–ã—ã€`rateLimit` ã®å ´åˆã¯ `PostMessageError.rateLimit` ã‚’è¿”ã™ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

3. **`APIError.unexpectedResponse` ã®ã‚¹ãƒ­ãƒ¼**  
   `BadRequestCode` ã‚„ `TooManyRequestCode` ã®åˆæœŸåŒ–ãŒå¤±æ•—ã—ãŸå ´åˆã€`APIError.unexpectedResponse` ã‚’ã‚¹ãƒ­ãƒ¼ã—ã¾ã™ã€‚

ã“ã‚Œã§ã€`400` ã‚„ `429` ã‚¨ãƒ©ãƒ¼ã«å¿œã˜ã¦ `PostMessageError` ãŒè¿”ã•ã‚Œã€`BadRequestCode` ã¨ `TooManyRequestCode` ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒæ•´ã„ã¾ã—ãŸã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/9/18 18:34:40*

ã“ã‚Œã‚‚ã©ã†ã‚ˆã†ã®å‡¦ç†ã«ã—ãŸã„

    func finishConversation(threadId: Int) async throws -&gt; Result&lt;Void, PostMessageError&gt; {
        do {
            let _ = try await api.finishConversation(threadId: threadId)
            return .success(())
        } catch {
            guard let error = error as? OpenAPIClient.ErrorResponse else {
                throw APIError.unexpectedResponse
            }

            guard error.statusCode == 429,
                  let data = error.data,
                  let response429 = try? JSONDecoder().decode(ErrorDTO.self, from: data)
            else {
                throw APIError.unexpectedResponse
            }

            switch response429.code {
            case errorCodeRateLimit:
                return .failure(.rateLimit)
            default:
                throw APIError.unexpectedResponse
            }
        }
    }

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/9/18 18:35:05*

`finishConversation` é–¢æ•°ã‚’ã€å…ˆã»ã©ã® `postMessage` é–¢æ•°ã¨åŒæ§˜ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å‡¦ç†ã«ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€`400` ã‚„ `429` ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸéš›ã«ã€`APIError` ã¨ `PostMessageError` ã‚’é©åˆ‡ã«åˆ©ç”¨ã—ã¦ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’è¡Œã†ã‚ˆã†ã«ã§ãã¾ã™ã€‚

### ä¿®æ­£å¾Œã® `finishConversation` é–¢æ•°

```swift
func finishConversation(threadId: Int) async throws -> Result<Void, PostMessageError> {
    do {
        let _ = try await api.finishConversation(threadId: threadId)
        return .success(())
    } catch {
        guard let error = error as? OpenAPIClient.ErrorResponse else {
            throw APIError.unexpectedResponse
        }

        guard let data = error.data,
              let errorDTO = try? JSONDecoder().decode(ErrorDTO.self, from: data)
        else {
            throw APIError.unexpectedResponse
        }

        switch error.statusCode {
        case 400:
            do {
                let badRequestCode = try APIError.BadRequestCode(code: errorDTO.code)
                switch badRequestCode {
                case .contentFilter:
                    return .failure(.contentFilter)
                }
            } catch {
                throw APIError.unexpectedResponse // BadRequestCode ãŒå‡¦ç†ã§ããªã‹ã£ãŸå ´åˆ
            }
            
        case 429:
            do {
                let tooManyRequestCode = try APIError.TooManyRequestCode(code: errorDTO.code)
                switch tooManyRequestCode {
                case .rateLimit:
                    return .failure(.rateLimit)
                }
            } catch {
                throw APIError.unexpectedResponse // TooManyRequestCode ãŒå‡¦ç†ã§ããªã‹ã£ãŸå ´åˆ
            }

        default:
            throw APIError.unexpectedResponse
        }
    }
}
```

### å¤‰æ›´ç‚¹

1. **400ã‚¨ãƒ©ãƒ¼å‡¦ç† (`BadRequestCode`)**  
   `APIError.BadRequestCode` ã‚’åˆæœŸåŒ–ã—ã€`switch` æ–‡ã§ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’åˆ¤å®šã—ã¾ã™ã€‚`400` ã‚¨ãƒ©ãƒ¼ãŒ `contentFilter` ã®å ´åˆã€`PostMessageError.contentFilter` ã‚’è¿”ã—ã¾ã™ã€‚

2. **429ã‚¨ãƒ©ãƒ¼å‡¦ç† (`TooManyRequestCode`)**  
   `APIError.TooManyRequestCode` ã‚’åˆæœŸåŒ–ã—ã€`429` ã‚¨ãƒ©ãƒ¼ãŒ `rateLimit` ã®å ´åˆã€`PostMessageError.rateLimit` ã‚’è¿”ã—ã¾ã™ã€‚

3. **`APIError.unexpectedResponse` ã®ã‚¹ãƒ­ãƒ¼**  
   `BadRequestCode` ã‚„ `TooManyRequestCode` ã®åˆæœŸåŒ–ãŒå¤±æ•—ã—ãŸå ´åˆã€ã¾ãŸã¯æœªçŸ¥ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãŒè¿”ã•ã‚ŒãŸå ´åˆã« `APIError.unexpectedResponse` ã‚’ã‚¹ãƒ­ãƒ¼ã—ã¾ã™ã€‚

ã“ã‚Œã§ã€`finishConversation` é–¢æ•°ã‚‚ `postMessage` ã¨åŒæ§˜ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ§‹é€ ã‚’æŒã¡ã€ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†ãŒçµ±ä¸€ã•ã‚Œã¾ã™ã€‚

---
