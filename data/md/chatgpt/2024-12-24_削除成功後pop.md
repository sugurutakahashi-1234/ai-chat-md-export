# 削除成功後pop

日付: 2024-12-24

---

## 👤 ユーザー
*2024/12/24 15:16:25*

削除に成功したらpopしてほしい。
final deleteGuildNotifier = ref.watch(deleteGuildNotifierProvider.notifier);の位置はここであっているのか？

import 'package:flutter/material.dart';
import 'package:go\_router/go\_router.dart';
import 'package:hooks\_riverpod/hooks\_riverpod.dart';
import 'package:snpit\_guild\_app/presentation/providers/api\_client/guilds/delete\_guild.dart';

class GuildEditPage extends HookConsumerWidget {
  const GuildEditPage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    ref.listen&lt;AsyncValue&lt;String?&gt;&gt;(
      deleteGuildNotifierProvider,
      (previous, next) {
        next.when(
          data: (data) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(content: Text('Guild deleted successfully: $data')),
            );
          },
          error: (e, stackTrace) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(content: Text('Error deleting guild: $e')),
            );
          },
          loading: () {
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(content: Text('Deleting guild...')),
            );
          },
        );
      },
    );

    final deleteGuildNotifier = ref.watch(deleteGuildNotifierProvider.notifier);

    return Scaffold(
      appBar: AppBar(title: const Text('Guild Edit')),
      body: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 16),
        child: SingleChildScrollView(
          child: Column(
            children: \[
              ElevatedButton(
                onPressed: () async {
                  final guildId = 'your-guild-id'; // 削除対象のギルドIDを指定
                  final result = await showDialog&lt;bool&gt;(
                    context: context,
                    builder: (context) =&gt; AlertDialog(
                      title: const Text('Delete Guild'),
                      content: const Text(
                        'Are you sure you want to delete this guild?',
                      ),
                      actions: \[
                        TextButton(
                          onPressed: () =&gt; context.pop(false),
                          child: const Text('Cancel'),
                        ),
                        TextButton(
                          onPressed: () =&gt; context.pop(true),
                          child: const Text('Delete'),
                        ),
                      \],
                    ),
                  );

                  if (result == true) {
                    // 削除処理の実行
                    await deleteGuildNotifier.executeRequest(guildId);
                  }
                },
                child: const Text('Delete Guild'),
              ),
            \],
          ),
        ),
      ),
    );
  }
}

---

## 🤖 アシスタント
*2024/12/24 15:16:39*

`final deleteGuildNotifier = ref.watch(deleteGuildNotifierProvider.notifier);` の位置は正しいです。ただし、削除に成功したら `context.pop()` を呼び出すようにするには、`ref.listen` 内で削除成功時の処理に追加する必要があります。

以下のように修正すると、削除成功時に `pop` が呼び出され、前の画面に戻れるようになります。

### 修正版

```dart
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:hooks_riverpod/hooks_riverpod.dart';
import 'package:snpit_guild_app/presentation/providers/api_client/guilds/delete_guild.dart';

class GuildEditPage extends HookConsumerWidget {
  const GuildEditPage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    ref.listen<AsyncValue<String?>>(
      deleteGuildNotifierProvider,
      (previous, next) {
        next.when(
          data: (data) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(content: Text('Guild deleted successfully: $data')),
            );
            // 削除成功時にpopする
            context.pop();
          },
          error: (e, stackTrace) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(content: Text('Error deleting guild: $e')),
            );
          },
          loading: () {
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(content: Text('Deleting guild...')),
            );
          },
        );
      },
    );

    final deleteGuildNotifier = ref.watch(deleteGuildNotifierProvider.notifier);

    return Scaffold(
      appBar: AppBar(title: const Text('Guild Edit')),
      body: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 16),
        child: SingleChildScrollView(
          child: Column(
            children: [
              ElevatedButton(
                onPressed: () async {
                  final guildId = 'your-guild-id'; // 削除対象のギルドIDを指定
                  final result = await showDialog<bool>(
                    context: context,
                    builder: (context) => AlertDialog(
                      title: const Text('Delete Guild'),
                      content: const Text(
                        'Are you sure you want to delete this guild?',
                      ),
                      actions: [
                        TextButton(
                          onPressed: () => context.pop(false),
                          child: const Text('Cancel'),
                        ),
                        TextButton(
                          onPressed: () => context.pop(true),
                          child: const Text('Delete'),
                        ),
                      ],
                    ),
                  );

                  if (result == true) {
                    // 削除処理の実行
                    await deleteGuildNotifier.executeRequest(guildId);
                  }
                },
                child: const Text('Delete Guild'),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
```

### 修正ポイント
1. **`ref.listen` 内で `context.pop()` を呼び出し**  
   削除成功時に `context.pop()` を呼び出すことで、現在の画面を閉じます。

2. **`deleteGuildNotifier` の位置を維持**  
   `ref.watch` の位置は変更していません。ビジネスロジックの実行には適切な位置です。

これにより、削除成功時にスナックバーを表示した後に前の画面に戻れるようになります。

---

## 👤 ユーザー
*2024/12/24 15:17:25*

deleteGuildNotifier は onPressed 時に宣言するのとどちらがいいの？

---

## 🤖 アシスタント
*2024/12/24 15:17:44*

`deleteGuildNotifier` を **`onPressed` 時に宣言する**のと、**`Widget build` 内で宣言する**のはそれぞれ利点がありますが、一般的なガイドラインや用途に応じた選択肢を考えると次のようになります。

---

### **1. `Widget build` 内で宣言する場合 (現在のコード)**

```dart
final deleteGuildNotifier = ref.watch(deleteGuildNotifierProvider.notifier);
```

#### **メリット**
- **再利用性**: `deleteGuildNotifier` が `build` メソッド全体で使えるため、他のボタンや処理でも同じインスタンスを再利用できます。
- **コードの読みやすさ**: `deleteGuildNotifier` が上部で宣言されているため、他の開発者がコードを見たときに、このプロバイダがこのページ全体で利用される可能性があると理解しやすいです。
- **リソース管理**: `ref.watch` はリビルドごとにプロバイダの状態を適切に管理するため、冗長な宣言を避けられます。

#### **デメリット**
- **スコープが広い**: 実際に利用されるのは `onPressed` 時のみである場合、`build` 内での宣言は少し過剰かもしれません。

---

### **2. `onPressed` 内で宣言する場合**

```dart
onPressed: () async {
  final deleteGuildNotifier = ref.watch(deleteGuildNotifierProvider.notifier);
  await deleteGuildNotifier.executeRequest(guildId);
},
```

#### **メリット**
- **スコープの限定**: `deleteGuildNotifier` の利用範囲が狭まるため、コードの意図がより明確になります（このボタンでしか使わないとわかる）。
- **効率的な管理**: `onPressed` の中でのみ使われるため、意図的にプロバイダを参照していることが明確になります。

#### **デメリット**
- **重複の可能性**: 他の場所で同じ `deleteGuildNotifier` を利用する場合、毎回宣言する必要があります。
- **テスト性の低下**: ローカルスコープで宣言すると、テスト時にモックを注入しづらくなる場合があります。

---

### **どちらを選ぶべきか？**
- **シンプルなケース**:  
  ボタンが1つしかなく、`deleteGuildNotifier` が他の場所で再利用されない場合は、`onPressed` 内で宣言するのがシンプルです。

- **複数箇所で利用する可能性がある場合**:  
  他のボタンや処理で同じ `deleteGuildNotifier` を利用する場合は、`build` 内で宣言する方が良いです。

---

### **推奨**
今回は `deleteGuildNotifier` を **このボタンだけで使用する** 可能性が高いため、`onPressed` 内で宣言する方がコードの意図が明確で良い選択です。

修正例:

```dart
onPressed: () async {
  final guildId = 'your-guild-id'; // 削除対象のギルドIDを指定
  final deleteGuildNotifier = ref.watch(deleteGuildNotifierProvider.notifier);
  final result = await showDialog<bool>(
    context: context,
    builder: (context) => AlertDialog(
      title: const Text('Delete Guild'),
      content: const Text(
        'Are you sure you want to delete this guild?',
      ),
      actions: [
        TextButton(
          onPressed: () => context.pop(false),
          child: const Text('Cancel'),
        ),
        TextButton(
          onPressed: () => context.pop(true),
          child: const Text('Delete'),
        ),
      ],
    ),
  );

  if (result == true) {
    await deleteGuildNotifier.executeRequest(guildId);
  }
},
```

---

### **まとめ**
- 再利用性やテスト性を考慮するなら **`build` 内で宣言**。
- 単純なスコープで済むなら **`onPressed` 内で宣言**。

---
