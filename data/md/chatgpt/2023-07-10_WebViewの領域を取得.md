# WebViewの領域を取得

日付: 2023-07-10

---

## 👤 ユーザー
*2023/07/11 08:50:52*

SwiftUI で WebViewを表示している。自分が表示している領域がWebViewの高さと幅をそれぞれ1としたときにどの範囲であるかを取得したい

---

## 🤖 アシスタント
*2023/07/11 08:51:37*

SwiftUIの本体にはWebViewが含まれていません。したがって、WKWebViewを使用して自己管理を行う必要があります。このためにUIViewRepresentableを使用してWKWebViewをWrapすることができます。WKWebViewのコンテンツの領域を取得するためには、JavaScriptを使用してページの高さと幅を取得することができます。

以下にそのコードを示します。

```swift
import SwiftUI
import WebKit

struct WebView: UIViewRepresentable {
    let request: URLRequest
    
    func makeUIView(context: Context) -> WKWebView  {
        return WKWebView()
    }
    
    func updateUIView(_ uiView: WKWebView, context: Context) {
        uiView.load(request)
    }
    
    func makeCoordinator() -> Coordinator {
        Coordinator(self)
    }
    
    class Coordinator: NSObject, WKNavigationDelegate {
        var parent: WebView

        init(_ parent: WebView) {
            self.parent = parent
        }
        
        func webView(_ webView: WKWebView, didFinish navigation: WKNavigation!) {
            webView.evaluateJavaScript("document.documentElement.scrollWidth;", completionHandler: { (height, error) in
                if error != nil {
                    print("Error: \(String(describing: error))")
                }
                if height != nil {
                    print("Width: \(height!)")
                }
            })
            webView.evaluateJavaScript("document.documentElement.scrollHeight;", completionHandler: { (height, error) in
                if error != nil {
                    print("Error: \(String(describing: error))")
                }
                if height != nil {
                    print("Height: \(height!)")
                }
            })
        }
    }
}
```

このコードはWKWebViewを表示するためのSwiftUIビューを定義し、ページの読み込みが完了したときにJavaScriptを使用してページの幅と高さを取得します。`webView(_:didFinish:)`メソッドはWKNavigationDelegateプロトコルの一部であり、ページのナビゲーションが完了したときに呼び出されます。

WebViewのインスタンス化時に適切なURLRequestを渡すことで、任意のWebページをロードできます。

```swift
WebView(request: URLRequest(url: URL(string: "https://www.example.com")!))
```

なお、ページの幅と高さはピクセル単位で取得され、`print`ステートメントを使用してコンソールに出力されます。これらの値を他の部分で使用したい場合は、必要に応じて適切なデータ構造を使用して状態を保存する必要があります。

---

## 👤 ユーザー
*2023/07/11 08:52:38*

タップした箇所がWebViewの高さと幅を1としたときの相対座標としてどのくらいか取得することはできそう？

---

## 🤖 アシスタント
*2023/07/11 08:53:21*

WebKitはJavaScriptにタップのX, Y座標を取得するメソッドを提供していますが、これらはページ全体に対する絶対座標となります。そのため、JavaScriptを使ってWebViewの全体の高さと幅を取得し、さらにタップのX, Y座標を取得してからこれらを使って相対座標を計算することができます。

以下にその方法を示します：

1. SwiftのUIViewRepresentableとWKNavigationDelegateを使ってJavaScriptを実行できるようにします：

```swift
import SwiftUI
import WebKit

struct WebView: UIViewRepresentable {
    let request: URLRequest
    
    func makeUIView(context: Context) -> WKWebView  {
        let webView = WKWebView()
        webView.navigationDelegate = context.coordinator
        return webView
    }
    
    func updateUIView(_ uiView: WKWebView, context: Context) {
        uiView.load(request)
    }
    
    func makeCoordinator() -> Coordinator {
        Coordinator(self)
    }
    
    class Coordinator: NSObject, WKNavigationDelegate, WKScriptMessageHandler {
        var parent: WebView

        init(_ parent: WebView) {
            self.parent = parent
        }
        
        func webView(_ webView: WKWebView, didFinish navigation: WKNavigation!) {
            webView.configuration.userContentController.add(self, name: "observe")
            webView.evaluateJavaScript("""
                document.body.addEventListener('click', function(event) {
                    var rect = event.target.getBoundingClientRect();
                    var x = event.clientX / window.innerWidth;
                    var y = event.clientY / window.innerHeight;
                    window.webkit.messageHandlers.observe.postMessage({x: x, y: y});
                });
                """, completionHandler: nil)
        }
        
        func userContentController(_ userContentController: WKUserContentController, didReceive message: WKScriptMessage) {
            if message.name == "observe", let dict = message.body as? [String: Any], let x = dict["x"] as? Float, let y = dict["y"] as? Float {
                print("Relative x: \(x), y: \(y)")
            }
        }
    }
}
```

上記のコードでは、ページがロードされたら、すべてのクリックイベントを監視し、クリックされた座標のxとyの値をWebViewの幅と高さで割り、0から1までの相対値を得ます。その値はWebKitのメッセージハンドラを経由してSwiftに送信され、コンソールに出力されます。

2. WebViewのインスタンス化時に適切なURLRequestを渡すことで、任意のWebページをロードできます。

```swift
WebView(request: URLRequest(url: URL(string: "https://www.example.com")!))
```

なお、これらの相対値は0から1の間で、WebViewの左上を(0,0)、右下を(1,1)としたときの相対的な位置を示します。

---

## 👤 ユーザー
*2023/07/11 08:53:57*

ちなみにスクロールしているときに、どの範囲を表示しているかの情報はとれたりするの？

---

## 🤖 アシスタント
*2023/07/11 08:54:37*

はい、スクロール位置を取得することも可能です。JavaScriptを用いて、`window.scrollX`と`window.scrollY`を使用します。これらはウェブページ上部からのスクロール距離をピクセル単位で返します。また、`window.innerWidth`と`window.innerHeight`を使用して表示範囲のサイズも取得できます。

以下に、スクロール位置と表示範囲を取得するサンプルコードを示します。

```swift
import SwiftUI
import WebKit

struct WebView: UIViewRepresentable {
    let request: URLRequest
    
    func makeUIView(context: Context) -> WKWebView  {
        let webView = WKWebView()
        webView.navigationDelegate = context.coordinator
        return webView
    }
    
    func updateUIView(_ uiView: WKWebView, context: Context) {
        uiView.load(request)
    }
    
    func makeCoordinator() -> Coordinator {
        Coordinator(self)
    }
    
    class Coordinator: NSObject, WKNavigationDelegate, WKScriptMessageHandler {
        var parent: WebView

        init(_ parent: WebView) {
            self.parent = parent
        }
        
        func webView(_ webView: WKWebView, didFinish navigation: WKNavigation!) {
            webView.configuration.userContentController.add(self, name: "observe")
            webView.evaluateJavaScript("""
                window.addEventListener('scroll', function(event) {
                    var x = window.scrollX;
                    var y = window.scrollY;
                    var width = window.innerWidth;
                    var height = window.innerHeight;
                    window.webkit.messageHandlers.observe.postMessage({scrollX: x, scrollY: y, width: width, height: height});
                });
                """, completionHandler: nil)
        }
        
        func userContentController(_ userContentController: WKUserContentController, didReceive message: WKScriptMessage) {
            if message.name == "observe", let dict = message.body as? [String: Any] {
                let x = dict["scrollX"] as? Float
                let y = dict["scrollY"] as? Float
                let width = dict["width"] as? Float
                let height = dict["height"] as? Float
                print("Scroll x: \(x), y: \(y), width: \(width), height: \(height)")
            }
        }
    }
}
```

このサンプルコードでは、スクロールするたびに、スクロール位置（`scrollX`, `scrollY`）と表示範囲のサイズ（`width`, `height`）がコンソールに出力されます。これらはすべてピクセル単位で表示されます。

---

## 👤 ユーザー
*2023/07/11 08:55:10*

これが相対座標としてどの位置かは取得できたりしますか？

---

## 🤖 アシスタント
*2023/07/11 08:55:58*

はい、それは可能です。ただし、相対座標を計算するためには、ページ全体の高さと幅も必要になります。以下にその方法を示します：

1. スクロール位置と表示範囲を相対座標として取得するためのSwiftのコード：

```swift
import SwiftUI
import WebKit

struct WebView: UIViewRepresentable {
    let request: URLRequest
    
    func makeUIView(context: Context) -> WKWebView  {
        let webView = WKWebView()
        webView.navigationDelegate = context.coordinator
        return webView
    }
    
    func updateUIView(_ uiView: WKWebView, context: Context) {
        uiView.load(request)
    }
    
    func makeCoordinator() -> Coordinator {
        Coordinator(self)
    }
    
    class Coordinator: NSObject, WKNavigationDelegate, WKScriptMessageHandler {
        var parent: WebView

        init(_ parent: WebView) {
            self.parent = parent
        }
        
        func webView(_ webView: WKWebView, didFinish navigation: WKNavigation!) {
            webView.configuration.userContentController.add(self, name: "observe")
            webView.evaluateJavaScript("""
                window.addEventListener('scroll', function(event) {
                    var x = window.scrollX / document.documentElement.scrollWidth;
                    var y = window.scrollY / document.documentElement.scrollHeight;
                    var width = window.innerWidth / document.documentElement.scrollWidth;
                    var height = window.innerHeight / document.documentElement.scrollHeight;
                    window.webkit.messageHandlers.observe.postMessage({scrollX: x, scrollY: y, width: width, height: height});
                });
                """, completionHandler: nil)
        }
        
        func userContentController(_ userContentController: WKUserContentController, didReceive message: WKScriptMessage) {
            if message.name == "observe", let dict = message.body as? [String: Any] {
                let x = dict["scrollX"] as? Float
                let y = dict["scrollY"] as? Float
                let width = dict["width"] as? Float
                let height = dict["height"] as? Float
                print("Relative scroll x: \(x), y: \(y), width: \(width), height: \(height)")
            }
        }
    }
}
```

このコードでは、スクロールイベントが発生するたびにJavaScriptが実行され、スクロール位置と表示範囲の相対座標がSwiftに送られます。スクロール位置は左上からの相対的な位置を示し、表示範囲はページ全体に対する相対的な大きさを示します。

2. WebViewのインスタンス化時に適切なURLRequestを渡すことで、任意のWebページをロードできます。

```swift
WebView(request: URLRequest(url: URL(string: "https://www.example.com")!))
```

なお、これらの相対値は0から1の間で、スクロール位置のxとyがそれぞれ左端と上端からの相対的な距離を示し、表示範囲の幅と高さはページ全体に対する相対的な大きさを示します。

---

## 👤 ユーザー
*2023/07/11 10:14:02*

スクロールイベントは少しでも動かしたら発生するものなの？

---

## 🤖 アシスタント
*2023/07/11 10:14:22*

はい、その通りです。スクロールイベントはブラウザの画面がスクロールされたときに発生します。つまり、ユーザーがウェブページを少しでもスクロールすれば、スクロールイベントは発生します。このイベントは、ユーザーがページをスクロールしている間、連続的に発生します。

ただし、一部のブラウザでは、スクロールイベントの頻度を制限するためにイベントの発生を遅延させる可能性があります。この遅延は、ページのパフォーマンスを改善するために行われます。特に、スクロールイベントハンドラが高負荷の処理を行う場合、ページのスクロールが滑らかでなくなる可能性があります。

なお、上記のコード例では、JavaScriptの`addEventListener`メソッドを用いてスクロールイベントを監視しています。そして、スクロールイベントが発生すると、そのスクロール位置と表示範囲の相対座標を計算し、Swiftに送信します。

---

## 👤 ユーザー
*2023/07/11 10:19:39*

SwiftUIでWebViewを表示している画面ではナビゲーションバーや、ToolbarItemGroup でボトムにボタンなどを配置している。

そして、外部のSDKによって、端末の画面全体のwidth, height でどこのGCPointを見ているかの座標が連続的にAnyPublisherで取得できている際に、それをWebViewの中のWebPageの相対座標として、どこかを取得するにはどうしたらよいか？

MVVMモデルで実装してほしい

---

## 🤖 アシスタント
*2023/07/11 10:20:26*

まず、外部SDKからのデータをViewModelを介して取得する方法を見てみましょう。以下に簡単な例を示します。

まず、取得したい座標情報を表現するための構造体を定義します。

```swift
struct Coordinate {
    let x: Float
    let y: Float
}
```

次に、この座標情報を提供するViewModelを定義します。このViewModelはCombineの`AnyPublisher`を使って座標情報を提供します。

```swift
class ViewModel: ObservableObject {
    // 外部SDKからの座標情報を表現するためのPublisher
    @Published var coordinatePublisher: AnyPublisher<Coordinate, Never> = ...
}
```

このViewModelを使って、外部SDKからの座標情報をWebViewに渡すことができます。

そして、先に提供したWebViewの実装にViewModelを接続します。これにより、ViewModelから取得した座標情報をWebViewの表示に反映させることができます。

以下にそのコードを示します：

```swift
import SwiftUI
import WebKit
import Combine

struct WebView: UIViewRepresentable {
    let request: URLRequest
    @ObservedObject var viewModel: ViewModel
    var coordinateCancellable: AnyCancellable?
    
    func makeUIView(context: Context) -> WKWebView  {
        let webView = WKWebView()
        webView.navigationDelegate = context.coordinator
        
        coordinateCancellable = viewModel.coordinatePublisher.sink { [weak webView] coordinate in
            let script = """
            var x = \(coordinate.x) * document.documentElement.scrollWidth;
            var y = \(coordinate.y) * document.documentElement.scrollHeight;
            window.scrollTo(x, y);
            """
            webView?.evaluateJavaScript(script, completionHandler: nil)
        }
        
        return webView
    }
    
    func updateUIView(_ uiView: WKWebView, context: Context) {
        uiView.load(request)
    }
    
    func makeCoordinator() -> Coordinator {
        Coordinator(self)
    }
    
    class Coordinator: NSObject, WKNavigationDelegate, WKScriptMessageHandler {
        var parent: WebView

        init(_ parent: WebView) {
            self.parent = parent
        }
    }
    
    mutating func disconnect() {
        coordinateCancellable?.cancel()
        coordinateCancellable = nil
    }
}
```

このコードでは、ViewModelから取得した座標情報をWebViewのスクロール位置に反映しています。ViewModelから取得した座標情報はWebViewの全体の高さと幅を1とした相対座標であることを前提としています。

また、`disconnect`メソッドを呼び出すことで、ViewModelからの座標情報の購読を停止できます。このメソッドは例えばWebViewが破棄される時に呼び出すことができます。

これで、外部SDKからの座標情報をWebViewの表示に反映させることができるようになりました。ただし、このコードはあくまで一例であり、実際のアプリケーションの要件に応じて適切に調整する必要があります。

---
