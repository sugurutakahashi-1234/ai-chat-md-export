# ディレクトリとリダイレクト修正

日付: 2024-05-20

---

## 👤 ユーザー
*2024/5/20 15:39:34*

以下のエラーになった。なぜだろう。

#!/bin/sh

# 以下の処理によって、TestFlight での Staging 環境のリリースページに、直近のタグからの PR のマージログを表示するようにしている
# Ref: https://developer.apple.com/documentation/xcode/including-notes-for-testers-with-a-beta-release-of-your-app
if \[\[ -d "$CI\_APP\_STORE\_SIGNED\_APP\_PATH" \]\] && \[\[ "$CI\_WORKFLOW" == "Distribute Staging App to TestFlight by PR Merged" \]\]; then
    TESTFLIGHT\_DIR\_PATH=../TestFlight
    mkdir $TESTFLIGHT\_DIR\_PATH

    # 必要なコミット数だけ履歴を取得する（git rev-list だとうまくいかなかったので、一旦、500 にしておく）
    git fetch --deepen 500

    # 直近のタグを取得
    LATEST\_TAG=$(git describe --tags --abbrev=0 2&gt;/dev/null)

    # Merge pull request の commit だけを取得して見やすいように 1 行空ける
    if \[ -z "$LATEST\_TAG" \]; then
        # タグがない場合
        git log HEAD --oneline --merges --pretty=format:"\[%cs\] %s %b" | sed -E 's|Merge pull request #\[0-9\]+ from \[^/\]+/||' | awk '{print $0 "\\n"}' &gt;! $TESTFLIGHT\_DIR\_PATH/WhatToTest.en-US.txt
    else
        # タグがある場合
        git log $LATEST\_TAG..HEAD --oneline --merges --pretty=format:"\[%cs\] %s %b" | sed -E 's|Merge pull request #\[0-9\]+ from \[^/\]+/||' | awk '{print $0 "\\n"}' &gt;! $TESTFLIGHT\_DIR\_PATH/WhatToTest.en-US.txt
    fi
fi



Showing All Messages
cd /Volumes/workspace/repository/ci\_scripts && CI\_XCODEBUILD\_EXIT\_CODE=0 /Volumes/workspace/repository/ci\_scripts/ci\_post\_xcodebuild.sh
From http://github.com/suguruTakahashi-1234/fia-practical-sample
 \* \[new branch\]        feature/renovate-apple-swift-syntax-510-x -&gt; origin/feature/renovate-apple-swift-syntax-510-x
 \* \[new branch\]        feature/renovate-apple-swift-testing-0-x -&gt; origin/feature/renovate-apple-swift-testing-0-x
 \* \[new branch\]        feature/renovate-emergetools-snapshotpreviews-ios-0-x -&gt; origin/feature/renovate-emergetools-snapshotpreviews-ios-0-x
 \* \[new branch\]        feature/renovate-firebase-firebase-ios-sdk-10-x -&gt; origin/feature/renovate-firebase-firebase-ios-sdk-10-x
 \* \[new branch\]        feature/renovate-krzysztofzablocki-sourcery-2-x -&gt; origin/feature/renovate-krzysztofzablocki-sourcery-2-x
 \* \[new branch\]        feature/xcode-cloud-report -&gt; origin/feature/xcode-cloud-report
 \* \[new branch\]        main       -&gt; origin/main
 \* \[new tag\]           0.1.0      -&gt; 0.1.0
 \* \[new tag\]           0.2.0      -&gt; 0.2.0
 \* \[new tag\]           0.3.0      -&gt; 0.3.0
awk: can't open file ../TestFlight/WhatToTest.en-US.txt
 source line number 1

Run command: 'cd /Volumes/workspace/repository/ci\_scripts && CI\_XCODEBUILD\_EXIT\_CODE=0 /Volumes/workspace/repository/ci\_scripts/ci\_post\_xcodebuild.sh'

From http://github.com/suguruTakahashi-1234/fia-practical-sample

 \* \[new branch\]        feature/renovate-apple-swift-syntax-510-x -&gt; origin/feature/renovate-apple-swift-syntax-510-x

 \* \[new branch\]        feature/renovate-apple-swift-testing-0-x -&gt; origin/feature/renovate-apple-swift-testing-0-x

 \* \[new branch\]        feature/renovate-emergetools-snapshotpreviews-ios-0-x -&gt; origin/feature/renovate-emergetools-snapshotpreviews-ios-0-x

 \* \[new branch\]        feature/renovate-firebase-firebase-ios-sdk-10-x -&gt; origin/feature/renovate-firebase-firebase-ios-sdk-10-x

 \* \[new branch\]        feature/renovate-krzysztofzablocki-sourcery-2-x -&gt; origin/feature/renovate-krzysztofzablocki-sourcery-2-x

 \* \[new branch\]        feature/xcode-cloud-report -&gt; origin/feature/xcode-cloud-report

 \* \[new branch\]        main       -&gt; origin/main

 \* \[new tag\]           0.1.0      -&gt; 0.1.0

 \* \[new tag\]           0.2.0      -&gt; 0.2.0

 \* \[new tag\]           0.3.0      -&gt; 0.3.0

awk: can't open file ../TestFlight/WhatToTest.en-US.txt

 source line number 1

Command exited with non-zero exit-code: 2

Running ci\_post\_xcodebuild.sh script failed (exited with code 2). Executable scripts are run using the interpreter specified in the shebang line. 

No “What to test” notes files found at /Volumes/workspace/repository
Store crash logs

---

## 🤖 アシスタント
*2024/5/20 15:39:55*

エラーメッセージを見ると、`awk`が`../TestFlight/WhatToTest.en-US.txt`ファイルを開けないというエラーが発生しています。これは、スクリプト内のファイルパスが正しくないか、またはファイルが存在しないためです。

具体的には、次の点を確認する必要があります：

1. **ディレクトリ作成の確認**：
   `mkdir $TESTFLIGHT_DIR_PATH`でディレクトリを作成していますが、実際にディレクトリが作成されているか確認してください。絶対パスで作成することを検討することも有効です。

2. **出力リダイレクトのシンボルの誤り**：
   スクリプト内でファイルに書き込む際のリダイレクトシンボルが誤っています。`>`を使うべきです。

修正後のスクリプトは次のようになります：

```sh
#!/bin/sh

# 以下の処理によって、TestFlight での Staging 環境のリリースページに、直近のタグからの PR のマージログを表示するようにしている
# Ref: https://developer.apple.com/documentation/xcode/including-notes-for-testers-with-a-beta-release-of-your-app
if [[ -d "$CI_APP_STORE_SIGNED_APP_PATH" ]] && [[ "$CI_WORKFLOW" == "Distribute Staging App to TestFlight by PR Merged" ]]; then
    TESTFLIGHT_DIR_PATH=../TestFlight
    mkdir -p $TESTFLIGHT_DIR_PATH

    # 必要なコミット数だけ履歴を取得する（git rev-list だとうまくいかなかったので、一旦、500 にしておく）
    git fetch --deepen 500

    # 直近のタグを取得
    LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null)

    # Merge pull request の commit だけを取得して見やすいように 1 行空ける
    if [ -z "$LATEST_TAG" ]; then
        # タグがない場合
        git log HEAD --oneline --merges --pretty=format:"[%cs] %s %b" | sed -E 's|Merge pull request #[0-9]+ from [^/]+/||' | awk '{print $0 "\n"}' > $TESTFLIGHT_DIR_PATH/WhatToTest.en-US.txt
    else
        # タグがある場合
        git log $LATEST_TAG..HEAD --oneline --merges --pretty=format:"[%cs] %s %b" | sed -E 's|Merge pull request #[0-9]+ from [^/]+/||' | awk '{print $0 "\n"}' > $TESTFLIGHT_DIR_PATH/WhatToTest.en-US.txt
    fi
fi
```

主な変更点は次のとおりです：

1. `mkdir $TESTFLIGHT_DIR_PATH`を`mkdir -p $TESTFLIGHT_DIR_PATH`に変更しました。`-p`オプションは、親ディレクトリが存在しない場合にもディレクトリを作成します。
2. `>`シンボルを修正しました。`>!`はシェルによっては無効です。

この修正を試してみてください。もし他に問題がある場合、再度教えてください。

---

## 👤 ユーザー
*2024/5/20 15:44:28*

そもそもなんでawkのエラーとなっているのだろう？

Showing All Messages
awk: can't open file ../TestFlight/WhatToTest.en-US.txt

---

## 🤖 アシスタント
*2024/5/20 15:44:57*

`awk`のエラーは、`../TestFlight/WhatToTest.en-US.txt`ファイルが存在しないか、正しく作成されていないことが原因で発生しています。このエラーを解決するためには、スクリプトの実行中にこのファイルが正しく作成されているかを確認する必要があります。

スクリプトの流れに問題がないかを確認するために、次の手順を実行してみてください。

1. **ディレクトリの作成確認**：
   `mkdir`コマンドでディレクトリが正しく作成されているか確認します。`-p`オプションを使うと、親ディレクトリも含めて必要なディレクトリをすべて作成します。

2. **ファイルの書き込み確認**：
   ファイルへの書き込み処理が正しく行われているかを確認します。

3. **デバッグ用のエラーメッセージの追加**：
   スクリプトの中で、途中のステップが正しく実行されているかを確認するために、エラーメッセージや確認用の出力を追加します。

次のスクリプトは、ディレクトリとファイルの作成を確認するためのデバッグメッセージを含めたものです：

```sh
#!/bin/sh

# 以下の処理によって、TestFlight での Staging 環境のリリースページに、直近のタグからの PR のマージログを表示するようにしている
# Ref: https://developer.apple.com/documentation/xcode/including-notes-for-testers-with-a-beta-release-of-your-app
if [[ -d "$CI_APP_STORE_SIGNED_APP_PATH" ]] && [[ "$CI_WORKFLOW" == "Distribute Staging App to TestFlight by PR Merged" ]]; then
    TESTFLIGHT_DIR_PATH=../TestFlight
    echo "Creating directory: $TESTFLIGHT_DIR_PATH"
    mkdir -p $TESTFLIGHT_DIR_PATH

    # 必要なコミット数だけ履歴を取得する（git rev-list だとうまくいかなかったので、一旦、500 にしておく）
    git fetch --deepen 500

    # 直近のタグを取得
    LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null)

    # Merge pull request の commit だけを取得して見やすいように 1 行空ける
    if [ -z "$LATEST_TAG" ]; then
        # タグがない場合
        echo "No tags found. Writing log to $TESTFLIGHT_DIR_PATH/WhatToTest.en-US.txt"
        git log HEAD --oneline --merges --pretty=format:"[%cs] %s %b" | sed -E 's|Merge pull request #[0-9]+ from [^/]+/||' | awk '{print $0 "\n"}' > $TESTFLIGHT_DIR_PATH/WhatToTest.en-US.txt
    else
        # タグがある場合
        echo "Latest tag found: $LATEST_TAG. Writing log to $TESTFLIGHT_DIR_PATH/WhatToTest.en-US.txt"
        git log $LATEST_TAG..HEAD --oneline --merges --pretty=format:"[%cs] %s %b" | sed -E 's|Merge pull request #[0-9]+ from [^/]+/||' | awk '{print $0 "\n"}' > $TESTFLIGHT_DIR_PATH/WhatToTest.en-US.txt
    fi

    # ファイルが正しく作成されたか確認
    if [ -f "$TESTFLIGHT_DIR_PATH/WhatToTest.en-US.txt" ]; then
        echo "File created successfully: $TESTFLIGHT_DIR_PATH/WhatToTest.en-US.txt"
    else
        echo "Error: File not created: $TESTFLIGHT_DIR_PATH/WhatToTest.en-US.txt"
    fi
fi
```

このスクリプトでは、ディレクトリの作成やファイルへの書き込みが行われるたびにメッセージを出力します。また、最終的にファイルが正しく作成されたかを確認するためのチェックも追加しています。

このスクリプトを実行して、エラーメッセージや確認メッセージがどのように表示されるかを確認してください。それによって、どのステップで問題が発生しているかがより明確になります。

---

## 👤 ユーザー
*2024/5/20 15:48:24*

これでも同じエラーになった

---

## 🤖 アシスタント
*2024/5/20 15:48:52*

同じエラーが続く場合、以下の点を再度確認し、デバッグしてみてください。

1. **スクリプトの実行パス**：スクリプトが実行されるディレクトリが想定通りであるか確認します。特に相対パスの扱いが重要です。

2. **ディレクトリとファイルの権限**：ディレクトリやファイルの権限が適切に設定されているか確認します。

3. **ファイルの存在確認**：`awk`がファイルを開く前に、そのファイルが実際に存在しているか確認します。

以下のスクリプトには追加のデバッグ出力を含めています：

```sh
#!/bin/sh

# 以下の処理によって、TestFlight での Staging 環境のリリースページに、直近のタグからの PR のマージログを表示するようにしている
# Ref: https://developer.apple.com/documentation/xcode/including-notes-for-testers-with-a-beta-release-of-your-app
if [[ -d "$CI_APP_STORE_SIGNED_APP_PATH" ]] && [[ "$CI_WORKFLOW" == "Distribute Staging App to TestFlight by PR Merged" ]]; then
    TESTFLIGHT_DIR_PATH=../TestFlight
    echo "Creating directory: $TESTFLIGHT_DIR_PATH"
    mkdir -p $TESTFLIGHT_DIR_PATH
    echo "Directory created: $(ls -ld $TESTFLIGHT_DIR_PATH)"

    # 必要なコミット数だけ履歴を取得する（git rev-list だとうまくいかなかったので、一旦、500 にしておく）
    git fetch --deepen 500

    # 直近のタグを取得
    LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null)

    # Merge pull request の commit だけを取得して見やすいように 1 行空ける
    if [ -z "$LATEST_TAG" ]; then
        # タグがない場合
        echo "No tags found. Writing log to $TESTFLIGHT_DIR_PATH/WhatToTest.en-US.txt"
        git log HEAD --oneline --merges --pretty=format:"[%cs] %s %b" | sed -E 's|Merge pull request #[0-9]+ from [^/]+/||' | awk '{print $0 "\n"}' > $TESTFLIGHT_DIR_PATH/WhatToTest.en-US.txt
    else
        # タグがある場合
        echo "Latest tag found: $LATEST_TAG. Writing log to $TESTFLIGHT_DIR_PATH/WhatToTest.en-US.txt"
        git log $LATEST_TAG..HEAD --oneline --merges --pretty=format:"[%cs] %s %b" | sed -E 's|Merge pull request #[0-9]+ from [^/]+/||' | awk '{print $0 "\n"}' > $TESTFLIGHT_DIR_PATH/WhatToTest.en-US.txt
    fi

    # ファイルが正しく作成されたか確認
    if [ -f "$TESTFLIGHT_DIR_PATH/WhatToTest.en-US.txt" ]; then
        echo "File created successfully: $TESTFLIGHT_DIR_PATH/WhatToTest.en-US.txt"
        echo "File contents:"
        cat $TESTFLIGHT_DIR_PATH/WhatToTest.en-US.txt
    else
        echo "Error: File not created: $TESTFLIGHT_DIR_PATH/WhatToTest.en-US.txt"
    fi
fi
```

このスクリプトでは、以下のデバッグ出力を追加しています：

1. ディレクトリが作成されたことを確認するための出力。
2. ファイルが作成されたことを確認するための出力。
3. 作成されたファイルの内容を表示するための出力。

これらの追加の出力により、スクリプトが正しく実行されているか、どのステップで問題が発生しているかをより明確に確認できます。

また、スクリプトの実行ディレクトリが想定通りかどうかも確認してください。特にCI環境では、スクリプトが意図しないディレクトリから実行されている可能性があります。

---
