# Swift マクロ サンプル

日付: 2024-02-26

---

## 👤 ユーザー
*2024/02/26 19:43:53*

Xcode15からできる swift macro のサンプルコードを書いてほしい。playgroundで試せると嬉しい

---

## 🤖 アシスタント
*2024/02/26 19:44:38*

Xcode 15に導入されたSwiftマクロは、コンパイル時にコードを動的に生成または変更する強力な機能です。これはコードの抽象化レベルを高め、ボイラープレートコードの削減、コンパイル時の検証、そしてコード生成の自動化に役立ちます。

Swiftマクロの使用には、特定の構文とパターンが必要です。以下は、XcodeのPlaygroundで試すことができる基本的なマクロのサンプルコードです。この例では、マクロを使って簡単なログメッセージを生成する方法を示します。

```swift
// Macroの定義
// マクロ機能は現在のSwiftの公式リリースでは利用できないため、
// このコードはXcode 15で導入された仮想的な例です。

macro LogMessage(level: String, message: ExpressibleByStringLiteral) {
    // マクロの中でコンパイル時に実行されるコード
    // メッセージレベルとメッセージを出力する疑似コード
    print("[\(level)] \(message)")
}

// マクロの使用例
func myFunction() {
    LogMessage(level: "INFO", message: "This is a test log message.")
}

myFunction()
```

注意: 上記のコードはSwiftの現在のバージョンでは実際には動作しません。Swiftのマクロ機能は進行中の作業であり、将来のリリースで利用可能になる可能性があります。この例は、マクロがどのように見えるか、そしてどのように機能するかについての仮想的なイメージを提供するためのものです。

Swiftのマクロに関する正確な構文や機能は、Swiftの公式ドキュメントやXcodeのリリースノートをチェックして最新情報を入手してください。また、Swiftの進化に関する議論はSwift Forumsで追うことができます。マクロのような高度な機能は、Swift言語の将来のバージョンでどのように展開されるかによって大きく変わる可能性があります。

---

## 👤 ユーザー
*2024/02/26 20:19:03*

SettingView という structから以下を生成するmacroを作成したほしい。

Settingは置き換え可能なイメージです。

```
struct SettingView {}
```
//以下を生成する

```
// MARK: Wireframe
import Foundation
import DomainLayer

// TODO: add SettingWireframe to AppRootRouter
public protocol SettingWireframe {}

// MARK: PresenterDependency
import Foundation
import DomainLayer

public protocol SettingPresenterDependency {}

// MARK: View
import SwiftUI
import DomainLayer

public struct SettingView: View {
    private let router: SettingWireframe
    @StateObject private var presenter: SettingPresenter

    public init(router: some SettingWireframe, dependency: some SettingPresenterDependency) {
        self.router = router
        _presenter = .init(wrappedValue: .init(dependency: dependency))
    }
    
    public var body: some View {
        Text("SettingView")
            .task {
                presenter.onAppear()
            }
            .onDisappear {
                presenter.onDisappear()
            }
    }
}

// MARK: Preview
import PreviewSnapshots

struct SettingView_Previews: PreviewProvider, SnapshotTestable {
    static var previews: some View {
        snapshots.previews.previewLayout(.sizeThatFits)
    }

    static var snapshots: PreviewSnapshots<AppRootRouterDependency> {
        .init(
            configurations: [],
            configure: { state in
                // TODO: add SettingPresenterDependency to AppRootRouterDependency
                SettingView(router: AppRootRouter.empty, dependency: state)
            }
        )
    }
}


// MARK: Presenter
import Foundation
import DomainLayer

@MainActor
final class SettingPresenter: ObservableObject {
    init(dependency: some SettingPresenterDependency) {
        LoggerContainer.initLog()
    }

    deinit {
        LoggerContainer.deinitLog()
    }

    func onAppear() {
        LoggerContainer.logOnAppear()
    }

    func onDisappear() {
        LoggerContainer.logOnDisappear()
    }
}
```

---

## 🤖 アシスタント
*2024/02/26 20:20:23*

Swiftの現在の公式リリースではマクロ機能は提供されていないため、直接的なマクロを記述して上記の要求を満たすことはできません。しかし、Swiftの将来のリリースでマクロがサポートされる可能性があり、その場合はコードの生成や変更を自動化するために使用できます。

代わりに、Swiftのテンプレートやコード生成ツールを使用して似たような結果を達成することができます。例えば、SwiftGenやSourceryなどのツールを使用して、定義された構造体に基づいてコードを生成するスクリプトを作成することが可能です。これらのツールはビルドプロセス中に自動的にコードを生成するために設定することができます。

以下は、マクロのように動作する可能性のあるコード生成の概念例です。この例は、実際のSwiftのコードではなく、コード生成のための擬似コードやアイデアを示しています。

```swift
// コード生成ツールで使用する擬似コード
func generateCode(forStruct structName: String) {
    let wireframeProtocol = """
    // MARK: Wireframe
    import Foundation
    import DomainLayer

    // TODO: add \(structName)Wireframe to AppRootRouter
    public protocol \(structName)Wireframe {}
    """

    let presenterDependencyProtocol = """
    // MARK: PresenterDependency
    import Foundation
    import DomainLayer

    public protocol \(structName)PresenterDependency {}
    """

    let viewStruct = """
    // MARK: View
    import SwiftUI
    import DomainLayer

    public struct \(structName)View: View {
        private let router: \(structName)Wireframe
        @StateObject private var presenter: \(structName)Presenter

        public init(router: some \(structName)Wireframe, dependency: some \(structName)PresenterDependency) {
            self.router = router
            _presenter = .init(wrappedValue: .init(dependency: dependency))
        }

        public var body: some View {
            Text("\(structName)View")
                .task {
                    presenter.onAppear()
                }
                .onDisappear {
                    presenter.onDisappear()
                }
        }
    }
    """

    let presenterClass = """
    // MARK: Presenter
    import Foundation
    import DomainLayer

    @MainActor
    final class \(structName)Presenter: ObservableObject {
        init(dependency: some \(structName)PresenterDependency) {
            LoggerContainer.initLog()
        }

        deinit {
            LoggerContainer.deinitLog()
        }

        func onAppear() {
            LoggerContainer.logOnAppear()
        }

        func onDisappear() {
            LoggerContainer.logOnDisappear()
        }
    }
    """

    // 生成したコードをファイルに書き込む、またはコンソールに出力するなどの処理をここに追加
    print(wireframeProtocol)
    print(presenterDependencyProtocol)
    print(viewStruct)
    print(presenterClass)
}

// 使用例
generateCode(forStruct: "Setting")
```

このコードはSwiftのコンパイラによって実行されるわけではなく、コード生成を行う外部ツールやスクリプトの一部として想定されています。実際にこのような機能を実装する場合は、プロジェクトのビルドプロセスに組み込むスクリプトやツールを開発する必要があります。

---
