# デバイス情報をJSONコピー

日付: 2024-06-11

---

## 👤 ユーザー
*2024/06/12 08:54:36*

ナビゲーションバーの右上にJSONぽく内容をコピーするボタンを設けたい

// MARK: - View

@MainActor
public struct DeviceInfoView&lt;Dependency: RootDIContainerDependency&gt;: View {
    private let dependency: Dependency
    @StateObject private var presenter: DeviceInfoPresenter&lt;Dependency&gt;

    public init(dependency: Dependency) {
        self.dependency = dependency
        _presenter = .init(wrappedValue: DeviceInfoPresenter(dependency: dependency))
    }

    public var body: some View {
        List {
            Section("") {
                ForEach(DeviceInfoType.allCases) { deviceInfoType in
                    Button {
                        presenter.onTapDeviceInfo(deviceInfoType)
                    } label: {
                        HStack {
                            Text(deviceInfoType.name)
                            Spacer()
                            Text(presenter.getDeviceInfoValue(deviceInfoType))
                                .lineLimit(1)
                                .minimumScaleFactor(0.1)
                        }
                    }
                }
            }
        }
        .navigationTitle("デバイス情報")
        .alert(presenter.copiedAlertTitle, isPresented: $presenter.showCopyAlert) {
            Button("OK", action: {})
        }
        .task {
            await presenter.onAppear()
        }
        .onDisappear {
            presenter.onDisappear()
        }
    }
}

// MARK: - Domain

extension DeviceInfoType: Identifiable {
    public var id: String {
        name
    }

    var name: String {
        switch self {
        case .osVersion:
            "OS Version"
        default:
            "\(self)".camelCaseToSpaces.initialUppercased
        }
    }
}
 
@MainActor
final class DeviceInfoPresenter&lt;Dependency: DeviceInfoPresenterDependency&gt;: ObservableObject {
    @Published var showCopyAlert: Bool = false
    @Published private(set) var selectedDeviceInfoType: DeviceInfoType?

    /// UseCase の Mock を使用する場合はここを書き換える（DI のコードは書き換えず Presenter で直接指定する）
    private let deviceInfoUseCase: DeviceInfoInteractor&lt;Dependency&gt;
    private let dependency: Dependency

    var copiedAlertTitle: String {
        guard let selectedDeviceInfoType else {
            return ""
        }
        return "Copied \"\(getDeviceInfoValue(selectedDeviceInfoType))\""
    }

    init(dependency: Dependency) {
        dependency.logDriver.initLog()

        self.dependency = dependency
        deviceInfoUseCase = DeviceInfoInteractor(dependency: dependency)
    }

    deinit {
        OSLogger.deinitLog()
    }

    func onAppear() async {
        dependency.logDriver.onAppearLog()
    }

    func onDisappear() {
        dependency.logDriver.onDisappearLog()
    }

    func onTapDeviceInfo(_ deviceInfoType: DeviceInfoType) {
        selectedDeviceInfoType = deviceInfoType
        dependency.clipboardDriver.copy(deviceInfoUseCase.getDeviceInfoValue(deviceInfoType))
        showCopyAlert = true
    }

    func getDeviceInfoValue(_ deviceInfoType: DeviceInfoType) -&gt; String {
        deviceInfoUseCase.getDeviceInfoValue(deviceInfoType)
    }
}


@MainActor
public final class DeviceInfoInteractor&lt;Dependency: DeviceInfoInteractorDependency&gt;: DeviceInfoUseCase {
    private let dependency: Dependency

    public init(dependency: Dependency) {
        dependency.logDriver.initLog()

        self.dependency = dependency
    }

    public func getDeviceInfoValue(_ deviceInfoType: DeviceInfoType) -&gt; String {
        switch deviceInfoType {
        case .appVersion:
            "\(dependency.deviceInfoDriver.appVersion) (\(dependency.deviceInfoDriver.appBuildNumber))"
        case .buildScheme:
            dependency.buildEnvDriver.buildScheme.name
        case .buildConfiguration:
            dependency.buildEnvDriver.buildConfiguration.name
        case .deviceIdentifier:
            dependency.deviceInfoDriver.deviceIdentifier
        case .bundleId:
            dependency.deviceInfoDriver.bundleId
        case .deviceName:
            dependency.deviceInfoDriver.deviceName
        case .isSimulator:
            "\(dependency.deviceInfoDriver.isSimulator)"
        case .isPreview:
            "\(dependency.deviceInfoDriver.isPreview)"
        case .osVersion:
            "\(dependency.deviceInfoDriver.osType) \(dependency.deviceInfoDriver.osVersion)"
        case .timezone:
            dependency.deviceInfoDriver.timezone
        case .preferredLanguages:
            dependency.deviceInfoDriver.preferredLanguages
        case .language:
            dependency.deviceInfoDriver.language
        case .launchAppCount:
            "\(dependency.localDataStoreDriver.launchAppCount)"
        case .apnsToken:
            "\(dependency.localDataStoreDriver.apnsToken?.deviceTokenHexString ?? "not set")"
        }
    }
}

private extension BuildScheme {
    var name: String {
        "\(self)".camelCaseToSpaces.localizedCapitalized
    }
}

private extension BuildConfiguration {
    var name: String {
        "\(self)".camelCaseToSpaces.localizedCapitalized
    }
}

---

## 🤖 アシスタント
*2024/06/12 08:54:58*

ナビゲーションバーの右上にJSON風の内容をコピーするボタンを設けるために、以下のように変更を加えることができます。まず、ナビゲーションバーにカスタムボタンを追加し、そのボタンが押されたときに現在のデバイス情報をJSON形式でクリップボードにコピーする処理を追加します。

以下のコードを修正します。

### DeviceInfoView

```swift
// MARK: - View

@MainActor
public struct DeviceInfoView<Dependency: RootDIContainerDependency>: View {
    private let dependency: Dependency
    @StateObject private var presenter: DeviceInfoPresenter<Dependency>

    public init(dependency: Dependency) {
        self.dependency = dependency
        _presenter = .init(wrappedValue: DeviceInfoPresenter(dependency: dependency))
    }

    public var body: some View {
        List {
            Section("") {
                ForEach(DeviceInfoType.allCases) { deviceInfoType in
                    Button {
                        presenter.onTapDeviceInfo(deviceInfoType)
                    } label: {
                        HStack {
                            Text(deviceInfoType.name)
                            Spacer()
                            Text(presenter.getDeviceInfoValue(deviceInfoType))
                                .lineLimit(1)
                                .minimumScaleFactor(0.1)
                        }
                    }
                }
            }
        }
        .navigationTitle("デバイス情報")
        .navigationBarItems(trailing: Button(action: {
            presenter.copyAllDeviceInfoAsJSON()
        }) {
            Image(systemName: "doc.on.doc")
        })
        .alert(presenter.copiedAlertTitle, isPresented: $presenter.showCopyAlert) {
            Button("OK", action: {})
        }
        .task {
            await presenter.onAppear()
        }
        .onDisappear {
            presenter.onDisappear()
        }
    }
}
```

### DeviceInfoPresenter

次に、Presenterクラスにすべてのデバイス情報をJSON形式でコピーする関数を追加します。

```swift
@MainActor
final class DeviceInfoPresenter<Dependency: DeviceInfoPresenterDependency>: ObservableObject {
    @Published var showCopyAlert: Bool = false
    @Published private(set) var selectedDeviceInfoType: DeviceInfoType?

    /// UseCase の Mock を使用する場合はここを書き換える（DI のコードは書き換えず Presenter で直接指定する）
    private let deviceInfoUseCase: DeviceInfoInteractor<Dependency>
    private let dependency: Dependency

    var copiedAlertTitle: String {
        guard let selectedDeviceInfoType else {
            return "Copied All Device Info as JSON"
        }
        return "Copied \"\(getDeviceInfoValue(selectedDeviceInfoType))\""
    }

    init(dependency: Dependency) {
        dependency.logDriver.initLog()

        self.dependency = dependency
        deviceInfoUseCase = DeviceInfoInteractor(dependency: dependency)
    }

    deinit {
        OSLogger.deinitLog()
    }

    func onAppear() async {
        dependency.logDriver.onAppearLog()
    }

    func onDisappear() {
        dependency.logDriver.onDisappearLog()
    }

    func onTapDeviceInfo(_ deviceInfoType: DeviceInfoType) {
        selectedDeviceInfoType = deviceInfoType
        dependency.clipboardDriver.copy(deviceInfoUseCase.getDeviceInfoValue(deviceInfoType))
        showCopyAlert = true
    }

    func getDeviceInfoValue(_ deviceInfoType: DeviceInfoType) -> String {
        deviceInfoUseCase.getDeviceInfoValue(deviceInfoType)
    }

    func copyAllDeviceInfoAsJSON() {
        let allDeviceInfo = DeviceInfoType.allCases.reduce(into: [String: String]()) { result, deviceInfoType in
            result[deviceInfoType.name] = getDeviceInfoValue(deviceInfoType)
        }
        if let jsonData = try? JSONSerialization.data(withJSONObject: allDeviceInfo, options: .prettyPrinted),
           let jsonString = String(data: jsonData, encoding: .utf8) {
            dependency.clipboardDriver.copy(jsonString)
            showCopyAlert = true
        }
    }
}
```

この修正により、ナビゲーションバーの右上にJSON形式の内容をコピーするボタンが追加されます。このボタンを押すと、現在表示されているすべてのデバイス情報がJSON形式でクリップボードにコピーされ、アラートが表示されます。

---

## 👤 ユーザー
*2024/06/12 08:55:47*

Codableを使うのとどちらがいいか？

---

## 🤖 アシスタント
*2024/06/12 08:56:20*

Codableを使ってデバイス情報をJSON形式に変換するのは、型安全で読みやすく、エラー処理もしやすいため、推奨される方法です。以下に、Codableを使った実装例を示します。

まず、デバイス情報を保持する構造体を作成し、Codableに準拠させます。

### DeviceInfo

```swift
struct DeviceInfo: Codable {
    let appVersion: String
    let buildScheme: String
    let buildConfiguration: String
    let deviceIdentifier: String
    let bundleId: String
    let deviceName: String
    let isSimulator: Bool
    let isPreview: Bool
    let osVersion: String
    let timezone: String
    let preferredLanguages: String
    let language: String
    let launchAppCount: Int
    let apnsToken: String?
    
    init(dependency: Dependency) {
        self.appVersion = "\(dependency.deviceInfoDriver.appVersion) (\(dependency.deviceInfoDriver.appBuildNumber))"
        self.buildScheme = dependency.buildEnvDriver.buildScheme.name
        self.buildConfiguration = dependency.buildEnvDriver.buildConfiguration.name
        self.deviceIdentifier = dependency.deviceInfoDriver.deviceIdentifier
        self.bundleId = dependency.deviceInfoDriver.bundleId
        self.deviceName = dependency.deviceInfoDriver.deviceName
        self.isSimulator = dependency.deviceInfoDriver.isSimulator
        self.isPreview = dependency.deviceInfoDriver.isPreview
        self.osVersion = "\(dependency.deviceInfoDriver.osType) \(dependency.deviceInfoDriver.osVersion)"
        self.timezone = dependency.deviceInfoDriver.timezone
        self.preferredLanguages = dependency.deviceInfoDriver.preferredLanguages
        self.language = dependency.deviceInfoDriver.language
        self.launchAppCount = dependency.localDataStoreDriver.launchAppCount
        self.apnsToken = dependency.localDataStoreDriver.apnsToken?.deviceTokenHexString
    }
}
```

### DeviceInfoPresenter

次に、Presenterクラスにすべてのデバイス情報を取得し、JSON形式でクリップボードにコピーする関数を追加します。

```swift
@MainActor
final class DeviceInfoPresenter<Dependency: DeviceInfoPresenterDependency>: ObservableObject {
    @Published var showCopyAlert: Bool = false
    @Published private(set) var selectedDeviceInfoType: DeviceInfoType?

    private let deviceInfoUseCase: DeviceInfoInteractor<Dependency>
    private let dependency: Dependency

    var copiedAlertTitle: String {
        guard let selectedDeviceInfoType else {
            return "Copied All Device Info as JSON"
        }
        return "Copied \"\(getDeviceInfoValue(selectedDeviceInfoType))\""
    }

    init(dependency: Dependency) {
        dependency.logDriver.initLog()

        self.dependency = dependency
        deviceInfoUseCase = DeviceInfoInteractor(dependency: dependency)
    }

    deinit {
        OSLogger.deinitLog()
    }

    func onAppear() async {
        dependency.logDriver.onAppearLog()
    }

    func onDisappear() {
        dependency.logDriver.onDisappearLog()
    }

    func onTapDeviceInfo(_ deviceInfoType: DeviceInfoType) {
        selectedDeviceInfoType = deviceInfoType
        dependency.clipboardDriver.copy(deviceInfoUseCase.getDeviceInfoValue(deviceInfoType))
        showCopyAlert = true
    }

    func getDeviceInfoValue(_ deviceInfoType: DeviceInfoType) -> String {
        deviceInfoUseCase.getDeviceInfoValue(deviceInfoType)
    }

    func copyAllDeviceInfoAsJSON() {
        let deviceInfo = DeviceInfo(dependency: dependency)
        if let jsonData = try? JSONEncoder().encode(deviceInfo),
           let jsonString = String(data: jsonData, encoding: .utf8) {
            dependency.clipboardDriver.copy(jsonString)
            showCopyAlert = true
        }
    }
}
```

### DeviceInfoView

最後に、Viewを更新してボタンを追加します。

```swift
// MARK: - View

@MainActor
public struct DeviceInfoView<Dependency: RootDIContainerDependency>: View {
    private let dependency: Dependency
    @StateObject private var presenter: DeviceInfoPresenter<Dependency>

    public init(dependency: Dependency) {
        self.dependency = dependency
        _presenter = .init(wrappedValue: DeviceInfoPresenter(dependency: dependency))
    }

    public var body: some View {
        List {
            Section("") {
                ForEach(DeviceInfoType.allCases) { deviceInfoType in
                    Button {
                        presenter.onTapDeviceInfo(deviceInfoType)
                    } label: {
                        HStack {
                            Text(deviceInfoType.name)
                            Spacer()
                            Text(presenter.getDeviceInfoValue(deviceInfoType))
                                .lineLimit(1)
                                .minimumScaleFactor(0.1)
                        }
                    }
                }
            }
        }
        .navigationTitle("デバイス情報")
        .navigationBarItems(trailing: Button(action: {
            presenter.copyAllDeviceInfoAsJSON()
        }) {
            Image(systemName: "doc.on.doc")
        })
        .alert(presenter.copiedAlertTitle, isPresented: $presenter.showCopyAlert) {
            Button("OK", action: {})
        }
        .task {
            await presenter.onAppear()
        }
        .onDisappear {
            presenter.onDisappear()
        }
    }
}
```

この修正により、デバイス情報を構造体にまとめてCodableを使ってJSON形式に変換し、ナビゲーションバーのボタンを押すとその内容をクリップボードにコピーすることができます。Codableを使うことで、型安全性が向上し、エラー処理も簡単になります。

---

## 👤 ユーザー
*2024/06/12 08:57:29*

でもこうするとpresenterに値を持たなければいけなくなるのでやだな。なるべくプレゼンターに値を保持したくないんだ。以下のような定義が存在するのでうまく活用したい。

public enum DeviceInfoType: Sendable {
    case appVersion
    case osVersion
    case buildScheme
    case buildConfiguration
    case bundleId
    case isSimulator
    case isPreview
    case deviceName
    case deviceIdentifier
    case timezone
    case preferredLanguages
    case language
    case launchAppCount
    case apnsToken
}

---

## 🤖 アシスタント
*2024/06/12 08:57:59*

User prefers not to hold values in the presenter and wants to utilize the existing definition of `DeviceInfoType`.

---

## 🔧 ツール
*2024/06/12 08:57:59*

Model set context updated.

---

## 🤖 アシスタント
*2024/06/12 08:57:59*

なるべくプレゼンターに値を保持させずに、既存の `DeviceInfoType` を活用する方法として、デバイス情報を直接取得してJSON形式に変換する関数をプレゼンターに追加し、ボタンのアクションでその関数を呼び出すようにします。以下にその方法を示します。

### DeviceInfoPresenter

プレゼンターに `copyAllDeviceInfoAsJSON` 関数を追加します。この関数は、デバイス情報を動的に取得してJSON形式に変換し、クリップボードにコピーします。

```swift
@MainActor
final class DeviceInfoPresenter<Dependency: DeviceInfoPresenterDependency>: ObservableObject {
    @Published var showCopyAlert: Bool = false
    @Published private(set) var selectedDeviceInfoType: DeviceInfoType?

    private let deviceInfoUseCase: DeviceInfoInteractor<Dependency>
    private let dependency: Dependency

    var copiedAlertTitle: String {
        guard let selectedDeviceInfoType else {
            return "Copied All Device Info as JSON"
        }
        return "Copied \"\(getDeviceInfoValue(selectedDeviceInfoType))\""
    }

    init(dependency: Dependency) {
        dependency.logDriver.initLog()

        self.dependency = dependency
        deviceInfoUseCase = DeviceInfoInteractor(dependency: dependency)
    }

    deinit {
        OSLogger.deinitLog()
    }

    func onAppear() async {
        dependency.logDriver.onAppearLog()
    }

    func onDisappear() {
        dependency.logDriver.onDisappearLog()
    }

    func onTapDeviceInfo(_ deviceInfoType: DeviceInfoType) {
        selectedDeviceInfoType = deviceInfoType
        dependency.clipboardDriver.copy(deviceInfoUseCase.getDeviceInfoValue(deviceInfoType))
        showCopyAlert = true
    }

    func getDeviceInfoValue(_ deviceInfoType: DeviceInfoType) -> String {
        deviceInfoUseCase.getDeviceInfoValue(deviceInfoType)
    }

    func copyAllDeviceInfoAsJSON() {
        let allDeviceInfo = DeviceInfoType.allCases.reduce(into: [String: String]()) { result, deviceInfoType in
            result[deviceInfoType.name] = getDeviceInfoValue(deviceInfoType)
        }
        if let jsonData = try? JSONSerialization.data(withJSONObject: allDeviceInfo, options: .prettyPrinted),
           let jsonString = String(data: jsonData, encoding: .utf8) {
            dependency.clipboardDriver.copy(jsonString)
            showCopyAlert = true
        }
    }
}
```

### DeviceInfoView

Viewにナビゲーションバーのボタンを追加します。

```swift
// MARK: - View

@MainActor
public struct DeviceInfoView<Dependency: RootDIContainerDependency>: View {
    private let dependency: Dependency
    @StateObject private var presenter: DeviceInfoPresenter<Dependency>

    public init(dependency: Dependency) {
        self.dependency = dependency
        _presenter = .init(wrappedValue: DeviceInfoPresenter(dependency: dependency))
    }

    public var body: some View {
        List {
            Section("") {
                ForEach(DeviceInfoType.allCases) { deviceInfoType in
                    Button {
                        presenter.onTapDeviceInfo(deviceInfoType)
                    } label: {
                        HStack {
                            Text(deviceInfoType.name)
                            Spacer()
                            Text(presenter.getDeviceInfoValue(deviceInfoType))
                                .lineLimit(1)
                                .minimumScaleFactor(0.1)
                        }
                    }
                }
            }
        }
        .navigationTitle("デバイス情報")
        .navigationBarItems(trailing: Button(action: {
            presenter.copyAllDeviceInfoAsJSON()
        }) {
            Image(systemName: "doc.on.doc")
        })
        .alert(presenter.copiedAlertTitle, isPresented: $presenter.showCopyAlert) {
            Button("OK", action: {})
        }
        .task {
            await presenter.onAppear()
        }
        .onDisappear {
            presenter.onDisappear()
        }
    }
}
```

### DeviceInfoTypeの拡張

`DeviceInfoType` に名前を取得するプロパティを追加します。

```swift
extension DeviceInfoType: Identifiable {
    public var id: String {
        name
    }

    var name: String {
        switch self {
        case .appVersion:
            return "App Version"
        case .osVersion:
            return "OS Version"
        case .buildScheme:
            return "Build Scheme"
        case .buildConfiguration:
            return "Build Configuration"
        case .bundleId:
            return "Bundle ID"
        case .isSimulator:
            return "Is Simulator"
        case .isPreview:
            return "Is Preview"
        case .deviceName:
            return "Device Name"
        case .deviceIdentifier:
            return "Device Identifier"
        case .timezone:
            return "Timezone"
        case .preferredLanguages:
            return "Preferred Languages"
        case .language:
            return "Language"
        case .launchAppCount:
            return "Launch App Count"
        case .apnsToken:
            return "APNs Token"
        }
    }
}
```

この方法では、プレゼンターに値を保持する必要はなく、動的にデバイス情報を取得してJSON形式に変換することができます。これにより、クリーンで管理しやすいコードを維持できます。

---

## 👤 ユーザー
*2024/06/12 09:28:47*

guard文に変えてほしい

let allDeviceInfo = DeviceInfoType.allCases.reduce(into: [String: String]()) { result, deviceInfoType in
            result[deviceInfoType.name] = getDeviceInfoValue(deviceInfoType)
        }
        if let jsonData = try? JSONSerialization.data(withJSONObject: allDeviceInfo, options: .prettyPrinted),
           let jsonString = String(data: jsonData, encoding: .utf8) {
            dependency.clipboardDriver.copy(jsonString)
            showCopyAlert = true
        }

---

## 🤖 アシスタント
*2024/06/12 09:28:52*

以下のように `guard` 文を使用して書き換えることができます。

```swift
func copyAllDeviceInfoAsJSON() {
    let allDeviceInfo = DeviceInfoType.allCases.reduce(into: [String: String]()) { result, deviceInfoType in
        result[deviceInfoType.name] = getDeviceInfoValue(deviceInfoType)
    }
    guard let jsonData = try? JSONSerialization.data(withJSONObject: allDeviceInfo, options: .prettyPrinted),
          let jsonString = String(data: jsonData, encoding: .utf8) else {
        return
    }
    dependency.clipboardDriver.copy(jsonString)
    showCopyAlert = true
}
```

このように `guard` 文を使用することで、エラーが発生した場合に早期リターンすることができ、可読性が向上します。

---

## 👤 ユーザー
*2024/06/12 09:30:42*

以下のようになった。毎回順番を固定にしてほしい

{
  "OS Version" : "iOS 17.5",
  "Device Name" : "Simulator (iPhone 15 Pro)",
  "Device Identifier" : "iPhone16,1",
  "Language" : "language",
  "App Version" : "0.1.0 (1)",
  "Build Configuration" : "Debug",
  "Preferred Languages" : "[\"ja-JP\", \"en-JP\"]",
  "Launch App Count" : "6",
  "Timezone" : "Asia\/Tokyo",
  "Apns Token" : "not set",
  "Is Preview" : "false",
  "Build Scheme" : "Staging",
  "Is Simulator" : "true",
  "Bundle Id" : "jp.co.crage.small-talk.staging"
}

---

## 🤖 アシスタント
*2024/06/12 09:30:58*

順番を固定するためには、DeviceInfoTypeに表示順序を指定するためのプロパティを追加し、その順序に従って情報を取得するようにします。

まず、DeviceInfoTypeに順序を指定するプロパティを追加します。

```swift
public enum DeviceInfoType: Sendable, CaseIterable {
    case appVersion
    case osVersion
    case buildScheme
    case buildConfiguration
    case bundleId
    case isSimulator
    case isPreview
    case deviceName
    case deviceIdentifier
    case timezone
    case preferredLanguages
    case language
    case launchAppCount
    case apnsToken

    var displayOrder: Int {
        switch self {
        case .osVersion:
            return 0
        case .deviceName:
            return 1
        case .deviceIdentifier:
            return 2
        case .language:
            return 3
        case .appVersion:
            return 4
        case .buildConfiguration:
            return 5
        case .preferredLanguages:
            return 6
        case .launchAppCount:
            return 7
        case .timezone:
            return 8
        case .apnsToken:
            return 9
        case .isPreview:
            return 10
        case .buildScheme:
            return 11
        case .isSimulator:
            return 12
        case .bundleId:
            return 13
        }
    }
}
```

次に、`copyAllDeviceInfoAsJSON` 関数を順序に従って情報を取得するように修正します。

```swift
func copyAllDeviceInfoAsJSON() {
    let allDeviceInfo = DeviceInfoType.allCases
        .sorted { $0.displayOrder < $1.displayOrder }
        .reduce(into: [String: String]()) { result, deviceInfoType in
            result[deviceInfoType.name] = getDeviceInfoValue(deviceInfoType)
        }
    guard let jsonData = try? JSONSerialization.data(withJSONObject: allDeviceInfo, options: .prettyPrinted),
          let jsonString = String(data: jsonData, encoding: .utf8) else {
        return
    }
    dependency.clipboardDriver.copy(jsonString)
    showCopyAlert = true
}
```

この修正により、JSONに含まれるデバイス情報の順序が固定されます。

---

## 👤 ユーザー
*2024/06/12 09:31:10*

そんなことはしたいくない。もっとスマートな方法はないか？

---

## 🤖 アシスタント
*2024/06/12 09:31:27*

もっとスマートな方法として、`DeviceInfoType` を配列にして順序を保持する方法があります。この配列に従ってデバイス情報を取得し、JSON形式に変換します。

### DeviceInfoPresenter

`copyAllDeviceInfoAsJSON` 関数を以下のように修正します。

```swift
func copyAllDeviceInfoAsJSON() {
    let orderedDeviceInfoTypes: [DeviceInfoType] = [
        .osVersion,
        .deviceName,
        .deviceIdentifier,
        .language,
        .appVersion,
        .buildConfiguration,
        .preferredLanguages,
        .launchAppCount,
        .timezone,
        .apnsToken,
        .isPreview,
        .buildScheme,
        .isSimulator,
        .bundleId
    ]

    let allDeviceInfo = orderedDeviceInfoTypes.reduce(into: [String: String]()) { result, deviceInfoType in
        result[deviceInfoType.name] = getDeviceInfoValue(deviceInfoType)
    }

    guard let jsonData = try? JSONSerialization.data(withJSONObject: allDeviceInfo, options: .prettyPrinted),
          let jsonString = String(data: jsonData, encoding: .utf8) else {
        return
    }
    dependency.clipboardDriver.copy(jsonString)
    showCopyAlert = true
}
```

### DeviceInfoTypeの拡張

`DeviceInfoType` に名前を取得するプロパティを追加します。

```swift
extension DeviceInfoType: Identifiable {
    public var id: String {
        name
    }

    var name: String {
        switch self {
        case .appVersion:
            return "App Version"
        case .osVersion:
            return "OS Version"
        case .buildScheme:
            return "Build Scheme"
        case .buildConfiguration:
            return "Build Configuration"
        case .bundleId:
            return "Bundle ID"
        case .isSimulator:
            return "Is Simulator"
        case .isPreview:
            return "Is Preview"
        case .deviceName:
            return "Device Name"
        case .deviceIdentifier:
            return "Device Identifier"
        case .timezone:
            return "Timezone"
        case .preferredLanguages:
            return "Preferred Languages"
        case .language:
            return "Language"
        case .launchAppCount:
            return "Launch App Count"
        case .apnsToken:
            return "APNs Token"
        }
    }
}
```

この方法により、`DeviceInfoType` の順序を指定する必要がなく、`copyAllDeviceInfoAsJSON` 関数内で順序付けを行うだけで済みます。これにより、コードがシンプルでメンテナンスしやすくなります。

---

## 👤 ユーザー
*2024/06/12 09:31:59*

JSONSerialization の オプションにないのか？

---

## 🤖 アシスタント
*2024/06/12 09:32:15*

`JSONSerialization` のオプションに、キーの順序を指定する機能はありません。しかし、キーを特定の順序で追加することで、順序を維持したJSONを生成することができます。以下のコードは、その方法を実装しています。

### DeviceInfoPresenter

`copyAllDeviceInfoAsJSON` 関数を修正して、キーの順序を維持するようにします。

```swift
func copyAllDeviceInfoAsJSON() {
    let orderedDeviceInfoTypes: [DeviceInfoType] = [
        .osVersion,
        .deviceName,
        .deviceIdentifier,
        .language,
        .appVersion,
        .buildConfiguration,
        .preferredLanguages,
        .launchAppCount,
        .timezone,
        .apnsToken,
        .isPreview,
        .buildScheme,
        .isSimulator,
        .bundleId
    ]

    var allDeviceInfo: [String: String] = [:]
    for deviceInfoType in orderedDeviceInfoTypes {
        allDeviceInfo[deviceInfoType.name] = getDeviceInfoValue(deviceInfoType)
    }

    guard let jsonData = try? JSONSerialization.data(withJSONObject: allDeviceInfo, options: .prettyPrinted),
          let jsonString = String(data: jsonData, encoding: .utf8) else {
        return
    }
    dependency.clipboardDriver.copy(jsonString)
    showCopyAlert = true
}
```

### DeviceInfoTypeの拡張

`DeviceInfoType` に名前を取得するプロパティを追加します。

```swift
extension DeviceInfoType: Identifiable {
    public var id: String {
        name
    }

    var name: String {
        switch self {
        case .appVersion:
            return "App Version"
        case .osVersion:
            return "OS Version"
        case .buildScheme:
            return "Build Scheme"
        case .buildConfiguration:
            return "Build Configuration"
        case .bundleId:
            return "Bundle ID"
        case .isSimulator:
            return "Is Simulator"
        case .isPreview:
            return "Is Preview"
        case .deviceName:
            return "Device Name"
        case .deviceIdentifier:
            return "Device Identifier"
        case .timezone:
            return "Timezone"
        case .preferredLanguages:
            return "Preferred Languages"
        case .language:
            return "Language"
        case .launchAppCount:
            return "Launch App Count"
        case .apnsToken:
            return "APNs Token"
        }
    }
}
```

この方法により、指定した順序でキーを追加し、順序を維持したJSONを生成することができます。

---

## 👤 ユーザー
*2024/06/12 09:32:30*

sortedKeys は？

---

## 🤖 アシスタント
*2024/06/12 09:32:46*

`JSONSerialization`自体にはキーの順序を制御するオプションはありませんが、Swiftの標準ライブラリを使って順序付けられたキーを手動で追加することができます。以下に示す方法で、`sortedKeys`オプションを使用してJSONのキーの順序を維持することができます。

```swift
func copyAllDeviceInfoAsJSON() {
    let orderedDeviceInfoTypes: [DeviceInfoType] = [
        .osVersion,
        .deviceName,
        .deviceIdentifier,
        .language,
        .appVersion,
        .buildConfiguration,
        .preferredLanguages,
        .launchAppCount,
        .timezone,
        .apnsToken,
        .isPreview,
        .buildScheme,
        .isSimulator,
        .bundleId
    ]

    var allDeviceInfo: [String: String] = [:]
    for deviceInfoType in orderedDeviceInfoTypes {
        allDeviceInfo[deviceInfoType.name] = getDeviceInfoValue(deviceInfoType)
    }

    guard let jsonData = try? JSONSerialization.data(withJSONObject: allDeviceInfo, options: [.prettyPrinted, .sortedKeys]),
          let jsonString = String(data: jsonData, encoding: .utf8) else {
        return
    }
    dependency.clipboardDriver.copy(jsonString)
    showCopyAlert = true
}
```

### DeviceInfoTypeの拡張

既存の`DeviceInfoType`の拡張を使用します。

```swift
extension DeviceInfoType: Identifiable {
    public var id: String {
        name
    }

    var name: String {
        switch self {
        case .appVersion:
            return "App Version"
        case .osVersion:
            return "OS Version"
        case .buildScheme:
            return "Build Scheme"
        case .buildConfiguration:
            return "Build Configuration"
        case .bundleId:
            return "Bundle ID"
        case .isSimulator:
            return "Is Simulator"
        case .isPreview:
            return "Is Preview"
        case .deviceName:
            return "Device Name"
        case .deviceIdentifier:
            return "Device Identifier"
        case .timezone:
            return "Timezone"
        case .preferredLanguages:
            return "Preferred Languages"
        case .language:
            return "Language"
        case .launchAppCount:
            return "Launch App Count"
        case .apnsToken:
            return "APNs Token"
        }
    }
}
```

この方法では、`.sortedKeys`オプションを使用して、辞書のキーをアルファベット順にソートしてJSONに変換するため、キーの順序が固定されます。これは非常にスマートな方法ですが、キーの順序が特定の順序（アルファベット順）に依存することに注意が必要です。もし特定の順序を維持したい場合、先ほどの方法のように順序付けられた配列を使用する方法も一つの手です。

---

## 👤 ユーザー
*2024/06/12 09:34:27*

この4つだけほしい

App Version
Build Scheme
Device Name
OS Version

---

## 🤖 アシスタント
*2024/06/12 09:34:41*

特定の4つのデバイス情報のみをJSONに含め、順序を固定するためには、以下のように実装できます。

### DeviceInfoPresenter

`copyAllDeviceInfoAsJSON` 関数を修正して、必要なデバイス情報のみを取得し、順序を固定します。

```swift
func copyAllDeviceInfoAsJSON() {
    let orderedDeviceInfoTypes: [DeviceInfoType] = [
        .appVersion,
        .buildScheme,
        .deviceName,
        .osVersion
    ]

    var allDeviceInfo: [String: String] = [:]
    for deviceInfoType in orderedDeviceInfoTypes {
        allDeviceInfo[deviceInfoType.name] = getDeviceInfoValue(deviceInfoType)
    }

    guard let jsonData = try? JSONSerialization.data(withJSONObject: allDeviceInfo, options: .prettyPrinted),
          let jsonString = String(data: jsonData, encoding: .utf8) else {
        return
    }
    dependency.clipboardDriver.copy(jsonString)
    showCopyAlert = true
}
```

### DeviceInfoTypeの拡張

既存の `DeviceInfoType` の拡張を使用します。

```swift
extension DeviceInfoType: Identifiable {
    public var id: String {
        name
    }

    var name: String {
        switch self {
        case .appVersion:
            return "App Version"
        case .osVersion:
            return "OS Version"
        case .buildScheme:
            return "Build Scheme"
        case .buildConfiguration:
            return "Build Configuration"
        case .bundleId:
            return "Bundle ID"
        case .isSimulator:
            return "Is Simulator"
        case .isPreview:
            return "Is Preview"
        case .deviceName:
            return "Device Name"
        case .deviceIdentifier:
            return "Device Identifier"
        case .timezone:
            return "Timezone"
        case .preferredLanguages:
            return "Preferred Languages"
        case .language:
            return "Language"
        case .launchAppCount:
            return "Launch App Count"
        case .apnsToken:
            return "APNs Token"
        }
    }
}
```

このコードにより、指定された4つのデバイス情報のみが順序付けられてJSON形式でクリップボードにコピーされます。これで必要な情報のみが含まれ、順序も指定通りに固定されます。

---

## 👤 ユーザー
*2024/06/12 09:37:27*

orderedDeviceInfoTypes ではなくて、コピーすべきという意味合いの変数名を教えてほしい。boolがいい


extension DeviceInfoType {
    var isNeedDebug: Bool {
        self {
        case .appVersion, .buildScheme, .deviceName, .osVersion:
            true
        default:
            false
        }
    }
}

---

## 🤖 アシスタント
*2024/06/12 09:37:38*

`isNeedDebug` の代わりに、`isCopyRequired` という変数名を提案します。これにより、このプロパティがコピーすべき情報かどうかを示していることが明確になります。

### DeviceInfoTypeの拡張

```swift
extension DeviceInfoType {
    var isCopyRequired: Bool {
        switch self {
        case .appVersion, .buildScheme, .deviceName, .osVersion:
            return true
        default:
            return false
        }
    }
}
```

### DeviceInfoPresenter

`copyAllDeviceInfoAsJSON` 関数を修正して、`isCopyRequired` プロパティを使用するようにします。

```swift
func copyAllDeviceInfoAsJSON() {
    let allDeviceInfo = DeviceInfoType.allCases
        .filter { $0.isCopyRequired }
        .reduce(into: [String: String]()) { result, deviceInfoType in
            result[deviceInfoType.name] = getDeviceInfoValue(deviceInfoType)
        }

    guard let jsonData = try? JSONSerialization.data(withJSONObject: allDeviceInfo, options: .prettyPrinted),
          let jsonString = String(data: jsonData, encoding: .utf8) else {
        return
    }
    dependency.clipboardDriver.copy(jsonString)
    showCopyAlert = true
}
```

この方法により、コピーすべき情報のみを含めることができます。`isCopyRequired` プロパティを使ってフィルタリングし、指定された4つのデバイス情報のみがJSONに含まれるようにします。

---
