# ビュー修正のリクエスト

日付: 2024-10-17

---

## 👤 ユーザー
*2024/10/18 7:39:12*

直してほしい
'buildExpression' is unavailable: this expression does not conform to 'View'

if viewModel.isPresentedGuide {
                if case .guide(let type) = viewModel.pauseAlert {
                    var title: String = ""
                    var message: String = ""
                    var imageRes: String = ""
                    switch type {
                    case .jaMode:
                        title = "日本語モード"
                        imageRes = "conversation_study_tutorial_ja_mode"
                        message = "英語でなんて言ったらいいかわからない時に使ってみてね！使い終わったらもう一度タップすると元の会話に戻るよ。"

                    case .preference:
                        title = "会話の調整"
                        imageRes = "conversation_study_tutorial_setting"
                        message = "会話はやりやすいですか？右上のアイコンから相手の発話速度や言語レベルを調整できます！"
                    }
                    AppAlert {
                        GuideAlert(
                            title: title,
                            imageRes: imageRes,
                            message: message,
                            onOkTapped: { viewModel.hideAlert() }
                        )
                    }
                }
            }

---

## 🤖 アシスタント
*2024/10/18 7:39:39*

`buildExpression` が使えない理由は `GuideAlert` や `AppAlert` が `View` プロトコルに準拠していないためです。これを修正するためには、`GuideAlert` と `AppAlert` を `View` に準拠させるか、適切に SwiftUI のビューとして扱う必要があります。

まず、コードを SwiftUI に適応させるため、以下の修正を行います。

1. `AppAlert` が `View` プロトコルに準拠しているか確認する。
2. `GuideAlert` が `View` プロトコルに準拠しているか確認する。

以下のように修正できます:

```swift
if viewModel.isPresentedGuide {
    if case .guide(let type) = viewModel.pauseAlert {
        var title: String = ""
        var message: String = ""
        var imageRes: String = ""
        
        switch type {
        case .jaMode:
            title = "日本語モード"
            imageRes = "conversation_study_tutorial_ja_mode"
            message = "英語でなんて言ったらいいかわからない時に使ってみてね！使い終わったらもう一度タップすると元の会話に戻るよ。"
        
        case .preference:
            title = "会話の調整"
            imageRes = "conversation_study_tutorial_setting"
            message = "会話はやりやすいですか？右上のアイコンから相手の発話速度や言語レベルを調整できます！"
        }
        
        AppAlert { // AppAlertがViewに準拠していることを確認
            GuideAlert( // GuideAlertがViewに準拠していることを確認
                title: title,
                imageRes: imageRes,
                message: message,
                onOkTapped: { viewModel.hideAlert() }
            )
        }
        .frame(maxWidth: .infinity, maxHeight: .infinity) // AppAlertがViewとして正しく描画されるように
    }
}
```

`AppAlert` と `GuideAlert` がカスタムビューであることを前提としていますが、もしこれらが `View` プロトコルに準拠していない場合は、以下のように `View` に準拠させる必要があります。

```swift
struct AppAlert<Content: View>: View {
    let content: Content
    
    var body: some View {
        VStack {
            content
        }
        .background(Color.white)
        .cornerRadius(10)
    }
}

struct GuideAlert: View {
    let title: String
    let imageRes: String
    let message: String
    let onOkTapped: () -> Void
    
    var body: some View {
        VStack {
            Text(title)
                .font(.headline)
            Image(imageRes)
                .resizable()
                .aspectRatio(contentMode: .fit)
            Text(message)
                .font(.body)
            Button("OK", action: onOkTapped)
        }
        .padding()
    }
}
```

このように修正すると、SwiftUI のビューの構造と整合性が取れるようになります。

---

## 👤 ユーザー
*2024/10/18 7:40:20*

準拠しているんだけどViewで行ってはいけない記述なのかもしれない

    enum PauseAlertType: Equatable {
        case none
        case pause
        case quit
        case guide(GuideType)

        enum GuideType {
            case jaMode
            case preference
        }
    }

---

## 🤖 アシスタント
*2024/10/18 7:41:04*

`View` プロトコルに準拠している状態でもエラーが出る場合、以下の点が問題の可能性があります。

### 1. **条件分岐での状態管理**
SwiftUI では `View` の構造が宣言的に定義されているため、`if` や `switch` でビューツリーの状態を動的に変更すると問題が発生することがあります。

### 2. **状態が正しく更新されない**
`viewModel.pauseAlert` や `viewModel.isPresentedGuide` の状態管理が適切でない場合、SwiftUI が正しくレンダリングできないことがあります。

この問題を解決するために、状態を明示的に `@State` や `@ObservedObject` で管理し、ビューレンダリングのタイミングが正しく動作するようにしましょう。以下のようにリファクタリングして、ビュー構造をシンプルにしつつ、条件に応じてビューを切り替えることができます。

### 修正版コード例:

```swift
struct ContentView: View {
    @ObservedObject var viewModel: ViewModel

    var body: some View {
        VStack {
            if viewModel.isPresentedGuide {
                if let type = viewModel.getPauseGuideType() {
                    GuideAlertView(type: type) {
                        viewModel.hideAlert()
                    }
                }
            }
        }
    }
}

struct GuideAlertView: View {
    let type: PauseAlertType.GuideType
    let onOkTapped: () -> Void

    var body: some View {
        var title: String = ""
        var message: String = ""
        var imageRes: String = ""

        switch type {
        case .jaMode:
            title = "日本語モード"
            imageRes = "conversation_study_tutorial_ja_mode"
            message = "英語でなんて言ったらいいかわからない時に使ってみてね！使い終わったらもう一度タップすると元の会話に戻るよ。"

        case .preference:
            title = "会話の調整"
            imageRes = "conversation_study_tutorial_setting"
            message = "会話はやりやすいですか？右上のアイコンから相手の発話速度や言語レベルを調整できます！"
        }

        VStack {
            Text(title)
                .font(.headline)
            Image(imageRes)
                .resizable()
                .aspectRatio(contentMode: .fit)
            Text(message)
                .font(.body)
            Button("OK", action: onOkTapped)
        }
        .padding()
        .background(Color.white)
        .cornerRadius(10)
        .shadow(radius: 5)
    }
}

class ViewModel: ObservableObject {
    @Published var isPresentedGuide: Bool = false
    @Published var pauseAlert: PauseAlertType = .none

    func getPauseGuideType() -> PauseAlertType.GuideType? {
        if case let .guide(type) = pauseAlert {
            return type
        }
        return nil
    }

    func hideAlert() {
        pauseAlert = .none
        isPresentedGuide = false
    }
}
```

### 修正ポイント：
1. **`GuideAlertView` にロジックを移動**  
   `GuideAlertView` に `GuideType` によるスイッチロジックを移動させ、ビューをシンプルにしつつ表示を分離しました。

2. **`viewModel.getPauseGuideType()` の導入**  
   `pauseAlert` が `.guide` の場合のみ `GuideType` を返すようにして、ビューでの `if case` 文をシンプルにしました。

3. **状態管理の修正**  
   SwiftUI のビューは状態が変わるたびに再レンダリングされるため、`@Published` プロパティを使い、状態の変化が反映されるようにしました。

これで、SwiftUI の宣言的なビュー構造に適した方法でガイドのアラートを表示できるはずです。

---
