# ローカルホスト接続設定

日付: 2024-12-19

---

## 👤 ユーザー
*2024/12/20 08:32:25*

Flutter でローカルホストにAPIサーバーを立てたが、シミュレーターから接続できなかった。
iOSAndroidともにどう設定すればいいのか？

---

## 🤖 アシスタント
*2024/12/20 08:33:00*

FlutterアプリからローカルホストのAPIサーバーに接続する際、iOSとAndroidのシミュレーター/エミュレーターでは通常の`localhost`ではなく特定の設定が必要です。それぞれのOSでの設定方法を説明します。

---

### **iOS Simulator**
iOSシミュレーターは、Macのネットワークを共有しています。そのため、ローカルホストを使用するには以下のアプローチが必要です。

1. **サーバーのアドレスを`127.0.0.1`に変更**
   - 通常、`localhost`と同じ意味ですが、iOSシミュレーターで確実に動作します。

2. **HTTPSが必要な場合は証明書を設定**
   - ローカル開発環境でHTTPSを使用する場合、サーバーの証明書を信頼できるようにする必要があります。
   - `Info.plist`に以下を追加して、ローカルアドレスでHTTPSが必要ないように設定することも可能です。

```xml
<key>NSAppTransportSecurity</key>
<dict>
    <key>NSAllowsArbitraryLoads</key>
    <true/>
    <key>NSExceptionDomains</key>
    <dict>
        <key>localhost</key>
        <dict>
            <key>NSExceptionAllowsInsecureHTTPLoads</key>
            <true/>
        </dict>
    </dict>
</dict>
```

---

### **Android Emulator**
Androidエミュレーターでは`localhost`や`127.0.0.1`はエミュレーター自身を指します。そのため、ホストマシンのローカルホストに接続するには以下の設定を行います。

1. **サーバーのアドレスを`10.0.2.2`に変更**
   - Androidエミュレーターでは`10.0.2.2`がホストマシンの`localhost`に対応します。

2. **HTTPSが必要な場合**
   - 自己署名証明書を使っている場合、アプリ内で証明書を信頼する設定をする必要があります。
   - 信頼設定を省略したい場合は、開発中にHTTPでの接続を許可する以下の設定を`AndroidManifest.xml`に追加します。

```xml
<application
    android:usesCleartextTraffic="true"
    ... >
</application>
```

---

### **Flutterコードの変更**
バックエンドのアドレスを環境に応じて切り替えるコードを追加すると便利です。

```dart
String getBaseUrl() {
  if (Platform.isIOS) {
    return 'http://127.0.0.1:8000'; // iOS用
  } else if (Platform.isAndroid) {
    return 'http://10.0.2.2:8000'; // Android用
  } else {
    return 'http://localhost:8000'; // 他のプラットフォーム
  }
}
```

使い方：

```dart
final baseUrl = getBaseUrl();
// 例: http://127.0.0.1:8000/api/example
```

---

### **その他のポイント**
1. **APIサーバーが正しく起動しているか確認**
   - ローカルホストで`curl http://127.0.0.1:8000`やブラウザでサーバーにアクセスして正常に動作しているか確認。

2. **ファイアウォールやポート設定**
   - サーバーが動いているポート（例: `8000`）がファイアウォールでブロックされていないことを確認。

3. **外部デバイスを使う場合**
   - 実機で接続する場合、ホストのローカルIPアドレス（例: `192.168.x.x`）を使用する必要があります。

---

これでシミュレーターやエミュレーターからローカルホストのAPIサーバーに接続できるはずです。必要に応じて設定を調整してください！

---

## 👤 ユーザー
*2024/12/20 08:40:46*

- iOS 実機: localhost接続不可能
- iOS シミュレーター: localhost接続可能
- Android シミュレーター: localhost接続不可能
- Android シミュレーター: localhost接続不可能

device_info_plus を使って、デバッグビルド時のみlocalhostに接続可能なようにして欲しい

@riverpod
Uri baseUri(Ref ref) {
  return Uri.parse('http://localhost:3002');
}

---

## 🤖 アシスタント
*2024/12/20 08:41:20*

`device_info_plus` を使用して、デバッグビルド時にのみ `localhost` に接続可能にする実装例を以下に示します。このコードでは、プラットフォームごとのローカルホスト接続を適切に設定し、デバッグモードでのみ使用するように制御します。

---

### 実装例

```dart
import 'dart:io';
import 'package:device_info_plus/device_info_plus.dart';
import 'package:riverpod_annotation/riverpod_annotation.dart';

part 'base_uri_provider.g.dart';

@riverpod
Future<Uri> baseUri(BaseUriRef ref) async {
  // デフォルトのURI（本番用や外部サーバー）
  const productionUri = 'https://example.com';

  // デバッグモード判定（デバッグビルド時のみtrue）
  const isDebug = bool.fromEnvironment('dart.vm.product') == false;

  if (!isDebug) {
    // 本番ビルドの場合は外部サーバーのURIを返す
    return Uri.parse(productionUri);
  }

  // デバイス情報を取得
  final deviceInfo = DeviceInfoPlugin();
  String baseUrl;

  if (Platform.isIOS) {
    final iosInfo = await deviceInfo.iosInfo;
    if (iosInfo.isPhysicalDevice) {
      // iOS実機ではlocalhost接続不可能
      baseUrl = productionUri;
    } else {
      // iOSシミュレーター
      baseUrl = 'http://127.0.0.1:3002';
    }
  } else if (Platform.isAndroid) {
    final androidInfo = await deviceInfo.androidInfo;
    if (androidInfo.isPhysicalDevice) {
      // Android実機ではlocalhost接続不可能
      baseUrl = productionUri;
    } else {
      // Androidエミュレーター
      baseUrl = 'http://10.0.2.2:3002';
    }
  } else {
    // その他のプラットフォーム
    baseUrl = productionUri;
  }

  return Uri.parse(baseUrl);
}
```

---

### **ポイント解説**
1. **`isDebug`でビルドタイプを判定**
   - `bool.fromEnvironment('dart.vm.product')` を使用して、デバッグモードかどうかを確認します。
   - 本番ビルドでは常に外部サーバーのURIを使用する設定にします。

2. **デバイスの物理/仮想判定**
   - `device_info_plus` を使い、`isPhysicalDevice` を用いて実機かシミュレーターかを判定。
   - シミュレーターやエミュレーターでは`localhost`接続を有効化します。

3. **プラットフォームごとの`localhost`設定**
   - **iOS シミュレーター**: `127.0.0.1`
   - **Android エミュレーター**: `10.0.2.2`
   - **実機**: `localhost`接続ができないため外部サーバーURIを使用。

4. **`riverpod`でプロバイダー化**
   - `@riverpod`を使用して`baseUri`をプロバイダーとして管理。
   - 必要な箇所で`ref.watch(baseUriProvider)`でアクセス可能。

---

### **使用方法**

`baseUri` プロバイダーを以下のように使用します。

```dart
void main() async {
  final container = ProviderContainer();
  final uri = await container.read(baseUriProvider.future);

  print('Base URI: $uri'); // 開発中の環境に応じたURIが表示される
}
```

---

このコードにより、シミュレーターやエミュレーターではローカルホストに接続しつつ、実機や本番ビルドでは外部サーバーのURIを使用する動作が可能になります。

---

## 👤 ユーザー
*2024/12/20 08:41:59*

デバッグモード判定もDeviceInfoPluginでできないか？

---

## 🤖 アシスタント
*2024/12/20 08:42:43*

`DeviceInfoPlugin` では直接的にデバッグモードを判定する機能はありません。ただし、間接的にデバッグモードかどうかを推測する方法として、以下のような情報を活用できます：

1. **Androidの場合**: `androidInfo.version.securityPatch` が空文字であればエミュレーターや開発モードの可能性が高いです。
2. **iOSの場合**: シミュレーターか実機かを判定する `isPhysicalDevice` を利用して、シミュレーターならデバッグモードと仮定できます。

これらを利用してデバッグモードを判定する例を以下に示します。

---

### 実装例

```dart
import 'dart:io';
import 'package:device_info_plus/device_info_plus.dart';
import 'package:riverpod_annotation/riverpod_annotation.dart';

part 'base_uri_provider.g.dart';

@riverpod
Future<Uri> baseUri(BaseUriRef ref) async {
  // デフォルトのURI（本番用や外部サーバー）
  const productionUri = 'https://example.com';

  // デバイス情報を取得
  final deviceInfo = DeviceInfoPlugin();
  String baseUrl;

  // デバッグモードかどうかを推測
  bool isDebug = false;

  if (Platform.isAndroid) {
    final androidInfo = await deviceInfo.androidInfo;

    // Androidのセキュリティパッチ情報でデバッグかどうか推測
    isDebug = androidInfo.version.securityPatch.isEmpty;

    if (isDebug) {
      // Androidエミュレーター用
      baseUrl = 'http://10.0.2.2:3002';
    } else if (androidInfo.isPhysicalDevice) {
      // Android実機用
      baseUrl = productionUri;
    } else {
      // その他のAndroid（例えば仮想デバイス）
      baseUrl = 'http://10.0.2.2:3002';
    }
  } else if (Platform.isIOS) {
    final iosInfo = await deviceInfo.iosInfo;

    // iOSシミュレーターか実機かで判定
    isDebug = !iosInfo.isPhysicalDevice;

    if (isDebug) {
      // iOSシミュレーター用
      baseUrl = 'http://127.0.0.1:3002';
    } else {
      // iOS実機用
      baseUrl = productionUri;
    }
  } else {
    // その他のプラットフォーム
    baseUrl = productionUri;
  }

  // デバッグモードではない場合、外部サーバーのURIを返す
  return Uri.parse(baseUrl);
}
```

---

### **ポイント解説**
1. **Androidのデバッグ判定**
   - `securityPatch.isEmpty` を利用して、セキュリティパッチ情報がない場合はデバッグモードで動作している可能性が高い。
   - エミュレーターでは通常セキュリティパッチ情報が設定されていないため、これをデバッグ判定に利用できます。

2. **iOSのデバッグ判定**
   - `isPhysicalDevice` を使って、シミュレーター（デバッグモードと仮定）か実機かを判定。

3. **デフォルトのURI**
   - `isDebug` に応じて、ローカルホスト接続か本番用URIを切り替え。

4. **プラットフォームごとの対応**
   - iOSとAndroidで異なるローカルホストアドレスを設定 (`127.0.0.1` vs `10.0.2.2`)。

---

### **使用例**

```dart
void main() async {
  final container = ProviderContainer();
  final uri = await container.read(baseUriProvider.future);

  print('Base URI: $uri'); // 環境に応じたURIが表示される
}
```

---

`DeviceInfoPlugin` を活用してデバッグ環境を推測し、環境ごとに適切な`localhost`設定を行うこの方法は、より柔軟に動作するコードを実現できます。

---
