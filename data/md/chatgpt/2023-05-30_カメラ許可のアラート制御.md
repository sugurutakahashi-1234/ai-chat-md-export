# カメラ許可のアラート制御

日付: 2023-05-30

---

## 👤 ユーザー
*2023/05/30 10:46:18*

SwiftUIでカメラの許諾の実装をしようとしているが、一度不許可を行なったユーザーに対して、2回目のアラートを出すことができるのか？

---

## 🤖 アシスタント
*2023/05/30 10:47:05*

SwiftUIでは、カメラアクセスを要求し、その許可がユーザーから拒否された場合、再度許可を求める機能は基本的に提供されていません。一度許可が拒否されると、その後の許可はユーザーがデバイスの設定を手動で変更する必要があります。

ただし、ユーザーに対してアラートを出し、設定を変更するよう指導することは可能です。以下のコードは、そのようなアラートを出す一例です：

```swift
import SwiftUI
import AVFoundation

struct ContentView: View {
    @State private var showCameraAlert = false
    
    var body: some View {
        VStack {
            // Your other UI elements
            
            Button(action: {
                let cameraAuthorizationStatus = AVCaptureDevice.authorizationStatus(for: .video)
                
                switch cameraAuthorizationStatus {
                case .notDetermined:
                    // Request access
                    AVCaptureDevice.requestAccess(for: .video) { granted in
                        if !granted {
                            self.showCameraAlert = true
                        }
                    }
                case .restricted, .denied:
                    // Alert user to change in Settings app
                    self.showCameraAlert = true
                default:
                    // Access is granted
                    break
                }
                
            }) {
                Text("Use Camera")
            }
            .alert(isPresented: $showCameraAlert) {
                Alert(title: Text("Camera Access Required"), message: Text("Please enable camera access in your device settings."), primaryButton: .default(Text("Settings"), action: {
                    // Open Settings app
                    if let url = URL(string: UIApplication.openSettingsURLString) {
                        UIApplication.shared.open(url)
                    }
                }), secondaryButton: .cancel())
            }
        }
    }
}
```

このコードでは、「Use Camera」というボタンをクリックすると、カメラへのアクセス許可をチェックします。許可がまだ決まっていない、あるいは許可が拒否されていた場合、アラートが表示されます。アラートの「Settings」ボタンをクリックすると、ユーザーはデバイスの設定画面に移動します。そこで、ユーザーは手動でカメラへのアクセスを許可できます。

ただし、アプリの中から直接設定を変更することはできません。そのため、ユーザーが設定を変更せずにアプリに戻った場合、引き続きカメラへのアクセスは許可されません。

---

## 👤 ユーザー
*2023/05/30 10:50:05*

1回しか表示されないことの公式ドキュメントがあれば教えて欲しい

---

## 🤖 アシスタント
*2023/05/30 10:50:31*

Appleの公式ドキュメントでは、プライバシー関連のパーミッションについて以下のように説明しています：

&gt; Important: In addition to providing the above usage descriptions, an app linked on or after iOS 10.0, and that accesses the device’s camera, must statically declare the intent to do so. Include the NSCameraUsageDescription key in your app’s Info.plist file and provide a purpose string for this key. If your app attempts to access the device’s camera without a corresponding purpose string, your app exits.

ここからはっきりとは示されていませんが、一度カメラアクセスが拒否されると、その後アプリが再度許可を求めることはできない、という解釈が一般的です。そのため、通常は設定画面へ誘導し、ユーザー自身に許可を変更してもらうという流れになります。

Appleの公式ドキュメントはこれ以上具体的な表現を提供していませんが、開発者コミュニティでは、この理解が一般的に共有されています。具体的なガイドラインや明確な記述を探しても、残念ながら存在しません。しかし、実際の開発経験から言って、これがiOSの動作の現状です。

---

## 👤 ユーザー
*2023/05/30 10:51:51*

設定画面でカメラをONした場合にViewがそれを検知して表示を変えることは可能なの？

---

## 🤖 アシスタント
*2023/05/30 10:52:40*

一部のパーミッションの変更についてはアプリが検知することができますが、アプリがバックグラウンドにある間に設定が変更されると、それを検知する方法は限られています。具体的には、アプリが再びフォアグラウンドになったときに再度確認することになります。

SwiftUIでは、`@State`と`@Binding`のようなプロパティラッパーを使用して状態を管理することで、設定の変更を監視し、それに基づいてUIを更新することが可能です。そのため、カメラのパーミッションが変更されたことを反映するためには、アプリがフォアグラウンドになるたびに（または、ユーザーが特定の操作を行うたびに）パーミッションを再チェックするようなロジックを実装する必要があります。

以下は、アプリがフォアグラウンドになるたびにカメラのパーミッションをチェックする一例です：

```swift
import SwiftUI
import AVFoundation

struct ContentView: View {
    @State private var hasCameraPermission = false
    
    let notificationCenter = NotificationCenter.default
    let publisher = NotificationCenter.default.publisher(for: UIApplication.willEnterForegroundNotification)
    
    var body: some View {
        VStack {
            // Your other UI elements
            
            Button(action: {
                checkCameraPermission()
            }) {
                Text(hasCameraPermission ? "Camera Access Granted" : "Camera Access Denied")
            }
            .onReceive(publisher) { _ in
                checkCameraPermission()
            }
        }
    }
    
    func checkCameraPermission() {
        let cameraAuthorizationStatus = AVCaptureDevice.authorizationStatus(for: .video)
        
        switch cameraAuthorizationStatus {
        case .authorized:
            // Access is granted
            self.hasCameraPermission = true
        default:
            // Access is denied
            self.hasCameraPermission = false
        }
    }
}
```

このコードでは、アプリがフォアグラウンドに入るたびに（または、「Check Camera Access」ボタンがクリックされるたびに）、カメラへのアクセス許可を再チェックします。その結果に基づいて、ボタンのテキストが更新されます。

---
