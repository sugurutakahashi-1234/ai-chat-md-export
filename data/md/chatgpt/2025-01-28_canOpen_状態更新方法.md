# canOpen çŠ¶æ…‹æ›´æ–°æ–¹æ³•

æ—¥ä»˜: 2025-01-28

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2025/1/28 15:05:15*

canOpenã®æ›´æ–°ã‚’useEffectã¨ã‹ã§ã‚„ã‚ŠãŸã„

import 'package:flutter/material.dart';
import 'package:geolocator/geolocator.dart';
import 'package:go\_router/go\_router.dart';
import 'package:google\_maps\_flutter/google\_maps\_flutter.dart';
import 'package:hooks\_riverpod/hooks\_riverpod.dart';
import 'package:snpit\_guild\_app/domain/design/color\_pallet.dart';
import 'package:snpit\_guild\_app/infrastructure/snapit\_guild\_api/snapit\_guild\_api.openapi.dart';
import 'package:snpit\_guild\_app/presentation/providers/api\_client/item\_boxes/open\_item\_box.dart';
import 'package:snpit\_guild\_app/presentation/providers/current\_location.dart';
import 'package:snpit\_guild\_app/presentation/widgets/cancel\_button.dart';
import 'package:snpit\_guild\_app/presentation/widgets/dialogs/item\_get\_dialog.dart';
import 'package:snpit\_guild\_app/presentation/widgets/square\_image.dart';
import 'package:snpit\_guild\_app/utils/snack\_bar\_utils.dart';

class ItemBoxDialog extends HookConsumerWidget {
  const ItemBoxDialog({
    super.key,
    required this.itemBox,
  });

  final ItemBoxDTO itemBox;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    double calculateDistance(LatLng start, LatLng end) {
      final distance = Geolocator.distanceBetween(
        start.latitude,
        start.longitude,
        end.latitude,
        end.longitude,
      );

      debugPrint('Distance: $distance');

      return distance;
    }

    final currentLocation = ref.watch(currentLocationNotifierProvider);
    final canOpen = currentLocation.when(
      data: (location) {
        final distance = calculateDistance(
          location,
          LatLng(
            itemBox.itemBoxLatitude?.toDouble() ?? 0,
            itemBox.itemBoxLongitude?.toDouble() ?? 0,
          ),
        );
        return distance &lt;=  100;
      },
      loading: () =&gt; false,
      error: (\_, \_\_) =&gt; false,
    );

    Future&lt;void&gt; onTapOpenBox() async {
      try {
        final currentLocation = await ref
            .watch(currentLocationNotifierProvider.notifier)
            .getCurrentLocation();

        final itemBoxId = itemBox.itemBoxId;
        if (itemBoxId == null) {
          throw Exception('ItemBoxId is null');
        }
        final itemList = await ref
            .read(openItemBoxNotifierProvider.notifier)
            .openItemBox(itemBoxId, currentLocation);

        if (context.mounted) {
          context.pop();
        }

        if (context.mounted) {
          await showDialog&lt;void&gt;(
            context: context,
            builder: (BuildContext context) {
              return ItemGetDialog(
                itemList: itemList,
              );
            },
          );
        }
      } on Exception catch (error) {
        if (context.mounted) {
          showErrorSnackBar(context, error);
        }
      }
    }

    return Dialog(
      backgroundColor: ColorPallet.gray800,
      child: Container(
        padding: const EdgeInsets.all(24),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: \[
            Text(
              itemBox.itemBoxName ?? '',
              style: const TextStyle(
                fontWeight: FontWeight.bold,
                fontSize: 20,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 18),
            Text(
              itemBox.itemBoxDescription ?? '',
              style: const TextStyle(
                fontSize: 16,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 32),
            ClipRRect(
              borderRadius: BorderRadius.circular(4),
              child: SquareImage(
                imageUrl: itemBox.itemBoxImage ?? '',
                size: 160,
              ),
            ),
            const SizedBox(height: 24),
            Container(
              padding: const EdgeInsets.symmetric(
                horizontal: 12,
                vertical: 8,
              ),
              decoration: BoxDecoration(
                color: const Color(0xFF14191A),
                borderRadius: BorderRadius.circular(50),
              ),
              child: const Text(
                // TODO: \[ItemBox\] ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒ¼ã®è¿½åŠ 
                'Uncommon',
                style: TextStyle(
                  fontSize: 14,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
            const SizedBox(height: 32),
            ElevatedButton(
              onPressed: canOpen
                  ? () async {
                      await onTapOpenBox();
                    }
                  : null,
              child: const Text(
                'Open Box',
              ),
            ),
            if (!canOpen) ...\[
              const SizedBox(height: 16),
              const Text(
                'You cannot open it unless you get within 100m.',
                textAlign: TextAlign.center,
              ),
            \],
            const SizedBox(height: 32),
            CancelButton(
              onTapCancel: () async {
                context.pop();
              },
            ),
          \],
        ),
      ),
    );
  }
}

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2025/1/28 15:05:29*

`canOpen` ã®çŠ¶æ…‹ã‚’ `useEffect` ã®ã‚ˆã†ã«æ›´æ–°ã—ãŸã„å ´åˆã€Flutterã§ã¯ `useEffect` ã®ä»£ã‚ã‚Šã«ã€`useState` ã¨ `useEffect` ã®ã‚ˆã†ãªæ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ `useEffect` çš„ãªãƒ•ãƒƒã‚¯ã¨ã—ã¦ `useEffect` ã¨çŠ¶æ…‹ç®¡ç†ã‚’çµ„ã¿åˆã‚ã›ãŸ `useState` ãƒ•ãƒƒã‚¯ã‚’åˆ©ç”¨ã§ãã¾ã™ã€‚

ä»¥ä¸‹ã¯ã€`canOpen` ã‚’ `useEffect` ã®ã‚ˆã†ã«æ›´æ–°ã™ã‚‹æ–¹æ³•ã®å®Ÿè£…ä¾‹ã§ã™ï¼š

### å®Ÿè£…

```dart
@override
Widget build(BuildContext context, WidgetRef ref) {
  final currentLocation = ref.watch(currentLocationNotifierProvider);
  final canOpenState = useState(false);

  useEffect(() {
    void updateCanOpen() {
      if (currentLocation is AsyncData) {
        final location = currentLocation.value;
        final distance = calculateDistance(
          location,
          LatLng(
            itemBox.itemBoxLatitude?.toDouble() ?? 0,
            itemBox.itemBoxLongitude?.toDouble() ?? 0,
          ),
        );
        canOpenState.value = distance <= 100;
      } else {
        canOpenState.value = false;
      }
    }

    updateCanOpen();

    // currentLocation ãŒå¤‰ã‚ã‚‹ãŸã³ã«å†è©•ä¾¡
    return ref.listen<AsyncValue<LatLng>>(
      currentLocationNotifierProvider,
      (_, __) => updateCanOpen(),
    ).cancel;
  }, [currentLocation]);

  Future<void> onTapOpenBox() async {
    // ... onTapOpenBoxã®å†…å®¹ã¯ãã®ã¾ã¾ ...
  }

  return Dialog(
    backgroundColor: ColorPallet.gray800,
    child: Container(
      padding: const EdgeInsets.all(24),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          Text(
            itemBox.itemBoxName ?? '',
            style: const TextStyle(
              fontWeight: FontWeight.bold,
              fontSize: 20,
            ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 18),
          Text(
            itemBox.itemBoxDescription ?? '',
            style: const TextStyle(
              fontSize: 16,
            ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 32),
          ClipRRect(
            borderRadius: BorderRadius.circular(4),
            child: SquareImage(
              imageUrl: itemBox.itemBoxImage ?? '',
              size: 160,
            ),
          ),
          const SizedBox(height: 24),
          Container(
            padding: const EdgeInsets.symmetric(
              horizontal: 12,
              vertical: 8,
            ),
            decoration: BoxDecoration(
              color: const Color(0xFF14191A),
              borderRadius: BorderRadius.circular(50),
            ),
            child: const Text(
              'Uncommon',
              style: TextStyle(
                fontSize: 14,
                fontWeight: FontWeight.bold,
              ),
            ),
          ),
          const SizedBox(height: 32),
          ElevatedButton(
            onPressed: canOpenState.value
                ? () async {
                    await onTapOpenBox();
                  }
                : null,
            child: const Text(
              'Open Box',
            ),
          ),
          if (!canOpenState.value) ...[
            const SizedBox(height: 16),
            const Text(
              'You cannot open it unless you get within 100m.',
              textAlign: TextAlign.center,
            ),
          ],
          const SizedBox(height: 32),
          CancelButton(
            onTapCancel: () async {
              context.pop();
            },
          ),
        ],
      ),
    ),
  );
}
```

### å¤‰æ›´ç‚¹
1. **`useState` ãƒ•ãƒƒã‚¯ã‚’è¿½åŠ **
   - `canOpenState` ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã« `useState<bool>` ã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚

2. **`useEffect` ãƒ•ãƒƒã‚¯ã®å®Ÿè£…**
   - `useEffect` ã«ç›¸å½“ã™ã‚‹ç®‡æ‰€ã§ `currentLocation` ã®çŠ¶æ…‹ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã« `canOpen` ã‚’å†è¨ˆç®—ã—ã€`canOpenState.value` ã‚’æ›´æ–°ã—ã¾ã™ã€‚

3. **`canOpen` ã®è¨ˆç®—ã‚’ãƒªã‚¹ãƒŠãƒ¼ã§æ›´æ–°**
   - `ref.listen` ã‚’åˆ©ç”¨ã—ã¦ã€`currentLocation` ãŒå¤‰æ›´ã•ã‚ŒãŸéš›ã« `updateCanOpen` ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

### ãƒ¡ãƒªãƒƒãƒˆ
- çŠ¶æ…‹ç®¡ç†ãŒç°¡å˜ã«ãªã‚Šã€çŠ¶æ…‹å¤‰æ›´ã®è¿½è·¡ãŒå®¹æ˜“ã€‚
- ç¾åœ¨ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«ä¿ã¡ãªãŒã‚‰ã€`canOpen` ã‚’ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«æ›´æ–°ã§ãã¾ã™ã€‚

---
