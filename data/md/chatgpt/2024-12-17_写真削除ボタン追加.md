# å†™çœŸå‰Šé™¤ãƒœã‚¿ãƒ³è¿½åŠ 

æ—¥ä»˜: 2024-12-17

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/12/17 17:24:37*

å†™çœŸã‚’å‰Šé™¤ã™ã‚‹ãƒœã‚¿ãƒ³ã‚’ã¤ã‘ã¦æ¬²ã—ã„

import 'dart:io';

import 'package:flutter/material.dart';
import 'package:flutter_hooks/flutter_hooks.dart';
import 'package:go_router/go_router.dart';
import 'package:image_picker/image_picker.dart';
import 'package:permission_handler/permission_handler.dart';

class GuildCreatePage extends HookWidget {
  const GuildCreatePage({super.key});

  @override
  Widget build(BuildContext context) {
    final imageFile = useState&lt;File?&gt;(null);
    final picker = useMemoized(ImagePicker.new);

    /// å†™çœŸã‚’é¸æŠ
    Future&lt;void&gt; pickImage() async {
      final pickedFile = await picker.pickImage(source: ImageSource.gallery);

      if (pickedFile != null) {
        imageFile.value = File(pickedFile.path);
      } else {
        debugPrint('ç”»åƒé¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
      }
    }

    return Scaffold(
      appBar: AppBar(title: const Text('GuildCreatePage')),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            imageFile.value != null
                ? Image.file(imageFile.value!, height: 300, fit: BoxFit.cover)
                : const Text('ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“'),
            const SizedBox(height: 20),
            ElevatedButton(
              onPressed: () async {
                final status = await _checkPhotoPermission(context);
                if (status == PermissionStatus.granted) {
                  await pickImage();
                }
              },
              child: const Text('ã‚®ãƒ«ãƒ‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’é¸æŠ'),
            ),
            ElevatedButton(
              onPressed: () {
                context.pop();
              },
              child: const Text('Create'),
            ),
          ],
        ),
      ),
    );
  }

  /// å†™çœŸã®æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
  Future&lt;PermissionStatus&gt; _checkPhotoPermission(BuildContext context) async {
    final status = await Permission.photos.request();

    if (status.isGranted) {
      // è¨±å¯æ¸ˆã¿ã®å ´åˆ
      return status;
    } else if (status.isPermanentlyDenied) {
      // æ°¸ä¹…ã«æ‹’å¦ã•ã‚Œã¦ã„ã‚‹å ´åˆ
      if (context.mounted) {
        _showPermissionDialog(context);
      }
    } else {
      // ãã®ä»–ã®ã‚±ãƒ¼ã‚¹ï¼ˆæ‹’å¦ã•ã‚ŒãŸå ´åˆï¼‰
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('å†™çœŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚')),
        );
      }
    }
    return status;
  }

  /// è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
  void _showPermissionDialog(BuildContext context) {
    showDialog&lt;void&gt;(
      context: context,
      builder: (context) =&gt; AlertDialog(
        title: const Text('å†™çœŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦ã§ã™'),
        content: const Text('å†™çœŸã‚’é¸æŠã™ã‚‹ã«ã¯ã€è¨­å®šã§å†™çœŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„ã€‚'),
        actions: [
          TextButton(
            onPressed: () {
              Navigator.of(context).pop();
            },
            child: const Text('ã‚­ãƒ£ãƒ³ã‚»ãƒ«'),
          ),
          TextButton(
            onPressed: () async {
              await openAppSettings(); // ã‚¢ãƒ—ãƒªã®è¨­å®šç”»é¢ã‚’é–‹ã
            },
            child: const Text('è¨­å®šã‚’é–‹ã'),
          ),
        ],
      ),
    );
  }
}

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/12/17 17:24:49*

å†™çœŸã‚’å‰Šé™¤ã™ã‚‹ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã« `imageFile` ã®çŠ¶æ…‹ã‚’ `null` ã«ãƒªã‚»ãƒƒãƒˆã™ã‚‹å‡¦ç†ã‚’è¿½åŠ ã—ã¾ã™ã€‚`ElevatedButton` ã‚’æ–°ãŸã«è¿½åŠ ã—ã¦ã€å†™çœŸãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã¨ãã ã‘è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

### ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰
```dart
import 'dart:io';

import 'package:flutter/material.dart';
import 'package:flutter_hooks/flutter_hooks.dart';
import 'package:go_router/go_router.dart';
import 'package:image_picker/image_picker.dart';
import 'package:permission_handler/permission_handler.dart';

class GuildCreatePage extends HookWidget {
  const GuildCreatePage({super.key});

  @override
  Widget build(BuildContext context) {
    final imageFile = useState<File?>(null);
    final picker = useMemoized(ImagePicker.new);

    /// å†™çœŸã‚’é¸æŠ
    Future<void> pickImage() async {
      final pickedFile = await picker.pickImage(source: ImageSource.gallery);

      if (pickedFile != null) {
        imageFile.value = File(pickedFile.path);
      } else {
        debugPrint('ç”»åƒé¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
      }
    }

    /// å†™çœŸã‚’å‰Šé™¤
    void deleteImage() {
      imageFile.value = null;
      debugPrint('ç”»åƒãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
    }

    return Scaffold(
      appBar: AppBar(title: const Text('GuildCreatePage')),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            imageFile.value != null
                ? Column(
                    children: [
                      Image.file(imageFile.value!, height: 300, fit: BoxFit.cover),
                      const SizedBox(height: 10),
                      ElevatedButton(
                        onPressed: deleteImage,
                        child: const Text('ç”»åƒã‚’å‰Šé™¤'),
                      ),
                    ],
                  )
                : const Text('ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“'),
            const SizedBox(height: 20),
            ElevatedButton(
              onPressed: () async {
                final status = await _checkPhotoPermission(context);
                if (status == PermissionStatus.granted) {
                  await pickImage();
                }
              },
              child: const Text('ã‚®ãƒ«ãƒ‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’é¸æŠ'),
            ),
            ElevatedButton(
              onPressed: () {
                context.pop();
              },
              child: const Text('Create'),
            ),
          ],
        ),
      ),
    );
  }

  /// å†™çœŸã®æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
  Future<PermissionStatus> _checkPhotoPermission(BuildContext context) async {
    final status = await Permission.photos.request();

    if (status.isGranted) {
      // è¨±å¯æ¸ˆã¿ã®å ´åˆ
      return status;
    } else if (status.isPermanentlyDenied) {
      // æ°¸ä¹…ã«æ‹’å¦ã•ã‚Œã¦ã„ã‚‹å ´åˆ
      if (context.mounted) {
        _showPermissionDialog(context);
      }
    } else {
      // ãã®ä»–ã®ã‚±ãƒ¼ã‚¹ï¼ˆæ‹’å¦ã•ã‚ŒãŸå ´åˆï¼‰
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('å†™çœŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚')),
        );
      }
    }
    return status;
  }

  /// è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
  void _showPermissionDialog(BuildContext context) {
    showDialog<void>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('å†™çœŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦ã§ã™'),
        content: const Text('å†™çœŸã‚’é¸æŠã™ã‚‹ã«ã¯ã€è¨­å®šã§å†™çœŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„ã€‚'),
        actions: [
          TextButton(
            onPressed: () {
              Navigator.of(context).pop();
            },
            child: const Text('ã‚­ãƒ£ãƒ³ã‚»ãƒ«'),
          ),
          TextButton(
            onPressed: () async {
              await openAppSettings(); // ã‚¢ãƒ—ãƒªã®è¨­å®šç”»é¢ã‚’é–‹ã
            },
            child: const Text('è¨­å®šã‚’é–‹ã'),
          ),
        ],
      ),
    );
  }
}
```

### è¿½åŠ å†…å®¹
1. **`deleteImage` é–¢æ•°**  
   `imageFile.value` ã‚’ `null` ã«ãƒªã‚»ãƒƒãƒˆã—ã€ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

2. **ã€Œç”»åƒã‚’å‰Šé™¤ã€ãƒœã‚¿ãƒ³**  
   - ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã«ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚  
   - ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ `deleteImage` é–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã™ã€‚

---

ã“ã‚Œã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç”»åƒã‚’å‰Šé™¤ã™ã‚‹ãƒœã‚¿ãƒ³ã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼

---
