# ローディングエラー修正

日付: 2024-12-13

---

## 👤 ユーザー
*2024/12/13 16:16:43*

loadingBuilder のところや error のところの実装が間違っている気がする。
ローディング中の描画がでないんだ。

import 'package:flutter/material.dart';
import 'package:go\_router/go\_router.dart';
import 'package:snpit\_guild\_app/domain/screen.dart';
import 'package:snpit\_guild\_app/utils/extensions/uri\_extensions.dart';

class SpotListPage extends StatelessWidget {
  const SpotListPage({super.key});

  @override
  Widget build(BuildContext context) {
    final spotList = List.generate(
      12,
      (index) =&gt; {
        'imageUrl': UriExtensions.randomImageUrl.toString(),
        'label': String.fromCharCode(65 + index),
      },
    );

    return Scaffold(
      appBar: AppBar(
        automaticallyImplyLeading: false,
        title: const Text('Spot list'),
        actions: \[
          IconButton(
            icon: const Icon(Icons.close),
            onPressed: () {
              // ボトムシート全体を閉じる
              Navigator.of(context, rootNavigator: true).pop();
            },
          ),
        \],
      ),
      body: GridView.builder(
        padding: const EdgeInsets.all(16),
        gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
          crossAxisCount: 3,
          crossAxisSpacing: 8,
          mainAxisSpacing: 8,
        ),
        itemCount: spotList.length,
        itemBuilder: (context, index) {
          final spot = spotList\[index\];
          final imageUrl = spot\['imageUrl'\]!;
          final label = spot\['label'\]!;

          return GestureDetector(
            onTap: () {
              context.push(Screen.spotDetail.path);
            },
            child: Stack(
              alignment: Alignment.bottomCenter,
              children: \[
                Container(
                  color: Colors.grey\[200\],
                  child: ClipRRect(
                    borderRadius: BorderRadius.circular(8),
                    child: Image.network(
                      imageUrl,
                      fit: BoxFit.cover,
                      width: double.infinity,
                      height: double.infinity,
                      loadingBuilder: (context, child, loadingProgress) {
                        if (loadingProgress == null) {
                          return child;
                        }
                        return const Center(
                          child: CircularProgressIndicator(),
                        );
                      },
                      errorBuilder: (context, error, stackTrace) {
                        return const Center(
                          child: Icon(Icons.error, color: Colors.red),
                        );
                      },
                    ),
                  ),
                ),
                Positioned(
                  top: 8,
                  left: 8,
                  child: Container(
                    padding:
                        const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                    decoration: BoxDecoration(
                      color: Colors.black.withOpacity(0.5),
                      borderRadius: BorderRadius.circular(4),
                    ),
                    child: Text(
                      label,
                      style: const TextStyle(color: Colors.white, fontSize: 12),
                    ),
                  ),
                ),
              \],
            ),
          );
        },
      ),
    );
  }
}

---

## 🤖 アシスタント
*2024/12/13 16:17:01*

`loadingBuilder` や `errorBuilder` の実装は一見正しく見えますが、以下の点を確認することで問題が解消する可能性があります。

### 1. **ローディング中の描画が出ない理由**
- **ローディング状態の検出**  
  `loadingBuilder` 内で `loadingProgress` を適切に処理しているか確認します。`loadingProgress` が `null` の場合は画像の読み込みが完了しているため、`CircularProgressIndicator` が表示されません。

- **ネットワークの問題**  
  `UriExtensions.randomImageUrl` が正しい URL を返しているか確認してください。不正な URL を生成している場合、`loadingBuilder` は呼び出されずに直接 `errorBuilder` に飛ぶ可能性があります。

### 修正例
以下のように `loadingBuilder` を改善します。`loadingProgress` の `expectedTotalBytes` や `cumulativeBytesLoaded` を使用して、進捗状況に基づくローディング UI を表示できます。

```dart
loadingBuilder: (context, child, loadingProgress) {
  if (loadingProgress == null) {
    return child;
  }
  return Center(
    child: CircularProgressIndicator(
      value: loadingProgress.expectedTotalBytes != null
          ? loadingProgress.cumulativeBytesLoaded /
              (loadingProgress.expectedTotalBytes ?? 1)
          : null,
    ),
  );
},
```

### 2. **エラー描画の問題**
- `errorBuilder` は通常正しく動作しますが、エラーメッセージをカスタマイズする場合は `error` と `stackTrace` をデバッグに役立てられるようにします。

```dart
errorBuilder: (context, error, stackTrace) {
  debugPrint('Image loading error: $error');
  return const Center(
    child: Icon(Icons.error, color: Colors.red),
  );
},
```

### 3. **`UriExtensions.randomImageUrl` の動作確認**
`UriExtensions.randomImageUrl` が正しい画像 URL を生成しているか確認してください。`toString()` の呼び出しに問題がある場合、以下のようにデバッグして確認します。

```dart
final imageUrl = UriExtensions.randomImageUrl.toString();
debugPrint('Generated imageUrl: $imageUrl');
```

### 4. **画像サイズの指定**
`Image.network` を使用する場合、`width` と `height` が親コンテナに依存するため、`double.infinity` が正しく解釈されていない可能性があります。`BoxConstraints` を確認し、サイズが意図通りか確かめます。

修正後の動作を確認して、問題が解消されるか試してください。それでも解決しない場合、生成される画像 URL やデバッグログを元にさらに調査する必要があります。

---
