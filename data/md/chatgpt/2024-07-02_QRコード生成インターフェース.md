# QRコード生成インターフェース

日付: 2024-07-02

---

## 👤 ユーザー
*2024/07/02 15:32:21*

画像を埋め込まないようなインターフェースも用意してほしい

import CoreImage.CIFilterBuiltins
import Foundation
import SwiftUI

public final class QRCodeDriver: QRCodeDriverProtocol {
    public init() {
        OSLogger.initLog()
    }

    deinit {
        OSLogger.deinitLog()
    }

    public func generateQRCode(text: String, correctionLevel: QRCorrectionLevel = .high) throws -&gt; UIImage {
        guard let data = text.data(using: .utf8) else {
            throw QRCodeGenerationError.dataConversionFailed
        }

        let filter = CIFilter.qrCodeGenerator()
        filter.setValue(data, forKey: Constants.QRCodeKey.inputMessage)
        filter.setValue(correctionLevel.rawValue, forKey: Constants.QRCodeKey.inputCorrectionLevel)

        guard let ciImage = filter.outputImage else {
            throw QRCodeGenerationError.qrCodeGenerationFailed
        }

        return try convertCIImageToImage(ciImage: ciImage)
    }

    /// image converter みたいな Driver を設置しても良いかも
    /// 変換は Image 型でもよいがカメラロールへの保存を考慮すると UIImage 型の方が都合が良い
    private func convertCIImageToImage(ciImage: CIImage) throws -&gt; UIImage {
        // CIImageは小さい為、任意のサイズに拡大
        let sizeTransform = CGAffineTransform(scaleX: 10, y: 10)
        let scaledCiImage = ciImage.transformed(by: sizeTransform)
        let context = CIContext()
        guard let cgImage: CGImage = context.createCGImage(scaledCiImage, from: scaledCiImage.extent), let appIcon = Bundle.main.appIcon else {
            OSLogger.errorLog()
            throw AppError.customError()
        }
        return UIImage(cgImage: cgImage).composited(withSmallCenterImage: appIcon)
    }
}

private extension Bundle {
    // Ref: How to get the current application icon in ios - https://stackoverflow.com/questions/9419261/how-to-get-the-current-application-icon-in-ios
    var appIcon: UIImage? {
        if let icons = infoDictionary?["CFBundleIcons"] as? [String: Any],
           let primaryIcon = icons["CFBundlePrimaryIcon"] as? [String: Any],
           let iconFiles = primaryIcon["CFBundleIconFiles"] as? [String],
           let lastIcon = iconFiles.last
        {
            return UIImage(named: lastIcon)
        }
        return nil
    }
}

private extension UIImage {
    // Ref: 【SwiftUI】QRコードを生成して、中心に可愛いアイコンを付ける方法 - https://dev.classmethod.jp/articles/swift-generate-qr-code/
    func composited(withSmallCenterImage centerImage: UIImage) -&gt; UIImage {
        UIGraphicsImageRenderer(size: size).image { context in
            let imageWidth = context.format.bounds.width
            let imageHeight = context.format.bounds.height
            let centerImageLength = imageWidth &lt; imageHeight ? imageWidth / 5 : imageHeight / 5
            let centerImageRadius = centerImageLength * 0.2

            // 背面に設置する親画像を描画
            draw(in: CGRect(origin: CGPoint(x: 0, y: 0),
                            size: context.format.bounds.size))

            // 中心に設置する画像のrectを設定
            let centerImageRect = CGRect(x: (imageWidth - centerImageLength) / 2,
                                         y: (imageHeight - centerImageLength) / 2,
                                         width: centerImageLength,
                                         height: centerImageLength)

            // 画像に角丸をつける為のパスを作成
            let roundedRectPath = UIBezierPath(roundedRect: centerImageRect,
                                               cornerRadius: centerImageRadius)
            // クリッピングパスを追加
            roundedRectPath.addClip()

            // 中心に設置する画像を描画
            centerImage.draw(in: centerImageRect)
        }
    }
}

---

## 🤖 アシスタント
*2024/07/02 15:32:44*

以下は、SwiftUIで画像を埋め込まないインターフェースを提供するための例です。この例では、QRコードを生成し、そのQRコードのCIImageを直接使用してImageビューに表示します。

```swift
import CoreImage.CIFilterBuiltins
import Foundation
import SwiftUI

public final class QRCodeDriver: QRCodeDriverProtocol {
    public init() {
        OSLogger.initLog()
    }

    deinit {
        OSLogger.deinitLog()
    }

    public func generateQRCode(text: String, correctionLevel: QRCorrectionLevel = .high) throws -> CIImage {
        guard let data = text.data(using: .utf8) else {
            throw QRCodeGenerationError.dataConversionFailed
        }

        let filter = CIFilter.qrCodeGenerator()
        filter.setValue(data, forKey: Constants.QRCodeKey.inputMessage)
        filter.setValue(correctionLevel.rawValue, forKey: Constants.QRCodeKey.inputCorrectionLevel)

        guard let ciImage = filter.outputImage else {
            throw QRCodeGenerationError.qrCodeGenerationFailed
        }

        return ciImage.transformed(by: CGAffineTransform(scaleX: 10, y: 10))
    }
}

struct QRCodeView: View {
    let qrCodeDriver = QRCodeDriver()
    @State private var qrCodeImage: CIImage?

    var body: some View {
        VStack {
            if let qrCodeImage = qrCodeImage {
                Image(uiImage: UIImage(ciImage: qrCodeImage))
                    .resizable()
                    .interpolation(.none)
                    .scaledToFit()
                    .frame(width: 200, height: 200)
            } else {
                Text("QRコードを生成してください")
            }

            Button(action: generateQRCode) {
                Text("QRコードを生成")
            }
        }
        .padding()
    }

    private func generateQRCode() {
        do {
            let qrCode = try qrCodeDriver.generateQRCode(text: "https://example.com")
            qrCodeImage = qrCode
        } catch {
            print("QRコードの生成に失敗しました: \(error)")
        }
    }
}
```

このコードでは、`QRCodeDriver`クラスはQRコードを`CIImage`形式で生成し、`QRCodeView`はこの`CIImage`を使用してSwiftUIの`Image`ビューにQRコードを表示します。こうすることで、画像を埋め込むことなく、QRコードをインターフェースに表示できます。

---

## 👤 ユーザー
*2024/07/02 15:35:14*

public func generateQRCode(text: String, correctionLevel: QRCorrectionLevel = .high) throws -&gt; UIImage  にしてほしい

---

## 🤖 アシスタント
*2024/07/02 15:35:43*

了解しました。以下は、`generateQRCode` メソッドが `UIImage` を返すように修正したコードです。

```swift
import CoreImage.CIFilterBuiltins
import Foundation
import SwiftUI

public final class QRCodeDriver: QRCodeDriverProtocol {
    public init() {
        OSLogger.initLog()
    }

    deinit {
        OSLogger.deinitLog()
    }

    public func generateQRCode(text: String, correctionLevel: QRCorrectionLevel = .high) throws -> UIImage {
        guard let data = text.data(using: .utf8) else {
            throw QRCodeGenerationError.dataConversionFailed
        }

        let filter = CIFilter.qrCodeGenerator()
        filter.setValue(data, forKey: Constants.QRCodeKey.inputMessage)
        filter.setValue(correctionLevel.rawValue, forKey: Constants.QRCodeKey.inputCorrectionLevel)

        guard let ciImage = filter.outputImage else {
            throw QRCodeGenerationError.qrCodeGenerationFailed
        }

        return try convertCIImageToImage(ciImage: ciImage)
    }

    private func convertCIImageToImage(ciImage: CIImage) throws -> UIImage {
        let sizeTransform = CGAffineTransform(scaleX: 10, y: 10)
        let scaledCiImage = ciImage.transformed(by: sizeTransform)
        let context = CIContext()
        guard let cgImage: CGImage = context.createCGImage(scaledCiImage, from: scaledCiImage.extent) else {
            OSLogger.errorLog()
            throw QRCodeGenerationError.qrCodeGenerationFailed
        }
        return UIImage(cgImage: cgImage)
    }
}

struct QRCodeView: View {
    let qrCodeDriver = QRCodeDriver()
    @State private var qrCodeImage: UIImage?

    var body: some View {
        VStack {
            if let qrCodeImage = qrCodeImage {
                Image(uiImage: qrCodeImage)
                    .resizable()
                    .interpolation(.none)
                    .scaledToFit()
                    .frame(width: 200, height: 200)
            } else {
                Text("QRコードを生成してください")
            }

            Button(action: generateQRCode) {
                Text("QRコードを生成")
            }
        }
        .padding()
    }

    private func generateQRCode() {
        do {
            let qrCode = try qrCodeDriver.generateQRCode(text: "https://example.com")
            qrCodeImage = qrCode
        } catch {
            print("QRコードの生成に失敗しました: \(error)")
        }
    }
}
```

このコードでは、`QRCodeDriver` の `generateQRCode` メソッドが `UIImage` を返すように変更されました。これにより、生成された QR コードを SwiftUI の `Image` ビューに表示することができます。

---

## 👤 ユーザー
*2024/07/02 15:36:19*

この2つのインターフェースを残したいんだ

public func generateCompositedAppIconQRCode(text: String, correctionLevel: QRCorrectionLevel = .high) throws -&gt; UIImage

public func generateQRCode(text: String, correctionLevel: QRCorrectionLevel = .high) throws -&gt; UIImage

---

## 🤖 アシスタント
*2024/07/02 15:37:11*

2つのインターフェースを維持しつつ、それぞれのメソッドを実装するためのコードを以下に示します。

```swift
import CoreImage.CIFilterBuiltins
import Foundation
import SwiftUI

public final class QRCodeDriver: QRCodeDriverProtocol {
    public init() {
        OSLogger.initLog()
    }

    deinit {
        OSLogger.deinitLog()
    }

    public func generateQRCode(text: String, correctionLevel: QRCorrectionLevel = .high) throws -> UIImage {
        guard let data = text.data(using: .utf8) else {
            throw QRCodeGenerationError.dataConversionFailed
        }

        let filter = CIFilter.qrCodeGenerator()
        filter.setValue(data, forKey: Constants.QRCodeKey.inputMessage)
        filter.setValue(correctionLevel.rawValue, forKey: Constants.QRCodeKey.inputCorrectionLevel)

        guard let ciImage = filter.outputImage else {
            throw QRCodeGenerationError.qrCodeGenerationFailed
        }

        return try convertCIImageToImage(ciImage: ciImage)
    }

    public func generateCompositedAppIconQRCode(text: String, correctionLevel: QRCorrectionLevel = .high) throws -> UIImage {
        let qrCodeImage = try generateQRCode(text: text, correctionLevel: correctionLevel)
        guard let appIcon = Bundle.main.appIcon else {
            throw QRCodeGenerationError.appIconNotFound
        }
        return qrCodeImage.composited(withSmallCenterImage: appIcon)
    }

    private func convertCIImageToImage(ciImage: CIImage) throws -> UIImage {
        let sizeTransform = CGAffineTransform(scaleX: 10, y: 10)
        let scaledCiImage = ciImage.transformed(by: sizeTransform)
        let context = CIContext()
        guard let cgImage: CGImage = context.createCGImage(scaledCiImage, from: scaledCiImage.extent) else {
            OSLogger.errorLog()
            throw QRCodeGenerationError.qrCodeGenerationFailed
        }
        return UIImage(cgImage: cgImage)
    }
}

private extension Bundle {
    var appIcon: UIImage? {
        if let icons = infoDictionary?["CFBundleIcons"] as? [String: Any],
           let primaryIcon = icons["CFBundlePrimaryIcon"] as? [String: Any],
           let iconFiles = primaryIcon["CFBundleIconFiles"] as? [String],
           let lastIcon = iconFiles.last
        {
            return UIImage(named: lastIcon)
        }
        return nil
    }
}

private extension UIImage {
    func composited(withSmallCenterImage centerImage: UIImage) -> UIImage {
        UIGraphicsImageRenderer(size: size).image { context in
            let imageWidth = context.format.bounds.width
            let imageHeight = context.format.bounds.height
            let centerImageLength = imageWidth < imageHeight ? imageWidth / 5 : imageHeight / 5
            let centerImageRadius = centerImageLength * 0.2

            draw(in: CGRect(origin: CGPoint(x: 0, y: 0), size: context.format.bounds.size))

            let centerImageRect = CGRect(x: (imageWidth - centerImageLength) / 2,
                                         y: (imageHeight - centerImageLength) / 2,
                                         width: centerImageLength,
                                         height: centerImageLength)

            let roundedRectPath = UIBezierPath(roundedRect: centerImageRect, cornerRadius: centerImageRadius)
            roundedRectPath.addClip()

            centerImage.draw(in: centerImageRect)
        }
    }
}

struct QRCodeView: View {
    let qrCodeDriver = QRCodeDriver()
    @State private var qrCodeImage: UIImage?

    var body: some View {
        VStack {
            if let qrCodeImage = qrCodeImage {
                Image(uiImage: qrCodeImage)
                    .resizable()
                    .interpolation(.none)
                    .scaledToFit()
                    .frame(width: 200, height: 200)
            } else {
                Text("QRコードを生成してください")
            }

            Button(action: generateQRCode) {
                Text("QRコードを生成")
            }

            Button(action: generateCompositedQRCode) {
                Text("App Icon付きQRコードを生成")
            }
        }
        .padding()
    }

    private func generateQRCode() {
        do {
            let qrCode = try qrCodeDriver.generateQRCode(text: "https://example.com")
            qrCodeImage = qrCode
        } catch {
            print("QRコードの生成に失敗しました: \(error)")
        }
    }

    private func generateCompositedQRCode() {
        do {
            let qrCode = try qrCodeDriver.generateCompositedAppIconQRCode(text: "https://example.com")
            qrCodeImage = qrCode
        } catch {
            print("QRコードの生成に失敗しました: \(error)")
        }
    }
}
```

このコードでは、`generateQRCode` メソッドと `generateCompositedAppIconQRCode` メソッドの両方を提供し、QRコードの生成とアプリアイコンを中心に合成したQRコードの生成が可能になっています。`QRCodeView` の中で、それぞれのボタンを押すことで対応するQRコードを生成して表示します。

---
