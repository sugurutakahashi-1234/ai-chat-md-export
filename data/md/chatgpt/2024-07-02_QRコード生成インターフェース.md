# QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

æ—¥ä»˜: 2024-07-02

---

## ðŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/07/02 15:32:21*

ç”»åƒã‚’åŸ‹ã‚è¾¼ã¾ãªã„ã‚ˆã†ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚‚ç”¨æ„ã—ã¦ã»ã—ã„

import CoreImage.CIFilterBuiltins
import Foundation
import SwiftUI

public final class QRCodeDriver: QRCodeDriverProtocol {
    public init() {
        OSLogger.initLog()
    }

    deinit {
        OSLogger.deinitLog()
    }

    public func generateQRCode(text: String, correctionLevel: QRCorrectionLevel = .high) throws -&gt; UIImage {
        guard let data = text.data(using: .utf8) else {
            throw QRCodeGenerationError.dataConversionFailed
        }

        let filter = CIFilter.qrCodeGenerator()
        filter.setValue(data, forKey: Constants.QRCodeKey.inputMessage)
        filter.setValue(correctionLevel.rawValue, forKey: Constants.QRCodeKey.inputCorrectionLevel)

        guard let ciImage = filter.outputImage else {
            throw QRCodeGenerationError.qrCodeGenerationFailed
        }

        return try convertCIImageToImage(ciImage: ciImage)
    }

    /// image converter ã¿ãŸã„ãª Driver ã‚’è¨­ç½®ã—ã¦ã‚‚è‰¯ã„ã‹ã‚‚
    /// å¤‰æ›ã¯ Image åž‹ã§ã‚‚ã‚ˆã„ãŒã‚«ãƒ¡ãƒ©ãƒ­ãƒ¼ãƒ«ã¸ã®ä¿å­˜ã‚’è€ƒæ…®ã™ã‚‹ã¨ UIImage åž‹ã®æ–¹ãŒéƒ½åˆãŒè‰¯ã„
    private func convertCIImageToImage(ciImage: CIImage) throws -&gt; UIImage {
        // CIImageã¯å°ã•ã„ç‚ºã€ä»»æ„ã®ã‚µã‚¤ã‚ºã«æ‹¡å¤§
        let sizeTransform = CGAffineTransform(scaleX: 10, y: 10)
        let scaledCiImage = ciImage.transformed(by: sizeTransform)
        let context = CIContext()
        guard let cgImage: CGImage = context.createCGImage(scaledCiImage, from: scaledCiImage.extent), let appIcon = Bundle.main.appIcon else {
            OSLogger.errorLog()
            throw AppError.customError()
        }
        return UIImage(cgImage: cgImage).composited(withSmallCenterImage: appIcon)
    }
}

private extension Bundle {
    // Ref: How to get the current application icon in ios - https://stackoverflow.com/questions/9419261/how-to-get-the-current-application-icon-in-ios
    var appIcon: UIImage? {
        if let icons = infoDictionary?["CFBundleIcons"] as? [String: Any],
           let primaryIcon = icons["CFBundlePrimaryIcon"] as? [String: Any],
           let iconFiles = primaryIcon["CFBundleIconFiles"] as? [String],
           let lastIcon = iconFiles.last
        {
            return UIImage(named: lastIcon)
        }
        return nil
    }
}

private extension UIImage {
    // Ref: ã€SwiftUIã€‘QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ã€ä¸­å¿ƒã«å¯æ„›ã„ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä»˜ã‘ã‚‹æ–¹æ³• - https://dev.classmethod.jp/articles/swift-generate-qr-code/
    func composited(withSmallCenterImage centerImage: UIImage) -&gt; UIImage {
        UIGraphicsImageRenderer(size: size).image { context in
            let imageWidth = context.format.bounds.width
            let imageHeight = context.format.bounds.height
            let centerImageLength = imageWidth &lt; imageHeight ? imageWidth / 5 : imageHeight / 5
            let centerImageRadius = centerImageLength * 0.2

            // èƒŒé¢ã«è¨­ç½®ã™ã‚‹è¦ªç”»åƒã‚’æç”»
            draw(in: CGRect(origin: CGPoint(x: 0, y: 0),
                            size: context.format.bounds.size))

            // ä¸­å¿ƒã«è¨­ç½®ã™ã‚‹ç”»åƒã®rectã‚’è¨­å®š
            let centerImageRect = CGRect(x: (imageWidth - centerImageLength) / 2,
                                         y: (imageHeight - centerImageLength) / 2,
                                         width: centerImageLength,
                                         height: centerImageLength)

            // ç”»åƒã«è§’ä¸¸ã‚’ã¤ã‘ã‚‹ç‚ºã®ãƒ‘ã‚¹ã‚’ä½œæˆ
            let roundedRectPath = UIBezierPath(roundedRect: centerImageRect,
                                               cornerRadius: centerImageRadius)
            // ã‚¯ãƒªãƒƒãƒ”ãƒ³ã‚°ãƒ‘ã‚¹ã‚’è¿½åŠ 
            roundedRectPath.addClip()

            // ä¸­å¿ƒã«è¨­ç½®ã™ã‚‹ç”»åƒã‚’æç”»
            centerImage.draw(in: centerImageRect)
        }
    }
}

---

## ðŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/07/02 15:32:44*

ä»¥ä¸‹ã¯ã€SwiftUIã§ç”»åƒã‚’åŸ‹ã‚è¾¼ã¾ãªã„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æä¾›ã™ã‚‹ãŸã‚ã®ä¾‹ã§ã™ã€‚ã“ã®ä¾‹ã§ã¯ã€QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã€ãã®QRã‚³ãƒ¼ãƒ‰ã®CIImageã‚’ç›´æŽ¥ä½¿ç”¨ã—ã¦Imageãƒ“ãƒ¥ãƒ¼ã«è¡¨ç¤ºã—ã¾ã™ã€‚

```swift
import CoreImage.CIFilterBuiltins
import Foundation
import SwiftUI

public final class QRCodeDriver: QRCodeDriverProtocol {
    public init() {
        OSLogger.initLog()
    }

    deinit {
        OSLogger.deinitLog()
    }

    public func generateQRCode(text: String, correctionLevel: QRCorrectionLevel = .high) throws -> CIImage {
        guard let data = text.data(using: .utf8) else {
            throw QRCodeGenerationError.dataConversionFailed
        }

        let filter = CIFilter.qrCodeGenerator()
        filter.setValue(data, forKey: Constants.QRCodeKey.inputMessage)
        filter.setValue(correctionLevel.rawValue, forKey: Constants.QRCodeKey.inputCorrectionLevel)

        guard let ciImage = filter.outputImage else {
            throw QRCodeGenerationError.qrCodeGenerationFailed
        }

        return ciImage.transformed(by: CGAffineTransform(scaleX: 10, y: 10))
    }
}

struct QRCodeView: View {
    let qrCodeDriver = QRCodeDriver()
    @State private var qrCodeImage: CIImage?

    var body: some View {
        VStack {
            if let qrCodeImage = qrCodeImage {
                Image(uiImage: UIImage(ciImage: qrCodeImage))
                    .resizable()
                    .interpolation(.none)
                    .scaledToFit()
                    .frame(width: 200, height: 200)
            } else {
                Text("QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„")
            }

            Button(action: generateQRCode) {
                Text("QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ")
            }
        }
        .padding()
    }

    private func generateQRCode() {
        do {
            let qrCode = try qrCodeDriver.generateQRCode(text: "https://example.com")
            qrCodeImage = qrCode
        } catch {
            print("QRã‚³ãƒ¼ãƒ‰ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: \(error)")
        }
    }
}
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€`QRCodeDriver`ã‚¯ãƒ©ã‚¹ã¯QRã‚³ãƒ¼ãƒ‰ã‚’`CIImage`å½¢å¼ã§ç”Ÿæˆã—ã€`QRCodeView`ã¯ã“ã®`CIImage`ã‚’ä½¿ç”¨ã—ã¦SwiftUIã®`Image`ãƒ“ãƒ¥ãƒ¼ã«QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ã“ã†ã™ã‚‹ã“ã¨ã§ã€ç”»åƒã‚’åŸ‹ã‚è¾¼ã‚€ã“ã¨ãªãã€QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«è¡¨ç¤ºã§ãã¾ã™ã€‚

---

## ðŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/07/02 15:35:14*

public func generateQRCode(text: String, correctionLevel: QRCorrectionLevel = .high) throws -&gt; UIImage  ã«ã—ã¦ã»ã—ã„

---

## ðŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/07/02 15:35:43*

äº†è§£ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã¯ã€`generateQRCode` ãƒ¡ã‚½ãƒƒãƒ‰ãŒ `UIImage` ã‚’è¿”ã™ã‚ˆã†ã«ä¿®æ­£ã—ãŸã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

```swift
import CoreImage.CIFilterBuiltins
import Foundation
import SwiftUI

public final class QRCodeDriver: QRCodeDriverProtocol {
    public init() {
        OSLogger.initLog()
    }

    deinit {
        OSLogger.deinitLog()
    }

    public func generateQRCode(text: String, correctionLevel: QRCorrectionLevel = .high) throws -> UIImage {
        guard let data = text.data(using: .utf8) else {
            throw QRCodeGenerationError.dataConversionFailed
        }

        let filter = CIFilter.qrCodeGenerator()
        filter.setValue(data, forKey: Constants.QRCodeKey.inputMessage)
        filter.setValue(correctionLevel.rawValue, forKey: Constants.QRCodeKey.inputCorrectionLevel)

        guard let ciImage = filter.outputImage else {
            throw QRCodeGenerationError.qrCodeGenerationFailed
        }

        return try convertCIImageToImage(ciImage: ciImage)
    }

    private func convertCIImageToImage(ciImage: CIImage) throws -> UIImage {
        let sizeTransform = CGAffineTransform(scaleX: 10, y: 10)
        let scaledCiImage = ciImage.transformed(by: sizeTransform)
        let context = CIContext()
        guard let cgImage: CGImage = context.createCGImage(scaledCiImage, from: scaledCiImage.extent) else {
            OSLogger.errorLog()
            throw QRCodeGenerationError.qrCodeGenerationFailed
        }
        return UIImage(cgImage: cgImage)
    }
}

struct QRCodeView: View {
    let qrCodeDriver = QRCodeDriver()
    @State private var qrCodeImage: UIImage?

    var body: some View {
        VStack {
            if let qrCodeImage = qrCodeImage {
                Image(uiImage: qrCodeImage)
                    .resizable()
                    .interpolation(.none)
                    .scaledToFit()
                    .frame(width: 200, height: 200)
            } else {
                Text("QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„")
            }

            Button(action: generateQRCode) {
                Text("QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ")
            }
        }
        .padding()
    }

    private func generateQRCode() {
        do {
            let qrCode = try qrCodeDriver.generateQRCode(text: "https://example.com")
            qrCodeImage = qrCode
        } catch {
            print("QRã‚³ãƒ¼ãƒ‰ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: \(error)")
        }
    }
}
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€`QRCodeDriver` ã® `generateQRCode` ãƒ¡ã‚½ãƒƒãƒ‰ãŒ `UIImage` ã‚’è¿”ã™ã‚ˆã†ã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç”Ÿæˆã•ã‚ŒãŸ QR ã‚³ãƒ¼ãƒ‰ã‚’ SwiftUI ã® `Image` ãƒ“ãƒ¥ãƒ¼ã«è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

---

## ðŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/07/02 15:36:19*

ã“ã®2ã¤ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æ®‹ã—ãŸã„ã‚“ã 

public func generateCompositedAppIconQRCode(text: String, correctionLevel: QRCorrectionLevel = .high) throws -&gt; UIImage

public func generateQRCode(text: String, correctionLevel: QRCorrectionLevel = .high) throws -&gt; UIImage

---

## ðŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/07/02 15:37:11*

2ã¤ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ç¶­æŒã—ã¤ã¤ã€ãã‚Œãžã‚Œã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

```swift
import CoreImage.CIFilterBuiltins
import Foundation
import SwiftUI

public final class QRCodeDriver: QRCodeDriverProtocol {
    public init() {
        OSLogger.initLog()
    }

    deinit {
        OSLogger.deinitLog()
    }

    public func generateQRCode(text: String, correctionLevel: QRCorrectionLevel = .high) throws -> UIImage {
        guard let data = text.data(using: .utf8) else {
            throw QRCodeGenerationError.dataConversionFailed
        }

        let filter = CIFilter.qrCodeGenerator()
        filter.setValue(data, forKey: Constants.QRCodeKey.inputMessage)
        filter.setValue(correctionLevel.rawValue, forKey: Constants.QRCodeKey.inputCorrectionLevel)

        guard let ciImage = filter.outputImage else {
            throw QRCodeGenerationError.qrCodeGenerationFailed
        }

        return try convertCIImageToImage(ciImage: ciImage)
    }

    public func generateCompositedAppIconQRCode(text: String, correctionLevel: QRCorrectionLevel = .high) throws -> UIImage {
        let qrCodeImage = try generateQRCode(text: text, correctionLevel: correctionLevel)
        guard let appIcon = Bundle.main.appIcon else {
            throw QRCodeGenerationError.appIconNotFound
        }
        return qrCodeImage.composited(withSmallCenterImage: appIcon)
    }

    private func convertCIImageToImage(ciImage: CIImage) throws -> UIImage {
        let sizeTransform = CGAffineTransform(scaleX: 10, y: 10)
        let scaledCiImage = ciImage.transformed(by: sizeTransform)
        let context = CIContext()
        guard let cgImage: CGImage = context.createCGImage(scaledCiImage, from: scaledCiImage.extent) else {
            OSLogger.errorLog()
            throw QRCodeGenerationError.qrCodeGenerationFailed
        }
        return UIImage(cgImage: cgImage)
    }
}

private extension Bundle {
    var appIcon: UIImage? {
        if let icons = infoDictionary?["CFBundleIcons"] as? [String: Any],
           let primaryIcon = icons["CFBundlePrimaryIcon"] as? [String: Any],
           let iconFiles = primaryIcon["CFBundleIconFiles"] as? [String],
           let lastIcon = iconFiles.last
        {
            return UIImage(named: lastIcon)
        }
        return nil
    }
}

private extension UIImage {
    func composited(withSmallCenterImage centerImage: UIImage) -> UIImage {
        UIGraphicsImageRenderer(size: size).image { context in
            let imageWidth = context.format.bounds.width
            let imageHeight = context.format.bounds.height
            let centerImageLength = imageWidth < imageHeight ? imageWidth / 5 : imageHeight / 5
            let centerImageRadius = centerImageLength * 0.2

            draw(in: CGRect(origin: CGPoint(x: 0, y: 0), size: context.format.bounds.size))

            let centerImageRect = CGRect(x: (imageWidth - centerImageLength) / 2,
                                         y: (imageHeight - centerImageLength) / 2,
                                         width: centerImageLength,
                                         height: centerImageLength)

            let roundedRectPath = UIBezierPath(roundedRect: centerImageRect, cornerRadius: centerImageRadius)
            roundedRectPath.addClip()

            centerImage.draw(in: centerImageRect)
        }
    }
}

struct QRCodeView: View {
    let qrCodeDriver = QRCodeDriver()
    @State private var qrCodeImage: UIImage?

    var body: some View {
        VStack {
            if let qrCodeImage = qrCodeImage {
                Image(uiImage: qrCodeImage)
                    .resizable()
                    .interpolation(.none)
                    .scaledToFit()
                    .frame(width: 200, height: 200)
            } else {
                Text("QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„")
            }

            Button(action: generateQRCode) {
                Text("QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ")
            }

            Button(action: generateCompositedQRCode) {
                Text("App Iconä»˜ãQRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ")
            }
        }
        .padding()
    }

    private func generateQRCode() {
        do {
            let qrCode = try qrCodeDriver.generateQRCode(text: "https://example.com")
            qrCodeImage = qrCode
        } catch {
            print("QRã‚³ãƒ¼ãƒ‰ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: \(error)")
        }
    }

    private func generateCompositedQRCode() {
        do {
            let qrCode = try qrCodeDriver.generateCompositedAppIconQRCode(text: "https://example.com")
            qrCodeImage = qrCode
        } catch {
            print("QRã‚³ãƒ¼ãƒ‰ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: \(error)")
        }
    }
}
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€`generateQRCode` ãƒ¡ã‚½ãƒƒãƒ‰ã¨ `generateCompositedAppIconQRCode` ãƒ¡ã‚½ãƒƒãƒ‰ã®ä¸¡æ–¹ã‚’æä¾›ã—ã€QRã‚³ãƒ¼ãƒ‰ã®ç”Ÿæˆã¨ã‚¢ãƒ—ãƒªã‚¢ã‚¤ã‚³ãƒ³ã‚’ä¸­å¿ƒã«åˆæˆã—ãŸQRã‚³ãƒ¼ãƒ‰ã®ç”ŸæˆãŒå¯èƒ½ã«ãªã£ã¦ã„ã¾ã™ã€‚`QRCodeView` ã®ä¸­ã§ã€ãã‚Œãžã‚Œã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã“ã¨ã§å¯¾å¿œã™ã‚‹QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚

---
