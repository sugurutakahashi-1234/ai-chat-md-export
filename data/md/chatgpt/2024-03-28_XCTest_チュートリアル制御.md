# XCTest チュートリアル制御

Date: 2024-03-28

---

## 👤 User
*2024-03-28 10:36:06*

XcodeでのUIテストでアプリの遷移を確認したい。
ただ、初回起動時はチュートリアルがあって、一度チュートリアルが表示された場合は、2回目は表示されなくて、その状態によって操作させたい挙動が違うんだ

具体的にはチュートリアルの場合のみ、チュートリアルを突破させる挙動をさせたい。

また、CI/CDで回す場合は全パターンを網羅したいので、チュートリアルのケースを一回は確認したく、アプリをクリーンインストールすることを前提に挙動させたいんだ。

どうすればいいか教えて欲しい。XCTestCase を使っている。

---

## 🤖 Assistant
*2024-03-28 10:36:57*

XcodeでのUIテストでは、アプリの状態管理や初回起動時のチュートリアルなど、特定のシナリオをテストするための方法を工夫する必要があります。XCTestCaseを使用しているとのことで、以下に具体的な対応策をいくつか提案します。

### チュートリアルの表示状態を管理する

1. **アプリの状態をリセットする**: テストの前にアプリの状態をリセットし、常にクリーンな状態から開始できるようにします。これには、アプリのデータやUserDefaultsの値をクリアする方法があります。
   
2. **起動引数を使用する**: アプリの起動時に特定の起動引数を渡して、アプリ内でチュートリアルの表示有無を制御します。XCTestでアプリを起動する際に起動引数を追加できます。

### XCTestでの実装例

#### アプリのリセット

テストのセットアップでアプリの状態をリセットします。以下は、UserDefaultsをクリアする例です。

```swift
override func setUp() {
    super.setUp()
    continueAfterFailure = false
    let app = XCUIApplication()
    app.launchArguments += ["-reset"]
    app.launch()
}
```

そして、アプリ側で`-reset`引数を検出してUserDefaultsなどをクリアします。

```swift
if CommandLine.arguments.contains("-reset") {
    UserDefaults.standard.removePersistentDomain(forName: Bundle.main.bundleIdentifier!)
    // 他のリセットが必要な処理
}
```

#### 起動引数を使ったチュートリアル制御

テストケースに応じて、チュートリアルを表示するかどうかを起動引数で制御します。

```swift
func testTutorial() {
    let app = XCUIApplication()
    app.launchArguments += ["-showTutorial"]
    app.launch()
    // チュートリアルを終了させるテストのステップ
}

func testMainFlowWithoutTutorial() {
    let app = XCUIApplication()
    app.launchArguments += ["-skipTutorial"]
    app.launch()
    // チュートリアルをスキップしてメインフローをテスト
}
```

アプリ側では、これらの引数をチェックして、チュートリアルの表示有無を制御します。

### CI/CDでのテスト自動化

CI/CDパイプラインを構成する際に、上記のテストケースを全て含めるようにします。Xcodeのテストプランを使って、特定のテストケースやテストスイートを実行するように設定できます。また、コマンドラインツール`xcodebuild`を使用してCI環境でテストを自動実行することもできます。

これにより、アプリのチュートリアルがあるケースとないケースの両方をカバーし、CI/CDパイプラインで自動的にテストが実行されるようになります。

---

## 👤 User
*2024-03-28 10:54:08*

テスト側のコードからUserデフォルトをリセットさせることはできないのか？

---

## 🤖 Assistant
*2024-03-28 10:54:18*

テストコードから直接UserDefaultsをリセットする方法は、実際には直接的にUserDefaultsを操作してリセットするコードを書くのではなく、テスト実行時に特定の起動引数をアプリに渡

---
