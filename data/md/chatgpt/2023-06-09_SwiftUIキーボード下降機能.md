# SwiftUIキーボード下降機能

日付: 2023-06-09

---

## 👤 ユーザー
*2023/6/9 12:01:38*

SwiftUI でキーボード以外の部分をタップするとキーボードが下に下がる機能をつけて欲しい

---

## 🤖 アシスタント
*2023/6/9 12:02:16*

SwiftUIでキーボードを下げるための一般的な方法は、背景のビューにタップジェスチャーを追加することです。以下にその方法を記述します。

まず、新しい`ViewModifier`を作成します。この`ViewModifier`は、ビューがタップされたときにキーボードを閉じる機能を提供します。

```swift
struct DismissKeyboard: ViewModifier {
    func body(content: Content) -> some View {
        content
            .onTapGesture {
                let keyWindow = UIApplication.shared.connectedScenes
                                .filter({$0.activationState == .foregroundActive})
                                .map({$0 as? UIWindowScene})
                                .compactMap({$0})
                                .first?.windows
                                .filter({$0.isKeyWindow}).first
                keyWindow?.endEditing(true)
            }
    }
}
```

次に、この新しい`ViewModifier`を任意のビューに適用します。例えば、以下のように適用できます。

```swift
var body: some View {
    VStack {
        // Your UI components here.
    }
    .modifier(DismissKeyboard())
}
```

これにより、`VStack`内のどこかをタップすると、キーボードが下に下がります。注意すべき点は、このアプローチはUIKitの一部である`UIApplication`を使っています。このため、SwiftUIのアプリでもUIKitのAPIを利用できることが必要です。

現在のところ、SwiftUI自体にはこのような機能を提供する組み込みのメソッドはありませんが、上記のような手法で代替することが可能です。

---

## 👤 ユーザー
*2023/6/9 12:02:49*

ViewModifier で定義したほうがいいのかな？Viewのextensionではだめなのか？

---

## 🤖 アシスタント
*2023/6/9 12:03:28*

それはどちらでも可能です。ViewModifierはコードをモジュール化するための手段であり、特定のビジュアル変更を一貫して適用することを容易にします。それはSwiftUIの概念の一部であり、あなたが作りたい特定のビジュアル効果を一貫して適用することを容易にします。ViewModifierは特に複数のビューで同じ修正を適用したい場合に便利です。

一方、Viewの拡張は一般的に共有の機能性を追加するために使用されます。これは特定のビューにのみ関連する修正よりも、全てのビューで使用可能な汎用的な修正を作るのに適しています。

以下に、キーボードを下げる機能をViewの拡張として追加する方法を示します：

```swift
extension View {
    func dismissKeyboardOnTap() -> some View {
        self.onTapGesture {
            let keyWindow = UIApplication.shared.connectedScenes
                            .filter({$0.activationState == .foregroundActive})
                            .map({$0 as? UIWindowScene})
                            .compactMap({$0})
                            .first?.windows
                            .filter({$0.isKeyWindow}).first
            keyWindow?.endEditing(true)
        }
    }
}
```

次に、この新しい拡張を任意のビューに適用します。例えば、以下のように適用できます：

```swift
var body: some View {
    VStack {
        // Your UI components here.
    }
    .dismissKeyboardOnTap()
}
```

これにより、`VStack`内のどこかをタップすると、キーボードが下に下がります。この方法でも、ViewModifierを使用した方法と同じ結果が得られます。使用するかどうかは主にプロジェクトの要件と個人の好みによります。

---

## 👤 ユーザー
*2023/6/9 12:07:56*

iOS15 以降なので@FocusStateを使ったらもっと簡単に書けないかな

---

## 🤖 アシスタント
*2023/6/9 12:08:28*

iOS 15以降、SwiftUIには新たに`@FocusState`プロパティラッパーが導入され、これを使用してキーボードの表示・非表示を制御できます。この新機能を使用して、キーボードを非表示にすることが可能です。

例えば、`TextField`がフォーカスを失うとキーボードが非表示になるようにすることができます。以下にその例を示します。

```swift
struct ContentView: View {
    @State private var text = ""
    @FocusState private var isTextFieldFocused: Bool
    
    var body: some View {
        VStack {
            TextField("Type something", text: $text)
                .focused($isTextFieldFocused)
            Button("Dismiss Keyboard") {
                isTextFieldFocused = false
            }
        }
        .onTapGesture {
            isTextFieldFocused = false
        }
    }
}
```

この例では、`TextField`と`Button`があり、どちらかがタップされたときにキーボードが非表示になります。`TextField`に対するフォーカス状態は`@FocusState`を使用して管理され、これを変更することでキーボードの表示・非表示を制御します。

したがって、`@FocusState`を使用すれば、キーボードを非表示にする機能を簡単に実装することができます。ただし、この機能はiOS 15以降でのみ使用可能であることに注意してください。

---

## 👤 ユーザー
*2023/6/9 12:08:46*

textFieldを以外をタップしたら勝手にフォーカスが下がるようにして欲しい

---

## 🤖 アシスタント
*2023/6/9 12:09:16*

確かに、`TextField`以外をタップしたときに自動的にキーボードを下げるためには、以下のように`ZStack`を使用して全体を覆う透明なビューにタップジェスチャーを追加することができます。

まず、あなたの`@FocusState`変数を定義します:

```swift
@FocusState private var isTextFieldFocused: Bool
```

そしてあなたのUIを以下のように変更します:

```swift
ZStack {
    // Main VStack or any other view layout
    VStack {
        TextField("Your Placeholder", text: $text)
            .focused($isTextFieldFocused)
        // Other UI elements
    }
    // This will capture taps outside the TextField
    if isTextFieldFocused {
        Color.clear
            .contentShape(Rectangle())
            .onTapGesture {
                isTextFieldFocused = false
            }
            .ignoresSafeArea(.all) // Optional: if you want to include the safe area in the tap gesture
    }
}
```

この設定により、`TextField`にフォーカスがある場合に限り、タップジェスチャーを受け入れる透明なビューが表示されます。このビューは`TextField`以外の領域を覆い、それらの領域がタップされると`@FocusState`変数を`false`に設定し、キーボードが非表示になります。

---

## 👤 ユーザー
*2023/6/9 12:10:14*

いろんな画面で使えるように拡張したい

---

## 🤖 アシスタント
*2023/6/9 12:10:54*

特定の動作を多数のビューで再利用する場合、ViewModifierかViewの拡張機能が良い選択です。ここでは、Viewの拡張機能を使ってキーボードを下げる機能を作ります。`dismissKeyboardOnTap()`という新しいメソッドを作成します。

以下にそのコードを示します:

```swift
extension View {
    @ViewBuilder
    func dismissKeyboardOnTap() -> some View {
        self.background(KeyboardDismisser())
    }
}

struct KeyboardDismisser: View {
    @FocusState private var isTextFieldFocused: Bool

    var body: some View {
        Color.clear
            .contentShape(Rectangle())
            .onTapGesture {
                isTextFieldFocused = false
            }
            .ignoresSafeArea(.all)
    }
}
```

この拡張機能を使って、特定の画面でキーボードを下げることができます。

```swift
VStack {
    TextField("Placeholder", text: $text)
        .focused($isTextFieldFocused)
    // Other UI elements
}
.dismissKeyboardOnTap()
```

これにより、`VStack`内のどこかをタップすると、キーボードが下に下がります。この方法を使用すると、多くのビューでキーボードを下げる機能を再利用することができます。

ただし、注意すべき点は`KeyboardDismisser`ビューが`FocusState`を所有していて、他の部分の`TextField`の`FocusState`とは独立しているということです。したがって、あなたが`TextField`の`FocusState`を自分で管理する必要がある場合は、この方法が適していないかもしれません。

なお、この方法はiOS 15以降でのみ動作します。

---

## 👤 ユーザー
*2023/6/9 12:14:56*

ViewModifierの拡張ではダメなんだっけ？

---

## 🤖 アシスタント
*2023/6/9 12:15:26*

ViewModifierを使用して拡張することも可能です。以下に、そのための拡張方法を示します。

```swift
struct DismissKeyboardOnTap: ViewModifier {
    @FocusState private var isKeyboardVisible: Bool?

    func body(content: Content) -> some View {
        ZStack {
            content
                .focused($isKeyboardVisible)
            if isKeyboardVisible ?? false {
                Color.clear
                    .contentShape(Rectangle())
                    .onTapGesture {
                        isKeyboardVisible = nil
                    }
                    .ignoresSafeArea(.all)
            }
        }
    }
}

extension View {
    func dismissKeyboardOnTap() -> some View {
        self.modifier(DismissKeyboardOnTap())
    }
}
```

この`ViewModifier`と拡張機能を使用すると、キーボードを表示している状態で`TextField`以外の部分をタップするとキーボードが下がる動作をあらゆる画面で再利用することができます。

使い方は以下の通りです：

```swift
VStack {
    TextField("Placeholder", text: $text)
    // Other UI elements
}
.dismissKeyboardOnTap()
```

このアプローチでは、各ビューが自身のFocusStateを管理しており、他のビューとは独立しています。ただし、これはiOS 15以降でのみ動作します。

---

## 👤 ユーザー
*2023/6/9 14:37:29*

ViewModifierの拡張 と Viewの拡張だとどっちがおすすめ？’

---

## 🤖 アシスタント
*2023/6/9 14:38:01*

ViewModifierとViewの拡張のどちらが優れているかは、使用する文脈とニーズに大きく依存します。

- **ViewModifierを使う場合**：特定のビジュアル効果や動作を一貫して適用したいときにはViewModifierを使用します。これは、コードの再利用性と組織を向上させるのに役立ちます。ViewModifierは自己完結型で、関連するすべてのロジックをカプセル化します。

- **Viewの拡張を使う場合**：共有機能性を追加したいときにはViewの拡張を使用します。これは特定のビューに関連する修正よりも、全てのビューで使用可能な汎用的な修正を作るのに適しています。

キーボードを下げるなどの操作は、アプリケーション全体で一貫して適用されることが多いため、ViewModifierの使用が適していると言えます。しかし、結果的にはどちらのアプローチを選ぶかはプロジェクトの要件、個人の好み、そしてチームのコーディングスタイルによります。どちらの方法も有効で、同じ結果を達成することができます。

---
