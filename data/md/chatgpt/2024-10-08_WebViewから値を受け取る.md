# WebViewから値を受け取る

日付: 2024-10-08

---

## 👤 ユーザー
*2024/10/8 17:17:02*

iOS で WebView からWebViewを閉じて値をiOSに持っていきたい

---

## 🤖 アシスタント
*2024/10/8 17:17:31*

iOS で WebView を閉じて、値をネイティブの Swift アプリに持ってくるには、`WKScriptMessageHandler` を使って、WebView と Swift 間で通信を行います。以下のステップで実装できます。

1. **JavaScript でメッセージを送信**
   WebView の中で JavaScript を使って `window.webkit.messageHandlers` にメッセージを送ります。これが iOS 側にデータを渡すための方法です。

   ```javascript
   // WebView の JavaScript 内
   function sendValueToiOS(value) {
       window.webkit.messageHandlers.callbackHandler.postMessage(value);
   }

   // 例えば、ボタンをクリックしたときに呼び出す
   document.getElementById('submitButton').onclick = function() {
       sendValueToiOS('送信したい値');
   };
   ```

2. **iOS 側でメッセージを受け取る**
   `WKScriptMessageHandler` を使って、WebView から送られたメッセージを受け取ります。

   ```swift
   import SwiftUI
   import WebKit

   struct WebView: UIViewRepresentable {
       let url: URL
       let onValueReceived: (String) -> Void  // WebView から値を受け取るコールバック

       func makeCoordinator() -> Coordinator {
           Coordinator(onValueReceived: onValueReceived)
       }

       func makeUIView(context: Context) -> WKWebView {
           let webView = WKWebView()
           let contentController = webView.configuration.userContentController
           contentController.add(context.coordinator, name: "callbackHandler") // JavaScript の名前と合わせる
           let request = URLRequest(url: url)
           webView.load(request)
           return webView
       }

       func updateUIView(_ uiView: WKWebView, context: Context) {}

       class Coordinator: NSObject, WKScriptMessageHandler {
           let onValueReceived: (String) -> Void

           init(onValueReceived: @escaping (String) -> Void) {
               self.onValueReceived = onValueReceived
           }

           func userContentController(_ userContentController: WKUserContentController, didReceive message: WKScriptMessage) {
               if message.name == "callbackHandler", let value = message.body as? String {
                   onValueReceived(value)  // Swift に値を渡す
               }
           }
       }
   }

   struct ContentView: View {
       @State private var receivedValue = ""

       var body: some View {
           VStack {
               WebView(url: URL(string: "https://your-web-url.com")!) { value in
                   receivedValue = value
                   // WebView が閉じた後の処理や値の処理をここで行う
               }
               Text("受け取った値: \(receivedValue)")
           }
       }
   }
   ```

3. **WebView を閉じる**
   WebView を閉じるには、値を受け取った後に SwiftUI の `dismiss` を呼び出します。例えば、`onValueReceived` 内で WebView を閉じることができます。

   ```swift
   @Environment(\.dismiss) private var dismiss

   func receivedValue(value: String) {
       // 値を使った処理
       dismiss()  // WebView を閉じる
   }
   ```

この方法で、WebView から値を iOS アプリに持ってきて、WebView を閉じることができます。

---
