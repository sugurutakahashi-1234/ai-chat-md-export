# レコーディング中のカウントダウン

日付: 2024-05-09

---

## 👤 ユーザー
*2024/5/9 18:39:31*

レコーディング中の時間をカウントダウンしたい。

//
//  Created by sugurutakahashi on 2024/05/02
//  Copyright © 2024 crage Inc. All rights reserved.
//

import SwiftUI

// MARK: - View

@MainActor
struct RecordingView: View {
    @StateObject private var presenter: RecordingPresenter

    init() {
        _presenter = .init(wrappedValue: .init())
    }

    var body: some View {
        List {
            Section("Recording Config") {
                RecordingConfigPickerView(selection: $presenter.audioFormat)
                RecordingConfigPickerView(selection: $presenter.audioSampleRate)
                RecordingConfigPickerView(selection: $presenter.audioChannel)
                RecordingConfigPickerView(selection: $presenter.audioEncodeQuality)
            }
            .textCase(nil)
            
            Section("Session Config") {
                RecordingConfigPickerView(selection: $presenter.audioSessionCategory)
                RecordingConfigPickerView(selection: $presenter.audioSessionMode)
            }
            .textCase(nil)
            
            Section("Recording Action") {
                Button {
                    presenter.onTapStartRecording()
                } label: {
                    Text("Start Recording")
                }
                .disabled(presenter.isRecording)

                Button {
                    presenter.onTapStopRecording()
                } label: {
                    Text("Stop Recording")
                }
                .disabled(!presenter.isRecording)
            }
            .textCase(nil)
            
            Section("Audio List") {
                NavigationLink {
                    AudioListView()
                } label: {
                    Text("Audio List")
                }
            }
            .textCase(nil)
        }
        .navigationTitle("Recording")
        .overlayLoading(isPresented: $presenter.isLoading, isGestureReactable: false)
        .onAppear {
            presenter.onAppear()
        }
    }
}

// MARK: - Preview

#Preview {
    RecordingView()
        .navigationStacked()
}



import Foundation

@MainActor
final class RecordingPresenter: ObservableObject {
    @Published var audioFormat: AudioFormat = .mpeg4aac_acc
    @Published var audioSampleRate: AudioSampleRate = .voiceLow
    @Published var audioChannel: AudioChannel = .stereo
    @Published var audioEncodeQuality: AudioEncodeQuality = .low
    @Published var audioSessionCategory: AudioSessionCategory = .record
    @Published var audioSessionMode: AudioSessionMode = .default
    
    @Published var isRecording: Bool = false

    @Published var isLoading: Bool = false
    @Published var showAlert: Bool = false
    
    private let deviceAccessDriver: DeviceAccessDriver = DeviceAccessDriver()
    private let fileManageDriver: FileManageDriver = FileManageDriver()
    private let recordingDriver: RecordingDriver = RecordingDriver()

    init() {
        recordingDriver.isRecordingPublisher
            .assign(to: &$isRecording)
    }

    func onAppear() {
        Task {
            await deviceAccessDriver.requestRecording()
        }
    }

    func onTapStartRecording() {
        let recordingConfig = RecordingConfig(audioFormat: audioFormat, audioSampleRate: audioSampleRate, audioChannel: audioChannel, audioEncodeQuality: audioEncodeQuality, audioSessionCategory: audioSessionCategory, audioSessionMode: audioSessionMode)
        do {
            try recordingDriver.startRecording(recordingConfig: recordingConfig)
        } catch {
            OSLogger.errorLog("Could not start recording: \(error)")
             showAlert = true
        }
    }

    func onTapStopRecording() {
        do {
            try recordingDriver.stopRecording()
        } catch {
            OSLogger.errorLog("Could not start recording: \(error)")
            showAlert = true
        }
    }
}

---

## 🤖 アシスタント
*2024/5/9 18:40:42*

To add a countdown timer to your recording feature in the `RecordingView`, you can enhance your SwiftUI and ViewModel classes to manage and display the time remaining. Here is how you can do it:

1. **Add Timer Functionality to `RecordingPresenter`:** First, add properties to keep track of the recording duration and a timer to decrement this duration.

2. **Update UI to Display Countdown Timer:** Modify the `RecordingView` to show the remaining recording time.

### Step 1: Modify `RecordingPresenter`

```swift
import Combine
import Foundation

@MainActor
final class RecordingPresenter: ObservableObject {
    @Published var audioFormat: AudioFormat = .mpeg4aac_acc
    @Published var audioSampleRate: AudioSampleRate = .voiceLow
    @Published var audioChannel: AudioChannel = .stereo
    @Published var audioEncodeQuality: AudioEncodeQuality = .low
    @Published var audioSessionCategory: AudioSessionCategory = .record
    @Published var audioSessionMode: AudioSessionMode = .default
    
    @Published var isRecording: Bool = false
    @Published var countdownTime: Int = 0  // Remaining time in seconds
    @Published var isLoading: Bool = false
    @Published var showAlert: Bool = false
    
    private let deviceAccessDriver: DeviceAccessDriver = DeviceAccessDriver()
    private let fileManageDriver: FileManageDriver = FileManageDriver()
    private let recordingDriver: RecordingDriver = RecordingDriver()
    private var recordingTimer: AnyCancellable?
    
    init() {
        recordingDriver.isRecordingPublisher
            .assign(to: &$isRecording)
    }
    
    func onAppear() {
        Task {
            await deviceAccessDriver.requestRecording()
        }
    }

    func onTapStartRecording() {
        let recordingConfig = RecordingConfig(audioFormat: audioFormat, audioSampleRate: audioSampleRate, audioChannel: audioChannel, audioEncodeQuality: audioEncodeQuality, audioSessionCategory: audioSessionCategory, audioSessionMode: audioSessionMode)
        do {
            try recordingDriver.startRecording(recordingConfig: recordingConfig)
            startTimer(duration: 60)  // Set desired countdown duration
        } catch {
            OSLogger.errorLog("Could not start recording: \(error)")
            showAlert = true
        }
    }

    func onTapStopRecording() {
        do {
            try recordingDriver.stopRecording()
            stopTimer()
        } catch {
            OSLogger.errorLog("Could not start recording: \(error)")
            showAlert = true
        }
    }
    
    private func startTimer(duration: Int) {
        countdownTime = duration
        recordingTimer = Timer.publish(every: 1, on: .main, in: .common).autoconnect()
            .sink { [weak self] _ in
                guard let self = self else { return }
                if self.countdownTime > 0 {
                    self.countdownTime -= 1
                } else {
                    self.onTapStopRecording()
                }
            }
    }
    
    private func stopTimer() {
        recordingTimer?.cancel()
    }
}
```

### Step 2: Update `RecordingView`

```swift
import SwiftUI

@MainActor
struct RecordingView: View {
    @StateObject private var presenter: RecordingPresenter

    init() {
        _presenter = .init(wrappedValue: .init())
    }

    var body: some View {
        List {
            Section("Recording Config") {
                RecordingConfigPickerView(selection: $presenter.audioFormat)
                RecordingConfigPickerView(selection: $presenter.audioSampleRate)
                RecordingConfigPickerView(selection: $presenter.audioChannel)
                RecordingConfigPickerView(selection: $presenter.audioEncodeQuality)
            }
            
            Section("Session Config") {
                RecordingConfigPickerView(selection: $presenter.audioSessionCategory)
                RecordingConfigPickerView(selection: $presenter.audioSessionMode)
            }
            
            Section("Recording Action") {
                Button {
                    presenter.onTapStartRecording()
                } label: {
                    Text("Start Recording")
                }
                .disabled(presenter.isRecording)

                Button {
                    presenter.onTapStopRecording()
                } label: {
                    Text("Stop Recording")
                }
                .disabled(!presenter.isRecording)
                
                if presenter.isRecording {
                    Text("Time Remaining: \(presenter.countdownTime)s")
                }
            }
            
            Section("Audio List") {
                NavigationLink {
                    AudioListView()
                } label: {
                    Text("Audio List")
                }
            }
        }
        .navigationTitle("Recording")
        .overlayLoading(isPresented: $presenter.isLoading, isGestureReactable: false)
        .onAppear {
            presenter.onAppear()
        }
    }
}
```

This setup now includes a countdown timer that starts when the recording starts and updates every second. If the timer runs out, the recording automatically stops. Adjust the `startTimer(duration: Int)`

---

## 👤 ユーザー
*2024/5/9 18:43:22*

純粋に録音時間を計りたいだけなんだ

---

## 🤖 アシスタント
*2024/5/9 18:44:18*

了解しました！録音時間を計測するだけの機能を実装するには、録音が開始されてからの経過時間を表示するタイマーを設定する必要があります。こちらのシンプルな変更で実現できます。

### `RecordingPresenter` に経過時間を追跡するタイマーを追加

```swift
import Combine
import Foundation

@MainActor
final class RecordingPresenter: ObservableObject {
    @Published var audioFormat: AudioFormat = .mpeg4aac_acc
    @Published var audioSampleRate: AudioSampleRate = .voiceLow
    @Published var audioChannel: AudioChannel = .stereo
    @Published var audioEncodeQuality: AudioEncodeQuality = .low
    @Published var audioSessionCategory: AudioSessionCategory = .record
    @Published var audioSessionMode: AudioSessionMode = .default
    
    @Published var isRecording: Bool = false
    @Published var recordingTime: Int = 0  // 経過時間（秒）
    @Published var isLoading: Bool = false
    @Published var showAlert: Bool = false
    
    private let deviceAccessDriver: DeviceAccessDriver = DeviceAccessDriver()
    private let fileManageDriver: FileManageDriver = FileManageDriver()
    private let recordingDriver: RecordingDriver = RecordingDriver()
    private var recordingTimer: AnyCancellable?
    
    init() {
        recordingDriver.isRecordingPublisher
            .assign(to: &$isRecording)
    }
    
    func onAppear() {
        Task {
            await deviceAccessDriver.requestRecording()
        }
    }

    func onTapStartRecording() {
        let recordingConfig = RecordingConfig(audioFormat: audioFormat, audioSampleRate: audioSampleRate, audioChannel: audioChannel, audioEncodeQuality: audioEncodeQuality, audioSessionCategory: audioSessionCategory, audioSessionMode: audioSessionMode)
        do {
            try recordingDriver.startRecording(recordingConfig: recordingConfig)
            startRecordingTimer()
        } catch {
            OSLogger.errorLog("Could not start recording: \(error)")
            showAlert = true
        }
    }

    func onTapStopRecording() {
        do {
            try recordingDriver.stopRecording()
            stopRecordingTimer()
        } catch {
            OSLogger.errorLog("Could not start recording: \(error)")
            showAlert = true
        }
    }
    
    private func startRecordingTimer() {
        recordingTime = 0
        recordingTimer = Timer.publish(every: 1, on: .main, in: .common).autoconnect()
            .sink { [weak self] _ in
                guard let self = self else { return }
                self.recordingTime += 1
            }
    }
    
    private func stopRecordingTimer() {
        recordingTimer?.cancel()
    }
}
```

### `RecordingView` に経過時間を表示する機能を追加

```swift
import SwiftUI

@MainActor
struct RecordingView: View {
    @StateObject private var presenter: RecordingPresenter

    init() {
        _presenter = .init(wrappedValue: .init())
    }

    var body: some View {
        List {
            // Config Sections...
            
            Section("Recording Action") {
                Button {
                    presenter.onTapStartRecording()
                } label: {
                    Text("Start Recording")
                }
                .disabled(presenter.isRecording)

                Button {
                    presenter.onTapStopRecording()
                } label: {
                    Text("Stop Recording")
                }
                .disabled(!presenter.isRecording)

                if presenter.isRecording {
                    Text("Recording Time: \(presenter.recordingTime)s")
                }
            }

            // Audio List Section...
        }
        .navigationTitle("Recording")
        .onAppear {
            presenter.onAppear()
        }
    }
}
```

このコードは録音が開始されるとタイマーを起動し、1秒ごとに経過時間を更新して画面に表示します。録音が停止されると、タイマーも停止します。

---
