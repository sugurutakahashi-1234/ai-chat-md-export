# Appleアプリ決済移行相談

日付: 2024-09-19

---

## 👤 ユーザー
*2024/9/19 17:36:24*

Apple からアプリの有料課金ユーザーをStripeにしたい

---

## 🤖 アシスタント
*2024/9/19 17:37:01*

AppleのApp Storeにおいて、アプリ内での有料課金（In-App Purchase）をAppleのシステムを介さずに外部の決済システム（例: Stripe）に変更することは、AppleのApp Storeガイドラインに違反する可能性があります。特に、App Storeガイドライン3.1.1では、アプリ内でデジタルコンテンツやサービスを提供する場合、AppleのIn-App Purchaseを使用することが求められています。

ただし、以下の条件によってはStripeなどの外部決済サービスを使用できる場合があります：

1. \*\*物理的な商品やサービスの販売\*\*  
   アプリが物理的な商品やサービスを提供する場合、Stripeなどの外部決済システムを使用することが許可されています。例としては、UberやAmazonなど、物理的な商品やサービスの決済が該当します。

2. \*\*外部購入リンクの追加 (Readerアプリ)\*\*  
   「リーダーアプリ」（例: SpotifyやNetflixのように、外部で購入されたコンテンツにアクセスするアプリ）は、アプリ内で直接課金を行わず、ユーザーを外部の決済ページに誘導するリンクを設置することが可能です。これはApp Storeガイドライン3.1.3(a)に基づいており、Stripeなどの外部決済をアプリの外で行うことが認められています。

3. \*\*サードパーティ決済（韓国やオランダなどの一部地域）\*\*  
   特定の地域（韓国やオランダなど）では、Appleはサードパーティの決済オプションの提供を認めています。ただし、手数料が課される場合があります。

Stripeなどに移行を検討している場合、ガイドラインに適合する形で実装を行うことが必要です。また、Appleに対して外部決済を利用する旨の申請やガイドラインの確認を行うことを強く推奨します。

どのようなアプリか、そしてどのような形式でStripeを導入したいか教えていただければ、さらに詳細なアドバイスができます。

---

## 👤 ユーザー
*2024/9/19 17:37:36*

両方を両立させることは可能なのか？

---

## 🤖 アシスタント
*2024/9/19 17:38:05*

AppleのApp Storeガイドラインに従いながら、AppleのIn-App Purchase (IAP) と Stripeなどの外部決済システムを両立させることは、通常のアプリ内デジタルコンテンツ販売では難しいです。しかし、以下のような状況では両方を使い分けることが可能です。

### 1. \*\*物理商品やサービスに対してStripeを使用\*\*  
デジタルコンテンツに対してはAppleのIn-App Purchaseを使用し、物理商品やサービス（例: イベントチケット、レストランの注文、配達サービス）にはStripeなどの外部決済システムを使用することができます。この方法は、デジタル商品と物理商品を明確に区別し、両方の決済システムを適切に使い分ける形です。

### 2. \*\*「リーダーアプリ」としての外部決済の利用\*\*
SpotifyやNetflixのように、外部で購入したコンテンツをアプリ内で閲覧する場合、外部決済のリンク（例えばStripe決済が含まれたウェブページ）を提供できます。AppleのIn-App Purchaseを使用せず、外部決済ページに誘導することができますが、この場合はアプリ内で直接決済を行うのではなく、ユーザーを外部ブラウザに移動させる必要があります。

### 3. \*\*特定の地域でのサードパーティ決済の導入\*\*  
韓国やオランダなどの地域では、アプリ内でStripeを含むサードパーティ決済を許可するルールが設けられています。Appleの手数料は別途請求される場合がありますが、In-App Purchaseと外部決済を併用できるケースもあります。

### 4. \*\*非デジタルサービスやサブスクリプション\*\*
デジタルコンテンツの販売にはAppleのIAPが必要ですが、非デジタルのサービスや会員登録、法人向けのサービスには外部決済システムが使える場合があります。例えば、フィットネスアプリでジムの会員登録など、デジタル商品でないサービスに対してはStripeなどを利用することが許されています。

---

### 注意点
Appleのガイドラインは厳格で、違反した場合にはアプリがリジェクトされる可能性があるため、両立させたい場合には以下の点に注意する必要があります：

- \*\*デジタルコンテンツには必ずIn-App Purchaseを使用すること。\*\*  
   デジタル商品の場合、外部決済システムを使用することは認められていないため、AppleのIAPを使用する必要があります。
   
- \*\*物理商品や非デジタルサービスに対してはStripeを使用できる。\*\*  
   物理商品やサービス、法人向けのサービスなどであれば、外部決済システムを使ってAppleの規約に違反することなく、決済を処理できます。

アプリがどのような商品やサービスを扱っているのかによって、実際に両方の決済システムをどのように組み込むかが決まります。もし具体的なケースがあれば、それに基づいてさらに詳しい提案をさせていただきます。

---

## 👤 ユーザー
*2024/9/19 17:38:20*

デジタルコンテンツなのですが、Stripeにしたい

---

## 🤖 アシスタント
*2024/9/19 17:38:58*

デジタルコンテンツに対して、AppleのIn-App Purchase (IAP) を避けて直接Stripeを使用するのは、App Storeガイドラインに違反する可能性が高いです。特に、\*\*App Store ガイドライン3.1.1\*\* では、アプリ内でデジタルコンテンツやサービスを提供する場合、AppleのIAPを使用することが義務付けられています。

以下は、Appleのガイドライン内で許容される範囲内でデジタルコンテンツのStripe決済を実現できるかもしれない方法やアプローチです。

### 1. \*\*「リーダーアプリ」モデルの活用\*\*
NetflixやSpotifyのような「リーダーアプリ」では、デジタルコンテンツの購入やサブスクリプションをアプリ外で行い、アプリ内でそのコンテンツを表示することが許されています。Appleのルールでは、「リーダーアプリ」はアプリ内で直接購入ボタンを表示することはできませんが、外部のWebサイトにユーザーを誘導するリンクを設置することは可能です。

具体的には、以下の手順でStripeを利用することができます：
- アプリ内では課金を行わず、デジタルコンテンツの購入を外部のWebサイトで行う。
- アプリ内で「購入は外部で行う」旨の案内を表示し、Stripeを組み込んだ決済用Webページにユーザーを誘導するリンクを設置する。
- WebページでユーザーがStripeを使って支払いを完了した後、アプリ内でそのコンテンツにアクセスできるようにする。

このアプローチでは、アプリ自体がデジタルコンテンツを提供するのではなく、すでに外部で購入されたコンテンツへのアクセスを提供するという形を取るため、AppleのIAPを回避できる可能性があります。

ただし、このモデルを採用するためには、Appleに「リーダーアプリ」としての申請が必要であり、Appleがその申請を承認する必要があります。また、アプリの中でユーザーを外部の決済ページに誘導する場合、\*\*決済が直接アプリ内で行われないこと\*\*を明示する必要があります。

### 2. \*\*サブスクリプションサービスのWeb経由課金\*\*
リーダーアプリとは異なる場合でも、サブスクリプションサービスを提供する場合は、App Store外でユーザーに対して課金を行う方法があります。ただし、アプリ内では直接課金や購入リンクを提供することはできず、外部のWebサイトやサブスクリプション用のポータルを利用する必要があります。

### 3. \*\*特定地域の規制変更を待つ\*\*
Appleは一部の地域（例: 韓国やオランダ）で、法律によってサードパーティの決済方法を許可するようになりました。今後、他の地域でも法的な変更がある可能性があります。これにより、Stripeのような外部決済を許可する道が広がるかもしれません。ただし、現在は限られた地域のみですので、現時点では広範囲での導入は難しいです。

---

### 注意点とリスク
App Storeの規約に違反した場合、アプリがリジェクトされたり、App Storeから削除されたりするリスクがあります。Appleは自社のIAPシステムをデジタルコンテンツに対して厳格に求めており、これを回避することは難しいため、公式なガイドラインに従って行動することが最も安全です。

Stripeを利用してデジタルコンテンツの課金を行いたい場合は、リーダーアプリモデルなどAppleのガイドラインに適合する形での実装が最も現実的な選択肢です。また、ユーザーエクスペリエンスやAppleの審査基準に注意しながら慎重に進めることをお勧めします。

---

## 👤 ユーザー
*2024/9/19 17:39:24*

2. サブスクリプションサービスのWeb経由課金 こちらのソースを教えてほしい

---

## 🤖 アシスタント
*2024/9/19 17:40:40*

サブスクリプションサービスのWeb経由課金を実装する際、AppleのApp Storeガイドラインに違反しない形で、アプリ外のWebサイトでStripeを利用した課金フローを実装する方法を以下に示します。

### 実装例（Swiftでの基本的なフロー）

#### 1. **アプリ内で課金リンクを表示する（直接のリンクは禁止）**
まず、アプリ内で直接決済を行うことはできないため、「購入はWebサイトで行う」旨を案内します。この場合、アプリ内に外部リンクを設置して、Webブラウザで決済ページに遷移させます。

```swift
import SwiftUI

struct SubscriptionView: View {
    var body: some View {
        VStack(spacing: 20) {
            Text("デジタルコンテンツを購入するには、Webサイトからサブスクリプションを行ってください。")
                .multilineTextAlignment(.center)
                .padding()

            // 外部サイトへのリンクボタンを設置（直接のリンクは禁止のため、ブラウザで開く）
            Button(action: {
                if let url = URL(string: "https://yourwebsite.com/subscribe") {
                    UIApplication.shared.open(url)
                }
            }) {
                Text("Webサイトでサブスクリプション")
                    .font(.headline)
                    .foregroundColor(.blue)
                    .underline()
            }
        }
        .padding()
    }
}
```

このコードでは、購入や課金がアプリ内で行われるのではなく、ユーザーを外部Webページに誘導しています。この外部WebページでStripeを使ったサブスクリプションを処理します。

#### 2. **Webサイト側でのStripe決済フロー**

次に、外部WebページでStripeを利用してサブスクリプションを実装します。以下はNode.js（Expressフレームワーク）を使ったStripeサブスクリプションの基本的な実装例です。

##### Node.js（Express）とStripeのインストール

まず、必要なパッケージをインストールします。

```bash
npm install express stripe body-parser
```

##### サーバー側のStripeサブスクリプション処理

```javascript
const express = require('express');
const stripe = require('stripe')('your-secret-key');
const bodyParser = require('body-parser');

const app = express();
app.use(bodyParser.json());

// サブスクリプション処理
app.post('/create-subscription', async (req, res) => {
  const { email, paymentMethodId } = req.body;

  try {
    // 顧客の作成
    const customer = await stripe.customers.create({
      email: email,
      payment_method: paymentMethodId,
      invoice_settings: {
        default_payment_method: paymentMethodId,
      },
    });

    // サブスクリプションの作成
    const subscription = await stripe.subscriptions.create({
      customer: customer.id,
      items: [{ price: 'your_price_id' }], // 事前に作成したStripeのPrice ID
      expand: ['latest_invoice.payment_intent'],
    });

    res.send({
      subscriptionId: subscription.id,
      clientSecret: subscription.latest_invoice.payment_intent.client_secret,
    });
  } catch (error) {
    res.status(400).send({ error: { message: error.message } });
  }
});

app.listen(3000, () => console.log('Server running on port 3000'));
```

このコードは、ユーザーから送信された支払い情報を使用して、Stripeのサブスクリプションを作成します。サブスクリプションには、事前にStripeダッシュボードで作成した価格（Price ID）を使用します。

#### 3. **フロントエンドでの支払いフォームの実装**

Stripeのサブスクリプション処理を行うためのフロントエンド部分のコードです。たとえば、HTMLで支払いフォームを実装します。

```html
<form id="subscription-form">
  <input type="email" id="email" placeholder="Email" required />
  <div id="card-element"><!-- Stripe.js will insert the Card Element here --></div>
  <button id="submit">Subscribe</button>
</form>

<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe('your-public-key');
  const elements = stripe.elements();
  const card = elements.create('card');
  card.mount('#card-element');

  document.getElementById('subscription-form').addEventListener('submit', async (event) => {
    event.preventDefault();

    const { paymentMethod, error } = await

---

## 🤖 アシスタント
*2024/9/19 17:41:24*

Appleのガイドラインに基づくと、アプリ内でユーザーを外部のWebサイトに飛ばすこと自体は可能です。ただし、その \*\*Webサイトでの購入プロセス\*\* がAppleの \*\*In-App Purchase (IAP)\*\* を迂回している場合、Appleの審査でリジェクトされる可能性があります。

特にデジタルコンテンツやサービスに関しては、以下の点に注意する必要があります。

### 1. \*\*直接的な外部決済リンクは禁止\*\*
Appleのガイドライン3.1.1では、アプリ内で外部の決済システム（例: Stripe）を通じたデジタルコンテンツやサービスの購入をアプリ外で行うことを示唆するリンクやボタンを設置することは許されていません。  
例えば、「購入はこちら」などのリンクで直接Webページに遷移させる場合は、審査でリジェクトされる可能性があります。

Appleのガイドライン3.1.3(b)では、外部リンクを通じてデジタルコンテンツの購入ページに誘導することが明確に禁じられています。

### 2. \*\*「リーダーアプリ」の特例\*\*
ただし、音楽やビデオ、書籍、ニュースなどのコンテンツにアクセスする \*\*リーダーアプリ\*\* に該当する場合は、例外が認められることがあります。例えば、SpotifyやNetflixのようなリーダーアプリでは、アプリ内で課金せずに、外部のWebサイトでサブスクリプションを購入することが許可されています。  
この場合でも、アプリ内で直接外部決済ページにリンクすることはできませんが、外部購入の方法について案内することは可能です。

### 3. \*\*エンタープライズや法人向けの場合\*\*
企業や法人向けのサービスを提供している場合、B2B向けの決済などであれば、AppleのIAPを回避して外部決済を利用できる可能性があります。この場合も慎重にガイドラインを確認する必要がありますが、一般的なデジタルコンテンツ向けアプリとは異なる基準が適用されることがあります。

### 4. \*\*合法的なWeb経由の案内（技術サポートや追加情報）\*\*
技術的なサポートやアカウント管理などの目的で、Webサイトにリンクを案内することは可能です。しかし、この場合も \*\*決済を含むリンク\*\* ではなく、あくまでサポートや情報提供のためのWebページに限られます。

---

### 結論
Appleのガイドラインに従う限り、\*\*デジタルコンテンツに関して外部決済への直接リンクを提供することはできません\*\*。しかし、外部での決済方法についてユーザーに情報を提供することや、物理的な商品やサービスに対して外部決済を利用することは可能です。

サブスクリプションを外部で行いたい場合、次のような対応が考えられます：
- \*\*リーダーアプリとして登録\*\*することが可能であれば、外部決済を案内できます。
- 物理商品やサービスの場合は、Stripeを利用しても問題ありません。

もし、この方法が難しい場合や、Appleの審査基準に対して心配がある場合は、Appleのサポートチームに事前に問い合わせるか、ガイドラインに沿った形で実装を進めるのが安全です。

---
