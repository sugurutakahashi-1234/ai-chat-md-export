# dotenv環境変数展開確認

Date: 2025-06-13

---

## 👤 User
*2025-06-13 18:05:22*

dotenv -e ../../.env -- prisma migrate dev
これで環境変数の展開はできるか。 
また、そうなるソースを教えてほしい。 

 .env.local
APP_ENV=local
PORT=3000
CORS_ORIGINS=http://localhost:5173
ENABLE_DEBUG_ENDPOINTS=true

# PostgreSQL設定（Docker Composeでも使用）
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=hono_learning
POSTGRES_PORT=5432

# Prisma接続設定（dotenvxの変数展開機能を使用）
# 参考: https://dotenvx.com/docs/advanced/run-variable-expansion
DATABASE_URL="postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@localhost:${POSTGRES_PORT}/${POSTGRES_DB}?schema=public"
DIRECT_URL="postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@localhost:${POSTGRES_PORT}/${POSTGRES_DB}?schema=public"

---

## 🤖 Assistant
*2025-06-13 18:05:52*

はい、`dotenv -e ../../.env -- prisma migrate dev`（＝ `dotenv-cli` を使う想定）でも、`.env` ファイル内の **`${POSTGRES_USER}`** などの *自己参照* 変数はデフォルトで展開されます。`dotenv-cli v8` 以降は **Variable expansion がオン** になっているため追加オプションは不要で、無効化したい場合だけ `--no-expand` を付けます。citeturn1view0

---

### 動作確認のミニサンプル

1. **.env.local**（既に提示いただいた内容）

   ```dotenv
   # .env.local
   APP_ENV=local
   PORT=3000
   POSTGRES_USER=postgres
   POSTGRES_PASSWORD=postgres
   POSTGRES_DB=hono_learning
   POSTGRES_PORT=5432

   DATABASE_URL="postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@localhost:${POSTGRES_PORT}/${POSTGRES_DB}?schema=public"
   DIRECT_URL="postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@localhost:${POSTGRES_PORT}/${POSTGRES_DB}?schema=public"
   ```

2. **確認用スクリプト** `scripts/show-db-url.js`

   ```js
   console.log('DATABASE_URL =', process.env.DATABASE_URL);
   ```

3. **実行**

   ```bash
   # 変数が正しく展開されるか確認
   npx dotenv -e .env.local -- node scripts/show-db-url.js
   # => DATABASE_URL = postgresql://postgres:postgres@localhost:5432/hono_learning?schema=public
   ```

4. **Prisma migrate**

   ```bash
   npx dotenv -e .env.local -- prisma migrate dev
   ```

   `dotenv-cli` が `.env.local` を読み込んで環境に注入したあと `prisma migrate dev` が走るので、Prisma は展開済み **DATABASE_URL** を受け取り、そのまま接続できます。

---

### `dotenvx` を使う場合

同じことを `dotenvx` でも行えます。`dotenvx run` は常に展開機能が有効なので、次のように書くだけです。

```bash
dotenvx run -f .env.local -- prisma migrate dev
```

`dotenvx` の公式ドキュメントでも変数展開の挙動が示されています。citeturn3search0

---

#### まとめ

| ツール | コマンド例 | 変数展開 | 備考 |
|-------|-----------|----------|------|
| dotenv-cli | `dotenv -e .env.local -- prisma migrate dev` | 既定で有効（`--no-expand` で無効化） | `.env` を複数指定したい場合は `-e` を並べる |
| dotenvx | `dotenvx run -f .env.local -- prisma migrate dev` | 常に有効 | 暗号化 `.env` やコマンド置換 `$(…)` など拡張機能が豊富 |

どちらを使っても、提示の `.env.local` で **`${…}`** を用いた参照は期待通りに解決されるので、そのままご利用いただけます。

---
