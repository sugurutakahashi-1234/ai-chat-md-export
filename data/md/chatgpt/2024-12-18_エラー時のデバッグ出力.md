# エラー時のデバッグ出力

Date: 2024-12-18

---

## 👤 User
*2024-12-18 15:25:36*

エラー時もdebugPrintしたい。

import 'package:dio/dio.dart';
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:hooks_riverpod/hooks_riverpod.dart';
import 'package:snpit_guild_app/domain/screen.dart';
import 'package:snpit_guild_app/lib/infrastructure/snapit_guild_api/snapit_guild_api.openapi.dart';

// API Client Provider
final guildApiProvider = Provider&lt;GuildApi&gt;((ref) {
  return GuildApi(
    Dio(),
    Uri.parse('http://localhost:3002/'),
  );
});

// Guild Info Future Provider
final guildInfoProvider = FutureProvider((ref) async {
  final client = ref.read(guildApiProvider);
  final guildInfo = await client.guildControllerGetGuildInfo();
  debugPrint('Guild Info: $guildInfo');
  return guildInfo.data;
});

class GuildPage extends HookConsumerWidget {
  const GuildPage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final guildInfoAsync = ref.watch(guildInfoProvider);

    return Scaffold(
      appBar: AppBar(title: const Text('Guild Page')),
      body: guildInfoAsync.when(
        data: (guildInfo) =&gt; Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Text('Guild Info: $guildInfo'),
              const SizedBox(height: 16),
              ElevatedButton(
                onPressed: () {
                  context.push(Screen.guildCode.path);
                },
                child: const Text('Go To Guild Code'),
              ),
              ElevatedButton(
                onPressed: () {
                  context.push(Screen.guildCreate.path);
                },
                child: const Text('Go To Guild Create'),
              ),
            ],
          ),
        ),
        loading: () =&gt; const Center(child: CircularProgressIndicator()),
        error: (error, stackTrace) =&gt; Center(
          child: Text('Error: $error'),
        ),
      ),
    );
  }
}

---

## 🤖 Assistant
*2024-12-18 15:25:47*

エラー時にも`debugPrint`でエラー内容を表示したい場合は、`guildInfoProvider`でエラーをキャッチしてログに出力するように変更できます。`catchError`を使用してエラーを処理する方法を以下に示します。

```dart
// Guild Info Future Provider
final guildInfoProvider = FutureProvider((ref) async {
  final client = ref.read(guildApiProvider);
  try {
    final guildInfo = await client.guildControllerGetGuildInfo();
    debugPrint('Guild Info: $guildInfo');
    return guildInfo.data;
  } catch (error, stackTrace) {
    debugPrint('Error fetching Guild Info: $error');
    debugPrint('StackTrace: $stackTrace');
    throw error; // 再度エラーをスローしてViewで表示する
  }
});
```

これにより、API呼び出しでエラーが発生した場合でも、コンソールにエラー情報が出力されます。また、`throw error`を使うことで、エラーを再度スローし、`guildInfoAsync.when`内の`error`ハンドラーに渡すことができます。

また、`GuildPage`内でエラーを表示する部分にさらに詳細な情報を追加することも可能です。

```dart
error: (error, stackTrace) => Center(
  child: Column(
    mainAxisAlignment: MainAxisAlignment.center,
    children: [
      Text('Error: $error'),
      const SizedBox(height: 16),
      TextButton(
        onPressed: () {
          debugPrint('Error: $error');
          debugPrint('StackTrace: $stackTrace');
        },
        child: const Text('Show Error Details'),
      ),
    ],
  ),
),
```

このようにすると、UI上でエラーの詳細情報を確認したい場合に役立ちます。`debugPrint`の中で`error`と`stackTrace`の両方を表示することで、デバッグしやすくなります。

---

## 👤 User
*2024-12-18 15:26:32*

client が 'http://localhost:3002/' にリクエストしているかが知りたい

---

## 🤖 Assistant
*2024-12-18 15:27:04*

`client`が正しく`http://localhost:3002/`にリクエストしているか確認するには、リクエストやレスポンスをログに出力する方法が有効です。`Dio`にはリクエスト/レスポンスを簡単にログに出力するための`Interceptor`を追加する機能があります。

以下に、リクエストとレスポンスをログに出力する方法を示します。

### 1. Dio に `LogInterceptor` を追加する
`GuildApi`の`Dio`インスタンスに`LogInterceptor`を追加します。

```dart
import 'package:dio/dio.dart';

final guildApiProvider = Provider<GuildApi>((ref) {
  final dio = Dio();
  dio.options.baseUrl = 'http://localhost:3002/';
  dio.interceptors.add(LogInterceptor(
    request: true, // リクエストデータをログに出力
    requestBody: true, // リクエストのボディをログに出力
    responseBody: true, // レスポンスのボディをログに出力
    responseHeader: false, // レスポンスヘッダーをログに出力（必要に応じて変更）
  ));
  return GuildApi(dio, Uri.parse('http://localhost:3002/'));
});
```

この設定により、すべてのリクエストとレスポンスがログに出力されます。ログには以下が含まれます：
- リクエストのURL
- HTTPメソッド
- ヘッダー
- ボディ（必要に応じて）
- レスポンスデータ

---

### 2. カスタムインターセプターを追加してより詳細にログを取得
より詳細な制御が必要な場合、カスタムインターセプターを作成して、すべてのリクエストやレスポンスをキャッチする方法があります。

```dart
class LoggingInterceptor extends Interceptor {
  @override
  void onRequest(RequestOptions options, RequestInterceptorHandler handler) {
    debugPrint('Request [${options.method}] ${options.baseUrl}${options.path}');
    debugPrint('Headers: ${options.headers}');
    debugPrint('Body: ${options.data}');
    handler.next(options); // 次の処理へ渡す
  }

  @override
  void onResponse(Response response, ResponseInterceptorHandler handler) {
    debugPrint('Response [${response.statusCode}] ${response.requestOptions.baseUrl}${response.requestOptions.path}');
    debugPrint('Response Data: ${response.data}');
    handler.next(response); // 次の処理へ渡す
  }

  @override
  void onError(DioError err, ErrorInterceptorHandler handler) {
    debugPrint('Error [${err.response?.statusCode}] ${err.requestOptions.baseUrl}${err.requestOptions.path}');
    debugPrint('Error Data: ${err.response?.data}');
    handler.next(err); // 次の処理へ渡す
  }
}

final guildApiProvider = Provider<GuildApi>((ref) {
  final dio = Dio();
  dio.options.baseUrl = 'http://localhost:3002/';
  dio.interceptors.add(LoggingInterceptor());
  return GuildApi(dio, Uri.parse('http://localhost:3002/'));
});
```

このインターセプターを使用すると、ログにリクエストとレスポンスの詳細が表示されます。また、エラー時の情報もキャッチできます。

---

### 3. 実行時にリクエストを確認
アプリを実行し、コンソールに以下のようなログが表示されるはずです：

#### リクエストログ
```
Request [GET] http://localhost:3002/guild-info
Headers: {Authorization: Bearer token...}
Body: null
```

#### レスポンスログ
```
Response [200] http://localhost:3002/guild-info
Response Data: {id: 1, name: 'Example Guild'}
```

#### エラーログ
```
Error [404] http://localhost:3002/guild-info
Error Data: {message: 'Not Found'}
```

これにより、`client`がリクエストを正しいエンドポイントに送信しているかどうかを確認できます。

---
