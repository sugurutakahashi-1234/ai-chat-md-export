# サブモジュールのコミット指定

日付: 2024-10-16

---

## 👤 ユーザー
*2024/10/16 20:06:27*

コミットhash指定
\[submodule "shared-module-ios"\]
	path = shared-module-ios
	url = git@github.com:progrit/shared-module-ios.git

---

## 🤖 アシスタント
*2024/10/16 20:06:42*

`submodule` に特定のコミットハッシュを指定する場合、通常は以下のように進めます。

1. `shared-module-ios` サブモジュールディレクトリに移動して、対象のコミットハッシュにチェックアウトします。
   
2. `git add` で変更をステージングし、サブモジュールが特定のコミットハッシュに固定されるようにします。

以下に具体的な手順を示します。

### 手順

1. サブモジュールディレクトリに移動します:

   ```bash
   cd shared-module-ios
   ```

2. サブモジュールの特定のコミットにチェックアウトします (例: `abc1234`):

   ```bash
   git checkout abc1234
   ```

3. 上位のプロジェクトに戻って、サブモジュールの変更をステージに追加します:

   ```bash
   cd ..
   git add shared-module-ios
   ```

4. コミットします:

   ```bash
   git commit -m "Update submodule shared-module-ios to commit abc1234"
   ```

5. 必要に応じて、プッシュします:

   ```bash
   git push
   ```

これで、サブモジュールが指定したコミットハッシュに固定されます。他の開発者がリポジトリをクローンまたは更新した場合、同じコミットハッシュに基づいたサブモジュールが取得されます。

---

## 👤 ユーザー
*2024/10/16 20:06:54*

.gitmodules ファイルに書き込む方法は

---

## 🤖 アシスタント
*2024/10/16 20:07:14*

`.gitmodules` ファイルに特定のコミットハッシュを直接書き込むことはできません。`.gitmodules` ファイルは、サブモジュールの URL やパスの情報を保持するためのファイルであり、コミットハッシュを管理する場所ではありません。

サブモジュールが指しているコミットハッシュの情報は、親リポジトリの `.gitmodules` ではなく、親リポジトリの Git ツリー内に格納されます。

具体的には、サブモジュールのコミットハッシュは親リポジトリの `.git/modules/` ディレクトリや、サブモジュールの状態を反映する親リポジトリのインデックスによって管理されています。

### `.gitmodules` ファイルにサブモジュール情報を記述する基本的な構文

`.gitmodules` ファイルに書き込む情報は次のようになります。

```plaintext
[submodule "shared-module-ios"]
    path = shared-module-ios
    url = git@github.com:progrit/shared-module-ios.git
```

この `.gitmodules` ファイルには、サブモジュールのパス (`path`) と URL (`url`) が指定されていますが、コミットハッシュは含まれていません。サブモジュールのコミットハッシュは、親リポジトリの Git オブジェクトとして管理され、次のように変更します。

### サブモジュールのコミットハッシュを管理する方法

1. サブモジュールを特定のコミットハッシュにチェックアウトする手順は、先ほど説明した通りです。

2. その状態を親リポジトリでコミットすることで、サブモジュールの状態が親リポジトリ内に保存されます。この操作により、親リポジトリのインデックスにサブモジュールが指すコミットハッシュが記録されます。

つまり、`.gitmodules` ファイルにはサブモジュールのパスと URL のみを記述し、サブモジュールのコミットハッシュを固定するためには、サブモジュール自体を更新して親リポジトリでコミットするのが一般的な方法です。

---

## 👤 ユーザー
*2024/10/16 20:07:25*

ブランチも指定できないの？

---

## 🤖 アシスタント
*2024/10/16 20:07:50*

`.gitmodules` ファイルでは、サブモジュールの **URL** や **パス** を指定できますが、特定の **ブランチ** や **コミットハッシュ** を直接指定することはできません。サブモジュールの参照先ブランチを指定するには、`.gitmodules` ではなく、サブモジュールの設定や操作によって行います。

ただし、サブモジュールを **特定のブランチ** に追従させる設定は可能です。その場合は、サブモジュールのブランチを自動的に追従させる設定をする必要があります。

### サブモジュールの特定のブランチを指定する方法

1. `.gitmodules` ファイルに **ブランチ** の設定を追加することができますが、この設定はあくまで「そのブランチを追従する」ようにするだけで、固定するものではありません。具体的には、以下のように設定します。

```plaintext
[submodule "shared-module-ios"]
    path = shared-module-ios
    url = git@github.com:progrit/shared-module-ios.git
    branch = develop   # ここで特定のブランチを指定します
```

これにより、`shared-module-ios` サブモジュールは `develop` ブランチを追従します。

2. 上記の `.gitmodules` の設定を反映するには、次のコマンドを実行します。

```bash
git submodule update --remote
```

このコマンドを実行するたびに、サブモジュールが指定されたブランチ（この例では `develop` ブランチ）を自動的に更新します。

### 特定のブランチを追従させたい場合

サブモジュールの追従ブランチを設定するには、以下のように手動でサブモジュールをセットアップすることもできます。

```bash
cd shared-module-ios
git checkout develop  # 特定のブランチを指定
cd ..
git add shared-module-ios
git commit -m "Update submodule to track develop branch"
```

### 注意点
- `.gitmodules` で設定するブランチは、あくまでデフォルトで追従するブランチを指定するためのものであり、固定的にブランチを使用することを保証するものではありません。
- サブモジュールは、通常はコミットハッシュで固定されるので、親リポジトリをクローンした際にそのコミットが使用されます。
- `git submodule update --remote` を定期的に実行しない限り、サブモジュールは指定されたブランチの最新のコミットを自動的に取得しません。

以上の方法で、サブモジュールにブランチの追従を設定することができますが、常にそのブランチを使用したい場合は、手動で `git submodule update --remote` を実行するか、CI/CD パイプラインで設定するなどの工夫が必要です。

---

## 👤 ユーザー
*2024/10/16 20:08:05*

どうやったら固定できるのか？

---

## 🤖 アシスタント
*2024/10/16 20:08:40*

サブモジュールを特定の **コミット** や **ブランチ** に **固定** する場合、以下のように操作することでサブモジュールが指定したコミットに固定されます。サブモジュールは特定のブランチの最新コミットを追い続けるのではなく、**親リポジトリの状態で固定**されるため、他の開発者がリポジトリをクローンしたときにも同じコミットが使われます。

以下に、コミットハッシュまたはブランチをサブモジュールに固定する方法を説明します。

### サブモジュールを特定の **コミットハッシュ** に固定する方法

1. **サブモジュールディレクトリ** に移動します：

   ```bash
   cd shared-module-ios
   ```

2. **特定のコミット** にチェックアウトします（例としてコミットハッシュ `abc1234` に固定）：

   ```bash
   git checkout abc1234
   ```

3. 親リポジトリのルートに戻り、サブモジュールの変更を **ステージ** します：

   ```bash
   cd ..
   git add shared-module-ios
   ```

4. サブモジュールの固定を **コミット** します：

   ```bash
   git commit -m "Fix submodule shared-module-ios to commit abc1234"
   ```

5. 必要に応じて、リモートに **プッシュ** します：

   ```bash
   git push
   ```

これで、サブモジュールが **指定されたコミットハッシュ** に固定され、他の開発者がリポジトリをクローンしたり、`git submodule update` を実行したりすると、同じコミットが使用されます。

### サブモジュールを特定の **ブランチ** に固定する方法

**ブランチを固定**するという考え方は、実際にはサブモジュールを常に最新のブランチに追従させるというよりは、ブランチの一つの状態（つまりコミット）を固定する形になります。したがって、特定のブランチの最新状態を使用したい場合は、そのブランチの最新コミットをチェックアウトして、コミットを固定します。

1. **サブモジュールディレクトリ** に移動します：

   ```bash
   cd shared-module-ios
   ```

2. **特定のブランチ** にチェックアウトします（例として `develop` ブランチ）：

   ```bash
   git checkout develop
   ```

3. 必要に応じて、そのブランチの最新のコミットを取得します：

   ```bash
   git pull origin develop
   ```

4. 親リポジトリのルートに戻り、サブモジュールの状態を **ステージ** します：

   ```bash
   cd ..
   git add shared-module-ios
   ```

5. **コミット** してサブモジュールの状態を保存します：

   ```bash
   git commit -m "Update submodule to latest commit on develop branch"
   ```

6. リモートに **プッシュ** します：

   ```bash
   git push
   ```

この手順により、親リポジトリのサブモジュールは `develop` ブランチの最新のコミットに固定されます。クローンや `git submodule update` を行うと、指定したコミットハッシュが使われるようになります。

### まとめ

- **コミットハッシュを固定**したい場合は、指定のコミットにサブモジュールをチェックアウトしてコミットすることで実現できます。
- **ブランチの最新状態を使用**したい場合でも、実際にチェックアウトされるのは特定のコミットなので、その状態を固定することになります。
- サブモジュールのブランチを自動的に追従させたい場合は、`git submodule update --remote` コマンドを使用して最新コミットを取得しますが、これもコミットを親リポジトリに反映しない限り固定されません。

サブモジュールは常に親リポジトリで指定された **コミット** を参照するため、ブランチの自動追従ではなくコミット単位での固定が行われます。

---

## 👤 ユーザー
*2024/10/16 20:10:57*

いかに修正した後取り込みたい

\[submodule "shared-module-ios"\]
	path = shared-module-ios
	url = git@github.com:progrit/shared-module-ios.git
	submodule = feature/46

---

## 🤖 アシスタント
*2024/10/16 20:11:23*

`submodule` の `.gitmodules` ファイルにブランチ（例えば `feature/46`）を設定して、そのブランチを追従させることができますが、`.gitmodules` の記述は次のように修正します。`submodule` キーではなく `branch` キーを使います。

### `.gitmodules` の修正例

```plaintext
[submodule "shared-module-ios"]
	path = shared-module-ios
	url = git@github.com:progrit/shared-module-ios.git
	branch = feature/46
```

このように `branch` に `feature/46` を指定することで、サブモジュールが `feature/46` ブランチを追従します。

### 修正後の取り込み手順

1. **`.gitmodules` ファイルを修正**します（上記のように `branch` を追加）。

2. **サブモジュールの設定を更新**します：

   ```bash
   git submodule sync
   ```

3. **サブモジュールを更新**し、指定したブランチ（この場合 `feature/46`）の最新コミットを取得します：

   ```bash
   git submodule update --remote shared-module-ios
   ```

4. サブモジュールが `feature/46` ブランチの最新の状態になっているか確認します：

   ```bash
   cd shared-module-ios
   git branch  # 現在のブランチが feature/46 であることを確認
   ```

5. 親リポジトリに戻り、サブモジュールの変更をステージに追加してコミットします：

   ```bash
   cd ..
   git add .gitmodules shared-module-ios
   git commit -m "Update submodule shared-module-ios to track branch feature/46"
   ```

6. 最後に、リモートにプッシュします：

   ```bash
   git push
   ```

### 注意点

- 上記のように `branch = feature/46` を `.gitmodules` に追加することで、そのブランチを追従しますが、実際にはサブモジュールの **最新コミットが固定** されるため、常に最新のコミットを反映したい場合は `git submodule update --remote` を定期的に実行する必要があります。
- `.gitmodules` にブランチを指定することで、そのブランチの最新のコミットが自動でチェックアウトされますが、親リポジトリのコミットにはサブモジュールの **特定のコミットハッシュ** が保存されることを覚えておいてください。

この設定により、サブモジュールは常に `feature/46` ブランチを追い続け、最新のコミットを取得しますが、その状態を親リポジトリで明示的にコミットする必要があります。

---
