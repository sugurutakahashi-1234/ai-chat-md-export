# アンラップと条件評価

日付: 2024-08-20

---

## 👤 ユーザー
*2024/8/20 18:10:27*

ここをうまくアンラップしたい
$account
            .map {
                $0.nickname.isNotEmpty && $0.birthDay.isPast && $0.gender != .noSelect
            }
            .assign(to: &$isValid)

final class ProfileEditPresenter: ObservableObject {
    @Published var account: Account?

    /// 画像
    @Published var selectedImage: UIImage?

    @Published var isLoading: Bool = false
    @Published var appError: AppError?
    @Published var showAlert: Bool = false
    
    @Published var shouldDismiss: Bool = false
    
    @Published var isValid: Bool = false
    
    private let logDriver: any LogDriverProtocol
    private let apiRequestDriver: any ApiRequestDriverProtocol

    init(logDriver: any LogDriverProtocol = LogDriver(), apiRequestDriver: any ApiRequestDriverProtocol = ApiRequestDriver()) {
        self.logDriver = logDriver
        self.apiRequestDriver = apiRequestDriver

        logDriver.initLog()
        
        $account
            .map {
                $0.nickname.isNotEmpty && $0.birthDay.isPast && $0.gender != .noSelect
            }
            .assign(to: &$isValid)
    }
}

---

## 🤖 アシスタント
*2024/8/20 18:10:41*

`$account` はオプショナルのため、アンラップする必要があります。`map` 関数内でアンラップするためには、`guard let` や `if let` を使用するか、`flatMap` を使って安全にアンラップできます。ここでは、`flatMap` を使ってアンラップして、アンラップされた `Account` オブジェクトに対して条件を評価する方法を提案します。

以下のコードで `Account` を安全にアンラップし、条件をチェックすることができます：

```swift
$account
    .flatMap { account in
        Just(account?.nickname.isNotEmpty == true && account?.birthDay.isPast == true && account?.gender != .noSelect)
    }
    .assign(to: &$isValid)
```

このコードでは、`flatMap` を使ってオプショナルの `account` をアンラップし、`Just` を使って `Bool` 値を返します。`account` が `nil` の場合は `false` になります。`isValid` は `account` の状態に応じて自動的に更新されます。

これにより、オプショナルな `Account` を安全にアンラップしつつ、期待する動作を実現できます。

---

## 👤 ユーザー
*2024/8/20 18:11:30*

こんな感じにしたいんだけど

$account
            .flatMap { $0 }
            .map {
                $0.nickname.isNotEmpty && $0.birthDay.isPast && $0.gender != .noSelect
            }
            .assign(to: &$isValid)

---

## 🤖 アシスタント
*2024/8/20 18:11:41*

そのアプローチで進める場合、`$account` がオプショナルであるため、`flatMap` を使ってアンラップし、次に `map` を使って条件を評価することができます。以下のように実装できます：

```swift
$account
    .compactMap { $0 }  // Optional<Account> を Account にアンラップ
    .map {
        $0.nickname.isNotEmpty && $0.birthDay.isPast && $0.gender != .noSelect
    }
    .assign(to: &$isValid)
```

ここでは、`flatMap` の代わりに `compactMap` を使うことで、`nil` を除外し、アンラップされた `Account` オブジェクトに対して処理を進めています。`map` で条件を評価し、その結果を `isValid` にバインドします。

このアプローチは、`$account` が `nil` の場合には処理をスキップし、アンラップに成功した場合のみ条件を評価するという意図に沿っています。

---
