# サブスクリプション購入時刻取得

日付: 2024-09-27

---

## 👤 ユーザー
*2024/9/27 14:37:17*

SwiftでInAppでサブスクリプション購入情報の購入時刻を習得したい

---

## 🤖 アシスタント
*2024/9/27 14:37:29*

In-App Purchaseでサブスクリプションの購入情報を取得し、購入時刻を取得するには、`StoreKit`フレームワークを使います。具体的には、`StoreKit.Transaction`から購入日を取得できます。以下に、購入履歴からサブスクリプションの購入時刻を取得する例を示します。

### 手順:
1. サブスクリプションの購入履歴を取得
2. 該当するサブスクリプションの`purchaseDate`を取得

以下のコードでは、`StoreKit`を用いてサブスクリプションの購入情報を取得し、購入時刻を取得する例です。

```swift
import StoreKit

func fetchSubscriptionPurchaseDate() async throws -> Date? {
    // 購入履歴を取得
    let result = try await StoreKit.Transaction.latest(for: .currentUser)
    
    // サブスクリプションに関連するトランザクションをフィルタリング
    for transaction in result {
        switch transaction.productType {
        case .autoRenewable:
            // サブスクリプションの場合、購入日を取得
            return transaction.purchaseDate
        default:
            break
        }
    }
    return nil // サブスクリプションが見つからない場合
}
```

### 説明:
- `StoreKit.Transaction.latest(for:)` で現在のユーザーの購入履歴を取得します。
- `transaction.productType == .autoRenewable` で自動更新型のサブスクリプションをフィルタリングし、`transaction.purchaseDate` から購入日を取得します。

上記のコードを実行すると、サブスクリプションの購入時刻（`Date`型）を取得することができます。

もしも複数のサブスクリプションがある場合や、特定のプロダクトIDに紐付いた情報だけを取得したい場合は、さらにフィルタリングを行う必要があります。

---

## 👤 ユーザー
*2024/9/27 14:52:08*

そのアプリ内で有効になっているもので取得したいんだ

---

## 🤖 アシスタント
*2024/9/27 14:52:25*

有効なサブスクリプション情報を取得するには、`StoreKit2`の`Transaction`クラスや`StoreKit.Product.SubscriptionInfo`を使用して、有効なサブスクリプション（特に未終了のトランザクション）を確認できます。

`StoreKit.Transaction`の中で、有効なサブスクリプションを確認するためには、`isUpgraded`, `revocationDate`, `expirationDate` などをチェックして有効性を判断します。

以下は、有効なサブスクリプションの購入時刻を取得する方法の例です。

### 手順:
1. `StoreKit.Product.SubscriptionInfo.Status`を使用して、サブスクリプションのステータスを確認。
2. `expirationDate`や`isRevoked`などを確認して、有効なサブスクリプションを抽出。
3. 有効なサブスクリプションの購入時刻を取得。

### コード例:

```swift
import StoreKit

func fetchActiveSubscriptionPurchaseDate() async throws -> Date? {
    // 購入履歴を取得
    let result = try await StoreKit.Transaction.latest(for: .currentUser)
    
    // 購入履歴から有効なサブスクリプションのみをフィルタリング
    for transaction in result {
        switch transaction.productType {
        case .autoRenewable:
            if let expirationDate = transaction.expirationDate, expirationDate > Date() {
                // 有効なサブスクリプションの場合、購入日を返す
                return transaction.purchaseDate
            }
        default:
            break
        }
    }
    return nil // 有効なサブスクリプションが見つからない場合
}
```

### 説明:
- `StoreKit.Transaction.latest(for: .currentUser)` でユーザーの最新の購入履歴を取得します。
- 各トランザクションの`productType`を確認し、`autoRenewable`サブスクリプションのみをフィルタリングします。
- `expirationDate`でサブスクリプションの有効期限を確認し、現在の日付と比較して有効な場合のみ購入日を返します。

これにより、サブスクリプションが有効である場合、その購入日を取得できます。

### 補足:
- `expirationDate`が`nil`の場合は、永続的に有効なサブスクリプションと見なされることがありますが、通常のサブスクリプションではこの値が設定されます。
- また、サブスクリプションがアップグレード/ダウングレードされた場合は`isUpgraded`フラグをチェックすることで、古いトランザクションをスキップすることができます。

---

## 👤 ユーザー
*2024/9/27 15:19:46*

最新のサブスクライブ済みな Transaction を返すような関数の方がよくないか？

---

## 🤖 アシスタント
*2024/9/27 15:20:03*

User prefers a function that returns the latest subscribed `Transaction` for in-app purchases.

---

## 🔧 ツール
*2024/9/27 15:20:03*

Model set context updated.

---

## 🤖 アシスタント
*2024/9/27 15:20:03*

確かに、最新のサブスクリプション済みの`Transaction`を返す関数を作成する方が、再利用しやすく、よりシンプルに目的を達成できるかもしれません。以下に、最新のサブスクライブされた`Transaction`を返す関数の例を示します。

### 最新のサブスクライブ済みトランザクションを返す関数

```swift
import StoreKit

func fetchLatestSubscribedTransaction() async throws -> StoreKit.Transaction? {
    // 購入履歴を取得
    let result = try await StoreKit.Transaction.latest(for: .currentUser)
    
    // サブスクリプションの購入履歴の中で最新かつ有効なトランザクションをフィルタリング
    for transaction in result {
        switch transaction.productType {
        case .autoRenewable:
            // サブスクリプションの有効期限を確認
            if let expirationDate = transaction.expirationDate, expirationDate > Date() {
                // 有効なサブスクリプションを返す
                return transaction
            }
        default:
            break
        }
    }
    return nil // 有効なサブスクリプションが見つからない場合
}
```

### 使用例

この関数を使って、サブスクライブ済みのトランザクションを取得し、その購入日を取得する方法です。

```swift
Task {
    do {
        if let transaction = try await fetchLatestSubscribedTransaction() {
            let purchaseDate = transaction.purchaseDate
            print("最新の購入日: \(purchaseDate)")
        } else {
            print("有効なサブスクリプションは見つかりませんでした。")
        }
    } catch {
        print("エラーが発生しました: \(error)")
    }
}
```

### 説明:
- `fetchLatestSubscribedTransaction`関数は、ユーザーの購入履歴をチェックし、有効なサブスクリプションのトランザクションを返します。
- `transaction.expirationDate`でサブスクリプションがまだ有効かどうかを確認します。
- サブスクリプションが有効であれば、そのトランザクションを返します。

このアプローチにより、サブスクライブ済みかつ有効な`Transaction`を簡単に取得でき、再利用がしやすくなります。

---

## 👤 ユーザー
*2024/9/27 15:20:25*

有効なトランザクションが複数ある場合はどうなのか？

func fetchLatestSubscribedTransaction() async throws -&gt; StoreKit.Transaction? {
    // 購入履歴を取得
    let result = try await StoreKit.Transaction.latest(for: .currentUser)
    
    // サブスクリプションの購入履歴の中で最新かつ有効なトランザクションをフィルタリング
    for transaction in result {
        switch transaction.productType {
        case .autoRenewable:
            // サブスクリプションの有効期限を確認
            if let expirationDate = transaction.expirationDate, expirationDate &gt; Date() {
                // 有効なサブスクリプションを返す
                return transaction
            }
        default:
            break
        }
    }
    return nil // 有効なサブスクリプションが見つからない場合
}

---

## 🤖 アシスタント
*2024/9/27 15:20:40*

有効なサブスクリプションのトランザクションが複数ある場合、それらの中で最も新しいトランザクションを返すことが望ましいです。現在のコードでは、最初に見つかった有効なトランザクションを返していますが、複数のサブスクリプションがある場合、最新のものを取得するために、トランザクションを日付で比較する必要があります。

以下に、有効なサブスクリプションが複数ある場合に最新のものを取得する方法を示します。

### 最新のサブスクライブ済みトランザクションを返す（複数の有効トランザクションに対応）

```swift
import StoreKit

func fetchLatestSubscribedTransaction() async throws -> StoreKit.Transaction? {
    // 購入履歴を取得
    let result = try await StoreKit.Transaction.latest(for: .currentUser)
    
    // サブスクリプションの有効なトランザクションをすべてフィルタリング
    let validTransactions = result.filter { transaction in
        switch transaction.productType {
        case .autoRenewable:
            if let expirationDate = transaction.expirationDate {
                // 有効期限が現在時刻より後であれば有効とみなす
                return expirationDate > Date()
            }
        default:
            break
        }
        return false
    }
    
    // 最新のトランザクションを返す
    return validTransactions.max(by: { $0.purchaseDate < $1.purchaseDate })
}
```

### 説明:
- `result.filter`を使って、有効なサブスクリプションのトランザクションのみを抽出しています。
- `expirationDate`が現在の日付よりも後である場合、そのトランザクションは有効とみなされます。
- 複数の有効なトランザクションがある場合、`max(by:)`を使って、`purchaseDate`が最も新しいトランザクションを取得します。

### 使用例

この関数を使って、最新のサブスクライブ済みトランザクションを取得できます。

```swift
Task {
    do {
        if let transaction = try await fetchLatestSubscribedTransaction() {
            let purchaseDate = transaction.purchaseDate
            print("最新の購入日: \(purchaseDate)")
        } else {
            print("有効なサブスクリプションは見つかりませんでした。")
        }
    } catch {
        print("エラーが発生しました: \(error)")
    }
}
```

これにより、複数の有効なサブスクリプションがあっても、常に最新のものを返すことができます。

---

## 👤 ユーザー
*2024/9/27 15:22:09*

autoRenewable とは

---

## 🤖 アシスタント
*2024/9/27 15:22:27*

`autoRenewable` は、`StoreKit` フレームワークで使われる `Product.ProductType` の一つで、自動更新型のサブスクリプション（Auto-Renewable Subscription）を指します。これは、定期的にユーザーに課金されるサブスクリプションで、ユーザーがキャンセルしない限り、自動的に更新されるものです。

### 自動更新型サブスクリプション (Auto-Renewable Subscription) の特徴
- **自動更新**: サブスクリプション期間が終了すると、自動的に次の期間に更新され、課金が発生します。
- **ユーザー管理**: ユーザーはApp Storeの設定でサブスクリプションを管理およびキャンセルできます。
- **サブスクリプション期間**: サブスクリプションの期間は、開発者が選んだ期間（例えば1週間、1ヶ月、3ヶ月、1年）ごとに更新されます。
- **App Storeでの管理**: サブスクリプションの購入、更新、キャンセルなどはすべてApp Storeによって管理されます。

### 主な用途
自動更新型サブスクリプションは、ニュースアプリ、音楽・動画ストリーミングサービス、フィットネスアプリ、教育アプリなど、定期的にコンテンツやサービスを提供するアプリでよく使用されます。

### 例: 
例えば、SpotifyやNetflixなどのサービスは自動更新型サブスクリプションを利用しています。ユーザーは1ヶ月単位で料金が自動的に課金され、特別な操作を行わない限り、次の月もサブスクリプションが継続します。

### `ProductType.autoRenewable` の使用
Swiftでサブスクリプションを扱う際には、サブスクリプションのプロダクトが自動更新型かどうかを確認するために、`ProductType.autoRenewable`を使用します。

#### 例:
```swift
switch transaction.productType {
case .autoRenewable:
    print("このトランザクションは自動更新型サブスクリプションです。")
default:
    break
}
```

このコードでは、`transaction.productType` が `.autoRenewable` であるかどうかを確認し、自動更新型サブスクリプションに対してのみ特定の処理を行うことができます。

---

## 👤 ユーザー
*2024/9/27 15:22:58*

そんざいしないのだが

try await StoreKit.Transaction.latest(for: .currentUser)

---

## 🤖 アシスタント
*2024/9/27 15:23:15*

`StoreKit.Transaction.latest(for:)` は、`StoreKit2`のAPIですが、最新の`Transaction`を取得するメソッドが`latest(for:)`として直接存在しない場合、代替の方法として、`StoreKit.Transaction.all`を使って、購入履歴全体を取得し、その中から最新のものをフィルタリングすることができます。

以下は、`StoreKit2`を使用して最新のサブスクリプション情報を取得する方法の例です。

### 代替コード例（`all(for:)`を使用）

```swift
import StoreKit

func fetchLatestSubscribedTransaction() async throws -> StoreKit.Transaction? {
    // 現在のユーザーのすべての購入履歴を取得
    let result = try await StoreKit.Transaction.all(for: .currentUser)
    
    // サブスクリプションの有効なトランザクションをフィルタリング
    let validTransactions = result.compactMap { transaction in
        if transaction.productType == .autoRenewable, 
           let expirationDate = transaction.expirationDate,
           expirationDate > Date() {
            // 有効なサブスクリプションを返す
            return transaction
        }
        return nil
    }
    
    // 最新のトランザクションを取得
    return validTransactions.max(by: { $0.purchaseDate < $1.purchaseDate })
}
```

### 説明:
- `StoreKit.Transaction.all(for:)` は、指定したユーザーのすべての購入履歴を取得します。
- `compactMap` を使って、`autoRenewable` タイプのトランザクションをフィルタリングし、`expirationDate`が現在より後の有効なサブスクリプションのみを残します。
- 最後に、`purchaseDate`が最も新しいトランザクションを返します。

### 使用例

```swift
Task {
    do {
        if let transaction = try await fetchLatestSubscribedTransaction() {
            let purchaseDate = transaction.purchaseDate
            print("最新の購入日: \(purchaseDate)")
        } else {
            print("有効なサブスクリプションは見つかりませんでした。")
        }
    } catch {
        print("エラーが発生しました: \(error)")
    }
}
```

### 補足:
- `StoreKit.Transaction.all(for:)` を使用して、すべてのトランザクションを取得した後、特定のフィルタリングを行う必要があります。
- `autoRenewable` や有効期限 (`expirationDate`) を使ってフィルタリングし、最も新しい有効なサブスクリプションを選びます。

この方法により、最新のサブスクリプション情報を取得できます。

---
