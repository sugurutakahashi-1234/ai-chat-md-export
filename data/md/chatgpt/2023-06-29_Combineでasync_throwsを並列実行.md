# Combineã§async throwsã‚’ä¸¦åˆ—å®Ÿè¡Œ

æ—¥ä»˜: 2023-06-29

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2023/6/29 9:02:44*

Swiftã®Combineã§mapå‡¦ç†ã§async throwsé–¢æ•°ã‚’å‘¼ã³å‡ºã™ã¨ãã«ä¸¦åˆ—ã§å®Ÿè¡Œã—ãŸã„

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2023/6/29 9:03:26*

Swiftã®Combineãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã¯ã€éåŒæœŸå‡¦ç†ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’çµ„ã¿åˆã‚ã›ã¦éå¸¸ã«æŸ”è»Ÿãªãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã—ã‹ã—ã€Combineã¯åŸºæœ¬çš„ã«ç›´åˆ—ã®å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚ç›´æ¥çš„ã«ä¸¦åˆ—å‡¦ç†ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½ã¯æä¾›ã—ã¦ã„ã¾ã›ã‚“ã€‚

ãã®ãŸã‚ã€ä¸¦åˆ—ã«å®Ÿè¡Œã—ãŸã„å ´åˆã¯ã€ä¸€éƒ¨è‡ªåˆ†ã§ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã®ä¾‹ã§ã¯ã€éåŒæœŸã§ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹é–¢æ•°`asyncThrowsFunction()`ã‚’Combineã®`flatMap`æ¼”ç®—å­ã‚’ç”¨ã„ã¦ä¸¦åˆ—ã«å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚`flatMap`ã¯å„å‡ºåŠ›ã«å¯¾ã—ã¦éåŒæœŸã®å‡¦ç†ã‚’è¡Œã„ã€ãã®çµæœã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«ãƒ•ãƒ©ãƒƒãƒˆåŒ–ã—ã¾ã™ã€‚ä¸¦åˆ—åŒ–ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã«ã€`maxPublishers`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

ã“ã®ä¾‹ã§ã¯ã€`DispatchQueue.global().async`ã‚’ä½¿ç”¨ã—ã¦ã€éåŒæœŸã®ã‚¿ã‚¹ã‚¯ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã‚­ãƒ¥ãƒ¼ã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ã€çµæœã‚’`Future`ã¨ã—ã¦è¿”ã™é–¢æ•°`asyncToFuture`ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€éåŒæœŸã®ã‚¿ã‚¹ã‚¯ãŒä¸¦åˆ—ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```swift
import Combine
import Foundation

func asyncThrowsFunction(input: Int) async throws -> String {
    // ã“ã“ã§ä½•ã‚‰ã‹ã®éåŒæœŸæ“ä½œã‚’è¡Œã„ã¾ã™
}

func asyncToFuture(input: Int) -> Future<String, Error> {
    Future { promise in
        DispatchQueue.global().async {
            do {
                let result = try await asyncThrowsFunction(input: input)
                promise(.success(result))
            } catch {
                promise(.failure(error))
            }
        }
    }
}

let publisher = [1, 2, 3, 4, 5].publisher
publisher
    .flatMap(maxPublishers: .max(2)) { input in
        asyncToFuture(input: input)
    }
    .sink(receiveCompletion: { completion in
        switch completion {
        case .failure(let error):
            print("Error: \(error)")
        case .finished:
            print("Finished")
        }
    }, receiveValue: { value in
        print("Received value: \(value)")
    })
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€`asyncThrowsFunction()`ã‚’ä¸¦åˆ—ã«å‘¼ã³å‡ºã—ã€ãã®çµæœã‚’å‡ºåŠ›ã—ã¾ã™ã€‚æœ€å¤§ã®ä¸¦åˆ—å®Ÿè¡Œæ•°ã¯`maxPublishers`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§åˆ¶å¾¡ã—ã¾ã™ã€‚ã“ã®ä¾‹ã§ã¯ã€æœ€å¤§2ã¤ã®éåŒæœŸã‚¿ã‚¹ã‚¯ãŒåŒæ™‚ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ãŸã ã—ã€CombineãŒç›´æ¥çš„ã«ä¸¦åˆ—å‡¦ç†ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ãŸã‚ã€ã“ã®æ–¹æ³•ã¯ã„ãã¤ã‹ã®åˆ¶ç´„ãŒã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°ã€éåŒæœŸã®ã‚¿ã‚¹ã‚¯ãŒã©ã®é †åºã§å®Œäº†ã™ã‚‹ã‹ã¯ä¿è¨¼ã•ã‚Œã¾ã›ã‚“ã€‚ã•ã‚‰ã«ã€éåŒæœŸã®ã‚¿ã‚¹ã‚¯ãŒä¸€åº¦ã«ã„ãã¤å®Ÿè¡Œã•ã‚Œã‚‹ã‹ã‚’æ­£

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2023/6/29 9:03:48*

ç¢ºã«åˆ¶å¾¡ã™ã‚‹ã“ã¨ã¯å›°é›£ã§ã™ã€‚ã“ã®åˆ¶ç´„ã‚’å—ã‘å…¥ã‚Œã‚‹ã‹ã€ã¾ãŸã¯ä»–ã®ãƒ„ãƒ¼ãƒ«ï¼ˆä¾‹ãˆã°ã€Operation Queuesã‚„GCDãªã©ï¼‰ã‚’ä½¿ã£ã¦ä¸¦åˆ—å‡¦ç†ã‚’è¡Œã†ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚

---
