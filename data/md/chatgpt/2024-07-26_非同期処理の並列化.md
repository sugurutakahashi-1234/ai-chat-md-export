# 非同期処理の並列化

日付: 2024-07-26

---

## 👤 ユーザー
*2024/07/26 14:12:02*

以下を並列で処理させたい

    func onAppear() async {
        dependency.logDriver.onAppearLog()
        
        isLoading = true
        defer {
            isLoading = false
        }

        do {
            account  = try await dependency.apiRequestDriver.getAccount()
        } catch {
            dependency.logDriver.errorLog("\(error)")
            appError = error.toAppError
            showAlert = true
        }
        
        do {
            talkThreads  = try await dependency.apiRequestDriver.getTalkThreads()
        } catch {
            dependency.logDriver.errorLog("\(error)")
            appError = error.toAppError
            showAlert = true
        }
    }

---

## 🤖 アシスタント
*2024/07/26 14:12:10*

並列処理を行うためには、`TaskGroup` を使用することで、複数の非同期タスクを同時に実行し、それぞれの結果を待つことができます。以下に並列処理を実装したコードを示します。

```swift
func onAppear() async {
    dependency.logDriver.onAppearLog()

    isLoading = true
    defer {
        isLoading = false
    }

    await withTaskGroup(of: Void.self) { taskGroup in
        taskGroup.addTask {
            do {
                account = try await dependency.apiRequestDriver.getAccount()
            } catch {
                dependency.logDriver.errorLog("\(error)")
                appError = error.toAppError
                showAlert = true
            }
        }
        
        taskGroup.addTask {
            do {
                talkThreads = try await dependency.apiRequestDriver.getTalkThreads()
            } catch {
                dependency.logDriver.errorLog("\(error)")
                appError = error.toAppError
                showAlert = true
            }
        }
    }
}
```

このコードでは、`withTaskGroup` を使用してタスクグループを作成し、その中で `getAccount` と `getTalkThreads` の呼び出しを並列に実行します。それぞれのタスクがエラーを処理し、ログを出力し、エラーメッセージを表示する処理を行っています。これにより、両方の非同期処理が並列に実行され、全体の処理時間が短縮されます。

---

## 👤 ユーザー
*2024/07/26 14:12:32*

もっと簡単にできないの？

---

## 🤖 アシスタント
*2024/07/26 14:12:38*

並列処理をさらに簡単に実装するために、`async let` を使用することができます。これにより、複数の非同期操作を並行して実行し、それらの結果を待つことができます。以下に簡略化されたコードを示します。

```swift
func onAppear() async {
    dependency.logDriver.onAppearLog()

    isLoading = true
    defer {
        isLoading = false
    }

    do {
        async let accountResult = dependency.apiRequestDriver.getAccount()
        async let talkThreadsResult = dependency.apiRequestDriver.getTalkThreads()
        
        account = try await accountResult
        talkThreads = try await talkThreadsResult
    } catch {
        dependency.logDriver.errorLog("\(error)")
        appError = error.toAppError
        showAlert = true
    }
}
```

この方法では、`async let` を使って `getAccount` と `getTalkThreads` の呼び出しを並行して実行し、それぞれの結果を `await` で待ちます。どちらかのタスクでエラーが発生した場合、キャッチブロックでエラーを処理します。この方法により、並列処理がさらにシンプルに実装できます。

---
