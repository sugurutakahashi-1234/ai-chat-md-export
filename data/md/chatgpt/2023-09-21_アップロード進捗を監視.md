# ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é€²æ—ã‚’ç›£è¦–

æ—¥ä»˜: 2023-09-21

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2023/9/21 15:59:57*

public class AmplifyStorageManager: CloudStorageManagerProtocol {
    public init() {}

    public func upload(key: String, data: Data) async throws {
        do {
            LoggerContainer.log(.startUpload(.init(key: key)))
            let uploadTask = Amplify.Storage.uploadData(key: key, data: data)

            Task {
                for await progress in await uploadTask.progress {
                    LoggerContainer.debugLog("Upload progress: \(progress.fractionCompleted * 100)%")
                }
            }

            let result = try await uploadTask.value
            LoggerContainer.log(.endUpload(.init(key: key, result: result)))
            LoggerContainer.debugLog("Completed: \(result)")
        } catch {
            LoggerContainer.logError("Failed to upload data: \(error)")
            throw error
        }
    }
}
ã“ã®uploadé–¢æ•°ã‚’é€²æ—çŠ¶æ³ãŒã‚ã‹ã‚‹ã‚ˆã†ã«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä¿®æ­£ã—ãŸã„ã€‚
ã©ã†ã™ã‚Œã°ã„ã„ã‹ï¼Ÿ

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2023/9/21 16:01:03*

ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®é€²æ—çŠ¶æ³ã‚’ä»–ã®ã‚¯ãƒ©ã‚¹ã‚„æ©Ÿèƒ½ã‹ã‚‰çŸ¥ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã€ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ï¼ˆClosureï¼‰ã€ãƒ‡ãƒªã‚²ãƒ¼ãƒˆï¼ˆDelegateï¼‰ã¾ãŸã¯ã‚³ãƒ³ãƒ“ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’åˆ©ç”¨ã§ãã¾ã™ã€‚ä»¥ä¸‹ã«ã€ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã¨ãƒ‡ãƒªã‚²ãƒ¼ãƒˆã‚’åˆ©ç”¨ã—ãŸä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚

### 1. ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã‚’ä½¿ç”¨ã™ã‚‹

é€²æ—ã‚’é€šçŸ¥ã™ã‚‹ãŸã‚ã®ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã‚’å¼•æ•°ã¨ã—ã¦è¿½åŠ ã§ãã¾ã™ã€‚

```swift
public func upload(key: String, data: Data, progress: @escaping (Double) -> Void) async throws {
    do {
        let uploadTask = Amplify.Storage.uploadData(key: key, data: data)

        Task {
            for await progressValue in await uploadTask.progress {
                let fractionCompleted = progressValue.fractionCompleted * 100
                LoggerContainer.debugLog("Upload progress: \(fractionCompleted)%")
                progress(fractionCompleted)
            }
        }

        let result = try await uploadTask.value
        LoggerContainer.debugLog("Completed: \(result)")
    } catch {
        LoggerContainer.logError("Failed to upload data: \(error)")
        throw error
    }
}
```

### 2. ãƒ‡ãƒªã‚²ãƒ¼ãƒˆã‚’ä½¿ç”¨ã™ã‚‹

ãƒ‡ãƒªã‚²ãƒ¼ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç”¨ã„ã¦é€²æ—çŠ¶æ³ã‚’ä¼ãˆã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

1. ãƒ‡ãƒªã‚²ãƒ¼ãƒˆãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’å®šç¾©ã—ã¾ã™ã€‚
```swift
protocol AmplifyStorageManagerDelegate: AnyObject {
    func uploadProgress(_ progress: Double)
}
```

2. `AmplifyStorageManager`ã§ãƒ‡ãƒªã‚²ãƒ¼ãƒˆã‚’ä¿æŒã—ã¾ã™ã€‚
```swift
public class AmplifyStorageManager: CloudStorageManagerProtocol {
    weak var delegate: AmplifyStorageManagerDelegate?

    // ...
}
```

3. ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é€²æ—æ™‚ã«ãƒ‡ãƒªã‚²ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
```swift
public func upload(key: String, data: Data) async throws {
    do {
        let uploadTask = Amplify.Storage.uploadData(key: key, data: data)

        Task {
            for await progressValue in await uploadTask.progress {
                let fractionCompleted = progressValue.fractionCompleted * 100
                LoggerContainer.debugLog("Upload progress: \(fractionCompleted)%")
                delegate?.uploadProgress(fractionCompleted)
            }
        }

        let result = try await uploadTask.value
        LoggerContainer.debugLog("Completed: \(result)")
    } catch {
        LoggerContainer.logError("Failed to upload data: \(error)")
        throw error
    }
}
```

### 3. ä½¿ç”¨æ–¹æ³•
å‘¼ã³å‡ºã—å´ã§ã¯ã€é¸æŠã—ãŸæ–¹æ³•ã«åŸºã¥ã„ã¦é€²æ—çŠ¶æ³ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã®å ´åˆï¼š
```swift
let manager = AmplifyStorageManager()
do {
    try await manager.upload(key: "someKey", data: someData) { progress in
        print("Upload progress: \(progress)%")
    }
} catch {
    print("Error: \(error)")
}
```

ãƒ‡ãƒªã‚²ãƒ¼ãƒˆã®å ´åˆï¼š
```swift
class SomeClass: AmplifyStorageManagerDelegate {
    func startUpload() {
        let manager = AmplifyStorageManager()
        manager.delegate = self
        do {
            try await manager.upload(key: "someKey", data: someData)
        } catch {
            print("Error: \(error)")
        }
    }

    func uploadProgress(_ progress: Double) {
        print("Upload progress: \(progress)%")
    }
}
```

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2023/9/21 16:01:31*

ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã¯å¾®å¦™ã ã¨æ€ã†ã€‚
ã‚„ã‚ŠãŸã„ã“ã¨ã¨ã—ã¦ã¯AsyncSequenceã¿ãŸã„ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½¿ã„ãŸã„ã€‚

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2023/9/21 16:02:15*

`AsyncSequence`ã‚’åˆ©ç”¨ã—ã¦ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®é€²æ—ã‚’ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¨ã—ã¦æä¾›ã—ãŸã„å ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚«ã‚¹ã‚¿ãƒ ã®`AsyncSequence`ã‚’ä½œæˆã§ãã¾ã™ã€‚

### 1. ProgressPublisherã®ä½œæˆ
é€²æ—ã‚’å ±å‘Šã™ã‚‹ãŸã‚ã®ã‚«ã‚¹ã‚¿ãƒ `AsyncSequence`ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ã€é€²æ—ãŒå¤–éƒ¨ã‹ã‚‰éåŒæœŸã«ç›£è¦–ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```swift
struct ProgressPublisher: AsyncSequence {
    typealias Element = Double
    typealias AsyncIterator = ProgressIterator
    
    let uploadTask: UploadTask // UploadTask should conform to AsyncSequence
    
    func makeAsyncIterator() -> ProgressIterator {
        return ProgressIterator(task: uploadTask)
    }
}

struct ProgressIterator: AsyncIteratorProtocol {
    typealias Element = Double
    
    let task: UploadTask // Assume UploadTask has progress property that is AsyncSequence
    
    mutating func next() async throws -> Double? {
        for await progress in task.progress {
            return progress.fractionCompleted * 100
        }
        return nil
    }
}
```

### 2. AmplifyStorageManagerã®ä¿®æ­£
æ¬¡ã«ã€`AmplifyStorageManager`ã®`upload`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã“ã®æ–°ã—ã„`ProgressPublisher`ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

```swift
public class AmplifyStorageManager: CloudStorageManagerProtocol {
    public init() {}
    
    public func upload(key: String, data: Data) async throws -> ProgressPublisher {
        let uploadTask = Amplify.Storage.uploadData(key: key, data: data)
        return ProgressPublisher(uploadTask: uploadTask)
    }
}
```

### 3. ä½¿ç”¨æ–¹æ³•
ã“ã‚Œã§ã€å‘¼ã³å‡ºã—å´ã§é€²æ—ã‚’`AsyncSequence`ã¨ã—ã¦æ‰±ã†ã“ã¨ãŒã§ãã¾ã™ã€‚

```swift
let manager = AmplifyStorageManager()

do {
    let progressPublisher = try await manager.upload(key: "someKey", data: someData)
    
    for await progress in progressPublisher {
        print("Upload progress: \(progress)%")
    }
    
    print("Upload Completed!")
} catch {
    print("Error: \(error)")
}
```

ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã‚ã‚Œã°ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯é€²æ—ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ç°¡å˜ã«ç›£è¦–ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

---
