# アップロード進捗を監視

日付: 2023-09-21

---

## 👤 ユーザー
*2023/9/21 15:59:57*

public class AmplifyStorageManager: CloudStorageManagerProtocol {
    public init() {}

    public func upload(key: String, data: Data) async throws {
        do {
            LoggerContainer.log(.startUpload(.init(key: key)))
            let uploadTask = Amplify.Storage.uploadData(key: key, data: data)

            Task {
                for await progress in await uploadTask.progress {
                    LoggerContainer.debugLog("Upload progress: \(progress.fractionCompleted * 100)%")
                }
            }

            let result = try await uploadTask.value
            LoggerContainer.log(.endUpload(.init(key: key, result: result)))
            LoggerContainer.debugLog("Completed: \(result)")
        } catch {
            LoggerContainer.logError("Failed to upload data: \(error)")
            throw error
        }
    }
}
このupload関数を進捗状況がわかるようにインターフェースを修正したい。
どうすればいいか？

---

## 🤖 アシスタント
*2023/9/21 16:01:03*

アップロードの進捗状況を他のクラスや機能から知ることができるようにするために、クロージャ（Closure）、デリゲート（Delegate）またはコンビネーションフレームワークを利用できます。以下に、クロージャとデリゲートを利用した例を示します。

### 1. クロージャを使用する

進捗を通知するためのクロージャを引数として追加できます。

```swift
public func upload(key: String, data: Data, progress: @escaping (Double) -> Void) async throws {
    do {
        let uploadTask = Amplify.Storage.uploadData(key: key, data: data)

        Task {
            for await progressValue in await uploadTask.progress {
                let fractionCompleted = progressValue.fractionCompleted * 100
                LoggerContainer.debugLog("Upload progress: \(fractionCompleted)%")
                progress(fractionCompleted)
            }
        }

        let result = try await uploadTask.value
        LoggerContainer.debugLog("Completed: \(result)")
    } catch {
        LoggerContainer.logError("Failed to upload data: \(error)")
        throw error
    }
}
```

### 2. デリゲートを使用する

デリゲートパターンを用いて進捗状況を伝えることもできます。

1. デリゲートプロトコルを定義します。
```swift
protocol AmplifyStorageManagerDelegate: AnyObject {
    func uploadProgress(_ progress: Double)
}
```

2. `AmplifyStorageManager`でデリゲートを保持します。
```swift
public class AmplifyStorageManager: CloudStorageManagerProtocol {
    weak var delegate: AmplifyStorageManagerDelegate?

    // ...
}
```

3. アップロード進捗時にデリゲートメソッドを呼び出します。
```swift
public func upload(key: String, data: Data) async throws {
    do {
        let uploadTask = Amplify.Storage.uploadData(key: key, data: data)

        Task {
            for await progressValue in await uploadTask.progress {
                let fractionCompleted = progressValue.fractionCompleted * 100
                LoggerContainer.debugLog("Upload progress: \(fractionCompleted)%")
                delegate?.uploadProgress(fractionCompleted)
            }
        }

        let result = try await uploadTask.value
        LoggerContainer.debugLog("Completed: \(result)")
    } catch {
        LoggerContainer.logError("Failed to upload data: \(error)")
        throw error
    }
}
```

### 3. 使用方法
呼び出し側では、選択した方法に基づいて進捗状況を受け取ります。

クロージャの場合：
```swift
let manager = AmplifyStorageManager()
do {
    try await manager.upload(key: "someKey", data: someData) { progress in
        print("Upload progress: \(progress)%")
    }
} catch {
    print("Error: \(error)")
}
```

デリゲートの場合：
```swift
class SomeClass: AmplifyStorageManagerDelegate {
    func startUpload() {
        let manager = AmplifyStorageManager()
        manager.delegate = self
        do {
            try await manager.upload(key: "someKey", data: someData)
        } catch {
            print("Error: \(error)")
        }
    }

    func uploadProgress(_ progress: Double) {
        print("Upload progress: \(progress)%")
    }
}
```

---

## 👤 ユーザー
*2023/9/21 16:01:31*

クロージャは微妙だと思う。
やりたいこととしてはAsyncSequenceみたいなインターフェースを使いたい。

---

## 🤖 アシスタント
*2023/9/21 16:02:15*

`AsyncSequence`を利用して、アップロードの進捗をストリームとして提供したい場合、以下のようにカスタムの`AsyncSequence`を作成できます。

### 1. ProgressPublisherの作成
進捗を報告するためのカスタム`AsyncSequence`を作成します。これによって、進捗が外部から非同期に監視できるようになります。

```swift
struct ProgressPublisher: AsyncSequence {
    typealias Element = Double
    typealias AsyncIterator = ProgressIterator
    
    let uploadTask: UploadTask // UploadTask should conform to AsyncSequence
    
    func makeAsyncIterator() -> ProgressIterator {
        return ProgressIterator(task: uploadTask)
    }
}

struct ProgressIterator: AsyncIteratorProtocol {
    typealias Element = Double
    
    let task: UploadTask // Assume UploadTask has progress property that is AsyncSequence
    
    mutating func next() async throws -> Double? {
        for await progress in task.progress {
            return progress.fractionCompleted * 100
        }
        return nil
    }
}
```

### 2. AmplifyStorageManagerの修正
次に、`AmplifyStorageManager`の`upload`メソッドでこの新しい`ProgressPublisher`を利用します。

```swift
public class AmplifyStorageManager: CloudStorageManagerProtocol {
    public init() {}
    
    public func upload(key: String, data: Data) async throws -> ProgressPublisher {
        let uploadTask = Amplify.Storage.uploadData(key: key, data: data)
        return ProgressPublisher(uploadTask: uploadTask)
    }
}
```

### 3. 使用方法
これで、呼び出し側で進捗を`AsyncSequence`として扱うことができます。

```swift
let manager = AmplifyStorageManager()

do {
    let progressPublisher = try await manager.upload(key: "someKey", data: someData)
    
    for await progress in progressPublisher {
        print("Upload progress: \(progress)%")
    }
    
    print("Upload Completed!")
} catch {
    print("Error: \(error)")
}
```

このアプローチであれば、クライアントは進捗のストリームを簡単に監視できるようになります。

---
