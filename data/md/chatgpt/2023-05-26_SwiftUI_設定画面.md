# SwiftUI 設定画面

日付: 2023-05-26

---

## 👤 ユーザー
*2023/05/26 18:41:29*

SwiftUIでアプリを開発しているけど以下の画面を作成してほし
- 通知のオン/OFF をトグルで制御
- カメラの許諾のON/OFFをトグルで制御
- それぞれ設定しているかどうかは設定アプリの値を反映する

---

## 🤖 アシスタント
*2023/05/26 18:42:23*

SwiftUIを使って設定画面を作る場合は、以下のようなコードを使うことができます。しかし、アプリの通知やカメラ許可の設定は、設定アプリからしか変更できません。それぞれの設定が有効化されているかどうかを確認するためのAPIがiOSには存在しますが、それをトグルで切り替えることは許可されていません。

```swift
import SwiftUI

struct SettingsView: View {
    @State private var notificationsEnabled: Bool = UserDefaults.standard.bool(forKey: "notifications")
    @State private var cameraPermissionEnabled: Bool = AVCaptureDevice.authorizationStatus(for: .video) == .authorized

    var body: some View {
        NavigationView {
            Form {
                Toggle(isOn: $notificationsEnabled) {
                    Text("通知")
                }
                .onChange(of: notificationsEnabled) { value in
                    // Change your settings here
                    UserDefaults.standard.set(value, forKey: "notifications")
                }

                Toggle(isOn: $cameraPermissionEnabled) {
                    Text("カメラの許諾")
                }
                .disabled(true)
                .onChange(of: cameraPermissionEnabled) { value in
                    // Change your settings here
                    // This is not allowed by Apple. You can only request permissions, not revoke them.
                }
            }
            .navigationBarTitle("設定")
        }
    }
}

struct SettingsView_Previews: PreviewProvider {
    static var previews: some View {
        SettingsView()
    }
}
```

このコードは、UserDefaultsに保存された通知設定を表示し、変更を可能にします。しかし、カメラの許諾設定については、現在の設定状態を表示するだけで、変更することはできません（トグルは無効化されています）。

通知やカメラの設定を変更するには、ユーザーに対して設定アプリを開いて変更するよう案内する必要があります。これはアプリ内からリンクを提供することで実現できます。

---

## 👤 ユーザー
*2023/05/26 18:42:56*

ユーザーデフォルトには保存しないでいいよ、両方ともトグルをタップしたら設定アプリにとばしてほしい。設定アプリで許可して、アプリにもどったら、設定状態を更新してほしい

---

## 🤖 アシスタント
*2023/05/26 18:44:19*

アプリの通知やカメラ許諾設定を開くために、ユーザーを設定アプリに誘導し、その後の設定の更新を反映させるためには以下のようなコードを書くことができます。

```swift
import SwiftUI
import AVFoundation
import UserNotifications

struct SettingsView: View {
    @State private var notificationsEnabled: Bool = false
    @State private var cameraPermissionEnabled: Bool = AVCaptureDevice.authorizationStatus(for: .video) == .authorized

    var body: some View {
        NavigationView {
            Form {
                Button(action: {
                    openAppSettings()
                    checkNotifications()
                }) {
                    HStack {
                        Text("通知")
                        Spacer()
                        if notificationsEnabled {
                            Text("On")
                                .foregroundColor(.blue)
                        } else {
                            Text("Off")
                                .foregroundColor(.red)
                        }
                    }
                }

                Button(action: {
                    openAppSettings()
                    checkCameraPermission()
                }) {
                    HStack {
                        Text("カメラの許諾")
                        Spacer()
                        if cameraPermissionEnabled {
                            Text("On")
                                .foregroundColor(.blue)
                        } else {
                            Text("Off")
                                .foregroundColor(.red)
                        }
                    }
                }
            }
            .navigationBarTitle("設定")
            .onAppear {
                checkNotifications()
                checkCameraPermission()
            }
        }
    }

    private func openAppSettings() {
        guard let settingsUrl = URL(string: UIApplication.openSettingsURLString) else {
            return
        }

        if UIApplication.shared.canOpenURL(settingsUrl) {
            UIApplication.shared.open(settingsUrl, completionHandler: { _ in
                checkNotifications()
                checkCameraPermission()
            })
        }
    }

    private func checkNotifications() {
        UNUserNotificationCenter.current().getNotificationSettings { settings in
            DispatchQueue.main.async {
                notificationsEnabled = settings.authorizationStatus == .authorized
            }
        }
    }

    private func checkCameraPermission() {
        cameraPermissionEnabled = AVCaptureDevice.authorizationStatus(for: .video) == .authorized
    }
}

struct SettingsView_Previews: PreviewProvider {
    static var previews: some View {
        SettingsView()
    }
}
```

このコードでは、ユーザーがボタンを押すと設定アプリが開きます。それぞれのボタンを押すと、設定アプリが開きます。設定が開かれたら、通知の許可とカメラの許可のステータスが更新されます。

ただし、iOSの制約により、ユーザーが設定アプリから戻ってきたときに自動的にステータスを更新することはできません。ユーザーが設定を変更した後にアプリに戻ってきたとき、または画面が再表示されたときに状態が更新されるようになっています。

なお、このコードはiOS 14以上で動作します。それ以下のバージョンでは動作しない可能性があります。また、iOSのセキュリティポリシーにより、特定の機能へのアクセス許可を取得するた

---
