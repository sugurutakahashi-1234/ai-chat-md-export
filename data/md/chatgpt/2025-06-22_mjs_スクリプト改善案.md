# mjs スクリプト改善案

日付: 2025-06-22

---

## 👤 ユーザー
*2025/6/22 12:33:14*

この記事と同じことを行おうとしているが、やめたほうがよかったり、mjsの処理にもっと改善すべき箇所はあるか？

https://zenn.dev/moozaru/articles/8a7cacefd6d91a

---

## 🤖 アシスタント
*2025/6/22 12:33:54*

### 結論 ― “記事どおりのカスタム transform” は \*\*動くが保守コストが高め\*\*  
- \*\*型安全性の低下は小さい\*\*  
  任意プロパティが `string | undefined` になっても JSON 送信時は `undefined` が消えるため、実行時の不整合はまず起きません。citeturn2view0  
- \*\*ただし openapi-typescript の内部 AST が変わると壊れる\*\*  
  transform / postTransform はメジャーアップデートごとに API が微妙に変化します【6 → 7.x で AST ベースに変更】。スクリプトをピン留めせずに bump すると生成に失敗する可能性があります。citeturn4view0  
- \*\*Zod 側で “? だけ” を表現できる日はまだ先\*\*  
  `exactOptionalPropertyTypes` を考慮した optional 実装は v4 ロードマップに載っていますが、現状は未実装です。citeturn7search0  

---

## mjs スクリプトの改善ポイント

| 項目 | 現状 (記事) | 改善案 |
| --- | --- | --- |
| \*\*1. 走査範囲\*\* | `schemaObject.type === "object"` の一次レベルのみ | 再帰でネスト･`$ref` も追跡。`transform()` 内で `if ("properties" in schemaObject) walk(schemaObject)` のように実装 |
| \*\*2. 型マッピング\*\* | `switch(type) { case "integer": … }` で手書き | `tsKeywordMap: Record&lt;string, ts.KeywordTypeSyntaxKind&gt;` を用意し、動的に `ts.factory.createKeywordTypeNode()` へ変換 |
| \*\*3. undefined 付与\*\* | `schemaObject.properties\[key\].type.push("undefined")` | `optional → union` への変換は postTransform で AST に対して&lt;br&gt;`ts.factory.createUnionTypeNode(\[node, ts.factory.createKeywordTypeNode(ts.SyntaxKind.UndefinedKeyword)\])` とした方が安全 |
| \*\*4. CLI 連携\*\* | 固定パス | `node generate-schema.mjs spec.yaml --out src/types.ts` のように `process.argv` で受け取り、CI でも使い回せるように |
| \*\*5. 型チェック\*\* | JS (.mjs) + any 多用 | `.mts` + `ts-node-esm` もしくはビルド済み `.cjs` で書き、`esbuild --banner:js="#!/usr/bin/env node"` で単一バイナリ化すると依存が減る |
| \*\*6. キャッシュ\*\* | 毎回生成 | spec のハッシュを計算し、同一ならスキップ。CI が速くなる |

---

## “変換しない” 代替策

1. \*\*openapi-ts + zod プラグインを丸ごと使う\*\*  
   `@hey-api/openapi-ts` + `plugins: \['zod'\]` を入れると、OpenAPI 定義から \*型\* と \*Zod スキーマ\* が同時生成され、両者が必ず一致します。optional も `string | undefined` なので今回の問題をそもそも回避できます。citeturn7search3  

2. \*\*exactOptionalPropertyTypes を無効にする\*\*  
   型精度は落ちるものの、Prisma など他ライブラリでメリットを感じていなければオフにする手もあります。citeturn7search4  

3. \*\*API スキーマ側で required を明示する\*\*  
   本来必須なら OpenAPI に `required: \["foo"\]` を書くことで食い違いを防げます。  

---

## まとめ

- \*\*短期的\*\*: 記事の transform でも実運用は可能。ただしネストや参照に未対応な点と、openapi-typesript のバージョンアップで壊れるリスクを認識しておく。  
- \*\*中期的\*\*: 生成ツール側（openapi-ts + zod プラグイン等）で型とスキーマを一元生成する構成への移行を検討すると、保守コストが大きく下がる。  
- \*\*長期的\*\*: Zod v4 が `exactOptionalPropertyTypes` 対応を正式にリリースしたら、transform スクリプトを捨てても型エラーが出なくなる可能性が高い。

スクリプトを書き直す／選択肢を切り替える際に悩んだら、どの程度の\*\*保守負荷\*\*と\*\*型精度\*\*を許容できるかが判断軸になります。

---
