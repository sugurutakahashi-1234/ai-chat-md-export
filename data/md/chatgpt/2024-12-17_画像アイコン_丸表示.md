# ç”»åƒã‚¢ã‚¤ã‚³ãƒ³ ä¸¸è¡¨ç¤º

æ—¥ä»˜: 2024-12-17

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/12/17 17:28:46*

ã‚µãƒ¼ã‚¯ãƒ«ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤ºã—ãŸãã€å¥½ããªä½ç½®ã«æ‹¡å¤§/ç¸®å°ã—ã¦ä¸¸ãè¡¨ç¤ºã—ãŸã„ã€‚ã©ã†ã™ã‚Œã°ã„ã„ã‹ï¼Ÿ

import 'dart:io';

import 'package:flutter/material.dart';
import 'package:flutter\_hooks/flutter\_hooks.dart';
import 'package:go\_router/go\_router.dart';
import 'package:image\_picker/image\_picker.dart';
import 'package:permission\_handler/permission\_handler.dart';

class GuildCreatePage extends HookWidget {
  const GuildCreatePage({super.key});

  @override
  Widget build(BuildContext context) {
    final imageFile = useState&lt;File?&gt;(null);
    final picker = useMemoized(ImagePicker.new);

    /// å†™çœŸã‚’é¸æŠ
    Future&lt;void&gt; pickImage() async {
      final pickedFile = await picker.pickImage(source: ImageSource.gallery);

      if (pickedFile != null) {
        imageFile.value = File(pickedFile.path);
      } else {
        debugPrint('ç”»åƒé¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
      }
    }

    /// å†™çœŸã‚’å‰Šé™¤
    void deleteImage() {
      imageFile.value = null;
      debugPrint('ç”»åƒãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
    }

    return Scaffold(
      appBar: AppBar(title: const Text('GuildCreatePage')),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: \[
            imageFile.value != null
                ? Column(
                    children: \[
                      Image.file(
                        imageFile.value!,
                        height: 300,
                        fit: BoxFit.cover,
                      ),
                      const SizedBox(height: 10),
                      ElevatedButton(
                        onPressed: deleteImage,
                        child: const Text('ç”»åƒã‚’å‰Šé™¤'),
                      ),
                    \],
                  )
                : const Text('ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“'),
            const SizedBox(height: 20),
            ElevatedButton(
              onPressed: () async {
                final status = await \_checkPhotoPermission(context);
                if (status == PermissionStatus.granted) {
                  await pickImage();
                }
              },
              child: const Text('ã‚®ãƒ«ãƒ‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’é¸æŠ'),
            ),
            ElevatedButton(
              onPressed: () {
                context.pop();
              },
              child: const Text('Create'),
            ),
          \],
        ),
      ),
    );
  }

  /// å†™çœŸã®æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
  Future&lt;PermissionStatus&gt; \_checkPhotoPermission(BuildContext context) async {
    final status = await Permission.photos.request();

    if (status.isGranted) {
      // è¨±å¯æ¸ˆã¿ã®å ´åˆ
      return status;
    } else if (status.isPermanentlyDenied) {
      // æ°¸ä¹…ã«æ‹’å¦ã•ã‚Œã¦ã„ã‚‹å ´åˆ
      if (context.mounted) {
        \_showPermissionDialog(context);
      }
    } else {
      // ãã®ä»–ã®ã‚±ãƒ¼ã‚¹ï¼ˆæ‹’å¦ã•ã‚ŒãŸå ´åˆï¼‰
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('å†™çœŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚')),
        );
      }
    }
    return status;
  }

  /// è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
  void \_showPermissionDialog(BuildContext context) {
    showDialog&lt;void&gt;(
      context: context,
      builder: (context) =&gt; AlertDialog(
        title: const Text('å†™çœŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦ã§ã™'),
        content: const Text('å†™çœŸã‚’é¸æŠã™ã‚‹ã«ã¯ã€è¨­å®šã§å†™çœŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„ã€‚'),
        actions: \[
          TextButton(
            onPressed: () {
              Navigator.of(context).pop();
            },
            child: const Text('ã‚­ãƒ£ãƒ³ã‚»ãƒ«'),
          ),
          TextButton(
            onPressed: () async {
              await openAppSettings(); // ã‚¢ãƒ—ãƒªã®è¨­å®šç”»é¢ã‚’é–‹ã
            },
            child: const Text('è¨­å®šã‚’é–‹ã'),
          ),
        \],
      ),
    );
  }
}

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/12/17 17:28:58*

æ‹¡å¤§ãƒ»ç¸®å°ã€ä½ç½®èª¿æ•´ã—ã¦ä¸¸ãã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã§é€²ã‚ã‚‹ã¨å®Ÿç¾ã§ãã¾ã™ã€‚

1. **`Crop` æ©Ÿèƒ½ã‚’è¿½åŠ **ï¼š`image_cropper` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã—ã¦ç”»åƒã‚’å¥½ããªä½ç½®ãƒ»ã‚µã‚¤ã‚ºã§åˆ‡ã‚ŠæŠœãã€‚
2. **åˆ‡ã‚ŠæŠœã„ãŸç”»åƒã‚’è¡¨ç¤ºã™ã‚‹**ï¼š`ClipOval` ã‚’ä½¿ç”¨ã—ã¦ç”»åƒã‚’ä¸¸ãè¡¨ç¤ºã™ã‚‹ã€‚

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

### æ›´æ–°å¾Œã®ã‚³ãƒ¼ãƒ‰

```dart
import 'dart:io';
import 'package:flutter/material.dart';
import 'package:flutter_hooks/flutter_hooks.dart';
import 'package:go_router/go_router.dart';
import 'package:image_picker/image_picker.dart';
import 'package:image_cropper/image_cropper.dart'; // è¿½åŠ 
import 'package:permission_handler/permission_handler.dart';

class GuildCreatePage extends HookWidget {
  const GuildCreatePage({super.key});

  @override
  Widget build(BuildContext context) {
    final imageFile = useState<File?>(null);
    final picker = useMemoized(ImagePicker.new);

    /// å†™çœŸã‚’é¸æŠã—ã€åˆ‡ã‚ŠæŠœã
    Future<void> pickAndCropImage() async {
      final pickedFile = await picker.pickImage(source: ImageSource.gallery);

      if (pickedFile != null) {
        final croppedFile = await _cropImage(File(pickedFile.path));
        if (croppedFile != null) {
          imageFile.value = croppedFile;
        }
      } else {
        debugPrint('ç”»åƒé¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
      }
    }

    /// ç”»åƒã‚’åˆ‡ã‚ŠæŠœã
    Future<File?> _cropImage(File image) async {
      final croppedFile = await ImageCropper().cropImage(
        sourcePath: image.path,
        aspectRatio: const CropAspectRatio(ratioX: 1, ratioY: 1), // æ­£æ–¹å½¢
        cropStyle: CropStyle.circle, // ä¸¸ãåˆ‡ã‚ŠæŠœã
        uiSettings: [
          AndroidUiSettings(
            toolbarTitle: 'ã‚¢ã‚¤ã‚³ãƒ³ã‚’ç·¨é›†',
            toolbarColor: Colors.blue,
            toolbarWidgetColor: Colors.white,
            hideBottomControls: false,
          ),
          IOSUiSettings(
            title: 'ã‚¢ã‚¤ã‚³ãƒ³ã‚’ç·¨é›†',
            aspectRatioLockEnabled: true,
          ),
        ],
      );

      return croppedFile != null ? File(croppedFile.path) : null;
    }

    /// å†™çœŸã‚’å‰Šé™¤
    void deleteImage() {
      imageFile.value = null;
      debugPrint('ç”»åƒãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
    }

    return Scaffold(
      appBar: AppBar(title: const Text('GuildCreatePage')),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            imageFile.value != null
                ? Column(
                    children: [
                      ClipOval( // ä¸¸ãè¡¨ç¤ºã™ã‚‹
                        child: Image.file(
                          imageFile.value!,
                          height: 150,
                          width: 150,
                          fit: BoxFit.cover,
                        ),
                      ),
                      const SizedBox(height: 10),
                      ElevatedButton(
                        onPressed: deleteImage,
                        child: const Text('ç”»åƒã‚’å‰Šé™¤'),
                      ),
                    ],
                  )
                : const Text('ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“'),
            const SizedBox(height: 20),
            ElevatedButton(
              onPressed: () async {
                final status = await _checkPhotoPermission(context);
                if (status == PermissionStatus.granted) {
                  await pickAndCropImage();
                }
              },
              child: const Text('ã‚®ãƒ«ãƒ‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’é¸æŠ'),
            ),
            ElevatedButton(
              onPressed: () {
                context.pop();
              },
              child: const Text('Create'),
            ),
          ],
        ),
      ),
    );
  }

  /// å†™çœŸã®æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
  Future<PermissionStatus> _checkPhotoPermission(BuildContext context) async {
    final status = await Permission.photos.request();

    if (status.isGranted) {
      return status;
    } else if (status.isPermanentlyDenied) {
      if (context.mounted) _showPermissionDialog(context);
    } else {
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('å†™çœŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚')),
        );
      }
    }
    return status;
  }

  /// è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
  void _showPermissionDialog(BuildContext context) {
    showDialog<void>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('å†™çœŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦ã§ã™'),
        content: const Text('å†™çœŸã‚’é¸æŠã™ã‚‹ã«ã¯ã€è¨­å®šã§å†™çœŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„ã€‚'),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text('ã‚­ãƒ£ãƒ³ã‚»ãƒ«'),
          ),
          TextButton(
            onPressed: () async => await openAppSettings(),
            child: const Text('è¨­å®šã‚’é–‹ã'),
          ),
        ],
      ),
    );
  }
}
```

---

### **ãƒã‚¤ãƒ³ãƒˆ**
1. **`image_cropper` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åˆ©ç”¨**  
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸ã‚“ã ç”»åƒã‚’æ‹¡å¤§/ç¸®å°ãƒ»ä½ç½®èª¿æ•´ã—ã¦åˆ‡ã‚ŠæŠœãã¾ã™ã€‚  
   - `CropStyle.circle` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ä¸¸ãåˆ‡ã‚ŠæŠœãã“ã¨ãŒã§ãã¾ã™ã€‚

2. **`ClipOval` ã‚’ä½¿ç”¨**  
   - åˆ‡ã‚ŠæŠœã„ãŸç”»åƒã‚’ä¸¸ãè¡¨ç¤ºã™ã‚‹ãŸã‚ã«ã€`ClipOval` ã§åŒ…ã‚“ã§è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚

3. **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è¿½åŠ **  
   `pubspec.yaml` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
   ```yaml
   dependencies:
     image_cropper: ^4.0.0
   ```

---

ã“ã®å®Ÿè£…ã§ã€ç”»åƒã®æ‹¡å¤§ãƒ»ç¸®å°ã¨ä¸¸ãåˆ‡ã‚ŠæŠœãæ©Ÿèƒ½ãŒã‚·ãƒ³ãƒ—ãƒ«ã«è¿½åŠ ã•ã‚Œã¾ã™ï¼

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/12/17 17:31:07*

iOSã‚„Androidã§ã©ã®ã‚ˆã†ãªè¨­å®šãŒå¿…è¦ã‹ï¼Ÿ

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/12/17 17:31:41*

`image_cropper` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ iOS ã¨ Android ã§å‹•ä½œã•ã›ã‚‹ãŸã‚ã«ã¯ã€ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã”ã¨ã«è¿½åŠ ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚

---

## **iOSã®è¨­å®š**

1. **`Info.plist` ã«æ¨©é™ã®èª¬æ˜ã‚’è¿½åŠ ã™ã‚‹**  
   ã‚¢ãƒ—ãƒªãŒå†™çœŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚„ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã«å¿…è¦ãªæ¨©é™ã®èª¬æ˜ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

   `ios/Runner/Info.plist` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

   ```xml
   <key>NSPhotoLibraryUsageDescription</key>
   <string>å†™çœŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™ã€‚</string>
   <key>NSCameraUsageDescription</key>
   <string>ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™ã€‚</string>
   <key>NSPhotoLibraryAddUsageDescription</key>
   <string>ç·¨é›†ã—ãŸå†™çœŸã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã«å†™çœŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¸ã®è¿½åŠ ãŒå¿…è¦ã§ã™ã€‚</string>
   ```

2. **iOS 14ä»¥é™ã®å¯¾å¿œ (Photo Picker API)**  
   `image_cropper` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ iOS 14 ä»¥ä¸Šã§ `PHPicker` ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã€ç‰¹ã«æ–°ã—ã„è¨­å®šã¯ä¸è¦ã§ã™ã€‚

---

## **Androidã®è¨­å®š**

1. **Androidã®`AndroidManifest.xml`ã«æ¨©é™ã‚’è¿½åŠ ã™ã‚‹**  
   ç”»åƒã®å–å¾—ã‚„ä¿å­˜ã«å¿…è¦ãªæ¨©é™ã‚’ `AndroidManifest.xml` ã«è¿½åŠ ã—ã¾ã™ã€‚

   `android/app/src/main/AndroidManifest.xml` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

   ```xml
   <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
   <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
   <uses-permission android:name="android.permission.CAMERA"/>
   ```

   - **Android 10 (API 29)** ä»¥é™: `WRITE_EXTERNAL_STORAGE` ã¯ä¸è¦ã§ã™ã€‚
   - **Android 13 (API 33)** ä»¥é™: `READ_EXTERNAL_STORAGE` ã®ä»£ã‚ã‚Šã« `READ_MEDIA_IMAGES` ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

   ```xml
   <uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />
   ```

2. **Androidã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¯¾å¿œ**  
   Android 7.0 (API 24) ä»¥é™ã§ `FileProvider` ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚  
   ä»¥ä¸‹ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

   - **`res/xml/file_paths.xml`** ã‚’ä½œæˆ:
     `android/app/src/main/res/xml/file_paths.xml` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

     ```xml
     <?xml version="1.0" encoding="utf-8"?>
     <paths xmlns:android="http://schemas.android.com/apk/res/android">
         <external-path name="external_files" path="."/>
     </paths>
     ```

   - **`AndroidManifest.xml` ã« `FileProvider` ã‚’è¨­å®š**:

     ```xml
     <application>
         ...
         <provider
             android:name="androidx.core.content.FileProvider"
             android:authorities="${applicationId}.fileprovider"
             android:exported="false"
             android:grantUriPermissions="true">
             <meta-data
                 android:name="android.support.FILE_PROVIDER_PATHS"
                 android:resource="@xml/file_paths" />
         </provider>
     </application>
     ```

3. **`minSdkVersion` ã®ç¢ºèª**  
   `build.gradle` ãƒ•ã‚¡ã‚¤ãƒ«ã§ `minSdkVersion` ãŒ **21** ä»¥ä¸Šã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

   ```gradle
   android {
       defaultConfig {
           minSdkVersion 21
       }
   }
   ```

---

## **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ä¾å­˜é–¢ä¿‚**
`pubspec.yaml` ã«è¿½åŠ æ¸ˆã¿ã® `image_cropper` ã«åŠ ãˆã€å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```yaml
dependencies:
  image_cropper: ^4.0.0
  image_picker: ^1.0.0
  permission_handler: ^11.0.0
```

---

ã“ã‚Œã‚‰ã®è¨­å®šã‚’è¡Œãˆã°ã€iOS ã¨ Android ä¸¡æ–¹ã§å†™çœŸã®é¸æŠãƒ»åˆ‡ã‚ŠæŠœããƒ»è¡¨ç¤ºãŒæ­£å¸¸ã«å‹•ä½œã—ã¾ã™ï¼

---
