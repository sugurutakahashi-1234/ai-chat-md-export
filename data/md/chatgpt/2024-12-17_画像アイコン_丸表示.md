# 画像アイコン 丸表示

日付: 2024-12-17

---

## 👤 ユーザー
*2024/12/17 17:28:46*

サークルのアイコンを表示したく、好きな位置に拡大/縮小して丸く表示したい。どうすればいいか？

import 'dart:io';

import 'package:flutter/material.dart';
import 'package:flutter\_hooks/flutter\_hooks.dart';
import 'package:go\_router/go\_router.dart';
import 'package:image\_picker/image\_picker.dart';
import 'package:permission\_handler/permission\_handler.dart';

class GuildCreatePage extends HookWidget {
  const GuildCreatePage({super.key});

  @override
  Widget build(BuildContext context) {
    final imageFile = useState&lt;File?&gt;(null);
    final picker = useMemoized(ImagePicker.new);

    /// 写真を選択
    Future&lt;void&gt; pickImage() async {
      final pickedFile = await picker.pickImage(source: ImageSource.gallery);

      if (pickedFile != null) {
        imageFile.value = File(pickedFile.path);
      } else {
        debugPrint('画像選択がキャンセルされました');
      }
    }

    /// 写真を削除
    void deleteImage() {
      imageFile.value = null;
      debugPrint('画像が削除されました');
    }

    return Scaffold(
      appBar: AppBar(title: const Text('GuildCreatePage')),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: \[
            imageFile.value != null
                ? Column(
                    children: \[
                      Image.file(
                        imageFile.value!,
                        height: 300,
                        fit: BoxFit.cover,
                      ),
                      const SizedBox(height: 10),
                      ElevatedButton(
                        onPressed: deleteImage,
                        child: const Text('画像を削除'),
                      ),
                    \],
                  )
                : const Text('画像が選択されていません'),
            const SizedBox(height: 20),
            ElevatedButton(
              onPressed: () async {
                final status = await \_checkPhotoPermission(context);
                if (status == PermissionStatus.granted) {
                  await pickImage();
                }
              },
              child: const Text('ギルドアイコンを選択'),
            ),
            ElevatedButton(
              onPressed: () {
                context.pop();
              },
              child: const Text('Create'),
            ),
          \],
        ),
      ),
    );
  }

  /// 写真の権限をチェックする
  Future&lt;PermissionStatus&gt; \_checkPhotoPermission(BuildContext context) async {
    final status = await Permission.photos.request();

    if (status.isGranted) {
      // 許可済みの場合
      return status;
    } else if (status.isPermanentlyDenied) {
      // 永久に拒否されている場合
      if (context.mounted) {
        \_showPermissionDialog(context);
      }
    } else {
      // その他のケース（拒否された場合）
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('写真へのアクセスが許可されていません。')),
        );
      }
    }
    return status;
  }

  /// 設定ダイアログを表示
  void \_showPermissionDialog(BuildContext context) {
    showDialog&lt;void&gt;(
      context: context,
      builder: (context) =&gt; AlertDialog(
        title: const Text('写真へのアクセス許可が必要です'),
        content: const Text('写真を選択するには、設定で写真へのアクセス許可をオンにしてください。'),
        actions: \[
          TextButton(
            onPressed: () {
              Navigator.of(context).pop();
            },
            child: const Text('キャンセル'),
          ),
          TextButton(
            onPressed: () async {
              await openAppSettings(); // アプリの設定画面を開く
            },
            child: const Text('設定を開く'),
          ),
        \],
      ),
    );
  }
}

---

## 🤖 アシスタント
*2024/12/17 17:28:58*

拡大・縮小、位置調整して丸くアイコンを表示するためには、以下の手順で進めると実現できます。

1. **`Crop` 機能を追加**：`image_cropper` パッケージを利用して画像を好きな位置・サイズで切り抜く。
2. **切り抜いた画像を表示する**：`ClipOval` を使用して画像を丸く表示する。

以下のコードを参考にしてください。

### 更新後のコード

```dart
import 'dart:io';
import 'package:flutter/material.dart';
import 'package:flutter_hooks/flutter_hooks.dart';
import 'package:go_router/go_router.dart';
import 'package:image_picker/image_picker.dart';
import 'package:image_cropper/image_cropper.dart'; // 追加
import 'package:permission_handler/permission_handler.dart';

class GuildCreatePage extends HookWidget {
  const GuildCreatePage({super.key});

  @override
  Widget build(BuildContext context) {
    final imageFile = useState<File?>(null);
    final picker = useMemoized(ImagePicker.new);

    /// 写真を選択し、切り抜く
    Future<void> pickAndCropImage() async {
      final pickedFile = await picker.pickImage(source: ImageSource.gallery);

      if (pickedFile != null) {
        final croppedFile = await _cropImage(File(pickedFile.path));
        if (croppedFile != null) {
          imageFile.value = croppedFile;
        }
      } else {
        debugPrint('画像選択がキャンセルされました');
      }
    }

    /// 画像を切り抜く
    Future<File?> _cropImage(File image) async {
      final croppedFile = await ImageCropper().cropImage(
        sourcePath: image.path,
        aspectRatio: const CropAspectRatio(ratioX: 1, ratioY: 1), // 正方形
        cropStyle: CropStyle.circle, // 丸く切り抜く
        uiSettings: [
          AndroidUiSettings(
            toolbarTitle: 'アイコンを編集',
            toolbarColor: Colors.blue,
            toolbarWidgetColor: Colors.white,
            hideBottomControls: false,
          ),
          IOSUiSettings(
            title: 'アイコンを編集',
            aspectRatioLockEnabled: true,
          ),
        ],
      );

      return croppedFile != null ? File(croppedFile.path) : null;
    }

    /// 写真を削除
    void deleteImage() {
      imageFile.value = null;
      debugPrint('画像が削除されました');
    }

    return Scaffold(
      appBar: AppBar(title: const Text('GuildCreatePage')),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            imageFile.value != null
                ? Column(
                    children: [
                      ClipOval( // 丸く表示する
                        child: Image.file(
                          imageFile.value!,
                          height: 150,
                          width: 150,
                          fit: BoxFit.cover,
                        ),
                      ),
                      const SizedBox(height: 10),
                      ElevatedButton(
                        onPressed: deleteImage,
                        child: const Text('画像を削除'),
                      ),
                    ],
                  )
                : const Text('画像が選択されていません'),
            const SizedBox(height: 20),
            ElevatedButton(
              onPressed: () async {
                final status = await _checkPhotoPermission(context);
                if (status == PermissionStatus.granted) {
                  await pickAndCropImage();
                }
              },
              child: const Text('ギルドアイコンを選択'),
            ),
            ElevatedButton(
              onPressed: () {
                context.pop();
              },
              child: const Text('Create'),
            ),
          ],
        ),
      ),
    );
  }

  /// 写真の権限をチェックする
  Future<PermissionStatus> _checkPhotoPermission(BuildContext context) async {
    final status = await Permission.photos.request();

    if (status.isGranted) {
      return status;
    } else if (status.isPermanentlyDenied) {
      if (context.mounted) _showPermissionDialog(context);
    } else {
      if (context.mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('写真へのアクセスが許可されていません。')),
        );
      }
    }
    return status;
  }

  /// 設定ダイアログを表示
  void _showPermissionDialog(BuildContext context) {
    showDialog<void>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('写真へのアクセス許可が必要です'),
        content: const Text('写真を選択するには、設定で写真へのアクセス許可をオンにしてください。'),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text('キャンセル'),
          ),
          TextButton(
            onPressed: () async => await openAppSettings(),
            child: const Text('設定を開く'),
          ),
        ],
      ),
    );
  }
}
```

---

### **ポイント**
1. **`image_cropper` パッケージを利用**  
   - ユーザーが選んだ画像を拡大/縮小・位置調整して切り抜きます。  
   - `CropStyle.circle` を指定することで丸く切り抜くことができます。

2. **`ClipOval` を使用**  
   - 切り抜いた画像を丸く表示するために、`ClipOval` で包んで表示しています。

3. **パッケージの追加**  
   `pubspec.yaml` に以下を追加してください。
   ```yaml
   dependencies:
     image_cropper: ^4.0.0
   ```

---

この実装で、画像の拡大・縮小と丸く切り抜く機能がシンプルに追加されます！

---

## 👤 ユーザー
*2024/12/17 17:31:07*

iOSやAndroidでどのような設定が必要か？

---

## 🤖 アシスタント
*2024/12/17 17:31:41*

`image_cropper` パッケージを iOS と Android で動作させるためには、プラットフォームごとに追加の設定が必要です。

---

## **iOSの設定**

1. **`Info.plist` に権限の説明を追加する**  
   アプリが写真ライブラリやカメラにアクセスする際に必要な権限の説明を記述します。

   `ios/Runner/Info.plist` に以下を追加してください。

   ```xml
   <key>NSPhotoLibraryUsageDescription</key>
   <string>写真ライブラリへのアクセスが必要です。</string>
   <key>NSCameraUsageDescription</key>
   <string>カメラへのアクセスが必要です。</string>
   <key>NSPhotoLibraryAddUsageDescription</key>
   <string>編集した写真を保存するために写真ライブラリへの追加が必要です。</string>
   ```

2. **iOS 14以降の対応 (Photo Picker API)**  
   `image_cropper` パッケージは iOS 14 以上で `PHPicker` を利用するため、特に新しい設定は不要です。

---

## **Androidの設定**

1. **Androidの`AndroidManifest.xml`に権限を追加する**  
   画像の取得や保存に必要な権限を `AndroidManifest.xml` に追加します。

   `android/app/src/main/AndroidManifest.xml` に以下を追加してください。

   ```xml
   <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
   <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
   <uses-permission android:name="android.permission.CAMERA"/>
   ```

   - **Android 10 (API 29)** 以降: `WRITE_EXTERNAL_STORAGE` は不要です。
   - **Android 13 (API 33)** 以降: `READ_EXTERNAL_STORAGE` の代わりに `READ_MEDIA_IMAGES` を使用します。

   ```xml
   <uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />
   ```

2. **Androidのバージョン対応**  
   Android 7.0 (API 24) 以降で `FileProvider` を使用する必要があります。  
   以下の設定を行います。

   - **`res/xml/file_paths.xml`** を作成:
     `android/app/src/main/res/xml/file_paths.xml` に以下を追加します。

     ```xml
     <?xml version="1.0" encoding="utf-8"?>
     <paths xmlns:android="http://schemas.android.com/apk/res/android">
         <external-path name="external_files" path="."/>
     </paths>
     ```

   - **`AndroidManifest.xml` に `FileProvider` を設定**:

     ```xml
     <application>
         ...
         <provider
             android:name="androidx.core.content.FileProvider"
             android:authorities="${applicationId}.fileprovider"
             android:exported="false"
             android:grantUriPermissions="true">
             <meta-data
                 android:name="android.support.FILE_PROVIDER_PATHS"
                 android:resource="@xml/file_paths" />
         </provider>
     </application>
     ```

3. **`minSdkVersion` の確認**  
   `build.gradle` ファイルで `minSdkVersion` が **21** 以上になっていることを確認してください。

   ```gradle
   android {
       defaultConfig {
           minSdkVersion 21
       }
   }
   ```

---

## **パッケージの依存関係**
`pubspec.yaml` に追加済みの `image_cropper` に加え、必要なパッケージも確認してください。

```yaml
dependencies:
  image_cropper: ^4.0.0
  image_picker: ^1.0.0
  permission_handler: ^11.0.0
```

---

これらの設定を行えば、iOS と Android 両方で写真の選択・切り抜き・表示が正常に動作します！

---
