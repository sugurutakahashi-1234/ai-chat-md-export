# 出力ファイル重複問題

日付: 2024-10-15

---

## 👤 ユーザー
*2024/10/15 15:39:20*

output\_file が2つ生成されるみたい

#!/bin/bash

if \[ "$#" -ne 1 \]; then
    echo "Usage: $0 &lt;Root Path&gt;"
    exit 1
fi

mint\_package\_name="DaVinciDevToolsPackage"
xcodeproject\_name="daVinci"
scheme\_name="Distribute"

# 無視する警告メッセージのパターン
ignore\_patterns=("")

root\_path=$1
mint\_package\_path="$root\_path/$mint\_package\_name"
periphery\_path="$root\_path/periphery"
output\_file="$periphery\_path/result.txt"

# Ref: https://github.com/peripheryapp/periphery?tab=readme-ov-file#swift-package-is-platform-specific
# Swift パッケージを指定したパスで実行し、periphery を使用してプロジェクトをスキャン
# --skip-build: ビルドプロセスをスキップ
# --index-store-path: ビルドプロセスをスキップしたので、xcodebuild でビルドしたindex-store-pathの指定
# --retain-swift-ui-previews: SwiftUI のプレビューはそのままにしておく
# --retain-public: 不要な Public 宣言はそのままにしておく
swift run --package-path $mint\_package\_path mint run periphery scan --project $xcodeproject\_name.xcodeproj --schemes $scheme\_name --targets $xcodeproject\_name | tee $output\_file

# 出力に環境依存な root\_path がoutputファイルに付与されるため、それを削除する
sed -i '' "s|${root\_path}/||g" $output\_file

# 無視する警告メッセージを表示し、削除する
for pattern in "${ignore\_patterns\[@\]}"; do
    echo -e "\\nLines to be deleted matching pattern: $pattern\\n"
    grep "$pattern" $output\_file
    sed -i '' "/$pattern/d" $output\_file
done

echo -e "✅ Periphery Scan Completed!!!!"

---

## 🤖 アシスタント
*2024/10/15 15:39:35*

The reason two `output\_file` instances might be created in your script is likely due to the behavior of the `tee` command, which creates a log file while also showing the output in the terminal. However, it’s possible that somewhere else in your build pipeline or script execution, an additional instance of the output file might be generated.

To investigate further:
- Check if the build process or other scripts triggered within your pipeline are also generating the same output.
- Review whether `tee` is being invoked multiple times or if there are other log file creations not explicitly defined in the script.

To ensure only one `output\_file` is generated, consider checking the current working directory and ensuring all paths are correctly set relative to the root path you intend.

Here are a few possible adjustments:

1. \*\*Ensure uniqueness of the output file path:\*\*
   Double-check that there are no unintended duplications in the script or in any surrounding processes.

2. \*\*Suppress extra tee commands:\*\*
   Make sure that `tee` is only being used once, and there are no other redundant logging mechanisms triggered.

If the problem persists despite these changes, please let me know more details about the build process, and we can look further into resolving this.

---

## 👤 ユーザー
*2024/10/15 15:39:38*

具体的に

---

## 🤖 アシスタント
*2024/10/15 15:40:16*

具体的な原因として、スクリプトの実行時に `tee` によって標準出力とファイル書き込みが行われる一方で、別の箇所で同じファイル名が指定されている可能性があります。これにより、意図せず同じ `output_file` が二重に生成されている可能性があります。

以下の手順でスクリプトの修正と確認ができます。

### 修正案 1: `tee` の使用を確認
`tee` コマンドは標準出力とファイルに同時に書き込みを行いますが、この部分で二重出力が発生していないか確認します。

```bash
# 現在のコマンド
swift run --package-path $mint_package_path mint run periphery scan --project $xcodeproject_name.xcodeproj --schemes $scheme_name --targets $xcodeproject_name | tee $output_file
```

**修正例**: `tee` を外して単純にファイルにリダイレクトして確認します。

```bash
# ファイルに直接出力する
swift run --package-path $mint_package_path mint run periphery scan --project $xcodeproject_name.xcodeproj --schemes $scheme_name --targets $xcodeproject_name > $output_file
```

これで、標準出力には表示されませんが、結果は `output_file` のみ生成されます。この方法で、不要な重複ファイルが生成されないか確認してください。

### 修正案 2: 既存の `output_file` を明示的に削除
スクリプトの実行前に、既に存在する `output_file` を明示的に削除しておくことで、重複ファイルの生成を防ぐことができます。

```bash
# 実行前に古いファイルを削除
rm -f $output_file

# ファイルに出力する
swift run --package-path $mint_package_path mint run periphery scan --project $xcodeproject_name.xcodeproj --schemes $scheme_name --targets $xcodeproject_name | tee $output_file
```

これにより、スクリプト実行時に必ず新しいファイルが生成されることが保証されます。

### 修正案 3: 標準出力とファイル出力を分ける
もし標準出力とファイル出力を分けて管理したい場合、以下のように `tee` を使用して標準出力を確認しながら、ログファイルにも結果を保存することができます。

```bash
# 標準出力にはそのまま表示し、ファイルに記録する
swift run --package-path $mint_package_path mint run periphery scan --project $xcodeproject_name.xcodeproj --schemes $scheme_name --targets $xcodeproject_name 2>&1 | tee $output_file
```

このコマンドにより、標準出力とファイル出力を同時に行いつつ、エラーメッセージも含めて結果が保存されます。

### 確認ポイント
- **他のスクリプトやビルドプロセス**が `result.txt` に出力していないか確認します。
- `sed` コマンドや他の操作で再生成されたファイルがないか確認します。

これで不要なファイル生成が防げるか確認し、問題が解決しない場合は他のプロセスを見直す必要があります。

---
