# Slang ファイル フォーマット 除外

Date: 2025-02-01

---

## 👤 User
*2025-02-01 22:27:52*

slang を使って導入したファイルについて、formatterが実施されてしまう。

なぜなのだろう？

$ dart run slang
dart run slang
Generating translations...

No build.yaml or slang.yaml, using default settings.
Scanning translations...

 (base) en -&gt; assets/i18n/en.i18n.json
        jp -&gt; assets/i18n/jp.i18n.json

Output:
 -&gt; lib/gen/strings.g.dart
 -&gt; lib/gen/strings_en.g.dart
 -&gt; lib/gen/strings_jp.g.dart


$ dart fix --apply lib && dart format lib
Computing fixes in lib...      0.8s
Nothing to fix!
Formatted lib/gen/strings.g.dart
Formatted lib/gen/strings_en.g.dart
Formatted lib/gen/strings_jp.g.dart
Formatted 181 files (3 changed) in 0.68 seconds.



```
# https://pub.dev/packages/pedantic_mono
include: package:pedantic_mono/analysis_options.yaml

analyzer:
  errors:
    sort_pub_dependencies: ignore # Want to arrange in meaningful units
    flutter_style_todos: ignore # Want to use TODOs in the code
  exclude:
    - '**.g.dart'
    - '**.freezed.dart'
    - '**.openapi.dart'

linter:
  # The lint rules applied to this project can be customized in the
  # section below to disable rules from the `package:flutter_lints/flutter.yaml`
  # included above or to enable additional rules. A list of all available lints
  # and their documentation is published at https://dart.dev/lints.
  #
  # Instead of disabling a lint rule for the entire project in the
  # section below, it can also be suppressed for a single line of code
  # or a specific dart file by using the `// ignore: name_of_lint` and
  # `// ignore_for_file: name_of_lint` syntax on the line or in the file
  # producing the lint.
  rules:
    # avoid_print: false  # Uncomment to disable the `avoid_print` rule
    # prefer_single_quotes: true  # Uncomment to enable the `prefer_single_quotes` rule

# Additional information about this file can be found at
# https://dart.dev/guides/language/analysis-options
```

---

## 🤖 Assistant
*2025-02-01 22:28:20*

`dart format` が `slang` によって生成された `*.g.dart` ファイルに対して実行されてしまう理由として、以下の点が考えられます。

### **考えられる原因**
1. **`analysis_options.yaml` の `exclude` は `dart format` には影響しない**
   - `exclude` は **analyzer**（静的解析）の設定であり、`dart format`（コードフォーマッター）には影響しません。
   - そのため、`dart format` は `gen` ディレクトリ内の `.g.dart` ファイルを普通にフォーマットします。

2. **`dart format` はデフォルトで `lib/` 全体を対象にする**
   - `dart format lib` を実行すると、`lib/` 以下の全ファイル（`gen/` 内を含む）がフォーマットされます。

### **解決策**
#### **1. `gen/` を `dart format` の対象から除外する**
`dart format` に `--set-exit-if-changed` や `--output none` のオプションはないため、以下の方法で `gen/` ディレクトリを除外できます。

```sh
dart format lib --ignore lib/gen
```

または `find` を使う方法もあります：

```sh
find lib -type f ! -path "lib/gen/*" -name "*.dart" | xargs dart format
```

#### **2. `dart fix` に `gen/` を明示的に除外**
`dart fix` の場合も `lib/gen/` を除外するために、以下のようにパスを指定できます。

```sh
dart fix --apply lib --ignore lib/gen
```

ただし、`dart fix` には `--ignore` のようなオプションがないため、事前に `find` で除外するのが確実です。

#### **3. `build.yaml` を設定して `slang` の出力ディレクトリを `ignore` する**
もし `slang.yaml` を使用しているなら、以下のように `output_directory` を `ignored/` に変更し、フォーマット対象外のディレクトリにする方法もあります。

```yaml
output_directory: ignored/gen
```

これにより、`dart format lib` を実行しても `ignored/gen` は影響を受けません。

---

### **結論**
- `analysis_options.yaml` の `exclude` は `dart format` には影響しない
- `dart format lib` を実行すると、`gen/` 内の `.g.dart` ファイルもフォーマットされる
- **`dart format` の対象から `gen/` を除外する** のが解決策

最も簡単な解決策は以下のコマンドです。

```sh
dart format lib --ignore lib/gen
```

または `find` を使う方法：

```sh
find lib -type f ! -path "lib/gen/*" -name "*.dart" | xargs dart format
```

これで `slang` の生成ファイルが `dart format` によって変更されることを防げます。

---

## 👤 User
*2025-02-01 22:29:20*

make format
dart fix --apply lib && dart format lib --ignore lib/gen
Computing fixes in lib...      1.9s
Nothing to fix!
Could not find an option named "--ignore".

Usage: dart format [options...] &lt;files or directories...&gt;
-h, --help                     Print this usage information.
-v, --verbose                  Show all options and flags with --help.
-o, --output                   Set where to write formatted output.

          [json]               Print code and selection as JSON.
          [none]               Discard output.
          [show]               Print code to terminal.
          [write] (default)    Overwrite formatted files on disk.

    --set-exit-if-changed      Return exit code 1 if there are any formatting changes.

Run "dart help" to see global options.
make: *** [format] Error 64

---

## 🤖 Assistant
*2025-02-01 22:29:48*

`dart format` には `--ignore` オプションが存在しないため、`lib/gen` を除外するには **別の方法** を使う必要があります。

---

## **解決策**
### **方法 1: `find` コマンドを使う（推奨）**
次のコマンドで `lib/gen/` 内の `.dart` ファイルを除外してフォーマットできます。

```sh
find lib -type f -name "*.dart" ! -path "lib/gen/*" | xargs dart format
```

### **方法 2: `make` コマンドを変更**
`Makefile` を使用しているなら、`format` タスクを次のように変更できます。

```makefile
format:
	find lib -type f -name "*.dart" ! -path "lib/gen/*" | xargs dart format
```

この方法なら `make format` を実行しても `lib/gen` 内のファイルはフォーマットされません。

---

### **方法 3: `dart format` の対象を明示的に指定**
`dart format lib` を使うのではなく、フォーマットしたいディレクトリを個別に指定することで `lib/gen/` を除外できます。

```sh
dart format lib/core lib/features lib/widgets
```

この方法では、`lib/` 配下の `core`, `features`, `widgets` ディレクトリのみフォーマット対象になります。

---

### **結論**
✅ **最も簡単な方法は `find` を使うこと**  
`lib/gen/` を除外したい場合、次のコマンドを実行すればOKです。

```sh
find lib -type f -name "*.dart" ! -path "lib/gen/*" | xargs dart format
```

Makefile にも適用できます。  
この方法で `slang` によって生成されたファイルをフォーマット対象から除外できます！ 🚀

---

## 👤 User
*2025-02-01 22:30:12*

これを修正して欲しい

# format の実行
.PHONY: format
format:
	dart fix --apply lib && dart format lib

---

## 🤖 Assistant
*2025-02-01 22:30:23*

`lib/gen/` を `dart format` の対象から除外するように `Makefile` を修正しました。  
修正後の `Makefile` は以下のようになります。  

```makefile
# format の実行
.PHONY: format
format:
	dart fix --apply lib
	find lib -type f -name "*.dart" ! -path "lib/gen/*" | xargs dart format
```

### **修正内容**
1. **`dart fix --apply lib` はそのまま**
   - これは `lib/` 内のコード修正を適用するため、変更なし。

2. **`dart format lib` を `find` に置き換え**
   - `find lib -type f -name "*.dart" ! -path "lib/gen/*"` を使って `lib/gen/` 内の `.dart` ファイルを除外。
   - `xargs dart format` で除外したファイル以外をフォーマット。

この修正により、`slang` によって生成された `.g.dart` ファイルを `dart format` から除外できます。 🚀

---

## 👤 User
*2025-02-01 22:32:22*

jobs:
  format:
    runs-on: ubuntu-20.04
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v3

      - uses: ./.github/actions/setup_flutter
        with:
          ssh_key: ${{ secrets.SSH_KEY }}
          known_hosts: ${{ secrets.KNOWN_HOSTS }}
          with_run_pub_get: false

      - run: dart format --set-exit-if-changed .

---

## 🤖 Assistant
*2025-02-01 22:32:39*

この GitHub Actions ジョブでは、リポジトリ全体 (`.`) に対して `dart format --set-exit-if-changed` を実行しているため、 `lib/gen/` 内の `*.g.dart` ファイルもフォーマットの対象になってしまいます。

### **修正方法**
`lib/gen/` を `dart format` の対象から除外するには、`find` コマンドを使用します。

#### **修正後の YAML**
```yaml
jobs:
  format:
    runs-on: ubuntu-20.04
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v3

      - uses: ./.github/actions/setup_flutter
        with:
          ssh_key: ${{ secrets.SSH_KEY }}
          known_hosts: ${{ secrets.KNOWN_HOSTS }}
          with_run_pub_get: false

      - run: |
          find lib -type f -name "*.dart" ! -path "lib/gen/*" | xargs dart format --set-exit-if-changed
```

### **変更点**
1. **`find` を使って `lib/gen/` を除外**
   ```sh
   find lib -type f -name "*.dart" ! -path "lib/gen/*" | xargs dart format --set-exit-if-changed
   ```
   - `find lib -type f -name "*.dart"`: `lib/` 以下の `.dart` ファイルを検索。
   - `! -path "lib/gen/*"`: `lib/gen/` 内のファイルを除外。
   - `xargs dart format --set-exit-if-changed`: フォーマットを適用し、変更があればエラー終了。

---

### **動作**
✅ `lib/gen/` の `*.g.dart` はフォーマット対象から除外される。  
✅ 他の `lib/` 以下の `.dart` ファイルはフォーマットされる。  
✅ `--set-exit-if-changed` により、フォーマットの必要がある場合 CI でエラーになる。

この修正で `slang` による `.g.dart` への影響を回避できます！ 🚀

---
