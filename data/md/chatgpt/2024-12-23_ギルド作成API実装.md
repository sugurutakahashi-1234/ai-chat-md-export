# ã‚®ãƒ«ãƒ‰ä½œæˆAPIå®Ÿè£…

æ—¥ä»˜: 2024-12-23

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/12/23 22:20:34*

ã‚®ãƒ«ãƒ‰ã‚’ä½œæˆã®ç®‡æ‰€ã«APIã‚’ã‚³ãƒ¼ãƒ«ã—ãŸã„

import 'dart:io';

import 'package:flutter/material.dart';
import 'package:flutter_hooks/flutter_hooks.dart';
import 'package:go_router/go_router.dart';
import 'package:hooks_riverpod/hooks_riverpod.dart';
import 'package:image_cropper/image_cropper.dart';
import 'package:image_picker/image_picker.dart';
import 'package:permission_handler/permission_handler.dart';
import 'package:snpit_guild_app/presentation/providers/on_created_guild.dart';

class GuildCreatePage extends HookConsumerWidget {
  const GuildCreatePage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final imageFile = useState&lt;File?&gt;(null);
    final picker = useMemoized(ImagePicker.new);

    /// å†™çœŸã‚’é¸æŠã—ã¦å††çŠ¶ã«ã‚¯ãƒ­ãƒƒãƒ—ã™ã‚‹
    Future&lt;void&gt; pickAndCropImage() async {
      final pickedFile = await picker.pickImage(source: ImageSource.gallery);

      if (pickedFile != null) {
        final croppedFile = await ImageCropper().cropImage(
          sourcePath: pickedFile.path,
          aspectRatio: const CropAspectRatio(ratioX: 1, ratioY: 1), // æ­£æ–¹å½¢ã«ã‚¯ãƒ­ãƒƒãƒ—
          uiSettings: [
            AndroidUiSettings(
              hideBottomControls: true, // ãƒœãƒˆãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«éè¡¨ç¤º
              lockAspectRatio: true, // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’å›ºå®š
            ),
            IOSUiSettings(
              aspectRatioLockEnabled: true, // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’å›ºå®š
            ),
          ],
        );

        if (croppedFile != null) {
          imageFile.value = File(croppedFile.path);
        } else {
          debugPrint('ã‚¯ãƒ­ãƒƒãƒ—ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
        }
      } else {
        debugPrint('ç”»åƒé¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
      }
    }

    /// å†™çœŸã‚’å‰Šé™¤
    void deleteImage() {
      imageFile.value = null;
      debugPrint('ç”»åƒãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
    }

    return Scaffold(
      appBar: AppBar(title: const Text('GuildCreatePage')),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            imageFile.value != null
                ? Column(
                    children: [
                      ClipRRect(
                        borderRadius: BorderRadius.circular(8),
                        child: Image.file(
                          imageFile.value!,
                          width: 150,
                          height: 150,
                          fit: BoxFit.cover,
                        ),
                      ),
                      const SizedBox(height: 10),
                      ElevatedButton(
                        onPressed: deleteImage,
                        child: const Text('ç”»åƒã‚’å‰Šé™¤'),
                      ),
                    ],
                  )
                : const Text('ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“'),
            const SizedBox(height: 20),
            ElevatedButton(
              onPressed: () async {
                final hasPermission = await hasPhotoPermission(context);
                if (hasPermission) {
                  await pickAndCropImage();
                }
              },
              child: const Text('ã‚®ãƒ«ãƒ‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’é¸æŠ'),
            ),
            ElevatedButton(
              onPressed: () {
                ref.read(onCreatedGuildNotifierProvider.notifier).trigger();
                context.pop();
              },
              child: const Text('Create'),
            ),
          ],
        ),
      ),
    );
  }

  /// å†™çœŸã®æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€æ¨©é™ãŒã‚ã‚Œã° true ã‚’è¿”ã™
  Future&lt;bool&gt; hasPhotoPermission(BuildContext context) async {
    final status = await Permission.photos.request();

    switch (status) {
      case PermissionStatus.granted:
      case PermissionStatus.limited:
        // è¨±å¯æ¸ˆã¿ã®å ´åˆ
        return true;

      case PermissionStatus.permanentlyDenied:
        // æ°¸ä¹…ã«æ‹’å¦ã•ã‚Œã¦ã„ã‚‹å ´åˆ
        if (context.mounted) {
          _showPermissionDialog(context);
        }
        return false;

      case PermissionStatus.denied:
      case PermissionStatus.restricted:
      case PermissionStatus.provisional:
        // ãã®ä»–ã®å ´åˆ
        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('å†™çœŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚')),
          );
        }
        return false;
    }
  }

  /// è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
  void _showPermissionDialog(BuildContext context) {
    showDialog&lt;void&gt;(
      context: context,
      builder: (context) =&gt; AlertDialog(
        title: const Text('å†™çœŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦ã§ã™'),
        content: const Text('å†™çœŸã‚’é¸æŠã™ã‚‹ã«ã¯ã€è¨­å®šã§å†™çœŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„ã€‚'),
        actions: [
          TextButton(
            onPressed: () {
              context.pop();
            },
            child: const Text('ã‚­ãƒ£ãƒ³ã‚»ãƒ«'),
          ),
          TextButton(
            onPressed: () async =&gt; openAppSettings(),
            child: const Text('è¨­å®šã‚’é–‹ã'),
          ),
        ],
      ),
    );
  }
}

import 'dart:io';

import 'package:flutter/material.dart';
import 'package:flutter_hooks/flutter_hooks.dart';
import 'package:go_router/go_router.dart';
import 'package:hooks_riverpod/hooks_riverpod.dart';
import 'package:image_cropper/image_cropper.dart';
import 'package:image_picker/image_picker.dart';
import 'package:permission_handler/permission_handler.dart';
import 'package:snpit_guild_app/presentation/providers/on_created_guild.dart';

class GuildCreatePage extends HookConsumerWidget {
  const GuildCreatePage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final imageFile = useState&lt;File?&gt;(null);
    final picker = useMemoized(ImagePicker.new);

    /// å†™çœŸã‚’é¸æŠã—ã¦å††çŠ¶ã«ã‚¯ãƒ­ãƒƒãƒ—ã™ã‚‹
    Future&lt;void&gt; pickAndCropImage() async {
      final pickedFile = await picker.pickImage(source: ImageSource.gallery);

      if (pickedFile != null) {
        final croppedFile = await ImageCropper().cropImage(
          sourcePath: pickedFile.path,
          aspectRatio: const CropAspectRatio(ratioX: 1, ratioY: 1), // æ­£æ–¹å½¢ã«ã‚¯ãƒ­ãƒƒãƒ—
          uiSettings: [
            AndroidUiSettings(
              hideBottomControls: true, // ãƒœãƒˆãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«éè¡¨ç¤º
              lockAspectRatio: true, // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’å›ºå®š
            ),
            IOSUiSettings(
              aspectRatioLockEnabled: true, // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’å›ºå®š
            ),
          ],
        );

        if (croppedFile != null) {
          imageFile.value = File(croppedFile.path);
        } else {
          debugPrint('ã‚¯ãƒ­ãƒƒãƒ—ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
        }
      } else {
        debugPrint('ç”»åƒé¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
      }
    }

    /// å†™çœŸã‚’å‰Šé™¤
    void deleteImage() {
      imageFile.value = null;
      debugPrint('ç”»åƒãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
    }

    return Scaffold(
      appBar: AppBar(title: const Text('GuildCreatePage')),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            imageFile.value != null
                ? Column(
                    children: [
                      ClipRRect(
                        borderRadius: BorderRadius.circular(8),
                        child: Image.file(
                          imageFile.value!,
                          width: 150,
                          height: 150,
                          fit: BoxFit.cover,
                        ),
                      ),
                      const SizedBox(height: 10),
                      ElevatedButton(
                        onPressed: deleteImage,
                        child: const Text('ç”»åƒã‚’å‰Šé™¤'),
                      ),
                    ],
                  )
                : const Text('ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“'),
            const SizedBox(height: 20),
            ElevatedButton(
              onPressed: () async {
                final hasPermission = await hasPhotoPermission(context);
                if (hasPermission) {
                  await pickAndCropImage();
                }
              },
              child: const Text('ã‚®ãƒ«ãƒ‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’é¸æŠ'),
            ),
            ElevatedButton(
              onPressed: () {
                ref.read(onCreatedGuildNotifierProvider.notifier).trigger();
                context.pop();
              },
              child: const Text('Create'),
            ),
          ],
        ),
      ),
    );
  }

  /// å†™çœŸã®æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€æ¨©é™ãŒã‚ã‚Œã° true ã‚’è¿”ã™
  Future&lt;bool&gt; hasPhotoPermission(BuildContext context) async {
    final status = await Permission.photos.request();

    switch (status) {
      case PermissionStatus.granted:
      case PermissionStatus.limited:
        // è¨±å¯æ¸ˆã¿ã®å ´åˆ
        return true;

      case PermissionStatus.permanentlyDenied:
        // æ°¸ä¹…ã«æ‹’å¦ã•ã‚Œã¦ã„ã‚‹å ´åˆ
        if (context.mounted) {
          _showPermissionDialog(context);
        }
        return false;

      case PermissionStatus.denied:
      case PermissionStatus.restricted:
      case PermissionStatus.provisional:
        // ãã®ä»–ã®å ´åˆ
        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('å†™çœŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚')),
          );
        }
        return false;
    }
  }

  /// è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
  void _showPermissionDialog(BuildContext context) {
    showDialog&lt;void&gt;(
      context: context,
      builder: (context) =&gt; AlertDialog(
        title: const Text('å†™çœŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦ã§ã™'),
        content: const Text('å†™çœŸã‚’é¸æŠã™ã‚‹ã«ã¯ã€è¨­å®šã§å†™çœŸã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„ã€‚'),
        actions: [
          TextButton(
            onPressed: () {
              context.pop();
            },
            child: const Text('ã‚­ãƒ£ãƒ³ã‚»ãƒ«'),
          ),
          TextButton(
            onPressed: () async =&gt; openAppSettings(),
            child: const Text('è¨­å®šã‚’é–‹ã'),
          ),
        ],
      ),
    );
  }
}

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/12/23 22:20:59*

ã‚®ãƒ«ãƒ‰ä½œæˆã®éš›ã«APIã‚’ã‚³ãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®æ‰‹é †ã§ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ï¼š

1. **ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**: ã‚®ãƒ«ãƒ‰ä½œæˆAPIã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹`GuildCreateProvider`ã‚’ä½œæˆã—ã¾ã™ã€‚
2. **ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ä½œæˆ**: ã‚®ãƒ«ãƒ‰åã‚„ã‚¢ã‚¤ã‚³ãƒ³ã‚’å«ã‚€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã‚’å®šç¾©ã—ã¾ã™ã€‚
3. **APIã‚³ãƒ¼ãƒ«ã‚’å®Ÿè¡Œ**: `GuildCreatePage`ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ"Create"ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã«APIã‚³ãƒ¼ãƒ«ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

ä»¥ä¸‹ã«æ›´æ–°ã—ãŸã‚³ãƒ¼ãƒ‰ã‚’ç¤ºã—ã¾ã™ï¼š

### ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®è¿½åŠ 

```dart
import 'package:hooks_riverpod/hooks_riverpod.dart';
import 'package:dio/dio.dart';

final guildCreateProvider = Provider((ref) => GuildCreateService());

class GuildCreateService {
  final Dio _dio = Dio();

  Future<void> createGuild({required String name, required File? icon}) async {
    try {
      final formData = FormData.fromMap({
        'name': name,
        if (icon != null)
          'icon': await MultipartFile.fromFile(icon.path, filename: 'icon.jpg'),
      });

      final response = await _dio.post(
        'https://example.com/api/guilds',
        data: formData,
      );

      if (response.statusCode == 201) {
        print('Guild created successfully');
      } else {
        throw Exception('Failed to create guild');
      }
    } catch (e) {
      print('Error creating guild: $e');
      rethrow;
    }
  }
}
```

### GuildCreatePageã®æ›´æ–°

```dart
ElevatedButton(
  onPressed: () async {
    if (imageFile.value == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('ã‚®ãƒ«ãƒ‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚')),
      );
      return;
    }

    try {
      final guildName = 'Example Guild'; // ã‚®ãƒ«ãƒ‰åã‚’å…¥åŠ›æ¬„ã‹ã‚‰å–å¾—ã™ã‚‹å ´åˆã¯æ›´æ–°
      await ref.read(guildCreateProvider).createGuild(
            name: guildName,
            icon: imageFile.value,
          );
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('ã‚®ãƒ«ãƒ‰ãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼')),
      );
      context.pop();
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('ã‚®ãƒ«ãƒ‰ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚')),
      );
    }
  },
  child: const Text('Create'),
),
```

### ãƒã‚¤ãƒ³ãƒˆ

1. **`FormData`ã‚’ä½¿ç”¨**: ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã€`FormData`ã‚’æ§‹ç¯‰ã€‚
2. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: APIå‘¼ã³å‡ºã—ä¸­ã®ã‚¨ãƒ©ãƒ¼ã«å¯¾å‡¦ã€‚
3. **Dioãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é€ä¿¡ã«ä½¿ç”¨ã€‚
4. **ã‚®ãƒ«ãƒ‰åå…¥åŠ›**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®TextFieldã‚’è¿½åŠ ã—ã¦`guildName`ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚

### å¿…è¦ãªä¾å­˜é–¢ä¿‚

`pubspec.yaml`ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

```yaml
dependencies:
  dio: ^5.0.0
```

ã“ã‚Œã§ã€APIå‘¼ã³å‡ºã—ã®å®Ÿè£…ãŒå®Œäº†ã—ã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦UIã«ã‚®ãƒ«ãƒ‰åå…¥åŠ›æ¬„ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

---
