# QRコード生成と読取

日付: 2024-06-14

---

## 👤 ユーザー
*2024/06/14 17:29:36*

QRコードの生成と読み取りを実装したい。

---

## 🤖 アシスタント
*2024/06/14 17:30:14*

QRコードの生成と読み取りは、Swiftを使ったiOSアプリ開発でよく使われる機能です。以下に、QRコードの生成と読み取りを実装するための基本的な手順を示します。

### 1. QRコードの生成

QRコードの生成には`CoreImage`フレームワークを使用します。

```swift
import UIKit
import CoreImage

func generateQRCode(from string: String) -> UIImage? {
    let data = string.data(using: String.Encoding.ascii)

    if let filter = CIFilter(name: "CIQRCodeGenerator") {
        filter.setValue(data, forKey: "inputMessage")
        let transform = CGAffineTransform(scaleX: 10, y: 10)

        if let output = filter.outputImage?.transformed(by: transform) {
            return UIImage(ciImage: output)
        }
    }
    return nil
}

// 使用例
if let qrCodeImage = generateQRCode(from: "https://example.com") {
    // qrCodeImageをUIImageViewなどに設定
}
```

### 2. QRコードの読み取り

QRコードの読み取りには、`AVFoundation`フレームワークを使用します。

```swift
import UIKit
import AVFoundation

class QRCodeScannerViewController: UIViewController, AVCaptureMetadataOutputObjectsDelegate {
    var captureSession: AVCaptureSession!
    var previewLayer: AVCaptureVideoPreviewLayer!

    override func viewDidLoad() {
        super.viewDidLoad()

        captureSession = AVCaptureSession()

        guard let videoCaptureDevice = AVCaptureDevice.default(for: .video) else { return }
        let videoInput: AVCaptureDeviceInput

        do {
            videoInput = try AVCaptureDeviceInput(device: videoCaptureDevice)
        } catch {
            return
        }

        if (captureSession.canAddInput(videoInput)) {
            captureSession.addInput(videoInput)
        } else {
            failed()
            return
        }

        let metadataOutput = AVCaptureMetadataOutput()

        if (captureSession.canAddOutput(metadataOutput)) {
            captureSession.addOutput(metadataOutput)

            metadataOutput.setMetadataObjectsDelegate(self, queue: DispatchQueue.main)
            metadataOutput.metadataObjectTypes = [.qr]
        } else {
            failed()
            return
        }

        previewLayer = AVCaptureVideoPreviewLayer(session: captureSession)
        previewLayer.frame = view.layer.bounds
        previewLayer.videoGravity = .resizeAspectFill
        view.layer.addSublayer(previewLayer)

        captureSession.startRunning()
    }

    func failed() {
        let alertController = UIAlertController(title: "Scanning not supported", message: "Your device does not support scanning a code from an item. Please use a device with a camera.", preferredStyle: .alert)
        alertController.addAction(UIAlertAction(title: "OK", style: .default))
        present(alertController, animated: true)
        captureSession = nil
    }

    override func viewWillAppear(_ animated: Bool) {
        super.viewWillAppear(animated)

        if (captureSession?.isRunning == false) {
            captureSession.startRunning()
        }
    }

    override func viewWillDisappear(_ animated: Bool) {
        super.viewWillDisappear(animated)

        if (captureSession?.isRunning == true) {
            captureSession.stopRunning()
        }
    }

    func metadataOutput(_ output: AVCaptureMetadataOutput, didOutput metadataObjects: [AVMetadataObject], from connection: AVCaptureConnection) {
        captureSession.stopRunning()

        if let metadataObject = metadataObjects.first {
            guard let readableObject = metadataObject as? AVMetadataMachineReadableCodeObject else { return }
            guard let stringValue = readableObject.stringValue else { return }
            AudioServicesPlaySystemSound(SystemSoundID(kSystemSoundID_Vibrate))
            found(code: stringValue)
        }

        dismiss(animated: true)
    }

    func found(code: String) {
        print("QRコードの内容: \(code)")
    }

    override var prefersStatusBarHidden: Bool {
        return true
    }

    override var supportedInterfaceOrientations: UIInterfaceOrientationMask {
        return .portrait
    }
}
```

### 手順のまとめ
1. `CoreImage`を使ってQRコードを生成。
2. `AVFoundation`を使ってQRコードを読み取る。

上記のコードをプロジェクトに追加し、QRコードの生成と読み取りを実現してください。質問があれば教えてください。

---

## 👤 ユーザー
*2024/06/14 17:32:29*

iOS16以上で何か使えない？

---

## 🤖 アシスタント
*2024/06/14 17:32:51*

iOS 16以上では、Appleの新しいAPIを利用してQRコードの生成と読み取りがより簡単になっています。以下はそれぞれの機能に対する最新の方法です。

### 1. QRコードの生成

iOS 16では、`CIQRCodeGenerator`フィルターを使って簡単にQRコードを生成できます。以下のコードはiOS 16に適しています。

```swift
import UIKit

func generateQRCode(from string: String) -> UIImage? {
    let data = string.data(using: .utf8)
    guard let qrFilter = CIFilter(name: "CIQRCodeGenerator") else { return nil }
    qrFilter.setValue(data, forKey: "inputMessage")
    qrFilter.setValue("Q", forKey: "inputCorrectionLevel")

    guard let qrImage = qrFilter.outputImage else { return nil }
    let transform = CGAffineTransform(scaleX: 10, y: 10)
    let scaledQrImage = qrImage.transformed(by: transform)
    
    return UIImage(ciImage: scaledQrImage)
}

// 使用例
if let qrCodeImage = generateQRCode(from: "https://example.com") {
    // qrCodeImageをUIImageViewなどに設定
}
```

### 2. QRコードの読み取り

iOS 16では、`DataScannerViewController`を使ってQRコードを読み取ることができます。これにより、より簡単にQRコードのスキャン機能を実装できます。

```swift
import UIKit
import VisionKit

class QRCodeScannerViewController: UIViewController, DataScannerViewControllerDelegate {
    override func viewDidLoad() {
        super.viewDidLoad()
        
        guard DataScannerViewController.isSupported else {
            print("このデバイスではDataScannerViewControllerはサポートされていません。")
            return
        }
        
        let scannerViewController = DataScannerViewController(
            recognizedDataTypes: [.barcode()],
            qualityLevel: .fast,
            recognizesMultipleItems: false,
            isGuidanceEnabled: true,
            isHighlightingEnabled: true
        )
        
        scannerViewController.delegate = self
        
        present(scannerViewController, animated: true)
        try? scannerViewController.startScanning()
    }
    
    func dataScanner(_ dataScanner: DataScannerViewController, didTapOn item: RecognizedItem) {
        guard case let .barcode(barcode) = item else { return }
        print("QRコードの内容: \(barcode.payloadStringValue ?? "")")
        dataScanner.stopScanning()
        dataScanner.dismiss(animated: true, completion: nil)
    }
}
```

### 手順のまとめ
1. `CIQRCodeGenerator`を使ってQRコードを生成。
2. `DataScannerViewController`を使ってQRコードを読み取る。

これにより、iOS 16以上のデバイスでより簡単かつ効率的にQRコードの生成と読み取りを行うことができます。質問があれば教えてください。

---

## 👤 ユーザー
*2024/06/14 17:32:58*

SwiftUIで実装したい。

---

## 🤖 アシスタント
*2024/06/14 17:33:30*

SwiftUIを使ってQRコードの生成と読み取りを実装することも可能です。以下に、SwiftUIでの実装方法を示します。

### 1. QRコードの生成 (SwiftUI)

まず、QRコードを生成するビューを作成します。

```swift
import SwiftUI
import CoreImage.CIFilterBuiltins

struct QRCodeGeneratorView: View {
    @State private var text = "https://example.com"
    private let context = CIContext()
    private let filter = CIFilter.qrCodeGenerator()
    
    var body: some View {
        VStack {
            TextField("Enter text", text: $text)
                .textFieldStyle(RoundedBorderTextFieldStyle())
                .padding()
            
            if let qrCodeImage = generateQRCode(from: text) {
                Image(uiImage: qrCodeImage)
                    .interpolation(.none)
                    .resizable()
                    .scaledToFit()
                    .frame(width: 200, height: 200)
            }
        }
        .padding()
    }
    
    func generateQRCode(from string: String) -> UIImage? {
        let data = Data(string.utf8)
        filter.setValue(data, forKey: "inputMessage")
        
        if let outputImage = filter.outputImage {
            if let cgImage = context.createCGImage(outputImage, from: outputImage.extent) {
                return UIImage(cgImage: cgImage)
            }
        }
        return nil
    }
}

struct QRCodeGeneratorView_Previews: PreviewProvider {
    static var previews: some View {
        QRCodeGeneratorView()
    }
}
```

### 2. QRコードの読み取り (SwiftUI)

次に、QRコードを読み取るビューを作成します。iOS 16では、`DataScannerViewController`を使うことができます。これはSwiftUIに直接組み込むことはできないため、UIViewControllerRepresentableを使用してSwiftUIと統合します。

```swift
import SwiftUI
import VisionKit

struct QRCodeScannerView: UIViewControllerRepresentable {
    class Coordinator: NSObject, DataScannerViewControllerDelegate {
        var parent: QRCodeScannerView
        
        init(parent: QRCodeScannerView) {
            self.parent = parent
        }
        
        func dataScanner(_ dataScanner: DataScannerViewController, didTapOn item: RecognizedItem) {
            guard case let .barcode(barcode) = item else { return }
            parent.scannedCode = barcode.payloadStringValue ?? ""
            dataScanner.stopScanning()
            dataScanner.dismiss(animated: true, completion: nil)
        }
    }
    
    @Binding var scannedCode: String
    @Environment(\.presentationMode) var presentationMode
    
    func makeCoordinator() -> Coordinator {
        Coordinator(parent: self)
    }
    
    func makeUIViewController(context: Context) -> DataScannerViewController {
        let scannerViewController = DataScannerViewController(
            recognizedDataTypes: [.barcode()],
            qualityLevel: .fast,
            recognizesMultipleItems: false,
            isGuidanceEnabled: true,
            isHighlightingEnabled: true
        )
        
        scannerViewController.delegate = context.coordinator
        
        return scannerViewController
    }
    
    func updateUIViewController(_ uiViewController: DataScannerViewController, context: Context) {
        try? uiViewController.startScanning()
    }
}

struct ContentView: View {
    @State private var scannedCode: String = ""
    @State private var isShowingScanner = false
    
    var body: some View {
        VStack {
            Text("Scanned QR Code: \(scannedCode)")
                .padding()
            
            Button("Scan QR Code") {
                isShowingScanner = true
            }
            .sheet(isPresented: $isShowingScanner) {
                QRCodeScannerView(scannedCode: $scannedCode)
            }
        }
        .padding()
    }
}

struct ContentView_Previews: PreviewProvider {
    static var previews: some View {
        ContentView()
    }
}
```

### 手順のまとめ

1. `QRCodeGeneratorView`を使用してSwiftUIでQRコードを生成。
2. `QRCodeScannerView`を使用してSwiftUIでQRコードを読み取り。

上記の実装をプロジェクトに追加することで、SwiftUIを使用してQRコードの生成と読み取りが可能になります。質問があれば教えてください。

---

## 👤 ユーザー
*2024/06/14 17:48:11*

以下について生成するボタンを追加してほしいのと。QRCodeDriverProtocol にプロトコルを定義して、クリーンアーキテクチャで実装してほしい。

/// @mockable
public protocol QRCodeDriverProtocol: AnyObject {}

public final class QRCodeDriver: QRCodeDriverProtocol {
    public init() {
        OSLogger.initLog()
    }

    deinit {
        OSLogger.deinitLog()
    }
}


public struct QRCodeGeneratorView&lt;Dependency: RootDIContainerDependency&gt;: View {
    private let dependency: Dependency
    @StateObject private var presenter: QRCodeGeneratorPresenter&lt;Dependency&gt;
    
    public init(dependency: Dependency) {
        self.dependency = dependency
        _presenter = .init(wrappedValue: QRCodeGeneratorPresenter(dependency: dependency))
    }
}

@MainActor
final class QRCodeGeneratorPresenter&lt;Dependency: QRCodeGeneratorPresenterDependency&gt;: ObservableObject {
    private let dependency: Dependency

    init(dependency: Dependency) {
        dependency.logDriver.initLog()

        self.dependency = dependency
    }

    deinit {
        OSLogger.deinitLog()
    }

    func onAppear() async {
        dependency.logDriver.onAppearLog()
    }

    func onDisappear() {
        dependency.logDriver.onDisappearLog()
    }
}

/// @mockable(typealias: xxxAT = xxxMock;)
public protocol QRCodeGeneratorPresenterDependency: CommonPresenterDependency, QRCodeDriverProvider {}

/// @mockable(typealias: QRCodeDriverProtocolAT = QRCodeDriverProtocolMock;)
public protocol QRCodeDriverProvider {
    associatedtype QRCodeDriverProtocolAT: QRCodeDriverProtocol

    var qRCodeDriver: QRCodeDriverProtocolAT { get }
}


import SwiftUI
import CoreImage.CIFilterBuiltins

struct QRCodeGeneratorView: View {
    @State private var text = "https://example.com"
    private let context = CIContext()
    private let filter = CIFilter.qrCodeGenerator()
    
    var body: some View {
        VStack {
            TextField("Enter text", text: $text)
                .textFieldStyle(RoundedBorderTextFieldStyle())
                .padding()
            
            if let qrCodeImage = generateQRCode(from: text) {
                Image(uiImage: qrCodeImage)
                    .interpolation(.none)
                    .resizable()
                    .scaledToFit()
                    .frame(width: 200, height: 200)
            }
        }
        .padding()
    }
    
    func generateQRCode(from string: String) -&gt; UIImage? {
        let data = Data(string.utf8)
        filter.setValue(data, forKey: "inputMessage")
        
        if let outputImage = filter.outputImage {
            if let cgImage = context.createCGImage(outputImage, from: outputImage.extent) {
                return UIImage(cgImage: cgImage)
            }
        }
        return nil
    }
}

struct QRCodeGeneratorView_Previews: PreviewProvider {
    static var previews: some View {
        QRCodeGeneratorView()
    }
}

---

## 🤖 アシスタント
*2024/06/14 17:48:43*

クリーンアーキテクチャを用いて、QRコードの生成機能を持つSwiftUIのビューにボタンを追加し、プロトコルやプレゼンター、ドライバを定義します。以下のコードは、あなたが示した要件に基づいて構築されています。

### 1. プロトコルの定義

```swift
import Foundation

/// @mockable
public protocol QRCodeDriverProtocol: AnyObject {
    func generateQRCode(from string: String) -> UIImage?
}

public final class QRCodeDriver: QRCodeDriverProtocol {
    private let context = CIContext()
    private let filter = CIFilter.qrCodeGenerator()

    public init() {
        OSLogger.initLog()
    }

    deinit {
        OSLogger.deinitLog()
    }

    public func generateQRCode(from string: String) -> UIImage? {
        let data = Data(string.utf8)
        filter.setValue(data, forKey: "inputMessage")
        
        if let outputImage = filter.outputImage {
            if let cgImage = context.createCGImage(outputImage, from: outputImage.extent) {
                return UIImage(cgImage: cgImage)
            }
        }
        return nil
    }
}
```

### 2. DIコンテナとプロバイダーの定義

```swift
import Foundation

public protocol QRCodeGeneratorPresenterDependency: CommonPresenterDependency, QRCodeDriverProvider {}

public protocol QRCodeDriverProvider {
    associatedtype QRCodeDriverProtocolAT: QRCodeDriverProtocol

    var qRCodeDriver: QRCodeDriverProtocolAT { get }
}
```

### 3. プレゼンターの定義

```swift
import SwiftUI

@MainActor
final class QRCodeGeneratorPresenter<Dependency: QRCodeGeneratorPresenterDependency>: ObservableObject {
    private let dependency: Dependency
    @Published var qrCodeImage: UIImage?

    init(dependency: Dependency) {
        dependency.logDriver.initLog()
        self.dependency = dependency
    }

    deinit {
        OSLogger.deinitLog()
    }

    func onAppear() async {
        dependency.logDriver.onAppearLog()
    }

    func onDisappear() {
        dependency.logDriver.onDisappearLog()
    }

    func generateQRCode(from string: String) {
        qrCodeImage = dependency.qRCodeDriver.generateQRCode(from: string)
    }
}
```

### 4. SwiftUIビューの定義

```swift
import SwiftUI

public struct QRCodeGeneratorView<Dependency: QRCodeGeneratorPresenterDependency>: View {
    private let dependency: Dependency
    @StateObject private var presenter: QRCodeGeneratorPresenter<Dependency>
    @State private var text = "https://example.com"
    
    public init(dependency: Dependency) {
        self.dependency = dependency
        _presenter = .init(wrappedValue: QRCodeGeneratorPresenter(dependency: dependency))
    }
    
    public var body: some View {
        VStack {
            TextField("Enter text", text: $text)
                .textFieldStyle(RoundedBorderTextFieldStyle())
                .padding()
            
            Button(action: {
                presenter.generateQRCode(from: text)
            }) {
                Text("Generate QR Code")
            }
            .padding()

            if let qrCodeImage = presenter.qrCodeImage {
                Image(uiImage: qrCodeImage)
                    .interpolation(.none)
                    .resizable()
                    .scaledToFit()
                    .frame(width: 200, height: 200)
            }
        }
        .padding()
        .onAppear {
            Task {
                await presenter.onAppear()
            }
        }
        .onDisappear {
            presenter.onDisappear()
        }
    }
}

struct QRCodeGeneratorView_Previews: PreviewProvider {
    static var previews: some View {
        QRCodeGeneratorView(dependency: MockDependency())
    }
}

final class MockDependency: QRCodeGeneratorPresenterDependency {
    var qRCodeDriver: QRCodeDriverProtocol {
        return QRCodeDriver()
    }

    var logDriver: LogDriver {
        return LogDriver()
    }
}
```

この実装により、SwiftUIビューにテキストフィールドと「Generate QR Code」ボタンが追加され、QRコードを生成できるようになります。また、クリーンアーキテクチャの原則に従って、依存性の注入とプロトコルに基づく設計を行っています。

---

## 👤 ユーザー
*2024/06/14 18:20:34*

Driver側にUIKitをインポートしたくない

---

## 🤖 アシスタント
*2024/06/14 18:21:15*

UIKitをインポートせずにQRコードを生成するために、CoreImageを使用してQRコードを生成し、生成された画像を返すために必要な部分だけをUIKitに依存させるようにします。まず、Driver側ではQRコードを生成し、CoreImageのCIImageを返すようにします。次に、SwiftUIのViewでそのCIImageをUIImageに変換して表示します。

### 1. QRCodeDriverの更新 (UIKitを使用しない)

```swift
import Foundation
import CoreImage.CIFilterBuiltins

/// @mockable
public protocol QRCodeDriverProtocol: AnyObject {
    func generateQRCode(from string: String) -> CIImage?
}

public final class QRCodeDriver: QRCodeDriverProtocol {
    private let context = CIContext()
    private let filter = CIFilter.qrCodeGenerator()

    public init() {
        OSLogger.initLog()
    }

    deinit {
        OSLogger.deinitLog()
    }

    public func generateQRCode(from string: String) -> CIImage? {
        let data = Data(string.utf8)
        filter.setValue(data, forKey: "inputMessage")
        
        return filter.outputImage
    }
}
```

### 2. DIコンテナとプロバイダーの定義

この部分は前のコードと同じです。

```swift
import Foundation

public protocol QRCodeGeneratorPresenterDependency: CommonPresenterDependency, QRCodeDriverProvider {}

public protocol QRCodeDriverProvider {
    associatedtype QRCodeDriverProtocolAT: QRCodeDriverProtocol

    var qRCodeDriver: QRCodeDriverProtocolAT { get }
}
```

### 3. プレゼンターの定義

プレゼンターもほとんど変更はありませんが、CIImageを保持し、SwiftUIビューで変換します。

```swift
import SwiftUI

@MainActor
final class QRCodeGeneratorPresenter<Dependency: QRCodeGeneratorPresenterDependency>: ObservableObject {
    private let dependency: Dependency
    @Published var qrCodeImage: CIImage?

    init(dependency: Dependency) {
        dependency.logDriver.initLog()
        self.dependency = dependency
    }

    deinit {
        OSLogger.deinitLog()
    }

    func onAppear() async {
        dependency.logDriver.onAppearLog()
    }

    func onDisappear() {
        dependency.logDriver.onDisappearLog()
    }

    func generateQRCode(from string: String) {
        qrCodeImage = dependency.qRCodeDriver.generateQRCode(from: string)
    }
}
```

### 4. SwiftUIビューの定義

SwiftUIビューで、CIImageをUIImageに変換して表示します。

```swift
import SwiftUI
import CoreImage.CIFilterBuiltins

public struct QRCodeGeneratorView<Dependency: QRCodeGeneratorPresenterDependency>: View {
    private let dependency: Dependency
    @StateObject private var presenter: QRCodeGeneratorPresenter<Dependency>
    @State private var text = "https://example.com"
    
    public init(dependency: Dependency) {
        self.dependency = dependency
        _presenter = .init(wrappedValue: QRCodeGeneratorPresenter(dependency: dependency))
    }
    
    public var body: some View {
        VStack {
            TextField("Enter text", text: $text)
                .textFieldStyle(RoundedBorderTextFieldStyle())
                .padding()
            
            Button(action: {
                presenter.generateQRCode(from: text)
            }) {
                Text("Generate QR Code")
            }
            .padding()

            if let qrCodeImage = presenter.qrCodeImage {
                Image(uiImage: convertCIImageToUIImage(ciImage: qrCodeImage))
                    .interpolation(.none)
                    .resizable()
                    .scaledToFit()
                    .frame(width: 200, height: 200)
            }
        }
        .padding()
        .onAppear {
            Task {
                await presenter.onAppear()
            }
        }
        .onDisappear {
            presenter.onDisappear()
        }
    }
    
    private func convertCIImageToUIImage(ciImage: CIImage) -> UIImage {
        let context = CIContext()
        if let cgImage = context.createCGImage(ciImage, from: ciImage.extent) {
            return UIImage(cgImage: cgImage)
        }
        return UIImage()
    }
}

struct QRCodeGeneratorView_Previews: PreviewProvider {
    static var previews: some View {
        QRCodeGeneratorView(dependency: MockDependency())
    }
}

final class MockDependency: QRCodeGeneratorPresenterDependency {
    var qRCodeDriver: QRCodeDriverProtocol {
        return QRCodeDriver()
    }

    var logDriver: LogDriver {
        return LogDriver()
    }
}
```

この実装では、`QRCodeDriver`はCoreImageのみを使用し、QRコードのCIImageを生成します。SwiftUIのビューでは、生成されたCIImageをUIImageに変換して表示します。この方法により、`QRCodeDriver`がUIKitに依存することなく、QRコードの生成機能を提供します。

---

## 👤 ユーザー
*2024/06/14 18:21:51*

これはclassのプロパティーで持つよりも関数内で持った方がよくないかな？

private let context = CIContext()
private let filter = CIFilter.qrCodeGenerator()

---

## 🤖 アシスタント
*2024/06/14 18:22:30*

確かに、`CIContext`と`CIFilter`をクラスのプロパティとして持つよりも、関数内でローカル変数として持つほうが良い場合があります。特に、生成処理が軽量であり、再利用の必要がない場合です。この方が、クラスのメモリ使用量を削減し、コードの可読性が向上することがあります。

以下は、その修正を行ったバージョンです。

### 1. QRCodeDriverの更新

```swift
import Foundation
import CoreImage.CIFilterBuiltins

/// @mockable
public protocol QRCodeDriverProtocol: AnyObject {
    func generateQRCode(from string: String) -> CIImage?
}

public final class QRCodeDriver: QRCodeDriverProtocol {
    public init() {
        OSLogger.initLog()
    }

    deinit {
        OSLogger.deinitLog()
    }

    public func generateQRCode(from string: String) -> CIImage? {
        let context = CIContext()
        let filter = CIFilter.qrCodeGenerator()
        let data = Data(string.utf8)
        filter.setValue(data, forKey: "inputMessage")
        
        return filter.outputImage
    }
}
```

### 2. DIコンテナとプロバイダーの定義

この部分は前のコードと同じです。

```swift
import Foundation

public protocol QRCodeGeneratorPresenterDependency: CommonPresenterDependency, QRCodeDriverProvider {}

public protocol QRCodeDriverProvider {
    associatedtype QRCodeDriverProtocolAT: QRCodeDriverProtocol

    var qRCodeDriver: QRCodeDriverProtocolAT { get }
}
```

### 3. プレゼンターの定義

プレゼンターも変更はありませんが、CIImageを保持し、SwiftUIビューで変換します。

```swift
import SwiftUI

@MainActor
final class QRCodeGeneratorPresenter<Dependency: QRCodeGeneratorPresenterDependency>: ObservableObject {
    private let dependency: Dependency
    @Published var qrCodeImage: CIImage?

    init(dependency: Dependency) {
        dependency.logDriver.initLog()
        self.dependency = dependency
    }

    deinit {
        OSLogger.deinitLog()
    }

    func onAppear() async {
        dependency.logDriver.onAppearLog()
    }

    func onDisappear() {
        dependency.logDriver.onDisappearLog()
    }

    func generateQRCode(from string: String) {
        qrCodeImage = dependency.qRCodeDriver.generateQRCode(from: string)
    }
}
```

### 4. SwiftUIビューの定義

SwiftUIビューで、CIImageをUIImageに変換して表示します。

```swift
import SwiftUI
import CoreImage.CIFilterBuiltins

public struct QRCodeGeneratorView<Dependency: QRCodeGeneratorPresenterDependency>: View {
    private let dependency: Dependency
    @StateObject private var presenter: QRCodeGeneratorPresenter<Dependency>
    @State private var text = "https://example.com"
    
    public init(dependency: Dependency) {
        self.dependency = dependency
        _presenter = .init(wrappedValue: QRCodeGeneratorPresenter(dependency: dependency))
    }
    
    public var body: some View {
        VStack {
            TextField("Enter text", text: $text)
                .textFieldStyle(RoundedBorderTextFieldStyle())
                .padding()
            
            Button(action: {
                presenter.generateQRCode(from: text)
            }) {
                Text("Generate QR Code")
            }
            .padding()

            if let qrCodeImage = presenter.qrCodeImage {
                Image(uiImage: convertCIImageToUIImage(ciImage: qrCodeImage))
                    .interpolation(.none)
                    .resizable()
                    .scaledToFit()
                    .frame(width: 200, height: 200)
            }
        }
        .padding()
        .onAppear {
            Task {
                await presenter.onAppear()
            }
        }
        .onDisappear {
            presenter.onDisappear()
        }
    }
    
    private func convertCIImageToUIImage(ciImage: CIImage) -> UIImage {
        let context = CIContext()
        if let cgImage = context.createCGImage(ciImage, from: ciImage.extent) {
            return UIImage(cgImage: cgImage)
        }
        return UIImage()
    }
}

struct QRCodeGeneratorView_Previews: PreviewProvider {
    static var previews: some View {
        QRCodeGeneratorView(dependency: MockDependency())
    }
}

final class MockDependency: QRCodeGeneratorPresenterDependency {
    var qRCodeDriver: QRCodeDriverProtocol {
        return QRCodeDriver()
    }

    var logDriver: LogDriver {
        return LogDriver()
    }
}
```

これにより、`CIContext`と`CIFilter`を関数内でローカル変数として扱うことで、クラスのメモリ使用量を削減し、コードの可読性を向上させています。

---

## 👤 ユーザー
*2024/06/14 18:22:35*

あと nil よりも throw したほうがいいはず。適切にerrorを定義してほしい。

---

## 🤖 アシスタント
*2024/06/14 18:23:12*

エラーハンドリングを適切に行うために、エラーを定義し、QRコード生成時にエラーを投げるようにします。

### 1. QRCodeErrorの定義

```swift
import Foundation

public enum QRCodeError: Error {
    case generationFailed
}
```

### 2. QRCodeDriverの更新 (エラーハンドリング)

```swift
import Foundation
import CoreImage.CIFilterBuiltins

/// @mockable
public protocol QRCodeDriverProtocol: AnyObject {
    func generateQRCode(from string: String) throws -> CIImage
}

public final class QRCodeDriver: QRCodeDriverProtocol {
    public init() {
        OSLogger.initLog()
    }

    deinit {
        OSLogger.deinitLog()
    }

    public func generateQRCode(from string: String) throws -> CIImage {
        let context = CIContext()
        let filter = CIFilter.qrCodeGenerator()
        let data = Data(string.utf8)
        filter.setValue(data, forKey: "inputMessage")
        
        guard let outputImage = filter.outputImage else {
            throw QRCodeError.generationFailed
        }
        
        return outputImage
    }
}
```

### 3. DIコンテナとプロバイダーの定義

この部分は前のコードと同じです。

```swift
import Foundation

public protocol QRCodeGeneratorPresenterDependency: CommonPresenterDependency, QRCodeDriverProvider {}

public protocol QRCodeDriverProvider {
    associatedtype QRCodeDriverProtocolAT: QRCodeDriverProtocol

    var qRCodeDriver: QRCodeDriverProtocolAT { get }
}
```

### 4. プレゼンターの定義

プレゼンターでエラーハンドリングを行います。

```swift
import SwiftUI

@MainActor
final class QRCodeGeneratorPresenter<Dependency: QRCodeGeneratorPresenterDependency>: ObservableObject {
    private let dependency: Dependency
    @Published var qrCodeImage: CIImage?
    @Published var errorMessage: String?

    init(dependency: Dependency) {
        dependency.logDriver.initLog()
        self.dependency = dependency
    }

    deinit {
        OSLogger.deinitLog()
    }

    func onAppear() async {
        dependency.logDriver.onAppearLog()
    }

    func onDisappear() {
        dependency.logDriver.onDisappearLog()
    }

    func generateQRCode(from string: String) {
        do {
            qrCodeImage = try dependency.qRCodeDriver.generateQRCode(from: string)
            errorMessage = nil
        } catch {
            errorMessage = error.localizedDescription
            qrCodeImage = nil
        }
    }
}
```

### 5. SwiftUIビューの定義

SwiftUIビューでエラーメッセージを表示します。

```swift
import SwiftUI
import CoreImage.CIFilterBuiltins

public struct QRCodeGeneratorView<Dependency: QRCodeGeneratorPresenterDependency>: View {
    private let dependency: Dependency
    @StateObject private var presenter: QRCodeGeneratorPresenter<Dependency>
    @State private var text = "https://example.com"
    
    public init(dependency: Dependency) {
        self.dependency = dependency
        _presenter = .init(wrappedValue: QRCodeGeneratorPresenter(dependency: dependency))
    }
    
    public var body: some View {
        VStack {
            TextField("Enter text", text: $text)
                .textFieldStyle(RoundedBorderTextFieldStyle())
                .padding()
            
            Button(action: {
                presenter.generateQRCode(from: text)
            }) {
                Text("Generate QR Code")
            }
            .padding()

            if let qrCodeImage = presenter.qrCodeImage {
                Image(uiImage: convertCIImageToUIImage(ciImage: qrCodeImage))
                    .interpolation(.none)
                    .resizable()
                    .scaledToFit()
                    .frame(width: 200, height: 200)
            }
            
            if let errorMessage = presenter.errorMessage {
                Text(errorMessage)
                    .foregroundColor(.red)
                    .padding()
            }
        }
        .padding()
        .onAppear {
            Task {
                await presenter.onAppear()
            }
        }
        .onDisappear {
            presenter.onDisappear()
        }
    }
    
    private func convertCIImageToUIImage(ciImage: CIImage) -> UIImage {
        let context = CIContext()
        if let cgImage = context.createCGImage(ciImage, from: ciImage.extent) {
            return UIImage(cgImage: cgImage)
        }
        return UIImage()
    }
}

struct QRCodeGeneratorView_Previews: PreviewProvider {
    static var previews: some View {
        QRCodeGeneratorView(dependency: MockDependency())
    }
}

final class MockDependency: QRCodeGeneratorPresenterDependency {
    var qRCodeDriver: QRCodeDriverProtocol {
        return QRCodeDriver()
    }

    var logDriver: LogDriver {
        return LogDriver()
    }
}
```

この実装により、QRコード生成時のエラーハンドリングが改善され、エラーが発生した場合には適切にエラーメッセージを表示することができます。

---
