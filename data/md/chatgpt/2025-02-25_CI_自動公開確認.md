# CI 自動公開確認

日付: 2025-02-25

---

## 👤 ユーザー
*2025/2/25 16:03:53*

このCIでアプリは公開されるのか、それともこれ以降にしなければならないタスクはあるのか？

  build\_android:
    env:
      BUILD\_TARGET: prod
    name: Build for android
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: ${{ github.event\_name == 'workflow\_dispatch' || github.event.workflow\_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Calculate build name
        id: calc\_build\_name
        run: |
          major=$(($GITHUB\_RUN\_NUMBER / 1000))
          minor=$(($GITHUB\_RUN\_NUMBER % 1000 / 100))
          patch=$(($GITHUB\_RUN\_NUMBER % 100))
          # Ensure that patch number is at least two digits
          printf -v patch\_formatted "%02d" $patch
          echo "BUILD\_NAME=$major.$minor.$patch\_formatted" &gt;&gt; $GITHUB\_ENV

      - uses: ./.github/actions/prepare\_build
        with:
          build\_name: ${{ env.BUILD\_NAME }}
          build\_target: ${BUILD\_TARGET}

      - uses: ./.github/actions/setup\_flutter
        with:
          ssh\_key: ${{ secrets.SSH\_KEY }}
          known\_hosts: ${{ secrets.KNOWN\_HOSTS }}

      - name: Create app/key.jks
        run: echo -n ${{ secrets.ANDROID\_KEY\_JKS }} | base64 -d &gt; android/app/key.jks

      - name: Create service-account-key.json
        run: echo -n ${{ secrets.SERVICE\_ACCOUNT\_KEY\_JSON }} | base64 -d &gt; android/service-account-key.json

      - name: Create keystore.properties
        run: |
          echo 'storeFile=key.jks' &gt; android/keystore.properties
          echo 'serviceAccountFile=service-account-key.json' &gt;&gt; android/keystore.properties
          echo 'storePassword=${{ secrets.ANDROID\_STORE\_PASSWORD }}' &gt;&gt; android/keystore.properties
          echo 'keyPassword=${{ secrets.ANDROID\_KEY\_PASSWORD }}' &gt;&gt; android/keystore.properties
          echo 'keyAlias=${{ secrets.ANDROID\_KEY\_ALIAS }}' &gt;&gt; android/keystore.properties

      #      - name: Create secrets google maps
      #        run: echo -n ${{ secrets.ANDROID\_SECRETS }} | base64 -d &gt; android/app/src/main/res/values/secrets.xml

      - name: Building Android AppBundle
        run: |
          flutter build appbundle --release \\
            --flavor ${BUILD\_TARGET} \\
            --build-name ${BUILD\_NAME} \\
            --build-number ${BUILD\_NUMBER} \\
            --obfuscate \\
            --split-debug-info=obfuscate/android

#      - name: AppBundle as artifact
#        uses: actions/upload-artifact@v2
#        with:
#          name: android-appbundle
#          path: build/app/outputs/bundle/prodRelease/app-prod-release.aab

      - name: Upload to GooglePlayStore
        id: android\_upload
        run: ./gradlew publishProdReleaseBundle
        working-directory: ./android

      - name: Notify Slack
        uses: ./.github/actions/deploy\_notifier
        if: always()
        with:
          os\_name: 'Android'
          branch: ${{ github.ref\_name }}
          job\_status: ${{ job.status == 'success' && 'success' || 'failure' }}
          slack\_webhook\_url: ${{ secrets.SLACK\_WEBHOOK\_URL }}

---

## 🤖 アシスタント
*2025/2/25 16:04:25*

このCIジョブ（`build\_android`）では、\*\*Google Play ストアにアプリをアップロード\*\*していますが、アプリが \*\*実際に公開（リリース）されるかどうか\*\* は、以下の点によります。

### \*\*このCIで行われること\*\*
1. \*\*Flutterのビルド準備\*\*
   - JDK 17 をセットアップ
   - `BUILD\_NAME` の計算（バージョン名の決定）
   - Flutter環境のセットアップ
   - キーストア、サービスアカウントキーの作成
   - `keystore.properties` の作成

2. \*\*Android App Bundle（AAB）のビルド\*\*
   - `flutter build appbundle --release` を実行
   - `--obfuscate`（難読化）と `--split-debug-info`（デバッグ情報分離）オプション付きでビルド

3. \*\*Google Play ストアへのアップロード\*\*
   - `./gradlew publishProdReleaseBundle` を実行
   - `prodRelease` の AAB を Google Play Console にアップロード

4. \*\*Slack 通知\*\*
   - 成功または失敗を Slack に通知

---

### \*\*このCIの実行結果\*\*
✅ \*\*アプリは Google Play ストアにアップロードされるが、自動的に公開はされない可能性が高い。\*\*

#### \*\*追加で必要な作業\*\*
1. \*\*Google Play Console の設定次第\*\*
   - `./gradlew publishProdReleaseBundle` が \*\*"内部テスト"、"クローズドテスト"、"オープンテスト"\*\* などのトラックにアップロードする設定になっている場合、手動で承認が必要。
   - "本番リリース" に直接アップロードする場合、Googleの審査や手動承認が必要になる可能性がある。

2. \*\*Google Play Console で手動でリリース\*\*
   - Google Play の「リリース管理」画面で、アップロードされた AAB を確認し、手動で公開。

3. \*\*Google Play の API 設定\*\*
   - Google Play の "Automated Publishing API" を有効にしていない場合、最終的なリリースは手動で行う必要がある。

---

### \*\*次にやるべきこと\*\*
- \*\*Google Play Console にログインし、アップロードされた AAB のステータスを確認する\*\*
  - 「リリースの概要」→「新しいバージョンがアップロードされたか？」  
  - 「審査待ち」や「リリース待ち」の状態になっていないか？
  
- \*\*自動リリースが必要なら、Google Play の API 設定を見直す\*\*
  - \[Google Play Developer API\](https://developers.google.com/android-publisher) を利用すれば、CI/CD で完全自動リリースが可能。

- \*\*手動でリリースする場合、Google Play Console で「リリース」ボタンを押す\*\*

---

### \*\*まとめ\*\*
🚀 \*\*このCIではアプリのビルドとストアへのアップロードまで自動化されているが、実際の公開（リリース）はGoogle Play Consoleの設定次第。\*\*  
次のアクションとして、Google Play Console で \*\*アップロードされたバージョンのステータスを確認\*\* し、必要に応じて手動リリースするか、自動リリースの設定を見直すとよいでしょう。

---
