# CI 自動公開確認

日付: 2025-02-25

---

## 👤 ユーザー
*2025/2/25 16:03:53*

このCIでアプリは公開されるのか、それともこれ以降にしなければならないタスクはあるのか？

  build_android:
    env:
      BUILD_TARGET: prod
    name: Build for android
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Calculate build name
        id: calc_build_name
        run: |
          major=$(($GITHUB_RUN_NUMBER / 1000))
          minor=$(($GITHUB_RUN_NUMBER % 1000 / 100))
          patch=$(($GITHUB_RUN_NUMBER % 100))
          # Ensure that patch number is at least two digits
          printf -v patch_formatted "%02d" $patch
          echo "BUILD_NAME=$major.$minor.$patch_formatted" &gt;&gt; $GITHUB_ENV

      - uses: ./.github/actions/prepare_build
        with:
          build_name: ${{ env.BUILD_NAME }}
          build_target: ${BUILD_TARGET}

      - uses: ./.github/actions/setup_flutter
        with:
          ssh_key: ${{ secrets.SSH_KEY }}
          known_hosts: ${{ secrets.KNOWN_HOSTS }}

      - name: Create app/key.jks
        run: echo -n ${{ secrets.ANDROID_KEY_JKS }} | base64 -d &gt; android/app/key.jks

      - name: Create service-account-key.json
        run: echo -n ${{ secrets.SERVICE_ACCOUNT_KEY_JSON }} | base64 -d &gt; android/service-account-key.json

      - name: Create keystore.properties
        run: |
          echo 'storeFile=key.jks' &gt; android/keystore.properties
          echo 'serviceAccountFile=service-account-key.json' &gt;&gt; android/keystore.properties
          echo 'storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}' &gt;&gt; android/keystore.properties
          echo 'keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}' &gt;&gt; android/keystore.properties
          echo 'keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}' &gt;&gt; android/keystore.properties

      #      - name: Create secrets google maps
      #        run: echo -n ${{ secrets.ANDROID_SECRETS }} | base64 -d &gt; android/app/src/main/res/values/secrets.xml

      - name: Building Android AppBundle
        run: |
          flutter build appbundle --release \
            --flavor ${BUILD_TARGET} \
            --build-name ${BUILD_NAME} \
            --build-number ${BUILD_NUMBER} \
            --obfuscate \
            --split-debug-info=obfuscate/android

#      - name: AppBundle as artifact
#        uses: actions/upload-artifact@v2
#        with:
#          name: android-appbundle
#          path: build/app/outputs/bundle/prodRelease/app-prod-release.aab

      - name: Upload to GooglePlayStore
        id: android_upload
        run: ./gradlew publishProdReleaseBundle
        working-directory: ./android

      - name: Notify Slack
        uses: ./.github/actions/deploy_notifier
        if: always()
        with:
          os_name: 'Android'
          branch: ${{ github.ref_name }}
          job_status: ${{ job.status == 'success' && 'success' || 'failure' }}
          slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

---

## 🤖 アシスタント
*2025/2/25 16:04:25*

このCIジョブ（`build_android`）では、**Google Play ストアにアプリをアップロード**していますが、アプリが **実際に公開（リリース）されるかどうか** は、以下の点によります。

### **このCIで行われること**
1. **Flutterのビルド準備**
   - JDK 17 をセットアップ
   - `BUILD_NAME` の計算（バージョン名の決定）
   - Flutter環境のセットアップ
   - キーストア、サービスアカウントキーの作成
   - `keystore.properties` の作成

2. **Android App Bundle（AAB）のビルド**
   - `flutter build appbundle --release` を実行
   - `--obfuscate`（難読化）と `--split-debug-info`（デバッグ情報分離）オプション付きでビルド

3. **Google Play ストアへのアップロード**
   - `./gradlew publishProdReleaseBundle` を実行
   - `prodRelease` の AAB を Google Play Console にアップロード

4. **Slack 通知**
   - 成功または失敗を Slack に通知

---

### **このCIの実行結果**
✅ **アプリは Google Play ストアにアップロードされるが、自動的に公開はされない可能性が高い。**

#### **追加で必要な作業**
1. **Google Play Console の設定次第**
   - `./gradlew publishProdReleaseBundle` が **"内部テスト"、"クローズドテスト"、"オープンテスト"** などのトラックにアップロードする設定になっている場合、手動で承認が必要。
   - "本番リリース" に直接アップロードする場合、Googleの審査や手動承認が必要になる可能性がある。

2. **Google Play Console で手動でリリース**
   - Google Play の「リリース管理」画面で、アップロードされた AAB を確認し、手動で公開。

3. **Google Play の API 設定**
   - Google Play の "Automated Publishing API" を有効にしていない場合、最終的なリリースは手動で行う必要がある。

---

### **次にやるべきこと**
- **Google Play Console にログインし、アップロードされた AAB のステータスを確認する**
  - 「リリースの概要」→「新しいバージョンがアップロードされたか？」  
  - 「審査待ち」や「リリース待ち」の状態になっていないか？
  
- **自動リリースが必要なら、Google Play の API 設定を見直す**
  - [Google Play Developer API](https://developers.google.com/android-publisher) を利用すれば、CI/CD で完全自動リリースが可能。

- **手動でリリースする場合、Google Play Console で「リリース」ボタンを押す**

---

### **まとめ**
🚀 **このCIではアプリのビルドとストアへのアップロードまで自動化されているが、実際の公開（リリース）はGoogle Play Consoleの設定次第。**  
次のアクションとして、Google Play Console で **アップロードされたバージョンのステータスを確認** し、必要に応じて手動リリースするか、自動リリースの設定を見直すとよいでしょう。

---
