# CI è‡ªå‹•å…¬é–‹ç¢ºèª

æ—¥ä»˜: 2025-02-25

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2025/2/25 16:03:53*

ã“ã®CIã§ã‚¢ãƒ—ãƒªã¯å…¬é–‹ã•ã‚Œã‚‹ã®ã‹ã€ãã‚Œã¨ã‚‚ã“ã‚Œä»¥é™ã«ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã‚¿ã‚¹ã‚¯ã¯ã‚ã‚‹ã®ã‹ï¼Ÿ

  build_android:
    env:
      BUILD_TARGET: prod
    name: Build for android
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Calculate build name
        id: calc_build_name
        run: |
          major=$(($GITHUB_RUN_NUMBER / 1000))
          minor=$(($GITHUB_RUN_NUMBER % 1000 / 100))
          patch=$(($GITHUB_RUN_NUMBER % 100))
          # Ensure that patch number is at least two digits
          printf -v patch_formatted "%02d" $patch
          echo "BUILD_NAME=$major.$minor.$patch_formatted" &gt;&gt; $GITHUB_ENV

      - uses: ./.github/actions/prepare_build
        with:
          build_name: ${{ env.BUILD_NAME }}
          build_target: ${BUILD_TARGET}

      - uses: ./.github/actions/setup_flutter
        with:
          ssh_key: ${{ secrets.SSH_KEY }}
          known_hosts: ${{ secrets.KNOWN_HOSTS }}

      - name: Create app/key.jks
        run: echo -n ${{ secrets.ANDROID_KEY_JKS }} | base64 -d &gt; android/app/key.jks

      - name: Create service-account-key.json
        run: echo -n ${{ secrets.SERVICE_ACCOUNT_KEY_JSON }} | base64 -d &gt; android/service-account-key.json

      - name: Create keystore.properties
        run: |
          echo 'storeFile=key.jks' &gt; android/keystore.properties
          echo 'serviceAccountFile=service-account-key.json' &gt;&gt; android/keystore.properties
          echo 'storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}' &gt;&gt; android/keystore.properties
          echo 'keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}' &gt;&gt; android/keystore.properties
          echo 'keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}' &gt;&gt; android/keystore.properties

      #      - name: Create secrets google maps
      #        run: echo -n ${{ secrets.ANDROID_SECRETS }} | base64 -d &gt; android/app/src/main/res/values/secrets.xml

      - name: Building Android AppBundle
        run: |
          flutter build appbundle --release \
            --flavor ${BUILD_TARGET} \
            --build-name ${BUILD_NAME} \
            --build-number ${BUILD_NUMBER} \
            --obfuscate \
            --split-debug-info=obfuscate/android

#      - name: AppBundle as artifact
#        uses: actions/upload-artifact@v2
#        with:
#          name: android-appbundle
#          path: build/app/outputs/bundle/prodRelease/app-prod-release.aab

      - name: Upload to GooglePlayStore
        id: android_upload
        run: ./gradlew publishProdReleaseBundle
        working-directory: ./android

      - name: Notify Slack
        uses: ./.github/actions/deploy_notifier
        if: always()
        with:
          os_name: 'Android'
          branch: ${{ github.ref_name }}
          job_status: ${{ job.status == 'success' && 'success' || 'failure' }}
          slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2025/2/25 16:04:25*

ã“ã®CIã‚¸ãƒ§ãƒ–ï¼ˆ`build_android`ï¼‰ã§ã¯ã€**Google Play ã‚¹ãƒˆã‚¢ã«ã‚¢ãƒ—ãƒªã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**ã—ã¦ã„ã¾ã™ãŒã€ã‚¢ãƒ—ãƒªãŒ **å®Ÿéš›ã«å…¬é–‹ï¼ˆãƒªãƒªãƒ¼ã‚¹ï¼‰ã•ã‚Œã‚‹ã‹ã©ã†ã‹** ã¯ã€ä»¥ä¸‹ã®ç‚¹ã«ã‚ˆã‚Šã¾ã™ã€‚

### **ã“ã®CIã§è¡Œã‚ã‚Œã‚‹ã“ã¨**
1. **Flutterã®ãƒ“ãƒ«ãƒ‰æº–å‚™**
   - JDK 17 ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
   - `BUILD_NAME` ã®è¨ˆç®—ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³åã®æ±ºå®šï¼‰
   - Flutterç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
   - ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã®ä½œæˆ
   - `keystore.properties` ã®ä½œæˆ

2. **Android App Bundleï¼ˆAABï¼‰ã®ãƒ“ãƒ«ãƒ‰**
   - `flutter build appbundle --release` ã‚’å®Ÿè¡Œ
   - `--obfuscate`ï¼ˆé›£èª­åŒ–ï¼‰ã¨ `--split-debug-info`ï¼ˆãƒ‡ãƒãƒƒã‚°æƒ…å ±åˆ†é›¢ï¼‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»˜ãã§ãƒ“ãƒ«ãƒ‰

3. **Google Play ã‚¹ãƒˆã‚¢ã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**
   - `./gradlew publishProdReleaseBundle` ã‚’å®Ÿè¡Œ
   - `prodRelease` ã® AAB ã‚’ Google Play Console ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

4. **Slack é€šçŸ¥**
   - æˆåŠŸã¾ãŸã¯å¤±æ•—ã‚’ Slack ã«é€šçŸ¥

---

### **ã“ã®CIã®å®Ÿè¡Œçµæœ**
âœ… **ã‚¢ãƒ—ãƒªã¯ Google Play ã‚¹ãƒˆã‚¢ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ãŒã€è‡ªå‹•çš„ã«å…¬é–‹ã¯ã•ã‚Œãªã„å¯èƒ½æ€§ãŒé«˜ã„ã€‚**

#### **è¿½åŠ ã§å¿…è¦ãªä½œæ¥­**
1. **Google Play Console ã®è¨­å®šæ¬¡ç¬¬**
   - `./gradlew publishProdReleaseBundle` ãŒ **"å†…éƒ¨ãƒ†ã‚¹ãƒˆ"ã€"ã‚¯ãƒ­ãƒ¼ã‚ºãƒ‰ãƒ†ã‚¹ãƒˆ"ã€"ã‚ªãƒ¼ãƒ—ãƒ³ãƒ†ã‚¹ãƒˆ"** ãªã©ã®ãƒˆãƒ©ãƒƒã‚¯ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹è¨­å®šã«ãªã£ã¦ã„ã‚‹å ´åˆã€æ‰‹å‹•ã§æ‰¿èªãŒå¿…è¦ã€‚
   - "æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹" ã«ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å ´åˆã€Googleã®å¯©æŸ»ã‚„æ‰‹å‹•æ‰¿èªãŒå¿…è¦ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

2. **Google Play Console ã§æ‰‹å‹•ã§ãƒªãƒªãƒ¼ã‚¹**
   - Google Play ã®ã€Œãƒªãƒªãƒ¼ã‚¹ç®¡ç†ã€ç”»é¢ã§ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸ AAB ã‚’ç¢ºèªã—ã€æ‰‹å‹•ã§å…¬é–‹ã€‚

3. **Google Play ã® API è¨­å®š**
   - Google Play ã® "Automated Publishing API" ã‚’æœ‰åŠ¹ã«ã—ã¦ã„ãªã„å ´åˆã€æœ€çµ‚çš„ãªãƒªãƒªãƒ¼ã‚¹ã¯æ‰‹å‹•ã§è¡Œã†å¿…è¦ãŒã‚ã‚‹ã€‚

---

### **æ¬¡ã«ã‚„ã‚‹ã¹ãã“ã¨**
- **Google Play Console ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸ AAB ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã™ã‚‹**
  - ã€Œãƒªãƒªãƒ¼ã‚¹ã®æ¦‚è¦ã€â†’ã€Œæ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‹ï¼Ÿã€  
  - ã€Œå¯©æŸ»å¾…ã¡ã€ã‚„ã€Œãƒªãƒªãƒ¼ã‚¹å¾…ã¡ã€ã®çŠ¶æ…‹ã«ãªã£ã¦ã„ãªã„ã‹ï¼Ÿ
  
- **è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹ãŒå¿…è¦ãªã‚‰ã€Google Play ã® API è¨­å®šã‚’è¦‹ç›´ã™**
  - [Google Play Developer API](https://developers.google.com/android-publisher) ã‚’åˆ©ç”¨ã™ã‚Œã°ã€CI/CD ã§å®Œå…¨è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹ãŒå¯èƒ½ã€‚

- **æ‰‹å‹•ã§ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹å ´åˆã€Google Play Console ã§ã€Œãƒªãƒªãƒ¼ã‚¹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™**

---

### **ã¾ã¨ã‚**
ğŸš€ **ã“ã®CIã§ã¯ã‚¢ãƒ—ãƒªã®ãƒ“ãƒ«ãƒ‰ã¨ã‚¹ãƒˆã‚¢ã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¾ã§è‡ªå‹•åŒ–ã•ã‚Œã¦ã„ã‚‹ãŒã€å®Ÿéš›ã®å…¬é–‹ï¼ˆãƒªãƒªãƒ¼ã‚¹ï¼‰ã¯Google Play Consoleã®è¨­å®šæ¬¡ç¬¬ã€‚**  
æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨ã—ã¦ã€Google Play Console ã§ **ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª** ã—ã€å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹ã‹ã€è‡ªå‹•ãƒªãƒªãƒ¼ã‚¹ã®è¨­å®šã‚’è¦‹ç›´ã™ã¨ã‚ˆã„ã§ã—ã‚‡ã†ã€‚

---
