# Mermaidファイルの加工

日付: 2024-03-22

---

## 👤 ユーザー
*2024/3/22 15:24:02*

"$mermaid_output_path/my_targets.mmd" の結果からファイルの1行目を削除するのと最後の2行分を削除してほしい。

#!/bin/bash

tools_package="./DISampleAppPackage"
mermaid_output_path="./assets/mermaid"
image_output_path="./assets/images"

swift package --package-path $tools_package plugin depermaid --direction TD &gt; "$mermaid_output_path/my_targets.mmd"
npx @mermaid-js/mermaid-cli -i "$mermaid_output_path/my_targets.mmd" -o "$image_output_path/my_targets.svg"

swift package --package-path $tools_package plugin depermaid --direction TD --test &gt; "$mermaid_output_path/test_targets.mmd"
swift package --package-path $tools_package plugin depermaid --direction TD --product &gt; "$mermaid_output_path/library_targets.mmd"
swift package --package-path $tools_package plugin depermaid --direction TD --test --product &gt; "$mermaid_output_path/all_targets.mmd"

---

## 🤖 アシスタント
*2024/3/22 15:24:47*

ファイルの最初の行を削除し、最後から2行を削除するためには、`sed` コマンド（または他のテキスト処理ツール）を使うと便利です。以下に示す Bash スクリプトは、指定したファイルから最初の1行を削除し、最後の2行を削除する方法を示しています。`sed` コマンドはストリームエディタで、テキストファイルを非常に柔軟に処理できます。

このスクリプトをあなたの既存のコードに組み込むと、`$mermaid_output_path/my_targets.mmd` ファイルを加工して、最初の1行と最後の2行を削除します。

```bash
#!/bin/bash

tools_package="./DISampleAppPackage"
mermaid_output_path="./assets/mermaid"
image_output_path="./assets/images"

swift package --package-path $tools_package plugin depermaid --direction TD > "$mermaid_output_path/my_targets.mmd"

# 最初の1行を削除し、最後の2行を削除
sed -i '1d' "$mermaid_output_path/my_targets.mmd" # 最初の1行を削除
sed -i ':a;N;$!ba;s/\n[^\n]*\n[^\n]*$//' "$mermaid_output_path/my_targets.mmd" # 最後の2行を削除

npx @mermaid-js/mermaid-cli -i "$mermaid_output_path/my_targets.mmd" -o "$image_output_path/my_targets.svg"

swift package --package-path $tools_package plugin depermaid --direction TD --test > "$mermaid_output_path/test_targets.mmd"
swift package --package-path $tools_package plugin depermaid --direction TD --product > "$mermaid_output_path/library_targets.mmd"
swift package --package-path $tools_package plugin depermaid --direction TD --test --product > "$mermaid_output_path/all_targets.mmd"
```

このコードの `sed -i '1d'` 部分が最初の1行を削除し、`sed -i ':a;N;$!ba;s/\n[^\n]*\n[^\n]*$//'` 部分が最後の2行を削除します。`-i` オプションはファイルを直接編集することを意味します。このスクリプトを実行する前に、バックアップを取っておくことをお勧めします。

---

## 👤 ユーザー
*2024/3/22 15:25:25*

最後の1行を削除する処理を2回書いた方がわかりやすいかな？

---

## 🤖 アシスタント
*2024/3/22 15:25:54*

はい、その通りです。最後の1行を削除する処理を2回実行する方が、理解しやすくシンプルな場合があります。この方法では、`sed` コマンドを使って最後の行を2回削除することになります。以下のように修正してみましょう。

```bash
#!/bin/bash

tools_package="./DISampleAppPackage"
mermaid_output_path="./assets/mermaid"
image_output_path="./assets/images"

swift package --package-path $tools_package plugin depermaid --direction TD > "$mermaid_output_path/my_targets.mmd"

# 最初の1行を削除
sed -i '1d' "$mermaid_output_path/my_targets.mmd"
# 最後の1行を2回削除
sed -i '$d' "$mermaid_output_path/my_targets.mmd"
sed -i '$d' "$mermaid_output_path/my_targets.mmd"

npx @mermaid-js/mermaid-cli -i "$mermaid_output_path/my_targets.mmd" -o "$image_output_path/my_targets.svg"

swift package --package-path $tools_package plugin depermaid --direction TD --test > "$mermaid_output_path/test_targets.mmd"
swift package --package-path $tools_package plugin depermaid --direction TD --product > "$mermaid_output_path/library_targets.mmd"
swift package --package-path $tools_package plugin depermaid --direction TD --test --product > "$mermaid_output_path/all_targets.mmd"
```

このスクリプトの`sed -i '1d'` は最初の行を削除し、`sed -i '$d'` はファイルの最後の行を削除します。最後の行の削除を2回実行することで、望みの結果を得られます。こちらの方法は、各ステップが明確で、何が行われているかを理解しやすいため、特にコードの読み手が `sed` コマンドに不慣れな場合に適しています。

---

## 👤 ユーザー
*2024/3/22 15:27:03*

このようなエラーになった

sed: 1: "./assets/mermaid/my_tar ...": invalid command code .

---

## 🤖 アシスタント
*2024/3/22 15:27:45*

このエラーメッセージは、`sed` コマンドを macOS などの BSD ベースのシステムで使用している場合によく見られます。BSD ベースの `sed` では、`-i` オプション（インプレース編集）を使用するときに、バックアップ拡張子を指定しなければならない場合があります。しかし、バックアップファイルを作成したくない場合は、`-i` の直後に空文字（''）を指定することでこれを回避できます。

以下のようにスクリプトを修正してみてください。`-i` オプションの使用方法を変更し、空文字を付け加えています。これは macOS またはその他の BSD ベースのシステムでのエラーを回避するためのものです。

```bash
#!/bin/bash

tools_package="./DISampleAppPackage"
mermaid_output_path="./assets/mermaid"
image_output_path="./assets/images"

swift package --package-path $tools_package plugin depermaid --direction TD > "$mermaid_output_path/my_targets.mmd"

# 最初の1行を削除（macOS/BSD対応）
sed -i '' '1d' "$mermaid_output_path/my_targets.mmd"
# 最後の1行を2回削除（macOS/BSD対応）
sed -i '' '$d' "$mermaid_output_path/my_targets.mmd"
sed -i '' '$d' "$mermaid_output_path/my_targets.mmd"

npx @mermaid-js/mermaid-cli -i "$mermaid_output_path/my_targets.mmd" -o "$image_output_path/my_targets.svg"

swift package --package-path $tools_package plugin depermaid --direction TD --test > "$mermaid_output_path/test_targets.mmd"
swift package --package-path $tools_package plugin depermaid --direction TD --product > "$mermaid_output_path/library_targets.mmd"
swift package --package-path $tools_package plugin depermaid --direction TD --test --product > "$mermaid_output_path/all_targets.mmd"
```

`sed -i ''` コマンドは、ファイルを直接編集しつつ、バックアップファイルを生成しないようにします。これにより、macOS や BSD ベースのシステムでも `sed` コマンドを問題なく使用できるようになります。

---

## 👤 ユーザー
*2024/3/22 15:30:30*

swift package --package-path $tools_package plugin depermaid --direction TD &gt; "$mermaid_output_path/my_targets.mmd"

sed -i '' '1d' "$mermaid_output_path/my_targets.mmd"
sed -i '' '$d' "$mermaid_output_path/my_targets.mmd"
sed -i '' '$d' "$mermaid_output_path/my_targets.mmd"

npx @mermaid-js/mermaid-cli -i "$mermaid_output_path/my_targets.mmd" -o "$image_output_path/my_targets.svg"

この一連の処理を以下でも実行したい。関数化して処理を共通化したい。

swift package --package-path $tools_package plugin depermaid --direction TD --test &gt; "$mermaid_output_path/test_targets.mmd"
swift package --package-path $tools_package plugin depermaid --direction TD --product &gt; "$mermaid_output_path/library_targets.mmd"
swift package --package-path $tools_package plugin depermaid --direction TD --test --product &gt; "$mermaid_output_path/all_targets.mmd"

---

## 🤖 アシスタント
*2024/3/22 15:31:10*

指定された一連の処理を関数化して、異なるパラメータで複数回実行できるようにすることは、コードの再利用性と可読性を向上させる良い方法です。以下に示す Bash スクリプトの例は、必要な処理を行う関数を定義し、その関数を異なるパラメータで複数回呼び出す方法を示しています。

```bash
#!/bin/bash

tools_package="./DISampleAppPackage"
mermaid_output_path="./assets/mermaid"
image_output_path="./assets/images"

# 処理を行う関数を定義
generate_diagram() {
    local input_options=$1
    local output_file="$mermaid_output_path/$2.mmd"

    # Swift Package Plugin を使って mermaid ファイルを生成
    swift package --package-path $tools_package plugin depermaid $input_options > "$output_file"

    # 最初の1行と最後の2行を削除
    sed -i '' '1d' "$output_file"
    sed -i '' '$d' "$output_file"
    sed -i '' '$d' "$output_file"

    # Mermaid CLI を使って SVG 画像を生成
    npx @mermaid-js/mermaid-cli -i "$output_file" -o "$image_output_path/$2.svg"
}

# 各種設定で関数を呼び出し
generate_diagram "--direction TD" "my_targets"
generate_diagram "--direction TD --test" "test_targets"
generate_diagram "--direction TD --product" "library_targets"
generate_diagram "--direction TD --test --product" "all_targets"
```

このスクリプトでは、`generate_diagram` 関数を定義しています。この関数は2つの引数を受け取ります：

1. `input_options`：`swift package` コマンドに渡すオプション（例えば、`--direction TD --test`）。
2. `output_file`：生成される `.mmd` ファイルの名前（拡張子なし）。

関数内では、最初に Swift Package Plugin を使用して Mermaid ファイルを生成し、次に `sed` コマンドを使用してファイルの最初の行と最後の2行を削除し、最後に Mermaid CLI を使用して SVG 画像を生成しています。これにより、異なるオプションを使って同じ処理を簡単に再実行できるようになります。

---

## 👤 ユーザー
*2024/3/22 15:31:20*

generate_diagram de

---
