# コード駆動OpenAPI生成

Date: 2025-05-30

---

## 👤 User
*2025-05-30 23:57:18*

hono と zod を使ってスキーマ駆動開発ではなくて、コード駆動駆動開発で、openapi.yamlとそれからクライアントコードを生成したい。

---

## 🤖 Assistant
*2025-05-30 23:57:19*

以下では **「Hono + Zod でコードを書くだけ → OpenAPI (YAML) を自動生成 → そこから TypeScript クライアントを生成」** という“コード駆動”の最小パイプラインを示します。ポイントは **@hono/zod-openapi** で API 定義と Zod スキーマを 1 か所にまとめ、その結果を **openapi-ts**（あるいは openapi-generator-cli など）に渡すだけ、というシンプルさです。  

---

## 1. 依存関係を追加

```bash
# サーバ側
pnpm add hono @hono/node-server zod @hono/zod-openapi
# ドキュメント出力補助
pnpm add -D yaml           # JSON→YAML 変換用 CLI
# クライアント生成
pnpm add -D @hey-api/openapi-ts         # 型だけならこれ
# フェッチラッパや SDK が欲しければ ↓ に置き換え可
# pnpm add -D @openapitools/openapi-generator-cli
```

---

## 2. サーバ実装（`packages/server/src/app.ts`）

```ts
// コメントは日本語で統一
import { z } from 'zod'
import { OpenAPIHono, createRoute } from '@hono/zod-openapi'

const app = new OpenAPIHono({
  // ここで共通メタデータを定義
  openapi: '3.1.0',
  info: { title: 'Todo API', version: '1.0.0' },
  servers: [{ url: 'http://localhost:8787' }],
})

// ------- Zod スキーマ ---------
const Todo = z.object({
  id: z.string().uuid(),
  title: z.string(),
})

// ------- ルート定義（コード = スキーマ = ドキュメント）---------
app.openapi(
  createRoute({
    method: 'post',
    path: '/todos',
    request: {
      body: {
        content: {
          'application/json': {
            schema: Todo.omit({ id: true }), // 新規作成なので id は不要
          },
        },
      },
    },
    responses: {
      201: {
        description: '作成成功',
        content: {
          'application/json': {
            schema: Todo,
          },
        },
      },
    },
  }),
  async (c) => {
    const input = c.req.valid('json') as z.infer<typeof Todo.omit({ id: true })>
    const created: z.infer<typeof Todo> = { id: crypto.randomUUID(), ...input }
    return c.json(created, 201)
  },
)

// ------- OpenAPI 出力エンドポイント ---------
app.doc('/openapi.json') // GET /openapi.json で取得可能

export default app
```

&gt; **ポイント**  
&gt; * `createRoute` に渡す **request / responses** の各 schema はそのまま Zod。  
&gt; * `app.openapi( routeSpec, handler )` が ①バリデーション ②型安全 ③ドキュメント生成 を同時に行います。  

---

## 3. ビルド＆ OpenAPI ファイルを書き出し

```jsonc
// packages/server/package.json （抜粋）
{
  "scripts": {
    "dev": "tsx watch src/app.ts",
    "build": "tsx src/app.ts > ../openapi.json",
    "build:yaml": "pnpm run build && yaml -i ../openapi.json ../openapi.yaml"
  }
}
```

* `tsx` で実行し、標準出力に `/openapi.json` を流すだけでも良いですし、  
  **実行後に `curl http://localhost:8787/openapi.json` でも可**。  
* `yaml -i` は JSON→YAML 変換（CLI 版 *yaml* パッケージ）。  

---

## 4. クライアント型／SDK を生成

### 4-1. 型だけ必要（最速パス）

```bash
npx openapi-ts ./openapi.yaml --output packages/client/src/api-types.ts
```

```ts
// 例: React クライアント側
import { paths } from '@/api-types'

type Todo = paths['/todos']['post']['responses']['201']['content']['application/json']
```

### 4-2. フェッチ込み SDK が欲しい場合

```bash
# 公式 Generator（typescript-fetch）
npx openapi-generator-cli generate -i openapi.yaml \
  -g typescript-fetch -o packages/client
```

生成物は `BaseAPI`, `TodosApi` などとして出力され、`fetch` 実装が同梱されます。  
Vite + React ならそのまま呼び出し可能です。

---

## 5. ディレクトリ例（Monorepo）

```
project-root/
├── packages/
│   ├── server/       # Hono + Zod (コード駆動)
│   ├── client/       # React, Vite
│   └── shared/       # 共通ユーティリティ
├── openapi.json      # build 時に生成
└── openapi.yaml      # 〃（クライアント生成に使用）
```

---

## 6. よくある質問

| Q | A |
|---|---|
| **Swagger UI を確認したい** | `@hono/swagger-ui` を追加し `app.get('/docs', swaggerUI({ url: '/openapi.json' }))` |
| **スキーマを複数ファイルに分割したい** | Zod スキーマを通常の TS モジュールとして分割し、`z.union`, `z.lazy` 等で組み合わせるだけ |
| **OpenAPI 以外のフォーマットにしたい** | `createRoute` の `responses` などはあくまで Zod なので、GraphQL 等に流用する場合は別途 resolver を用意 |

---

### まとめ

1. **Hono + Zod** でルートとスキーマを同時に記述  
2. **@hono/zod-openapi** が OpenAPI 3.1 ドキュメントを自動生成  
3. 生成された YAML / JSON を **openapi-ts** などに渡して **型／SDK** を生成  

これで「コードを書くだけでスキーマ & クライアントが揃う」コード駆動開発フローが完成します。

---
