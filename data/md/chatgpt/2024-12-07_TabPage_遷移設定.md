# TabPage 遷移設定

日付: 2024-12-07

---

## 👤 ユーザー
*2024/12/8 0:25:22*

このとき、notification\_listやaccountはTabPage(navigationShell: navigationShell)のAppヘッダーからpushで遷移する。それをうまく表現したい

    GoRoute(
      path: '/notification\_list',
      builder: (context, state) =&gt; const NotificationListPage(),
    ),
    GoRoute(
      path: '/account',
      builder: (context, state) =&gt; const AccountPage(),
    ),


// Package imports:
import 'package:go\_router/go\_router.dart';

// Project imports:
import 'package:flutter\_sample\_app/pages/account\_page.dart';
import 'package:flutter\_sample\_app/pages/notification\_list\_page.dart';
import 'pages/guild\_page.dart';
import 'pages/login\_page.dart';
import 'pages/map\_page.dart';
import 'pages/tab\_page.dart';

final GoRouter router = GoRouter(
  initialLocation: '/login',
  routes: \[
    GoRoute(
      path: '/login',
      builder: (context, state) =&gt; const LoginPage(),
    ),
    GoRoute(
      path: '/notification\_list',
      builder: (context, state) =&gt; const NotificationListPage(),
    ),
    GoRoute(
      path: '/account',
      builder: (context, state) =&gt; const AccountPage(),
    ),
    StatefulShellRoute.indexedStack(
      builder: (context, state, navigationShell) =&gt; TabPage(navigationShell: navigationShell),
      branches: \[
        StatefulShellBranch(
          routes: \[
            GoRoute(
              path: '/map',
              builder: (context, state) =&gt; const MapPage(),
            ),
          \],
        ),
        StatefulShellBranch(
          routes: \[
            GoRoute(
              path: '/guild',
              builder: (context, state) =&gt; const GuildPage(),
            ),
          \],
        ),
      \],
    ),
  \],
);

---

## 🤖 アシスタント
*2024/12/8 0:25:49*

TabPage の `navigationShell` を利用して、 `notification_list` や `account` を `TabPage` の一部のように扱い、`AppBar`（ヘッダー）からプッシュで遷移する表現を作るには、以下のポイントを押さえるべきです。

1. **`TabPage` から遷移することを明示**:
   `notification_list` や `account` が `TabPage` 内からプッシュされるのを表現するため、`GoRouter` の構造を再編成します。`TabPage` 内にこれらのルートを含めるのが自然です。

2. **`Navigator.push` の利用**:
   タブ切り替えの外部でルートを管理する場合でも、アプリの構造を一貫性のあるものに保つ必要があります。

以下に、調整された `GoRouter` のコード例を示します：

```dart
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:flutter_sample_app/pages/account_page.dart';
import 'package:flutter_sample_app/pages/notification_list_page.dart';
import 'package:flutter_sample_app/pages/guild_page.dart';
import 'package:flutter_sample_app/pages/login_page.dart';
import 'package:flutter_sample_app/pages/map_page.dart';
import 'package:flutter_sample_app/pages/tab_page.dart';

final GoRouter router = GoRouter(
  initialLocation: '/login',
  routes: [
    GoRoute(
      path: '/login',
      builder: (context, state) => const LoginPage(),
    ),
    StatefulShellRoute.indexedStack(
      builder: (context, state, navigationShell) => TabPage(navigationShell: navigationShell),
      branches: [
        // Map Tab
        StatefulShellBranch(
          routes: [
            GoRoute(
              path: '/map',
              builder: (context, state) => const MapPage(),
            ),
            GoRoute(
              path: '/map/notification_list',
              builder: (context, state) => const NotificationListPage(),
            ),
            GoRoute(
              path: '/map/account',
              builder: (context, state) => const AccountPage(),
            ),
          ],
        ),
        // Guild Tab
        StatefulShellBranch(
          routes: [
            GoRoute(
              path: '/guild',
              builder: (context, state) => const GuildPage(),
            ),
            GoRoute(
              path: '/guild/notification_list',
              builder: (context, state) => const NotificationListPage(),
            ),
            GoRoute(
              path: '/guild/account',
              builder: (context, state) => const AccountPage(),
            ),
          ],
        ),
      ],
    ),
  ],
);
```

### 調整のポイント

1. **`notification_list` と `account` をそれぞれのタブのルートにネスト**:
   - `notification_list` と `account` は `map` タブや `guild` タブ内のページとして扱われるため、それぞれの `StatefulShellBranch` 内に配置します。

2. **プッシュ遷移の処理**:
   - `TabPage` 内のボタンから `GoRouter.push` を呼び出すことで、これらのルートに遷移します。

例: `TabPage` 内で `AppBar` のアクションとしてプッシュを実装するコード:

```dart
AppBar(
  title: Text('Tab Page'),
  actions: [
    IconButton(
      icon: Icon(Icons.notifications),
      onPressed: () => context.push('/map/notification_list'),
    ),
    IconButton(
      icon: Icon(Icons.account_circle),
      onPressed: () => context.push('/map/account'),
    ),
  ],
),
```

3. **同一タブ内の戻りナビゲーションをサポート**:
   - `GoRouter` が現在のタブ内での戻り操作を適切に処理するようになります。

これにより、`notification_list` や `account` が `TabPage` の一部として自然に機能します。

---

## 👤 ユーザー
*2024/12/8 0:26:33*

でもguildを選択している状態でpopで戻った時にmapに戻ってしまうのではないか＞

---

## 🤖 アシスタント
*2024/12/8 0:26:57*

その懸念を解消するには、`StatefulShellRoute` の現在のタブ状態を保持し、適切に処理する必要があります。`StatefulShellRoute` 自体が現在のタブの状態を保持しているので、各タブごとに独立してページ遷移を処理できるよう、遷移ロジックを工夫します。

以下に修正版の解決策を示します：

### ポイント
1. **各タブ内でのルート階層を分離**:
   - `notification_list` や `account` を各タブ専用のルートとして扱います。
   - `StatefulShellRoute` は現在のタブ状態を保持しており、ポップ操作で正しいタブに戻れます。

2. **共通ルートの防止**:
   - `notification_list` や `account` を `StatefulShellRoute` の外部で定義しないことで、現在のタブに従った戻り操作が可能になります。

3. **タブ状態に依存した遷移**:
   - `context.push` を用いる際、現在のタブに応じたパスを生成します。

以下は修正後のコード例です：

```dart
final GoRouter router = GoRouter(
  initialLocation: '/login',
  routes: [
    GoRoute(
      path: '/login',
      builder: (context, state) => const LoginPage(),
    ),
    StatefulShellRoute.indexedStack(
      builder: (context, state, navigationShell) => TabPage(navigationShell: navigationShell),
      branches: [
        // Map Tab
        StatefulShellBranch(
          routes: [
            GoRoute(
              path: '/map',
              builder: (context, state) => const MapPage(),
              routes: [
                GoRoute(
                  path: 'notification_list',
                  builder: (context, state) => const NotificationListPage(),
                ),
                GoRoute(
                  path: 'account',
                  builder: (context, state) => const AccountPage(),
                ),
              ],
            ),
          ],
        ),
        // Guild Tab
        StatefulShellBranch(
          routes: [
            GoRoute(
              path: '/guild',
              builder: (context, state) => const GuildPage(),
              routes: [
                GoRoute(
                  path: 'notification_list',
                  builder: (context, state) => const NotificationListPage(),
                ),
                GoRoute(
                  path: 'account',
                  builder: (context, state) => const AccountPage(),
                ),
              ],
            ),
          ],
        ),
      ],
    ),
  ],
);
```

### 修正の要点

#### 1. **ルートのネスト**
- `notification_list` や `account` を各タブのネストルートとして定義。
- `context.push('/map/notification_list')` または `context.push('/guild/notification_list')` とすることで、現在のタブに依存した遷移が可能になります。

#### 2. **`AppBar` での遷移処理**
- `TabPage` の `AppBar` 内で、現在のタブに応じたルート遷移を設定します。

例：

```dart
AppBar(
  title: Text('Tab Page'),
  actions: [
    IconButton(
      icon: Icon(Icons.notifications),
      onPressed: () {
        final currentPath = GoRouter.of(context).location;
        if (currentPath.startsWith('/map')) {
          context.push('/map/notification_list');
        } else if (currentPath.startsWith('/guild')) {
          context.push('/guild/notification_list');
        }
      },
    ),
    IconButton(
      icon: Icon(Icons.account_circle),
      onPressed: () {
        final currentPath = GoRouter.of(context).location;
        if (currentPath.startsWith('/map')) {
          context.push('/map/account');
        } else if (currentPath.startsWith('/guild')) {
          context.push('/guild/account');
        }
      },
    ),
  ],
),
```

### 結果
1. **タブ状態を維持**:
   - 現在のタブから遷移しても、`pop` で正しく戻ります。

2. **ルート階層の一貫性**:
   - 各タブ内でのみ適切な遷移が行われます。

3. **UI の直感的な挙動**:
   - ユーザーが期待するタブ内操作が実現されます。

---

## 👤 ユーザー
*2024/12/8 0:27:05*

そこまでする価値はあるのか？

---

## 🤖 アシスタント
*2024/12/8 0:27:32*

良い視点です。実際、コードを複雑化する前に「そこまでする価値があるか」を検討するのは非常に重要です。このケースでは、次の観点から判断できます：

---

### **検討すべきポイント**

#### 1. **ユーザー体験**
- **価値がある場合**:
  - ユーザーが「特定のタブの状態に依存している」機能を期待している場合、例えば通知リストやアカウント画面がタブごとに異なるコンテキストを持つ場合。
  - タブ内での「戻る」操作が自然で一貫性があることが重要視される場合。

- **価値が薄い場合**:
  - 通知リストやアカウント画面がどのタブからでも同じコンテンツを提供する場合。
  - タブ間の独立性が薄く、グローバルな遷移が許容される場合。

---

#### 2. **開発・保守性**
- **価値がある場合**:
  - アプリの仕様がタブごとに異なるロジックやデータを要求する場合。
  - 将来的にタブごとの画面やルートが増える可能性がある場合。

- **価値が薄い場合**:
  - 今後の変更予定がなく、シンプルな実装で十分満足できる場合。
  - 開発期間やコストを削減したい場合。

---

#### 3. **リソース（時間・コスト）**
- **価値がある場合**:
  - 開発チームに十分なリソースがあり、より洗練されたユーザー体験を目指すために時間をかける余裕がある場合。

- **価値が薄い場合**:
  - リソースに制約があり、シンプルさを優先する方が合理的な場合。

---

### **簡素化の代替案**
もし「そこまでする価値が薄い」と判断した場合、次のような簡素化案が考えられます：

#### 1. **グローバル遷移として実装**
```dart
final GoRouter router = GoRouter(
  initialLocation: '/login',
  routes: [
    GoRoute(
      path: '/login',
      builder: (context, state) => const LoginPage(),
    ),
    GoRoute(
      path: '/notification_list',
      builder: (context, state) => const NotificationListPage(),
    ),
    GoRoute(
      path: '/account',
      builder: (context, state) => const AccountPage(),
    ),
    StatefulShellRoute.indexedStack(
      builder: (context, state, navigationShell) => TabPage(navigationShell: navigationShell),
      branches: [
        StatefulShellBranch(
          routes: [
            GoRoute(
              path: '/map',
              builder: (context, state) => const MapPage(),
            ),
          ],
        ),
        StatefulShellBranch(
          routes: [
            GoRoute(
              path: '/guild',
              builder: (context, state) => const GuildPage(),
            ),
          ],
        ),
      ],
    ),
  ],
);
```

- **戻り操作**: タブ間の遷移と無関係に、`/notification_list` や `/account` にグローバル遷移。
- **メリット**: 実装が簡単で、シンプルに動作。
- **デメリット**: ユーザーがタブ内での文脈を感じられない。

#### 2. **シンプルなコンテキスト保持**
タブごとの「意味」を強調する必要がある場合でも、明示的なロジックを減らし、`context.push('/notification_list')` のみで済ませる。

---

### **結論**
- **価値がある場合**:
  - 画面間の文脈がタブごとに異なる場合。
  - ユーザー体験が大幅に向上する場合。

- **価値が薄い場合**:
  - コンテンツがタブに依存しない場合。
  - 開発・保守コストを抑える方が重要な場合。

シンプルなグローバル実装で十分であれば、無理に複雑化する必要はありません。価値が本当にあるかどうか、ユーザー目線やリソース状況から再考するのがベストです！

---

## 👤 ユーザー
*2024/12/8 0:28:04*

ちなみにmapタブからしか遷移できない画面、たとえばmapディティールなどに遷移する場合はどういう記述になるのか

---

## 🤖 アシスタント
*2024/12/8 0:28:24*

`map` タブからしか遷移できない画面（例: `MapDetailPage`）に遷移する場合、ルート構造に制約を加えて特定のタブのネストルートとして管理します。このようにすることで、`map` タブの一部として動作し、他のタブやグローバルなルートからはアクセスできないようにします。

---

### **ルート構造の記述**
以下は、`MapDetailPage` が `map` タブ内専用の画面となるようにした例です：

```dart
final GoRouter router = GoRouter(
  initialLocation: '/login',
  routes: [
    GoRoute(
      path: '/login',
      builder: (context, state) => const LoginPage(),
    ),
    StatefulShellRoute.indexedStack(
      builder: (context, state, navigationShell) => TabPage(navigationShell: navigationShell),
      branches: [
        // Map Tab
        StatefulShellBranch(
          routes: [
            GoRoute(
              path: '/map',
              builder: (context, state) => const MapPage(),
              routes: [
                GoRoute(
                  path: 'detail',
                  builder: (context, state) => const MapDetailPage(),
                ),
              ],
            ),
          ],
        ),
        // Guild Tab
        StatefulShellBranch(
          routes: [
            GoRoute(
              path: '/guild',
              builder: (context, state) => const GuildPage(),
            ),
          ],
        ),
      ],
    ),
  ],
);
```

---

### **ポイント解説**

1. **ネストされたルート**:
   - `MapDetailPage` は `map` タブのルート (`/map`) の下にネストされています。
   - URL パスとしては `/map/detail` の形になります。

2. **タブの制約**:
   - 他のタブ (`/guild`) から直接 `/map/detail` に遷移することはできません。
   - `StatefulShellRoute` の仕組みによって、`map` タブがアクティブでないときは `MapDetailPage` にアクセスできない設計になります。

---

### **遷移例**

`MapPage` から `MapDetailPage` に遷移するコード例:

```dart
class MapPage extends StatelessWidget {
  const MapPage({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Map'),
      ),
      body: Center(
        child: ElevatedButton(
          onPressed: () {
            context.push('/map/detail'); // ネストされたルートに遷移
          },
          child: const Text('Go to Map Detail'),
        ),
      ),
    );
  }
}
```

---

### **戻り操作**

- `MapDetailPage` から戻ると、`MapPage` に戻ります。
- `GoRouter` がルートスタックを管理しているため、特別な処理をしなくてもポップで戻る動作が自然に動きます。

---

### **他のタブとの分離**

他のタブ（例えば `guild`）が同じような詳細画面を持つ場合、それぞれのタブ専用のルートとして管理します。同様の構造を利用して「他のタブからアクセスできない」状態を維持できます。

---

### **まとめ**

この方法は次のような場合に有効です：
- 特定のタブ専用の画面を定義したい。
- ユーザーが他のタブから意図しない遷移を行うことを防ぎたい。

ルート構造の一貫性が保たれるため、アプリ全体の管理もしやすくなります！

---
