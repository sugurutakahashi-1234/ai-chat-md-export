# GitHubアクションのトークン

日付: 2024-05-20

---

## 👤 ユーザー
*2024/5/20 11:27:03*

このtokenを使ってなにか簡単な処理をさせてほしい。

name: Test

on:
  pull\_request:
    types:
      - opened
      - reopened
      - ready\_for\_review
      - closed
      - synchronize

jobs:
  job:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/create-github-app-token@v1
        id: generate\_token
        with:
          app-id: ${{ secrets.APP\_ID }}
          private-key: ${{ secrets.PRIVATE\_KEY }}
      - name: Use token
        env:
          TOKEN: ${{ steps.generate\_token.outputs.token }}
        run: |
          echo "The Generated Token is masked: ${TOKEN}"

---

## 🤖 アシスタント
*2024/5/20 11:27:16*

このGitHub Actionsワークフローは、Pull Request（PR）が開かれた、再開された、レビュー準備ができた、閉じられた、または同期されたときにトリガーされます。指定されたイベントが発生したときに、GitHubアプリのトークンを生成し、そのトークンを使用して何か処理を行うジョブが実行されます。

具体的には、次のステップが含まれます：

1. **GitHubアプリのトークンを生成**:
    - `actions/create-github-app-token@v1`アクションを使用して、GitHubアプリのトークンを生成します。
    - 生成されたトークンは`${{ steps.generate_token.outputs.token }}`として取得できます。

2. **トークンを使用した処理**:
    - 生成されたトークンを環境変数`TOKEN`に設定し、エコーして出力します。出力されるトークンはマスクされて表示されます。

以下は、説明とともに示されたワークフローのコードです：

```yaml
name: Test

on:
  pull_request:
    types:
      - opened
      - reopened
      - ready_for_review
      - closed
      - synchronize

jobs:
  job:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/create-github-app-token@v1
        id: generate_token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
      - name: Use token
        env:
          TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          echo "The Generated Token is masked: ${TOKEN}"
```

このワークフローは、PRの特定のイベントが発生したときに、GitHubアプリのトークンを生成し、そのトークンを使用して何かしらの処理を行うための基本的なテンプレートです。このテンプレートを基に、さらに具体的な処理を追加することができます。

---

## 👤 ユーザー
*2024/5/20 11:27:48*

なにかこのTOkenを使って参照してほしい

---

## 🤖 アシスタント
*2024/5/20 11:28:02*

このトークンを使用して、例えば、リポジトリの情報を取得するようなAPIリクエストを実行することができます。以下の例では、生成されたトークンを使用してリポジトリの詳細情報を取得するリクエストを行います。

### 変更後のワークフロー

以下のワークフローは、生成されたトークンを使用してGitHub APIを呼び出し、リポジトリの情報を取得します。

```yaml
name: Test

on:
  pull_request:
    types:
      - opened
      - reopened
      - ready_for_review
      - closed
      - synchronize

jobs:
  job:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/create-github-app-token@v1
        id: generate_token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
      - name: Use token to get repo info
        env:
          TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          curl -H "Authorization: Bearer ${TOKEN}" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/repos/${{ github.repository }} \
               -o repo_info.json

      - name: Display repository information
        run: |
          cat repo_info.json
```

### 説明

1. **トークンの生成**:
    - `actions/create-github-app-token@v1`アクションを使用して、GitHubアプリのトークンを生成します。
    - 生成されたトークンは`${{ steps.generate_token.outputs.token }}`として取得できます。

2. **リポジトリ情報の取得**:
    - `curl`コマンドを使用してGitHub APIにリクエストを送り、リポジトリの情報を取得します。
    - このリクエストは、生成されたトークンを使用して認証されます。
    - 取得した情報は`repo_info.json`ファイルに保存されます。

3. **リポジトリ情報の表示**:
    - `repo_info.json`ファイルの内容を表示します。

このワークフローを実行することで、指定したリポジトリの詳細情報を取得し、それを表示することができます。

---

## 👤 ユーザー
*2024/5/20 11:28:16*

curl ではなくてもっといい感じに使ってほしい

---

## 🤖 アシスタント
*2024/5/20 11:28:35*

了解しました。`curl`を使わずに、GitHubのCLIツールである`gh`を使用してリポジトリ情報を取得し、それを参照する方法を紹介します。`gh`はGitHub CLIツールであり、より簡単にGitHubのAPIと対話することができます。

### GitHub CLIを使用したワークフロー

以下のワークフローは、生成されたトークンを使用してGitHub CLIを設定し、リポジトリの情報を取得します。

```yaml
name: Test

on:
  pull_request:
    types:
      - opened
      - reopened
      - ready_for_review
      - closed
      - synchronize

jobs:
  job:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/create-github-app-token@v1
        id: generate_token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh
      - name: Authenticate with GitHub CLI
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          echo "${{ steps.generate_token.outputs.token }}" | gh auth login --with-token
      - name: Get repository information
        run: |
          gh repo view ${{ github.repository }} --json name,description,stargazerCount,forkCount,openIssuesCount --jq '.'
      - name: Save repository information to file
        run: |
          gh repo view ${{ github.repository }} --json name,description,stargazerCount,forkCount,openIssuesCount > repo_info.json
      - name: Display repository information
        run: |
          cat repo_info.json
```

### 説明

1. **トークンの生成**:
    - `actions/create-github-app-token@v1`アクションを使用して、GitHubアプリのトークンを生成します。

2. **GitHub CLIのインストール**:
    - `gh`をインストールします。これは、GitHub CLIを使用するために必要です。

3. **GitHub CLIで認証**:
    - 生成されたトークンを使用してGitHub CLIに認証します。

4. **リポジトリ情報の取得**:
    - `gh repo view`コマンドを使用して、指定されたリポジトリの情報をJSON形式で取得します。
    - `--json`オプションで取得するフィールドを指定し、`--jq`オプションでJSON出力を整形します。

5. **リポジトリ情報をファイルに保存**:
    - 取得したリポジトリ情報を`repo_info.json`ファイルに保存します。

6. **リポジトリ情報の表示**:
    - `repo_info.json`ファイルの内容を表示します。

このワークフローにより、より簡潔にGitHub APIと対話し、リポジトリの情報を取得して表示することができます。

---

## 👤 ユーザー
*2024/5/20 11:28:52*

gh はわざわざインストールしないといけないんだっけ？

---

## 🤖 アシスタント
*2024/5/20 11:29:03*

`gh`（GitHub CLI）はデフォルトでGitHub Actionsの環境にインストールされているため、わざわざインストールする必要はありません。そのため、`gh`を直接使用することができます。

以下のワークフローでは、`gh`を使用してリポジトリ情報を取得するように修正しています。

### 修正後のワークフロー

```yaml
name: Test

on:
  pull_request:
    types:
      - opened
      - reopened
      - ready_for_review
      - closed
      - synchronize

jobs:
  job:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/create-github-app-token@v1
        id: generate_token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
      - name: Authenticate with GitHub CLI
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          gh auth login --with-token <<< "${{ steps.generate_token.outputs.token }}"
      - name: Get repository information
        run: |
          gh repo view ${{ github.repository }} --json name,description,stargazerCount,forkCount,openIssuesCount > repo_info.json
      - name: Display repository information
        run: |
          cat repo_info.json
```

### 説明

1. **トークンの生成**:
    - `actions/create-github-app-token@v1`アクションを使用して、GitHubアプリのトークンを生成します。

2. **GitHub CLIで認証**:
    - 生成されたトークンを使用してGitHub CLIに認証します。
    - `gh auth login --with-token <<< "${{ steps.generate_token.outputs.token }}"`を使って認証を行います。

3. **リポジトリ情報の取得**:
    - `gh repo view`コマンドを使用して、指定されたリポジトリの情報をJSON形式で取得し、`repo_info.json`ファイルに保存します。

4. **リポジトリ情報の表示**:
    - `repo_info.json`ファイルの内容を表示します。

この修正後のワークフローにより、`gh`のインストールステップを省略し、より効率的にリポジトリ情報を取得して表示することができます。

---

## 👤 ユーザー
*2024/5/20 11:29:35*

gh auth login って必要なんだっけ？しなくてよいためのトークンなのでは？

---

## 🤖 アシスタント
*2024/5/20 11:29:49*

その通りです。GitHub Actionsで使用するトークンは、環境変数 `GITHUB_TOKEN` として直接設定すれば、`gh auth login` を使わずに `gh` コマンドを実行できます。以下は修正されたワークフローです：

### 修正後のワークフロー

```yaml
name: Test

on:
  pull_request:
    types:
      - opened
      - reopened
      - ready_for_review
      - closed
      - synchronize

jobs:
  job:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/create-github-app-token@v1
        id: generate_token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
      - name: Get repository information
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          gh api repos/${{ github.repository }} --jq '{name: .name, description: .description, stargazers_count: .stargazers_count, forks_count: .forks_count, open_issues_count: .open_issues_count}' > repo_info.json
      - name: Display repository information
        run: |
          cat repo_info.json
```

### 説明

1. **トークンの生成**:
    - `actions/create-github-app-token@v1`アクションを使用して、GitHubアプリのトークンを生成します。

2. **リポジトリ情報の取得**:
    - 環境変数 `GITHUB_TOKEN` に生成されたトークンを設定します。
    - `gh api` コマンドを使用してGitHub APIにリクエストを送り、指定されたリポジトリの情報を取得します。
    - `--jq` オプションを使って必要なフィールドのみを抽出し、JSON形式で `repo_info.json` ファイルに保存します。

3. **リポジトリ情報の表示**:
    - `repo_info.json` ファイルの内容を表示します。

この方法により、`gh auth login` ステップを省略し、直接 `gh api` コマンドを使用してリポジトリ情報を取得することができます。

---

## 👤 ユーザー
*2024/5/20 11:31:39*

cat より echo のほうがいいかな。あと特定のrepoにしかインストールさせてないから別の簡単な処理がいい

---

## 🤖 アシスタント
*2024/5/20 11:31:51*

User has installed a specific GitHub App on a particular repository and prefers simpler tasks for demonstrating GitHub Actions.

---

## 🔧 ツール
*2024/5/20 11:31:51*

Model set context updated.

---

## 🤖 アシスタント
*2024/5/20 11:31:51*

了解しました。簡単な処理として、生成されたトークンを使用して、指定のリポジトリに対して単純なコメントを作成する例を示します。

以下のワークフローでは、Pull Requestが開かれた、再開された、レビュー準備ができた、閉じられた、または同期されたときに、Pull Requestにコメントを追加します。

### 修正後のワークフロー

```yaml
name: Test

on:
  pull_request:
    types:
      - opened
      - reopened
      - ready_for_review
      - closed
      - synchronize

jobs:
  job:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/create-github-app-token@v1
        id: generate_token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
      - name: Post a comment on the pull request
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "This is a test comment."
```

### 説明

1. **トークンの生成**:
    - `actions/create-github-app-token@v1`アクションを使用して、GitHubアプリのトークンを生成します。

2. **Pull Requestにコメントを投稿**:
    - 環境変数 `GITHUB_TOKEN` に生成されたトークンを設定します。
    - `gh pr comment` コマンドを使用して、現在のPull Requestにコメントを追加します。
    - コメントの内容は `"This is a test comment."` です。

このワークフローにより、指定されたリポジトリに対してPull Requestが発生した際に、自動的にコメントを追加することができます。これにより、トークンの使用方法をシンプルに示すことができます。

---

## 👤 ユーザー
*2024/5/20 11:32:59*

以下のエラーになった

Run gh pr comment 139 --body "This is a test comment."
  gh pr comment 139 --body "This is a test comment."
  shell: /usr/bin/bash -e {0}
  env:
    GITHUB\_TOKEN: \*\*\*
failed to run git: fatal: not a git repository (or any of the parent directories): .git

---

## 🤖 アシスタント
*2024/5/20 11:33:13*

GitHub Actionsの環境では、`gh`コマンドはデフォルトでリポジトリをチェックアウトしていません。そのため、リポジトリをチェックアウトするステップを追加する必要があります。

以下に、リポジトリをチェックアウトするステップを追加した修正版のワークフローを示します。

### 修正後のワークフロー

```yaml
name: Test

on:
  pull_request:
    types:
      - opened
      - reopened
      - ready_for_review
      - closed
      - synchronize

jobs:
  job:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repository
        uses: actions/checkout@v3
      - uses: actions/create-github-app-token@v1
        id: generate_token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
      - name: Post a comment on the pull request
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "This is a test comment."
```

### 説明

1. **リポジトリのチェックアウト**:
    - `actions/checkout@v3`アクションを使用して、現在のリポジトリをチェックアウトします。

2. **トークンの生成**:
    - `actions/create-github-app-token@v1`アクションを使用して、GitHubアプリのトークンを生成します。

3. **Pull Requestにコメントを投稿**:
    - 環境変数 `GITHUB_TOKEN` に生成されたトークンを設定します。
    - `gh pr comment`コマンドを使用して、現在のPull Requestにコメントを追加します。

この修正版ワークフローでは、リポジトリをチェックアウトするステップを追加し、`gh pr comment` コマンドを正常に実行できるようにしています。

---
