# 未使用コード解析ツール

Date: 2025-06-11

---

## 👤 User
*2025-06-11 19:58:47*

TypeScriptで使われていない関数や変数やsdkの静的解析ツールの候補を教えて欲しい

---

## 🤖 Assistant
*2025-06-11 19:59:30*

### 使われていないコードを検出する主なツール一覧

| レイヤー | 代表的ツール | 特徴・検出範囲 | 備考 |
|---|---|---|---|
| **コンパイラ** | **TypeScript `--noUnusedLocals` / `--noUnusedParameters`** | 変数・パラメータ・未使用 private メンバーをビルド時にエラー化 | 設定するだけで CI に組み込みやすい citeturn3search2 |
| **Linter** | **ESLint + @typescript-eslint**&lt;br&gt;`no-unused-vars` など | ファイル単位で未使用変数/引数/式を検出 | VS Code のリアルタイム警告とも連動 citeturn0search0 |
| | **eslint-plugin-unused-imports** | 未使用 `import` を自動削除する autofix 付き | Biome に乗り換えを示唆するケースも増加 citeturn2search0turn2search1 |
| | **Oxlint** | Rust 製で ESLint より 3-10 倍高速。未使用コード検出を含む | 大規模モノレポのプリチェック用に◎ citeturn0search2 |
| | **Biome** (旧 Rome) | `biome check --apply` で未使用 import や変数を自動修正 | ESLint 互換ではないが設定が最小 citeturn0search3 |
| **エクスポート/ファイル解析** | **ts-prune** | `tsconfig.json` を解析して未使用 export を列挙 | 0 設定で実行可、CI で差分検出が楽 citeturn0search4 |
| | **ts-unused-exports** | 未使用 export と「まるごと未使用ファイル」を検出・カウント | `--findCompletelyUnusedFiles` が便利 citeturn4search0 |
| | **ts-remove-unused** | 未使用 export を削除し、空になったファイルを自動削除 | `--check` モードで安全に導入可 citeturn4search6 |
| | **Knip** | 未使用 **export / 依存 / ファイル** を一括検出。モノレポ向け | 依存解析も兼ねられるのが強み citeturn0search1turn1search4 |
| **依存（SDK）レベル** | **depcheck** | `package.json` にあるが呼ばれていない依存を検出 | 型定義 (`@types/*`) もあわせて解析可 citeturn1search0 |
| | **npm-check** | 対話式 CLI で未使用依存・更新待ち依存を一括管理 | `npm-check -u` で削除/更新を選択 citeturn1search6 |
| | **Knip** | 未使用依存の検出も同時にこなす（上記参照） | monorepo を一本で管理したい場合に◎ |

---

#### 組み合わせ例（参考フロー）

1. **日常開発**  
   * `tsc --noUnusedLocals --noUnusedParameters` でビルド失敗を防止  
   * ESLint（または Biome/Oxlint）を IDE & pre-commit で実行

2. **CI / PR チェック**  
   * `ts-prune` か `ts-unused-exports` で export レベルのデッドコードを検出  
   * `depcheck` または `knip --dependencies` で不要 SDK を洗い出し  
   * 変更があれば PR を Fail して削除を促す

3. **定期クリーンアップ（手動 or cron）**  
   * `knip --fix` や `ts-remove-unused --check` → レポート確認  
   * 問題ないファイルを自動削除 / バンドルサイズ計測

---

### 選定のヒント

| ケース | 推しツール |
|---|---|
| **とりあえずコンパイル時に止めたい** | TypeScript オプションのみ |
| **IDE で即ハイライトしたい / autofix も欲しい** | ESLint + eslint-plugin-unused-imports&lt;br&gt;または Biome |
| **ライブラリ開発で“公開 API 以外”の死んだ export を削除したい** | ts-prune / ts-unused-exports |
| **大規模モノレポで依存・ファイルも含めて掃除したい** | Knip |
| **node_modules のダイエットが急務** | depcheck → npm-check で削除 |

&gt; **補足:** barrel ファイル (`index.ts` で再エクスポート) や動的 import を多用している場合は、どのツールも誤検知が起こりやすいです。まず **レポートを人間が確認** → `ignore` 設定を追加 → CI で強制、の順で導入すると安全です。

---

## 👤 User
*2025-06-11 20:04:49*

モノレポ構成なんだ。
やりたいことは使われていないexportなどを検知したい。
また、sdkも不要なファイルがあれば削除していきたい。
Biomeは基本設定で入っているのでimportは削除できているはず、
TypeScritpの設定はすでに入っていた。

---

## 🤖 Assistant
*2025-06-11 20:05:10*

#### モノレポで “未使用 export／未参照 SDK ファイル” を洗い出す鉄板セット

| 項目 | 最適ツール | 使い分けのポイント |
|------|-----------|-------------------|
| **未使用 export／未使用ファイル（パッケージ横断）** | **Knip** | - workspaces（pnpm / npm / Yarn）を自動認識し、**パッケージ間 import も解析**&lt;br&gt;- `knip src --workspaces --fix` で &lt;br&gt; ①未使用 export → `export` キーワードだけ外す&lt;br&gt; ②誰からも import されないファイル → 削除提案&lt;br&gt;- 依存ライブラリも同時にチェックできるので「使われていない SDK」整理にも◎ citeturn0search0turn0search3 |
| **export 単体の静的レポート（差分 CI 向け）** | **ts-unused-exports** または **ts-prune** | - **小規模〜単一パッケージ**なら起動が速い&lt;br&gt;- false-positive が出やすい alias／参照構成では `--ignorePattern` や `paths` 設定でチューニング必須 citeturn0search4turn0search5 |
| **“消すところまで自動” 派** | **ts-remove-unused (tsr)** | - Knip の `--fix` は *export キーワード* を外すだけ → “コードごと削除したい” 場合は tsr/ts-remove-unused の方が踏み込んで消してくれるciteturn1search1turn1search8 |
| **未使用依存（package.json）** | depcheck / Knip | - 既に Knip を入れるなら `knip --dependencies` で完結 citeturn1search0turn0search8 |

&gt; **既にあるもの**  
&gt; * **Biome** → import の死活整理は OK  
&gt; * **TypeScript `--noUnusedLocals / --noUnusedParameters`** → ファイル内のローカル死活は OK  
&gt; → つまり残タスクは **「パッケージをまたぐ export とファイル」** です。

---

### 🛠️ すぐ動く最小構成（pnpm モノレポ例）

```bash
pnpm add -Dw knip
```

`knip.json`（リポジトリルート）

```jsonc
{
  // workspace 検知は自動だが、root 設定で誤検知を防止
  "$schema": "https://knip.dev/knip.schema.json",
  "workspaces": [
    "packages/*"
  ],
  // 生成 SDK フォルダなど “対象外にしたい” もの
  "ignore": [
    "packages/**/src/generated/**"
  ],
  // モノレポで alias を多用している場合
  "paths": {
    "@myapp/*": ["packages/*/src"]
  }
}
```

**CI 用スクリプト**

```json
{
  "scripts": {
    "lint:deadcode": "knip --report --dependencies",
    "lint:deadcode:fix": "knip --fix"
  }
}
```

* `knip --report` … exit ≠ 0 で PR をブロック  
* `knip --fix` … ローカル実行で不要 export → `export` 剥がし／不要ファイル削除

---

### 自動削除までやりたい場合

1. **安全モードで一覧取得**

   ```bash
   pnpm ts-remove-unused --check --project packages/sdk/tsconfig.json
   ```

2. **差分を確認してから一括適用**

   ```bash
   pnpm ts-remove-unused --project packages/sdk/tsconfig.json
   pnpm biome check --apply   # import も再整理
   ```

---

### 導入時の落とし穴 & 回避策

| ケース | 症状 / 影響 | 対策 |
|--------|-------------|------|
| **パス alias (`paths` / babel-module-resolver)** | Knip / ts-prune が “使われていない” と誤判定 | `knip.json > paths` で alias→実パスを登録／tsconfig の `baseUrl` を合わせる citeturn0search6 |
| **`export * from` バレル** | *再エクスポート* だけ残って実装を誤検知 | ① Knip: `knip --includeExports` を併用&lt;br&gt;② ts-prune: `--exclude` でまとめて無視 |
| **コード生成フォルダ (openapi-sdk 等) が巨大** | 解析が遅い／誤検知 | `ignore` で除外し、生成元の YAML 変更時だけ別 CI で dead-code チェック |
| **ジョブ時間** | Knip は全ワークスペース解析 → 数千ファイルで 30-60 s 程度 | PR ごとなら OK。更に高速化したい場合は&lt;br&gt; `--changes` で差分限定解析 (Git 変更分のみ) |

---

### まとめ

* **import 整理** → Biome で既に対応  
* **ローカル未使用変数** → TypeScript コンパイラで対応  
* **パッケージ横断の未使用 export / ファイル / 依存** → **Knip** 一択（monorepo ネイティブ & 依存も同時チェック）  
* **「本当にコードも削除したい」** → `ts-remove-unused` or `tsr` を spot で併用  

これで **“不要な SDK ファイルまで含めたデッドコード狩り”** が CI で自動化できます。まずは `knip --report --workspaces` を回してレポートを眺め、誤検知を ignore に入れてから PR ブロックを有効化する手順が安全です。

---

## 👤 User
*2025-06-12 11:34:13*

ignoreExportsUsedInFileやincludeEntryExportsの設定はモノレポでどうするべきか教えてほしい。

---

## 🤖 Assistant
*2025-06-12 11:34:43*

### まず押さえておきたいポイント

| オプション | 作用範囲 | 主な役割 | モノレポでの扱い |
|------------|----------|----------|------------------|
| `ignoreExportsUsedInFile` | **ルート設定のみ**（各 workspace からは上書き不可） | **同一ファイル内だけで参照される export** を未使用扱いから除外する | 「**実装関数+テスト用関数を同居させる**」構成が多いアプリ系モジュールでは **true** が便利&lt;br&gt;ライブラリ系パッケージで **false** にしたい場合は JSDoc の `@internal`/`@lintignore` などで個別に無視する citeturn6search6turn1search0 |
| `includeEntryExports` | **workspace 単位** で ON/OFF 可能 | `src/index.ts` や `package.json#exports` など **エントリーファイルの未使用 export** も検出対象にする | **社内専用パッケージ**は true＝掃除対象に、**外部公開ライブラリ**は false＝API として残す、という切り分けが鉄板 citeturn0search1turn1search1 |

---

## 推奨フロー

1. **ルートの `knip.json` で全体方針を決める**
   ```jsonc
   {
     "$schema": "https://knip.dev/knip.schema.json",

     // ──① ファイル内専用の export は除外（テスト補助など）
     "ignoreExportsUsedInFile": true,

     // ──② ワークスペース定義
     "workspaces": {
       // アプリ / CLI など社内完結パッケージ
       "packages/app": {
         "includeEntryExports": true          // index.ts の不要エクスポートも報告
       },
       "packages/cli": {
         "includeEntryExports": true
       },

       // 公開 npm ライブラリ系
       "packages/ui-kit": {
         "includeEntryExports": false         // 公開 API は残す
       },
       "packages/sdk": {
         "includeEntryExports": false
       }
     }
   }
   ```
   *`includeEntryExports` を指定しない workspace は **false** と同義。*

2. **CI で差分チェック**
   ```json
   {
     "scripts": {
       "lint:deadcode": "knip --report --workspaces",
       "lint:deadcode:prod": "knip --production --report"
     }
   }
   ```
   - **通常モード** … テストも含めた未使用 export/ファイル/依存を検出  
   - **production モード** … 本番バンドルに不要なコードをさらに厳しく検出

3. **誤検知が出たら個別に回避**
   * JSDoc `@internal` / `@lintignore` タグで export ごとに無視  
   * `knip.json > ignore` で特定ファイル／依存を無視  
   * 動的 import・反射呼び出しがある箇所はコメントメモを残しておく

---

## 迷ったときの指針

| シチュエーション | 設定例 |
|------------------|--------|
| **テストヘルパや Storybook 用の export が大量** | `ignoreExportsUsedInFile: true`（ルート）&lt;br&gt;→ 「実装側で使われなくなったら自動で報告」なので掃除しやすい |
| **npm 公開ライブラリの `src/index.ts`** に&lt;br&gt;先行実験 API を隠し持たせたい | その workspace だけ `includeEntryExports: false` + JSDoc `@deprecated` で徐々に移行 |
| **社内ツールが増えてエントリーが乱立** | まず `includeEntryExports: true` でゴミ掃除 → 無視が必要なものだけ `@public` などタグ管理 |

---

### 仕上げチェックリスト ✓

- [ ] `ignoreExportsUsedInFile` は **ルートで一回** だけ設定しているか  
- [ ] `includeEntryExports` を **内部向け / 公開向け** で正しく振り分けたか  
- [ ] `paths` エイリアスや生成コードは `paths` / `ignore` に明示して誤検知を抑えたか  
- [ ] `knip --production` も定期実行し、テスト専用コードが本番に混ざっていないか確認  

これで **モノレポ全体の“死に export・死に SDK”を安全かつ段階的に撲滅**できます。

---

## 👤 User
*2025-06-12 11:37:40*

サーバーサイドとフロントサイドのワークスペースではどうなる

---

## 🤖 Assistant
*2025-06-12 11:37:41*

### 「サーバー用 workspace」と「フロント用 workspace」を分けたときの `knip` 設定指針

| 項目 | **Server-side workspace**&lt;br&gt;（Hono / Express / Nest など） | **Front-side workspace**&lt;br&gt;（Vite / Next.js / React SPA など） |
|------|------------------------------------------------------------|-----------------------------------------------------------------|
| **典型的なファイル構造** | `src/index.ts` がアプリ本体。&lt;br&gt;ルーティングはコードで `import` されることが多い | Next.js の `src/pages/**` や `app/**`、Vite の `src/main.tsx` など、**フレームワークが “ファイル名” で取り込む** パターン |
| **`includeEntryExports` 既定値のまま (`false`) にすると** | *index.ts* に置いたユーティリティ関数が未使用でも検知され **ない** → 死にコードが残る恐れ | Next.js ページ / API ルートの `export default` が「未使用」と誤判定され **る** |
| **推奨** | **`true`** …… `src/index.ts` 内の不要エクスポートもレポート&lt;br&gt;（フレームワークが import で拾うので誤検知は少ない） | **`false`** …… ページ・API ファイルはランタイムが読むだけで import されないため誤検知を防ぐ |
| **追加の無視設定例** | Nest の `@Module({ providers })` や Prisma seed など&lt;br&gt;**メタデータ経由で参照されるファイル** → `"ignore": ["src/**/migrations/**", "src/**/seed.ts"]` | Next.js の `src/pages/**`, `src/app/**/route.ts` は&lt;br&gt; `"ignore": ["src/pages/**", "src/app/**"]` で丸ごと除外でも可 |
| **SDK / 生成コードの扱い** | OpenAPI 生成物など → `"ignore": ["src/generated/**"]`&lt;br&gt;or workspace 自体で `include = []` | 同上（生成 GraphQL codegen など） |

---

## 具体的な `knip.json` サンプル

```jsonc
{
  "$schema": "https://knip.dev/knip.schema.json",

  /* ❶ 同一ファイル内だけで使うテスト補助 export は無視 */
  "ignoreExportsUsedInFile": true,

  /* ❷ workspaces ごとの細かい設定 */
  "workspaces": {
    /* ── Server side ───────────────────────── */
    "packages/server": {
      "includeEntryExports": true,          // index.ts の死に export を検出
      "ignore": [
        "src/generated/**",                 // OpenAPI SDK
        "src/**/migrations/**",
        "src/**/seed.ts"
      ],
      "paths": {                            // TS alias を knip に教える
        "@server/*": ["src/*"]
      }
    },

    /* ── Front side ────────────────────────── */
    "packages/web": {
      "includeEntryExports": false,         // Next.js ページを誤検知させない
      "ignore": [
        "src/pages/**",                     // file-system routing
        "src/app/**",                       // Next.js app router
        "src/generated/**"                  // GraphQL codegen など
      ],
      "paths": {
        "@web/*": ["src/*"]
      }
    }
  }
}
```

&gt; `includeEntryExports` は **workspace 単位で ON/OFF** できる唯一のスイッチです。誤判定しやすい “ファイル名で読み込む系フレームワーク” だけ **false** にするのが安全。

---

### FAQ よくある迷いどころ

| Q | A |
|---|---|
| **Server でもファイルベースルーティング（tRPC の `router/*` など）を使っている** | そのディレクトリだけ `"ignore": ["src/router/**"]` で除外するか、`includeEntryExports: false` に切り替える |
| **Next.js でも “design-system だけを export したサブパッケージ” がある** | そのサブパッケージ側で `includeEntryExports: true` にして死に export を検出 |
| **import alias が多すぎて誤検知が減らない** | ルート `knip.json` の `"paths"` で **モノレポ全 alias** を一元管理すると楽 |

---

### 最小導入ステップ

1. **設定ファイルを上記の形で置く**  
2. CI で  
   ```bash
   pnpm knip --workspaces --report
   ```  
   を回し、**exit code ≠ 0** なら PR をブロック  
3. 誤検知が出たら `ignore` またはコメント指示 `// knip-ignore` で抑制  
4. 慣れてきたら `knip --fix` で不要ファイル自動削除 → `pnpm biome check --apply` で import 整理

これで **サーバー / フロントの両方を “正しい閾値” で監視しながら、モノレポ全体の死にコードと不要 SDK を継続的に排除** できます。

---

## 👤 User
*2025-06-12 11:40:04*

設定を見直してほしい。 

{
  "files": [],
  "references": [
    { "path": "./packages/shared" },
    { "path": "./packages/database" },
    { "path": "./packages/api-client" },
    { "path": "./packages/web-client" },
    { "path": "./packages/server" }
  ]
}

{
  "name": "@myapp/web-client",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  "files": [
    "dist"
  ],
  "scripts": {
    "// 🚀 開発・実行": "",
    "dev": "vite",
    "start": "vite preview",
    "preview": "vite preview",
    "// 🏗️ ビルド・品質管理": "",
    "build": "vite build",
    "typecheck": "tsc -p . --noEmit",
    "lint": "biome check .",
    "lint:fix": "biome check . --write",
    "test": "vitest --run",
    "test:watch": "vitest",
    "// ✅ 統合検証": "",
    "verify": "pnpm lint && pnpm build && pnpm typecheck && pnpm test",
    "// 🧹 クリーンアップ": "",
    "clean": "rm -rf dist *.tsbuildinfo"
  },
  "dependencies": {
    "@myapp/api-client": "workspace:*",
    "@myapp/shared": "workspace:*",
    "react": "19.1.0",
    "react-dom": "19.1.0",
    "react-router": "7.6.2",
    "zod": "3.25.51"
  },
  "devDependencies": {
    "@testing-library/dom": "10.4.0",
    "@testing-library/react": "16.3.0",
    "@types/node": "22.15.29",
    "@types/react": "19.1.6",
    "@types/react-dom": "19.1.6",
    "@vitejs/plugin-react": "4.5.1",
    "jsdom": "26.1.0",
    "tsx": "4.19.4",
    "typescript": "5.8.3",
    "vite": "6.3.5"
  }
}


import type { KnipConfig } from "knip";

const config: KnipConfig = {
  // pnpm workspaceの各パッケージ設定
  workspaces: {
    // サーバーパッケージ: Honoアプリケーション
    "packages/server": {
      entry: ["src/index.ts"],
      project: ["src/**/*.ts"],
    },
    // Webクライアント: Reactアプリケーション
    "packages/web-client": {
      entry: ["src/main.tsx"],
      project: ["src/**/*.{ts,tsx}"],
    },
    // データベースパッケージ: Prismaクライアント（エントリーポイントなし）
    "packages/database": {
      entry: [],
      project: ["src/**/*.ts"],
    },
    // APIクライアント: 自動生成コード（エントリーポイントなし）
    "packages/api-client": {
      entry: [],
      project: ["src/**/*.ts"],
    },
    // 共有パッケージ: 共通型定義（エントリーポイントなし）
    "packages/shared": {
      entry: [],
      project: ["src/**/*.ts"],
    },
  },

  // Knipプラグイン設定
  vitest: {
    config: ["vitest.config.ts", "packages/*/vitest.config.ts"],
  },
  typescript: {
    config: ["tsconfig.json", "packages/*/tsconfig.json"],
  },

  // 無視する依存関係
  ignoreDependencies: [
    // TypeScript 関連
    "tslib", // TypeScript の importHelpers で自動的に使用される
    "tsx", // スクリプト実行用（package.jsonのスクリプトで使用）

    // 型定義・スキーマ関連
    "zod", // サブパッケージで使用、ルートでも型定義のために必要

    // コード生成関連
    "@prisma/client", // Prisma generate で必要（実際の使用は生成コード内）
    "@hey-api/client-fetch", // openapi-ts.config.ts でコード生成に使用
  ],

  // 無視する未解決インポート（Knipのワークスペース相対パス解決の問題回避）
  ignoreUnresolved: [
    "./src/__tests__/setup.ts", // Vitest setup files - 実際には存在するがKnipが相対パスを解決できない
  ],

  // 無視するワークスペース
  ignoreWorkspaces: [
    "docs/api", // 自動生成されるAPIドキュメント
  ],

  // 除外するファイル・ディレクトリ
  ignore: [
    // 自動生成
    "packages/**/src/generated/**",
    "docs/api/**",

    // ビルド成果物
    "**/dist/**",
    "**/build/**",
    "**/*.tsbuildinfo",

    // 設定・環境ファイル
    "knip.config.ts",
    ".husky/**",

    // テスト関連
    "**/*.manual.test.ts",
  ],

  // === 厳格な設定 ===
  // エクスポートに関する設定
  ignoreExportsUsedInFile: false, // ファイル内で使用されているexportも検出対象
  includeEntryExports: false, // エントリーファイルのexportは検出対象外（エントリーポイントなので）
};

export default config;

---

## 🤖 Assistant
*2025-06-12 11:40:19*

以下の観点で見直すと、モノレポ全体の **誤検知を減らしつつ “死に export／死に SDK” を漏れなく拾える** 構成になります。

---

## 1️⃣ グローバル方針

| 目的 | 推奨値 | 理由 |
|------|--------|------|
| **同一ファイル内だけで使うテスト補助等を無視したい** | `ignoreExportsUsedInFile: true` | ルートに 1 回指定すれば、テストヘルパや Storybook のモック関数で誤検知しなくなる citeturn0search6 |
| **エントリーファイルの export を検査するか** | workspace ごとに切替 | - **Server** → `true` で `src/index.ts` の不要 export も掃除&lt;br&gt;- **Web (Next/Vite)** → `false` でページ／API ルートの誤検知を防ぐ citeturn0search1turn0search10 |
| **パス alias 誤検知回避** | `paths` を明示 | TS の `compilerOptions.paths` は自動取得されるが、&lt;br&gt;モノレポ跨ぎの alias は `knip.json#paths` に列挙すると確実 citeturn0search0turn0search9 |

---

## 2️⃣ 改善版 `knip.config.ts`

```ts
import type { KnipConfig } from "knip";

const config: KnipConfig = {
  /* ---------- 共通 ---------- */
  ignoreExportsUsedInFile: true,      // テスト補助 export は無視
  workspaces: {
    /* ----- Server (Hono) ----- */
    "packages/server": {
      entry: ["src/index.ts"],        // サーバー起点
      project: ["src/**/*.ts"],
      includeEntryExports: true,      // index.ts の dead export も検出
      paths: { "@server/*": ["src/*"] }
    },

    /* ----- Web (Vite / React) ----- */
    "packages/web-client": {
      entry: ["src/main.tsx"],        // Vite 起点
      project: ["src/**/*.{ts,tsx}"],
      includeEntryExports: false,     // ページ/Route を誤検知させない
      paths: { "@web/*": ["src/*"] }
    },

    /* ----- Database (Prisma) ----- */
    "packages/database": {
      project: ["src/**/*.ts"],
      includeEntryExports: true       // 余分な util を検出したい
    },

    /* ----- API Client (生成) ----- */
    "packages/api-client": {
      project: ["src/**/*.ts"],
      includeEntryExports: false,     // 自動生成 → 基本除外
      ignore: ["src/generated/**"]
    },

    /* ----- Shared Types ----- */
    "packages/shared": {
      project: ["src/**/*.ts"],
      includeEntryExports: true
    }
  },

  /* ---------- プラグイン ---------- */
  vitest: { config: ["vitest.config.ts", "packages/*/vitest.config.ts"] },
  typescript: { config: ["tsconfig.json", "packages/*/tsconfig.json"] },

  /* ---------- グローバル ignore ---------- */
  paths: { "@myapp/*": ["packages/*/src"] },         // モノレポ alias
  ignore: [
    "packages/**/src/generated/**",                  // 自動生成
    "**/dist/**", "**/build/**", "**/*.tsbuildinfo",
    "docs/api/**", ".husky/**", "**/*.manual.test.ts"
  ],
  ignoreWorkspaces: ["docs/api"],
  ignoreDependencies: [
    "tslib", "tsx", "zod",
    "@prisma/client", "@hey-api/client-fetch"
  ]
};

export default config;
```

### 変更点まとめ

| 箇所 | BEFORE | AFTER | 効果 |
|------|--------|-------|------|
| **ignoreExportsUsedInFile** | `false` | `true` | テスト／Storybook 補助関数を誤検知しない |
| **includeEntryExports** | すべて `false` | Server / DB / Shared だけ `true` | エントリーファイルまで掃除したいパッケージを限定 |
| **paths alias** | なし | 追加 | モノレポ跨ぎの `@myapp/*` import を正しく解析 |
| **workspace-level ignore** | 生成コードを全体で除外 | `api-client` のみにローカル override | 他パッケージで誤検知が減る |
| **plugin tsconfig パス** | 既存 | 変更なし | OK |

---

## 3️⃣ `tsconfig.json` 連携チェックリスト

1. **各 package の `tsconfig.json` に `composite: true` と `references`**  
   ルート `references` だけでは必要ファイルがビルド対象にならない場合がある。
2. **`baseUrl` / `paths` を package 側にも合わせる**  
   Knip は `compilerOptions.paths` を拾うので整合性が取れる。

---

## 4️⃣ 導入フロー

1. ルートに置いた `knip.config.ts` を上記の形に更新  
2. `pnpm knip --report --workspaces` で実行  
3. 誤検知が出たら  
   * 生成ディレクトリ → `ignore`  
   * 特定ファイル → `// knip-ignore` コメント  
4. 安定後、CI に  
   ```bash
   pnpm lint && pnpm knip --report --workspaces
   ```  
   を追加し、PR 単位で “死にコード禁止” を徹底

こうしておくと **Server / Web 双方でフレームワーク特有の誤検知を防ぎながら、未使用 export・ファイル・依存を CI で継続的に排除** できます。

---

## 👤 User
*2025-06-12 11:57:16*

--report のオプションがなかった。 

Unknown option '--report'

✂️  Find unused dependencies, exports and files in your JavaScript and TypeScript projects

Usage: knip [options]

Options:
  -c, --config [file]      Configuration file path (default: [.]knip.json[c], knip.(js|ts), knip.config.(js|ts) or package.json#knip)
  -t, --tsConfig [file]    TypeScript configuration path (default: tsconfig.json)
  --production             Analyze only production source files (e.g. no test files, devDependencies)
  --strict                 Consider only direct dependencies of workspace (not devDependencies, not other workspaces)
  -W, --workspace [dir]    Analyze a single workspace (default: analyze all configured workspaces)
  --directory [dir]        Run process from a different directory (default: cwd)
  --cache                  Enable caching
  --cache-location         Change cache location (default: node_modules/.cache/knip)
  --watch                  Watch mode
  --no-gitignore           Don't use .gitignore
  --include                Report only provided issue type(s), can be comma-separated or repeated (1)
  --exclude                Exclude provided issue type(s) from report, can be comma-separated or repeated (1)
  --dependencies           Shortcut for --include dependencies,unlisted,binaries,unresolved
  --exports                Shortcut for --include exports,nsExports,classMembers,types,nsTypes,enumMembers,duplicates
  --files                  Shortcut for --include files
  --fix                    Fix issues
  --fix-type               Fix only issues of type, can be comma-separated or repeated (2)
  --format                 Format modified files after --fix using the local formatter
  --allow-remove-files     Allow Knip to remove files (with --fix)
  --include-libs           Include type definitions from external dependencies (default: false)
  --include-entry-exports  Include entry files when reporting unused exports
  --isolate-workspaces     Isolate workspaces into separate programs
  -n, --no-progress        Don't show dynamic progress updates (automatically enabled in CI environments)
  --preprocessor           Preprocess the results before providing it to the reporter(s), can be repeated
  --preprocessor-options   Pass extra options to the preprocessor (as JSON string, see --reporter-options example)
  --reporter               Select reporter: symbols, compact, codeowners, json, codeclimate, markdown, disclosure, can be repeated (default: symbols)
  --reporter-options       Pass extra options to the reporter (as JSON string, see example)
  --tags                   Include or exclude tagged exports
  --no-config-hints        Suppress configuration hints
  --treat-config-hints-as-errors    Exit with non-zero code (1) if there are any configuration hints
  --no-exit-code           Always exit with code zero (0)
  --max-issues             Maximum number of issues before non-zero exit code (default: 0)
  -d, --debug              Show debug output
  --trace                  Show trace output
  --trace-export [name]    Show trace output for named export(s)
  --trace-file [file]      Show trace output for exports in file
  --performance            Measure count and running time of key functions and display stats table
  --performance-fn [name]  Measure only function [name]
  --memory                 Measure memory usage and display data table
  --memory-realtime        Log memory usage in realtime
  -h, --help               Print this help text
  -V, --version            Print version

(1) Issue types: files, dependencies, unlisted, unresolved, exports, nsExports, classMembers, types, nsTypes, enumMembers, duplicates
(2) Fixable issue types: dependencies, exports, types

Examples:

$ knip
$ knip --production
$ knip --workspace packages/client --include files,dependencies
$ knip -c ./config/knip.json --reporter compact
$ knip --reporter codeowners --reporter-options '{"path":".github/CODEOWNERS"}'
$ knip --tags=-lintignore

Website: https://knip.dev

---

## 🤖 Assistant
*2025-06-12 11:57:18*

### 🙇‍♂️ 失礼しました — `--report` は v4 系で廃止

Knip v4 以降は **“検出結果を一覧表示＋ exit code≠0”** という挙動がデフォルトになり、  
旧 v3 の `--report` 相当スイッチは削除されました。現行版では **そのままコマンドを実行**すれば CI で失敗させられます。

```bash
# これだけで OK（問題があれば exit code 1）
pnpm knip --workspace packages/web-client        # 単体
pnpm knip --isolate-workspaces                   # すべて
```

---

## CI 用の最新パターン

| 目的 | 推奨コマンド | 補足 |
|------|--------------|------|
| **通常チェック**&lt;br&gt;（開発・CI 共通） | `knip --isolate-workspaces` | すべての workspace を独立解析し exit code 管理 |
| **本番バンドルに不要なものだけ検出** | `knip --production` | `devDependencies` とテスト系ファイルを自動除外 |
| **特定 issue タイプだけ**&lt;br&gt;（依存＋未解決 import だけ拾いたい等） | `knip --dependencies`&lt;br&gt;または&lt;br&gt;`knip --include dependencies,unresolved` | `--include/--exclude` で細粒度フィルタ |
| **マシン判定しやすい JSON 出力** | `knip --reporter json > knip-result.json` | GitHub Actions の `actions/upload-artifact` と相性◎ |

&gt; **exit code ルール**  
&gt; * 問題ゼロ … **0**  
&gt; * 検出あり … **1**（`--max-issues` で上限制御可）  
&gt; * `--no-exit-code` を付けると常に 0

---

## `package.json` スクリプト例（修正版）

```jsonc
{
  "scripts": {
    "// ⚡ デッドコード検出": "",
    "deadcode":      "knip --isolate-workspaces",
    "deadcode:prod": "knip --production --isolate-workspaces",
    "deadcode:json": "knip --isolate-workspaces --reporter json > knip-report.json",

    "// 🧹 自動修正": "",
    "deadcode:fix":  "knip --isolate-workspaces --fix --allow-remove-files && biome check . --write"
  }
}
```

---

## 参考: 主な v4 ブレークポイント

| 変更点 | 旧 v3 |  v4 現行 |
|--------|-------|----------|
| デフォルトの表示 | `exports,files,dependencies` をまとめた一覧 | 同じだが `--report` 不要 |
| `--report` | 一覧表示＋ exit=0 | **削除** |
| `--fix` の安全装置 | 自動で除外されていた | ファイル削除は **`--allow-remove-files`** 必須 |
| `--include-entry-exports` | グローバル | **CLI フラグ**に統合（`--include-entry-exports`） |

---

### 🔑 ポイント

* **CI ではコマンドだけで失敗判定**：`knip` が exit code 1 を返すので、`pnpm deadcode` をワークフローに置くだけ。  
* **レポート形式を変えたい** → `--reporter compact / markdown / json` などで切替。  
* **自動修正を許可** → `--fix --allow-remove-files` ＋ その後に `biome check --write` で import 整理。

これで **最新 Knip の仕様に沿ったデッドコード検出フロー** が組めます。

---
