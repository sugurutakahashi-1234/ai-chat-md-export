# Vitest プロジェクト設定

日付: 2025-06-19

---

## 👤 ユーザー
*2025/6/20 1:24:28*

vitestを導入しているのだけれどもモノレポになっている。 
昔はワークスペースというもので管理していたらしいけど、今はプロジェクトというもので管理しているみたいだ。 プロジェクトの設定の仕方を教えてほしい。 
とりあえずWebとサーバーとシェアに分かれていると思っていい。
本当はviteを使っている。 

https://vitest.dev/guide/projects

---

## 🤖 アシスタント
*2025/6/20 1:24:57*

### “workspace” → “projects” への移行ポイント

- **Vitest 3.2 で `workspace` は非推奨となり、`test.projects` 設定に置き換わりました**（機能は同じ。名前だけ変更）citeturn3view0  
- 1 プロセス内で複数の **プロジェクト（＝サブパッケージやテスト種別）** を走らせられるので、モノレポとの相性が良いです。citeturn3view0  

---

## 典型的なモノレポ構成例  
```
root/
├─ vitest.config.ts          # ルート設定（全体共通）
├─ vitest.shared.ts          # 共通テスト設定（任意）
└─ packages/
   ├─ web/                   # フロントエンド (Vite + React 等)
   │   ├─ src/
   │   └─ vitest.config.ts   # Web 専用設定
   ├─ server/                # Node サーバー
   │   └─ vitest.config.ts
   └─ shared/                # 共通ライブラリ
       └─ vitest.config.ts
```

---

## 1️⃣ ルート `vitest.config.ts`

```ts
import { defineConfig } from 'vitest/config'

export default defineConfig({
  // Vite の共有プラグインもここで設定可
  test: {
    pool: 'threads',           // ⏱️ 並列実行
    // packages/* を “プロジェクト” として扱う
    projects: ['packages/*'],
    // ルート側のみに置けるオプション
    reporters: ['default', 'junit'],
    coverage: {
      provider: 'v8',
      reportsDirectory: './coverage',
    },
  },
})
```
ポイント  

| 項目 | 意味 |
|------|------|
| `projects: ['packages/*']` | `packages` 配下を丸ごと走査。個々の config が無くてもプロジェクト扱いになるciteturn3view0 |
| ルート config は **テスト対象にはならない**。必要なら自身もプロジェクトに追加する |
| `coverage`, `reporters` などは **プロジェクト側では設定不可**。ルートで一括指定するciteturn1view0 |

---

## 2️⃣ 各パッケージ側の `vitest.config.ts`

### `packages/web/vitest.config.ts`
```ts
import { defineProject, mergeConfig } from 'vitest/config'
import shared from '../../vitest.shared'
import react from '@vitejs/plugin-react'

export default mergeConfig(
  shared,                      // 共通設定をマージ
  defineProject({
    plugins: [react()],
    test: {
      name: { label: 'web', color: 'cyan' }, // ラベル色も設定可
      environment: 'jsdom',   // DOM API が必要
      globals: true,
      setupFiles: ['./test/setup.ts'],
      alias: {                // Vite の別名も OK
        '~': '/src',
      },
    },
  }),
)
```

### `packages/server/vitest.config.ts`
```ts
import { defineProject } from 'vitest/config'

export default defineProject({
  test: {
    name: 'server',
    environment: 'node',
    setupFiles: ['./test/setup.ts'],
  },
})
```

### `packages/shared/vitest.config.ts`
```ts
import { defineProject } from 'vitest/config'

export default defineProject({
  test: {
    name: 'shared',
    environment: 'node',
  },
})
```

> **Tip** : `defineProject` を使うと、プロジェクト用に許可されていないプロパティを型レベルで弾いてくれるので安全ですciteturn3view0。

---

## 3️⃣ テスト実行コマンド

- すべてのプロジェクト  
  ```bash
  pnpm vitest
  # または npm run test / bun run test
  ```
- 特定プロジェクトだけ  
  ```bash
  pnpm vitest --project web          # web だけ
  pnpm vitest --project web --project server  # 複数指定も可
  ```citeturn3view0

---

## 4️⃣ “workspace” からの移行メモ

| 旧 (`workspace`) | 新 (`projects`) |
|------------------|-----------------|
| `test.workspace = [...]` | `test.projects = [...]` |
| 動作は同じ。名前を変えるだけ | 3.2 以降はこちら推奨citeturn3view0 |

---

### まとめ
1. **ルート**で `test.projects` にパス or インライン設定を並べる。  
2. **各パッケージ**は `defineProject` または `mergeConfig` で個別設定。  
3. `coverage`・`reporters` 等の **グローバル設定はルートのみ**。  
4. 実行時は `--project` でフィルタリング。  

これで Web／Server／Shared それぞれの設定を分離しつつ、モノレポ全体を１コマンドでテストできます。

---
