# Slack通知を設定する

Date: 2023-05-08

---

## 👤 User
*2023-05-09 01:26:47*

PRのレビューワーがコメントもしくは了承したときにSlackに通知を送りたいんだけどどうすればいい？

---

## 🤖 Assistant
*2023-05-09 01:27:59*

GitHubのプルリクエスト（PR）のレビューが完了した際にSlackに通知を送るには、GitHubとSlackの連携を利用して設定することができます。以下の手順で設定してみてください。

1. SlackのApp Directoryから「GitHub」アプリをインストールします。
   https://slack.com/apps/A0F7YS25R-github

2. インストールが完了したら、SlackでGitHubアプリがどのチャンネルに通知を送るか選択し、設定を完了させます。

3. Slackの設定が完了したら、GitHubに移動して対象リポジトリにアクセスします。

4. リポジトリページの右上にある「Settings」をクリックして、「Settings」ページに移動します。

5. 左側のメニューから「Webhooks」を選択します。

6. 右上の「Add webhook」ボタンをクリックします。

7. 「Payload URL」に、SlackのGitHubアプリから提供されるWebhook URLを貼り付けます。このURLは、GitHubアプリの設定ページで確認できます。

8. 「Content type」を`application/json`に設定します。

9. 「Which events would you like to trigger this webhook?」で、「Let me select individual events」を選択し、下のオプションで「Pull requests」と「Pull request reviews」にチェックを入れます。

10. 最後に、「Add webhook」ボタンをクリックして設定を保存します。

これで、プルリクエストのレビューが完了した際にSlackに通知が送られるようになります。なお、SlackとGitHubの連携には多くの設定がありますので、自分のニーズに合わせてカスタマイズしてください。

---

## 👤 User
*2023-05-09 01:28:17*

Webhooks じゃなくて、GitHub Actions を使いたい

---

## 🤖 Assistant
*2023-05-09 01:29:44*

GitHub Actionsを使用して、プルリクエストのレビューが完了した際にSlackに通知を送ることもできます。以下の手順で設定してみてください。

1. まず、GitHubリポジトリのルートディレクトリに`.github/workflows`ディレクトリを作成します（すでに存在する場合はスキップ）。

2. そのディレクトリに`pr_review_slack_notification.yml`などの名前で新しいYAMLファイルを作成します。

3. そのファイルに以下の内容を追加し、`SLACK_WEBHOOK_URL`という名前の[GitHubリポジトリのシークレット](https://docs.github.com/en/actions/reference/encrypted-secrets)に、SlackのWebhook URLを追加します（SlackのWebhook URLの取得方法は[こちら](https://slack.com/intl/ja-jp/help/articles/115005265063-Incoming-webhooks-for-Slack)）。

```yaml
name: PR Review Slack Notification

on:
  pull_request_review:
    types:
      - submitted

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
    - name: Send Slack notification
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      uses: act10ns/slack@v3
      with:
        status: ${{ job.status }}
        steps:
          - name: PR review
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            run: |
              echo "PR_URL=${{ github.event.pull_request.html_url }}" >> $GITHUB_ENV
              echo "REVIEW_STATE=${{ github.event.review.state }}" >> $GITHUB_ENV
              echo "REVIEW_AUTHOR=${{ github.event.review.user.login }}" >> $GITHUB_ENV
              echo "PR_AUTHOR=${{ github.event.pull_request.user.login }}" >> $GITHUB_ENV
        env:
          SLACK_MESSAGE: "A PR review has been ${REVIEW_STATE} by ${REVIEW_AUTHOR} for PR #${{ github.event.pull_request.number }} (${PR_AUTHOR}): ${PR_URL}"
          SLACK_COLOR: ${{ job.status == 'success' && 'good' || 'danger' }}
```

4. 上記のYAMLファイルをコミットしてプッシュします。

これで、プルリクエストのレビューが完了した際にSlackに通知が送られるようになります。`SLACK_MESSAGE`の内容や`SLACK_COLOR`をカスタマイズして、通知を自分のニーズに合わせて調整できます。

---

## 👤 User
*2023-05-09 01:30:13*

ちなみにどんな感じのメッセージになるの？

---

## 🤖 Assistant
*2023-05-09 01:31:32*

上記の設定でSlackに送信される通知メッセージは、以下のような形式になります。

```
A PR review has been [レビューの状態] by [レビュワーのユーザー名] for PR #[プルリクエスト番号] ([プルリクエスト作成者のユーザー名]): [プルリクエストのURL]
```

例えば、ユーザー名 `john_doe` がプルリクエスト番号 `42` のレビューを承認し、そのプルリクエストの作成者が `jane_doe` である場合、次のようなメッセージがSlackに表示されます。

```
A PR review has been approved by john_doe for PR #42 (jane_doe): https://github.com/user/repo/pull/42
```

`SLACK_MESSAGE` は自由にカスタマイズすることができますので、必要に応じてメッセージ内容を変更してください。たとえば、次のようにレビューの状態を日本語に変更することもできます。

```yaml
SLACK_MESSAGE: "プルリクエストのレビューが ${REVIEW_STATE} されました。レビュワー: ${REVIEW_AUTHOR}、プルリクエスト: #${{ github.event.pull_request.number }} (${PR_AUTHOR}): ${PR_URL}"
```

この場合、例えば以下のようなメッセージになります。

```
プルリクエストのレビューが approved されました。レビュワー: john_doe、プルリクエスト: #42 (jane_doe): https://github.com/user/repo/pull/42
```

---

## 👤 User
*2023-05-09 01:32:11*

PRの作成者にメンションもつけたいんだけどできる？

---

## 🤖 Assistant
*2023-05-09 01:34:21*

SlackでGitHubのユーザー名と同じ名前のメンションを作成する場合、次のように`SLACK_MESSAGE`をカスタマイズできます。ただし、これはGitHubのユーザー名とSlackのユーザー名が同じであることが前提となります。また、メンションが正常に機能するかどうかは、Slackのワークスペースの設定によります。

```yaml
SLACK_MESSAGE: "A PR review has been ${REVIEW_STATE} by ${REVIEW_AUTHOR} for PR #${{ github.event.pull_request.number }} (<@${PR_AUTHOR}>): ${PR_URL}"
```

これにより、メッセージ内にプルリクエストの作成者に対するメンションが追加されます。ただし、この方法でメンションが機能しない場合があります。その場合は、SlackのユーザーIDを取得してメンションを作成する必要がありますが、これを行うにはSlack APIを利用する必要があります。

Slack APIを利用してGitHubユーザー名とSlackのユーザーIDをマッピングする方法は、以下の手順で実行できます。

1. まず、Slack APIでボットトークンを取得します。[こちら](https://www.twilio.com/blog/how-to-build-a-slackbot-in-socket-mode-with-python)のチュートリアルに従ってください。

2. 次に、Slack APIを使用して、GitHubユーザー名とSlackユーザーIDのマッピングを行うためのPythonスクリプトを作成します。このスクリプトは、GitHub Actionsワークフロー内で実行されることを想定しています。

例:

```python
import os
import requests
from requests.structures import CaseInsensitiveDict

# Set required environment variables
SLACK_BOT_TOKEN = os.environ['SLACK_BOT_TOKEN']
GITHUB_USERNAME = os.environ['GITHUB_USERNAME']

# Set headers for Slack API request
headers = CaseInsensitiveDict()
headers["Content-Type"] = "application/json"
headers["Authorization"] = f"Bearer {SLACK_BOT_TOKEN}"

# Call the Slack API to get the list of users
resp = requests.get("https://slack.com/api/users.list", headers=headers)

# Check if the API request was successful
if resp.status_code != 200:
    raise ValueError("Failed to fetch users from Slack API")

# Get the JSON response body
response_json = resp.json()

# Find the Slack user ID that matches the GitHub username
slack_user_id = None
for user in response_json['members']:
    if user['profile'].get('display_name') == GITHUB_USERNAME:
        slack_user_id = user['id']
        break

# Raise an error if the Slack user ID was not found
if not slack_user_id:
    raise ValueError(f"Slack user ID not found for GitHub username: {GITHUB_USERNAME}")

# Print the Slack user ID to be used as an environment variable in the GitHub Actions workflow
print(f"SLACK_USER_ID={slack_user

---
