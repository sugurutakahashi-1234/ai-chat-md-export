# ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°

æ—¥ä»˜: 2025-01-19

---

## ðŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2025/1/19 16:06:19*

ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆãŒæ·±ã™ãŽã‚‹éƒ¨åˆ†ã‚’åˆ‡ã‚Šå‡ºã—ã¦ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã»ã—ã„ã€‚
ã‚ã¾ã‚Šç´°ã‹ãåˆ†ã‘ãªãã¦ã„ã„ãŒã€æ„å‘³ã®ã‚ã‚‹å˜ä½ã§åˆ†å‰²ã—ã¦ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆãŒæ·±ã„ã®ã‚’ã‚„ã‚ãŸã„ã€‚


import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter\_hooks/flutter\_hooks.dart';
import 'package:flutter\_svg/svg.dart';
import 'package:go\_router/go\_router.dart';
import 'package:hooks\_riverpod/hooks\_riverpod.dart';
import 'package:intl/intl.dart';
import 'package:snpit\_guild\_app/domain/design/color\_pallet.dart';
import 'package:snpit\_guild\_app/domain/design/color\_token.dart';
import 'package:snpit\_guild\_app/domain/screen.dart';
import 'package:snpit\_guild\_app/gen/assets.gen.dart';
import 'package:snpit\_guild\_app/infrastructure/snapit\_guild\_api/snapit\_guild\_api.openapi.dart';
import 'package:snpit\_guild\_app/presentation/providers/api\_client/accounts/get\_account.dart';
import 'package:snpit\_guild\_app/presentation/providers/api\_client/guilds/get\_guild.dart';
import 'package:snpit\_guild\_app/utils/extensions/uri\_extensions.dart';

class GuildPage extends HookConsumerWidget {
  const GuildPage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final myUserId = ref.watch(getMyAccountNotifierProvider).value?.userId;
    final myGuildInfoState = ref.watch(getMyGuildNotifierProvider);

    useEffect(
      () {
        Future.microtask(() async {
          await ref.read(getMyGuildNotifierProvider.notifier).getMyGuild();
        });
        return null;
      },
      \[\],
    );

    return Scaffold(
      body: RefreshIndicator(
        onRefresh: () async {
          await ref.read(getMyGuildNotifierProvider.notifier).getMyGuild();
        },
        child: myGuildInfoState.when(
          data: (guildInfo) {
            if (guildInfo != null) {
              final isAdminOrOwner = guildInfo.guildMembers?.any(
                    (member) =&gt;
                        member.userId == myUserId &&
                        (member.role == GuildMemberDtoRole.ADMIN ||
                            member.role == GuildMemberDtoRole.OWNER),
                  ) ??
                  false;
              final guildId = guildInfo.guildId ?? 'Unknown';
              final guildName = guildInfo.guildName ?? 'Unknown';
              final guildMembersCount = guildInfo.guildMembers?.length ?? 0;

              // ã‚®ãƒ«ãƒ‰æƒ…å ±ãŒã‚ã‚‹å ´åˆ
              return DefaultTabController(
                length: 2, // Tabã®æ•°
                child: Column(
                  children: \[
                    Expanded(
                      child: NestedScrollView(
                        headerSliverBuilder: (context, innerBoxIsScrolled) {
                          return \[
                            SliverToBoxAdapter(
                              child: Padding(
                                padding: const EdgeInsets.symmetric(
                                  horizontal: 24,
                                ),
                                child: Column(
                                  children: \[
                                    const SizedBox(height: 24),
                                    DecoratedBox(
                                      decoration: BoxDecoration(
                                        borderRadius: BorderRadius.circular(8),
                                        border: Border.all(
                                          color: ColorToken.secondary,
                                        ),
                                      ),
                                      child: Column(
                                        children: \[
                                          GestureDetector(
                                            onTap: () {
                                              Clipboard.setData(
                                                ClipboardData(
                                                  text: guildId,
                                                ),
                                              );
                                              ScaffoldMessenger.of(context)
                                                  .showSnackBar(
                                                SnackBar(
                                                  content: Text(
                                                    'Copied To Clipboard: '
                                                    '$guildId',
                                                  ),
                                                ),
                                              );
                                            },
                                            child: Container(
                                              padding:
                                                  const EdgeInsets.symmetric(
                                                vertical: 12,
                                                horizontal: 16,
                                              ),
                                              decoration: const BoxDecoration(
                                                color: ColorToken.secondary,
                                                borderRadius: BorderRadius.only(
                                                  bottomLeft:
                                                      Radius.circular(12),
                                                  bottomRight:
                                                      Radius.circular(12),
                                                ),
                                              ),
                                              child: Row(
                                                mainAxisSize: MainAxisSize.min,
                                                children: \[
                                                  SvgPicture.asset(
                                                    Assets.images.triangleDots
                                                        .path,
                                                  ),
                                                  const SizedBox(width: 8),
                                                  Text(
                                                    guildId,
                                                    style: const TextStyle(
                                                      fontSize: 14,
                                                    ),
                                                  ),
                                                \],
                                              ),
                                            ),
                                          ),
                                          const SizedBox(height: 20),
                                          ClipRRect(
                                            borderRadius:
                                                BorderRadius.circular(8),
                                            child: guildInfo.guildAvatar != null
                                                ? Image.network(
                                                    guildInfo.guildAvatar!,
                                                    width: 64,
                                                    height: 64,
                                                    fit: BoxFit.cover,
                                                  )
                                                : Container(
                                                    width: 64,
                                                    height: 64,
                                                    color: ColorToken.bgDark,
                                                    child: const Icon(
                                                      Icons.hide\_image\_outlined,
                                                      size: 48,
                                                      color: ColorToken.text,
                                                    ),
                                                  ),
                                          ),
                                          const SizedBox(height: 16),
                                          Text(
                                            guildName,
                                            style: const TextStyle(
                                              fontWeight: FontWeight.bold,
                                              fontSize: 18,
                                            ),
                                          ),
                                          const SizedBox(height: 8),
                                          Row(
                                            mainAxisAlignment:
                                                MainAxisAlignment.center,
                                            children: \[
                                              const Icon(
                                                Icons.people,
                                                size: 24,
                                                color: ColorToken.text,
                                              ),
                                              const SizedBox(width: 8),
                                              Text(
                                                '$guildMembersCount',
                                                style: const TextStyle(
                                                  fontSize: 14,
                                                ),
                                              ),
                                            \],
                                          ),
                                          const SizedBox(height: 24),
                                          const Padding(
                                            padding: EdgeInsets.symmetric(
                                              horizontal: 16,
                                            ),
                                            child: Divider(
                                              color: ColorToken.secondary,
                                              height: 0,
                                            ),
                                          ),
                                          const SizedBox(height: 24),
                                          Row(
                                            mainAxisAlignment:
                                                MainAxisAlignment.spaceEvenly,
                                            children: \[
                                              \_buildStatColumn(
                                                'Search',
                                                3879,
                                                'Q',
                                              ),
                                              \_buildStatColumn(
                                                'Attack',
                                                1230,
                                                'E',
                                              ),
                                              \_buildStatColumn(
                                                'Luck',
                                                893,
                                                'L',
                                              ),
                                              \_buildStatColumn(
                                                'Defence',
                                                905,
                                                'B',
                                              ),
                                            \],
                                          ),
                                          const SizedBox(height: 24),
                                        \],
                                      ),
                                    ),
                                    const SizedBox(height: 24),

                                    // ã‚®ãƒ«ãƒ‰ã®ç®¡ç†è€…ã¾ãŸã¯æ‰€æœ‰è€…ã®å ´åˆã®ã¿ç®¡ç†è€…ç”»é¢ã¸ã®å°Žç·šã‚’è¡¨ç¤º
                                    if (isAdminOrOwner) ...\[
                                      OutlinedButton(
                                        onPressed: () {
                                          context.push(Screen.guildManage.path);
                                        },
                                        child: const Stack(
                                          alignment: Alignment.center,
                                          children: \[
                                            Center(
                                              child: Text(
                                                'Manage this guild',
                                              ),
                                            ),
                                            Positioned(
                                              right: 0,
                                              child: Icon(
                                                Icons.arrow\_forward,
                                                size: 24,
                                                color: ColorToken.text,
                                              ),
                                            ),
                                          \],
                                        ),
                                      ),
                                      const SizedBox(height: 8),
                                    \],
                                  \],
                                ),
                              ),
                            ),
                            SliverPersistentHeader(
                              pinned: true,
                              delegate: \_SliverTabBarDelegate(
                                TabBar(
                                  dividerColor: ColorToken.secondary,
                                  indicator: UnderlineTabIndicator(
                                    borderSide: const BorderSide(
                                      color: ColorToken.primary,
                                      width: 4,
                                    ),
                                    insets: EdgeInsets.symmetric(
                                      horizontal:
                                          MediaQuery.of(context).size.width / 4,
                                    ),
                                  ),
                                  labelColor: ColorToken.text,
                                  unselectedLabelColor: ColorToken.secondary,
                                  tabs: const \[
                                    Tab(text: 'Members'),
                                    Tab(text: 'Spots'),
                                  \],
                                ),
                              ),
                            ),
                          \];
                        },
                        body: Padding(
                          padding: const EdgeInsets.only(
                            left: 24,
                            right: 24,
                            top: 24,
                          ),
                          child: TabBarView(
                            children: \[
                              // Members Tab
                              RefreshIndicator(
                                onRefresh: () async {
                                  await ref
                                      .read(getMyGuildNotifierProvider.notifier)
                                      .getMyGuild();
                                },
                                child: ListView.builder(
                                  itemCount: guildInfo.guildMembers
                                          ?.where(
                                            (member) =&gt;
                                                member.memberStatus ==
                                                    GuildMemberDtoMemberStatus
                                                        .JOINED ||
                                                member.memberStatus ==
                                                    GuildMemberDtoMemberStatus
                                                        .INVITED,
                                          )
                                          .length ??
                                      0,
                                  itemBuilder: (context, index) {
                                    final filteredMembers =
                                        guildInfo.guildMembers!
                                            .where(
                                              (member) =&gt;
                                                  member.memberStatus ==
                                                      GuildMemberDtoMemberStatus
                                                          .JOINED ||
                                                  member.memberStatus ==
                                                      GuildMemberDtoMemberStatus
                                                          .INVITED,
                                            )
                                            .toList();
                                    final member = filteredMembers\[index\];
                                    final userName =
                                        member.username ?? 'Unknown';
                                    final userPhotoUrl = member.avatar;
                                    return Padding(
                                      padding: const EdgeInsets.only(bottom: 8),
                                      child: DecoratedBox(
                                        decoration: BoxDecoration(
                                          color: ColorToken.bg,
                                          borderRadius:
                                              BorderRadius.circular(4),
                                          border: Border.all(
                                            color: ColorToken.secondary,
                                          ),
                                        ),
                                        child: Padding(
                                          padding: const EdgeInsets.all(16),
                                          child: Row(
                                            children: \[
                                              Expanded(
                                                child: Column(
                                                  crossAxisAlignment:
                                                      CrossAxisAlignment.start,
                                                  children: \[
                                                    Row(
                                                      children: \[
                                                        CircleAvatar(
                                                          radius: 16,
                                                          backgroundImage:
                                                              userPhotoUrl !=
                                                                      null
                                                                  ? NetworkImage(
                                                                      userPhotoUrl,
                                                                    )
                                                                  : AssetImage(
                                                                      Assets
                                                                          .images
                                                                          .defaultUserProfile
                                                                          .path,
                                                                    ),
                                                        ),
                                                        const SizedBox(
                                                          width: 12,
                                                        ),
                                                        Expanded(
                                                          child: Text(
                                                            userName,
                                                            maxLines: 1,
                                                            overflow:
                                                                TextOverflow
                                                                    .ellipsis,
                                                            style:
                                                                const TextStyle(
                                                              color:
                                                                  Colors.white,
                                                              fontSize: 16,
                                                              fontWeight:
                                                                  FontWeight
                                                                      .bold,
                                                            ),
                                                          ),
                                                        ),
                                                      \],
                                                    ),
                                                    const SizedBox(height: 10),
                                                    Row(
                                                      children: List.generate(
                                                        4,
                                                        (badgeIndex) =&gt; Padding(
                                                          padding:
                                                              const EdgeInsets
                                                                  .only(
                                                            right: 4,
                                                          ),
                                                          child: ClipRRect(
                                                            borderRadius:
                                                                BorderRadius
                                                                    .circular(
                                                              4,
                                                            ),
                                                            child: SizedBox(
                                                              width: 28,
                                                              height: 28,
                                                              child:
                                                                  Image.network(
                                                                UriExtensions
                                                                    .random
                                                                    .toString(),
                                                                fit: BoxFit
                                                                    .cover,
                                                              ),
                                                            ),
                                                          ),
                                                        ),
                                                      ),
                                                    ),
                                                  \],
                                                ),
                                              ),
                                              Expanded(
                                                child: Column(
                                                  crossAxisAlignment:
                                                      CrossAxisAlignment.end,
                                                  children: \[
                                                    \_buildStatRow('Q', 13),
                                                    \_buildStatRow('E', 48),
                                                    \_buildStatRow('L', 7),
                                                    \_buildStatRow('B', 5),
                                                  \],
                                                ),
                                              ),
                                            \],
                                          ),
                                        ),
                                      ),
                                    );
                                  },
                                ),
                              ),

                              // Spots Tab
                              const Center(child: Text('COMING SOON...')),
                            \],
                          ),
                        ),
                      ),
                    ),
                  \],
                ),
              );
            } else {
              // ã‚®ãƒ«ãƒ‰æƒ…å ±ãŒãªã„å ´åˆ
              return const SingleChildScrollView(
                physics: AlwaysScrollableScrollPhysics(),
                child: Padding(
                  padding: EdgeInsets.symmetric(horizontal: 16),
                  child: \_NoGuildWidget(),
                ),
              );
            }
          },
          loading: () =&gt; const Center(child: CircularProgressIndicator()),
          error: (error, stackTrace) {
            WidgetsBinding.instance.addPostFrameCallback((\_) {
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(content: Text('Error: $error')),
              );
            });
            return SingleChildScrollView(
              physics: const AlwaysScrollableScrollPhysics(),
              child: Center(child: Text('An error occurred: $error')),
            );
          },
        ),
      ),
    );
  }

  Widget \_buildStatColumn(String title, int value, String subtext) {
    return Column(
      children: \[
        Text(
          title,
          style: const TextStyle(
            fontSize: 13,
          ),
        ),
        Text(
          NumberFormat('#,###').format(value),
          style: const TextStyle(
            fontSize: 16,
            color: ColorToken.primary,
          ),
        ),
        Text(
          '($subtext)',
          style: const TextStyle(
            fontSize: 12,
            color: ColorToken.secondary,
          ),
        ),
      \],
    );
  }

  Widget \_buildStatRow(String label, int value) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.end,
      children: \[
        const SizedBox(
          width: 40,
        ),
        SizedBox(
          width: 20,
          child: Text(
            label,
            style: const TextStyle(
              fontSize: 13,
            ),
          ),
        ),
        const SizedBox(width: 4),
        SizedBox(
          width: 30,
          child: Text(
            NumberFormat('#,###').format(value),
            style: const TextStyle(
              color: ColorToken.primary,
              fontSize: 11,
            ),
          ),
        ),
        const SizedBox(width: 4),
        Expanded(
          child: LinearProgressIndicator(
            value: value / 100, // Max value is 100
            borderRadius: BorderRadius.circular(8),
          ),
        ),
      \],
    );
  }
}

class \_NoGuildWidget extends StatelessWidget {
  const \_NoGuildWidget();

  @override
  Widget build(BuildContext context) {
    return Column(
      children: \[
        const SizedBox(height: 48),
        const Text(
          'No guild affiliation',
          style: TextStyle(
            fontSize: 28,
            fontWeight: FontWeight.bold,
          ),
          textAlign: TextAlign.center,
        ),
        const SizedBox(height: 20),
        const Text(
          'Join a guild or create a new one!',
          style: TextStyle(fontSize: 16),
          textAlign: TextAlign.center,
        ),
        const SizedBox(height: 56),
        Container(
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(8),
            border: Border.all(color: ColorToken.secondary),
          ),
          padding: const EdgeInsets.all(24),
          child: Column(
            children: \[
              Image.asset(
                Assets.images.joinGuildFig.path,
              ),
              const SizedBox(height: 24),
              ElevatedButton(
                onPressed: () {
                  context.push(Screen.guildCode.path);
                },
                child: const Stack(
                  alignment: Alignment.center,
                  children: \[
                    Center(
                      child: Text(
                        'Join an existing guild',
                      ),
                    ),
                    Positioned(
                      right: 0,
                      child: Icon(
                        Icons.arrow\_forward,
                        size: 24,
                        color: ColorToken.text,
                      ),
                    ),
                  \],
                ),
              ),
            \],
          ),
        ),
        const SizedBox(height: 16),
        Container(
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(8),
            border: Border.all(color: ColorToken.secondary),
          ),
          padding: const EdgeInsets.all(24),
          child: Column(
            children: \[
              Image.asset(
                Assets.images.createGuildFig.path,
              ),
              const SizedBox(height: 24),
              ElevatedButton(
                onPressed: () {
                  context.push(Screen.guildCreate.path);
                },
                child: const Stack(
                  alignment: Alignment.center,
                  children: \[
                    Center(
                      child: Text('Host a new guild'),
                    ),
                    Positioned(
                      right: 0,
                      child: Icon(
                        Icons.arrow\_forward,
                        size: 24,
                        color: ColorToken.text,
                      ),
                    ),
                  \],
                ),
              ),
            \],
          ),
        ),
        const SizedBox(height: 48),
      \],
    );
  }
}

class \_SliverTabBarDelegate extends SliverPersistentHeaderDelegate {
  \_SliverTabBarDelegate(this.tabBar);
  final TabBar tabBar;

  @override
  double get minExtent =&gt; tabBar.preferredSize.height;

  @override
  double get maxExtent =&gt; tabBar.preferredSize.height;

  @override
  Widget build(
    BuildContext context,
    double shrinkOffset,
    bool overlapsContent,
  ) {
    return ColoredBox(
      color: ColorPallet.gray800,
      child: tabBar,
    );
  }

  @override
  bool shouldRebuild(\_SliverTabBarDelegate oldDelegate) {
    return oldDelegate.tabBar != tabBar;
  }
}

---

## ðŸ”§ ãƒ„ãƒ¼ãƒ«
*2025/1/19 16:07:01*

\*\*Refactoring the code\*\*

Iâ€™m mapping out the deep indentation in the GuildPage widget. Breaking down GuildInfoSection and Member tab into separate widgets clarifies the implementation, making the code more comprehensible.

\*\*Breaking down code\*\*

Iâ€™m creating two to three sub-widgets to reduce indentation: the GuildHeader widget from SliverToBoxAdapter and the GuildMembersTabView from TabBarView to streamline the code.

\*\*Streamlining structure\*\*

Organizing the code with "GuildInfoHeader" and "GuildTabsView" sub-widgets, and within "GuildTabsView," incorporating a "MembersList" sub-widget to effectively reduce indentation.

\*\*Refining widget flow\*\*

Iâ€™m mapping out the widget structure to streamline indentation, using separate widget methods to define `\_GuildContent` for `DefaultTabController` and `NestedScrollView` implementation.

\*\*Refactoring for clarity\*\*

Iâ€™m working on simplifying widget structures by refining `\_buildHeaderSliverBuilder`, extracting tab bar views, and streamlining the members list code to enhance code clarity and reduce complexity.

\*\*Organizing the code\*\*

Iâ€™m working on guiding users through organizing their code with a few classes and methods to streamline the structure while ensuring clarity.

---

## ðŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2025/1/19 16:07:01*

ä»¥ä¸‹ã®ä¾‹ã§ã¯ã€æ·±ã„ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã«ãªã‚ŠãŒã¡ãªç®‡æ‰€ï¼ˆç‰¹ã«ã‚®ãƒ«ãƒ‰æƒ…å ±ã®è¡¨ç¤ºéƒ¨åˆ†ï¼‰ã‚’ã€ã„ãã¤ã‹ã®Widgetã«åˆ‡ã‚Šå‡ºã—ã¦ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ãŸã‚‚ã®ã§ã™ã€‚  
ã€ŒGuildPageã€è‡ªä½“ã§ã¯å¤§æž ï¼ˆScaffold ã‚„ Future ã®å‘¼ã³å‡ºã—ãªã©ï¼‰ã‚’è¡Œã„ã€å®Ÿéš›ã®è¡¨ç¤ºã¯ã€Œ_GuildContentã€ã€Œ_NoGuildWidgetã€ãªã©ã®Widgetã«ä»»ã›ã¦ã„ã¾ã™ã€‚  
ã‚ã¾ã‚Šç´°ã‹ãåˆ†å‰²ã—ã™ãŽãšã«ã€æ„å‘³ã®ã‚ã‚‹å˜ä½ã§ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚

```dart
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_hooks/flutter_hooks.dart';
import 'package:flutter_svg/svg.dart';
import 'package:go_router/go_router.dart';
import 'package:hooks_riverpod/hooks_riverpod.dart';
import 'package:intl/intl.dart';
import 'package:snpit_guild_app/domain/design/color_pallet.dart';
import 'package:snpit_guild_app/domain/design/color_token.dart';
import 'package:snpit_guild_app/domain/screen.dart';
import 'package:snpit_guild_app/gen/assets.gen.dart';
import 'package:snpit_guild_app/infrastructure/snapit_guild_api/snapit_guild_api.openapi.dart';
import 'package:snpit_guild_app/presentation/providers/api_client/accounts/get_account.dart';
import 'package:snpit_guild_app/presentation/providers/api_client/guilds/get_guild.dart';
import 'package:snpit_guild_app/utils/extensions/uri_extensions.dart';

class GuildPage extends HookConsumerWidget {
  const GuildPage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final myUserId = ref.watch(getMyAccountNotifierProvider).value?.userId;
    final myGuildInfoState = ref.watch(getMyGuildNotifierProvider);

    useEffect(
      () {
        Future.microtask(() async {
          await ref.read(getMyGuildNotifierProvider.notifier).getMyGuild();
        });
        return null;
      },
      [],
    );

    return Scaffold(
      body: RefreshIndicator(
        onRefresh: () async {
          await ref.read(getMyGuildNotifierProvider.notifier).getMyGuild();
        },
        child: myGuildInfoState.when(
          data: (guildInfo) {
            if (guildInfo != null) {
              return _GuildContent(
                guildInfo: guildInfo,
                myUserId: myUserId,
              );
            } else {
              // ã‚®ãƒ«ãƒ‰æƒ…å ±ãŒãªã„å ´åˆ
              return const SingleChildScrollView(
                physics: AlwaysScrollableScrollPhysics(),
                child: Padding(
                  padding: EdgeInsets.symmetric(horizontal: 16),
                  child: _NoGuildWidget(),
                ),
              );
            }
          },
          loading: () => const Center(child: CircularProgressIndicator()),
          error: (error, stackTrace) {
            WidgetsBinding.instance.addPostFrameCallback((_) {
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(content: Text('Error: $error')),
              );
            });
            return SingleChildScrollView(
              physics: const AlwaysScrollableScrollPhysics(),
              child: Center(child: Text('An error occurred: $error')),
            );
          },
        ),
      ),
    );
  }
}

/// ã‚®ãƒ«ãƒ‰æƒ…å ±ãŒã‚ã‚‹å ´åˆã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã¾ã¨ã‚ãŸWidget
class _GuildContent extends StatelessWidget {
  const _GuildContent({
    required this.guildInfo,
    required this.myUserId,
  });

  final GuildDto guildInfo;
  final String? myUserId;

  @override
  Widget build(BuildContext context) {
    final guildId = guildInfo.guildId ?? 'Unknown';
    final guildName = guildInfo.guildName ?? 'Unknown';
    final guildMembersCount = guildInfo.guildMembers?.length ?? 0;
    final isAdminOrOwner = guildInfo.guildMembers?.any(
          (member) =>
              member.userId == myUserId &&
              (member.role == GuildMemberDtoRole.ADMIN ||
                  member.role == GuildMemberDtoRole.OWNER),
        ) ??
        false;

    return DefaultTabController(
      length: 2, // Tabã®æ•°
      child: Column(
        children: [
          Expanded(
            child: NestedScrollView(
              headerSliverBuilder: (context, innerBoxIsScrolled) {
                return [
                  // ã‚®ãƒ«ãƒ‰ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†
                  SliverToBoxAdapter(
                    child: _GuildHeader(
                      guildInfo: guildInfo,
                      guildId: guildId,
                      guildName: guildName,
                      guildMembersCount: guildMembersCount,
                      isAdminOrOwner: isAdminOrOwner,
                    ),
                  ),
                  // ã‚¿ãƒ–éƒ¨åˆ†ï¼ˆå›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰
                  SliverPersistentHeader(
                    pinned: true,
                    delegate: _SliverTabBarDelegate(
                      TabBar(
                        dividerColor: ColorToken.secondary,
                        indicator: UnderlineTabIndicator(
                          borderSide: const BorderSide(
                            color: ColorToken.primary,
                            width: 4,
                          ),
                          insets: EdgeInsets.symmetric(
                            horizontal: MediaQuery.of(context).size.width / 4,
                          ),
                        ),
                        labelColor: ColorToken.text,
                        unselectedLabelColor: ColorToken.secondary,
                        tabs: const [
                          Tab(text: 'Members'),
                          Tab(text: 'Spots'),
                        ],
                      ),
                    ),
                  ),
                ];
              },
              // ã‚¿ãƒ–ãƒ“ãƒ¥ãƒ¼
              body: Padding(
                padding: const EdgeInsets.only(
                  left: 24,
                  right: 24,
                  top: 24,
                ),
                child: TabBarView(
                  children: [
                    // Members Tab
                    _GuildMembersTab(guildInfo: guildInfo),
                    // Spots Tab
                    const Center(child: Text('COMING SOON...')),
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
}

/// ã‚®ãƒ«ãƒ‰ã®ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ï¼ˆã‚®ãƒ«ãƒ‰åã‚„ã‚®ãƒ«ãƒ‰IDãªã©ã®è¡¨ç¤ºï¼‰
class _GuildHeader extends StatelessWidget {
  const _GuildHeader({
    required this.guildInfo,
    required this.guildId,
    required this.guildName,
    required this.guildMembersCount,
    required this.isAdminOrOwner,
  });

  final GuildDto guildInfo;
  final String guildId;
  final String guildName;
  final int guildMembersCount;
  final bool isAdminOrOwner;

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24),
      child: Column(
        children: [
          const SizedBox(height: 24),
          DecoratedBox(
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(8),
              border: Border.all(
                color: ColorToken.secondary,
              ),
            ),
            child: Column(
              children: [
                GestureDetector(
                  onTap: () {
                    Clipboard.setData(
                      ClipboardData(text: guildId),
                    );
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(
                        content: Text('Copied To Clipboard: $guildId'),
                      ),
                    );
                  },
                  child: Container(
                    padding: const EdgeInsets.symmetric(
                      vertical: 12,
                      horizontal: 16,
                    ),
                    decoration: const BoxDecoration(
                      color: ColorToken.secondary,
                      borderRadius: BorderRadius.only(
                        bottomLeft: Radius.circular(12),
                        bottomRight: Radius.circular(12),
                      ),
                    ),
                    child: Row(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        SvgPicture.asset(
                          Assets.images.triangleDots.path,
                        ),
                        const SizedBox(width: 8),
                        Text(
                          guildId,
                          style: const TextStyle(fontSize: 14),
                        ),
                      ],
                    ),
                  ),
                ),
                const SizedBox(height: 20),
                ClipRRect(
                  borderRadius: BorderRadius.circular(8),
                  child: guildInfo.guildAvatar != null
                      ? Image.network(
                          guildInfo.guildAvatar!,
                          width: 64,
                          height: 64,
                          fit: BoxFit.cover,
                        )
                      : Container(
                          width: 64,
                          height: 64,
                          color: ColorToken.bgDark,
                          child: const Icon(
                            Icons.hide_image_outlined,
                            size: 48,
                            color: ColorToken.text,
                          ),
                        ),
                ),
                const SizedBox(height: 16),
                Text(
                  guildName,
                  style: const TextStyle(
                    fontWeight: FontWeight.bold,
                    fontSize: 18,
                  ),
                ),
                const SizedBox(height: 8),
                Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    const Icon(
                      Icons.people,
                      size: 24,
                      color: ColorToken.text,
                    ),
                    const SizedBox(width: 8),
                    Text(
                      '$guildMembersCount',
                      style: const TextStyle(fontSize: 14),
                    ),
                  ],
                ),
                const SizedBox(height: 24),
                const Padding(
                  padding: EdgeInsets.symmetric(horizontal: 16),
                  child: Divider(
                    color: ColorToken.secondary,
                    height: 0,
                  ),
                ),
                const SizedBox(height: 24),
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                  children: [
                    _buildStatColumn('Search', 3879, 'Q'),
                    _buildStatColumn('Attack', 1230, 'E'),
                    _buildStatColumn('Luck', 893, 'L'),
                    _buildStatColumn('Defence', 905, 'B'),
                  ],
                ),
                const SizedBox(height: 24),
              ],
            ),
          ),
          const SizedBox(height: 24),
          // ã‚®ãƒ«ãƒ‰ã®ç®¡ç†è€…ã¾ãŸã¯æ‰€æœ‰è€…ã®å ´åˆã®ã¿ç®¡ç†è€…ç”»é¢ã¸ã®å°Žç·šã‚’è¡¨ç¤º
          if (isAdminOrOwner) ...[
            OutlinedButton(
              onPressed: () {
                context.push(Screen.guildManage.path);
              },
              child: const Stack(
                alignment: Alignment.center,
                children: [
                  Center(
                    child: Text('Manage this guild'),
                  ),
                  Positioned(
                    right: 0,
                    child: Icon(
                      Icons.arrow_forward,
                      size: 24,
                      color: ColorToken.text,
                    ),
                  ),
                ],
              ),
            ),
            const SizedBox(height: 8),
          ],
        ],
      ),
    );
  }

  Widget _buildStatColumn(String title, int value, String subtext) {
    return Column(
      children: [
        Text(
          title,
          style: const TextStyle(fontSize: 13),
        ),
        Text(
          NumberFormat('#,###').format(value),
          style: const TextStyle(
            fontSize: 16,
            color: ColorToken.primary,
          ),
        ),
        Text(
          '($subtext)',
          style: const TextStyle(
            fontSize: 12,
            color: ColorToken.secondary,
          ),
        ),
      ],
    );
  }
}

/// Membersã‚¿ãƒ–ã®ãƒªã‚¹ãƒˆéƒ¨åˆ†
class _GuildMembersTab extends ConsumerWidget {
  const _GuildMembersTab({
    required this.guildInfo,
  });

  final GuildDto guildInfo;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    return RefreshIndicator(
      onRefresh: () async {
        await ref.read(getMyGuildNotifierProvider.notifier).getMyGuild();
      },
      child: ListView.builder(
        itemCount: guildInfo.guildMembers
                ?.where(
                  (member) =>
                      member.memberStatus == GuildMemberDtoMemberStatus.JOINED ||
                      member.memberStatus == GuildMemberDtoMemberStatus.INVITED,
                )
                .length ??
            0,
        itemBuilder: (context, index) {
          final filteredMembers = guildInfo.guildMembers!
              .where(
                (member) =>
                    member.memberStatus == GuildMemberDtoMemberStatus.JOINED ||
                    member.memberStatus == GuildMemberDtoMemberStatus.INVITED,
              )
              .toList();
          final member = filteredMembers[index];
          final userName = member.username ?? 'Unknown';
          final userPhotoUrl = member.avatar;

          return Padding(
            padding: const EdgeInsets.only(bottom: 8),
            child: DecoratedBox(
              decoration: BoxDecoration(
                color: ColorToken.bg,
                borderRadius: BorderRadius.circular(4),
                border: Border.all(
                  color: ColorToken.secondary,
                ),
              ),
              child: Padding(
                padding: const EdgeInsets.all(16),
                child: Row(
                  children: [
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            children: [
                              CircleAvatar(
                                radius: 16,
                                backgroundImage: userPhotoUrl != null
                                    ? NetworkImage(userPhotoUrl)
                                    : AssetImage(
                                        Assets.images.defaultUserProfile.path,
                                      ) as ImageProvider,
                              ),
                              const SizedBox(width: 12),
                              Expanded(
                                child: Text(
                                  userName,
                                  maxLines: 1,
                                  overflow: TextOverflow.ellipsis,
                                  style: const TextStyle(
                                    color: Colors.white,
                                    fontSize: 16,
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                              ),
                            ],
                          ),
                          const SizedBox(height: 10),
                          Row(
                            children: List.generate(
                              4,
                              (badgeIndex) => Padding(
                                padding: const EdgeInsets.only(right: 4),
                                child: ClipRRect(
                                  borderRadius: BorderRadius.circular(4),
                                  child: SizedBox(
                                    width: 28,
                                    height: 28,
                                    child: Image.network(
                                      // é©å®œå¤‰æ›´ã—ã¦ãã ã•ã„
                                      UriExtensions.random.toString(),
                                      fit: BoxFit.cover,
                                    ),
                                  ),
                                ),
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.end,
                        children: [
                          _buildStatRow('Q', 13),
                          _buildStatRow('E', 48),
                          _buildStatRow('L', 7),
                          _buildStatRow('B', 5),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            ),
          );
        },
      ),
    );
  }

  Widget _buildStatRow(String label, int value) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.end,
      children: [
        const SizedBox(width: 40),
        SizedBox(
          width: 20,
          child: Text(
            label,
            style: const TextStyle(
              fontSize: 13,
            ),
          ),
        ),
        const SizedBox(width: 4),
        SizedBox(
          width: 30,
          child: Text(
            NumberFormat('#,###').format(value),
            style: const TextStyle(
              color: ColorToken.primary,
              fontSize: 11,
            ),
          ),
        ),
        const SizedBox(width: 4),
        Expanded(
          child: LinearProgressIndicator(
            value: value / 100, // ä»®ã«100ã‚’æœ€å¤§å€¤ã¨ã—ã¦æ‰±ã†ä¾‹
            borderRadius: BorderRadius.circular(8),
          ),
        ),
      ],
    );
  }
}

/// ã‚®ãƒ«ãƒ‰æœªæ‰€å±žã®å ´åˆã«è¡¨ç¤ºã•ã‚Œã‚‹Widget
class _NoGuildWidget extends StatelessWidget {
  const _NoGuildWidget();

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        const SizedBox(height: 48),
        const Text(
          'No guild affiliation',
          style: TextStyle(
            fontSize: 28,
            fontWeight: FontWeight.bold,
          ),
          textAlign: TextAlign.center,
        ),
        const SizedBox(height: 20),
        const Text(
          'Join a guild or create a new one!',
          style: TextStyle(fontSize: 16),
          textAlign: TextAlign.center,
        ),
        const SizedBox(height: 56),
        Container(
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(8),
            border: Border.all(color: ColorToken.secondary),
          ),
          padding: const EdgeInsets.all(24),
          child: Column(
            children: [
              Image.asset(
                Assets.images.joinGuildFig.path,
              ),
              const SizedBox(height: 24),
              ElevatedButton(
                onPressed: () {
                  context.push(Screen.guildCode.path);
                },
                child: const Stack(
                  alignment: Alignment.center,
                  children: [
                    Center(
                      child: Text('Join an existing guild'),
                    ),
                    Positioned(
                      right: 0,
                      child: Icon(
                        Icons.arrow_forward,
                        size: 24,
                        color: ColorToken.text,
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
        const SizedBox(height: 16),
        Container(
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(8),
            border: Border.all(color: ColorToken.secondary),
          ),
          padding: const EdgeInsets.all(24),
          child: Column(
            children: [
              Image.asset(
                Assets.images.createGuildFig.path,
              ),
              const SizedBox(height: 24),
              ElevatedButton(
                onPressed: () {
                  context.push(Screen.guildCreate.path);
                },
                child: const Stack(
                  alignment: Alignment.center,
                  children: [
                    Center(child: Text('Host a new guild')),
                    Positioned(
                      right: 0,
                      child: Icon(
                        Icons.arrow_forward,
                        size: 24,
                        color: ColorToken.text,
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
        const SizedBox(height: 48),
      ],
    );
  }
}

/// ã‚¿ãƒ–ãƒãƒ¼ã‚’ SliverPersistentHeader ã¨ã—ã¦ä½¿ã†ãŸã‚ã®ãƒ‡ãƒªã‚²ãƒ¼ãƒˆ
class _SliverTabBarDelegate extends SliverPersistentHeaderDelegate {
  _SliverTabBarDelegate(this.tabBar);

  final TabBar tabBar;

  @override
  double get minExtent => tabBar.preferredSize.height;
  @override
  double get maxExtent => tabBar.preferredSize.height;

  @override
  Widget build(
    BuildContext context,
    double shrinkOffset,
    bool overlapsContent,
  ) {
    return ColoredBox(
      color: ColorPallet.gray800,
      child: tabBar,
    );
  }

  @override
  bool shouldRebuild(_SliverTabBarDelegate oldDelegate) {
    return oldDelegate.tabBar != tabBar;
  }
}
```

---

### ãƒã‚¤ãƒ³ãƒˆ

1. **_GuildContent ã¨ã„ã†Widgetã«åˆ‡ã‚Šå‡ºã—**  
   - ã‚®ãƒ«ãƒ‰æƒ…å ±ãŒã‚ã‚‹å ´åˆã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆ`DefaultTabController` ã‚„ `NestedScrollView`ï¼‰ã‚’ã¾ã¨ã‚ã¦ãŠãã“ã¨ã§ã€å…ƒã® `build` ãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’æµ…ãã—ã¦ã„ã¾ã™ã€‚

2. **_GuildHeader ã¨ã„ã†Widgetã«åˆ‡ã‚Šå‡ºã—**  
   - ã‚®ãƒ«ãƒ‰IDã‚„ã‚®ãƒ«ãƒ‰åã€ç”»åƒãªã©ã‚’è¡¨ç¤ºã™ã‚‹éƒ¨åˆ†ã‚’ã•ã‚‰ã«ã¾ã¨ã‚ã‚‹ã“ã¨ã§ã€å†—é•·ã«æ·±ããªã‚ŠãŒã¡ã ã£ãŸColumnã‚„è£…é£¾ã‚³ãƒ¼ãƒ‰ã‚’æ•´ç†ã—ã¾ã—ãŸã€‚

3. **_GuildMembersTab ã¨ã„ã†Widgetã«åˆ‡ã‚Šå‡ºã—**  
   - Membersã‚¿ãƒ–ã«è¡¨ç¤ºã™ã‚‹ListViewãªã©ã‚’ã¾ã¨ã‚ã‚‹ã“ã¨ã§ã€ã“ã“ã‚‚ã‹ãªã‚Šæ·±ã‹ã£ãŸã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’è§£æ¶ˆã§ãã¾ã™ã€‚

4. **_NoGuildWidget ã¯ãã®ã¾ã¾**  
   - å…ƒã€…ç‹¬ç«‹ã—ã¦ã„ã‚‹Widgetãªã®ã§ã€ä»Šå›žç‰¹ã«è§¦ã£ã¦ã„ã¾ã›ã‚“ã€‚å¿…è¦ã§ã‚ã‚Œã°åŒæ§˜ã«ç´°åˆ†åŒ–ã‚‚å¯èƒ½ã§ã™ã€‚

5. **TabBarDelegate ã®å®šç¾©ã¯æœ«å°¾ã«**  
   - ã“ã¡ã‚‰ã¯ã‚¿ãƒ–å›ºå®šã®ãŸã‚ã®ã‚¯ãƒ©ã‚¹ã§ã™ãŒã€åˆ†å‰²ã™ã‚‹ã“ã¨ã§æœ¬ä½“ã‹ã‚‰ã¯ã‚¹ãƒƒã‚­ãƒªåˆ‡ã‚Šé›¢ã—ã¦ã„ã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«ã€**ã€Œ1ç”»é¢ã«å¿…è¦ãªè¦ç´ ã‚’ãƒ­ã‚¸ã‚«ãƒ«ã«åˆ†å‰²ã—ã¤ã¤ã€ç´°ã‹ãåˆ†ã‘ã™ãŽãªã„ã€**ã“ã¨ã‚’å¿ƒãŒã‘ã‚‹ã“ã¨ã§ã€ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã‚„ä¿å®ˆæ€§ã‚’ä¸Šã’ã¤ã¤ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã®æ·±ã•ã‚’è§£æ¶ˆã§ãã¾ã™ã€‚

---
