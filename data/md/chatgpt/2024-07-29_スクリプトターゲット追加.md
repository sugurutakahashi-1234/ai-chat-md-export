# スクリプトターゲット追加

Date: 2024-07-29

---

## 👤 User
*2024-07-29 15:46:37*

このように分けて定義したい。でも追加したい
targets="DependencyInjectionLayer DomainLayer PresentationLayer"
+ targets="DeviceFramework FirebaseFramework LicenseFramework OpenAPIFramework PhoneNumberFramework SpeechToTextFramework"


#!/bin/bash

if [ "$#" -ne 1 ]; then
    echo "Usage: $0 &lt;Root Path&gt;"
    exit 1
fi

mint_package_name="MintCLIPackage"
product_package_name="SmallTalkPackage"
di_scheme="DependencyInjectionLayer"

# UICatalogLayer は DependencyInjectionLayer に依存していないため入れられない
# TODO: 【Periphery】自動的に RootDIContainer から Package名 を抽出するスクリプトを導入する #149
targets="DependencyInjectionLayer DomainLayer PresentationLayer"
targets="DeviceFramework FirebaseFramework LicenseFramework OpenAPIFramework PhoneNumberFramework SpeechToTextFramework"

# 無視する警告メッセージのパターン
ignore_patterns=("Imported module 'DomainLayer' is unused" "Property 'dependency' is assigned, but never used")

root_path=$1
mint_package_path="$root_path/$mint_package_name"
product_package_path="$root_path/$product_package_name"

echo -e "mint_package_path: ${mint_package_path}"
echo -e "product_package_path: ${product_package_path}"

periphery_path="$root_path/periphery"
periphery_build_path="$root_path/build_for_periphery" # periphery/ 配下に build_path を設定 かつ Xcode で参照フォルダにするとなぜかビルドに失敗するので、ルート直下に配置している
output_file="$periphery_path/result.txt"
index_store_path="$periphery_build_path/Index.noindex/DataStore/"

# periphery_build_path が存在する場合、削除する（速度的には遅くなるが scheme を増やしたときに periphery が失敗して、原因究明に時間がかかるので毎回削除するようにしている）
rm -rf "$periphery_build_path"

# periphery を実行すると MacOS でビルドを行うが、アプリ内部で UIKit など、iOS 依存なコードがあるとビルドできないため、一旦 xcodebuild コマンドでプラットフォームを指定して、ビルドする必要がある
# 失敗する場合は periphery/build ディレクトリを削除してから、また、make コマンドを実行してください
xcodebuild -scheme $di_scheme -destination 'platform=iOS Simulator,name=iPhone 15' -derivedDataPath $periphery_build_path clean build

# periphery の仕様なのか、Package.swift が存在するディレクトリを移動しないと SwiftPM マルチモジュール かつ Workspace で構成されるプロジェクトで periphery scan がうまく動いてくれない
cd "${product_package_path}"

# Swift パッケージを指定したパスで実行し、periphery を使用してプロジェクトをスキャン
# --skip-build: ビルドプロセスをスキップ
# --index-store-path: ビルドプロセスをスキップしたので、xcodebuild でビルドしたindex-store-pathの指定
# --retain-swift-ui-previews: SwiftUI のプレビューはそのままにしておく
# --retain-public: 不要な Public 宣言はそのままにしておく
swift run --package-path $mint_package_path mint run periphery scan \
    --skip-build --index-store-path $index_store_path \
    --retain-swift-ui-previews \
    --retain-public \
    --targets $targets \
    | tee $output_file

# 出力に環境依存な root_path がoutputファイルに付与されるため、それを削除する
sed -i '' "s|${root_path}/||g" $output_file

# 無視する警告メッセージを表示し、削除する
for pattern in "${ignore_patterns[@]}"; do
    echo -e "\nLines to be deleted matching pattern: $pattern\n"
    grep "$pattern" $output_file
    sed -i '' "/$pattern/d" $output_file
done

# 毎回完全にclean buildしたいため、削除する、また削除しないと Xcode で検索かけたときに一致する対象が増えてしまうため
rm -rf "$periphery_build_path"

echo -e "\nPeriphery Scan Completed!!!!"

---

## 🤖 Assistant
*2024-07-29 15:46:47*

`targets`の値を一行で追加するのではなく、配列に格納しループで処理するように変更します。また、変数を`$targets`にまとめて参照するように修正します。

```bash
#!/bin/bash

if [ "$#" -ne 1 ]; then
    echo "Usage: $0 &lt;Root Path&gt;"
    exit 1
fi

mint_package_name="MintCLIPackage"
product_package_name="SmallTalkPackage"
di_scheme="DependencyInjectionLayer"

# UICatalogLayer は DependencyInjectionLayer に依存していないため入れられない
# TODO: 【Periphery】自動的に RootDIContainer から Package名 を抽出するスクリプトを導入する #149

# ターゲットを配列にまとめる
targets=(
    "DependencyInjectionLayer"
    "DomainLayer"
    "PresentationLayer"
    "DeviceFramework"
    "FirebaseFramework"
    "LicenseFramework"
    "OpenAPIFramework"
    "PhoneNumberFramework"
    "SpeechToTextFramework"
)

# 無視する警告メッセージのパターン
ignore_patterns=("Imported module 'DomainLayer' is unused"

---
