# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¿½åŠ 

æ—¥ä»˜: 2024-07-29

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/7/29 15:46:37*

ã“ã®ã‚ˆã†ã«åˆ†ã‘ã¦å®šç¾©ã—ãŸã„ã€‚ã§ã‚‚è¿½åŠ ã—ãŸã„
targets="DependencyInjectionLayer DomainLayer PresentationLayer"
+ targets="DeviceFramework FirebaseFramework LicenseFramework OpenAPIFramework PhoneNumberFramework SpeechToTextFramework"


#!/bin/bash

if \[ "$#" -ne 1 \]; then
    echo "Usage: $0 &lt;Root Path&gt;"
    exit 1
fi

mint\_package\_name="MintCLIPackage"
product\_package\_name="SmallTalkPackage"
di\_scheme="DependencyInjectionLayer"

# UICatalogLayer ã¯ DependencyInjectionLayer ã«ä¾å­˜ã—ã¦ã„ãªã„ãŸã‚å…¥ã‚Œã‚‰ã‚Œãªã„
# TODO: ã€Peripheryã€‘è‡ªå‹•çš„ã« RootDIContainer ã‹ã‚‰ Packageå ã‚’æŠ½å‡ºã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å°å…¥ã™ã‚‹ #149
targets="DependencyInjectionLayer DomainLayer PresentationLayer"
targets="DeviceFramework FirebaseFramework LicenseFramework OpenAPIFramework PhoneNumberFramework SpeechToTextFramework"

# ç„¡è¦–ã™ã‚‹è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
ignore\_patterns=("Imported module 'DomainLayer' is unused" "Property 'dependency' is assigned, but never used")

root\_path=$1
mint\_package\_path="$root\_path/$mint\_package\_name"
product\_package\_path="$root\_path/$product\_package\_name"

echo -e "mint\_package\_path: ${mint\_package\_path}"
echo -e "product\_package\_path: ${product\_package\_path}"

periphery\_path="$root\_path/periphery"
periphery\_build\_path="$root\_path/build\_for\_periphery" # periphery/ é…ä¸‹ã« build\_path ã‚’è¨­å®š ã‹ã¤ Xcode ã§å‚ç…§ãƒ•ã‚©ãƒ«ãƒ€ã«ã™ã‚‹ã¨ãªãœã‹ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã™ã‚‹ã®ã§ã€ãƒ«ãƒ¼ãƒˆç›´ä¸‹ã«é…ç½®ã—ã¦ã„ã‚‹
output\_file="$periphery\_path/result.txt"
index\_store\_path="$periphery\_build\_path/Index.noindex/DataStore/"

# periphery\_build\_path ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€å‰Šé™¤ã™ã‚‹ï¼ˆé€Ÿåº¦çš„ã«ã¯é…ããªã‚‹ãŒ scheme ã‚’å¢—ã‚„ã—ãŸã¨ãã« periphery ãŒå¤±æ•—ã—ã¦ã€åŸå› ç©¶æ˜ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã§æ¯å›å‰Šé™¤ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ï¼‰
rm -rf "$periphery\_build\_path"

# periphery ã‚’å®Ÿè¡Œã™ã‚‹ã¨ MacOS ã§ãƒ“ãƒ«ãƒ‰ã‚’è¡Œã†ãŒã€ã‚¢ãƒ—ãƒªå†…éƒ¨ã§ UIKit ãªã©ã€iOS ä¾å­˜ãªã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹ã¨ãƒ“ãƒ«ãƒ‰ã§ããªã„ãŸã‚ã€ä¸€æ—¦ xcodebuild ã‚³ãƒãƒ³ãƒ‰ã§ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’æŒ‡å®šã—ã¦ã€ãƒ“ãƒ«ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
# å¤±æ•—ã™ã‚‹å ´åˆã¯ periphery/build ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰ã€ã¾ãŸã€make ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
xcodebuild -scheme $di\_scheme -destination 'platform=iOS Simulator,name=iPhone 15' -derivedDataPath $periphery\_build\_path clean build

# periphery ã®ä»•æ§˜ãªã®ã‹ã€Package.swift ãŒå­˜åœ¨ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç§»å‹•ã—ãªã„ã¨ SwiftPM ãƒãƒ«ãƒãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« ã‹ã¤ Workspace ã§æ§‹æˆã•ã‚Œã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ periphery scan ãŒã†ã¾ãå‹•ã„ã¦ãã‚Œãªã„
cd "${product\_package\_path}"

# Swift ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æŒ‡å®šã—ãŸãƒ‘ã‚¹ã§å®Ÿè¡Œã—ã€periphery ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¹ã‚­ãƒ£ãƒ³
# --skip-build: ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã‚¹ã‚­ãƒƒãƒ—
# --index-store-path: ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ãŸã®ã§ã€xcodebuild ã§ãƒ“ãƒ«ãƒ‰ã—ãŸindex-store-pathã®æŒ‡å®š
# --retain-swift-ui-previews: SwiftUI ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ãã®ã¾ã¾ã«ã—ã¦ãŠã
# --retain-public: ä¸è¦ãª Public å®£è¨€ã¯ãã®ã¾ã¾ã«ã—ã¦ãŠã
swift run --package-path $mint\_package\_path mint run periphery scan \\
    --skip-build --index-store-path $index\_store\_path \\
    --retain-swift-ui-previews \\
    --retain-public \\
    --targets $targets \\
    | tee $output\_file

# å‡ºåŠ›ã«ç’°å¢ƒä¾å­˜ãª root\_path ãŒoutputãƒ•ã‚¡ã‚¤ãƒ«ã«ä»˜ä¸ã•ã‚Œã‚‹ãŸã‚ã€ãã‚Œã‚’å‰Šé™¤ã™ã‚‹
sed -i '' "s|${root\_path}/||g" $output\_file

# ç„¡è¦–ã™ã‚‹è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã€å‰Šé™¤ã™ã‚‹
for pattern in "${ignore\_patterns\[@\]}"; do
    echo -e "\\nLines to be deleted matching pattern: $pattern\\n"
    grep "$pattern" $output\_file
    sed -i '' "/$pattern/d" $output\_file
done

# æ¯å›å®Œå…¨ã«clean buildã—ãŸã„ãŸã‚ã€å‰Šé™¤ã™ã‚‹ã€ã¾ãŸå‰Šé™¤ã—ãªã„ã¨ Xcode ã§æ¤œç´¢ã‹ã‘ãŸã¨ãã«ä¸€è‡´ã™ã‚‹å¯¾è±¡ãŒå¢—ãˆã¦ã—ã¾ã†ãŸã‚
rm -rf "$periphery\_build\_path"

echo -e "\\nPeriphery Scan Completed!!!!"

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/7/29 15:46:47*

`targets`ã®å€¤ã‚’ä¸€è¡Œã§è¿½åŠ ã™ã‚‹ã®ã§ã¯ãªãã€é…åˆ—ã«æ ¼ç´ã—ãƒ«ãƒ¼ãƒ—ã§å‡¦ç†ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚ã¾ãŸã€å¤‰æ•°ã‚’`$targets`ã«ã¾ã¨ã‚ã¦å‚ç…§ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

```bash
#!/bin/bash

if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <Root Path>"
    exit 1
fi

mint_package_name="MintCLIPackage"
product_package_name="SmallTalkPackage"
di_scheme="DependencyInjectionLayer"

# UICatalogLayer ã¯ DependencyInjectionLayer ã«ä¾å­˜ã—ã¦ã„ãªã„ãŸã‚å…¥ã‚Œã‚‰ã‚Œãªã„
# TODO: ã€Peripheryã€‘è‡ªå‹•çš„ã« RootDIContainer ã‹ã‚‰ Packageå ã‚’æŠ½å‡ºã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å°å…¥ã™ã‚‹ #149

# ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’é…åˆ—ã«ã¾ã¨ã‚ã‚‹
targets=(
    "DependencyInjectionLayer"
    "DomainLayer"
    "PresentationLayer"
    "DeviceFramework"
    "FirebaseFramework"
    "LicenseFramework"
    "OpenAPIFramework"
    "PhoneNumberFramework"
    "SpeechToTextFramework"
)

# ç„¡è¦–ã™ã‚‹è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
ignore_patterns=("Imported module 'DomainLayer' is unused"

---
