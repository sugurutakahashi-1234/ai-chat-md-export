# スクリプトターゲット追加

日付: 2024-07-29

---

## 👤 ユーザー
*2024/7/29 15:46:37*

このように分けて定義したい。でも追加したい
targets="DependencyInjectionLayer DomainLayer PresentationLayer"
+ targets="DeviceFramework FirebaseFramework LicenseFramework OpenAPIFramework PhoneNumberFramework SpeechToTextFramework"


#!/bin/bash

if \[ "$#" -ne 1 \]; then
    echo "Usage: $0 &lt;Root Path&gt;"
    exit 1
fi

mint\_package\_name="MintCLIPackage"
product\_package\_name="SmallTalkPackage"
di\_scheme="DependencyInjectionLayer"

# UICatalogLayer は DependencyInjectionLayer に依存していないため入れられない
# TODO: 【Periphery】自動的に RootDIContainer から Package名 を抽出するスクリプトを導入する #149
targets="DependencyInjectionLayer DomainLayer PresentationLayer"
targets="DeviceFramework FirebaseFramework LicenseFramework OpenAPIFramework PhoneNumberFramework SpeechToTextFramework"

# 無視する警告メッセージのパターン
ignore\_patterns=("Imported module 'DomainLayer' is unused" "Property 'dependency' is assigned, but never used")

root\_path=$1
mint\_package\_path="$root\_path/$mint\_package\_name"
product\_package\_path="$root\_path/$product\_package\_name"

echo -e "mint\_package\_path: ${mint\_package\_path}"
echo -e "product\_package\_path: ${product\_package\_path}"

periphery\_path="$root\_path/periphery"
periphery\_build\_path="$root\_path/build\_for\_periphery" # periphery/ 配下に build\_path を設定 かつ Xcode で参照フォルダにするとなぜかビルドに失敗するので、ルート直下に配置している
output\_file="$periphery\_path/result.txt"
index\_store\_path="$periphery\_build\_path/Index.noindex/DataStore/"

# periphery\_build\_path が存在する場合、削除する（速度的には遅くなるが scheme を増やしたときに periphery が失敗して、原因究明に時間がかかるので毎回削除するようにしている）
rm -rf "$periphery\_build\_path"

# periphery を実行すると MacOS でビルドを行うが、アプリ内部で UIKit など、iOS 依存なコードがあるとビルドできないため、一旦 xcodebuild コマンドでプラットフォームを指定して、ビルドする必要がある
# 失敗する場合は periphery/build ディレクトリを削除してから、また、make コマンドを実行してください
xcodebuild -scheme $di\_scheme -destination 'platform=iOS Simulator,name=iPhone 15' -derivedDataPath $periphery\_build\_path clean build

# periphery の仕様なのか、Package.swift が存在するディレクトリを移動しないと SwiftPM マルチモジュール かつ Workspace で構成されるプロジェクトで periphery scan がうまく動いてくれない
cd "${product\_package\_path}"

# Swift パッケージを指定したパスで実行し、periphery を使用してプロジェクトをスキャン
# --skip-build: ビルドプロセスをスキップ
# --index-store-path: ビルドプロセスをスキップしたので、xcodebuild でビルドしたindex-store-pathの指定
# --retain-swift-ui-previews: SwiftUI のプレビューはそのままにしておく
# --retain-public: 不要な Public 宣言はそのままにしておく
swift run --package-path $mint\_package\_path mint run periphery scan \\
    --skip-build --index-store-path $index\_store\_path \\
    --retain-swift-ui-previews \\
    --retain-public \\
    --targets $targets \\
    | tee $output\_file

# 出力に環境依存な root\_path がoutputファイルに付与されるため、それを削除する
sed -i '' "s|${root\_path}/||g" $output\_file

# 無視する警告メッセージを表示し、削除する
for pattern in "${ignore\_patterns\[@\]}"; do
    echo -e "\\nLines to be deleted matching pattern: $pattern\\n"
    grep "$pattern" $output\_file
    sed -i '' "/$pattern/d" $output\_file
done

# 毎回完全にclean buildしたいため、削除する、また削除しないと Xcode で検索かけたときに一致する対象が増えてしまうため
rm -rf "$periphery\_build\_path"

echo -e "\\nPeriphery Scan Completed!!!!"

---

## 🤖 アシスタント
*2024/7/29 15:46:47*

`targets`の値を一行で追加するのではなく、配列に格納しループで処理するように変更します。また、変数を`$targets`にまとめて参照するように修正します。

```bash
#!/bin/bash

if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <Root Path>"
    exit 1
fi

mint_package_name="MintCLIPackage"
product_package_name="SmallTalkPackage"
di_scheme="DependencyInjectionLayer"

# UICatalogLayer は DependencyInjectionLayer に依存していないため入れられない
# TODO: 【Periphery】自動的に RootDIContainer から Package名 を抽出するスクリプトを導入する #149

# ターゲットを配列にまとめる
targets=(
    "DependencyInjectionLayer"
    "DomainLayer"
    "PresentationLayer"
    "DeviceFramework"
    "FirebaseFramework"
    "LicenseFramework"
    "OpenAPIFramework"
    "PhoneNumberFramework"
    "SpeechToTextFramework"
)

# 無視する警告メッセージのパターン
ignore_patterns=("Imported module 'DomainLayer' is unused"

---
