# æ–‡ç¯€çµæœã®ä¿æŒ

æ—¥ä»˜: 2024-07-29

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/7/29 19:14:43*

ã“ã®å‡¦ç†ãªã‚“ã ã‘ã©é€”ä¸­ã§isFinal = true ã¨ãªã‚‰ãšã«æ–‡ç¯€ã§formattedStringãŒéå»ã®å€¤ã‚’ä¿æŒã—ãªããªã£ã¦ã—ã¾ã£ãŸã‚“ã ã€‚è§£æ±ºæ–¹æ³•ã‚’è€ƒãˆã¦æ¬²ã—ã„

    public func transcribe(audioUrl: URL) async throws -&gt; \[String\] {
        let recognizer = try await getRecognizer()
        let request = SFSpeechURLRecognitionRequest(url: audioUrl)

        return try await withCheckedThrowingContinuation { continuation in
            recognizer.recognitionTask(with: request) { result, error in
                if let error {
                    if error.localizedDescription == "No speech detected" {
                        continuation.resume(throwing: TranscriptionDriverError.noSpeechDetected)
                    } else {
                        continuation.resume(throwing: error)
                    }
                    return
                }

                if let result {
                    if result.isFinal {
                        continuation.resume(returning: \[result.bestTranscription.formattedString\])
                        
                        result.bestTranscription.segments
                    }
                }
            }
        }
    }

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/7/29 19:14:59*

`isFinal`ãŒ`true`ã«ãªã‚‰ãªã„å ´åˆã‚„ã€`formattedString`ãŒéå»ã®å€¤ã‚’ä¿æŒã—ãªã„å•é¡Œã‚’è§£æ±ºã™ã‚‹ã«ã¯ã€æ–‡ç¯€ã”ã¨ã«åé›†ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«ã€æ–‡ç¯€ã®çµæœã‚’é€æ¬¡ä¿å­˜ã™ã‚‹ã‚ˆã†ã«ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```swift
public func transcribe(audioUrl: URL) async throws -> [String] {
    let recognizer = try await getRecognizer()
    let request = SFSpeechURLRecognitionRequest(url: audioUrl)

    return try await withCheckedThrowingContinuation { continuation in
        var transcriptions: [String] = []

        recognizer.recognitionTask(with: request) { result, error in
            if let error {
                if error.localizedDescription == "No speech detected" {
                    continuation.resume(throwing: TranscriptionDriverError.noSpeechDetected)
                } else {
                    continuation.resume(throwing: error)
                }
                return
            }

            if let result {
                // æ–‡ç¯€ã®çµæœã‚’åé›†ã™ã‚‹
                transcriptions.append(result.bestTranscription.formattedString)

                // æœ€çµ‚çµæœã®å ´åˆ
                if result.isFinal {
                    continuation.resume(returning: transcriptions)
                }
            }
        }
    }
}
```

ã“ã®ã‚ˆã†ã«ã€`transcriptions`ã¨ã„ã†é…åˆ—ã‚’ä½¿ã£ã¦æ–‡ç¯€ã”ã¨ã«`formattedString`ã‚’ä¿å­˜ã—ã€`isFinal`ãŒ`true`ã«ãªã£ãŸæ™‚ã«ãã®é…åˆ—ã‚’è¿”ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ä¸­é–“çµæœãŒä¿æŒã•ã‚Œã€æœ€çµ‚çµæœã¨ã—ã¦å…¨ã¦ã®æ–‡ç¯€ãŒè¿”ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

è©¦ã—ã¦ã¿ã¦ã€å•é¡ŒãŒè§£æ±ºã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/7/29 19:17:11*

å…¨æ–‡è¿½åŠ ã—ã¦ã—ã¾ã£ã¦ã„ã‚‹ã€‚ã¤ã¾ã‚Šç¹°ã‚Šè¿”ã—åŒã˜æ–‡ç« ãŒå…¥ã£ã¦ã„ã‚‹

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/7/29 19:17:25*

åŒã˜æ–‡ç« ãŒç¹°ã‚Šè¿”ã—å…¥ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã¯ã€æ¯å›æ–°ã—ã„æ–‡ç¯€ã ã‘ã‚’è¿½åŠ ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«ã€å‰å›ã®æ–‡ç¯€ã‹ã‚‰ã®å·®åˆ†ã‚’è¨ˆç®—ã—ã¦è¿½åŠ ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã§ãã¾ã™ã€‚

```swift
public func transcribe(audioUrl: URL) async throws -> [String] {
    let recognizer = try await getRecognizer()
    let request = SFSpeechURLRecognitionRequest(url: audioUrl)

    return try await withCheckedThrowingContinuation { continuation in
        var transcriptions: [String] = []
        var lastTranscription = ""

        recognizer.recognitionTask(with: request) { result, error in
            if let error {
                if error.localizedDescription == "No speech detected" {
                    continuation.resume(throwing: TranscriptionDriverError.noSpeechDetected)
                } else {
                    continuation.resume(throwing: error)
                }
                return
            }

            if let result {
                // æ–°ã—ã„æ–‡ç¯€ã‚’è¿½åŠ 
                let currentTranscription = result.bestTranscription.formattedString
                let newTranscription = currentTranscription.replacingOccurrences(of: lastTranscription, with: "")
                transcriptions.append(newTranscription)
                lastTranscription = currentTranscription

                // æœ€çµ‚çµæœã®å ´åˆ
                if result.isFinal {
                    continuation.resume(returning: transcriptions)
                }
            }
        }
    }
}
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€`lastTranscription`ã‚’ä½¿ã£ã¦å‰å›ã®æ–‡ç¯€ã‚’ä¿æŒã—ã€`currentTranscription`ã‹ã‚‰ãã®éƒ¨åˆ†ã‚’é™¤ã„ãŸæ–°ã—ã„æ–‡ç¯€ã ã‘ã‚’`transcriptions`ã«è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ç¹°ã‚Šè¿”ã—åŒã˜æ–‡ç« ãŒè¿½åŠ ã•ã‚Œã‚‹ã“ã¨ã‚’é˜²ãã¾ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/7/29 19:17:37*

ã¡ã‚‡ã£ã¨å‡¦ç†ãŒé‡ããªã‚Šãã†ãªã®ã§ã¯ï¼Ÿ

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/7/29 19:17:55*

ç¢ºã‹ã«ã€`replacingOccurrences(of:with:)`ã®ä½¿ç”¨ã¯ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ä»£ã‚ã‚Šã«ã€æ–‡ç¯€ã®é…åˆ—ã‚’ç®¡ç†ã—ã€å„æ–‡ç¯€ãŒè¿½åŠ ã•ã‚Œã‚‹ã¨ãã«ä¸€åº¦ã ã‘é…åˆ—ã«è¿½åŠ ã™ã‚‹æ–¹æ³•ã‚’è€ƒãˆã¾ã—ã‚‡ã†ã€‚

ä»¥ä¸‹ã¯ã€æ–‡ç¯€ã”ã¨ã«è¿½åŠ ã—ã€é‡è¤‡ã‚’é¿ã‘ã‚‹æ–¹æ³•ã§ã™ï¼š

```swift
public func transcribe(audioUrl: URL) async throws -> [String] {
    let recognizer = try await getRecognizer()
    let request = SFSpeechURLRecognitionRequest(url: audioUrl)

    return try await withCheckedThrowingContinuation { continuation in
        var transcriptions: [String] = []

        recognizer.recognitionTask(with: request) { result, error in
            if let error {
                if error.localizedDescription == "No speech detected" {
                    continuation.resume(throwing: TranscriptionDriverError.noSpeechDetected)
                } else {
                    continuation.resume(throwing: error)
                }
                return
            }

            if let result {
                // æ–‡ç¯€ã”ã¨ã«è¿½åŠ 
                let segments = result.bestTranscription.segments.map { $0.substring }
                for segment in segments {
                    if transcriptions.isEmpty || transcriptions.last! != segment {
                        transcriptions.append(segment)
                    }
                }

                // æœ€çµ‚çµæœã®å ´åˆ
                if result.isFinal {
                    continuation.resume(returning: transcriptions)
                }
            }
        }
    }
}
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€`result.bestTranscription.segments`ã‚’ä½¿ç”¨ã—ã¦æ–‡ç¯€ã”ã¨ã«æ–‡å­—åˆ—ã‚’å–å¾—ã—ã€`transcriptions`é…åˆ—ã«è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚æ—¢ã«è¿½åŠ ã•ã‚ŒãŸæ–‡ç¯€ã¨åŒã˜å ´åˆã¯è¿½åŠ ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã“ã¨ã§ã€é‡è¤‡ã‚’é¿ã‘ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å‡¦ç†ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æ”¹å–„ã—ã€åŒã˜æ–‡ç¯€ã®é‡è¤‡ã‚’é˜²ãã“ã¨ãŒã§ãã¾ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/7/29 19:19:46*

ã‚ˆã‚Šé‡è¤‡ãŒã™ã”ããªã£ãŸã€‚é€”ä¸­ã§segmentsãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã¿ãŸã„ã€‚

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/7/29 19:19:59*

segmentsãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã€å‰å›ã®èªè­˜çµæœã‹ã‚‰æ–°ã—ã„æ–‡ç¯€ã‚’è¿½åŠ ã™ã‚‹æ–¹æ³•ã‚’è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

```swift
public func transcribe(audioUrl: URL) async throws -> [String] {
    let recognizer = try await getRecognizer()
    let request = SFSpeechURLRecognitionRequest(url: audioUrl)

    return try await withCheckedThrowingContinuation { continuation in
        var transcriptions: [String] = []
        var lastSegmentIndex = 0

        recognizer.recognitionTask(with: request) { result, error in
            if let error {
                if error.localizedDescription == "No speech detected" {
                    continuation.resume(throwing: TranscriptionDriverError.noSpeechDetected)
                } else {
                    continuation.resume(throwing: error)
                }
                return
            }

            if let result {
                // æ–°ã—ã„æ–‡ç¯€ã‚’è¿½åŠ 
                let segments = result.bestTranscription.segments
                for i in lastSegmentIndex..<segments.count {
                    transcriptions.append(segments[i].substring)
                }
                lastSegmentIndex = segments.count

                // æœ€çµ‚çµæœã®å ´åˆ
                if result.isFinal {
                    continuation.resume(returning: transcriptions)
                }
            }
        }
    }
}
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€å‰å›ã®`segments`ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿½è·¡ã™ã‚‹`lastSegmentIndex`ã‚’å°å…¥ã—ã€æ–°ã—ã„æ–‡ç¯€ã ã‘ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€é€”ä¸­ã§`segments`ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¦ã‚‚ã€é‡è¤‡ãŒç™ºç”Ÿã—ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/7/29 19:21:07*

ã‚ã‹ã£ãŸã€‚æ™®é€šã¯segmentsã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå¢—ãˆã¦ã„ãã‚“ã ã‘ã©ã€æ–‡ç¯€ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã¨ããŒã‚ã‚‹ã‚“ã ã€‚ãã‚Œã‚’æ¤œçŸ¥ã—ã¦ã†ã¾ãformattedStringã‚’appendã—ã¦ã„ã‘ã°ã„ã„ã‚“ã ã€‚

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/7/29 19:21:25*

ãªã‚‹ã»ã©ã€ãã‚Œãªã‚‰æ–‡ç¯€ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹å ´åˆã«å¯¾å¿œã™ã‚‹ãŸã‚ã«ã€`formattedString`ã®å·®åˆ†ã‚’è¿½åŠ ã™ã‚‹æ–¹æ³•ã‚’è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```swift
public func transcribe(audioUrl: URL) async throws -> [String] {
    let recognizer = try await getRecognizer()
    let request = SFSpeechURLRecognitionRequest(url: audioUrl)

    return try await withCheckedThrowingContinuation { continuation in
        var transcriptions: [String] = []
        var lastTranscription = ""

        recognizer.recognitionTask(with: request) { result, error in
            if let error {
                if error.localizedDescription == "No speech detected" {
                    continuation.resume(throwing: TranscriptionDriverError.noSpeechDetected)
                } else {
                    continuation.resume(throwing: error)
                }
                return
            }

            if let result {
                let currentTranscription = result.bestTranscription.formattedString
                if currentTranscription != lastTranscription {
                    let newTranscription = currentTranscription.replacingOccurrences(of: lastTranscription, with: "")
                    if !newTranscription.isEmpty {
                        transcriptions.append(newTranscription)
                    }
                    lastTranscription = currentTranscription
                }

                if result.isFinal {
                    continuation.resume(returning: transcriptions)
                }
            }
        }
    }
}
```

ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã¯ã€`lastTranscription`ã¨`currentTranscription`ã‚’æ¯”è¼ƒã—ã€å·®åˆ†ã‚’å–å¾—ã—ã¦`transcriptions`ã«è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ–‡ç¯€ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¦ã‚‚æ­£ç¢ºã«å·®åˆ†ã‚’å–å¾—ã—ã¦ä¿å­˜ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

---
