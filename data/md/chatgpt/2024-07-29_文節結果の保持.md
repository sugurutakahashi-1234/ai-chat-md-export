# ÊñáÁØÄÁµêÊûú„ÅÆ‰øùÊåÅ

Êó•‰ªò: 2024-07-29

---

## üë§ „É¶„Éº„Ç∂„Éº
*2024/7/29 19:14:43*

„Åì„ÅÆÂá¶ÁêÜ„Å™„Çì„Å†„Åë„Å©ÈÄî‰∏≠„ÅßisFinal = true „Å®„Å™„Çâ„Åö„Å´ÊñáÁØÄ„ÅßformattedString„ÅåÈÅéÂéª„ÅÆÂÄ§„Çí‰øùÊåÅ„Åó„Å™„Åè„Å™„Å£„Å¶„Åó„Åæ„Å£„Åü„Çì„Å†„ÄÇËß£Ê±∫ÊñπÊ≥ï„ÇíËÄÉ„Åà„Å¶Ê¨≤„Åó„ÅÑ

    public func transcribe(audioUrl: URL) async throws -&gt; \[String\] {
        let recognizer = try await getRecognizer()
        let request = SFSpeechURLRecognitionRequest(url: audioUrl)

        return try await withCheckedThrowingContinuation { continuation in
            recognizer.recognitionTask(with: request) { result, error in
                if let error {
                    if error.localizedDescription == "No speech detected" {
                        continuation.resume(throwing: TranscriptionDriverError.noSpeechDetected)
                    } else {
                        continuation.resume(throwing: error)
                    }
                    return
                }

                if let result {
                    if result.isFinal {
                        continuation.resume(returning: \[result.bestTranscription.formattedString\])
                        
                        result.bestTranscription.segments
                    }
                }
            }
        }
    }

---

## ü§ñ „Ç¢„Ç∑„Çπ„Çø„É≥„Éà
*2024/7/29 19:14:59*

`isFinal`„Åå`true`„Å´„Å™„Çâ„Å™„ÅÑÂ†¥Âêà„ÇÑ„ÄÅ`formattedString`„ÅåÈÅéÂéª„ÅÆÂÄ§„Çí‰øùÊåÅ„Åó„Å™„ÅÑÂïèÈ°å„ÇíËß£Ê±∫„Åô„Çã„Å´„ÅØ„ÄÅÊñáÁØÄ„Åî„Å®„Å´ÂèéÈõÜ„Åô„Çã„É≠„Ç∏„ÉÉ„ÇØ„ÇíËøΩÂä†„Åô„Çã„Åì„Å®„ÅåËÄÉ„Åà„Çâ„Çå„Åæ„Åô„ÄÇ‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å´„ÄÅÊñáÁØÄ„ÅÆÁµêÊûú„ÇíÈÄêÊ¨°‰øùÂ≠ò„Åô„Çã„Çà„ÅÜ„Å´„Ç≥„Éº„Éâ„ÇíÂ§âÊõ¥„Åô„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ

```swift
public func transcribe(audioUrl: URL) async throws -> [String] {
    let recognizer = try await getRecognizer()
    let request = SFSpeechURLRecognitionRequest(url: audioUrl)

    return try await withCheckedThrowingContinuation { continuation in
        var transcriptions: [String] = []

        recognizer.recognitionTask(with: request) { result, error in
            if let error {
                if error.localizedDescription == "No speech detected" {
                    continuation.resume(throwing: TranscriptionDriverError.noSpeechDetected)
                } else {
                    continuation.resume(throwing: error)
                }
                return
            }

            if let result {
                // ÊñáÁØÄ„ÅÆÁµêÊûú„ÇíÂèéÈõÜ„Åô„Çã
                transcriptions.append(result.bestTranscription.formattedString)

                // ÊúÄÁµÇÁµêÊûú„ÅÆÂ†¥Âêà
                if result.isFinal {
                    continuation.resume(returning: transcriptions)
                }
            }
        }
    }
}
```

„Åì„ÅÆ„Çà„ÅÜ„Å´„ÄÅ`transcriptions`„Å®„ÅÑ„ÅÜÈÖçÂàó„Çí‰Ωø„Å£„Å¶ÊñáÁØÄ„Åî„Å®„Å´`formattedString`„Çí‰øùÂ≠ò„Åó„ÄÅ`isFinal`„Åå`true`„Å´„Å™„Å£„ÅüÊôÇ„Å´„Åù„ÅÆÈÖçÂàó„ÇíËøî„Åô„Çà„ÅÜ„Å´„Åó„Åæ„Åô„ÄÇ„Åì„Çå„Å´„Çà„Çä„ÄÅ‰∏≠ÈñìÁµêÊûú„Åå‰øùÊåÅ„Åï„Çå„ÄÅÊúÄÁµÇÁµêÊûú„Å®„Åó„Å¶ÂÖ®„Å¶„ÅÆÊñáÁØÄ„ÅåËøî„Åï„Çå„Çã„Çà„ÅÜ„Å´„Å™„Çä„Åæ„Åô„ÄÇ

Ë©¶„Åó„Å¶„Åø„Å¶„ÄÅÂïèÈ°å„ÅåËß£Ê±∫„Åô„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

---

## üë§ „É¶„Éº„Ç∂„Éº
*2024/7/29 19:17:11*

ÂÖ®ÊñáËøΩÂä†„Åó„Å¶„Åó„Åæ„Å£„Å¶„ÅÑ„Çã„ÄÇ„Å§„Åæ„ÇäÁπ∞„ÇäËøî„ÅóÂêå„ÅòÊñáÁ´†„ÅåÂÖ•„Å£„Å¶„ÅÑ„Çã

---

## ü§ñ „Ç¢„Ç∑„Çπ„Çø„É≥„Éà
*2024/7/29 19:17:25*

Âêå„ÅòÊñáÁ´†„ÅåÁπ∞„ÇäËøî„ÅóÂÖ•„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã„Åü„ÇÅ„Å´„ÅØ„ÄÅÊØéÂõûÊñ∞„Åó„ÅÑÊñáÁØÄ„Å†„Åë„ÇíËøΩÂä†„Åô„Çã„Çà„ÅÜ„Å´„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å´„ÄÅÂâçÂõû„ÅÆÊñáÁØÄ„Åã„Çâ„ÅÆÂ∑ÆÂàÜ„ÇíË®àÁÆó„Åó„Å¶ËøΩÂä†„Åô„Çã„Çà„ÅÜ„Å´Â§âÊõ¥„Åß„Åç„Åæ„Åô„ÄÇ

```swift
public func transcribe(audioUrl: URL) async throws -> [String] {
    let recognizer = try await getRecognizer()
    let request = SFSpeechURLRecognitionRequest(url: audioUrl)

    return try await withCheckedThrowingContinuation { continuation in
        var transcriptions: [String] = []
        var lastTranscription = ""

        recognizer.recognitionTask(with: request) { result, error in
            if let error {
                if error.localizedDescription == "No speech detected" {
                    continuation.resume(throwing: TranscriptionDriverError.noSpeechDetected)
                } else {
                    continuation.resume(throwing: error)
                }
                return
            }

            if let result {
                // Êñ∞„Åó„ÅÑÊñáÁØÄ„ÇíËøΩÂä†
                let currentTranscription = result.bestTranscription.formattedString
                let newTranscription = currentTranscription.replacingOccurrences(of: lastTranscription, with: "")
                transcriptions.append(newTranscription)
                lastTranscription = currentTranscription

                // ÊúÄÁµÇÁµêÊûú„ÅÆÂ†¥Âêà
                if result.isFinal {
                    continuation.resume(returning: transcriptions)
                }
            }
        }
    }
}
```

„Åì„ÅÆ„Ç≥„Éº„Éâ„Åß„ÅØ„ÄÅ`lastTranscription`„Çí‰Ωø„Å£„Å¶ÂâçÂõû„ÅÆÊñáÁØÄ„Çí‰øùÊåÅ„Åó„ÄÅ`currentTranscription`„Åã„Çâ„Åù„ÅÆÈÉ®ÂàÜ„ÇíÈô§„ÅÑ„ÅüÊñ∞„Åó„ÅÑÊñáÁØÄ„Å†„Åë„Çí`transcriptions`„Å´ËøΩÂä†„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Åì„Çå„Å´„Çà„Çä„ÄÅÁπ∞„ÇäËøî„ÅóÂêå„ÅòÊñáÁ´†„ÅåËøΩÂä†„Åï„Çå„Çã„Åì„Å®„ÇíÈò≤„Åé„Åæ„Åô„ÄÇ

---

## üë§ „É¶„Éº„Ç∂„Éº
*2024/7/29 19:17:37*

„Å°„Çá„Å£„Å®Âá¶ÁêÜ„ÅåÈáç„Åè„Å™„Çä„Åù„ÅÜ„Å™„ÅÆ„Åß„ÅØÔºü

---

## ü§ñ „Ç¢„Ç∑„Çπ„Çø„É≥„Éà
*2024/7/29 19:17:55*

Á¢∫„Åã„Å´„ÄÅ`replacingOccurrences(of:with:)`„ÅÆ‰ΩøÁî®„ÅØ„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Å´ÂΩ±Èüø„Çí‰∏é„Åà„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ‰ª£„Çè„Çä„Å´„ÄÅÊñáÁØÄ„ÅÆÈÖçÂàó„ÇíÁÆ°ÁêÜ„Åó„ÄÅÂêÑÊñáÁØÄ„ÅåËøΩÂä†„Åï„Çå„Çã„Å®„Åç„Å´‰∏ÄÂ∫¶„Å†„ÅëÈÖçÂàó„Å´ËøΩÂä†„Åô„ÇãÊñπÊ≥ï„ÇíËÄÉ„Åà„Åæ„Åó„Çá„ÅÜ„ÄÇ

‰ª•‰∏ã„ÅØ„ÄÅÊñáÁØÄ„Åî„Å®„Å´ËøΩÂä†„Åó„ÄÅÈáçË§á„ÇíÈÅø„Åë„ÇãÊñπÊ≥ï„Åß„ÅôÔºö

```swift
public func transcribe(audioUrl: URL) async throws -> [String] {
    let recognizer = try await getRecognizer()
    let request = SFSpeechURLRecognitionRequest(url: audioUrl)

    return try await withCheckedThrowingContinuation { continuation in
        var transcriptions: [String] = []

        recognizer.recognitionTask(with: request) { result, error in
            if let error {
                if error.localizedDescription == "No speech detected" {
                    continuation.resume(throwing: TranscriptionDriverError.noSpeechDetected)
                } else {
                    continuation.resume(throwing: error)
                }
                return
            }

            if let result {
                // ÊñáÁØÄ„Åî„Å®„Å´ËøΩÂä†
                let segments = result.bestTranscription.segments.map { $0.substring }
                for segment in segments {
                    if transcriptions.isEmpty || transcriptions.last! != segment {
                        transcriptions.append(segment)
                    }
                }

                // ÊúÄÁµÇÁµêÊûú„ÅÆÂ†¥Âêà
                if result.isFinal {
                    continuation.resume(returning: transcriptions)
                }
            }
        }
    }
}
```

„Åì„ÅÆ„Ç≥„Éº„Éâ„Åß„ÅØ„ÄÅ`result.bestTranscription.segments`„Çí‰ΩøÁî®„Åó„Å¶ÊñáÁØÄ„Åî„Å®„Å´ÊñáÂ≠óÂàó„ÇíÂèñÂæó„Åó„ÄÅ`transcriptions`ÈÖçÂàó„Å´ËøΩÂä†„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÊó¢„Å´ËøΩÂä†„Åï„Çå„ÅüÊñáÁØÄ„Å®Âêå„ÅòÂ†¥Âêà„ÅØËøΩÂä†„Çí„Çπ„Ç≠„ÉÉ„Éó„Åô„Çã„Åì„Å®„Åß„ÄÅÈáçË§á„ÇíÈÅø„Åë„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Åì„Çå„Å´„Çà„Çä„ÄÅÂá¶ÁêÜ„ÅÆ„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÇíÊîπÂñÑ„Åó„ÄÅÂêå„ÅòÊñáÁØÄ„ÅÆÈáçË§á„ÇíÈò≤„Åê„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ

---

## üë§ „É¶„Éº„Ç∂„Éº
*2024/7/29 19:19:46*

„Çà„ÇäÈáçË§á„Åå„Åô„Åî„Åè„Å™„Å£„Åü„ÄÇÈÄî‰∏≠„Åßsegments„Åå„É™„Çª„ÉÉ„Éà„Åï„Çå„Çã„Åø„Åü„ÅÑ„ÄÇ

---

## ü§ñ „Ç¢„Ç∑„Çπ„Çø„É≥„Éà
*2024/7/29 19:19:59*

segments„Åå„É™„Çª„ÉÉ„Éà„Åï„Çå„ÇãÂïèÈ°å„ÇíËß£Ê±∫„Åô„Çã„Åü„ÇÅ„Å´„ÄÅ‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å´„ÄÅÂâçÂõû„ÅÆË™çË≠òÁµêÊûú„Åã„ÇâÊñ∞„Åó„ÅÑÊñáÁØÄ„ÇíËøΩÂä†„Åô„ÇãÊñπÊ≥ï„ÇíË©¶„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

```swift
public func transcribe(audioUrl: URL) async throws -> [String] {
    let recognizer = try await getRecognizer()
    let request = SFSpeechURLRecognitionRequest(url: audioUrl)

    return try await withCheckedThrowingContinuation { continuation in
        var transcriptions: [String] = []
        var lastSegmentIndex = 0

        recognizer.recognitionTask(with: request) { result, error in
            if let error {
                if error.localizedDescription == "No speech detected" {
                    continuation.resume(throwing: TranscriptionDriverError.noSpeechDetected)
                } else {
                    continuation.resume(throwing: error)
                }
                return
            }

            if let result {
                // Êñ∞„Åó„ÅÑÊñáÁØÄ„ÇíËøΩÂä†
                let segments = result.bestTranscription.segments
                for i in lastSegmentIndex..<segments.count {
                    transcriptions.append(segments[i].substring)
                }
                lastSegmentIndex = segments.count

                // ÊúÄÁµÇÁµêÊûú„ÅÆÂ†¥Âêà
                if result.isFinal {
                    continuation.resume(returning: transcriptions)
                }
            }
        }
    }
}
```

„Åì„ÅÆ„Ç≥„Éº„Éâ„Åß„ÅØ„ÄÅÂâçÂõû„ÅÆ`segments`„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíËøΩË∑°„Åô„Çã`lastSegmentIndex`„ÇíÂ∞éÂÖ•„Åó„ÄÅÊñ∞„Åó„ÅÑÊñáÁØÄ„Å†„Åë„ÇíËøΩÂä†„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Åì„Çå„Å´„Çà„Çä„ÄÅÈÄî‰∏≠„Åß`segments`„Åå„É™„Çª„ÉÉ„Éà„Åï„Çå„Å¶„ÇÇ„ÄÅÈáçË§á„ÅåÁô∫Áîü„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´„Åó„Åæ„Åô„ÄÇ

---

## üë§ „É¶„Éº„Ç∂„Éº
*2024/7/29 19:21:07*

„Çè„Åã„Å£„Åü„ÄÇÊôÆÈÄö„ÅØsegments„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÅåÂ¢ó„Åà„Å¶„ÅÑ„Åè„Çì„Å†„Åë„Å©„ÄÅÊñáÁØÄ„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„Åß„É™„Çª„ÉÉ„Éà„Åï„Çå„Çã„Å®„Åç„Åå„ÅÇ„Çã„Çì„Å†„ÄÇ„Åù„Çå„ÇíÊ§úÁü•„Åó„Å¶„ÅÜ„Åæ„ÅèformattedString„Çíappend„Åó„Å¶„ÅÑ„Åë„Å∞„ÅÑ„ÅÑ„Çì„Å†„ÄÇ

---

## ü§ñ „Ç¢„Ç∑„Çπ„Çø„É≥„Éà
*2024/7/29 19:21:25*

„Å™„Çã„Åª„Å©„ÄÅ„Åù„Çå„Å™„ÇâÊñáÁØÄ„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„Åß„É™„Çª„ÉÉ„Éà„Åï„Çå„ÇãÂ†¥Âêà„Å´ÂØæÂøú„Åô„Çã„Åü„ÇÅ„Å´„ÄÅ`formattedString`„ÅÆÂ∑ÆÂàÜ„ÇíËøΩÂä†„Åô„ÇãÊñπÊ≥ï„ÇíË©¶„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ

```swift
public func transcribe(audioUrl: URL) async throws -> [String] {
    let recognizer = try await getRecognizer()
    let request = SFSpeechURLRecognitionRequest(url: audioUrl)

    return try await withCheckedThrowingContinuation { continuation in
        var transcriptions: [String] = []
        var lastTranscription = ""

        recognizer.recognitionTask(with: request) { result, error in
            if let error {
                if error.localizedDescription == "No speech detected" {
                    continuation.resume(throwing: TranscriptionDriverError.noSpeechDetected)
                } else {
                    continuation.resume(throwing: error)
                }
                return
            }

            if let result {
                let currentTranscription = result.bestTranscription.formattedString
                if currentTranscription != lastTranscription {
                    let newTranscription = currentTranscription.replacingOccurrences(of: lastTranscription, with: "")
                    if !newTranscription.isEmpty {
                        transcriptions.append(newTranscription)
                    }
                    lastTranscription = currentTranscription
                }

                if result.isFinal {
                    continuation.resume(returning: transcriptions)
                }
            }
        }
    }
}
```

„Åì„ÅÆ„Ç¢„Éó„É≠„Éº„ÉÅ„Åß„ÅØ„ÄÅ`lastTranscription`„Å®`currentTranscription`„ÇíÊØîËºÉ„Åó„ÄÅÂ∑ÆÂàÜ„ÇíÂèñÂæó„Åó„Å¶`transcriptions`„Å´ËøΩÂä†„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Åì„Çå„Å´„Çà„Çä„ÄÅÊñáÁØÄ„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„Åß„É™„Çª„ÉÉ„Éà„Åï„Çå„Å¶„ÇÇÊ≠£Á¢∫„Å´Â∑ÆÂàÜ„ÇíÂèñÂæó„Åó„Å¶‰øùÂ≠ò„Åô„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ

---
