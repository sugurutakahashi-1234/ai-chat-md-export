# ビルド番号修正方法

Date: 2025-02-21

---

## 👤 User
*2025-02-21 15:18:11*

flutterでビルド番号が自動で振られているのだけれども、0.0.01や0.0.02のように01や02のように0始まりの番号が含まれている。これはセマンティックバージョニングとして正しくないので、0.0.1や0.0.2、や0.0.10や0.0.123のようになるように修正してほしい。 
以下はおそらく番号を決めている処理になっている

name: 'Prepare to build snpit app'
description: 'Prepare to build snpit app'
inputs:
  build_name:
    description: 'build name'
    required: true
    default: ''
  build_target:
    description: 'build target'
    required: true
    default: 'dev'

runs:
  using: "composite"
  steps:
    - name: Setup env
      run: |
        INPUT_BUILD_NAME="${{ inputs.build_name }}"
        INPUT_BUILD_TARGET="${{ inputs.build_target }}"
        
        echo "BUILD_NAME=${INPUT_BUILD_NAME:-0.0.01}" &gt;&gt; $GITHUB_ENV
        echo "BUILD_TARGET=${INPUT_BUILD_TARGET:-dev}" &gt;&gt; $GITHUB_ENV

        # Check if the version name matches the x.x.xx pattern
        # Until it reaches the format xx.x.xx, only the x.x.xx format is accepted
        if [[ ! "${INPUT_BUILD_NAME}" =~ ^[0-9]+\.[0-9]+\.[0-9]{2}$ ]]; then
            echo "Error: Invalid build name pattern. Please use the x.x.xx format." &gt;&2
            exit 1
        fi
        
        VERSION_CODE=$(echo "${INPUT_BUILD_NAME:-0.0.01}" | tr -d . | sed 's/^0*//')
        echo "BUILD_NUMBER=${VERSION_CODE}" &gt;&gt; $GITHUB_ENV
      shell: bash

    - name: Generate .env
      run: |
        echo "FLAVOR=${BUILD_TARGET}" &gt;&gt; .env
        echo ".env file generated"
        cat .env
      shell: bash



name: Flutter Build Dev

on:
  workflow_run:
    branches:
      - main
    workflows:
      - Flutter CI
    types:
      - completed
  workflow_dispatch:

jobs:
  build_ios:
    env:
      BUILD_TARGET: dev
    name: Build for iOS
    runs-on: macos-latest
    timeout-minutes: 30
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 15.4
      - name: Display Xcode Version
        run: xcodebuild -version

      - name: Calculate build name
        id: calc_build_name
        run: |
          major=$(($GITHUB_RUN_NUMBER / 1000))
          minor=$(($GITHUB_RUN_NUMBER % 1000 / 100))
          patch=$(($GITHUB_RUN_NUMBER % 100))
          # Ensure that patch number is at least two digits
          printf -v patch_formatted "%02d" $patch
          echo "BUILD_NAME=$major.$minor.$patch_formatted" &gt;&gt; $GITHUB_ENV

      - uses: ./.github/actions/prepare_build
        with:
          build_name: ${{ env.BUILD_NAME }}
          build_target: ${BUILD_TARGET}

      - uses: ./.github/actions/setup_flutter
        with:
          ssh_key: ${{ secrets.SSH_KEY }}
          known_hosts: ${{ secrets.KNOWN_HOSTS }}

      - name: Import Provisioning Profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo -n "${{ secrets.PROVISIONING_PROFILE_DEV }}" | base64 -d &gt; ~/Library/MobileDevice/Provisioning\ Profiles/distribution.mobileprovision

      - name: Import Code-Signing Certificates
        uses: Apple-Actions/import-codesign-certs@v1
        with:
          p12-file-base64: ${{ secrets.CERTIFICATES_P12 }}
          p12-password: ${{ secrets.CERTIFICATE_PASSWORD }}

      #      - name: Create secrets
      #        run: echo -n ${{ secrets.IOS_SECRETS }} | base64 -d &gt; Automation/secrets/google_maps_api_key

      - name: Create ipa file
        run: |
          flutter build ipa --release \
            --export-options-plist=ExportOptions.${BUILD_TARGET}.plist \
            --flavor ${BUILD_TARGET} \
            --build-name ${BUILD_NAME} \
            --build-number ${BUILD_NUMBER} \
            --obfuscate \
            --split-debug-info=obfuscate/ios

      - name: List IPA directory contents
        run: ls -la ./build/ios/ipa

      - name: Upload to AppStoreConnect
        run: xcrun altool --upload-app -f "./build/ios/ipa/snpit_guild_app.ipa" -t ios -u "${{ secrets.APPLE_ID }}" -p "${{ secrets.APPLE_APP_PASS }}"

      - name: Notify Slack
        uses: ./.github/actions/deploy_notifier
        if: always()
        with:
          os_name: 'iOS'
          branch: ${{ github.ref_name }}
          job_status: ${{ job.status == 'success' && 'success' || 'failure' }}
          slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL_DEV }}

  build_android:
    env:
      BUILD_TARGET: dev
    name: Build for android
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Calculate build name
        id: calc_build_name
        run: |
          major=$(($GITHUB_RUN_NUMBER / 1000))
          minor=$(($GITHUB_RUN_NUMBER % 1000 / 100))
          patch=$(($GITHUB_RUN_NUMBER % 100))
          # Ensure that patch number is at least two digits
          printf -v patch_formatted "%02d" $patch
          echo "BUILD_NAME=$major.$minor.$patch_formatted" &gt;&gt; $GITHUB_ENV

      - uses: ./.github/actions/prepare_build
        with:
          build_name: ${{ env.BUILD_NAME }}
          build_target: ${BUILD_TARGET}

      - uses: ./.github/actions/setup_flutter
        with:
          ssh_key: ${{ secrets.SSH_KEY }}
          known_hosts: ${{ secrets.KNOWN_HOSTS }}

      - name: Create app/key.jks
        run: echo -n ${{ secrets.ANDROID_KEY_JKS_DEV }} | base64 -d &gt; android/app/key.jks

      - name: Create service-account-key.json
        run: echo -n ${{ secrets.SERVICE_ACCOUNT_KEY_JSON }} | base64 -d &gt; android/service-account-key.json

      - name: Create keystore.properties
        run: |
          echo 'storeFile=key.jks' &gt; android/keystore.properties
          echo 'serviceAccountFile=service-account-key.json' &gt;&gt; android/keystore.properties
          echo 'storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}' &gt;&gt; android/keystore.properties
          echo 'keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}' &gt;&gt; android/keystore.properties
          echo 'keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}' &gt;&gt; android/keystore.properties

      #      - name: Create secrets google maps
      #        run: echo -n ${{ secrets.ANDROID_SECRETS }} | base64 -d &gt; android/app/src/main/res/values/secrets.xml

      - name: Building Android AppBundle
        run: |
          flutter build appbundle --release \
            --flavor ${BUILD_TARGET} \
            --build-name ${BUILD_NAME} \
            --build-number ${BUILD_NUMBER} \
            --obfuscate \
            --split-debug-info=obfuscate/android

#      - name: AppBundle as artifact
#        uses: actions/upload-artifact@v2
#        with:
#          name: android-appbundle
#          path: build/app/outputs/bundle/devRelease/app-dev-release.aab

      - name: Upload to GooglePlayStore
        id: android_upload
        run: ./gradlew publishDevReleaseBundle
        working-directory: ./android

      - name: Notify Slack
        uses: ./.github/actions/deploy_notifier
        if: always()
        with:
          os_name: 'Android'
          branch: ${{ github.ref_name }}
          job_status: ${{ job.status == 'success' && 'success' || 'failure' }}
          slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL_DEV }}


name: Flutter Build Prod

on:
  workflow_run:
    branches:
      - main
    workflows:
      - Flutter CI
    types:
      - completed
  workflow_dispatch:

jobs:
  build_ios:
    env:
      BUILD_TARGET: prod
    name: Build for iOS
    runs-on: macos-latest
    timeout-minutes: 30
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 15.4
      - name: Display Xcode Version
        run: xcodebuild -version

      - name: Calculate build name
        id: calc_build_name
        run: |
          major=$(($GITHUB_RUN_NUMBER / 1000))
          minor=$(($GITHUB_RUN_NUMBER % 1000 / 100))
          patch=$(($GITHUB_RUN_NUMBER % 100))
          # Ensure that patch number is at least two digits
          printf -v patch_formatted "%02d" $patch
          echo "BUILD_NAME=$major.$minor.$patch_formatted" &gt;&gt; $GITHUB_ENV

      - uses: ./.github/actions/prepare_build
        with:
          build_name: ${{ env.BUILD_NAME }}
          build_target: ${BUILD_TARGET}

      - uses: ./.github/actions/setup_flutter
        with:
          ssh_key: ${{ secrets.SSH_KEY }}
          known_hosts: ${{ secrets.KNOWN_HOSTS }}

      - name: Import Provisioning Profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo -n ${{ secrets.PROVISIONING_PROFILE }} | base64 -d &gt; ~/Library/MobileDevice/Provisioning\ Profiles/distribution.mobileprovision

      - name: Import Code-Signing Certificates
        uses: Apple-Actions/import-codesign-certs@v1
        with:
          p12-file-base64: ${{ secrets.CERTIFICATES_P12 }}
          p12-password: ${{ secrets.CERTIFICATE_PASSWORD }}

      #      - name: Create secrets
      #        run: echo -n ${{ secrets.IOS_SECRETS }} | base64 -d &gt; Automation/secrets/google_maps_api_key

      - name: Create ipa file
        run: |
          flutter build ipa --release \
            --export-options-plist=ExportOptions.${BUILD_TARGET}.plist \
            --flavor ${BUILD_TARGET} \
            --build-name ${BUILD_NAME} \
            --build-number ${BUILD_NUMBER} \
            --obfuscate \
            --split-debug-info=obfuscate/ios

      - name: List IPA directory contents
        run: ls -la ./build/ios/ipa

      - name: Upload to AppStoreConnect
        run: xcrun altool --upload-app -f "./build/ios/ipa/snpit_guild_app.ipa" -t ios -u "${{ secrets.APPLE_ID }}" -p "${{ secrets.APPLE_APP_PASS }}"

      - name: Notify Slack
        uses: ./.github/actions/deploy_notifier
        if: always()
        with:
          os_name: 'iOS'
          branch: ${{ github.ref_name }}
          job_status: ${{ job.status == 'success' && 'success' || 'failure' }}
          slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

  build_android:
    env:
      BUILD_TARGET: prod
    name: Build for android
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Calculate build name
        id: calc_build_name
        run: |
          major=$(($GITHUB_RUN_NUMBER / 1000))
          minor=$(($GITHUB_RUN_NUMBER % 1000 / 100))
          patch=$(($GITHUB_RUN_NUMBER % 100))
          # Ensure that patch number is at least two digits
          printf -v patch_formatted "%02d" $patch
          echo "BUILD_NAME=$major.$minor.$patch_formatted" &gt;&gt; $GITHUB_ENV

      - uses: ./.github/actions/prepare_build
        with:
          build_name: ${{ env.BUILD_NAME }}
          build_target: ${BUILD_TARGET}

      - uses: ./.github/actions/setup_flutter
        with:
          ssh_key: ${{ secrets.SSH_KEY }}
          known_hosts: ${{ secrets.KNOWN_HOSTS }}

      - name: Create app/key.jks
        run: echo -n ${{ secrets.ANDROID_KEY_JKS }} | base64 -d &gt; android/app/key.jks

      - name: Create service-account-key.json
        run: echo -n ${{ secrets.SERVICE_ACCOUNT_KEY_JSON }} | base64 -d &gt; android/service-account-key.json

      - name: Create keystore.properties
        run: |
          echo 'storeFile=key.jks' &gt; android/keystore.properties
          echo 'serviceAccountFile=service-account-key.json' &gt;&gt; android/keystore.properties
          echo 'storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}' &gt;&gt; android/keystore.properties
          echo 'keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}' &gt;&gt; android/keystore.properties
          echo 'keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}' &gt;&gt; android/keystore.properties

      #      - name: Create secrets google maps
      #        run: echo -n ${{ secrets.ANDROID_SECRETS }} | base64 -d &gt; android/app/src/main/res/values/secrets.xml

      - name: Building Android AppBundle
        run: |
          flutter build appbundle --release \
            --flavor ${BUILD_TARGET} \
            --build-name ${BUILD_NAME} \
            --build-number ${BUILD_NUMBER} \
            --obfuscate \
            --split-debug-info=obfuscate/android

#      - name: AppBundle as artifact
#        uses: actions/upload-artifact@v2
#        with:
#          name: android-appbundle
#          path: build/app/outputs/bundle/prodRelease/app-prod-release.aab

      - name: Upload to GooglePlayStore
        id: android_upload
        run: ./gradlew publishProdReleaseBundle
        working-directory: ./android

      - name: Notify Slack
        uses: ./.github/actions/deploy_notifier
        if: always()
        with:
          os_name: 'Android'
          branch: ${{ github.ref_name }}
          job_status: ${{ job.status == 'success' && 'success' || 'failure' }}
          slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

---

## 🔧 Tool
*2025-02-21 15:18:47*

GitHub ActionsでFlutterのビルドバージョンを自動生成しているが、現在のスクリプトは`patch`部分を強制的に二桁にしている。これを改善し、`patch`部分に二桁の前ゼロを削除したいと考えている。

GitHub Actionsのスクリプトを見直し、`patch`部分を強制的に二桁にするフォーマットを削除し、単一桁の`patch`を許容するように変更している。

正規表現を更新して、`patch`部分の強制的な二桁を削除し、標準的なバージョンフォーマットを許容するようにしている。

正規表現を更新して、バージョンコードから前ゼロを削除し、単一桁の`patch`を許容するようにしている。これにより、バージョンコードが空になる問題を解決している。

`minor`部分の前ゼロを保持しつつ、`patch`部分の前ゼロを削除するアプローチで、ユーザーのニーズに合ったバージョンフォーマットを提供する。

`patch`部分の前ゼロを削除し、`VERSION_CODE`の更新を提案している。`prepare_build`ステップの正規表現も更新する必要がある。

---

## 🤖 Assistant
*2025-02-21 15:18:47*

以下の2点を修正すれば、`0.0.01` といった2桁固定ではなく `0.0.1` や `0.0.2` のように先頭ゼロなしでパッチ番号を扱うようになります。

1. **パッチ番号を二桁固定でフォーマットしない**  
   `Calculate build name` ステップで、現在は

   ```bash
   patch=$(($GITHUB_RUN_NUMBER % 100))
   # Ensure that patch number is at least two digits
   printf -v patch_formatted "%02d" $patch
   echo "BUILD_NAME=$major.$minor.$patch_formatted" >> $GITHUB_ENV
   ```

   のように二桁固定 (`%02d`) でパッチ番号をフォーマットしています。ここを単に

   ```bash
   patch=$(($GITHUB_RUN_NUMBER % 100))
   echo "BUILD_NAME=$major.$minor.$patch" >> $GITHUB_ENV
   ```

   に変更し、ゼロ埋めを行わないようにしてください。

2. **ビルド名バリデーションを `^[0-9]+\.[0-9]+\.[0-9]+$` に変更する**  
   `prepare_build` アクション内の以下の箇所で、現在は “三番目が必ず2桁” のバリデーションになっています。

   ```bash
   if [[ ! "${INPUT_BUILD_NAME}" =~ ^[0-9]+\.[0-9]+\.[0-9]{2}$ ]]; then
       echo "Error: Invalid build name pattern. Please use the x.x.xx format." >&2
       exit 1
   fi
   ```

   ここを “三番目が1桁以上” のバリデーションに変更します。例:

   ```bash
   if [[ ! "${INPUT_BUILD_NAME}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
       echo "Error: Invalid build name pattern. Please use the x.x.x format." >&2
       exit 1
   fi
   ```

   これにより、`0.0.1` や `0.0.2`、`0.0.10`、`0.0.123` など、桁数に制限なく正しく受け付けるようになります。

---

## 変更例

### 修正前 (抜粋)

```yaml
- name: Calculate build name
  id: calc_build_name
  run: |
    major=$(($GITHUB_RUN_NUMBER / 1000))
    minor=$(($GITHUB_RUN_NUMBER % 1000 / 100))
    patch=$(($GITHUB_RUN_NUMBER % 100))
    # Ensure that patch number is at least two digits
    printf -v patch_formatted "%02d" $patch
    echo "BUILD_NAME=$major.$minor.$patch_formatted" >> $GITHUB_ENV
```

```bash
if [[ ! "${INPUT_BUILD_NAME}" =~ ^[0-9]+\.[0-9]+\.[0-9]{2}$ ]]; then
    echo "Error: Invalid build name pattern. Please use the x.x.xx format." >&2
    exit 1
fi
```

### 修正後 (抜粋)

```yaml
- name: Calculate build name
  id: calc_build_name
  run: |
    major=$(($GITHUB_RUN_NUMBER / 1000))
    minor=$(($GITHUB_RUN_NUMBER % 1000 / 100))
    patch=$(($GITHUB_RUN_NUMBER % 100))
    echo "BUILD_NAME=$major.$minor.$patch" >> $GITHUB_ENV
```

```bash
if [[ ! "${INPUT_BUILD_NAME}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "Error: Invalid build name pattern. Please use the x.x.x format." >&2
    exit 1
fi
```

---

この2点を修正すれば、`0.0.01` や `0.0.02` のような二桁パッチではなく、`0.0.1`・`0.0.2` といったセマンティックバージョニングに近い形でバージョンを設定できます。

---

## 👤 User
*2025-02-21 15:30:18*

そもそもなんでそうしてたんだと思いますか？この処理を勝手に変えていいのかが怖いんだ

major=$(($GITHUB_RUN_NUMBER / 1000))
          minor=$(($GITHUB_RUN_NUMBER % 1000 / 100))
          patch=$(($GITHUB_RUN_NUMBER % 100))
          # Ensure that patch number is at least two digits
          printf -v patch_formatted "%02d" $patch
          echo "BUILD_NAME=$major.$minor.$patch_formatted" &gt;&gt; $GITHUB_ENV

---

## 🔧 Tool
*2025-02-21 15:30:36*

バージョンコードの一貫性을 유지するの이 중요한 이유だと考えられる

バージョンコードの一貫性을 유지하고いるんぢゃ요か溪县

**保持一致性を意識**

バージョンコードの一貫性を確保するため、3または4桁のパターンを維持したり、AppleやGoogleストアの制限を考慮することがある。

---

## 🤖 Assistant
*2025-02-21 15:30:36*

大きく考えられる理由としては、**「バージョン文字列を常に同じ桁数で管理したかった」** というのが一番シンプルな動機です。

---

## なぜ二桁固定にしているのか？
1. **文字列としてソートしやすいように**  
   たとえば `0.0.1` と `0.0.10` は、文字列ソート(辞書順ソート)では `0.0.10` が先に並んでしまいます。  
   しかし `0.0.01` / `0.0.10` のように常に桁数を合わせていれば文字列としても数値と同じ順序でソートされます。

2. **単純に見やすい・わかりやすい形式を揃えたかった**  
   `01` と `02` のように桁数が揃っているほうが “バージョンは常に x.x.xx” という形で分かりやすい、と意図された可能性があります。

3. **プロジェクト独自ルールや慣習**  
   iOSやAndroidに明確なルールとして「パッチを2桁にしなければならない」ということはないのですが、チームの中で「常に x.x.xx フォーマットを守ろう」というルールとして運用していたケースもあります。

4. **バージョン番号として使う (Android の versionCode と紐づける) ときに管理しやすかった**  
   Android で使う versionCode は数値なので、例えば “major=1, minor=2, patch=03” を整数にすると 103 になる、など一定の規則で管理したかった可能性があります。  
   - 例: `versionCode = major * 100 + minor * 10 + patch` のように決めている場合、patch を必ず2桁の範囲(00–99)に収まるようにしておけばロジックがシンプルになる  
   - GitHub Actions の `GITHUB_RUN_NUMBER` を使って単純計算で振り分けやすくしていた

---

## 変更して問題ないかどうか
- 基本的に、**iOS や Android 側では「2桁でなければリジェクトされる」などの制約はありません**。  
- ただし、すでに **アプリ配信のワークフローやストアの運用が「x.x.xx」 に依存しているケース** があれば注意する必要があります。  
  - たとえば、外部システムと連携するときに「バージョン番号は常に 5桁の文字列を想定している」など、何かしらのルールを自動化ツールが持っている可能性がある  
  - Slack 通知など、ほかの部分でパース処理をしているかもしれない  

実際には、**ぱっと見で二桁にするメリットはほぼ「慣習的・可読性的なもの」** なので、よほど外部システムとの紐づけがない限り、好きな形式にして問題になることは少ないです。

---

## まとめ
- 二桁固定にしていた理由は「文字列ソート時の整合性」や「バージョン表記を一定桁で揃える」など、プロジェクト独自の運用上の便宜が大きいです。  
- セマンティックバージョニング的には `0.0.1` や `1.2.10` のほうが自然で、アプリストア側も特に2桁固定を求めていません。  
- もしチームとして「セマンティックバージョンに寄せたい」ということであれば、周辺でその二桁運用を前提にパースしている処理がないかだけ確認してから修正するのが安全です。

---

## 👤 User
*2025-02-21 15:33:52*

VERSION_CODE=$(echo "${INPUT_BUILD_NAME:-0.0.1}" | tr -d . | sed 's/^0*//')の処理はどういうことなのかな？

---

## 🤖 Assistant
*2025-02-21 15:34:26*

この処理  
```bash
VERSION_CODE=$(echo "${INPUT_BUILD_NAME:-0.0.1}" | tr -d . | sed 's/^0*//')
```
は、**バージョン文字列を整数のビルド番号 (VERSION_CODE) に変換する処理** です。  
それぞれの処理の意味を解説します。

---

### 1. `${INPUT_BUILD_NAME:-0.0.1}`
- `INPUT_BUILD_NAME` の値が設定されていればその値を使う
- 設定されていなければデフォルト値として `"0.0.1"` を使う
- 例えば `INPUT_BUILD_NAME="1.2.03"` なら `"1.2.03"` になる

---

### 2. `tr -d .`
- `tr -d .` は **文字列から `.` を削除** するコマンド
- 例えば:
  ```bash
  echo "1.2.03" | tr -d .
  ```
  の結果は `1203`

---

### 3. `sed 's/^0*//'`
- `sed 's/^0*//'` は **先頭のゼロ (`0`) を削除** する処理
- `^0*` は「文字列の先頭 (`^`) にある `0` をすべて (`*`)」という意味
- 例えば:
  ```bash
  echo "01203" | sed 's/^0*//'
  ```
  の結果は `1203`

---

## 実際の処理の流れ
例えば `INPUT_BUILD_NAME="1.2.03"` の場合、順番に処理するとこうなります:

| 処理 | 結果 |
|------|------|
| `${INPUT_BUILD_NAME:-0.0.1}` | `"1.2.03"` |
| `tr -d .` | `"1203"` |
| `sed 's/^0*//'` | `"1203"` |

つまり `VERSION_CODE=1203` になります。

---

## 目的
### **Android の `versionCode` 生成**
この `VERSION_CODE` は Android の `versionCode` (整数) に使用されることが多いです。  
Google Play では `versionCode` が **整数値** であり、**以前より大きい値** にする必要があります。  
例えば:
- `BUILD_NAME=1.2.03` → `VERSION_CODE=1203`
- `BUILD_NAME=1.2.10` → `VERSION_CODE=1210`

このようにすることで、**`versionCode` を一貫した整数値として管理できる** ため、アプリのバージョン管理がシンプルになります。

---

## **修正するべきか？**
この処理は **二桁の `patch` を前提にしているため、修正する場合は要注意** です。  
たとえば `patch` を `1.2.3` のように **1桁で表現** すると、`VERSION_CODE` が小さくなってしまう可能性があります。

**修正例:**  
もし `patch` の桁数を変えても `VERSION_CODE` の一貫性を保ちたいなら、例えば次のような方法を使えます。

```bash
VERSION_CODE=$(echo "${INPUT_BUILD_NAME:-0.0.1}" | awk -F. '{printf "%d%02d%02d", $1, $2, $3}')
```
これは:
- `1.2.3` → `10203`
- `1.2.10` → `10210`
のように `patch` を **必ず2桁** にすることで、バージョンの昇順を保ちます。

---

### **結論**
この処理 (`VERSION_CODE=$(echo "${INPUT_BUILD_NAME:-0.0.1}" | tr -d . | sed 's/^0*//'`) )は、
1. `.` を削除し、  
2. `0` を取り除いて整数化することで  
3. Android の `versionCode` に変換している  

という目的で使われています。

もし **バージョンの `patch` を 1 桁で表記する (`1.2.3` など) ように変えるなら、`versionCode` の一貫性を維持するための修正** が必要になります。

---

## 👤 User
*2025-02-21 15:39:34*

どうやったらビルド番号がいい感じに維持できると思う？

---

## 🤖 Assistant
*2025-02-21 15:40:09*

「ビルド番号（versionCode）が一貫したルールで増加する」ことが重要なので、以下のような方式を採用すると良いでしょう。

## **方法 1: `major.minor.patch` を固定フォーマット (x.xx.xx) にして整数化**
この方法では `patch` を **2桁固定にする** ことで、昇順が崩れないように管理します。

**修正コード**
```bash
VERSION_CODE=$(echo "${INPUT_BUILD_NAME:-0.0.1}" | awk -F. '{printf "%d%02d%02d", $1, $2, $3}')
```
これにより、例えば以下のようにバージョンを管理できます。

| `BUILD_NAME` | `VERSION_CODE` |
|-------------|--------------|
| `0.0.1` | `00001` |
| `0.0.10` | `00010` |
| `0.1.1` | `01001` |
| `1.2.3` | `10203` |

**メリット**
- `patch` を **2桁固定** にするので、ソート順が崩れない
- `versionCode` の値が **必ず増加する**
- `major` を大きくすることで大規模な変更を管理できる
- 既存の `VERSION_CODE` のロジックを維持しつつ、セマンティックバージョニングの `patch` に影響を与えない

**デメリット**
- `patch` の桁数が 2桁に固定される (ただし100以上に到達することは少ないので実用上問題なし)

---

## **方法 2: `GITHUB_RUN_NUMBER` を使って自動管理**
この方法では `major.minor.patch` ではなく、GitHub Actions の `GITHUB_RUN_NUMBER` を利用して常に増加する `versionCode` を生成します。

**修正コード**
```bash
VERSION_CODE=$((10000 + GITHUB_RUN_NUMBER))
```

**例**
| `GITHUB_RUN_NUMBER` | `VERSION_CODE` |
|-------------------|--------------|
| 1  | 10001 |
| 2  | 10002 |
| 50 | 10050 |
| 150 | 10150 |

**メリット**
- `versionCode` が **常に増加する**（GitHub Actions の `GITHUB_RUN_NUMBER` を使うため）
- `major.minor.patch` との **依存関係をなくせる**
- `versionCode` の管理がシンプルになる

**デメリット**
- `major.minor.patch` と直接の関連がなくなる
- `versionCode` の形式が `major.minor.patch` の構造ではなくなるため、人が見て分かりづらい

---

## **方法 3: `major.minor.patch` + `GITHUB_RUN_NUMBER` の組み合わせ**
この方法では、`major.minor.patch` を保持しつつ、**`patch` の後に GitHub Actions の `GITHUB_RUN_NUMBER` を付与** して `versionCode` を一意にします。

**修正コード**
```bash
VERSION_CODE=$(echo "${INPUT_BUILD_NAME:-0.0.1}" | awk -F. '{printf "%d%02d%02d", $1, $2, $3}')$GITHUB_RUN_NUMBER
```

**例**
| `BUILD_NAME` | `GITHUB_RUN_NUMBER` | `VERSION_CODE` |
|-------------|-------------------|--------------|
| `0.0.1` | 10 | `0000110` |
| `0.0.10` | 11 | `0001011` |
| `1.2.3` | 50 | `1020350` |

**メリット**
- `major.minor.patch` の順序が **明確**
- `GITHUB_RUN_NUMBER` を組み込むことで、**ビルドごとに確実に増加**
- `patch` を **2桁固定** にすることで順序が崩れない

**デメリット**
- `versionCode` がやや長くなる (`1020350` のように7桁以上になる)

---

## **どれを選ぶべきか？**
### ✅ **一番シンプルで安全なのは「方法 1」**
- `major.minor.patch` の順序が明確
- `patch` を 2桁にすることで、ソート順が崩れない
- `versionCode` の値が **常に増加する**

もし、ビルド番号ごとに確実に増加する `versionCode` が必要なら「方法 2」も選択肢になりますが、`versionCode` にバージョン情報が直接含まれない点がデメリットです。

👉 **結論: 「方法 1」で `patch` を 2桁固定にして `versionCode` を作るのがベスト**

---

## 👤 User
*2025-02-21 15:43:57*

そもそもこのルールでバージョンを分けているのだからこのルールで戻してあるのはどうかな

major=$(($GITHUB_RUN_NUMBER / 1000))
          minor=$(($GITHUB_RUN_NUMBER % 1000 / 100))
          patch=$(($GITHUB_RUN_NUMBER % 100))
          echo "BUILD_NAME=$major.$minor.$patch" &gt;&gt; $GITHUB_ENV

---

## 🤖 Assistant
*2025-02-21 15:44:11*

**現在の `major.minor.patch` ルールを維持しつつ、`VERSION_CODE` を適切に生成する方法**を考えます。

---

## **考え方**
- `BUILD_NAME` のフォーマットは **`major.minor.patch`** で維持する (`0.0.1`, `0.0.2`, ..., `1.2.10` など)
- `VERSION_CODE` は、`major.minor.patch` を数値に変換し、一貫した順序で増加するようにする
- 既存の `major.minor.patch` を活かす

---

## **修正コード**
```bash
major=$(($GITHUB_RUN_NUMBER / 1000))
minor=$(($GITHUB_RUN_NUMBER % 1000 / 100))
patch=$(($GITHUB_RUN_NUMBER % 100))
echo "BUILD_NAME=$major.$minor.$patch" >> $GITHUB_ENV

# versionCode を生成 (major * 10000 + minor * 100 + patch)
VERSION_CODE=$((major * 10000 + minor * 100 + patch))
echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
```

---

## **動作例**
| `GITHUB_RUN_NUMBER` | `BUILD_NAME` (major.minor.patch) | `VERSION_CODE` |
|--------------------|--------------------------------|---------------|
| 1   | `0.0.1`  | `1`  |
| 10  | `0.0.10` | `10` |
| 99  | `0.0.99` | `99` |
| 100 | `0.1.0`  | `100` |
| 150 | `0.1.50` | `150` |
| 1000 | `1.0.0` | `10000` |
| 1234 | `1.2.34` | `10234` |

---

## **この方法のメリット**
✅ **`major.minor.patch` のルールをそのまま維持**  
✅ **`versionCode` は常に増加するため、Android の要件を満たせる**  
✅ **シンプルで直感的なバージョン管理ができる**

---

## **結論**
**この方法 (`versionCode = major * 10000 + minor * 100 + patch`) で修正すれば、バージョン管理のルールを変えずに整合性を保てるのでベストな方法だと思います。**

---

## 👤 User
*2025-02-21 15:44:38*

修正して欲しい

        VERSION_CODE=$(echo "${INPUT_BUILD_NAME:-0.0.1}" | tr -d . | sed 's/^0*//')
        echo "BUILD_NUMBER=${VERSION_CODE}" &gt;&gt; $GITHUB_ENV

---

## 🤖 Assistant
*2025-02-21 15:45:04*

以下の修正を適用し、**`major.minor.patch` ルールを維持しながら `VERSION_CODE` を適切に生成**するようにします。

### **修正後のコード**
```bash
# major.minor.patch を GitHub Actions の RUN_NUMBER から生成
major=$(($GITHUB_RUN_NUMBER / 1000))
minor=$(($GITHUB_RUN_NUMBER % 1000 / 100))
patch=$(($GITHUB_RUN_NUMBER % 100))

# BUILD_NAME の設定
echo "BUILD_NAME=$major.$minor.$patch" >> $GITHUB_ENV

# versionCode を生成 (major * 10000 + minor * 100 + patch)
VERSION_CODE=$((major * 10000 + minor * 100 + patch))
echo "BUILD_NUMBER=${VERSION_CODE}" >> $GITHUB_ENV
```

---

### **変更点**
1. **`INPUT_BUILD_NAME` からの `tr -d .` 削除**
   - `tr -d .` でドットを削除する処理が不要になった。
   - `BUILD_NAME` のフォーマット (`major.minor.patch`) を **維持する形に変更**。

2. **`sed 's/^0*//'` を削除**
   - `VERSION_CODE` の整数化は `major * 10000 + minor * 100 + patch` で管理。
   - 先頭ゼロを手動で削除する必要がない。

3. **適切な `VERSION_CODE` を計算**
   - `VERSION_CODE` は `major.minor.patch` の数値表現を **確実に昇順になるように管理** できる。
   - `major`, `minor`, `patch` の値に **一定のルールを適用** し、**Android の `versionCode` が常に増加** するようにした。

---

### **動作例**
| `GITHUB_RUN_NUMBER` | `BUILD_NAME` | `VERSION_CODE` |
|--------------------|-------------|---------------|
| 1   | `0.0.1`  | `1`  |
| 10  | `0.0.10` | `10` |
| 99  | `0.0.99` | `99` |
| 100 | `0.1.0`  | `100` |
| 150 | `0.1.50` | `150` |
| 1000 | `1.0.0` | `10000` |
| 1234 | `1.2.34` | `10234` |

---

### **結論**
✅ **`major.minor.patch` のルールを維持したまま `VERSION_CODE` を管理できる。**  
✅ **Android の `versionCode` 要件を満たし、常に増加する値になる。**  
✅ **シンプルで直感的なバージョン管理が可能になる。**  

この修正で `BUILD_NAME` のフォーマットを変更せず、適切に `VERSION_CODE` を管理できるようになります。

---
