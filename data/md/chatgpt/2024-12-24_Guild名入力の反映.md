# Guild名入力の反映

日付: 2024-12-24

---

## 👤 ユーザー
*2024/12/24 16:59:59*

hooksを使って'TODO: ギルド名を入力'のところにテキストフィールドの値を入れて欲しい

import 'dart:io';

import 'package:flutter/material.dart';
import 'package:flutter\_hooks/flutter\_hooks.dart';
import 'package:go\_router/go\_router.dart';
import 'package:hooks\_riverpod/hooks\_riverpod.dart';
import 'package:image\_cropper/image\_cropper.dart';
import 'package:image\_picker/image\_picker.dart';
import 'package:permission\_handler/permission\_handler.dart';
import 'package:snpit\_guild\_app/presentation/providers/api\_client/guilds/create\_guild.dart';
import 'package:snpit\_guild\_app/presentation/providers/on\_created\_guild.dart';

class GuildCreatePage extends HookConsumerWidget {
  const GuildCreatePage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final imageFile = useState&lt;File?&gt;(null);
    final picker = useMemoized(ImagePicker.new);

    /// 写真を選択して円状にクロップする
    Future&lt;void&gt; pickAndCropImage() async {
      final pickedFile = await picker.pickImage(source: ImageSource.gallery);

      if (pickedFile != null) {
        final croppedFile = await ImageCropper().cropImage(
          sourcePath: pickedFile.path,
          aspectRatio: const CropAspectRatio(ratioX: 1, ratioY: 1), // 正方形にクロップ
          uiSettings: \[
            AndroidUiSettings(
              hideBottomControls: true, // ボトムコントロール非表示
              lockAspectRatio: true, // アスペクト比を固定
            ),
            IOSUiSettings(
              aspectRatioLockEnabled: true, // アスペクト比を固定
            ),
          \],
        );

        if (croppedFile != null) {
          imageFile.value = File(croppedFile.path);
        } else {
          debugPrint('クロップがキャンセルされました');
        }
      } else {
        debugPrint('画像選択がキャンセルされました');
      }
    }

    /// 写真を削除
    void deleteImage() {
      imageFile.value = null;
      debugPrint('画像が削除されました');
    }

    ref.listen&lt;AsyncValue&lt;String?&gt;&gt;(createGuildNotifierProvider,
        (previous, next) {
      next.when(
        data: (data) {
          if (data == null) {
            return;
          }
          if (context.mounted) {
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(content: Text('ギルドが作成されました！')),
            );
            ref.read(onCreatedGuildNotifierProvider.notifier).trigger();
            context.pop();
          }
        },
        error: (error, stackTrace) {
          if (context.mounted) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(content: Text('ギルドの作成に失敗しました: $error')),
            );
          }
        },
        loading: () {},
      );
    });

    return Scaffold(
      appBar: AppBar(title: const Text('GuildCreatePage')),
      body: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 24),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: \[
            imageFile.value != null
                ? Column(
                    children: \[
                      ClipRRect(
                        borderRadius: BorderRadius.circular(8),
                        child: Image.file(
                          imageFile.value!,
                          width: 150,
                          height: 150,
                          fit: BoxFit.cover,
                        ),
                      ),
                      const SizedBox(height: 10),
                      ElevatedButton(
                        onPressed: deleteImage,
                        child: const Text('画像を削除'),
                      ),
                    \],
                  )
                : const Text('画像が選択されていません'),
            const SizedBox(height: 20),
            ElevatedButton(
              onPressed: () async {
                final hasPermission = await hasPhotoPermission(context);
                if (hasPermission) {
                  await pickAndCropImage();
                }
              },
              child: const Text('ギルドアイコンを選択'),
            ),
            ElevatedButton(
              onPressed: () async {
                await ref
                    .read(createGuildNotifierProvider.notifier)
                    .executeRequest('TODO: ギルド名を入力');
              },
              child: const Text('Create'),
            ),
          \],
        ),
      ),
    );
  }

  /// 写真の権限をチェックして、権限があれば true を返す
  Future&lt;bool&gt; hasPhotoPermission(BuildContext context) async {
    final status = await Permission.photos.request();

    switch (status) {
      case PermissionStatus.granted:
      case PermissionStatus.limited:
        // 許可済みの場合
        return true;

      case PermissionStatus.permanentlyDenied:
        // 永久に拒否されている場合
        if (context.mounted) {
          \_showPermissionDialog(context);
        }
        return false;

      case PermissionStatus.denied:
      case PermissionStatus.restricted:
      case PermissionStatus.provisional:
        // その他の場合
        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('写真へのアクセスが許可されていません。')),
          );
        }
        return false;
    }
  }

  /// 設定ダイアログを表示
  void \_showPermissionDialog(BuildContext context) {
    showDialog&lt;void&gt;(
      context: context,
      builder: (context) =&gt; AlertDialog(
        title: const Text('写真へのアクセス許可が必要です'),
        content: const Text('写真を選択するには、設定で写真へのアクセス許可をオンにしてください。'),
        actions: \[
          TextButton(
            onPressed: () {
              context.pop();
            },
            child: const Text('キャンセル'),
          ),
          TextButton(
            onPressed: () async =&gt; openAppSettings(),
            child: const Text('設定を開く'),
          ),
        \],
      ),
    );
  }
}

---

## 🤖 アシスタント
*2024/12/24 17:00:33*

`TODO: ギルド名を入力` の部分にテキストフィールドの値を反映させるには、以下のように `TextEditingController` を使ってテキスト入力を管理します。以下は修正したコードです。

```dart
class GuildCreatePage extends HookConsumerWidget {
  const GuildCreatePage({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final imageFile = useState<File?>(null);
    final guildNameController = useTextEditingController(); // ギルド名用のコントローラ
    final picker = useMemoized(ImagePicker.new);

    /// 写真を選択して円状にクロップする
    Future<void> pickAndCropImage() async {
      final pickedFile = await picker.pickImage(source: ImageSource.gallery);

      if (pickedFile != null) {
        final croppedFile = await ImageCropper().cropImage(
          sourcePath: pickedFile.path,
          aspectRatio: const CropAspectRatio(ratioX: 1, ratioY: 1),
          uiSettings: [
            AndroidUiSettings(
              hideBottomControls: true,
              lockAspectRatio: true,
            ),
            IOSUiSettings(
              aspectRatioLockEnabled: true,
            ),
          ],
        );

        if (croppedFile != null) {
          imageFile.value = File(croppedFile.path);
        } else {
          debugPrint('クロップがキャンセルされました');
        }
      } else {
        debugPrint('画像選択がキャンセルされました');
      }
    }

    /// 写真を削除
    void deleteImage() {
      imageFile.value = null;
      debugPrint('画像が削除されました');
    }

    ref.listen<AsyncValue<String?>>(createGuildNotifierProvider,
        (previous, next) {
      next.when(
        data: (data) {
          if (data == null) {
            return;
          }
          if (context.mounted) {
            ScaffoldMessenger.of(context).showSnackBar(
              const SnackBar(content: Text('ギルドが作成されました！')),
            );
            ref.read(onCreatedGuildNotifierProvider.notifier).trigger();
            context.pop();
          }
        },
        error: (error, stackTrace) {
          if (context.mounted) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(content: Text('ギルドの作成に失敗しました: $error')),
            );
          }
        },
        loading: () {},
      );
    });

    return Scaffold(
      appBar: AppBar(title: const Text('GuildCreatePage')),
      body: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 24),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            imageFile.value != null
                ? Column(
                    children: [
                      ClipRRect(
                        borderRadius: BorderRadius.circular(8),
                        child: Image.file(
                          imageFile.value!,
                          width: 150,
                          height: 150,
                          fit: BoxFit.cover,
                        ),
                      ),
                      const SizedBox(height: 10),
                      ElevatedButton(
                        onPressed: deleteImage,
                        child: const Text('画像を削除'),
                      ),
                    ],
                  )
                : const Text('画像が選択されていません'),
            const SizedBox(height: 20),
            TextField(
              controller: guildNameController,
              decoration: const InputDecoration(
                labelText: 'ギルド名を入力',
                border: OutlineInputBorder(),
              ),
            ),
            const SizedBox(height: 20),
            ElevatedButton(
              onPressed: () async {
                final hasPermission = await hasPhotoPermission(context);
                if (hasPermission) {
                  await pickAndCropImage();
                }
              },
              child: const Text('ギルドアイコンを選択'),
            ),
            ElevatedButton(
              onPressed: () async {
                final guildName = guildNameController.text;
                if (guildName.isEmpty) {
                  ScaffoldMessenger.of(context).showSnackBar(
                    const SnackBar(content: Text('ギルド名を入力してください。')),
                  );
                  return;
                }
                await ref
                    .read(createGuildNotifierProvider.notifier)
                    .executeRequest(guildName);
              },
              child: const Text('Create'),
            ),
          ],
        ),
      ),
    );
  }

  /// 写真の権限をチェックして、権限があれば true を返す
  Future<bool> hasPhotoPermission(BuildContext context) async {
    final status = await Permission.photos.request();

    switch (status) {
      case PermissionStatus.granted:
      case PermissionStatus.limited:
        return true;
      case PermissionStatus.permanentlyDenied:
        if (context.mounted) {
          _showPermissionDialog(context);
        }
        return false;
      case PermissionStatus.denied:
      case PermissionStatus.restricted:
      case PermissionStatus.provisional:
        if (context.mounted) {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('写真へのアクセスが許可されていません。')),
          );
        }
        return false;
    }
  }

  /// 設定ダイアログを表示
  void _showPermissionDialog(BuildContext context) {
    showDialog<void>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('写真へのアクセス許可が必要です'),
        content: const Text('写真を選択するには、設定で写真へのアクセス許可をオンにしてください。'),
        actions: [
          TextButton(
            onPressed: () {
              context.pop();
            },
            child: const Text('キャンセル'),
          ),
          TextButton(
            onPressed: () async => openAppSettings(),
            child: const Text('設定を開く'),
          ),
        ],
      ),
    );
  }
}
```

### 修正点
1. `useTextEditingController` を使用して `guildNameController` を追加しました。
2. `TextField` を追加し、ユーザーが入力した値を管理します。
3. `Create` ボタンの処理で、テキストフィールドが空の場合に警告を表示し、値がある場合に API を呼び出すようにしました。

この修正により、ギルド名をテキストフィールドから取得して使用できるようになります。

---
