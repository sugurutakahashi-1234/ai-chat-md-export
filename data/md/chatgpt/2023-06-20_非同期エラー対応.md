# éåŒæœŸã‚¨ãƒ©ãƒ¼å¯¾å¿œ

æ—¥ä»˜: 2023-06-20

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2023/6/20 19:10:44*

ã„ã‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ã‚‹ã®ã§å¯¾å¿œã—ã¦ã»ã—ã„

Cannot pass function of type '(GazeTrackEvent) async -&gt; Void' to parameter expecting synchronous function type

public final class GazeTrackCalibrationInteractor: GazeTrackCalibrationInteractorProtocol {
    private let calibrationNextPointSubject = PassthroughSubject&lt;(x: Double, y: Double), Never&gt;()
    private let progressSubject = PassthroughSubject&lt;Double, Never&gt;()
    private let completedCalibrationSubject = PassthroughSubject&lt;\[Double\], Never&gt;()
    private let errorSubject = PassthroughSubject&lt;Error, Never&gt;()
    private let gazeTrackManager: GazeTrackManagerProtocol
    private var cancellableSet = Set&lt;AnyCancellable&gt;()

    public var calibrationNextPointPublisher: AnyPublisher&lt;(x: Double, y: Double), Never&gt; {
        calibrationNextPointSubject.eraseToAnyPublisher()
    }

    public var progressPublisher: AnyPublisher&lt;Double, Never&gt; {
        progressSubject.eraseToAnyPublisher()
    }
    
    public var completedCalibrationPublisher: AnyPublisher&lt;\[Double\], Never&gt; {
        completedCalibrationSubject.eraseToAnyPublisher()
    }

    public var errorPublisher: AnyPublisher&lt;Error, Never&gt; {
        errorSubject.eraseToAnyPublisher()
    }

    public init(gazeTrackManager: GazeTrackManagerProtocol = SeeSoGazeTrackManager()) {
        self.gazeTrackManager = gazeTrackManager

        gazeTrackManager
            .gazeTrackEventPublisher
            .sink { \[weak self\] event in
                guard let self else { return }

                switch event {
                case .initialized(let trackerVoid, let error):
                    AppLogger.debugLog("Event: \\(event), TrackerVoid: \\(String(describing: trackerVoid)), Error: \\(error)")

                    guard error != .none else {
                        // ã‚¨ãƒ©ãƒ¼ã§ã¯ãªã„ã§ã™
                        return
                    }
                    self.errorSubject.send(error)
                    
                case .started:
                    AppLogger.debugLog("Event: \\(event)")

                case .stopped(let error):
                    AppLogger.debugLog("Event: \\(event), Error: \\(error)", level: .error)

                    self.errorSubject.send(error)

                case .gaze(let gazeInformation):
                    AppLogger.debugLog("Event: \\(event), Gaze Information: \\(gazeInformation)")

                case .calibrationNextPoint(let x, let y):
                    AppLogger.debugLog("Event: \\(event), X: \\(x), Y: \\(y)")

                    do {
                        try await self.gazeTrackManager.startCalibrationCollectSamples()
                    } catch {
                        self.errorSubject.send(error)
                    }

                case .calibrationProgress(let progress):
                    AppLogger.debugLog("Event: \\(event), Progress: \\(progress)")
                    
                    self.progressSubject.send(progress)

                case .calibrationFinished(let calibrationData):
                    AppLogger.debugLog("Event: \\(event), Calibration Data: \\(calibrationData)")
                    
                    self.completedCalibrationSubject.send(calibrationData)

                case .image(let timestamp, let image):
                    AppLogger.debugLog("Event: \\(event), Timestamp: \\(timestamp), Image: \\(image)")

                case .attention(let timestampBegin, let timestampEnd, let score):
                    AppLogger.debugLog("Event: \\(event), Timestamp Begin: \\(timestampBegin), Timestamp End: \\(timestampEnd), Score: \\(score)")

                case .blink(let timestamp, let isBlinkLeft, let isBlinkRight, let isBlink, let eyeOpenness):
                    AppLogger.debugLog("Event: \\(event), Timestamp: \\(timestamp), Is Blink Left: \\(isBlinkLeft), Is Blink Right: \\(isBlinkRight), Is Blink: \\(isBlink), Eye Openness: \\(eyeOpenness)")

                case .drowsiness(let timestamp, let isDrowsiness):
                    AppLogger.debugLog("Event: \\(event), Timestamp: \\(timestamp), Is Drowsiness: \\(isDrowsiness)")
                }
            }
            .store(in: &cancellableSet)
        
        self.gazeTrackManager.initializationGazeTracker()
    }

    public func startCalibration() async throws {
        try await gazeTrackManager.startCalibration()
    }
}

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2023/6/20 19:11:18*

Swift 5.5ã‹ã‚‰å°å…¥ã•ã‚ŒãŸéåŒæœŸå‡¦ç†ã¨æ—¢å­˜ã®åŒæœŸå‡¦ç†ã‚’æ··åœ¨ã•ã›ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ãã®ãŸã‚ã€`sink`ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§éåŒæœŸã®`startCalibrationCollectSamples`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚

ã“ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã€éåŒæœŸã‚¿ã‚¹ã‚¯ã‚’`Task.init{}`ãƒ–ãƒ­ãƒƒã‚¯å†…ã§ç”Ÿæˆã—ã€ãã®ãƒ–ãƒ­ãƒƒã‚¯å†…ã§éåŒæœŸé–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ã“ã†ã™ã‚‹ã“ã¨ã§éåŒæœŸã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿã§ãã¾ã™ã€‚

ä»¥ä¸‹ã«ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰ã®ä¸€éƒ¨ã‚’ç¤ºã—ã¾ã™ï¼š

```swift
gazeTrackManager
    .gazeTrackEventPublisher
    .sink { [weak self] event in
        guard let self = self else { return }

        switch event {
        case .calibrationNextPoint(let x, let y):
            AppLogger.debugLog("Event: \(event), X: \(x), Y: \(y)")

            Task.init {
                do {
                    try await self.gazeTrackManager.startCalibrationCollectSamples()
                } catch {
                    self.errorSubject.send(error)
                }
            }

        // Other cases...
        }
    }
    .store(in: &cancellableSet)
```

ã“ã®ä¿®æ­£ã«ã‚ˆã‚Šã€éåŒæœŸé–¢æ•°`startCalibrationCollectSamples`ã¯`Task.init {}`ãƒ–ãƒ­ãƒƒã‚¯å†…ã§å®Ÿè¡Œã•ã‚Œã€`sink`ãƒ¡ã‚½ãƒƒãƒ‰ã®åŒæœŸã‚³ãƒ¼ãƒ‰ã¨ã®é–“ã§ç«¶åˆã™ã‚‹ã“ã¨ãŒãªããªã‚Šã¾ã™ã€‚

---
