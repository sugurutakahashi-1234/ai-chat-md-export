# 日付フォーマット変換実装

日付: 2024-10-21

---

## 👤 ユーザー
*2024/10/21 15:57:48*

必ずja(+09:00)での"yyyy-MM-dd'T'HH:mm:ss" もしくは "yyyy-MM-dd'T'HH:mm:ss.SSS"にString表記する実装


private extension DateFormatter {
    /// DateFormatterの生成が遅いため、アプリ内で 1つのインスタンスを使い回す
    static let shared: DateFormatter = {
        let formatter = DateFormatter()
        formatter.calendar = .current
        formatter.locale = .current
        return formatter
    }()
}

extension Date {
    /// Date -&gt; String 変換用のフォーマット
    enum DateToStringFormat: String {
        /// yyyy/MM/dd
        case yyyyMMddSlash = "yyyy/MM/dd"
        /// yyyy年MM月dd日 HH:mm
        case yyyyMMddHHmmJA = "yyyy年MM月dd日 HH:mm"
    }

    /// Date -&gt; String 変換
    func toString(_ format: DateToStringFormat) -&gt; String {
        DateFormatter.shared.dateFormat = format.rawValue
        return DateFormatter.shared.string(from: self)
    }
}

---

## 🤖 アシスタント
*2024/10/21 15:57:54*

`DateFormatter`を使って、指定の形式（`yyyy-MM-dd'T'HH:mm:ss`または`yyyy-MM-dd'T'HH:mm:ss.SSS`）で、日本標準時（JST, +09:00）に対応する拡張を追加するコードは以下の通りです。

```swift
private extension DateFormatter {
    /// DateFormatterの生成が遅いため、アプリ内で 1つのインスタンスを使い回す
    static let shared: DateFormatter = {
        let formatter = DateFormatter()
        formatter.calendar = .current
        formatter.locale = Locale(identifier: "ja_JP")
        formatter.timeZone = TimeZone(identifier: "Asia/Tokyo")
        return formatter
    }()
}

extension Date {
    /// Date -> String 変換用のフォーマット
    enum DateToStringFormat: String {
        /// yyyy-MM-dd'T'HH:mm:ss
        case iso8601 = "yyyy-MM-dd'T'HH:mm:ss"
        /// yyyy-MM-dd'T'HH:mm:ss.SSS
        case iso8601WithMilliseconds = "yyyy-MM-dd'T'HH:mm:ss.SSS"
    }

    /// Date -> String 変換
    func toString(_ format: DateToStringFormat) -> String {
        DateFormatter.shared.dateFormat = format.rawValue
        return DateFormatter.shared.string(from: self)
    }
}
```

### 変更点
- `DateFormatter.shared`に日本標準時（`Asia/Tokyo`）を設定。
- 新しいフォーマットとして`iso8601`および`iso8601WithMilliseconds`を追加。
- `locale`を`ja_JP`に指定し、日本のロケールに適したフォーマットで文字列変換が行われるように設定。

このコードで、日本標準時に対応した形式で日時を文字列に変換できます。

---

## 👤 ユーザー
*2024/10/21 16:11:03*

sharedJaJpAsiaTokyo と通常のに分けて欲しい

---

## 🤖 アシスタント
*2024/10/21 16:11:12*

User prefers to separate `sharedJaJpAsiaTokyo` from the usual `DateFormatter.shared`.

---

## 🔧 ツール
*2024/10/21 16:11:12*

Model set context updated.

---

## 🤖 アシスタント
*2024/10/21 16:11:12*

`DateFormatter`のインスタンスを分けるように変更しました。以下は、日本標準時用の`sharedJaJpAsiaTokyo`と通常の`shared`を分けた実装です。

```swift
private extension DateFormatter {
    /// 通常の DateFormatter インスタンス
    static let shared: DateFormatter = {
        let formatter = DateFormatter()
        formatter.calendar = .current
        formatter.locale = .current
        formatter.timeZone = .current
        return formatter
    }()
    
    /// 日本標準時（JST, +09:00）用の DateFormatter インスタンス
    static let sharedJaJpAsiaTokyo: DateFormatter = {
        let formatter = DateFormatter()
        formatter.calendar = .current
        formatter.locale = Locale(identifier: "ja_JP")
        formatter.timeZone = TimeZone(identifier: "Asia/Tokyo")
        return formatter
    }()
}

extension Date {
    /// Date -> String 変換用のフォーマット
    enum DateToStringFormat: String {
        /// yyyy-MM-dd'T'HH:mm:ss
        case iso8601 = "yyyy-MM-dd'T'HH:mm:ss"
        /// yyyy-MM-dd'T'HH:mm:ss.SSS
        case iso8601WithMilliseconds = "yyyy-MM-dd'T'HH:mm:ss.SSS"
    }

    /// Date -> String 変換
    func toString(_ format: DateToStringFormat, useJst: Bool = false) -> String {
        let formatter = useJst ? DateFormatter.sharedJaJpAsiaTokyo : DateFormatter.shared
        formatter.dateFormat = format.rawValue
        return formatter.string(from: self)
    }
}
```

### 変更点
- `DateFormatter.sharedJaJpAsiaTokyo`を追加し、日本標準時用のインスタンスを分離。
- `toString`メソッドに`useJst`引数を追加し、指定された場合に`sharedJaJpAsiaTokyo`を使用。

これにより、必要に応じて通常のフォーマットか日本標準時のフォーマットを選択できます。

---

## 👤 ユーザー
*2024/10/21 16:12:03*

toString も JaJpAsiaTokyo とそうでないものを2つ用意して欲しい

---

## 🤖 アシスタント
*2024/10/21 16:12:11*

`toString`メソッドを2つに分け、それぞれ`toString`と`toStringJaJpAsiaTokyo`としました。以下のコードをご覧ください。

```swift
private extension DateFormatter {
    /// 通常の DateFormatter インスタンス
    static let shared: DateFormatter = {
        let formatter = DateFormatter()
        formatter.calendar = .current
        formatter.locale = .current
        formatter.timeZone = .current
        return formatter
    }()
    
    /// 日本標準時（JST, +09:00）用の DateFormatter インスタンス
    static let sharedJaJpAsiaTokyo: DateFormatter = {
        let formatter = DateFormatter()
        formatter.calendar = .current
        formatter.locale = Locale(identifier: "ja_JP")
        formatter.timeZone = TimeZone(identifier: "Asia/Tokyo")
        return formatter
    }()
}

extension Date {
    /// Date -> String 変換用のフォーマット
    enum DateToStringFormat: String {
        /// yyyy-MM-dd'T'HH:mm:ss
        case iso8601 = "yyyy-MM-dd'T'HH:mm:ss"
        /// yyyy-MM-dd'T'HH:mm:ss.SSS
        case iso8601WithMilliseconds = "yyyy-MM-dd'T'HH:mm:ss.SSS"
    }

    /// 通常の Date -> String 変換
    func toString(_ format: DateToStringFormat) -> String {
        DateFormatter.shared.dateFormat = format.rawValue
        return DateFormatter.shared.string(from: self)
    }
    
    /// 日本標準時用の Date -> String 変換
    func toStringJaJpAsiaTokyo(_ format: DateToStringFormat) -> String {
        DateFormatter.sharedJaJpAsiaTokyo.dateFormat = format.rawValue
        return DateFormatter.sharedJaJpAsiaTokyo.string(from: self)
    }
}
```

### 変更点
- `toStringJaJpAsiaTokyo`メソッドを追加し、日本標準時（JST, +09:00）での文字列変換を行うようにしました。
- `toString`は通常の変換に使用されます。

これで、必要に応じて日本標準時の変換と通常の変換を明確に使い分けられます。

---

## 👤 ユーザー
*2024/10/21 16:13:24*

formatter.calendar = .current としているのは意味はあるのか？

---

## 🤖 アシスタント
*2024/10/21 16:13:31*

`formatter.calendar = .current`は、現在のカレンダー設定を`DateFormatter`に適用するコードですが、この設定を行う意味は以下のような場合に影響します：

1. **ユーザーのカレンダー設定**：
   - ユーザーがデバイスでグレゴリオ暦以外のカレンダーを選択している場合（たとえば和暦やイスラム暦など）、`.current`を使うことで、システムがそのカレンダーを反映します。
   
2. **ローカルなカレンダーの考慮**：
   - たとえば、日本で和暦を使う設定にしている場合、`.current`は和暦に対応するようになります。

ただし、このケースでは、明確に日本標準時（JST, +09:00）や通常の変換を行う目的があるため、`.current`を使うより、明示的に`Calendar(identifier: .gregorian)`を指定するほうが適切です。

### 修正後のコード
次のように変更できます：

```swift
private extension DateFormatter {
    /// 通常の DateFormatter インスタンス
    static let shared: DateFormatter = {
        let formatter = DateFormatter()
        formatter.calendar = Calendar(identifier: .gregorian)
        formatter.locale = .current
        formatter.timeZone = .current
        return formatter
    }()
    
    /// 日本標準時（JST, +09:00）用の DateFormatter インスタンス
    static let sharedJaJpAsiaTokyo: DateFormatter = {
        let formatter = DateFormatter()
        formatter.calendar = Calendar(identifier: .gregorian)
        formatter.locale = Locale(identifier: "ja_JP")
        formatter.timeZone = TimeZone(identifier: "Asia/Tokyo")
        return formatter
    }()
}
```

### ポイント
- **`Calendar(identifier: .gregorian)`** に変更することで、どの環境でも一貫してグレゴリオ暦が適用されます。
- この場合、`.current`の意味はなく、より予測可能な動作が保証されます。

---

## 👤 ユーザー
*2024/10/21 16:24:59*

iso8601WithMilliseconds だとタイムゾーンが出ないんだけど

---

## 🤖 アシスタント
*2024/10/21 16:25:08*

ISO 8601形式でタイムゾーンを含めてミリ秒まで出力する場合、フォーマットにタイムゾーンの指定（`Z`など）を追加する必要があります。

### 修正後のコード
タイムゾーンを含むISO 8601形式のフォーマットに変更します。

```swift
private extension DateFormatter {
    /// 通常の DateFormatter インスタンス
    static let shared: DateFormatter = {
        let formatter = DateFormatter()
        formatter.calendar = Calendar(identifier: .gregorian)
        formatter.locale = .current
        formatter.timeZone = .current
        return formatter
    }()
    
    /// 日本標準時（JST, +09:00）用の DateFormatter インスタンス
    static let sharedJaJpAsiaTokyo: DateFormatter = {
        let formatter = DateFormatter()
        formatter.calendar = Calendar(identifier: .gregorian)
        formatter.locale = Locale(identifier: "ja_JP")
        formatter.timeZone = TimeZone(identifier: "Asia/Tokyo")
        return formatter
    }()
}

extension Date {
    /// Date -> String 変換用のフォーマット
    enum DateToStringFormat: String {
        /// yyyy-MM-dd'T'HH:mm:ssZ
        case iso8601 = "yyyy-MM-dd'T'HH:mm:ssZ"
        /// yyyy-MM-dd'T'HH:mm:ss.SSSZ
        case iso8601WithMilliseconds = "yyyy-MM-dd'T'HH:mm:ss.SSSZ"
    }

    /// 通常の Date -> String 変換
    func toString(_ format: DateToStringFormat) -> String {
        DateFormatter.shared.dateFormat = format.rawValue
        return DateFormatter.shared.string(from: self)
    }
    
    /// 日本標準時用の Date -> String 変換
    func toStringJaJpAsiaTokyo(_ format: DateToStringFormat) -> String {
        DateFormatter.sharedJaJpAsiaTokyo.dateFormat = format.rawValue
        return DateFormatter.sharedJaJpAsiaTokyo.string(from: self)
    }
}
```

### ポイント
- **`Z`** をフォーマットに追加することで、タイムゾーン情報（+09:00など）が含まれるようになります。
- これにより、ミリ秒まで含むISO 8601形式の文字列がタイムゾーンを正しく表示します。

---
