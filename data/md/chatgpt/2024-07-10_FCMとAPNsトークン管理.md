# FCMã¨APNsãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†

æ—¥ä»˜: 2024-07-10

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/07/10 16:19:28*

FCM Token ã¨ APNs Token ã®ãã‚Œãã‚Œã®å¯¿å‘½

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/07/10 16:19:50*

FCM Tokenï¼ˆFirebase Cloud Messaging Tokenï¼‰ã¨ APNs Tokenï¼ˆApple Push Notification Service Tokenï¼‰ã¯ã€ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã«å¿…è¦ãªãƒ‡ãƒã‚¤ã‚¹ã®è­˜åˆ¥å­ã§ã™ã€‚ãã‚Œãã‚Œã®å¯¿å‘½ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

### FCM Token
- **å¯¿å‘½**: é€šå¸¸ã€FCM Token ã®å¯¿å‘½ã¯ç„¡æœŸé™ã§ã™ãŒã€ã„ãã¤ã‹ã®ç†ç”±ã§å¤‰æ›´ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ãªå ´åˆã«æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ãŒç”Ÿæˆã•ã‚Œã¾ã™ï¼š
  - ã‚¢ãƒ—ãƒªãŒã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸå ´åˆ
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ãŸå ´åˆ
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ–°ã—ã„ãƒ‡ãƒã‚¤ã‚¹ã«ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸå ´åˆ
  - ãƒˆãƒ¼ã‚¯ãƒ³ã®æ›´æ–°ãŒæ˜ç¤ºçš„ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸå ´åˆ
  - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç†ç”±ã§ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚ŒãŸå ´åˆ

### APNs Token
- **å¯¿å‘½**: APNs Token ã®å¯¿å‘½ã‚‚é€šå¸¸ç„¡æœŸé™ã§ã™ãŒã€ä»¥ä¸‹ã®ç†ç”±ã§å¤‰æ›´ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼š
  - ãƒ‡ãƒã‚¤ã‚¹ãŒ iOS ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ãŸå ´åˆ
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ‡ãƒã‚¤ã‚¹ã®è¨­å®šã‚’å¤‰æ›´ã—ãŸå ´åˆ
  - ã‚¢ãƒ—ãƒªãŒã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸå ´åˆ
  - APNs ãŒãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã™ã‚‹ã“ã¨ã‚’è¦æ±‚ã—ãŸå ´åˆ

### ãƒˆãƒ¼ã‚¯ãƒ³ã®ç®¡ç†
- ã„ãšã‚Œã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚‚ç„¡æœŸé™ã§ã‚ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ãŒã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè£…ã«ãŠã„ã¦ã¯ãƒˆãƒ¼ã‚¯ãƒ³ã®å¤‰æ›´ã‚’å¸¸ã«ç›£è¦–ã—ã€å¿…è¦ã«å¿œã˜ã¦ã‚µãƒ¼ãƒãƒ¼ã«æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ä¿¡ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚
- FCM Token ã«ã¤ã„ã¦ã¯ã€`onNewToken` ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’åˆ©ç”¨ã—ã¦ã€æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ãŒç”Ÿæˆã•ã‚ŒãŸéš›ã«å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚
- APNs Token ã«ã¤ã„ã¦ã¯ã€`didRegisterForRemoteNotificationsWithDeviceToken` ãƒ‡ãƒªã‚²ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã§ã€æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã•ã‚ŒãŸéš›ã«å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ãŒé©åˆ‡ã«ãƒ‡ãƒã‚¤ã‚¹ã«é…ä¿¡ã•ã‚Œç¶šã‘ã‚‹ã‚ˆã†ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç®¡ç†ã§ãã¾ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/07/10 16:20:34*

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ãŸéš›ã«ã¯ã©ã®ã‚ˆã†ã«Token ã‚’ç™»éŒ²ã™ã‚Œã°ã‚ˆã„ã‹ï¼Ÿ

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/07/10 16:21:16*

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ãŸéš›ã®ãƒˆãƒ¼ã‚¯ãƒ³ã®ç™»éŒ²ã«é–¢ã—ã¦ã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã‚’è€ƒæ…®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®æ‰‹é †ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é©åˆ‡ã«å‡¦ç†ã™ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚

### FCM Token
1. **ãƒˆãƒ¼ã‚¯ãƒ³ã®ç„¡åŠ¹åŒ–**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ãŸéš›ã«ã€ã‚µãƒ¼ãƒãƒ¼å´ã§è©²å½“ã™ã‚‹ FCM Token ã‚’ç„¡åŠ¹åŒ–ã¾ãŸã¯å‰Šé™¤ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã«ãã®ãƒˆãƒ¼ã‚¯ãƒ³ã¸ã®é€šçŸ¥ãŒé€ä¿¡ã•ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚
2. **ãƒˆãƒ¼ã‚¯ãƒ³ã®å†å–å¾—**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸéš›ã«ã€æ–°ã—ã„ FCM Token ã‚’å–å¾—ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã«ç™»éŒ²ã—ã¾ã™ã€‚

#### iOS ã®ä¾‹
```swift
import Firebase

func logoutUser() {
    // ãƒˆãƒ¼ã‚¯ãƒ³ã®ç„¡åŠ¹åŒ–å‡¦ç†ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã«ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹åŒ–ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ï¼‰
    if let fcmToken = Messaging.messaging().fcmToken {
        // ã‚µãƒ¼ãƒãƒ¼ã«ç„¡åŠ¹åŒ–ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹
        sendTokenToServer(token: fcmToken, action: "invalidate")
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
    Auth.auth().signOut()
}

func loginUser() {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    Auth.auth().signIn()

    // æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—
    Messaging.messaging().token { token, error in
        if let error = error {
            print("Error fetching FCM registration token: \(error)")
        } else if let token = token {
            print("FCM registration token: \(token)")
            // ã‚µãƒ¼ãƒãƒ¼ã«æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™»éŒ²
            sendTokenToServer(token: token, action: "register")
        }
    }
}

func sendTokenToServer(token: String, action: String) {
    // ã‚µãƒ¼ãƒãƒ¼ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ä¿¡ã™ã‚‹å®Ÿè£…
}
```

### APNs Token
APNs ãƒˆãƒ¼ã‚¯ãƒ³ã«ã¤ã„ã¦ã‚‚åŒæ§˜ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å‰Šé™¤ã—ã€ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å†ç™»éŒ²ã—ã¾ã™ã€‚

#### iOS ã®ä¾‹
```swift
import UserNotifications

func logoutUser() {
    // APNs ãƒˆãƒ¼ã‚¯ãƒ³ã®ç„¡åŠ¹åŒ–å‡¦ç†ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã«ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹åŒ–ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ï¼‰
    if let apnsToken = UserDefaults.standard.string(forKey: "apnsToken") {
        // ã‚µãƒ¼ãƒãƒ¼ã«ç„¡åŠ¹åŒ–ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹
        sendTokenToServer(token: apnsToken, action: "invalidate")
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’å®Ÿè¡Œ
}

func loginUser() {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’å®Ÿè¡Œ

    // æ–°ã—ã„ APNs ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—
    UNUserNotificationCenter.current().getNotificationSettings { settings in
        if settings.authorizationStatus == .authorized {
            DispatchQueue.main.async {
                UIApplication.shared.registerForRemoteNotifications()
            }
        }
    }
}

func application(_ application: UIApplication, didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data) {
    let tokenParts = deviceToken.map { data in String(format: "%02.2hhx", data) }
    let token = tokenParts.joined()
    print("Device Token: \(token)")

    // ã‚µãƒ¼ãƒãƒ¼ã«æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™»éŒ²
    sendTokenToServer(token: token, action: "register")

    // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ï¼ˆå†ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã®ç„¡åŠ¹åŒ–ã®ãŸã‚ï¼‰
    UserDefaults.standard.set(token, forKey: "apnsToken")
}

func sendTokenToServer(token: String, action: String) {
    // ã‚µãƒ¼ãƒãƒ¼ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ä¿¡ã™ã‚‹å®Ÿè£…
}
```

### æ³¨æ„ç‚¹
- ãƒˆãƒ¼ã‚¯ãƒ³ã®ç„¡åŠ¹åŒ–ã¨å†å–å¾—ã®å‡¦ç†ã¯ã€ã‚µãƒ¼ãƒãƒ¼å´ã§é©åˆ‡ã«å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
- ãƒˆãƒ¼ã‚¯ãƒ³ã®ç™»éŒ²ãƒ»ç„¡åŠ¹åŒ–ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚»ã‚­ãƒ¥ã‚¢ãªé€šä¿¡ï¼ˆHTTPSï¼‰ã‚’ä½¿ç”¨ã—ã¦è¡Œã„ã¾ã™ã€‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå†ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¾ã§ã¯é€šçŸ¥ã‚’å—ã‘å–ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã€ãƒˆãƒ¼ã‚¯ãƒ³ã®ç„¡åŠ¹åŒ–ã¯å¿…é ˆã§ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ãŸå¾Œã«ä¸è¦ãªé€šçŸ¥ã‚’å—ã‘å–ã‚‹ã“ã¨ã‚’é˜²ãã“ã¨ãŒã§ãã¾ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/07/10 16:28:15*

ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã¯ã©ã¡ã‚‰ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã™ã‚‹ã¹ãï¼Ÿ

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/07/10 16:29:02*

ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã¯ã€ã©ã¡ã‚‰ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚‚ä¿å­˜ã™ã‚‹ã“ã¨ãŒä¸€èˆ¬çš„ã§ã™ã€‚ãªãœãªã‚‰ã€iOS ãƒ‡ãƒã‚¤ã‚¹ã«ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã«ã¯ APNs ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ã§ã™ãŒã€é€šçŸ¥é€ä¿¡ã®ãŸã‚ã®çµ±ä¸€ã•ã‚ŒãŸç®¡ç†ã‚’è¡Œã†ãŸã‚ã«ã¯ FCM ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ã§ã™ã€‚ä»¥ä¸‹ã«ã€ã©ã¡ã‚‰ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã©ã®ã‚ˆã†ã«ä¿å­˜ã™ã‚‹ã‹ã«ã¤ã„ã¦ã®è©³ç´°ã‚’èª¬æ˜ã—ã¾ã™ã€‚

### 1. APNs Token
- **ç”¨é€”**: Apple Push Notification Service ã‚’ä»‹ã—ã¦ iOS ãƒ‡ãƒã‚¤ã‚¹ã«ç›´æ¥é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚
- **ä¿å­˜æ–¹æ³•**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã« APNs ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã—ã¾ã™ã€‚

### 2. FCM Token
- **ç”¨é€”**: Firebase Cloud Messaging ã‚’ä»‹ã—ã¦ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã®é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚FCM ã¯å†…éƒ¨çš„ã« APNs ã‚’åˆ©ç”¨ã—ã¦ iOS ãƒ‡ãƒã‚¤ã‚¹ã«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™ã€‚
- **ä¿å­˜æ–¹æ³•**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã« FCM ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã—ã¾ã™ã€‚

### æ¨å¥¨ã•ã‚Œã‚‹ä¿å­˜æ–¹æ³•
#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¹ã‚­ãƒ¼ãƒä¾‹
```sql
CREATE TABLE user_tokens (
    user_id VARCHAR(255) PRIMARY KEY,
    fcm_token VARCHAR(255) NOT NULL,
    apns_token VARCHAR(255) NOT NULL,
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### ä¿å­˜ã®å®Ÿè£…ä¾‹ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ï¼‰
ä»¥ä¸‹ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã™ã‚‹ä¾‹ã§ã™ã€‚ã“ã®ä¾‹ã§ã¯ã€Node.js ã¨ Express ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ãŒã€ä»–ã®ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰æŠ€è¡“ã§ã‚‚åŒæ§˜ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒå–ã‚Œã¾ã™ã€‚

```javascript
const express = require('express');
const bodyParser = require('body-parser');
const { Pool } = require('pg'); // PostgreSQL ã®å ´åˆ

const app = express();
const pool = new Pool({
    connectionString: 'your_database_url'
});

app.use(bodyParser.json());

app.post('/register-token', async (req, res) => {
    const { userId, fcmToken, apnsToken } = req.body;

    if (!userId || !fcmToken || !apnsToken) {
        return res.status(400).send('Missing required fields');
    }

    try {
        const result = await pool.query(
            'INSERT INTO user_tokens (user_id, fcm_token, apns_token) VALUES ($1, $2, $3) ' +
            'ON CONFLICT (user_id) DO UPDATE SET fcm_token = $2, apns_token = $3, last_updated = CURRENT_TIMESTAMP',
            [userId, fcmToken, apnsToken]
        );

        res.status(200).send('Token registered successfully');
    } catch (err) {
        console.error('Error saving token:', err);
        res.status(500).send('Internal Server Error');
    }
});

app.listen(3000, () => {
    console.log('Server running on port 3000');
});
```

### ãƒˆãƒ¼ã‚¯ãƒ³ã®æ›´æ–°
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã¾ãŸã¯å†åº¦ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ãŸéš›ã«ã€æœ€æ–°ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ã¦æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚å‰è¿°ã®ä¾‹ã§ã¯ã€`ON CONFLICT` SQL ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦æ—¢å­˜ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ›´æ–°ã—ã¦ã„ã¾ã™ã€‚

### ãƒˆãƒ¼ã‚¯ãƒ³ã®ç„¡åŠ¹åŒ–
- **ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã«ã¯ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç„¡åŠ¹åŒ–ã¾ãŸã¯å‰Šé™¤ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¾ã™**ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãŒå¼·åŒ–ã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå†ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¾ã§é€šçŸ¥ãŒé€ä¿¡ã•ã‚Œãªã„ã‚ˆã†ã«ã§ãã¾ã™ã€‚

```javascript
app.post('/invalidate-token', async (req, res) => {
    const { userId } = req.body;

    if (!userId) {
        return res.status(400).send('Missing required fields');
    }

    try {
        const result = await pool.query(
            'UPDATE user_tokens SET fcm_token = NULL, apns_token = NULL WHERE user_id = $1',
            [userId]
        );

        res.status(200).send('Token invalidated successfully');
    } catch (err) {
        console.error('Error invalidating token:', err);
        res.status(500).send('Internal Server Error');
    }
});
```

### ã¾ã¨ã‚
ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã¯ã€APNs ãƒˆãƒ¼ã‚¯ãƒ³ã¨ FCM ãƒˆãƒ¼ã‚¯ãƒ³ã®ä¸¡æ–¹ã‚’ä¿å­˜ã™ã‚‹ã“ã¨ã§ã€ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®é€ä¿¡ã«æŸ”è»Ÿæ€§ã‚’æŒãŸã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ãŠã‚ˆã³ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã™ã‚‹éš›ã«ã“ã‚Œã‚‰ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é©åˆ‡ã«ç®¡ç†ã™ã‚‹ã“ã¨ã§ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®ä¸¡æ–¹ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

---

## ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼
*2024/07/10 16:29:16*

FCMãƒˆãƒ¼ã‚¯ãƒ³ã ã‘ã§è‰¯ããªã„ã®ã‹ï¼Ÿ

---

## ğŸ¤– ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
*2024/07/10 16:30:06*

FCM ãƒˆãƒ¼ã‚¯ãƒ³ã ã‘ã§ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’ç®¡ç†ã™ã‚‹ã“ã¨ã¯å¤šãã®å ´åˆã§ååˆ†ã§ã™ã€‚å®Ÿéš›ã€Firebase Cloud Messaging (FCM) ã¯ã€APNs (Apple Push Notification Service) ã‚’ä»‹ã—ã¦ iOS ãƒ‡ãƒã‚¤ã‚¹ã«é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã®çµ±åˆã•ã‚ŒãŸã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æä¾›ã—ã¾ã™ã€‚

### FCM ãƒˆãƒ¼ã‚¯ãƒ³ã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹åˆ©ç‚¹
1. **çµ±ä¸€ã•ã‚ŒãŸé€šçŸ¥ç®¡ç†**: FCM ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€iOS ã¨ Android ãƒ‡ãƒã‚¤ã‚¹ã®ä¸¡æ–¹ã«å¯¾ã—ã¦çµ±ä¸€ã•ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§é€šçŸ¥ã‚’é€ä¿¡ã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®å®Ÿè£…ãŒã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚Šã¾ã™ã€‚
2. **è‡ªå‹•ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: FCM ã¯ APNs ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å†…éƒ¨çš„ã«ç®¡ç†ã—ã€å¿…è¦ã«å¿œã˜ã¦æ›´æ–°ã—ã¾ã™ã€‚é–‹ç™ºè€…ã¯ FCM ãƒˆãƒ¼ã‚¯ãƒ³ã®ç®¡ç†ã«é›†ä¸­ã™ã‚Œã°è‰¯ãã€APNs ãƒˆãƒ¼ã‚¯ãƒ³ã®å€‹åˆ¥ç®¡ç†ã¯ä¸è¦ã§ã™ã€‚
3. **ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ **: FCM ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€è¤‡æ•°ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«å¯¾å¿œã™ã‚‹é€šçŸ¥ã‚’ä¸€å…ƒçš„ã«ç®¡ç†ã§ãã‚‹ãŸã‚ã€ãƒãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹ç™ºãŒå®¹æ˜“ã«ãªã‚Šã¾ã™ã€‚

### å®Ÿè£…ä¾‹
#### ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰
ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã¯ã€FCM ãƒˆãƒ¼ã‚¯ãƒ³ã®ã¿ã‚’ä¿å­˜ã—ã€ç®¡ç†ã™ã‚‹ã“ã¨ã§ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’é€ä¿¡ã§ãã¾ã™ã€‚

##### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¹ã‚­ãƒ¼ãƒä¾‹
```sql
CREATE TABLE user_tokens (
    user_id VARCHAR(255) PRIMARY KEY,
    fcm_token VARCHAR(255) NOT NULL,
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

##### ä¿å­˜ã®å®Ÿè£…ä¾‹ï¼ˆNode.js ã¨ Expressï¼‰
```javascript
const express = require('express');
const bodyParser = require('body-parser');
const { Pool } = require('pg'); // PostgreSQL ã®å ´åˆ

const app = express();
const pool = new Pool({
    connectionString: 'your_database_url'
});

app.use(bodyParser.json());

app.post('/register-token', async (req, res) => {
    const { userId, fcmToken } = req.body;

    if (!userId || !fcmToken) {
        return res.status(400).send('Missing required fields');
    }

    try {
        const result = await pool.query(
            'INSERT INTO user_tokens (user_id, fcm_token) VALUES ($1, $2) ' +
            'ON CONFLICT (user_id) DO UPDATE SET fcm_token = $2, last_updated = CURRENT_TIMESTAMP',
            [userId, fcmToken]
        );

        res.status(200).send('Token registered successfully');
    } catch (err) {
        console.error('Error saving token:', err);
        res.status(500).send('Internal Server Error');
    }
});

app.post('/invalidate-token', async (req, res) => {
    const { userId } = req.body;

    if (!userId) {
        return res.status(400).send('Missing required fields');
    }

    try {
        const result = await pool.query(
            'UPDATE user_tokens SET fcm_token = NULL WHERE user_id = $1',
            [userId]
        );

        res.status(200).send('Token invalidated successfully');
    } catch (err) {
        console.error('Error invalidating token:', err);
        res.status(500).send('Internal Server Error');
    }
});

app.listen(3000, () => {
    console.log('Server running on port 3000');
});
```

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰
iOS ãƒ‡ãƒã‚¤ã‚¹ã§ã¯ã€Firebase SDK ã‚’åˆ©ç”¨ã—ã¦ FCM ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã€ã‚µãƒ¼ãƒãƒ¼ã«ç™»éŒ²ã—ã¾ã™ã€‚

#### iOS ã®ä¾‹
```swift
import Firebase

func registerForFCM() {
    Messaging.messaging().token { token, error in
        if let error = error {
            print("Error fetching FCM registration token: \(error)")
        } else if let token = token {
            print("FCM registration token: \(token)")
            // ã‚µãƒ¼ãƒãƒ¼ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™»éŒ²
            sendTokenToServer(token: token)
        }
    }
}

func sendTokenToServer(token: String) {
    let url = URL(string: "https://your-server.com/register-token")!
    var request = URLRequest(url: url)
    request.httpMethod = "POST"
    request.setValue("application/json", forHTTPHeaderField: "Content-Type")

    let body: [String: Any] = ["userId": "your_user_id", "fcmToken": token]
    request.httpBody = try? JSONSerialization.data(withJSONObject: body, options: [])

    let task = URLSession.shared.dataTask(with: request) { data, response, error in
        if let error = error {
            print("Error sending token to server: \(error)")
        } else {
            print("Token successfully sent to server")
        }
    }
    task.resume()
}
```

### ã¾ã¨ã‚
FCM ãƒˆãƒ¼ã‚¯ãƒ³ã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®ç®¡ç†ãŒã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚Šã€ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å¯¾å¿œã®é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã‚’å®¹æ˜“ã«æ§‹ç¯‰ã§ãã¾ã™ã€‚APNs ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å€‹åˆ¥ã«ç®¡ç†ã™ã‚‹å¿…è¦ãŒãªã„ãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ§‹é€ ã‚‚ç°¡ç´ åŒ–ã•ã‚Œã¾ã™ã€‚

---
