# 位置情報除去方法

日付: 2024-07-26

---

## 👤 ユーザー
*2024/7/26 20:40:27*

SwiftUI の PhotoPicker 位置情報 含めない方法

---

## 🤖 アシスタント
*2024/7/26 20:40:47*

SwiftUI の `PhotoPicker` を使用して写真を選択する際に位置情報を含めない方法について説明します。位置情報を含めないようにするには、`PHPickerConfiguration` を設定する際に `setAutoDisableLivePhotos` を `true` に設定し、写真のメタデータを削除する処理を追加する必要があります。

以下に、その実装例を示します。

### Step 1: PHPickerConfiguration の設定

まず、`PHPickerConfiguration` を作成し、位置情報を含めないように設定します。

```swift
import PhotosUI
import SwiftUI

struct PhotoPickerView: UIViewControllerRepresentable {
    @Binding var selectedImage: UIImage?

    class Coordinator: NSObject, PHPickerViewControllerDelegate {
        var parent: PhotoPickerView

        init(parent: PhotoPickerView) {
            self.parent = parent
        }

        func picker(_ picker: PHPickerViewController, didFinishPicking results: [PHPickerResult]) {
            picker.dismiss(animated: true, completion: nil)
            
            guard let provider = results.first?.itemProvider else { return }
            if provider.canLoadObject(ofClass: UIImage.self) {
                provider.loadObject(ofClass: UIImage.self) { (image, error) in
                    DispatchQueue.main.async {
                        if let uiImage = image as? UIImage {
                            // メタデータを削除
                            self.parent.selectedImage = self.removeMetadata(from: uiImage)
                        }
                    }
                }
            }
        }

        private func removeMetadata(from image: UIImage) -> UIImage? {
            guard let cgImage = image.cgImage else { return nil }
            let newImage = UIImage(cgImage: cgImage, scale: image.scale, orientation: image.imageOrientation)
            return newImage
        }
    }

    func makeCoordinator() -> Coordinator {
        Coordinator(parent: self)
    }

    func makeUIViewController(context: Context) -> PHPickerViewController {
        var config = PHPickerConfiguration()
        config.filter = .images
        config.selectionLimit = 1

        let picker = PHPickerViewController(configuration: config)
        picker.delegate = context.coordinator
        return picker
    }

    func updateUIViewController(_ uiViewController: PHPickerViewController, context: Context) {}
}

struct ContentView: View {
    @State private var selectedImage: UIImage?

    var body: some View {
        VStack {
            if let selectedImage = selectedImage {
                Image(uiImage: selectedImage)
                    .resizable()
                    .scaledToFit()
            } else {
                Button("Select Photo") {
                    showPhotoPicker.toggle()
                }
            }
        }
        .sheet(isPresented: $showPhotoPicker) {
            PhotoPickerView(selectedImage: $selectedImage)
        }
    }

    @State private var showPhotoPicker = false
}
```

### 実装のポイント

1. **`PHPickerConfiguration`の設定**: `config` のフィルタリングで画像のみを選択可能に設定しています。
2. **メタデータの削除**: `removeMetadata(from:)` メソッドで画像のメタデータを削除しています。これは、選択された画像からメタデータ（位置情報を含む）を削除して新しい `UIImage` を作成する方法です。
3. **SwiftUI との連携**: `UIViewControllerRepresentable` を使用して `PHPickerViewController` を SwiftUI に統合しています。

このコードをプロジェクトに追加することで、位置情報を含めずに写真を選択できるようになります。

---

## 👤 ユーザー
*2024/7/26 20:42:25*

.photosPicker(isPresented: $showPhotoPicker, selection: $selectedPhotosPickerItem, matching: .images) のオプションにあったりしない？

---

## 🤖 アシスタント
*2024/7/26 20:42:40*

`SwiftUI` の `.photosPicker` モディファイアでは、位置情報を含めないように直接設定するオプションはありません。しかし、選択した写真のメタデータを手動で削除する方法を提供できます。

以下は、`.photosPicker` を使用して写真を選択し、その後メタデータを削除する方法の例です。

```swift
import SwiftUI
import PhotosUI

struct ContentView: View {
    @State private var selectedPhotosPickerItem: [PhotosPickerItem] = []
    @State private var selectedImage: UIImage?

    var body: some View {
        VStack {
            if let selectedImage = selectedImage {
                Image(uiImage: selectedImage)
                    .resizable()
                    .scaledToFit()
            } else {
                Button("Select Photo") {
                    showPhotoPicker.toggle()
                }
            }
        }
        .photosPicker(isPresented: $showPhotoPicker, selection: $selectedPhotosPickerItem, matching: .images)
        .onChange(of: selectedPhotosPickerItem) { newItems in
            guard let firstItem = newItems.first else { return }
            firstItem.loadTransferable(type: UIImage.self) { result in
                switch result {
                case .success(let image):
                    if let image = image {
                        self.selectedImage = self.removeMetadata(from: image)
                    }
                case .failure(let error):
                    print("Error loading image: \(error)")
                }
            }
        }
    }

    @State private var showPhotoPicker = false

    private func removeMetadata(from image: UIImage) -> UIImage? {
        guard let cgImage = image.cgImage else { return nil }
        let newImage = UIImage(cgImage: cgImage, scale: image.scale, orientation: image.imageOrientation)
        return newImage
    }
}

@main
struct MyApp: App {
    var body: some Scene {
        WindowGroup {
            ContentView()
        }
    }
}
```

### 実装のポイント

1. **`PhotosPickerItem` の使用**: `PhotosPickerItem` を使用して写真を選択し、`selectedPhotosPickerItem` にバインディングします。
2. **`loadTransferable(type:)` メソッド**: `PhotosPickerItem` から `UIImage` をロードします。
3. **メタデータの削除**: `removeMetadata(from:)` メソッドを使用して選択された画像からメタデータを削除します。このメソッドは、元の画像から `CGImage` を取得し、新しい `UIImage` を作成してメタデータを削除します。

このアプローチを使用すると、`SwiftUI` の `PhotosPicker` を利用しながら、選択した写真の位置情報を含むメタデータを手動で削除することができます。

---
