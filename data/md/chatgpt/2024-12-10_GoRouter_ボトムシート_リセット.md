# GoRouter ボトムシート リセット

日付: 2024-12-10

---

## 👤 ユーザー
*2024/12/10 20:20:52*

Show Bottom Sheet をタップした時に前のルート情報が残ってしまって、SecondPageから表示されることがある。

毎回routerを作り直さない方法で/homeから表示するようにしたい

import 'package:flutter/material.dart';
import 'package:go\_router/go\_router.dart';

void main() {
  runApp(MyApp());
}

/// メインアプリ用 GoRouter
final GoRouter mainRouter = GoRouter(
  routes: \[
    GoRoute(
      path: '/',
      builder: (context, state) =&gt; HomePage(),
    ),
  \],
);

final GoRouter bottomSheetRouter = GoRouter(
  initialLocation: '/home',
  routes: \[
    GoRoute(
      path: '/home',
      builder: (context, state) =&gt; BottomSheetHomePage(),
    ),
    GoRoute(
      path: '/second',
      builder: (context, state) =&gt; BottomSheetSecondPage(),
    ),
  \],
);

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp.router(
      routerConfig: mainRouter, // メインアプリ用 GoRouter
    );
  }
}

class HomePage extends StatelessWidget {
  void \_showBottomSheet(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      builder: (context) {
        return FractionallySizedBox(
          heightFactor: 0.5,
          child: ClipRRect(
            borderRadius: BorderRadius.vertical(top: Radius.circular(16.0)),
            child: MaterialApp.router(
              routerConfig: bottomSheetRouter,
              debugShowCheckedModeBanner: false,
            ),
          ),
        );
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Main App')),
      body: Center(
        child: ElevatedButton(
          onPressed: () =&gt; \_showBottomSheet(context),
          child: Text('Show Bottom Sheet'),
        ),
      ),
    );
  }
}

/// ボトムシートの最初のページ
class BottomSheetHomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        automaticallyImplyLeading: false,
        title: Text('Bottom Sheet Home'),
        actions: \[
          IconButton(
            icon: Icon(Icons.close),
            onPressed: () {
              Navigator.of(context, rootNavigator: true).pop(); // ボトムシート全体を閉じる
            },
          ),
        \],
      ),
      body: Center(
        child: ElevatedButton(
          onPressed: () {
            context.push('/second'); // ボトムシート内での遷移
          },
          child: Text('Go to Second Page'),
        ),
      ),
    );
  }
}

class BottomSheetSecondPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        automaticallyImplyLeading: true,
        title: Text('Second Page'),
        actions: \[
          IconButton(
            icon: Icon(Icons.close),
            onPressed: () {
              Navigator.of(context, rootNavigator: true).pop(); // ボトムシート全体を閉じる
            },
          ),
        \],
      ),
      body: Center(
        child: Text('This is the second page in the bottom sheet.'),
      ),
    );
  }
}

---

## 🤖 アシスタント
*2024/12/10 20:21:13*

問題の原因は、`bottomSheetRouter`が再利用されており、`GoRouter`の状態がリセットされないためです。解決策として、以下の方法を試してみてください。

1. **状態をリセットする**  
`showModalBottomSheet`内で新しい`GoRouter`インスタンスを作成し直す必要があります。これにより、毎回初期状態から始めることができます。

修正コード:

```dart
void _showBottomSheet(BuildContext context) {
  showModalBottomSheet(
    context: context,
    isScrollControlled: true,
    builder: (context) {
      // 新しい GoRouter インスタンスを毎回作成
      final GoRouter sheetRouter = GoRouter(
        initialLocation: '/home',
        routes: [
          GoRoute(
            path: '/home',
            builder: (context, state) => BottomSheetHomePage(),
          ),
          GoRoute(
            path: '/second',
            builder: (context, state) => BottomSheetSecondPage(),
          ),
        ],
      );

      return FractionallySizedBox(
        heightFactor: 0.5,
        child: ClipRRect(
          borderRadius: BorderRadius.vertical(top: Radius.circular(16.0)),
          child: MaterialApp.router(
            routerConfig: sheetRouter,
            debugShowCheckedModeBanner: false,
          ),
        ),
      );
    },
  );
}
```

### 変更点の説明

- **`GoRouter`のインスタンス化を`showModalBottomSheet`内で行う**  
  これにより、毎回新しいルートが生成され、状態がリセットされます。

### 期待する動作

- 毎回ボトムシートを開くとき、必ず`/home`から始まります。
- ボトムシート内でのナビゲーションは独立しており、`mainRouter`に影響を与えません。

この方法は、既存のコードに最小限の変更で対応できるため、保守性にも優れています。

---

## 👤 ユーザー
*2024/12/10 20:21:40*

// 新しい GoRouter インスタンスを毎回作成　をしたくないだ。閉じるときや表示する時にルーティングをhomeに戻しておけばいいと思っている

---

## 🤖 アシスタント
*2024/12/10 20:21:55*

`GoRouter`の再利用をしたい場合、ボトムシートを閉じる際や表示する前に、ルートを`/home`に戻すことで対応できます。以下のように修正できます。

### 修正コード

```dart
void _showBottomSheet(BuildContext context) {
  // ボトムシートを開く前にルートをリセット
  bottomSheetRouter.go('/home');

  showModalBottomSheet(
    context: context,
    isScrollControlled: true,
    builder: (context) {
      return FractionallySizedBox(
        heightFactor: 0.5,
        child: ClipRRect(
          borderRadius: BorderRadius.vertical(top: Radius.circular(16.0)),
          child: MaterialApp.router(
            routerConfig: bottomSheetRouter,
            debugShowCheckedModeBanner: false,
          ),
        ),
      );
    },
  );
}
```

### 変更点の説明

1. **`bottomSheetRouter.go('/home')`を追加**  
   ボトムシートを表示する前に、`GoRouter`の現在のルートを`/home`に変更します。これにより、毎回初期ルートから始めるようになります。

2. **ボトムシートを閉じたときの状態のリセット**（任意）  
   必要であれば、ボトムシートを閉じる際にルートを`/home`に戻す処理も追加できます。

   ```dart
   onPressed: () {
     bottomSheetRouter.go('/home'); // ルートをリセット
     Navigator.of(context, rootNavigator: true).pop(); // ボトムシート全体を閉じる
   },
   ```

### 期待する動作

- ボトムシートを開くとき、常に`/home`から始まります。
- ボトムシート内での遷移状態は次回表示時にリセットされます。
- `GoRouter`のインスタンスを再生成する必要がありません。

これにより、`GoRouter`の再利用が可能になり、コードもシンプルに保つことができます。

---

## 👤 ユーザー
*2024/12/10 22:21:00*

GuildPage から GuildCode画面と GuildCreate へpush遷移するボタンを短いコードで置いてほしい

import 'package:flutter/material.dart';

class GuildPage extends StatelessWidget {
  const GuildPage({super.key});

  @override
  Widget build(BuildContext context) {
    return const Center(child: Text('Guild Page Content'));
  }
}

---

## 🤖 アシスタント
*2024/12/10 22:21:20*

以下は、`GuildPage`から`GuildCode`と`GuildCreate`画面への遷移を簡潔に実装したコード例です。ボタンを追加し、`Navigator.push`で各画面に遷移するコードを含めました。

```dart
import 'package:flutter/material.dart';

class GuildPage extends StatelessWidget {
  const GuildPage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('Guild Page')),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            ElevatedButton(
              onPressed: () => Navigator.push(
                context,
                MaterialPageRoute(builder: (_) => const GuildCodePage()),
              ),
              child: const Text('Go to Guild Code'),
            ),
            ElevatedButton(
              onPressed: () => Navigator.push(
                context,
                MaterialPageRoute(builder: (_) => const GuildCreatePage()),
              ),
              child: const Text('Go to Guild Create'),
            ),
          ],
        ),
      ),
    );
  }
}

class GuildCodePage extends StatelessWidget {
  const GuildCodePage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('Guild Code')),
      body: const Center(child: Text('Guild Code Page Content')),
    );
  }
}

class GuildCreatePage extends StatelessWidget {
  const GuildCreatePage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('Guild Create')),
      body: const Center(child: Text('Guild Create Page Content')),
    );
  }
}
```

### 主なポイント
1. **`Navigator.push`の使用**  
   ボタンをタップしたときに`Navigator.push`を使って新しい画面へ遷移します。
   
2. **短いコード**  
   ボタンと遷移処理を簡潔に記述し、余計なロジックを排除しました。

3. **`Scaffold`を使用**  
   画面全体のレイアウトを整えるために`Scaffold`を使用しています。

### 使用方法
`GuildPage`から「Go to Guild Code」または「Go to Guild Create」のボタンをタップすると、それぞれの画面に遷移します。

---

## 👤 ユーザー
*2024/12/10 22:26:09*

create ボタンを作ってgo\_routertでpopしてほしい

import 'package:flutter/material.dart';

class GuildCreatePage extends StatelessWidget {
  const GuildCreatePage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('GuildCreatePage')),
      body: const Center(child: Text('GuildCreatePage')),
    );
  }
}

---

## 🤖 アシスタント
*2024/12/10 22:26:22*

以下のように、`create`ボタンを追加して、`go_router`を使用して`pop`するコードを実装できます。

### 修正コード

```dart
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';

class GuildCreatePage extends StatelessWidget {
  const GuildCreatePage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('GuildCreatePage')),
      body: Center(
        child: ElevatedButton(
          onPressed: () {
            // go_router で pop
            context.pop();
          },
          child: const Text('Create'),
        ),
      ),
    );
  }
}
```

### 主なポイント
1. **`context.pop()`の使用**  
   `go_router`の`pop`メソッドを利用して、現在のルートをスタックから取り除き、前の画面に戻ります。

2. **`ElevatedButton`でボタンの作成**  
   シンプルな「Create」ボタンを実装し、`onPressed`で`pop`をトリガーします。

### 使用方法
1. `GuildCreatePage`に遷移。
2. 「Create」ボタンをタップすると、前の画面に戻ります。

このコードは`go_router`を利用した`pop`操作に対応しており、`Navigator.pop`を使わずに実現できます。

---

## 👤 ユーザー
*2024/12/10 22:28:05*

GuildCodePage から GuildRequestPage へpush遷移してほしい

import 'package:flutter/material.dart';

class GuildCodePage extends StatelessWidget {
  const GuildCodePage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('GuildCodePage')),
      body: const Center(child: Text('GuildCodePage')),
    );
  }
}

---

## 🤖 アシスタント
*2024/12/10 22:28:29*

以下は、`GuildCodePage`から`GuildRequestPage`へ`go_router`を使用して遷移するコードの例です。

### 修正コード

```dart
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';

class GuildCodePage extends StatelessWidget {
  const GuildCodePage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('GuildCodePage')),
      body: Center(
        child: ElevatedButton(
          onPressed: () {
            // go_router を使用して GuildRequestPage に遷移
            context.push('/guild_request');
          },
          child: const Text('Go to GuildRequestPage'),
        ),
      ),
    );
  }
}

class GuildRequestPage extends StatelessWidget {
  const GuildRequestPage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('GuildRequestPage')),
      body: const Center(child: Text('GuildRequestPage')),
    );
  }
}

void main() {
  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp.router(
      routerConfig: GoRouter(
        routes: [
          GoRoute(
            path: '/guild_code',
            builder: (context, state) => const GuildCodePage(),
          ),
          GoRoute(
            path: '/guild_request',
            builder: (context, state) => const GuildRequestPage(),
          ),
        ],
      ),
    );
  }
}
```

### 主なポイント
1. **`context.push('/guild_request')`の使用**  
   `go_router`を利用して、新しいルート`/guild_request`に遷移します。

2. **`GuildRequestPage`の定義**  
   `GuildRequestPage`を新しいルートとして追加しました。

3. **`GoRouter`のルート設定**  
   ルート一覧に`/guild_code`と`/guild_request`を定義しました。

### 使用方法
1. アプリを起動すると`GuildCodePage`に遷移します。
2. 「Go to GuildRequestPage」ボタンをタップすると、`GuildRequestPage`に遷移します。

このコードにより、簡単にページ間のナビゲーションが可能になります。

---
