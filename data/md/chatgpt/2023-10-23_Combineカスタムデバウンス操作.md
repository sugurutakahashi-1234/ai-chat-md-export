# Combineカスタムデバウンス操作

日付: 2023-10-23

---

## 👤 ユーザー
*2023/10/23 20:46:00*

swift の Combine に debounce や throttle があるが一定時間出力が来ていれば、延長して、一定時間出力がこなければ処理をしたい場合はどうすればいいか？

---

## 🤖 アシスタント
*2023/10/23 20:46:41*

SwiftのCombineフレームワークでは、`debounce`と`throttle`のようなオペレーターを使用して、出力イベントの配信頻度を制御することができます。`debounce`は特定の期間中に受け取った複数のイベントを一つにまとめ、その期間の終了時に最新のイベントを送信します。一方、`throttle`は指定された期間中に最初に受け取ったイベントを送信し、その後のイベントは無視します。

あなたが述べているような振る舞い、つまり「一定時間出力が続いていればその期間を延長し、一定時間出力がなければ処理を行いたい」というものは、これらのオペレーターだけでは完全には実現できません。しかし、カスタムオペレーターを作成することで、このような動作を実現することが可能です。

以下に、この振る舞いを模倣するための疑似コードを示します。実際のコードではエラーハンドリングやコンプリートイベントの処理など、より多くの考慮が必要になりますが、基本的なアイデアは以下の通りです。

```swift
import Combine
import Foundation

extension Publisher {
    
    func extendableDebounce(for dueTime: DispatchQueue.SchedulerTimeType.Stride, scheduler: DispatchQueue) -> AnyPublisher<Output, Failure> {
        let subject = PassthroughSubject<Output, Failure>()
        var lastValue: Output? = nil
        var debounceWorkItem: DispatchWorkItem?
        
        return self
            .handleEvents(receiveOutput: { value in
                // キャンセル前の作業項目があればキャンセル
                debounceWorkItem?.cancel()
                
                // 新しい作業項目をスケジュール
                debounceWorkItem = DispatchWorkItem {
                    if let lastValue = lastValue {
                        subject.send(lastValue)
                    }
                    lastValue = nil
                }
                lastValue = value
                scheduler.schedule(after: scheduler.now.advanced(by: dueTime), execute: debounceWorkItem!)
            }, receiveCompletion: { completion in
                // 完了イベントで残りの作業を処理
                debounceWorkItem?.perform()
                subject.send(completion: completion)
            })
            .flatMap { _ in Empty<Output, Failure>() } // 元のイベントは無視
            .merge(with: subject) // 新しいsubjectからのイベントをマージ
            .eraseToAnyPublisher()
    }
}
```

このカスタムオペレーターは、新しい値が来るたびにデバウンスタイマーをリセットします。一定時間新しい値がこなければ、最後の値を送信します。

これは疑似コードであり、実際のプロジェクトに適用する前に適切なエラーハンドリングや購読の解除、メモリリークの考慮などを含めた十分なテストが必要です。また、このコードは主にディスパッチキューとの相互運用を目的としていますが、他のスケジューラでの使用には適応が必要です。

---
