# Next.js DB アクセス

Date: 2025-06-25

---

## 👤 User
*2025-06-25 16:58:34*

Next.jsってクライアント側でデータベースのアクセスをかけるってほんとか？
つまりAPIいらないのか？

---

## 🤖 Assistant
*2025-06-25 16:58:48*

結論から言うと **ブラウザ側（Client Component）の JavaScript が直接あなたの MySQL/PostgreSQL などにコネクションを張ることはありません**。  
ただし **Next.js (13/14/15 以降の App Router) では「Server Components／Server Actions」を経由して** ― 見た目は「クライアントから関数を呼ぶだけ」なのに ― バックエンドで実際に DB クエリを実行させるしくみが用意されています。これが「クライアント側で DB にアクセスできる」と言われるゆえんです。

---

## どうなっているのか

| レイヤ | 役割 | 実際の実行場所 |
|-------|------|---------------|
| **Client Component** | フォーム送信やボタンクリックで Server Action を呼び出す | ブラウザ |
| **Server Action / Server Component** | `use server` ディレクティブ付きの関数。Prisma などで DB を操作 | Vercel Edge／Node.js ランタイム（サーバ側） |
| **Next.js 内部 RPC** | `POST /_next/action` にシリアライズして転送（暗号化付き） | フレームワークが自動生成 | citeturn0search7 |

* **認証情報・ENV はサーバに留まる**  
  `process.env.DATABASE_URL` などは Server Action 内でしか参照できず、クライアントへは漏れません。Next.js はクロージャ変数を暗号化して転送する仕組みを持っています。citeturn0search7

* **専用 API ルートを手書きしなくても良い**  
  Route Handlers（`app/api/*/route.ts`）を書かずに済むので「API を書かなくても DB 触れる」ように感じるわけです。実際は **Next.js が裏側で RPC エンドポイントを自動生成** しています。

---

## Prisma + Server Action の最小サンプル

```ts
// app/actions/todo.ts
'use server';

import { prisma } from '@/lib/prisma';

export async function addTodo(formData: FormData) {
  const title = formData.get('title') as string;
  await prisma.todo.create({ data: { title } });
}
```

```tsx
// app/page.tsx (Client Component)
'use client';

import { addTodo } from './actions/todo';

export default function TodoForm() {
  async function handleSubmit(e: React.FormEvent<HTMLFormElement>) {
    e.preventDefault();
    await addTodo(new FormData(e.currentTarget)); // ← 普通の関数呼び出しに見える
  }

  return (
    <form onSubmit={handleSubmit}>
      <input name="title" />
      <button type="submit">Add</button>
    </form>
  );
}
```

呼び出し側は通常の関数呼び出しと同じ書き味ですが、`addTodo` はサーバ上で実行され、ブラウザには DB 接続情報が一切送られません。citeturn0search6

---

## 「本当に API いらないの？」チェックリスト

| ケース | 具体例 | Server Actions だけで OK? |
|-------|--------|--------------------------|
| **同じ Next.js アプリから CRUD する** | 管理画面やブログなど | ✔️ 十分。変わりに API ルートを書く必要なし |
| **モバイルアプリや別ドメイン SPA からも呼びたい** | React Native / Flutter App | ❌ REST/GraphQL など公開 API の方が適切 |
| **第三者が叩く公開 API** | パートナー向け API | ❌ OpenAPI/GraphQL を設計する方が管理しやすい |
| **行レベルセキュリティつき BaaS** | Supabase/Firebase | クライアント SDK でも安全に直接クエリ可能（とはいえロール設定必須）citeturn0search5 |

---

## まとめ

* **直接ブラウザから RDB に接続するわけではない**  
  → Server Actions 経由でサーバ上のコードとして実行される。
* **専用 REST/GraphQL ルートを手で書かずに済む**  
  → ただし内部的には Next.js が RPC API を自動生成している。
* **外部クライアントや公開 API が必要なら従来通り API 設計が必要**  
  → Server Actions は「同じ Next.js アプリ内限定の BFF（Backend-for-Frontend）」と考えると分かりやすい。

これで「クライアントから DB に直接アクセスしているように見える」仕掛けの正体と、API の要否の判断軸がクリアになるはずです。

---
