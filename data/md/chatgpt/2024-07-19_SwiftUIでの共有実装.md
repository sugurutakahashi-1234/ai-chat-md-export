# SwiftUIでの共有実装

日付: 2024-07-19

---

## 👤 ユーザー
*2024/7/19 16:55:28*

shareLinkを使わないSwiftでのshare画面の立ち上げ

---

## 🤖 アシスタント
*2024/7/19 16:55:51*

Swiftで`shareLink`を使わずに共有画面を表示するには、`UIActivityViewController`を使用します。以下はその実装例です。

### 実装手順

1. **共有するコンテンツを用意する**：例えば、テキストや画像など。
2. **`UIActivityViewController`のインスタンスを作成する**。
3. **`present`メソッドを使って共有画面を表示する**。

### 例

以下の例では、ボタンをタップするとテキストを共有する画面が表示されるSwiftUIのビューを示します。

```swift
import SwiftUI
import UIKit

struct ShareView: View {
    var body: some View {
        VStack {
            Text("Hello, world!")
                .padding()
            
            Button(action: {
                shareText("This is a text to share!")
            }) {
                Text("Share Text")
                    .padding()
                    .background(Color.blue)
                    .foregroundColor(.white)
                    .cornerRadius(8)
            }
        }
    }
    
    private func shareText(_ text: String) {
        guard let windowScene = UIApplication.shared.connectedScenes.first as? UIWindowScene,
              let rootViewController = windowScene.windows.first?.rootViewController else {
            return
        }
        
        let activityVC = UIActivityViewController(activityItems: [text], applicationActivities: nil)
        rootViewController.present(activityVC, animated: true, completion: nil)
    }
}

struct ShareView_Previews: PreviewProvider {
    static var previews: some View {
        ShareView()
    }
}
```

### 説明

1. **ボタンの作成**：
    - `Button`を使用して、タップしたときに`shareText`メソッドを呼び出します。

2. **`shareText`メソッドの実装**：
    - 共有するテキストを受け取り、`UIActivityViewController`を作成します。
    - `UIApplication.shared.connectedScenes`から現在のウィンドウシーンを取得し、その中の`rootViewController`を使って共有画面を表示します。

### 注意点
- SwiftUIとUIKitの橋渡しとして`UIViewController`を利用するため、`UIApplication`から現在のウィンドウシーンや`rootViewController`を取得する必要があります。
- この方法は、テキスト、画像、URLなど、`UIActivityViewController`がサポートするあらゆるコンテンツを共有するために使用できます。

このコードを使用すれば、`shareLink`を使わずにSwiftUI内で共有機能を実装することができます。

---

## 👤 ユーザー
*2024/7/19 18:55:52*

SwiftUIでラップして実装してほしい

---

## 🤖 アシスタント
*2024/7/19 18:56:11*

SwiftUIでラップして`UIActivityViewController`を使うためには、`UIViewControllerRepresentable`を利用します。これにより、SwiftUIからUIKitのビューコントローラーを使用することができます。

### 実装手順

1. **`UIViewControllerRepresentable`を実装**：`UIActivityViewController`をラップするためのSwiftUIビューを作成します。
2. **SwiftUIビュー内でラップしたビューを利用**。

### コード例

以下は、SwiftUIでラップした`UIActivityViewController`を使って共有機能を実装する例です。

```swift
import SwiftUI
import UIKit

struct ShareSheet: UIViewControllerRepresentable {
    var activityItems: [Any]
    var applicationActivities: [UIActivity]? = nil
    
    func makeUIViewController(context: Context) -> UIActivityViewController {
        let controller = UIActivityViewController(activityItems: activityItems, applicationActivities: applicationActivities)
        return controller
    }
    
    func updateUIViewController(_ uiViewController: UIActivityViewController, context: Context) {
        // No need to update the controller, as it does not change over time
    }
}

struct ContentView: View {
    @State private var isShareSheetPresented = false
    
    var body: some View {
        VStack {
            Text("Hello, world!")
                .padding()
            
            Button(action: {
                isShareSheetPresented = true
            }) {
                Text("Share Text")
                    .padding()
                    .background(Color.blue)
                    .foregroundColor(.white)
                    .cornerRadius(8)
            }
            .sheet(isPresented: $isShareSheetPresented) {
                ShareSheet(activityItems: ["This is a text to share!"])
            }
        }
    }
}

struct ContentView_Previews: PreviewProvider {
    static var previews: some View {
        ContentView()
    }
}
```

### 説明

1. **`ShareSheet`の実装**：
    - `UIViewControllerRepresentable`プロトコルを採用して、`UIActivityViewController`をラップします。
    - `makeUIViewController`メソッドで`UIActivityViewController`を作成し、共有するアイテムを設定します。

2. **`ContentView`の実装**：
    - `@State`プロパティでシートの表示状態を管理します。
    - ボタンをタップすると`isShareSheetPresented`が`true`に設定され、`ShareSheet`が表示されます。

この方法により、SwiftUIの中でUIKitの`UIActivityViewController`をシームレスに使用することができます。これにより、`shareLink`を使わずに柔軟な共有機能を提供できます。

---

## 👤 ユーザー
*2024/7/19 18:56:45*

この時にインスタのアイコンの時に特別な処理を実施できるのか？

---

## 🤖 アシスタント
*2024/7/19 18:57:16*

`UIActivityViewController`を使用している場合、特定のアプリ（例えばInstagram）のアイコンをタップしたときに特別な処理を行うことは直接的には難しいです。`UIActivityViewController`自体はカスタム処理を挟むためのフックを提供していません。しかし、カスタムのアクティビティを追加することで、特定のアクションを処理することは可能です。

以下に、カスタムアクティビティを作成してInstagramへの共有処理をカスタマイズする例を示します。

### ステップ1：カスタムアクティビティの作成

まず、`UIActivity`のサブクラスを作成します。

```swift
import UIKit

class InstagramActivity: UIActivity {
    var items: [Any]?
    
    override var activityType: UIActivity.ActivityType? {
        return UIActivity.ActivityType("com.example.instagram")
    }
    
    override var activityTitle: String? {
        return "Instagram"
    }
    
    override var activityImage: UIImage? {
        return UIImage(named: "instagram_icon") // カスタムのInstagramアイコンを提供
    }
    
    override func canPerform(withActivityItems activityItems: [Any]) -> Bool {
        // 必要なアイテムがあるかどうかをチェック
        return activityItems.contains { $0 is UIImage }
    }
    
    override func prepare(withActivityItems activityItems: [Any]) {
        self.items = activityItems
    }
    
    override func perform() {
        // Instagramに画像を共有するカスタム処理
        guard let image = items?.first(where: { $0 is UIImage }) as? UIImage else {
            activityDidFinish(false)
            return
        }
        
        // 画像をInstagramにシェアするためのコードをここに記述
        // 例：URLスキームを使ってInstagramを開く
        
        activityDidFinish(true)
    }
}
```

### ステップ2：カスタムアクティビティを`UIActivityViewController`に追加

次に、`UIActivityViewController`を作成するときにカスタムアクティビティを追加します。

```swift
import SwiftUI
import UIKit

struct ShareSheet: UIViewControllerRepresentable {
    var activityItems: [Any]
    var applicationActivities: [UIActivity]? = nil
    
    func makeUIViewController(context: Context) -> UIActivityViewController {
        let controller = UIActivityViewController(activityItems: activityItems, applicationActivities: applicationActivities)
        return controller
    }
    
    func updateUIViewController(_ uiViewController: UIActivityViewController, context: Context) {
        // No need to update the controller, as it does not change over time
    }
}

struct ContentView: View {
    @State private var isShareSheetPresented = false
    
    var body: some View {
        VStack {
            Text("Hello, world!")
                .padding()
            
            Button(action: {
                isShareSheetPresented = true
            }) {
                Text("Share Text")
                    .padding()
                    .background(Color.blue)
                    .foregroundColor(.white)
                    .cornerRadius(8)
            }
            .sheet(isPresented: $isShareSheetPresented) {
                ShareSheet(activityItems: ["This is a text to share!"], applicationActivities: [InstagramActivity()])
            }
        }
    }
}

struct ContentView_Previews: PreviewProvider {
    static var previews: some View {
        ContentView()
    }
}
```

### 説明

1. **`InstagramActivity`の作成**：
    - `UIActivity`のサブクラスとして`InstagramActivity`を作成し、Instagramアイコンとカスタム処理を定義します。
    - `canPerform(withActivityItems:)`メソッドで共有可能なアイテムがあるかをチェックし、`perform()`メソッドで実際の処理を行います。

2. **`ShareSheet`にカスタムアクティビティを追加**：
    - `ShareSheet`を表示する際に、`applicationActivities`に`InstagramActivity`のインスタンスを追加します。

このアプローチにより、Instagramアイコンをタップしたときに特定の処理を実行することができます。カスタムアクティビティを使うことで、他の共有先に対しても同様のカスタマイズが可能です。

---

## 👤 ユーザー
*2024/7/19 18:59:37*

{
  "content\_type": "image\_asset\_pointer",
  "asset\_pointer": "file-service://file-AKgu6GMfzEbp5Abf0rvjtbHS",
  "size\_bytes": 158645,
  "width": 708,
  "height": 1536,
  "fovea": null,
  "metadata": {
    "dalle": null,
    "gizmo": null,
    "generation": null,
    "container\_pixel\_height": null,
    "container\_pixel\_width": null,
    "emu\_omit\_glimpse\_image": null,
    "emu\_patches\_override": null,
    "sanitized": true,
    "asset\_pointer\_link": null,
    "watermarked\_asset\_pointer": null
  }
}

---

## 🤖 アシスタント
*2024/7/19 19:00:09*

画像を確認しました。UIActivityViewControllerを使用してInstagramにシェアしようとした際にエラーが発生しているようです。

このエラーを解決するための手順として、以下のようなカスタム処理を実装することが考えられます。具体的には、Instagramへのシェア機能をカスタマイズするために`URL Scheme`を使用します。InstagramのURLスキームを使うことで、画像を直接Instagramアプリに送ることができます。

### ステップ1：Instagram URLスキームの使用

InstagramのURLスキームは以下のようになります。
- 画像を投稿する場合: `instagram://library?AssetPath=...`

### ステップ2：カスタムアクティビティの実装

以下は、Instagramに画像をシェアするためのカスタムアクティビティの実装例です。

```swift
import UIKit

class InstagramActivity: UIActivity {
    var items: [Any]?
    
    override var activityType: UIActivity.ActivityType? {
        return UIActivity.ActivityType("com.example.instagram")
    }
    
    override var activityTitle: String? {
        return "Instagram"
    }
    
    override var activityImage: UIImage? {
        return UIImage(named: "instagram_icon") // カスタムのInstagramアイコンを提供
    }
    
    override func canPerform(withActivityItems activityItems: [Any]) -> Bool {
        // UIImageが含まれている場合のみアクティビティを表示
        return activityItems.contains { $0 is UIImage }
    }
    
    override func prepare(withActivityItems activityItems: [Any]) {
        self.items = activityItems
    }
    
    override func perform() {
        guard let image = items?.first(where: { $0 is UIImage }) as? UIImage else {
            activityDidFinish(false)
            return
        }
        
        // 画像を一時ファイルとして保存
        if let imageData = image.pngData(), let url = saveImageToTemporaryDirectory(data: imageData) {
            // Instagram URLスキームを使用して画像を開く
            let instagramUrl = URL(string: "instagram://library?AssetPath=\(url.path)")!
            if UIApplication.shared.canOpenURL(instagramUrl) {
                UIApplication.shared.open(instagramUrl, options: [:]) { success in
                    self.activityDidFinish(success)
                }
            } else {
                // Instagramがインストールされていない場合の処理
                self.activityDidFinish(false)
            }
        } else {
            activityDidFinish(false)
        }
    }
    
    private func saveImageToTemporaryDirectory(data: Data) -> URL? {
        let temporaryDirectory = FileManager.default.temporaryDirectory
        let fileName = UUID().uuidString + ".png"
        let fileURL = temporaryDirectory.appendingPathComponent(fileName)
        
        do {
            try data.write(to: fileURL)
            return fileURL
        } catch {
            return nil
        }
    }
}
```

### ステップ3：カスタムアクティビティをUIActivityViewControllerに追加

次に、`UIActivityViewController`を作成するときにカスタムアクティビティを追加します。

```swift
import SwiftUI
import UIKit

struct ShareSheet: UIViewControllerRepresentable {
    var activityItems: [Any]
    var applicationActivities: [UIActivity]? = nil
    
    func makeUIViewController(context: Context) -> UIActivityViewController {
        let controller = UIActivityViewController(activityItems: activityItems, applicationActivities: applicationActivities)
        return controller
    }
    
    func updateUIViewController(_ uiViewController: UIActivityViewController, context: Context) {
        // No need to update the controller, as it does not change over time
    }
}

struct ContentView: View {
    @State private var isShareSheetPresented = false
    
    var body: some View {
        VStack {
            Text("Hello, world!")
                .padding()
            
            Button(action: {
                isShareSheetPresented = true
            }) {
                Text("Share Text")
                    .padding()
                    .background(Color.blue)
                    .foregroundColor(.white)
                    .cornerRadius(8)
            }
            .sheet(isPresented: $isShareSheetPresented) {
                ShareSheet(activityItems: [UIImage(named: "your_image_name")!], applicationActivities: [InstagramActivity()])
            }
        }
    }
}

struct ContentView_Previews: PreviewProvider {
    static var previews: some View {
        ContentView()
    }
}
```

### 説明

1. **`InstagramActivity`の作成**：
    - `UIActivity`のサブクラスとして`InstagramActivity`を作成し、Instagramアイコンとカスタム処理を定義します。
    - `canPerform(withActivityItems:)`メソッドで共有可能なアイテムがあるかをチェックし、`perform()`メソッドでInstagram URLスキームを使用して画像をシェアします。

2. **`ShareSheet`にカスタムアクティビティを追加**：
    - `ShareSheet`を表示する際に、`applicationActivities`に`InstagramActivity`のインスタンスを追加します。

このアプローチにより、Instagramアイコンをタップしたときに特定の処理を実行することができます。

---

## 👤 ユーザー
*2024/7/19 20:02:59*

しっかりの上位互換

---

## 🤖 アシスタント
*2024/7/19 20:03:04*

InstagramへのシェアをSwiftUIで実装し、カスタムの処理を加える方法について、より洗練されたアプローチを示します。この例では、Instagramに画像を共有するためのURLスキームを使用しつつ、SwiftUIとUIKitの連携をスムーズに行います。

### ステップ1：カスタ

---
