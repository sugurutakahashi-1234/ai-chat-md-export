# グリッドビューのアニメーション

日付: 2024-05-23

---

## 👤 ユーザー
*2024/5/23 17:29:46*

onTapPlus でグリットVIewのアニメーションを入れたいどうすればいいか？

@MainActor
struct TalkBoxListView: View {
    @StateObject private var presenter: TalkBoxListPresenter
    private let lazyVGridColumns: \[GridItem\] = Array(repeating: GridItem(.flexible()), count: 2)
    
    init() {
        \_presenter = .init(wrappedValue: .init())
    }

    var body: some View {
        ScrollView {
            LazyVGrid(columns: lazyVGridColumns) {
                ForEach(presenter.talkBoxes) { talkBox in
                    ZStack(alignment: .bottom) {
                        AsyncImage(url: talkBox.imageUrl) { image in
                            image
                        } placeholder: {
                            ProgressView()
                        }
                        .aspectRatio(Constants.AspectRatio.square, contentMode: .fill)
                        
                        Text("Order: \\(talkBox.order)")
                    }
                    .background(Color.gray.opacity(0.2))
                    .cornerRadius(8)
                }
            }
        }
        .refreshable {
            Task {
                await presenter.onRefresh()
            }
        }
        .toolbar {
            ToolbarItem(placement: .topBarTrailing) {
                Button {
                    Task {
                        await presenter.onTapPlus()
                    }
                } label: {
                    SFSymbols.plus.image
                }
            }
        }
        .navigationTitle("Small Talk")
        .sensoryFeedbackSuccess(trigger: presenter.shouldfeedbackSuccess)
        .task {
            await presenter.onAppear()
        }
    }
}

@MainActor
final class TalkBoxListPresenter: ObservableObject {
    @Published private(set) var talkBoxes: \[TalkBox\] = \[\]

    @Published var isLoading: Bool = false
    @Published var appError: AppError?
    @Published var showAlert: Bool = false
    @Published var shouldfeedbackSuccess: Bool = false
    
    private let apiDriver = APIDriver()
    
    func onAppear() async {
        do {
            talkBoxes = try await apiDriver.getTalkBox()
        } catch {
            OSLogger.errorLog("\\(error)")
            appError = error.toAppError
            showAlert = true
        }
    }
    
    func onRefresh() async {
        await onAppear()
        shouldfeedbackSuccess = true
    }
    
    func onTapPlus() async {
        do {
            let newTalkBox = try await apiDriver.postTalkBox(talkBox: .random)
            talkBoxes.insert(newTalkBox, at: 0)
        } catch {
            OSLogger.errorLog("\\(error)")
            appError = error.toAppError
            showAlert = true
        }
    }
}

---

## 🤖 アシスタント
*2024/5/23 17:30:08*

グリッドビューのアニメーションを追加するためには、新しいトークボックスが追加されたときにアニメーションを適用する必要があります。SwiftUIの`withAnimation`を使って、要素が追加される際にアニメーションを付けることができます。以下にアニメーションを追加する方法を示します。

まず、`TalkBoxListView`の`LazyVGrid`に`.animation()`モディファイアを追加します。

次に、`TalkBoxListPresenter`の`onTapPlus`メソッドで新しいトークボックスを追加する際に`withAnimation`を使用します。

```swift
@MainActor
struct TalkBoxListView: View {
    @StateObject private var presenter: TalkBoxListPresenter
    private let lazyVGridColumns: [GridItem] = Array(repeating: GridItem(.flexible()), count: 2)
    
    init() {
        _presenter = .init(wrappedValue: .init())
    }

    var body: some View {
        ScrollView {
            LazyVGrid(columns: lazyVGridColumns) {
                ForEach(presenter.talkBoxes) { talkBox in
                    ZStack(alignment: .bottom) {
                        AsyncImage(url: talkBox.imageUrl) { image in
                            image
                        } placeholder: {
                            ProgressView()
                        }
                        .aspectRatio(Constants.AspectRatio.square, contentMode: .fill)
                        
                        Text("Order: \(talkBox.order)")
                    }
                    .background(Color.gray.opacity(0.2))
                    .cornerRadius(8)
                }
            }
            .animation(.default, value: presenter.talkBoxes)
        }
        .refreshable {
            Task {
                await presenter.onRefresh()
            }
        }
        .toolbar {
            ToolbarItem(placement: .topBarTrailing) {
                Button {
                    Task {
                        await presenter.onTapPlus()
                    }
                } label: {
                    SFSymbols.plus.image
                }
            }
        }
        .navigationTitle("Small Talk")
        .sensoryFeedbackSuccess(trigger: presenter.shouldfeedbackSuccess)
        .task {
            await presenter.onAppear()
        }
    }
}

@MainActor
final class TalkBoxListPresenter: ObservableObject {
    @Published private(set) var talkBoxes: [TalkBox] = []

    @Published var isLoading: Bool = false
    @Published var appError: AppError?
    @Published var showAlert: Bool = false
    @Published var shouldfeedbackSuccess: Bool = false
    
    private let apiDriver = APIDriver()
    
    func onAppear() async {
        do {
            talkBoxes = try await apiDriver.getTalkBox()
        } catch {
            OSLogger.errorLog("\(error)")
            appError = error.toAppError
            showAlert = true
        }
    }
    
    func onRefresh() async {
        await onAppear()
        shouldfeedbackSuccess = true
    }
    
    func onTapPlus() async {
        do {
            let newTalkBox = try await apiDriver.postTalkBox(talkBox: .random)
            withAnimation {
                talkBoxes.insert(newTalkBox, at: 0)
            }
        } catch {
            OSLogger.errorLog("\(error)")
            appError = error.toAppError
            showAlert = true
        }
    }
}
```

上記のコードで、新しいトークボックスが追加された際にアニメーションが適用されるようになります。`withAnimation`を使用して要素が挿入される際にアニメーションを追加し、`LazyVGrid`に`.animation(.default, value: presenter.talkBoxes)`を追加することで、トークボックスのリストが変化する際にアニメーションが実行されます。

---
